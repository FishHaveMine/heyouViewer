"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function LRUMap(e,t){"number"!=typeof e&&(t=e,e=0),this.size=0,this.limit=e,this.oldest=this.newest=void 0,this._keymap=new Map,t&&(this.assign(t),e<1&&(this.limit=this.size))}function Entry(e,t){this.key=e,this.value=t,this[NEWER]=void 0,this[OLDER]=void 0}function EntryIterator(e){this.entry=e}function KeyIterator(e){this.entry=e}function ValueIterator(e){this.entry=e}var _slicedToArray=function(){function e(e,t){var n=[],i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_get=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,i)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(i)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},CLOUD=window.CLOUD||{};!function(e,t,n){!function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){n(1),n(50),n(51),n(52),n(54),n(55),n(58),n(59),n(60),n(61),n(62),n(63),n(64),n(65),n(66),n(68),n(70),n(72),n(74),n(77),n(78),n(79),n(83),n(86),n(87),n(88),n(89),n(91),n(92),n(93),n(94),n(95),n(97),n(99),n(100),n(101),n(103),n(104),n(105),n(107),n(108),n(109),n(111),n(112),n(113),n(114),n(115),n(116),n(117),n(118),n(119),n(120),n(121),n(122),n(123),n(124),n(126),n(130),n(131),n(132),n(133),n(137),n(139),n(140),n(141),n(142),n(143),n(144),n(145),n(146),n(147),n(148),n(149),n(150),n(151),n(152),n(158),n(159),n(161),n(162),n(163),n(167),n(168),n(169),n(170),n(171),n(173),n(174),n(175),n(176),n(179),n(181),n(182),n(183),n(185),n(187),n(189),n(190),n(191),n(193),n(194),n(195),n(196),n(203),n(206),n(207),n(209),n(210),n(211),n(212),n(213),n(214),n(215),n(216),n(217),n(218),n(219),n(220),n(222),n(223),n(224),n(225),n(226),n(227),n(228),n(229),n(231),n(234),n(235),n(237),n(238),n(239),n(240),n(241),n(242),n(243),n(244),n(245),n(246),n(247),n(249),n(250),n(251),n(252),n(253),n(254),n(255),n(256),n(258),n(259),n(261),n(262),n(263),n(264),n(267),n(268),n(269),n(270),n(271),n(272),n(273),n(274),n(276),n(277),n(278),n(279),n(280),n(281),n(282),n(283),n(284),n(285),n(286),n(287),n(288),n(291),n(156),n(293),n(292),n(294),n(295),n(296),n(297),n(298),n(300),n(301),n(302),n(304),e.exports=n(305)},function(e,t,i){var r=i(2),a=i(3),o=i(4),s=i(6),l=i(16),u=i(20).KEY,c=i(5),h=i(21),d=i(22),f=i(17),p=i(23),m=i(24),g=i(25),v=i(27),y=i(40),E=i(43),b=i(10),x=i(30),M=i(14),_=i(15),C=i(44),I=i(47),O=i(49),T=i(9),L=i(28),S=O.f,D=T.f,w=I.f,U=r.Symbol,R=r.JSON,A=R&&R.stringify,N="prototype",P=p("_hidden"),k=p("toPrimitive"),B={}.propertyIsEnumerable,F=h("symbol-registry"),H=h("symbols"),G=h("op-symbols"),V=Object[N],z="function"==typeof U,j=r.QObject,W=!j||!j[N]||!j[N].findChild,X=o&&c(function(){return 7!=C(D({},"a",{get:function(){return D(this,"a",{value:7}).a}})).a})?function(e,t,n){var i=S(V,t);i&&delete V[t],D(e,t,n),i&&e!==V&&D(V,t,i)}:D,Y=function(e){var t=H[e]=C(U[N]);return t._k=e,t},q=z&&"symbol"==_typeof(U.iterator)?function(e){return"symbol"==(void 0===e?"undefined":_typeof(e))}:function(e){return e instanceof U},Z=function(e,t,n){return e===V&&Z(G,t,n),b(e),t=M(t,!0),b(n),a(H,t)?(n.enumerable?(a(e,P)&&e[P][t]&&(e[P][t]=!1),n=C(n,{enumerable:_(0,!1)})):(a(e,P)||D(e,P,_(1,{})),e[P][t]=!0),X(e,t,n)):D(e,t,n)},K=function(e,t){b(e);for(var n,i=y(t=x(t)),r=0,a=i.length;a>r;)Z(e,n=i[r++],t[n]);return e},Q=function(e,t){return t===n?C(e):K(C(e),t)},J=function(e){var t=B.call(this,e=M(e,!0));return!(this===V&&a(H,e)&&!a(G,e))&&(!(t||!a(this,e)||!a(H,e)||a(this,P)&&this[P][e])||t)},$=function(e,t){if(e=x(e),t=M(t,!0),e!==V||!a(H,t)||a(G,t)){var n=S(e,t);return!n||!a(H,t)||a(e,P)&&e[P][t]||(n.enumerable=!0),n}},ee=function(e){for(var t,n=w(x(e)),i=[],r=0;n.length>r;)a(H,t=n[r++])||t==P||t==u||i.push(t);return i},te=function(e){for(var t,n=e===V,i=w(n?G:x(e)),r=[],o=0;i.length>o;)!a(H,t=i[o++])||n&&!a(V,t)||r.push(H[t]);return r};z||(U=function(){if(this instanceof U)throw TypeError("Symbol is not a constructor!");var e=f(arguments.length>0?arguments[0]:n),t=function t(n){this===V&&t.call(G,n),a(this,P)&&a(this[P],e)&&(this[P][e]=!1),X(this,e,_(1,n))};return o&&W&&X(V,e,{configurable:!0,set:t}),Y(e)},l(U[N],"toString",function(){return this._k}),O.f=$,T.f=Z,i(48).f=I.f=ee,i(42).f=J,i(41).f=te,o&&!i(26)&&l(V,"propertyIsEnumerable",J,!0),m.f=function(e){return Y(p(e))}),s(s.G+s.W+s.F*!z,{Symbol:U});for(var ne="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;ne.length>ie;)p(ne[ie++]);for(var ne=L(p.store),ie=0;ne.length>ie;)g(ne[ie++]);s(s.S+s.F*!z,"Symbol",{for:function(e){return a(F,e+="")?F[e]:F[e]=U(e)},keyFor:function(e){if(q(e))return v(F,e);throw TypeError(e+" is not a symbol!")},useSetter:function(){W=!0},useSimple:function(){W=!1}}),s(s.S+s.F*!z,"Object",{create:Q,defineProperty:Z,defineProperties:K,getOwnPropertyDescriptor:$,getOwnPropertyNames:ee,getOwnPropertySymbols:te}),R&&s(s.S+s.F*(!z||c(function(){var e=U();return"[null]"!=A([e])||"{}"!=A({a:e})||"{}"!=A(Object(e))})),"JSON",{stringify:function(e){if(e!==n&&!q(e)){for(var t,i,r=[e],a=1;arguments.length>a;)r.push(arguments[a++]);return t=r[1],"function"==typeof t&&(i=t),!i&&E(t)||(t=function(e,t){if(i&&(t=i.call(this,e,t)),!q(t))return t}),r[1]=t,A.apply(R,r)}}}),U[N][k]||i(8)(U[N],k,U[N].valueOf),d(U,"Symbol"),d(Math,"Math",!0),d(r.JSON,"JSON",!0)},function(e,n){var i=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof t&&(t=i)},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){e.exports=!n(5)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,i){var r=i(2),a=i(7),o=i(8),s=i(16),l=i(18),u="prototype",c=function e(t,i,c){var h,d,f,p,m=t&e.F,g=t&e.G,v=t&e.S,y=t&e.P,E=t&e.B,b=g?r:v?r[i]||(r[i]={}):(r[i]||{})[u],x=g?a:a[i]||(a[i]={}),M=x[u]||(x[u]={});g&&(c=i);for(h in c)d=!m&&b&&b[h]!==n,f=(d?b:c)[h],p=E&&d?l(f,r):y&&"function"==typeof f?l(Function.call,f):f,b&&s(b,h,f,t&e.U),x[h]!=f&&o(x,h,p),y&&M[h]!=f&&(M[h]=f)};r.core=a,c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,e.exports=c},function(t,n){var i=t.exports={version:"2.4.0"};"number"==typeof e&&(e=i)},function(e,t,n){var i=n(9),r=n(15);e.exports=n(4)?function(e,t,n){return i.f(e,t,r(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var i=n(10),r=n(12),a=n(14),o=Object.defineProperty;t.f=n(4)?Object.defineProperty:function(e,t,n){if(i(e),t=a(t,!0),i(n),r)try{return o(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){var i=n(11);e.exports=function(e){if(!i(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==(void 0===e?"undefined":_typeof(e))?null!==e:"function"==typeof e}},function(e,t,n){e.exports=!n(4)&&!n(5)(function(){return 7!=Object.defineProperty(n(13)("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var i=n(11),r=n(2).document,a=i(r)&&i(r.createElement);e.exports=function(e){return a?r.createElement(e):{}}},function(e,t,n){var i=n(11);e.exports=function(e,t){if(!i(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!i(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!i(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!i(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var i=n(2),r=n(8),a=n(3),o=n(17)("src"),s="toString",l=Function[s],u=(""+l).split(s);n(7).inspectSource=function(e){return l.call(e)},(e.exports=function(e,t,n,s){var l="function"==typeof n;l&&(a(n,"name")||r(n,"name",t)),e[t]!==n&&(l&&(a(n,o)||r(n,o,e[t]?""+e[t]:u.join(String(t)))),e===i?e[t]=n:s?e[t]?e[t]=n:r(e,t,n):(delete e[t],r(e,t,n)))})(Function.prototype,s,function(){return"function"==typeof this&&this[o]||l.call(this)})},function(e,t){var i=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(e===n?"":e,")_",(++i+r).toString(36))}},function(e,t,i){var r=i(19);e.exports=function(e,t,i){if(r(e),t===n)return e;switch(i){case 1:return function(n){return e.call(t,n)};case 2:return function(n,i){return e.call(t,n,i)};case 3:return function(n,i,r){return e.call(t,n,i,r)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var i=n(17)("meta"),r=n(11),a=n(3),o=n(9).f,s=0,l=Object.isExtensible||function(){return!0},u=!n(5)(function(){return l(Object.preventExtensions({}))}),c=function(e){o(e,i,{value:{i:"O"+ ++s,w:{}}})},h=function(e,t){if(!r(e))return"symbol"==(void 0===e?"undefined":_typeof(e))?e:("string"==typeof e?"S":"P")+e;if(!a(e,i)){if(!l(e))return"F";if(!t)return"E";c(e)}return e[i].i},d=function(e,t){if(!a(e,i)){if(!l(e))return!0;if(!t)return!1;c(e)}return e[i].w},f=function(e){return u&&p.NEED&&l(e)&&!a(e,i)&&c(e),e},p=e.exports={KEY:i,NEED:!1,fastKey:h,getWeak:d,onFreeze:f}},function(e,t,n){var i=n(2),r="__core-js_shared__",a=i[r]||(i[r]={});e.exports=function(e){return a[e]||(a[e]={})}},function(e,t,n){var i=n(9).f,r=n(3),a=n(23)("toStringTag");e.exports=function(e,t,n){e&&!r(e=n?e:e.prototype,a)&&i(e,a,{configurable:!0,value:t})}},function(e,t,n){var i=n(21)("wks"),r=n(17),a=n(2).Symbol,o="function"==typeof a;(e.exports=function(e){return i[e]||(i[e]=o&&a[e]||(o?a:r)("Symbol."+e))}).store=i},function(e,t,n){t.f=n(23)},function(e,t,n){var i=n(2),r=n(7),a=n(26),o=n(24),s=n(9).f;e.exports=function(e){var t=r.Symbol||(r.Symbol=a?{}:i.Symbol||{});"_"==e.charAt(0)||e in t||s(t,e,{value:o.f(e)})}},function(e,t){e.exports=!1},function(e,t,n){var i=n(28),r=n(30);e.exports=function(e,t){for(var n,a=r(e),o=i(a),s=o.length,l=0;s>l;)if(a[n=o[l++]]===t)return n}},function(e,t,n){var i=n(29),r=n(39);e.exports=Object.keys||function(e){return i(e,r)}},function(e,t,n){var i=n(3),r=n(30),a=n(34)(!1),o=n(38)("IE_PROTO");e.exports=function(e,t){var n,s=r(e),l=0,u=[];for(n in s)n!=o&&i(s,n)&&u.push(n);for(;t.length>l;)i(s,n=t[l++])&&(~a(u,n)||u.push(n));return u}},function(e,t,n){var i=n(31),r=n(33);e.exports=function(e){return i(r(e))}},function(e,t,n){var i=n(32);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==i(e)?e.split(""):Object(e)}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(e==n)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var i=n(30),r=n(35),a=n(37);e.exports=function(e){return function(t,n,o){var s,l=i(t),u=r(l.length),c=a(o,u);if(e&&n!=n){for(;u>c;)if((s=l[c++])!=s)return!0}else for(;u>c;c++)if((e||c in l)&&l[c]===n)return e||c||0;return!e&&-1}}},function(e,t,n){var i=n(36),r=Math.min;e.exports=function(e){return e>0?r(i(e),9007199254740991):0}},function(e,t){var n=Math.ceil,i=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?i:n)(e)}},function(e,t,n){var i=n(36),r=Math.max,a=Math.min;e.exports=function(e,t){return e=i(e),e<0?r(e+t,0):a(e,t)}},function(e,t,n){var i=n(21)("keys"),r=n(17);e.exports=function(e){return i[e]||(i[e]=r(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){var i=n(28),r=n(41),a=n(42);e.exports=function(e){var t=i(e),n=r.f;if(n)for(var o,s=n(e),l=a.f,u=0;s.length>u;)l.call(e,o=s[u++])&&t.push(o);return t}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){var i=n(32);e.exports=Array.isArray||function(e){return"Array"==i(e)}},function(e,t,i){var r=i(10),a=i(45),o=i(39),s=i(38)("IE_PROTO"),l=function(){},u="prototype",c=function(){var e,t=i(13)("iframe"),n=o.length;for(t.style.display="none",i(46).appendChild(t),t.src="javascript:",e=t.contentWindow.document,e.open(),e.write("<script>document.F=Object<\/script>"),e.close(),c=e.F;n--;)delete c[u][o[n]];return c()};e.exports=Object.create||function(e,t){var i;return null!==e?(l[u]=r(e),i=new l,l[u]=null,i[s]=e):i=c(),t===n?i:a(i,t)}},function(e,t,n){var i=n(9),r=n(10),a=n(28);e.exports=n(4)?Object.defineProperties:function(e,t){r(e);for(var n,o=a(t),s=o.length,l=0;s>l;)i.f(e,n=o[l++],t[n]);return e}},function(e,t,n){e.exports=n(2).document&&document.documentElement},function(e,t,n){var i=n(30),r=n(48).f,a={}.toString,o="object"==("undefined"==typeof window?"undefined":_typeof(window))&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],s=function(e){try{return r(e)}catch(e){return o.slice()}};e.exports.f=function(e){return o&&"[object Window]"==a.call(e)?s(e):r(i(e))}},function(e,t,n){var i=n(29),r=n(39).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return i(e,r)}},function(e,t,n){var i=n(42),r=n(15),a=n(30),o=n(14),s=n(3),l=n(12),u=Object.getOwnPropertyDescriptor;t.f=n(4)?u:function(e,t){if(e=a(e),t=o(t,!0),l)try{return u(e,t)}catch(e){}if(s(e,t))return r(!i.f.call(e,t),e[t])}},function(e,t,n){var i=n(6);i(i.S+i.F*!n(4),"Object",{defineProperty:n(9).f})},function(e,t,n){var i=n(6);i(i.S+i.F*!n(4),"Object",{defineProperties:n(45)})},function(e,t,n){var i=n(30),r=n(49).f;n(53)("getOwnPropertyDescriptor",function(){return function(e,t){return r(i(e),t)}})},function(e,t,n){var i=n(6),r=n(7),a=n(5);e.exports=function(e,t){var n=(r.Object||{})[e]||Object[e],o={};o[e]=t(n),i(i.S+i.F*a(function(){n(1)}),"Object",o)}},function(e,t,n){var i=n(6);i(i.S,"Object",{create:n(44)})},function(e,t,n){var i=n(56),r=n(57);n(53)("getPrototypeOf",function(){return function(e){return r(i(e))}})},function(e,t,n){var i=n(33);e.exports=function(e){return Object(i(e))}},function(e,t,n){var i=n(3),r=n(56),a=n(38)("IE_PROTO"),o=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=r(e),i(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},function(e,t,n){var i=n(56),r=n(28);n(53)("keys",function(){return function(e){return r(i(e))}})},function(e,t,n){n(53)("getOwnPropertyNames",function(){return n(47).f})},function(e,t,n){var i=n(11),r=n(20).onFreeze;n(53)("freeze",function(e){return function(t){return e&&i(t)?e(r(t)):t}})},function(e,t,n){var i=n(11),r=n(20).onFreeze;n(53)("seal",function(e){return function(t){return e&&i(t)?e(r(t)):t}})},function(e,t,n){var i=n(11),r=n(20).onFreeze;n(53)("preventExtensions",function(e){return function(t){return e&&i(t)?e(r(t)):t}})},function(e,t,n){var i=n(11);n(53)("isFrozen",function(e){return function(t){return!i(t)||!!e&&e(t)}})},function(e,t,n){var i=n(11);n(53)("isSealed",function(e){return function(t){return!i(t)||!!e&&e(t)}})},function(e,t,n){var i=n(11);n(53)("isExtensible",function(e){return function(t){return!!i(t)&&(!e||e(t))}})},function(e,t,n){var i=n(6);i(i.S+i.F,"Object",{assign:n(67)})},function(e,t,n){var i=n(28),r=n(41),a=n(42),o=n(56),s=n(31),l=Object.assign;e.exports=!l||n(5)(function(){var e={},t={},n=Symbol(),i="abcdefghijklmnopqrst";return e[n]=7,i.split("").forEach(function(e){t[e]=e}),7!=l({},e)[n]||Object.keys(l({},t)).join("")!=i})?function(e,t){for(var n=o(e),l=arguments.length,u=1,c=r.f,h=a.f;l>u;)for(var d,f=s(arguments[u++]),p=c?i(f).concat(c(f)):i(f),m=p.length,g=0;m>g;)h.call(f,d=p[g++])&&(n[d]=f[d]);return n}:l},function(e,t,n){var i=n(6);i(i.S,"Object",{is:n(69)})},function(e,t){e.exports=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}},function(e,t,n){var i=n(6);i(i.S,"Object",{setPrototypeOf:n(71).set})},function(e,t,i){var r=i(11),a=i(10),o=function(e,t){if(a(e),!r(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,n){try{n=i(18)(Function.call,i(49).f(Object.prototype,"__proto__").set,2),n(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,i){return o(e,i),t?e.__proto__=i:n(e,i),e}}({},!1):n),check:o}},function(e,t,n){var i=n(73),r={};r[n(23)("toStringTag")]="z",r+""!="[object z]"&&n(16)(Object.prototype,"toString",function(){return"[object "+i(this)+"]"},!0)},function(e,t,i){var r=i(32),a=i(23)("toStringTag"),o="Arguments"==r(function(){return arguments}()),s=function(e,t){try{return e[t]}catch(e){}};e.exports=function(e){var t,i,l;return e===n?"Undefined":null===e?"Null":"string"==typeof(i=s(t=Object(e),a))?i:o?r(t):"Object"==(l=r(t))&&"function"==typeof t.callee?"Arguments":l}},function(e,t,n){var i=n(6);i(i.P,"Function",{bind:n(75)})},function(e,t,n){var i=n(19),r=n(11),a=n(76),o=[].slice,s={},l=function(e,t,n){if(!(t in s)){for(var i=[],r=0;r<t;r++)i[r]="a["+r+"]";s[t]=Function("F,a","return new F("+i.join(",")+")")}return s[t](e,n)};e.exports=Function.bind||function(e){var t=i(this),n=o.call(arguments,1),s=function i(){var r=n.concat(o.call(arguments));return this instanceof i?l(t,r.length,r):a(t,r,e)};return r(t.prototype)&&(s.prototype=t.prototype),s}},function(e,t){e.exports=function(e,t,i){var r=i===n;switch(t.length){case 0:return r?e():e.call(i);case 1:return r?e(t[0]):e.call(i,t[0]);case 2:return r?e(t[0],t[1]):e.call(i,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(i,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(i,t[0],t[1],t[2],t[3])}return e.apply(i,t)}},function(e,t,n){var i=n(9).f,r=n(15),a=n(3),o=Function.prototype,s=/^\s*function ([^ (]*)/,l="name",u=Object.isExtensible||function(){return!0};l in o||n(4)&&i(o,l,{configurable:!0,get:function(){try{var e=this,t=(""+e).match(s)[1];return a(e,l)||!u(e)||i(e,l,r(5,t)),t}catch(e){return""}}})},function(e,t,n){var i=n(11),r=n(57),a=n(23)("hasInstance"),o=Function.prototype;a in o||n(9).f(o,a,{value:function(e){if("function"!=typeof this||!i(e))return!1;if(!i(this.prototype))return e instanceof this;for(;e=r(e);)if(this.prototype===e)return!0;return!1}})},function(e,t,n){var i=n(2),r=n(3),a=n(32),o=n(80),s=n(14),l=n(5),u=n(48).f,c=n(49).f,h=n(9).f,d=n(81).trim,f="Number",p=i[f],m=p,g=p.prototype,v=a(n(44)(g))==f,y="trim"in String.prototype,E=function(e){var t=s(e,!1);if("string"==typeof t&&t.length>2){t=y?t.trim():d(t,3);var n,i,r,a=t.charCodeAt(0);if(43===a||45===a){if(88===(n=t.charCodeAt(2))||120===n)return NaN}else if(48===a){switch(t.charCodeAt(1)){case 66:case 98:i=2,r=49;break;case 79:case 111:i=8,r=55;break;default:return+t}for(var o,l=t.slice(2),u=0,c=l.length;u<c;u++)if((o=l.charCodeAt(u))<48||o>r)return NaN;return parseInt(l,i)}}return+t};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(e){var t=arguments.length<1?0:e,n=this;return n instanceof p&&(v?l(function(){g.valueOf.call(n)}):a(n)!=f)?o(new m(E(t)),n,p):E(t)};for(var b,x=n(4)?u(m):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),M=0;x.length>M;M++)r(m,b=x[M])&&!r(p,b)&&h(p,b,c(m,b));p.prototype=g,g.constructor=p,n(16)(i,f,p)}},function(e,t,n){var i=n(11),r=n(71).set;e.exports=function(e,t,n){var a,o=t.constructor;return o!==n&&"function"==typeof o&&(a=o.prototype)!==n.prototype&&i(a)&&r&&r(e,a),e}},function(e,t,n){var i=n(6),r=n(33),a=n(5),o=n(82),s="["+o+"]",l="​",u=RegExp("^"+s+s+"*"),c=RegExp(s+s+"*$"),h=function(e,t,n){var r={},s=a(function(){return!!o[e]()||l[e]()!=l}),u=r[e]=s?t(d):o[e];n&&(r[n]=u),i(i.P+i.F*s,"String",r)},d=h.trim=function(e,t){return e=String(r(e)),1&t&&(e=e.replace(u,"")),2&t&&(e=e.replace(c,"")),e};e.exports=h},function(e,t){e.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(e,t,n){var i=n(6),r=n(36),a=n(84),o=n(85),s=1..toFixed,l=Math.floor,u=[0,0,0,0,0,0],c="Number.toFixed: incorrect invocation!",h="0",d=function(e,t){for(var n=-1,i=t;++n<6;)i+=e*u[n],u[n]=i%1e7,i=l(i/1e7)},f=function(e){for(var t=6,n=0;--t>=0;)n+=u[t],u[t]=l(n/e),n=n%e*1e7},p=function(){for(var e=6,t="";--e>=0;)if(""!==t||0===e||0!==u[e]){var n=String(u[e]);t=""===t?n:t+o.call(h,7-n.length)+n}return t},m=function e(t,n,i){return 0===n?i:n%2==1?e(t,n-1,i*t):e(t*t,n/2,i)},g=function(e){for(var t=0,n=e;n>=4096;)t+=12,n/=4096;for(;n>=2;)t+=1,n/=2;return t};i(i.P+i.F*(!!s&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!n(5)(function(){s.call({})})),"Number",{toFixed:function(e){var t,n,i,s,l=a(this,c),u=r(e),v="",y=h;if(u<0||u>20)throw RangeError(c);if(l!=l)return"NaN";if(l<=-1e21||l>=1e21)return String(l);if(l<0&&(v="-",l=-l),l>1e-21)if(t=g(l*m(2,69,1))-69,n=t<0?l*m(2,-t,1):l/m(2,t,1),n*=4503599627370496,(t=52-t)>0){for(d(0,n),i=u;i>=7;)d(1e7,0),i-=7;for(d(m(10,i,1),0),i=t-1;i>=23;)f(1<<23),i-=23;f(1<<i),d(1,1),f(2),y=p()}else d(0,n),d(1<<-t,0),y=p()+o.call(h,u);return u>0?(s=y.length,y=v+(s<=u?"0."+o.call(h,u-s)+y:y.slice(0,s-u)+"."+y.slice(s-u))):y=v+y,y}})},function(e,t,n){var i=n(32);e.exports=function(e,t){if("number"!=typeof e&&"Number"!=i(e))throw TypeError(t);return+e}},function(e,t,n){var i=n(36),r=n(33);e.exports=function(e){var t=String(r(this)),n="",a=i(e);if(a<0||a==1/0)throw RangeError("Count can't be negative");for(;a>0;(a>>>=1)&&(t+=t))1&a&&(n+=t);return n}},function(e,t,i){var r=i(6),a=i(5),o=i(84),s=1..toPrecision;r(r.P+r.F*(a(function(){return"1"!==s.call(1,n)})||!a(function(){s.call({})})),"Number",{toPrecision:function(e){var t=o(this,"Number#toPrecision: incorrect invocation!");return e===n?s.call(t):s.call(t,e)}})},function(e,t,n){var i=n(6);i(i.S,"Number",{EPSILON:Math.pow(2,-52)})},function(e,t,n){var i=n(6),r=n(2).isFinite;i(i.S,"Number",{isFinite:function(e){return"number"==typeof e&&r(e)}})},function(e,t,n){var i=n(6);i(i.S,"Number",{isInteger:n(90)})},function(e,t,n){var i=n(11),r=Math.floor;e.exports=function(e){return!i(e)&&isFinite(e)&&r(e)===e}},function(e,t,n){var i=n(6);i(i.S,"Number",{isNaN:function(e){return e!=e}})},function(e,t,n){var i=n(6),r=n(90),a=Math.abs;i(i.S,"Number",{isSafeInteger:function(e){return r(e)&&a(e)<=9007199254740991}})},function(e,t,n){var i=n(6);i(i.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(e,t,n){var i=n(6);i(i.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(e,t,n){var i=n(6),r=n(96);i(i.S+i.F*(Number.parseFloat!=r),"Number",{parseFloat:r})},function(e,t,n){var i=n(2).parseFloat,r=n(81).trim;e.exports=1/i(n(82)+"-0")!=-1/0?function(e){var t=r(String(e),3),n=i(t);return 0===n&&"-"==t.charAt(0)?-0:n}:i},function(e,t,n){var i=n(6),r=n(98);i(i.S+i.F*(Number.parseInt!=r),"Number",{parseInt:r})},function(e,t,n){var i=n(2).parseInt,r=n(81).trim,a=n(82),o=/^[\-+]?0[xX]/;e.exports=8!==i(a+"08")||22!==i(a+"0x16")?function(e,t){var n=r(String(e),3);return i(n,t>>>0||(o.test(n)?16:10))}:i},function(e,t,n){var i=n(6),r=n(98);i(i.G+i.F*(parseInt!=r),{parseInt:r})},function(e,t,n){var i=n(6),r=n(96);i(i.G+i.F*(parseFloat!=r),{parseFloat:r})},function(e,t,n){var i=n(6),r=n(102),a=Math.sqrt,o=Math.acosh;i(i.S+i.F*!(o&&710==Math.floor(o(Number.MAX_VALUE))&&o(1/0)==1/0),"Math",{acosh:function(e){return(e=+e)<1?NaN:e>94906265.62425156?Math.log(e)+Math.LN2:r(e-1+a(e-1)*a(e+1))}})},function(e,t){e.exports=Math.log1p||function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:Math.log(1+e)}},function(e,t,n){function i(e){return isFinite(e=+e)&&0!=e?e<0?-i(-e):Math.log(e+Math.sqrt(e*e+1)):e}var r=n(6),a=Math.asinh;r(r.S+r.F*!(a&&1/a(0)>0),"Math",{asinh:i})},function(e,t,n){var i=n(6),r=Math.atanh;i(i.S+i.F*!(r&&1/r(-0)<0),"Math",{atanh:function(e){return 0==(e=+e)?e:Math.log((1+e)/(1-e))/2}})},function(e,t,n){var i=n(6),r=n(106);i(i.S,"Math",{cbrt:function(e){return r(e=+e)*Math.pow(Math.abs(e),1/3)}})},function(e,t){e.exports=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},function(e,t,n){var i=n(6);i(i.S,"Math",{clz32:function(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},function(e,t,n){var i=n(6),r=Math.exp;i(i.S,"Math",{cosh:function(e){return(r(e=+e)+r(-e))/2}})},function(e,t,n){var i=n(6),r=n(110);i(i.S+i.F*(r!=Math.expm1),"Math",{expm1:r})},function(e,t){var n=Math.expm1;e.exports=!n||n(10)>22025.465794806718||n(10)<22025.465794806718||-2e-17!=n(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Math.exp(e)-1}:n},function(e,t,n){var i=n(6),r=n(106),a=Math.pow,o=a(2,-52),s=a(2,-23),l=a(2,127)*(2-s),u=a(2,-126),c=function(e){return e+1/o-1/o};i(i.S,"Math",{fround:function(e){var t,n,i=Math.abs(e),a=r(e);return i<u?a*c(i/u/s)*u*s:(t=(1+s/o)*i,n=t-(t-i),n>l||n!=n?a*(1/0):a*n)}})},function(e,t,n){var i=n(6),r=Math.abs;i(i.S,"Math",{hypot:function(e,t){for(var n,i,a=0,o=0,s=arguments.length,l=0;o<s;)n=r(arguments[o++]),l<n?(i=l/n,a=a*i*i+1,l=n):n>0?(i=n/l,a+=i*i):a+=n;return l===1/0?1/0:l*Math.sqrt(a)}})},function(e,t,n){var i=n(6),r=Math.imul;i(i.S+i.F*n(5)(function(){return-5!=r(4294967295,5)||2!=r.length}),"Math",{imul:function(e,t){var n=65535,i=+e,r=+t,a=n&i,o=n&r;return 0|a*o+((n&i>>>16)*o+a*(n&r>>>16)<<16>>>0)}})},function(e,t,n){var i=n(6);i(i.S,"Math",{log10:function(e){return Math.log(e)/Math.LN10}})},function(e,t,n){var i=n(6);i(i.S,"Math",{log1p:n(102)})},function(e,t,n){var i=n(6);i(i.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}})},function(e,t,n){var i=n(6);i(i.S,"Math",{sign:n(106)})},function(e,t,n){var i=n(6),r=n(110),a=Math.exp;i(i.S+i.F*n(5)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(e){return Math.abs(e=+e)<1?(r(e)-r(-e))/2:(a(e-1)-a(-e-1))*(Math.E/2)}})},function(e,t,n){var i=n(6),r=n(110),a=Math.exp;i(i.S,"Math",{tanh:function(e){var t=r(e=+e),n=r(-e);return t==1/0?1:n==1/0?-1:(t-n)/(a(e)+a(-e))}})},function(e,t,n){var i=n(6);i(i.S,"Math",{trunc:function(e){return(e>0?Math.floor:Math.ceil)(e)}})},function(e,t,n){var i=n(6),r=n(37),a=String.fromCharCode,o=String.fromCodePoint;i(i.S+i.F*(!!o&&1!=o.length),"String",{fromCodePoint:function(e){for(var t,n=[],i=arguments.length,o=0;i>o;){if(t=+arguments[o++],r(t,1114111)!==t)throw RangeError(t+" is not a valid code point");n.push(t<65536?a(t):a(55296+((t-=65536)>>10),t%1024+56320))}return n.join("")}})},function(e,t,n){var i=n(6),r=n(30),a=n(35);i(i.S,"String",{raw:function(e){for(var t=r(e.raw),n=a(t.length),i=arguments.length,o=[],s=0;n>s;)o.push(String(t[s++])),s<i&&o.push(String(arguments[s]));return o.join("")}})},function(e,t,n){n(81)("trim",function(e){return function(){return e(this,3)}})},function(e,t,n){var i=n(6),r=n(125)(!1);i(i.P,"String",{codePointAt:function(e){return r(this,e)}})},function(e,t,i){var r=i(36),a=i(33);e.exports=function(e){return function(t,i){var o,s,l=String(a(t)),u=r(i),c=l.length;return u<0||u>=c?e?"":n:(o=l.charCodeAt(u),o<55296||o>56319||u+1===c||(s=l.charCodeAt(u+1))<56320||s>57343?e?l.charAt(u):o:e?l.slice(u,u+2):s-56320+(o-55296<<10)+65536)}}},function(e,t,i){var r=i(6),a=i(35),o=i(127),s="endsWith",l=""[s];r(r.P+r.F*i(129)(s),"String",{endsWith:function(e){var t=o(this,e,s),i=arguments.length>1?arguments[1]:n,r=a(t.length),u=i===n?r:Math.min(a(i),r),c=String(e);return l?l.call(t,c,u):t.slice(u-c.length,u)===c}})},function(e,t,n){var i=n(128),r=n(33);e.exports=function(e,t,n){if(i(t))throw TypeError("String#"+n+" doesn't accept regex!");return String(r(e))}},function(e,t,i){var r=i(11),a=i(32),o=i(23)("match");e.exports=function(e){var t;return r(e)&&((t=e[o])!==n?!!t:"RegExp"==a(e))}},function(e,t,n){var i=n(23)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(n){try{return t[i]=!1,!"/./"[e](t)}catch(e){}}return!0}},function(e,t,i){var r=i(6),a=i(127),o="includes";r(r.P+r.F*i(129)(o),"String",{includes:function(e){return!!~a(this,e,o).indexOf(e,arguments.length>1?arguments[1]:n)}})},function(e,t,n){var i=n(6);i(i.P,"String",{repeat:n(85)})},function(e,t,i){var r=i(6),a=i(35),o=i(127),s="startsWith",l=""[s];r(r.P+r.F*i(129)(s),"String",{startsWith:function(e){var t=o(this,e,s),i=a(Math.min(arguments.length>1?arguments[1]:n,t.length)),r=String(e);return l?l.call(t,r,i):t.slice(i,i+r.length)===r}})},function(e,t,i){var r=i(125)(!0);i(134)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,i=this._i;return i>=t.length?{value:n,done:!0}:(e=r(t,i),this._i+=e.length,{value:e,done:!1})})},function(e,t,i){var r=i(26),a=i(6),o=i(16),s=i(8),l=i(3),u=i(135),c=i(136),h=i(22),d=i(57),f=i(23)("iterator"),p=!([].keys&&"next"in[].keys()),m="keys",g="values",v=function(){return this};e.exports=function(e,t,i,y,E,b,x){c(i,t,y);var M,_,C,I=function(e){if(!p&&e in S)return S[e];switch(e){case m:case g:return function(){return new i(this,e)}}return function(){return new i(this,e)}},O=t+" Iterator",T=E==g,L=!1,S=e.prototype,D=S[f]||S["@@iterator"]||E&&S[E],w=D||I(E),U=E?T?I("entries"):w:n,R="Array"==t?S.entries||D:D;if(R&&(C=d(R.call(new e)))!==Object.prototype&&(h(C,O,!0),r||l(C,f)||s(C,f,v)),T&&D&&D.name!==g&&(L=!0,w=function(){return D.call(this)}),r&&!x||!p&&!L&&S[f]||s(S,f,w),u[t]=w,u[O]=v,E)if(M={values:T?w:I(g),keys:b?w:I(m),entries:U},x)for(_ in M)_ in S||o(S,_,M[_]);else a(a.P+a.F*(p||L),t,M);return M}},function(e,t){e.exports={}},function(e,t,n){var i=n(44),r=n(15),a=n(22),o={};n(8)(o,n(23)("iterator"),function(){return this}),e.exports=function(e,t,n){e.prototype=i(o,{next:r(1,n)}),a(e,t+" Iterator")}},function(e,t,n){n(138)("anchor",function(e){return function(t){return e(this,"a","name",t)}})},function(e,t,n){var i=n(6),r=n(5),a=n(33),o=/"/g,s=function(e,t,n,i){var r=String(a(e)),s="<"+t;return""!==n&&(s+=" "+n+'="'+String(i).replace(o,"&quot;")+'"'),s+">"+r+"</"+t+">"};e.exports=function(e,t){var n={};n[e]=t(s),i(i.P+i.F*r(function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}),"String",n)}},function(e,t,n){n(138)("big",function(e){return function(){return e(this,"big","","")}})},function(e,t,n){n(138)("blink",function(e){return function(){return e(this,"blink","","")}})},function(e,t,n){n(138)("bold",function(e){return function(){return e(this,"b","","")}})},function(e,t,n){n(138)("fixed",function(e){return function(){return e(this,"tt","","")}})},function(e,t,n){n(138)("fontcolor",function(e){return function(t){return e(this,"font","color",t)}})},function(e,t,n){n(138)("fontsize",function(e){return function(t){return e(this,"font","size",t)}})},function(e,t,n){n(138)("italics",function(e){return function(){return e(this,"i","","")}})},function(e,t,n){
n(138)("link",function(e){return function(t){return e(this,"a","href",t)}})},function(e,t,n){n(138)("small",function(e){return function(){return e(this,"small","","")}})},function(e,t,n){n(138)("strike",function(e){return function(){return e(this,"strike","","")}})},function(e,t,n){n(138)("sub",function(e){return function(){return e(this,"sub","","")}})},function(e,t,n){n(138)("sup",function(e){return function(){return e(this,"sup","","")}})},function(e,t,n){var i=n(6);i(i.S,"Array",{isArray:n(43)})},function(e,t,i){var r=i(18),a=i(6),o=i(56),s=i(153),l=i(154),u=i(35),c=i(155),h=i(156);a(a.S+a.F*!i(157)(function(e){}),"Array",{from:function(e){var t,i,a,d,f=o(e),p="function"==typeof this?this:Array,m=arguments.length,g=m>1?arguments[1]:n,v=g!==n,y=0,E=h(f);if(v&&(g=r(g,m>2?arguments[2]:n,2)),E==n||p==Array&&l(E))for(t=u(f.length),i=new p(t);t>y;y++)c(i,y,v?g(f[y],y):f[y]);else for(d=E.call(f),i=new p;!(a=d.next()).done;y++)c(i,y,v?s(d,g,[a.value,y],!0):a.value);return i.length=y,i}})},function(e,t,i){var r=i(10);e.exports=function(e,t,i,a){try{return a?t(r(i)[0],i[1]):t(i)}catch(t){var o=e.return;throw o!==n&&r(o.call(e)),t}}},function(e,t,i){var r=i(135),a=i(23)("iterator"),o=Array.prototype;e.exports=function(e){return e!==n&&(r.Array===e||o[a]===e)}},function(e,t,n){var i=n(9),r=n(15);e.exports=function(e,t,n){t in e?i.f(e,t,r(0,n)):e[t]=n}},function(e,t,i){var r=i(73),a=i(23)("iterator"),o=i(135);e.exports=i(7).getIteratorMethod=function(e){if(e!=n)return e[a]||e["@@iterator"]||o[r(e)]}},function(e,t,n){var i=n(23)("iterator"),r=!1;try{var a=[7][i]();a.return=function(){r=!0},Array.from(a,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!r)return!1;var n=!1;try{var a=[7],o=a[i]();o.next=function(){return{done:n=!0}},a[i]=function(){return o},e(a)}catch(e){}return n}},function(e,t,n){var i=n(6),r=n(155);i(i.S+i.F*n(5)(function(){function e(){}return!(Array.of.call(e)instanceof e)}),"Array",{of:function(){for(var e=0,t=arguments.length,n=new("function"==typeof this?this:Array)(t);t>e;)r(n,e,arguments[e++]);return n.length=t,n}})},function(e,t,i){var r=i(6),a=i(30),o=[].join;r(r.P+r.F*(i(31)!=Object||!i(160)(o)),"Array",{join:function(e){return o.call(a(this),e===n?",":e)}})},function(e,t,n){var i=n(5);e.exports=function(e,t){return!!e&&i(function(){t?e.call(null,function(){},1):e.call(null)})}},function(e,t,i){var r=i(6),a=i(46),o=i(32),s=i(37),l=i(35),u=[].slice;r(r.P+r.F*i(5)(function(){a&&u.call(a)}),"Array",{slice:function(e,t){var i=l(this.length),r=o(this);if(t=t===n?i:t,"Array"==r)return u.call(this,e,t);for(var a=s(e,i),c=s(t,i),h=l(c-a),d=Array(h),f=0;f<h;f++)d[f]="String"==r?this.charAt(a+f):this[a+f];return d}})},function(e,t,i){var r=i(6),a=i(19),o=i(56),s=i(5),l=[].sort,u=[1,2,3];r(r.P+r.F*(s(function(){u.sort(n)})||!s(function(){u.sort(null)})||!i(160)(l)),"Array",{sort:function(e){return e===n?l.call(o(this)):l.call(o(this),a(e))}})},function(e,t,n){var i=n(6),r=n(164)(0),a=n(160)([].forEach,!0);i(i.P+i.F*!a,"Array",{forEach:function(e){return r(this,e,arguments[1])}})},function(e,t,i){var r=i(18),a=i(31),o=i(56),s=i(35),l=i(165);e.exports=function(e,t){var i=1==e,u=2==e,c=3==e,h=4==e,d=6==e,f=5==e||d,p=t||l;return function(t,l,m){for(var g,v,y=o(t),E=a(y),b=r(l,m,3),x=s(E.length),M=0,_=i?p(t,x):u?p(t,0):n;x>M;M++)if((f||M in E)&&(g=E[M],v=b(g,M,y),e))if(i)_[M]=v;else if(v)switch(e){case 3:return!0;case 5:return g;case 6:return M;case 2:_.push(g)}else if(h)return!1;return d?-1:c||h?h:_}}},function(e,t,n){var i=n(166);e.exports=function(e,t){return new(i(e))(t)}},function(e,t,i){var r=i(11),a=i(43),o=i(23)("species");e.exports=function(e){var t;return a(e)&&(t=e.constructor,"function"!=typeof t||t!==Array&&!a(t.prototype)||(t=n),r(t)&&null===(t=t[o])&&(t=n)),t===n?Array:t}},function(e,t,n){var i=n(6),r=n(164)(1);i(i.P+i.F*!n(160)([].map,!0),"Array",{map:function(e){return r(this,e,arguments[1])}})},function(e,t,n){var i=n(6),r=n(164)(2);i(i.P+i.F*!n(160)([].filter,!0),"Array",{filter:function(e){return r(this,e,arguments[1])}})},function(e,t,n){var i=n(6),r=n(164)(3);i(i.P+i.F*!n(160)([].some,!0),"Array",{some:function(e){return r(this,e,arguments[1])}})},function(e,t,n){var i=n(6),r=n(164)(4);i(i.P+i.F*!n(160)([].every,!0),"Array",{every:function(e){return r(this,e,arguments[1])}})},function(e,t,n){var i=n(6),r=n(172);i(i.P+i.F*!n(160)([].reduce,!0),"Array",{reduce:function(e){return r(this,e,arguments.length,arguments[1],!1)}})},function(e,t,n){var i=n(19),r=n(56),a=n(31),o=n(35);e.exports=function(e,t,n,s,l){i(t);var u=r(e),c=a(u),h=o(u.length),d=l?h-1:0,f=l?-1:1;if(n<2)for(;;){if(d in c){s=c[d],d+=f;break}if(d+=f,l?d<0:h<=d)throw TypeError("Reduce of empty array with no initial value")}for(;l?d>=0:h>d;d+=f)d in c&&(s=t(s,c[d],d,u));return s}},function(e,t,n){var i=n(6),r=n(172);i(i.P+i.F*!n(160)([].reduceRight,!0),"Array",{reduceRight:function(e){return r(this,e,arguments.length,arguments[1],!0)}})},function(e,t,n){var i=n(6),r=n(34)(!1),a=[].indexOf,o=!!a&&1/[1].indexOf(1,-0)<0;i(i.P+i.F*(o||!n(160)(a)),"Array",{indexOf:function(e){return o?a.apply(this,arguments)||0:r(this,e,arguments[1])}})},function(e,t,n){var i=n(6),r=n(30),a=n(36),o=n(35),s=[].lastIndexOf,l=!!s&&1/[1].lastIndexOf(1,-0)<0;i(i.P+i.F*(l||!n(160)(s)),"Array",{lastIndexOf:function(e){if(l)return s.apply(this,arguments)||0;var t=r(this),n=o(t.length),i=n-1;for(arguments.length>1&&(i=Math.min(i,a(arguments[1]))),i<0&&(i=n+i);i>=0;i--)if(i in t&&t[i]===e)return i||0;return-1}})},function(e,t,n){var i=n(6);i(i.P,"Array",{copyWithin:n(177)}),n(178)("copyWithin")},function(e,t,i){var r=i(56),a=i(37),o=i(35);e.exports=[].copyWithin||function(e,t){var i=r(this),s=o(i.length),l=a(e,s),u=a(t,s),c=arguments.length>2?arguments[2]:n,h=Math.min((c===n?s:a(c,s))-u,s-l),d=1;for(u<l&&l<u+h&&(d=-1,u+=h-1,l+=h-1);h-- >0;)u in i?i[l]=i[u]:delete i[l],l+=d,u+=d;return i}},function(e,t,i){var r=i(23)("unscopables"),a=Array.prototype;a[r]==n&&i(8)(a,r,{}),e.exports=function(e){a[r][e]=!0}},function(e,t,n){var i=n(6);i(i.P,"Array",{fill:n(180)}),n(178)("fill")},function(e,t,i){var r=i(56),a=i(37),o=i(35);e.exports=function(e){for(var t=r(this),i=o(t.length),s=arguments.length,l=a(s>1?arguments[1]:n,i),u=s>2?arguments[2]:n,c=u===n?i:a(u,i);c>l;)t[l++]=e;return t}},function(e,t,i){var r=i(6),a=i(164)(5),o="find",s=!0;o in[]&&Array(1)[o](function(){s=!1}),r(r.P+r.F*s,"Array",{find:function(e){return a(this,e,arguments.length>1?arguments[1]:n)}}),i(178)(o)},function(e,t,i){var r=i(6),a=i(164)(6),o="findIndex",s=!0;o in[]&&Array(1)[o](function(){s=!1}),r(r.P+r.F*s,"Array",{findIndex:function(e){return a(this,e,arguments.length>1?arguments[1]:n)}}),i(178)(o)},function(e,t,i){var r=i(178),a=i(184),o=i(135),s=i(30);e.exports=i(134)(Array,"Array",function(e,t){this._t=s(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,i=this._i++;return!e||i>=e.length?(this._t=n,a(1)):"keys"==t?a(0,i):"values"==t?a(0,e[i]):a(0,[i,e[i]])},"values"),o.Arguments=o.Array,r("keys"),r("values"),r("entries")},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,n){n(186)("Array")},function(e,t,n){var i=n(2),r=n(9),a=n(4),o=n(23)("species");e.exports=function(e){var t=i[e];a&&t&&!t[o]&&r.f(t,o,{configurable:!0,get:function(){return this}})}},function(e,t,i){var r=i(2),a=i(80),o=i(9).f,s=i(48).f,l=i(128),u=i(188),c=r.RegExp,h=c,d=c.prototype,f=/a/g,p=/a/g,m=new c(f)!==f;if(i(4)&&(!m||i(5)(function(){return p[i(23)("match")]=!1,c(f)!=f||c(p)==p||"/a/i"!=c(f,"i")}))){c=function(e,t){var i=this instanceof c,r=l(e),o=t===n;return!i&&r&&e.constructor===c&&o?e:a(m?new h(r&&!o?e.source:e,t):h((r=e instanceof c)?e.source:e,r&&o?u.call(e):t),i?this:d,c)};for(var g=s(h),v=0;g.length>v;)!function(e){e in c||o(c,e,{configurable:!0,get:function(){return h[e]},set:function(t){h[e]=t}})}(g[v++]);d.constructor=c,c.prototype=d,i(16)(r,"RegExp",c)}i(186)("RegExp")},function(e,t,n){var i=n(10);e.exports=function(){var e=i(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,i){i(190);var r=i(10),a=i(188),o=i(4),s="toString",l=/./[s],u=function(e){i(16)(RegExp.prototype,s,e,!0)};i(5)(function(){return"/a/b"!=l.call({source:"a",flags:"b"})})?u(function(){var e=r(this);return"/".concat(e.source,"/","flags"in e?e.flags:!o&&e instanceof RegExp?a.call(e):n)}):l.name!=s&&u(function(){return l.call(this)})},function(e,t,n){n(4)&&"g"!=/./g.flags&&n(9).f(RegExp.prototype,"flags",{configurable:!0,get:n(188)})},function(e,t,i){i(192)("match",1,function(e,t,i){return[function(i){var r=e(this),a=i==n?n:i[t];return a!==n?a.call(i,r):new RegExp(i)[t](String(r))},i]})},function(e,t,n){var i=n(8),r=n(16),a=n(5),o=n(33),s=n(23);e.exports=function(e,t,n){var l=s(e),u=n(o,l,""[e]),c=u[0],h=u[1];a(function(){var t={};return t[l]=function(){return 7},7!=""[e](t)})&&(r(String.prototype,e,c),i(RegExp.prototype,l,2==t?function(e,t){return h.call(e,this,t)}:function(e){return h.call(e,this)}))}},function(e,t,i){i(192)("replace",2,function(e,t,i){return[function(r,a){var o=e(this),s=r==n?n:r[t];return s!==n?s.call(r,o,a):i.call(String(o),r,a)},i]})},function(e,t,i){i(192)("search",1,function(e,t,i){return[function(i){var r=e(this),a=i==n?n:i[t];return a!==n?a.call(i,r):new RegExp(i)[t](String(r))},i]})},function(e,t,i){i(192)("split",2,function(e,t,r){var a=i(128),o=r,s=[].push,l="split",u="length",c="lastIndex";if("c"=="abbc"[l](/(b)*/)[1]||4!="test"[l](/(?:)/,-1)[u]||2!="ab"[l](/(?:ab)*/)[u]||4!="."[l](/(.?)(.?)/)[u]||"."[l](/()()/)[u]>1||""[l](/.?/)[u]){var h=/()??/.exec("")[1]===n;r=function(e,t){var i=String(this);if(e===n&&0===t)return[];if(!a(e))return o.call(i,e,t);var r,l,d,f,p,m=[],g=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),v=0,y=t===n?4294967295:t>>>0,E=new RegExp(e.source,g+"g");for(h||(r=new RegExp("^"+E.source+"$(?!\\s)",g));(l=E.exec(i))&&!((d=l.index+l[0][u])>v&&(m.push(i.slice(v,l.index)),!h&&l[u]>1&&l[0].replace(r,function(){for(p=1;p<arguments[u]-2;p++)arguments[p]===n&&(l[p]=n)}),l[u]>1&&l.index<i[u]&&s.apply(m,l.slice(1)),f=l[0][u],v=d,m[u]>=y));)E[c]===l.index&&E[c]++;return v===i[u]?!f&&E.test("")||m.push(""):m.push(i.slice(v)),m[u]>y?m.slice(0,y):m}}else"0"[l](n,0)[u]&&(r=function(e,t){return e===n&&0===t?[]:o.call(this,e,t)});return[function(i,a){var o=e(this),s=i==n?n:i[t];return s!==n?s.call(i,o,a):r.call(String(o),i,a)},r]})},function(e,t,i){var r,a,o,s=i(26),l=i(2),u=i(18),c=i(73),h=i(6),d=i(11),f=i(19),p=i(197),m=i(198),g=i(199),v=i(200).set,y=i(201)(),E="Promise",b=l.TypeError,x=l.process,M=l[E],x=l.process,_="process"==c(x),C=function(){},I=!!function(){try{var e=M.resolve(1),t=(e.constructor={})[i(23)("species")]=function(e){e(C,C)};return(_||"function"==typeof PromiseRejectionEvent)&&e.then(C)instanceof t}catch(e){}}(),O=function(e,t){return e===t||e===M&&t===o},T=function(e){var t;return!(!d(e)||"function"!=typeof(t=e.then))&&t},L=function(e){return O(M,e)?new S(e):new a(e)},S=a=function(e){var t,i;this.promise=new e(function(e,r){if(t!==n||i!==n)throw b("Bad Promise constructor");t=e,i=r}),this.resolve=f(t),this.reject=f(i)},D=function(e){try{e()}catch(e){return{error:e}}},w=function(e,t){if(!e._n){e._n=!0;var n=e._c;y(function(){for(var i=e._v,r=1==e._s,a=0;n.length>a;)!function(t){var n,a,o=r?t.ok:t.fail,s=t.resolve,l=t.reject,u=t.domain;try{o?(r||(2==e._h&&A(e),e._h=1),!0===o?n=i:(u&&u.enter(),n=o(i),u&&u.exit()),n===t.promise?l(b("Promise-chain cycle")):(a=T(n))?a.call(n,s,l):s(n)):l(i)}catch(e){l(e)}}(n[a++]);e._c=[],e._n=!1,t&&!e._h&&U(e)})}},U=function(e){v.call(l,function(){var t,i,r,a=e._v;if(R(e)&&(t=D(function(){_?x.emit("unhandledRejection",a,e):(i=l.onunhandledrejection)?i({promise:e,reason:a}):(r=l.console)&&r.error&&r.error("Unhandled promise rejection",a)}),e._h=_||R(e)?2:1),e._a=n,t)throw t.error})},R=function e(t){if(1==t._h)return!1;for(var n,i=t._a||t._c,r=0;i.length>r;)if(n=i[r++],n.fail||!e(n.promise))return!1;return!0},A=function(e){v.call(l,function(){var t;_?x.emit("rejectionHandled",e):(t=l.onrejectionhandled)&&t({promise:e,reason:e._v})})},N=function(e){var t=this;t._d||(t._d=!0,t=t._w||t,t._v=e,t._s=2,t._a||(t._a=t._c.slice()),w(t,!0))},P=function e(t){var n,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===t)throw b("Promise can't be resolved itself");(n=T(t))?y(function(){var r={_w:i,_d:!1};try{n.call(t,u(e,r,1),u(N,r,1))}catch(e){N.call(r,e)}}):(i._v=t,i._s=1,w(i,!1))}catch(e){N.call({_w:i,_d:!1},e)}}};I||(M=function(e){p(this,M,E,"_h"),f(e),r.call(this);try{e(u(P,this,1),u(N,this,1))}catch(e){N.call(this,e)}},r=function(e){this._c=[],this._a=n,this._s=0,this._d=!1,this._v=n,this._h=0,this._n=!1},r.prototype=i(202)(M.prototype,{then:function(e,t){var i=L(g(this,M));return i.ok="function"!=typeof e||e,i.fail="function"==typeof t&&t,i.domain=_?x.domain:n,this._c.push(i),this._a&&this._a.push(i),this._s&&w(this,!1),i.promise},catch:function(e){return this.then(n,e)}}),S=function(){var e=new r;this.promise=e,this.resolve=u(P,e,1),this.reject=u(N,e,1)}),h(h.G+h.W+h.F*!I,{Promise:M}),i(22)(M,E),i(186)(E),o=i(7)[E],h(h.S+h.F*!I,E,{reject:function(e){var t=L(this);return(0,t.reject)(e),t.promise}}),h(h.S+h.F*(s||!I),E,{resolve:function(e){if(e instanceof M&&O(e.constructor,this))return e;var t=L(this);return(0,t.resolve)(e),t.promise}}),h(h.S+h.F*!(I&&i(157)(function(e){M.all(e).catch(C)})),E,{all:function(e){var t=this,i=L(t),r=i.resolve,a=i.reject,o=D(function(){var i=[],o=0,s=1;m(e,!1,function(e){var l=o++,u=!1;i.push(n),s++,t.resolve(e).then(function(e){u||(u=!0,i[l]=e,--s||r(i))},a)}),--s||r(i)});return o&&a(o.error),i.promise},race:function(e){var t=this,n=L(t),i=n.reject,r=D(function(){m(e,!1,function(e){t.resolve(e).then(n.resolve,i)})});return r&&i(r.error),n.promise}})},function(e,t){e.exports=function(e,t,i,r){if(!(e instanceof t)||r!==n&&r in e)throw TypeError(i+": incorrect invocation!");return e}},function(e,t,n){var i=n(18),r=n(153),a=n(154),o=n(10),s=n(35),l=n(156),u={},c={},t=e.exports=function(e,t,n,h,d){var f,p,m,g,v=d?function(){return e}:l(e),y=i(n,h,t?2:1),E=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(a(v)){for(f=s(e.length);f>E;E++)if((g=t?y(o(p=e[E])[0],p[1]):y(e[E]))===u||g===c)return g}else for(m=v.call(e);!(p=m.next()).done;)if((g=r(m,y,p.value,t))===u||g===c)return g};t.BREAK=u,t.RETURN=c},function(e,t,i){var r=i(10),a=i(19),o=i(23)("species");e.exports=function(e,t){var i,s=r(e).constructor;return s===n||(i=r(s)[o])==n?t:a(i)}},function(e,t,n){var i,r,a,o=n(18),s=n(76),l=n(46),u=n(13),c=n(2),h=c.process,d=c.setImmediate,f=c.clearImmediate,p=c.MessageChannel,m=0,g={},v="onreadystatechange",y=function(){var e=+this;if(g.hasOwnProperty(e)){var t=g[e];delete g[e],t()}},E=function(e){y.call(e.data)};d&&f||(d=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return g[++m]=function(){s("function"==typeof e?e:Function(e),t)},i(m),m},f=function(e){delete g[e]},"process"==n(32)(h)?i=function(e){h.nextTick(o(y,e,1))}:p?(r=new p,a=r.port2,r.port1.onmessage=E,i=o(a.postMessage,a,1)):c.addEventListener&&"function"==typeof postMessage&&!c.importScripts?(i=function(e){c.postMessage(e+"","*")},c.addEventListener("message",E,!1)):i=v in u("script")?function(e){l.appendChild(u("script"))[v]=function(){l.removeChild(this),y.call(e)}}:function(e){setTimeout(o(y,e,1),0)}),e.exports={set:d,clear:f}},function(e,t,i){var r=i(2),a=i(200).set,o=r.MutationObserver||r.WebKitMutationObserver,s=r.process,l=r.Promise,u="process"==i(32)(s);e.exports=function(){var e,t,i,c=function(){var r,a;for(u&&(r=s.domain)&&r.exit();e;){a=e.fn,e=e.next;try{a()}catch(r){throw e?i():t=n,r}}t=n,r&&r.enter()};if(u)i=function(){s.nextTick(c)};else if(o){var h=!0,d=document.createTextNode("");new o(c).observe(d,{characterData:!0}),i=function(){d.data=h=!h}}else if(l&&l.resolve){var f=l.resolve();i=function(){f.then(c)}}else i=function(){a.call(r,c)};return function(r){var a={fn:r,next:n};t&&(t.next=a),e||(e=a,i()),t=a}}},function(e,t,n){var i=n(16);e.exports=function(e,t,n){for(var r in t)i(e,r,t[r],n);return e}},function(e,t,i){var r=i(204);e.exports=i(205)("Map",function(e){return function(){return e(this,arguments.length>0?arguments[0]:n)}},{get:function(e){var t=r.getEntry(this,e);return t&&t.v},set:function(e,t){return r.def(this,0===e?0:e,t)}},r,!0)},function(e,t,i){var r=i(9).f,a=i(44),o=i(202),s=i(18),l=i(197),u=i(33),c=i(198),h=i(134),d=i(184),f=i(186),p=i(4),m=i(20).fastKey,g=p?"_s":"size",v=function(e,t){var n,i=m(t);if("F"!==i)return e._i[i];for(n=e._f;n;n=n.n)if(n.k==t)return n};e.exports={getConstructor:function(e,t,i,h){var d=e(function(e,r){l(e,d,t,"_i"),e._i=a(null),e._f=n,e._l=n,e[g]=0,r!=n&&c(r,i,e[h],e)});return o(d.prototype,{clear:function(){for(var e=this,t=e._i,i=e._f;i;i=i.n)i.r=!0,i.p&&(i.p=i.p.n=n),delete t[i.i];e._f=e._l=n,e[g]=0},delete:function(e){var t=this,n=v(t,e);if(n){var i=n.n,r=n.p;delete t._i[n.i],n.r=!0,r&&(r.n=i),i&&(i.p=r),t._f==n&&(t._f=i),t._l==n&&(t._l=r),t[g]--}return!!n},forEach:function(e){l(this,d,"forEach");for(var t,i=s(e,arguments.length>1?arguments[1]:n,3);t=t?t.n:this._f;)for(i(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!v(this,e)}}),p&&r(d.prototype,"size",{get:function(){return u(this[g])}}),d},def:function(e,t,i){var r,a,o=v(e,t);return o?o.v=i:(e._l=o={i:a=m(t,!0),k:t,v:i,p:r=e._l,n:n,r:!1},e._f||(e._f=o),r&&(r.n=o),e[g]++,"F"!==a&&(e._i[a]=o)),e},getEntry:v,setStrong:function(e,t,i){h(e,t,function(e,t){this._t=e,this._k=t,this._l=n},function(){for(var e=this,t=e._k,i=e._l;i&&i.r;)i=i.p;return e._t&&(e._l=i=i?i.n:e._t._f)?"keys"==t?d(0,i.k):"values"==t?d(0,i.v):d(0,[i.k,i.v]):(e._t=n,d(1))},i?"entries":"values",!i,!0),f(t)}}},function(e,t,i){var r=i(2),a=i(6),o=i(16),s=i(202),l=i(20),u=i(198),c=i(197),h=i(11),d=i(5),f=i(157),p=i(22),m=i(80);e.exports=function(e,t,i,g,v,y){var E=r[e],b=E,x=v?"set":"add",M=b&&b.prototype,_={},C=function(e){var t=M[e];o(M,e,"delete"==e?function(e){return!(y&&!h(e))&&t.call(this,0===e?0:e)}:"has"==e?function(e){return!(y&&!h(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return y&&!h(e)?n:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,n){return t.call(this,0===e?0:e,n),this})};if("function"==typeof b&&(y||M.forEach&&!d(function(){(new b).entries().next()}))){var I=new b,O=I[x](y?{}:-0,1)!=I,T=d(function(){I.has(1)}),L=f(function(e){new b(e)}),S=!y&&d(function(){for(var e=new b,t=5;t--;)e[x](t,t);return!e.has(-0)});L||(b=t(function(t,i){c(t,b,e);var r=m(new E,t,b);return i!=n&&u(i,v,r[x],r),r}),b.prototype=M,M.constructor=b),(T||S)&&(C("delete"),C("has"),v&&C("get")),(S||O)&&C(x),y&&M.clear&&delete M.clear}else b=g.getConstructor(t,e,v,x),s(b.prototype,i),l.NEED=!0;return p(b,e),_[e]=b,a(a.G+a.W+a.F*(b!=E),_),y||g.setStrong(b,e,v),b}},function(e,t,i){var r=i(204);e.exports=i(205)("Set",function(e){return function(){return e(this,arguments.length>0?arguments[0]:n)}},{add:function(e){return r.def(this,e=0===e?0:e,e)}},r)},function(e,t,i){var r,a=i(164)(0),o=i(16),s=i(20),l=i(67),u=i(208),c=i(11),h=s.getWeak,d=Object.isExtensible,f=u.ufstore,p={},m=function(e){return function(){return e(this,arguments.length>0?arguments[0]:n)}},g={get:function(e){if(c(e)){var t=h(e);return!0===t?f(this).get(e):t?t[this._i]:n}},set:function(e,t){return u.def(this,e,t)}},v=e.exports=i(205)("WeakMap",m,g,u,!0,!0);7!=(new v).set((Object.freeze||Object)(p),7).get(p)&&(r=u.getConstructor(m),l(r.prototype,g),s.NEED=!0,a(["delete","has","get","set"],function(e){var t=v.prototype,n=t[e];o(t,e,function(t,i){if(c(t)&&!d(t)){this._f||(this._f=new r);var a=this._f[e](t,i);return"set"==e?this:a}return n.call(this,t,i)})}))},function(e,t,i){var r=i(202),a=i(20).getWeak,o=i(10),s=i(11),l=i(197),u=i(198),c=i(164),h=i(3),d=c(5),f=c(6),p=0,m=function(e){return e._l||(e._l=new g)},g=function(){this.a=[]},v=function(e,t){return d(e.a,function(e){return e[0]===t})};g.prototype={get:function(e){var t=v(this,e);if(t)return t[1]},has:function(e){return!!v(this,e)},set:function(e,t){var n=v(this,e);n?n[1]=t:this.a.push([e,t])},delete:function(e){var t=f(this.a,function(t){return t[0]===e});return~t&&this.a.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,i,o){var c=e(function(e,r){l(e,c,t,"_i"),e._i=p++,e._l=n,r!=n&&u(r,i,e[o],e)});return r(c.prototype,{delete:function(e){if(!s(e))return!1;var t=a(e);return!0===t?m(this).delete(e):t&&h(t,this._i)&&delete t[this._i]},has:function(e){if(!s(e))return!1;var t=a(e);return!0===t?m(this).has(e):t&&h(t,this._i)}}),c},def:function(e,t,n){var i=a(o(t),!0);return!0===i?m(e).set(t,n):i[e._i]=n,e},ufstore:m}},function(e,t,i){var r=i(208);i(205)("WeakSet",function(e){return function(){return e(this,arguments.length>0?arguments[0]:n)}},{add:function(e){return r.def(this,e,!0)}},r,!1,!0)},function(e,t,n){var i=n(6),r=n(19),a=n(10),o=(n(2).Reflect||{}).apply,s=Function.apply;i(i.S+i.F*!n(5)(function(){o(function(){})}),"Reflect",{apply:function(e,t,n){var i=r(e),l=a(n);return o?o(i,t,l):s.call(i,t,l)}})},function(e,t,n){var i=n(6),r=n(44),a=n(19),o=n(10),s=n(11),l=n(5),u=n(75),c=(n(2).Reflect||{}).construct,h=l(function(){function e(){}return!(c(function(){},[],e)instanceof e)}),d=!l(function(){c(function(){})});i(i.S+i.F*(h||d),"Reflect",{construct:function(e,t){a(e),o(t);var n=arguments.length<3?e:a(arguments[2]);if(d&&!h)return c(e,t,n);if(e==n){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var i=[null];return i.push.apply(i,t),new(u.apply(e,i))}var l=n.prototype,f=r(s(l)?l:Object.prototype),p=Function.apply.call(e,f,t);return s(p)?p:f}})},function(e,t,n){var i=n(9),r=n(6),a=n(10),o=n(14);r(r.S+r.F*n(5)(function(){Reflect.defineProperty(i.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(e,t,n){a(e),t=o(t,!0),a(n);try{return i.f(e,t,n),!0}catch(e){return!1}}})},function(e,t,n){var i=n(6),r=n(49).f,a=n(10);i(i.S,"Reflect",{deleteProperty:function(e,t){var n=r(a(e),t);return!(n&&!n.configurable)&&delete e[t]}})},function(e,t,i){var r=i(6),a=i(10),o=function(e){this._t=a(e),this._i=0;var t,n=this._k=[];for(t in e)n.push(t)};i(136)(o,"Object",function(){var e,t=this,i=t._k;do{if(t._i>=i.length)return{value:n,done:!0}}while(!((e=i[t._i++])in t._t));return{value:e,done:!1}}),r(r.S,"Reflect",{enumerate:function(e){return new o(e)}})},function(e,t,i){function r(e,t){var i,l,h=arguments.length<3?e:arguments[2];return c(e)===h?e[t]:(i=a.f(e,t))?s(i,"value")?i.value:i.get!==n?i.get.call(h):n:u(l=o(e))?r(l,t,h):void 0}var a=i(49),o=i(57),s=i(3),l=i(6),u=i(11),c=i(10);l(l.S,"Reflect",{get:r})},function(e,t,n){var i=n(49),r=n(6),a=n(10);r(r.S,"Reflect",{getOwnPropertyDescriptor:function(e,t){return i.f(a(e),t)}})},function(e,t,n){var i=n(6),r=n(57),a=n(10);i(i.S,"Reflect",{getPrototypeOf:function(e){return r(a(e))}})},function(e,t,n){var i=n(6);i(i.S,"Reflect",{has:function(e,t){return t in e}})},function(e,t,n){var i=n(6),r=n(10),a=Object.isExtensible;i(i.S,"Reflect",{isExtensible:function(e){return r(e),!a||a(e)}})},function(e,t,n){var i=n(6);i(i.S,"Reflect",{ownKeys:n(221)})},function(e,t,n){var i=n(48),r=n(41),a=n(10),o=n(2).Reflect;e.exports=o&&o.ownKeys||function(e){var t=i.f(a(e)),n=r.f;return n?t.concat(n(e)):t}},function(e,t,n){var i=n(6),r=n(10),a=Object.preventExtensions;i(i.S,"Reflect",{preventExtensions:function(e){r(e);try{return a&&a(e),!0}catch(e){return!1}}})},function(e,t,i){function r(e,t,i){var u,f,p=arguments.length<4?e:arguments[3],m=o.f(h(e),t);if(!m){if(d(f=s(e)))return r(f,t,i,p);m=c(0)}return l(m,"value")?!(!1===m.writable||!d(p)||(u=o.f(p,t)||c(0),u.value=i,a.f(p,t,u),0)):m.set!==n&&(m.set.call(p,i),!0)}var a=i(9),o=i(49),s=i(57),l=i(3),u=i(6),c=i(15),h=i(10),d=i(11);u(u.S,"Reflect",{set:r})},function(e,t,n){var i=n(6),r=n(71);r&&i(i.S,"Reflect",{setPrototypeOf:function(e,t){r.check(e,t);try{return r.set(e,t),!0}catch(e){return!1}}})},function(e,t,n){var i=n(6);i(i.S,"Date",{now:function(){return(new Date).getTime()}})},function(e,t,n){var i=n(6),r=n(56),a=n(14);i(i.P+i.F*n(5)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(e){var t=r(this),n=a(t);return"number"!=typeof n||isFinite(n)?t.toISOString():null}})},function(e,t,n){var i=n(6),r=n(5),a=Date.prototype.getTime,o=function(e){return e>9?e:"0"+e};i(i.P+i.F*(r(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!r(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){if(!isFinite(a.call(this)))throw RangeError("Invalid time value");var e=this,t=e.getUTCFullYear(),n=e.getUTCMilliseconds(),i=t<0?"-":t>9999?"+":"";return i+("00000"+Math.abs(t)).slice(i?-6:-4)+"-"+o(e.getUTCMonth()+1)+"-"+o(e.getUTCDate())+"T"+o(e.getUTCHours())+":"+o(e.getUTCMinutes())+":"+o(e.getUTCSeconds())+"."+(n>99?n:"0"+o(n))+"Z"}})},function(e,t,n){var i=Date.prototype,r="Invalid Date",a="toString",o=i[a],s=i.getTime;new Date(NaN)+""!=r&&n(16)(i,a,function(){var e=s.call(this);return e===e?o.call(this):r})},function(e,t,n){var i=n(23)("toPrimitive"),r=Date.prototype;i in r||n(8)(r,i,n(230))},function(e,t,n){var i=n(10),r=n(14),a="number";e.exports=function(e){if("string"!==e&&e!==a&&"default"!==e)throw TypeError("Incorrect hint");return r(i(this),e!=a)}},function(e,t,i){var r=i(6),a=i(232),o=i(233),s=i(10),l=i(37),u=i(35),c=i(11),h=i(2).ArrayBuffer,d=i(199),f=o.ArrayBuffer,p=o.DataView,m=a.ABV&&h.isView,g=f.prototype.slice,v=a.VIEW,y="ArrayBuffer";r(r.G+r.W+r.F*(h!==f),{ArrayBuffer:f}),r(r.S+r.F*!a.CONSTR,y,{isView:function(e){return m&&m(e)||c(e)&&v in e}}),r(r.P+r.U+r.F*i(5)(function(){return!new f(2).slice(1,n).byteLength}),y,{slice:function(e,t){if(g!==n&&t===n)return g.call(s(this),e);for(var i=s(this).byteLength,r=l(e,i),a=l(t===n?i:t,i),o=new(d(this,f))(u(a-r)),c=new p(this),h=new p(o),m=0;r<a;)h.setUint8(m++,c.getUint8(r++));return o}}),i(186)(y)},function(e,t,n){for(var i,r=n(2),a=n(8),o=n(17),s=o("typed_array"),l=o("view"),u=!(!r.ArrayBuffer||!r.DataView),c=u,h=0,d="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");h<9;)(i=r[d[h++]])?(a(i.prototype,s,!0),a(i.prototype,l,!0)):c=!1;e.exports={ABV:u,CONSTR:c,TYPED:s,VIEW:l}},function(e,t,i){var r=i(2),a=i(4),o=i(26),s=i(232),l=i(8),u=i(202),c=i(5),h=i(197),d=i(36),f=i(35),p=i(48).f,m=i(9).f,g=i(180),v=i(22),y="ArrayBuffer",E="DataView",b="prototype",x="Wrong length!",M="Wrong index!",_=r[y],C=r[E],I=r.Math,O=r.RangeError,T=r.Infinity,L=_,S=I.abs,D=I.pow,w=I.floor,U=I.log,R=I.LN2,A="buffer",N="byteLength",P="byteOffset",k=a?"_b":A,B=a?"_l":N,F=a?"_o":P,H=function(e,t,n){var i,r,a,o=Array(n),s=8*n-t-1,l=(1<<s)-1,u=l>>1,c=23===t?D(2,-24)-D(2,-77):0,h=0,d=e<0||0===e&&1/e<0?1:0;for(e=S(e),e!=e||e===T?(r=e!=e?1:0,i=l):(i=w(U(e)/R),e*(a=D(2,-i))<1&&(i--,a*=2),e+=i+u>=1?c/a:c*D(2,1-u),e*a>=2&&(i++,a/=2),i+u>=l?(r=0,i=l):i+u>=1?(r=(e*a-1)*D(2,t),i+=u):(r=e*D(2,u-1)*D(2,t),i=0));t>=8;o[h++]=255&r,r/=256,t-=8);for(i=i<<t|r,s+=t;s>0;o[h++]=255&i,i/=256,s-=8);return o[--h]|=128*d,o},G=function(e,t,n){var i,r=8*n-t-1,a=(1<<r)-1,o=a>>1,s=r-7,l=n-1,u=e[l--],c=127&u;for(u>>=7;s>0;c=256*c+e[l],l--,s-=8);for(i=c&(1<<-s)-1,c>>=-s,s+=t;s>0;i=256*i+e[l],l--,s-=8);if(0===c)c=1-o;else{if(c===a)return i?NaN:u?-T:T;i+=D(2,t),c-=o}return(u?-1:1)*i*D(2,c-t)},V=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},z=function(e){return[255&e]},j=function(e){return[255&e,e>>8&255]},W=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},X=function(e){return H(e,52,8)},Y=function(e){return H(e,23,4)},q=function(e,t,n){m(e[b],t,{get:function(){return this[n]}})},Z=function(e,t,n,i){var r=+n,a=d(r);if(r!=a||a<0||a+t>e[B])throw O(M);var o=e[k]._b,s=a+e[F],l=o.slice(s,s+t);return i?l:l.reverse()},K=function(e,t,n,i,r,a){var o=+n,s=d(o);if(o!=s||s<0||s+t>e[B])throw O(M);for(var l=e[k]._b,u=s+e[F],c=i(+r),h=0;h<t;h++)l[u+h]=c[a?h:t-h-1]},Q=function(e,t){h(e,_,y);var n=+t,i=f(n);if(n!=i)throw O(x);return i};if(s.ABV){if(!c(function(){new _})||!c(function(){new _(.5)})){_=function(e){return new L(Q(this,e))};for(var J,$=_[b]=L[b],ee=p(L),te=0;ee.length>te;)(J=ee[te++])in _||l(_,J,L[J]);o||($.constructor=_)}var ne=new C(new _(2)),ie=C[b].setInt8;ne.setInt8(0,2147483648),ne.setInt8(1,2147483649),!ne.getInt8(0)&&ne.getInt8(1)||u(C[b],{setInt8:function(e,t){ie.call(this,e,t<<24>>24)},setUint8:function(e,t){ie.call(this,e,t<<24>>24)}},!0)}else _=function(e){var t=Q(this,e);this._b=g.call(Array(t),0),this[B]=t},C=function(e,t,i){h(this,C,E),h(e,_,E);var r=e[B],a=d(t);if(a<0||a>r)throw O("Wrong offset!");if(i=i===n?r-a:f(i),a+i>r)throw O(x);this[k]=e,this[F]=a,this[B]=i},a&&(q(_,N,"_l"),q(C,A,"_b"),q(C,N,"_l"),q(C,P,"_o")),u(C[b],{getInt8:function(e){return Z(this,1,e)[0]<<24>>24},getUint8:function(e){return Z(this,1,e)[0]},getInt16:function(e){var t=Z(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=Z(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return V(Z(this,4,e,arguments[1]))},getUint32:function(e){return V(Z(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return G(Z(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return G(Z(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){K(this,1,e,z,t)},setUint8:function(e,t){K(this,1,e,z,t)},setInt16:function(e,t){K(this,2,e,j,t,arguments[2])},setUint16:function(e,t){K(this,2,e,j,t,arguments[2])},setInt32:function(e,t){K(this,4,e,W,t,arguments[2])},setUint32:function(e,t){K(this,4,e,W,t,arguments[2])},setFloat32:function(e,t){K(this,4,e,Y,t,arguments[2])},setFloat64:function(e,t){K(this,8,e,X,t,arguments[2])}});v(_,y),v(C,E),l(C[b],s.VIEW,!0),t[y]=_,t[E]=C},function(e,t,n){var i=n(6);i(i.G+i.W+i.F*!n(232).ABV,{DataView:n(233).DataView})},function(e,t,n){n(236)("Int8",1,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,i){if(i(4)){var r=i(26),a=i(2),o=i(5),s=i(6),l=i(232),u=i(233),c=i(18),h=i(197),d=i(15),f=i(8),p=i(202),m=i(36),g=i(35),v=i(37),y=i(14),E=i(3),b=i(69),x=i(73),M=i(11),_=i(56),C=i(154),I=i(44),O=i(57),T=i(48).f,L=i(156),S=i(17),D=i(23),w=i(164),U=i(34),R=i(199),A=i(183),N=i(135),P=i(157),k=i(186),B=i(180),F=i(177),H=i(9),G=i(49),V=H.f,z=G.f,j=a.RangeError,W=a.TypeError,X=a.Uint8Array,Y="ArrayBuffer",q="Shared"+Y,Z="BYTES_PER_ELEMENT",K="prototype",Q=Array[K],J=u.ArrayBuffer,$=u.DataView,ee=w(0),te=w(2),ne=w(3),ie=w(4),re=w(5),ae=w(6),oe=U(!0),se=U(!1),le=A.values,ue=A.keys,ce=A.entries,he=Q.lastIndexOf,de=Q.reduce,fe=Q.reduceRight,pe=Q.join,me=Q.sort,ge=Q.slice,ve=Q.toString,ye=Q.toLocaleString,Ee=D("iterator"),be=D("toStringTag"),xe=S("typed_constructor"),Me=S("def_constructor"),_e=l.CONSTR,Ce=l.TYPED,Ie=l.VIEW,Oe="Wrong length!",Te=w(1,function(e,t){return Re(R(e,e[Me]),t)}),Le=o(function(){return 1===new X(new Uint16Array([1]).buffer)[0]}),Se=!!X&&!!X[K].set&&o(function(){new X(1).set({})}),De=function(e,t){if(e===n)throw W(Oe);var i=+e,r=g(e);if(t&&!b(i,r))throw j(Oe);return r},we=function(e,t){var n=m(e);if(n<0||n%t)throw j("Wrong offset!");return n},Ue=function(e){if(M(e)&&Ce in e)return e;throw W(e+" is not a typed array!")},Re=function(e,t){if(!(M(e)&&xe in e))throw W("It is not a typed array constructor!");return new e(t)},Ae=function(e,t){return Ne(R(e,e[Me]),t)},Ne=function(e,t){for(var n=0,i=t.length,r=Re(e,i);i>n;)r[n]=t[n++];return r},Pe=function(e,t,n){V(e,t,{get:function(){return this._d[n]}})},ke=function(e){var t,i,r,a,o,s,l=_(e),u=arguments.length,h=u>1?arguments[1]:n,d=h!==n,f=L(l);if(f!=n&&!C(f)){for(s=f.call(l),r=[],t=0;!(o=s.next()).done;t++)r.push(o.value);l=r}for(d&&u>2&&(h=c(h,arguments[2],2)),t=0,i=g(l.length),a=Re(this,i);i>t;t++)a[t]=d?h(l[t],t):l[t];return a},Be=function(){for(var e=0,t=arguments.length,n=Re(this,t);t>e;)n[e]=arguments[e++];return n},Fe=!!X&&o(function(){ye.call(new X(1))}),He=function(){return ye.apply(Fe?ge.call(Ue(this)):Ue(this),arguments)},Ge={copyWithin:function(e,t){
return F.call(Ue(this),e,t,arguments.length>2?arguments[2]:n)},every:function(e){return ie(Ue(this),e,arguments.length>1?arguments[1]:n)},fill:function(e){return B.apply(Ue(this),arguments)},filter:function(e){return Ae(this,te(Ue(this),e,arguments.length>1?arguments[1]:n))},find:function(e){return re(Ue(this),e,arguments.length>1?arguments[1]:n)},findIndex:function(e){return ae(Ue(this),e,arguments.length>1?arguments[1]:n)},forEach:function(e){ee(Ue(this),e,arguments.length>1?arguments[1]:n)},indexOf:function(e){return se(Ue(this),e,arguments.length>1?arguments[1]:n)},includes:function(e){return oe(Ue(this),e,arguments.length>1?arguments[1]:n)},join:function(e){return pe.apply(Ue(this),arguments)},lastIndexOf:function(e){return he.apply(Ue(this),arguments)},map:function(e){return Te(Ue(this),e,arguments.length>1?arguments[1]:n)},reduce:function(e){return de.apply(Ue(this),arguments)},reduceRight:function(e){return fe.apply(Ue(this),arguments)},reverse:function(){for(var e,t=this,n=Ue(t).length,i=Math.floor(n/2),r=0;r<i;)e=t[r],t[r++]=t[--n],t[n]=e;return t},some:function(e){return ne(Ue(this),e,arguments.length>1?arguments[1]:n)},sort:function(e){return me.call(Ue(this),e)},subarray:function(e,t){var i=Ue(this),r=i.length,a=v(e,r);return new(R(i,i[Me]))(i.buffer,i.byteOffset+a*i.BYTES_PER_ELEMENT,g((t===n?r:v(t,r))-a))}},Ve=function(e,t){return Ae(this,ge.call(Ue(this),e,t))},ze=function(e){Ue(this);var t=we(arguments[1],1),n=this.length,i=_(e),r=g(i.length),a=0;if(r+t>n)throw j(Oe);for(;a<r;)this[t+a]=i[a++]},je={entries:function(){return ce.call(Ue(this))},keys:function(){return ue.call(Ue(this))},values:function(){return le.call(Ue(this))}},We=function(e,t){return M(e)&&e[Ce]&&"symbol"!=(void 0===t?"undefined":_typeof(t))&&t in e&&String(+t)==String(t)},Xe=function(e,t){return We(e,t=y(t,!0))?d(2,e[t]):z(e,t)},Ye=function(e,t,n){return!(We(e,t=y(t,!0))&&M(n)&&E(n,"value"))||E(n,"get")||E(n,"set")||n.configurable||E(n,"writable")&&!n.writable||E(n,"enumerable")&&!n.enumerable?V(e,t,n):(e[t]=n.value,e)};_e||(G.f=Xe,H.f=Ye),s(s.S+s.F*!_e,"Object",{getOwnPropertyDescriptor:Xe,defineProperty:Ye}),o(function(){ve.call({})})&&(ve=ye=function(){return pe.call(this)});var qe=p({},Ge);p(qe,je),f(qe,Ee,je.values),p(qe,{slice:Ve,set:ze,constructor:function(){},toString:ve,toLocaleString:He}),Pe(qe,"buffer","b"),Pe(qe,"byteOffset","o"),Pe(qe,"byteLength","l"),Pe(qe,"length","e"),V(qe,be,{get:function(){return this[Ce]}}),e.exports=function(e,t,i,u){u=!!u;var c=e+(u?"Clamped":"")+"Array",d="Uint8Array"!=c,p="get"+e,m="set"+e,v=a[c],y=v||{},E=v&&O(v),b=!v||!l.ABV,_={},C=v&&v[K],L=function(e,n){var i=e._d;return i.v[p](n*t+i.o,Le)},S=function(e,n,i){var r=e._d;u&&(i=(i=Math.round(i))<0?0:i>255?255:255&i),r.v[m](n*t+r.o,i,Le)},D=function(e,t){V(e,t,{get:function(){return L(this,t)},set:function(e){return S(this,t,e)},enumerable:!0})};b?(v=i(function(e,i,r,a){h(e,v,c,"_d");var o,s,l,u,d=0,p=0;if(M(i)){if(!(i instanceof J||(u=x(i))==Y||u==q))return Ce in i?Ne(v,i):ke.call(v,i);o=i,p=we(r,t);var m=i.byteLength;if(a===n){if(m%t)throw j(Oe);if((s=m-p)<0)throw j(Oe)}else if((s=g(a)*t)+p>m)throw j(Oe);l=s/t}else l=De(i,!0),s=l*t,o=new J(s);for(f(e,"_d",{b:o,o:p,l:s,e:l,v:new $(o)});d<l;)D(e,d++)}),C=v[K]=I(qe),f(C,"constructor",v)):P(function(e){new v(null),new v(e)},!0)||(v=i(function(e,i,r,a){h(e,v,c);var o;return M(i)?i instanceof J||(o=x(i))==Y||o==q?a!==n?new y(i,we(r,t),a):r!==n?new y(i,we(r,t)):new y(i):Ce in i?Ne(v,i):ke.call(v,i):new y(De(i,d))}),ee(E!==Function.prototype?T(y).concat(T(E)):T(y),function(e){e in v||f(v,e,y[e])}),v[K]=C,r||(C.constructor=v));var w=C[Ee],U=!!w&&("values"==w.name||w.name==n),R=je.values;f(v,xe,!0),f(C,Ce,c),f(C,Ie,!0),f(C,Me,v),(u?new v(1)[be]==c:be in C)||V(C,be,{get:function(){return c}}),_[c]=v,s(s.G+s.W+s.F*(v!=y),_),s(s.S,c,{BYTES_PER_ELEMENT:t,from:ke,of:Be}),Z in C||f(C,Z,t),s(s.P,c,Ge),k(c),s(s.P+s.F*Se,c,{set:ze}),s(s.P+s.F*!U,c,je),s(s.P+s.F*(C.toString!=ve),c,{toString:ve}),s(s.P+s.F*o(function(){new v(1).slice()}),c,{slice:Ve}),s(s.P+s.F*(o(function(){return[1,2].toLocaleString()!=new v([1,2]).toLocaleString()})||!o(function(){C.toLocaleString.call([1,2])})),c,{toLocaleString:He}),N[c]=U?w:R,r||U||f(C,Ee,R)}}else e.exports=function(){}},function(e,t,n){n(236)("Uint8",1,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,n){n(236)("Uint8",1,function(e){return function(t,n,i){return e(this,t,n,i)}},!0)},function(e,t,n){n(236)("Int16",2,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,n){n(236)("Uint16",2,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,n){n(236)("Int32",4,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,n){n(236)("Uint32",4,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,n){n(236)("Float32",4,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,n){n(236)("Float64",8,function(e){return function(t,n,i){return e(this,t,n,i)}})},function(e,t,i){var r=i(6),a=i(34)(!0);r(r.P,"Array",{includes:function(e){return a(this,e,arguments.length>1?arguments[1]:n)}}),i(178)("includes")},function(e,t,n){var i=n(6),r=n(125)(!0);i(i.P,"String",{at:function(e){return r(this,e)}})},function(e,t,i){var r=i(6),a=i(248);r(r.P,"String",{padStart:function(e){return a(this,e,arguments.length>1?arguments[1]:n,!0)}})},function(e,t,i){var r=i(35),a=i(85),o=i(33);e.exports=function(e,t,i,s){var l=String(o(e)),u=l.length,c=i===n?" ":String(i),h=r(t);if(h<=u||""==c)return l;var d=h-u,f=a.call(c,Math.ceil(d/c.length));return f.length>d&&(f=f.slice(0,d)),s?f+l:l+f}},function(e,t,i){var r=i(6),a=i(248);r(r.P,"String",{padEnd:function(e){return a(this,e,arguments.length>1?arguments[1]:n,!1)}})},function(e,t,n){n(81)("trimLeft",function(e){return function(){return e(this,1)}},"trimStart")},function(e,t,n){n(81)("trimRight",function(e){return function(){return e(this,2)}},"trimEnd")},function(e,t,n){var i=n(6),r=n(33),a=n(35),o=n(128),s=n(188),l=RegExp.prototype,u=function(e,t){this._r=e,this._s=t};n(136)(u,"RegExp String",function(){var e=this._r.exec(this._s);return{value:e,done:null===e}}),i(i.P,"String",{matchAll:function(e){if(r(this),!o(e))throw TypeError(e+" is not a regexp!");var t=String(this),n="flags"in l?String(e.flags):s.call(e),i=new RegExp(e.source,~n.indexOf("g")?n:"g"+n);return i.lastIndex=a(e.lastIndex),new u(i,t)}})},function(e,t,n){n(25)("asyncIterator")},function(e,t,n){n(25)("observable")},function(e,t,n){var i=n(6),r=n(221),a=n(30),o=n(49),s=n(155);i(i.S,"Object",{getOwnPropertyDescriptors:function(e){for(var t,n=a(e),i=o.f,l=r(n),u={},c=0;l.length>c;)s(u,t=l[c++],i(n,t));return u}})},function(e,t,n){var i=n(6),r=n(257)(!1);i(i.S,"Object",{values:function(e){return r(e)}})},function(e,t,n){var i=n(28),r=n(30),a=n(42).f;e.exports=function(e){return function(t){for(var n,o=r(t),s=i(o),l=s.length,u=0,c=[];l>u;)a.call(o,n=s[u++])&&c.push(e?[n,o[n]]:o[n]);return c}}},function(e,t,n){var i=n(6),r=n(257)(!0);i(i.S,"Object",{entries:function(e){return r(e)}})},function(e,t,n){var i=n(6),r=n(56),a=n(19),o=n(9);n(4)&&i(i.P+n(260),"Object",{__defineGetter__:function(e,t){o.f(r(this),e,{get:a(t),enumerable:!0,configurable:!0})}})},function(e,t,n){e.exports=n(26)||!n(5)(function(){var e=Math.random();__defineSetter__.call(null,e,function(){}),delete n(2)[e]})},function(e,t,n){var i=n(6),r=n(56),a=n(19),o=n(9);n(4)&&i(i.P+n(260),"Object",{__defineSetter__:function(e,t){o.f(r(this),e,{set:a(t),enumerable:!0,configurable:!0})}})},function(e,t,n){var i=n(6),r=n(56),a=n(14),o=n(57),s=n(49).f;n(4)&&i(i.P+n(260),"Object",{__lookupGetter__:function(e){var t,n=r(this),i=a(e,!0);do{if(t=s(n,i))return t.get}while(n=o(n))}})},function(e,t,n){var i=n(6),r=n(56),a=n(14),o=n(57),s=n(49).f;n(4)&&i(i.P+n(260),"Object",{__lookupSetter__:function(e){var t,n=r(this),i=a(e,!0);do{if(t=s(n,i))return t.set}while(n=o(n))}})},function(e,t,n){var i=n(6);i(i.P+i.R,"Map",{toJSON:n(265)("Map")})},function(e,t,n){var i=n(73),r=n(266);e.exports=function(e){return function(){if(i(this)!=e)throw TypeError(e+"#toJSON isn't generic");return r(this)}}},function(e,t,n){var i=n(198);e.exports=function(e,t){var n=[];return i(e,!1,n.push,n,t),n}},function(e,t,n){var i=n(6);i(i.P+i.R,"Set",{toJSON:n(265)("Set")})},function(e,t,n){var i=n(6);i(i.S,"System",{global:n(2)})},function(e,t,n){var i=n(6),r=n(32);i(i.S,"Error",{isError:function(e){return"Error"===r(e)}})},function(e,t,n){var i=n(6);i(i.S,"Math",{iaddh:function(e,t,n,i){var r=e>>>0,a=t>>>0,o=n>>>0;return a+(i>>>0)+((r&o|(r|o)&~(r+o>>>0))>>>31)|0}})},function(e,t,n){var i=n(6);i(i.S,"Math",{isubh:function(e,t,n,i){var r=e>>>0,a=t>>>0,o=n>>>0;return a-(i>>>0)-((~r&o|~(r^o)&r-o>>>0)>>>31)|0}})},function(e,t,n){var i=n(6);i(i.S,"Math",{imulh:function(e,t){var n=65535,i=+e,r=+t,a=i&n,o=r&n,s=i>>16,l=r>>16,u=(s*o>>>0)+(a*o>>>16);return s*l+(u>>16)+((a*l>>>0)+(u&n)>>16)}})},function(e,t,n){var i=n(6);i(i.S,"Math",{umulh:function(e,t){var n=65535,i=+e,r=+t,a=i&n,o=r&n,s=i>>>16,l=r>>>16,u=(s*o>>>0)+(a*o>>>16);return s*l+(u>>>16)+((a*l>>>0)+(u&n)>>>16)}})},function(e,t,n){var i=n(275),r=n(10),a=i.key,o=i.set;i.exp({defineMetadata:function(e,t,n,i){o(e,t,r(n),a(i))}})},function(e,t,i){var r=i(203),a=i(6),o=i(21)("metadata"),s=o.store||(o.store=new(i(207))),l=function(e,t,i){var a=s.get(e);if(!a){if(!i)return n;s.set(e,a=new r)}var o=a.get(t);if(!o){if(!i)return n;a.set(t,o=new r)}return o},u=function(e,t,i){var r=l(t,i,!1);return r!==n&&r.has(e)},c=function(e,t,i){var r=l(t,i,!1);return r===n?n:r.get(e)},h=function(e,t,n,i){l(n,i,!0).set(e,t)},d=function(e,t){var n=l(e,t,!1),i=[];return n&&n.forEach(function(e,t){i.push(t)}),i},f=function(e){return e===n||"symbol"==(void 0===e?"undefined":_typeof(e))?e:String(e)},p=function(e){a(a.S,"Reflect",e)};e.exports={store:s,map:l,has:u,get:c,set:h,keys:d,key:f,exp:p}},function(e,t,i){var r=i(275),a=i(10),o=r.key,s=r.map,l=r.store;r.exp({deleteMetadata:function(e,t){var i=arguments.length<3?n:o(arguments[2]),r=s(a(t),i,!1);if(r===n||!r.delete(e))return!1;if(r.size)return!0;var u=l.get(t);return u.delete(i),!!u.size||l.delete(t)}})},function(e,t,i){var r=i(275),a=i(10),o=i(57),s=r.has,l=r.get,u=r.key,c=function e(t,i,r){if(s(t,i,r))return l(t,i,r);var a=o(i);return null!==a?e(t,a,r):n};r.exp({getMetadata:function(e,t){return c(e,a(t),arguments.length<3?n:u(arguments[2]))}})},function(e,t,i){var r=i(206),a=i(266),o=i(275),s=i(10),l=i(57),u=o.keys,c=o.key,h=function e(t,n){var i=u(t,n),o=l(t);if(null===o)return i;var s=e(o,n);return s.length?i.length?a(new r(i.concat(s))):s:i};o.exp({getMetadataKeys:function(e){return h(s(e),arguments.length<2?n:c(arguments[1]))}})},function(e,t,i){var r=i(275),a=i(10),o=r.get,s=r.key;r.exp({getOwnMetadata:function(e,t){return o(e,a(t),arguments.length<3?n:s(arguments[2]))}})},function(e,t,i){var r=i(275),a=i(10),o=r.keys,s=r.key;r.exp({getOwnMetadataKeys:function(e){return o(a(e),arguments.length<2?n:s(arguments[1]))}})},function(e,t,i){var r=i(275),a=i(10),o=i(57),s=r.has,l=r.key,u=function e(t,n,i){if(s(t,n,i))return!0;var r=o(n);return null!==r&&e(t,r,i)};r.exp({hasMetadata:function(e,t){return u(e,a(t),arguments.length<3?n:l(arguments[2]))}})},function(e,t,i){var r=i(275),a=i(10),o=r.has,s=r.key;r.exp({hasOwnMetadata:function(e,t){return o(e,a(t),arguments.length<3?n:s(arguments[2]))}})},function(e,t,i){var r=i(275),a=i(10),o=i(19),s=r.key,l=r.set;r.exp({metadata:function(e,t){return function(i,r){l(e,t,(r!==n?a:o)(i),s(r))}}})},function(e,t,n){var i=n(6),r=n(201)(),a=n(2).process,o="process"==n(32)(a);i(i.G,{asap:function(e){var t=o&&a.domain;r(t?t.bind(e):e)}})},function(e,t,i){var r=i(6),a=i(2),o=i(7),s=i(201)(),l=i(23)("observable"),u=i(19),c=i(10),h=i(197),d=i(202),f=i(8),p=i(198),m=p.RETURN,g=function(e){return null==e?n:u(e)},v=function(e){var t=e._c;t&&(e._c=n,t())},y=function(e){return e._o===n},E=function(e){y(e)||(e._o=n,v(e))},b=function(e,t){c(e),this._c=n,this._o=e,e=new x(this);try{var i=t(e),r=i;null!=i&&("function"==typeof i.unsubscribe?i=function(){r.unsubscribe()}:u(i),this._c=i)}catch(t){return void e.error(t)}y(this)&&v(this)};b.prototype=d({},{unsubscribe:function(){E(this)}});var x=function(e){this._s=e};x.prototype=d({},{next:function(e){var t=this._s;if(!y(t)){var n=t._o;try{var i=g(n.next);if(i)return i.call(n,e)}catch(e){try{E(t)}finally{throw e}}}},error:function(e){var t=this._s;if(y(t))throw e;var i=t._o;t._o=n;try{var r=g(i.error);if(!r)throw e;e=r.call(i,e)}catch(e){try{v(t)}finally{throw e}}return v(t),e},complete:function(e){var t=this._s;if(!y(t)){var i=t._o;t._o=n;try{var r=g(i.complete);e=r?r.call(i,e):n}catch(e){try{v(t)}finally{throw e}}return v(t),e}}});var M=function(e){h(this,M,"Observable","_f")._f=u(e)};d(M.prototype,{subscribe:function(e){return new b(e,this._f)},forEach:function(e){var t=this;return new(o.Promise||a.Promise)(function(n,i){u(e);var r=t.subscribe({next:function(t){try{return e(t)}catch(e){i(e),r.unsubscribe()}},error:i,complete:n})})}}),d(M,{from:function(e){var t="function"==typeof this?this:M,n=g(c(e)[l]);if(n){var i=c(n.call(e));return i.constructor===t?i:new t(function(e){return i.subscribe(e)})}return new t(function(t){var n=!1;return s(function(){if(!n){try{if(p(e,!1,function(e){if(t.next(e),n)return m})===m)return}catch(e){if(n)throw e;return void t.error(e)}t.complete()}}),function(){n=!0}})},of:function(){for(var e=0,t=arguments.length,n=Array(t);e<t;)n[e]=arguments[e++];return new("function"==typeof this?this:M)(function(e){var t=!1;return s(function(){if(!t){for(var i=0;i<n.length;++i)if(e.next(n[i]),t)return;e.complete()}}),function(){t=!0}})}}),f(M.prototype,l,function(){return this}),r(r.G,{Observable:M}),i(186)("Observable")},function(e,t,n){var i=n(6),r=n(200);i(i.G+i.B,{setImmediate:r.set,clearImmediate:r.clear})},function(e,t,n){for(var i=n(183),r=n(16),a=n(2),o=n(8),s=n(135),l=n(23),u=l("iterator"),c=l("toStringTag"),h=s.Array,d=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var p,m=d[f],g=a[m],v=g&&g.prototype;if(v){v[u]||o(v,u,h),v[c]||o(v,c,m),s[m]=h;for(p in i)v[p]||r(v,p,i[p],!0)}}},function(e,t,n){var i=n(2),r=n(6),a=n(76),o=n(289),s=i.navigator,l=!!s&&/MSIE .\./.test(s.userAgent),u=function(e){return l?function(t,n){return e(a(o,[].slice.call(arguments,2),"function"==typeof t?t:Function(t)),n)}:e};r(r.G+r.B+r.F*l,{setTimeout:u(i.setTimeout),setInterval:u(i.setInterval)})},function(e,t,n){var i=n(290),r=n(76),a=n(19);e.exports=function(){for(var e=a(this),t=arguments.length,n=Array(t),o=0,s=i._,l=!1;t>o;)(n[o]=arguments[o++])===s&&(l=!0);return function(){var i,a=this,o=arguments.length,u=0,c=0;if(!l&&!o)return r(e,n,a);if(i=n.slice(),l)for(;t>u;u++)i[u]===s&&(i[u]=arguments[c++]);for(;o>c;)i.push(arguments[c++]);return r(e,i,a)}}},function(e,t,n){e.exports=n(2)},function(e,t,i){function r(e){var t=p(null);return e!=n&&(x(e)?b(e,!0,function(e,n){t[e]=n}):f(t,e)),t}function a(e,t,n){E(t);var i,r,a=I(e),o=g(a),s=o.length,l=0;if(arguments.length<3){if(!s)throw TypeError("Reduce of empty object with no initial value");i=a[o[l++]]}else i=Object(n);for(;s>l;)T(a,r=o[l++])&&(i=t(i,a[r],r,e));return i}function o(e,t){return(t==t?y(e,t):S(e,function(e){return e!=e}))!==n}function s(e,t){if(T(e,t))return e[t]}function l(e,t,n){return O&&t in Object?v.f(e,t,d(0,n)):e[t]=n,e}function u(e){return C(e)&&m(e)===r.prototype}var c=i(18),h=i(6),d=i(15),f=i(67),p=i(44),m=i(57),g=i(28),v=i(9),y=i(27),E=i(19),b=i(198),x=i(292),M=i(136),_=i(184),C=i(11),I=i(30),O=i(4),T=i(3),L=function(e){var t=1==e,i=4==e;return function(a,o,s){var l,u,h,d=c(o,s,3),f=I(a),p=t||7==e||2==e?new("function"==typeof this?this:r):n;for(l in f)if(T(f,l)&&(u=f[l],h=d(u,l,a),e))if(t)p[l]=h;else if(h)switch(e){case 2:p[l]=u;break;case 3:return!0;case 5:return u;case 6:return l;case 7:p[h[0]]=h[1]}else if(i)return!1;return 3==e||i?i:p}},S=L(6),D=function(e){return function(t){return new w(t,e)}},w=function(e,t){this._t=I(e),this._a=g(e),this._i=0,this._k=t};M(w,"Dict",function(){var e,t=this,i=t._t,r=t._a,a=t._k;do{if(t._i>=r.length)return t._t=n,_(1)}while(!T(i,e=r[t._i++]));return"keys"==a?_(0,e):"values"==a?_(0,i[e]):_(0,[e,i[e]])}),r.prototype=null,h(h.G+h.F,{Dict:r}),h(h.S,"Dict",{keys:D("keys"),values:D("values"),entries:D("entries"),forEach:L(0),map:L(1),filter:L(2),some:L(3),every:L(4),find:L(5),findKey:S,mapPairs:L(7),reduce:a,keyOf:y,includes:o,has:T,get:s,set:l,isDict:u})},function(e,t,i){var r=i(73),a=i(23)("iterator"),o=i(135);e.exports=i(7).isIterable=function(e){var t=Object(e);return t[a]!==n||"@@iterator"in t||o.hasOwnProperty(r(t))}},function(e,t,n){var i=n(10),r=n(156);e.exports=n(7).getIterator=function(e){var t=r(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return i(t.call(e))}},function(e,t,n){var i=n(2),r=n(7),a=n(6),o=n(289);a(a.G+a.F,{delay:function(e){return new(r.Promise||i.Promise)(function(t){setTimeout(o.call(t,!0),e)})}})},function(e,t,n){var i=n(290),r=n(6);n(7)._=i._=i._||{},r(r.P+r.F,"Function",{part:n(289)})},function(e,t,n){var i=n(6);i(i.S+i.F,"Object",{isObject:n(11)})},function(e,t,n){var i=n(6);i(i.S+i.F,"Object",{classof:n(73)})},function(e,t,n){var i=n(6),r=n(299);i(i.S+i.F,"Object",{define:r})},function(e,t,n){var i=n(9),r=n(49),a=n(221),o=n(30);e.exports=function(e,t){for(var n,s=a(o(t)),l=s.length,u=0;l>u;)i.f(e,n=s[u++],r.f(t,n));return e}},function(e,t,n){var i=n(6),r=n(299),a=n(44);i(i.S+i.F,"Object",{make:function(e,t){return r(a(e),t)}})},function(e,t,i){i(134)(Number,"Number",function(e){this._l=+e,this._i=0},function(){var e=this._i++,t=!(e<this._l);return{done:t,value:t?n:e}})},function(e,t,n){var i=n(6),r=n(303)(/[\\^$*+?.()|[\]{}]/g,"\\$&");i(i.S,"RegExp",{escape:function(e){return r(e)}})},function(e,t){e.exports=function(e,t){var n=t===Object(t)?function(e){return t[e]}:t;return function(t){return String(t).replace(e,n)}}},function(e,t,n){var i=n(6),r=n(303)(/[&<>"']/g,{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"});i(i.P+i.F,"String",{escapeHTML:function(){return r(this)}})},function(e,t,n){var i=n(6),r=n(303)(/&(?:amp|lt|gt|quot|apos);/g,{"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"});i(i.P+i.F,"String",{unescapeHTML:function(){return r(this)}})}]),"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.core=e}(1,1);var NEWER=Symbol("newer"),OLDER=Symbol("older");LRUMap.prototype._markEntryAsUsed=function(e){e!==this.newest&&(e[NEWER]&&(e===this.oldest&&(this.oldest=e[NEWER]),e[NEWER][OLDER]=e[OLDER]),e[OLDER]&&(e[OLDER][NEWER]=e[NEWER]),e[NEWER]=void 0,e[OLDER]=this.newest,this.newest&&(this.newest[NEWER]=e),this.newest=e)},LRUMap.prototype.assign=function(e){var t=void 0,n=this.limit||Number.MAX_VALUE;this._keymap.clear();for(var i=e[Symbol.iterator](),r=i.next();!r.done;r=i.next()){var a=new Entry(r.value[0],r.value[1]);if(this._keymap.set(a.key,a),t?(t[NEWER]=a,a[OLDER]=t):this.oldest=a,t=a,0==n--)throw new Error("overflow")}this.newest=t,this.size=this._keymap.size},LRUMap.prototype.get=function(e){var t=this._keymap.get(e);if(t)return this._markEntryAsUsed(t),t.value},LRUMap.prototype.set=function(e,t){var n=this._keymap.get(e);return n?(n.value=t,this._markEntryAsUsed(n),this):(this._keymap.set(e,n=new Entry(e,t)),this.newest?(this.newest[NEWER]=n,n[OLDER]=this.newest):this.oldest=n,this.newest=n,++this.size,this.size>this.limit&&this.shift(),this)},LRUMap.prototype.shift=function(){var e=this.oldest;if(e)return this.oldest[NEWER]?(this.oldest=this.oldest[NEWER],this.oldest[OLDER]=void 0):(this.oldest=void 0,this.newest=void 0),e[NEWER]=e[OLDER]=void 0,this._keymap.delete(e.key),--this.size,[e.key,e.value]},LRUMap.prototype.find=function(e){var t=this._keymap.get(e);return t?t.value:void 0},LRUMap.prototype.has=function(e){return this._keymap.has(e)},LRUMap.prototype.delete=function(e){var t=this._keymap.get(e);if(t)return this._keymap.delete(t.key),t[NEWER]&&t[OLDER]?(t[OLDER][NEWER]=t[NEWER],t[NEWER][OLDER]=t[OLDER]):t[NEWER]?(t[NEWER][OLDER]=void 0,this.oldest=t[NEWER]):t[OLDER]?(t[OLDER][NEWER]=void 0,this.newest=t[OLDER]):this.oldest=this.newest=void 0,this.size--,t.value},LRUMap.prototype.clear=function(){this.oldest=this.newest=void 0,this.size=0,this._keymap.clear()},EntryIterator.prototype[Symbol.iterator]=function(){return this},EntryIterator.prototype.next=function(){var e=this.entry;return e?(this.entry=e[NEWER],{done:!1,value:[e.key,e.value]}):{done:!0,value:void 0}},KeyIterator.prototype[Symbol.iterator]=function(){return this},KeyIterator.prototype.next=function(){var e=this.entry;return e?(this.entry=e[NEWER],{done:!1,value:e.key}):{done:!0,value:void 0}},ValueIterator.prototype[Symbol.iterator]=function(){return this},ValueIterator.prototype.next=function(){var e=this.entry;return e?(this.entry=e[NEWER],{done:!1,value:e.value}):{done:!0,value:void 0}},LRUMap.prototype.keys=function(){return new KeyIterator(this.oldest)},LRUMap.prototype.values=function(){return new ValueIterator(this.oldest)},LRUMap.prototype.entries=function(){return this},LRUMap.prototype[Symbol.iterator]=function(){return new EntryIterator(this.oldest)},LRUMap.prototype.forEach=function(e,t){"object"!==(void 0===t?"undefined":_typeof(t))&&(t=this);for(var n=this.oldest;n;)e.call(t,n.value,n.key,this),n=n[NEWER]},LRUMap.prototype.toJSON=function(){for(var e=new Array(this.size),t=0,n=this.oldest;n;)e[t++]={key:n.key,value:n.value},n=n[NEWER];return e},LRUMap.prototype.toString=function(){for(var e="",t=this.oldest;t;)e+=String(t.key)+":"+t.value,(t=t[NEWER])&&(e+=" < ");return e},function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.THREE=e.THREE||{})}(window,function(e){function t(){}function n(e,t){this.x=e||0,this.y=t||0}function i(e,t,r,a,o,s,l,u,c,h){Object.defineProperty(this,"id",{value:ds++}),this.uuid=hs.generateUUID(),this.name="",this.image=void 0!==e?e:i.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:i.DEFAULT_MAPPING,this.wrapS=void 0!==r?r:po,this.wrapT=void 0!==a?a:po,this.magFilter=void 0!==o?o:Eo,this.minFilter=void 0!==s?s:xo,this.anisotropy=void 0!==c?c:1,this.format=void 0!==l?l:Po,this.type=void 0!==u?u:Mo,this.offset=new n(0,0),this.repeat=new n(1,1),this.rotateMatrix=new te,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==h?h:ns,this.version=0,this.onUpdate=null}function r(e,t,n,i){this.x=e||0,this.y=t||0,this.z=n||0,this.w=void 0!==i?i:1}function a(e,t,n){this.uuid=hs.generateUUID(),this.width=e,this.height=t,this.scissor=new r(0,0,e,t),this.scissorTest=!1,this.viewport=new r(0,0,e,t),n=n||{},void 0===n.minFilter&&(n.minFilter=Eo),this.texture=new i(void 0,void 0,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.encoding),this.depthBuffer=void 0===n.depthBuffer||n.depthBuffer,this.stencilBuffer=void 0===n.stencilBuffer||n.stencilBuffer,this.depthTexture=void 0!==n.depthTexture?n.depthTexture:null}function o(e,t,n){a.call(this,e,t,n),this.activeCubeFace=0,this.activeMipMapLevel=0}function s(e,t,n,i){this._x=e||0,this._y=t||0,this._z=n||0,this._w=void 0!==i?i:1}function l(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0}function u(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function c(e,t,n,r,a,o,s,l,u,c,h,d){i.call(this,null,o,s,l,u,c,r,a,h,d),this.image={data:e,width:t,height:n},this.magFilter=void 0!==u?u:go,this.minFilter=void 0!==c?c:go,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function h(e,t,n,r,a,o,s,l,u,c){e=void 0!==e?e:[],t=void 0!==t?t:ao,i.call(this,e,t,n,r,a,o,s,l,u,c),this.flipY=!1}function d(){this.seq=[],this.map={}}function f(e,t,n){var i=e[0];if(i<=0||i>0)return e;var r=t*n,a=ms[r];if(void 0===a&&(a=new Float32Array(r),ms[r]=a),0!==t){i.toArray(a,0);for(var o=1,s=0;o!==t;++o)s+=n,e[o].toArray(a,s)}return a}function p(e,t){var n=gs[t];void 0===n&&(n=new Int32Array(t),gs[t]=n);for(var i=0;i!==t;++i)n[i]=e.allocTextureUnit();return n}function m(e,t){e.uniform1f(this.addr,t)}function g(e,t){e.uniform1i(this.addr,t)}function v(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function y(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function E(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function b(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function x(e,t){void 0===t.elements?e.uniformMatrix3fv(this.addr,!1,t):(ys.set(t.elements),e.uniformMatrix3fv(this.addr,!1,ys))}function M(e,t){void 0===t.elements?e.uniformMatrix4fv(this.addr,!1,t):(vs.set(t.elements),e.uniformMatrix4fv(this.addr,!1,vs))}function _(e,t,n){var i=n.allocTextureUnit();e.uniform1i(this.addr,i),n.setTexture2D(t||fs,i)}function C(e,t,n){var i=n.allocTextureUnit();e.uniform1i(this.addr,i),n.setTextureCube(t||ps,i)}function I(e,t){e.uniform2iv(this.addr,t)}function O(e,t){e.uniform3iv(this.addr,t)}function T(e,t){e.uniform4iv(this.addr,t)}function L(e){switch(e){case 5126:return m;case 35664:return v;case 35665:return y;case 35666:return E;case 35674:return b;case 35675:return x;case 35676:return M;case 35678:return _;case 35680:return C;case 5124:case 35670:return g;case 35667:case 35671:return I;case 35668:case 35672:return O;case 35669:case 35673:return T}}function S(e,t){e.uniform1fv(this.addr,t)}function D(e,t){e.uniform1iv(this.addr,t)}function w(e,t){e.uniform2fv(this.addr,f(t,this.size,2))}function U(e,t){e.uniform3fv(this.addr,f(t,this.size,3))}function R(e,t){e.uniform4fv(this.addr,f(t,this.size,4))}function A(e,t){e.uniformMatrix2fv(this.addr,!1,f(t,this.size,4))}function N(e,t){e.uniformMatrix3fv(this.addr,!1,f(t,this.size,9))}function P(e,t){e.uniformMatrix4fv(this.addr,!1,f(t,this.size,16))}function k(e,t,n){var i=t.length,r=p(n,i);e.uniform1iv(this.addr,r);for(var a=0;a!==i;++a)n.setTexture2D(t[a]||fs,r[a])}function B(e,t,n){var i=t.length,r=p(n,i);e.uniform1iv(this.addr,r);for(var a=0;a!==i;++a)n.setTextureCube(t[a]||ps,r[a])}function F(e){switch(e){case 5126:return S;case 35664:return w;case 35665:return U;case 35666:return R;case 35674:return A;case 35675:return N;case 35676:return P;case 35678:return k;case 35680:return B;case 5124:case 35670:return D;case 35667:case 35671:return I;case 35668:case 35672:return O;case 35669:case 35673:return T}}function H(e,t,n){this.id=e,this.addr=n,this.setValue=L(t.type)}function G(e,t,n){this.id=e,this.addr=n,this.size=t.size,this.setValue=F(t.type)}function V(e){this.id=e,d.call(this)}function z(e,t){e.seq.push(t),e.map[t.id]=t}function j(e,t,n){var i=e.name,r=i.length;for(Es.lastIndex=0;;){var a=Es.exec(i),o=Es.lastIndex,s=a[1],l="]"===a[2],u=a[3];if(l&&(s|=0),void 0===u||"["===u&&o+2===r){z(n,void 0===u?new H(s,e,t):new G(s,e,t));break}var c=n.map,h=c[s];void 0===h&&(h=new V(s),z(n,h)),n=h}}function W(e,t,n){d.call(this),this.renderer=n;for(var i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),r=0;r<i;++r){var a=e.getActiveUniform(t,r),o=a.name;j(a,e.getUniformLocation(t,o),this)}}function X(e,t,n){return void 0===t&&void 0===n?this.set(e):this.setRGB(e,t,n)}function Y(e,t){this.min=void 0!==e?e:new n(1/0,1/0),this.max=void 0!==t?t:new n(-1/0,-1/0)}function q(e,t){function i(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),t=new Uint16Array([0,1,2,0,2,3]);a=p.createBuffer(),o=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,a),p.bufferData(p.ARRAY_BUFFER,e,p.STATIC_DRAW),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,o),p.bufferData(p.ELEMENT_ARRAY_BUFFER,t,p.STATIC_DRAW),d=p.createTexture(),f=p.createTexture(),m.bindTexture(p.TEXTURE_2D,d),p.texImage2D(p.TEXTURE_2D,0,p.RGB,16,16,0,p.RGB,p.UNSIGNED_BYTE,null),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),m.bindTexture(p.TEXTURE_2D,f),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,16,16,0,p.RGBA,p.UNSIGNED_BYTE,null),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),s={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},u=r(s),c={vertex:p.getAttribLocation(u,"position"),uv:p.getAttribLocation(u,"uv")},h={renderType:p.getUniformLocation(u,"renderType"),map:p.getUniformLocation(u,"map"),occlusionMap:p.getUniformLocation(u,"occlusionMap"),opacity:p.getUniformLocation(u,"opacity"),color:p.getUniformLocation(u,"color"),scale:p.getUniformLocation(u,"scale"),rotation:p.getUniformLocation(u,"rotation"),screenPosition:p.getUniformLocation(u,"screenPosition")}}function r(t){var n=p.createProgram(),i=p.createShader(p.FRAGMENT_SHADER),r=p.createShader(p.VERTEX_SHADER),a="precision "+e.getPrecision()+" float;\n";return p.shaderSource(i,a+t.fragmentShader),p.shaderSource(r,a+t.vertexShader),p.compileShader(i),p.compileShader(r),p.attachShader(n,i),p.attachShader(n,r),p.linkProgram(n),n}var a,o,s,u,c,h,d,f,p=e.context,m=e.state;this.render=function(r,s,g){if(0!==t.length){var v=new l,y=g.w/g.z,E=.5*g.z,b=.5*g.w,x=16/g.w,M=new n(x*y,x),_=new l(1,1,0),C=new n(1,1),I=new Y;I.min.set(g.x,g.y),I.max.set(g.x+(g.z-16),g.y+(g.w-16)),void 0===u&&i(),p.useProgram(u),m.initAttributes(),m.enableAttribute(c.vertex),m.enableAttribute(c.uv),m.disableUnusedAttributes(),p.uniform1i(h.occlusionMap,0),p.uniform1i(h.map,1),p.bindBuffer(p.ARRAY_BUFFER,a),p.vertexAttribPointer(c.vertex,2,p.FLOAT,!1,16,0),p.vertexAttribPointer(c.uv,2,p.FLOAT,!1,16,8),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,o),m.disable(p.CULL_FACE),m.buffers.depth.setMask(!1);for(var O=0,T=t.length;O<T;O++){x=16/g.w,M.set(x*y,x);var L=t[O];if(v.set(L.matrixWorld.elements[12],L.matrixWorld.elements[13],L.matrixWorld.elements[14]),v.applyMatrix4(s.matrixWorldInverse),v.applyMatrix4(s.projectionMatrix),_.copy(v),C.x=g.x+_.x*E+E-8,C.y=g.y+_.y*b+b-8,
!0===I.containsPoint(C)){m.activeTexture(p.TEXTURE0),m.bindTexture(p.TEXTURE_2D,null),m.activeTexture(p.TEXTURE1),m.bindTexture(p.TEXTURE_2D,d),p.copyTexImage2D(p.TEXTURE_2D,0,p.RGB,C.x,C.y,16,16,0),p.uniform1i(h.renderType,0),p.uniform2f(h.scale,M.x,M.y),p.uniform3f(h.screenPosition,_.x,_.y,_.z),m.disable(p.BLEND),m.enable(p.DEPTH_TEST),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0),m.activeTexture(p.TEXTURE0),m.bindTexture(p.TEXTURE_2D,f),p.copyTexImage2D(p.TEXTURE_2D,0,p.RGBA,C.x,C.y,16,16,0),p.uniform1i(h.renderType,1),m.disable(p.DEPTH_TEST),m.activeTexture(p.TEXTURE1),m.bindTexture(p.TEXTURE_2D,d),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0),L.positionScreen.copy(_),L.customUpdateCallback?L.customUpdateCallback(L):L.updateLensFlares(),p.uniform1i(h.renderType,2),m.enable(p.BLEND);for(var S=0,D=L.lensFlares.length;S<D;S++){var w=L.lensFlares[S];w.opacity>.001&&w.scale>.001&&(_.x=w.x,_.y=w.y,_.z=w.z,x=w.size*w.scale/g.w,M.x=x*y,M.y=x,p.uniform3f(h.screenPosition,_.x,_.y,_.z),p.uniform2f(h.scale,M.x,M.y),p.uniform1f(h.rotation,w.rotation),p.uniform1f(h.opacity,w.opacity),p.uniform3f(h.color,w.color.r,w.color.g,w.color.b),m.setBlending(w.blending,w.blendEquation,w.blendSrc,w.blendDst),e.setTexture2D(w.texture,1),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0))}}}m.enable(p.CULL_FACE),m.enable(p.DEPTH_TEST),m.buffers.depth.setMask(!0),e.resetGLState()}}}function Z(e,t){function n(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),t=new Uint16Array([0,1,2,0,2,3]);o=p.createBuffer(),u=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,o),p.bufferData(p.ARRAY_BUFFER,e,p.STATIC_DRAW),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,u),p.bufferData(p.ELEMENT_ARRAY_BUFFER,t,p.STATIC_DRAW),c=r(),h={position:p.getAttribLocation(c,"position"),uv:p.getAttribLocation(c,"uv")},d={uvOffset:p.getUniformLocation(c,"uvOffset"),uvScale:p.getUniformLocation(c,"uvScale"),rotation:p.getUniformLocation(c,"rotation"),scale:p.getUniformLocation(c,"scale"),color:p.getUniformLocation(c,"color"),map:p.getUniformLocation(c,"map"),opacity:p.getUniformLocation(c,"opacity"),modelViewMatrix:p.getUniformLocation(c,"modelViewMatrix"),projectionMatrix:p.getUniformLocation(c,"projectionMatrix"),fogType:p.getUniformLocation(c,"fogType"),fogDensity:p.getUniformLocation(c,"fogDensity"),fogNear:p.getUniformLocation(c,"fogNear"),fogFar:p.getUniformLocation(c,"fogFar"),fogColor:p.getUniformLocation(c,"fogColor"),alphaTest:p.getUniformLocation(c,"alphaTest")};var n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");n.width=8,n.height=8;var a=n.getContext("2d");a.fillStyle="white",a.fillRect(0,0,8,8),f=new i(n),f.needsUpdate=!0}function r(){var t=p.createProgram(),n=p.createShader(p.VERTEX_SHADER),i=p.createShader(p.FRAGMENT_SHADER);return p.shaderSource(n,["precision "+e.getPrecision()+" float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),p.shaderSource(i,["precision "+e.getPrecision()+" float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),p.compileShader(n),p.compileShader(i),p.attachShader(t,n),p.attachShader(t,i),p.linkProgram(t),t}function a(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}var o,u,c,h,d,f,p=e.context,m=e.state,g=new l,v=new s,y=new l;this.render=function(i,r){if(0!==t.length){void 0===c&&n(),p.useProgram(c),m.initAttributes(),m.enableAttribute(h.position),m.enableAttribute(h.uv),m.disableUnusedAttributes(),m.disable(p.CULL_FACE),m.enable(p.BLEND),p.bindBuffer(p.ARRAY_BUFFER,o),p.vertexAttribPointer(h.position,2,p.FLOAT,!1,16,0),p.vertexAttribPointer(h.uv,2,p.FLOAT,!1,16,8),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,u),p.uniformMatrix4fv(d.projectionMatrix,!1,r.projectionMatrix.elements),m.activeTexture(p.TEXTURE0),p.uniform1i(d.map,0);var s=0,l=0,E=i.fog;E?(p.uniform3f(d.fogColor,E.color.r,E.color.g,E.color.b),E.isFog?(p.uniform1f(d.fogNear,E.near),p.uniform1f(d.fogFar,E.far),p.uniform1i(d.fogType,1),s=1,l=1):E.isFogExp2&&(p.uniform1f(d.fogDensity,E.density),p.uniform1i(d.fogType,2),s=2,l=2)):(p.uniform1i(d.fogType,0),s=0,l=0);for(var b=0,x=t.length;b<x;b++){var M=t[b];M.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,M.matrixWorld),M.z=-M.modelViewMatrix.elements[14]}t.sort(a);for(var _=[],b=0,x=t.length;b<x;b++){var M=t[b],C=M.material;if(!1!==C.visible){p.uniform1f(d.alphaTest,C.alphaTest),p.uniformMatrix4fv(d.modelViewMatrix,!1,M.modelViewMatrix.elements),M.matrixWorld.decompose(g,v,y),_[0]=y.x,_[1]=y.y;var I=0;i.fog&&C.fog&&(I=l),s!==I&&(p.uniform1i(d.fogType,I),s=I),null!==C.map?(p.uniform2f(d.uvOffset,C.map.offset.x,C.map.offset.y),p.uniform2f(d.uvScale,C.map.repeat.x,C.map.repeat.y)):(p.uniform2f(d.uvOffset,0,0),p.uniform2f(d.uvScale,1,1)),p.uniform1f(d.opacity,C.opacity),p.uniform3f(d.color,C.color.r,C.color.g,C.color.b),p.uniform1f(d.rotation,C.rotation),p.uniform2fv(d.scale,_),m.setBlending(C.blending,C.blendEquation,C.blendSrc,C.blendDst),m.buffers.depth.setTest(C.depthTest),m.buffers.depth.setMask(C.depthWrite),C.map?e.setTexture2D(C.map,0):e.setTexture2D(f,0),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0)}}m.enable(p.CULL_FACE),e.resetGLState()}}}function K(){Object.defineProperty(this,"id",{value:Is++}),this.uuid=hs.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=Ma,this.side=fa,this.shading=va,this.vertexColors=ya,this.opacity=1,this.transparent=!1,this.blendSrc=Pa,this.blendDst=ka,this.blendEquation=Ta,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=Xa,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.needsUpdate=!0}function Q(e){K.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function J(e){K.call(this),this.type="MeshDepthMaterial",this.depthPacking=us,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function $(e,t){this.min=void 0!==e?e:new l(1/0,1/0,1/0),this.max=void 0!==t?t:new l(-1/0,-1/0,-1/0)}function ee(e,t){this.center=void 0!==e?e:new l,this.radius=void 0!==t?t:0}function te(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function ne(e,t){this.normal=void 0!==e?e:new l(1,0,0),this.constant=void 0!==t?t:0}function ie(e,t,n,i,r,a){this.planes=[void 0!==e?e:new ne,void 0!==t?t:new ne,void 0!==n?n:new ne,void 0!==i?i:new ne,void 0!==r?r:new ne,void 0!==a?a:new ne]}function re(e,t,i,o){function s(t,n,i,r){var a=t.geometry,o=null,s=_,l=t.customDepthMaterial;if(i&&(s=C,l=t.customDistanceMaterial),l)o=l;else{var u=!1;n.morphTargets&&(a&&a.isBufferGeometry?u=a.morphAttributes&&a.morphAttributes.position&&a.morphAttributes.position.length>0:a&&a.isGeometry&&(u=a.morphTargets&&a.morphTargets.length>0)),t.isSkinnedMesh&&!1===n.skinning&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t);var c=t.isSkinnedMesh&&n.skinning,h=0;u&&(h|=b),c&&(h|=x),o=s[h]}if(e.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){var d=o.uuid,f=n.uuid,p=I[d];void 0===p&&(p={},I[d]=p);var m=p[f];void 0===m&&(m=o.clone(),p[f]=m),o=m}o.visible=n.visible,o.wireframe=n.wireframe;var g=n.side;return k.renderSingleSided&&g==ma&&(g=fa),k.renderReverseSided&&(g===fa?g=pa:g===pa&&(g=fa)),o.side=g,o.clipShadows=n.clipShadows,o.clippingPlanes=e.clippingPlanes,o.wireframeLinewidth=n.wireframeLinewidth,o.linewidth=n.linewidth,i&&void 0!==o.uniforms.lightPos&&o.uniforms.lightPos.value.copy(r),o}function c(t,n,r,a){if(!1!==t.visible){if(t.layers.test(n.layers)&&(t.isMesh||t.isLine||t.isPoints)&&t.castShadow&&(!t.frustumCulled||f.intersectsObject(t))){t.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,t.matrixWorld);var o=i.update(t),l=t.material;if(Array.isArray(l))for(var u=o.groups,h=0,d=u.length;h<d;h++){var p=u[h],m=p.materialIndex;p&&m<0&&(m=Math.abs(2+p.materialIndex));var g=l[m];if(g&&g.visible&&g.opacity>.9){var v=s(t,g,a,E);e.renderBufferDirect(r,null,o,v,t,p)}}else if(l.visible&&l.opacity>.9){var v=s(t,l,a,E);e.renderBufferDirect(r,null,o,v,t,null)}}for(var y=t.children,b=0,x=y.length;b<x;b++)c(y[b],n,r,a)}}var h=e.context,d=e.state,f=new ie,p=new u,m=t.shadows,g=new n,v=new n(o.maxTextureSize,o.maxTextureSize),y=new l,E=new l,b=1,x=2,M=1+(b|x),_=new Array(M),C=new Array(M),I={},O=[new l(1,0,0),new l(-1,0,0),new l(0,0,1),new l(0,0,-1),new l(0,1,0),new l(0,-1,0)],T=[new l(0,1,0),new l(0,1,0),new l(0,1,0),new l(0,1,0),new l(0,0,1),new l(0,0,-1)],L=[new r,new r,new r,new r,new r,new r],S=new J;S.depthPacking=cs,S.clipping=!0;for(var D=Cs.distanceRGBA,w=Ms.clone(D.uniforms),U=0;U!==M;++U){var R=0!=(U&b),A=0!=(U&x),N=S.clone();N.morphTargets=R,N.skinning=A,_[U]=N;var P=new Q({defines:{USE_SHADOWMAP:""},uniforms:w,vertexShader:D.vertexShader,fragmentShader:D.fragmentShader,morphTargets:R,skinning:A,clipping:!0});C[U]=P}var k=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=ha,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(t,n){if(!1!==k.enabled&&(!1!==k.autoUpdate||!1!==k.needsUpdate)&&0!==m.length){d.disable(h.BLEND),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(var i,r,o=0,s=m.length;o<s;o++){var l=m[o],u=l.shadow;if(void 0!==u){var b=u.camera,x=u.matrix;if(E.setFromMatrixPosition(l.matrixWorld),b.position.copy(E),g.copy(u.mapSize),g.min(v),l&&l.isPointLight){i=6,r=!0;var M=g.x,_=g.y;L[0].set(2*M,_,M,_),L[1].set(0,_,M,_),L[2].set(3*M,_,M,_),L[3].set(M,_,M,_),L[4].set(3*M,0,M,_),L[5].set(M,0,M,_),g.x*=4,g.y*=2,x.makeTranslation(-E.x,-E.y,-E.z)}else i=1,r=!1,y.setFromMatrixPosition(l.target.matrixWorld),b.lookAt(y),b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld),x.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),x.multiply(b.projectionMatrix),x.multiply(b.matrixWorldInverse);if(null===u.map){var C={minFilter:go,magFilter:go,format:Po};u.map=new a(g.x,g.y,C),u.map.texture.name=l.name+".shadowMap",b.updateProjectionMatrix()}u.isSpotLightShadow&&u.update(l);var I=u.map;e.setRenderTarget(I),e.clear();for(var S=0;S<i;S++){if(r){y.copy(b.position),y.add(O[S]),b.up.copy(T[S]),b.lookAt(y),b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld);var D=L[S];d.viewport(D)}p.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse),f.setFromMatrix(p),c(t,n,b,r)}}else console.warn("THREE.WebGLShadowMap:",l,"has no shadow.")}var w=e.getClearColor(),U=e.getClearAlpha();e.setClearColor(w,U),k.needsUpdate=!1}}}function ae(e,t){this.origin=void 0!==e?e:new l,this.direction=void 0!==t?t:new l}function oe(e,t,n,i){this._x=e||0,this._y=t||0,this._z=n||0,this._order=i||oe.DefaultOrder}function se(){this.mask=1}function le(){function e(){r.setFromEuler(i,!1)}function t(){i.setFromQuaternion(r,void 0,!1)}Object.defineProperty(this,"id",{value:Os++}),this.uuid=hs.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=le.DefaultUp.clone();var n=new l,i=new oe,r=new s,a=new l(1,1,1);i.onChange(e),r.onChange(t),Object.defineProperties(this,{position:{enumerable:!0,value:n},rotation:{enumerable:!0,value:i},quaternion:{enumerable:!0,value:r},scale:{enumerable:!0,value:a},modelViewMatrix:{value:new u},normalMatrix:{value:new te}}),this.matrix=new u,this.matrixWorld=new u,this.matrixAutoUpdate=le.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new se,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.onBeforeRender=function(){},this.onAfterRender=function(){}}function ue(e,t){this.start=void 0!==e?e:new l,this.end=void 0!==t?t:new l}function ce(e,t,n){this.a=void 0!==e?e:new l,this.b=void 0!==t?t:new l,this.c=void 0!==n?n:new l}function he(e,t,n,i,r,a){this.a=e,this.b=t,this.c=n,this.normal=i&&i.isVector3?i:new l,this.vertexNormals=Array.isArray(i)?i:[],this.color=r&&r.isColor?r:new X,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=void 0!==a?a:0}function de(e){K.call(this),this.type="MeshBasicMaterial",this.color=new X(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Qa,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function fe(e,t,n){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=hs.generateUUID(),this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===n,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function pe(e,t){fe.call(this,new Int8Array(e),t)}function me(e,t){fe.call(this,new Uint8Array(e),t)}function ge(e,t){fe.call(this,new Uint8ClampedArray(e),t)}function ve(e,t){fe.call(this,new Int16Array(e),t)}function ye(e,t){fe.call(this,new Uint16Array(e),t)}function Ee(e,t){fe.call(this,new Int32Array(e),t)}function be(e,t){fe.call(this,new Uint32Array(e),t)}function xe(e,t){fe.call(this,new Float32Array(e),t)}function Me(e,t){fe.call(this,new Float64Array(e),t)}function _e(){this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function Ce(e){if(0===e.length)return-1/0;for(var t=e[0],n=1,i=e.length;n<i;++n)e[n]>t&&(t=e[n]);return t}function Ie(){return Ts++}function Oe(){Object.defineProperty(this,"id",{value:Ie()}),this.uuid=hs.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function Te(){Object.defineProperty(this,"id",{value:Ie()}),this.uuid=hs.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function Le(e,t){le.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new Te,this.material=void 0!==t?t:new de({color:16777215*Math.random()}),this.drawMode=$o,this.updateMorphTargets()}function Se(e,t,n,i,r,a){Oe.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:i,heightSegments:r,depthSegments:a},this.fromBufferGeometry(new De(e,t,n,i,r,a)),this.mergeVertices()}function De(e,t,n,i,r,a){function o(e,t,n,i,r,a,o,m,g,v,y){var E,b,x=a/g,M=o/v,_=a/2,C=o/2,I=m/2,O=g+1,T=v+1,L=0,S=0,D=new l;for(b=0;b<T;b++){var w=b*M-C;for(E=0;E<O;E++){var U=E*x-_;D[e]=U*i,D[t]=w*r,D[n]=I,c.push(D.x,D.y,D.z),D[e]=0,D[t]=0,D[n]=m>0?1:-1,h.push(D.x,D.y,D.z),d.push(E/g),d.push(1-b/v),L+=1}}for(b=0;b<v;b++)for(E=0;E<g;E++){var R=f+E+O*b,A=f+E+O*(b+1),N=f+(E+1)+O*(b+1),P=f+(E+1)+O*b;u.push(R,A,P),u.push(A,N,P),S+=6}s.addGroup(p,S,y),p+=S,f+=L}Te.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:i,heightSegments:r,depthSegments:a};var s=this;i=Math.floor(i)||1,r=Math.floor(r)||1,a=Math.floor(a)||1;var u=[],c=[],h=[],d=[],f=0,p=0;o("z","y","x",-1,-1,n,t,e,a,r,0),o("z","y","x",1,-1,n,t,-e,a,r,1),o("x","z","y",1,1,e,n,t,i,a,2),o("x","z","y",1,-1,e,n,-t,i,a,3),o("x","y","z",1,-1,e,t,n,i,r,4),o("x","y","z",-1,-1,e,t,-n,i,r,5),this.setIndex(u),this.addAttribute("position",new xe(c,3)),this.addAttribute("normal",new xe(h,3)),this.addAttribute("uv",new xe(d,2))}function we(e,t,n,i){Oe.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:i},this.fromBufferGeometry(new Ue(e,t,n,i)),this.mergeVertices()}function Ue(e,t,n,i){Te.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:i};var r,a,o=e/2,s=t/2,l=Math.floor(n)||1,u=Math.floor(i)||1,c=l+1,h=u+1,d=e/l,f=t/u,p=[],m=[],g=[],v=[];for(a=0;a<h;a++){var y=a*f-s;for(r=0;r<c;r++){var E=r*d-o;m.push(E,-y,0),g.push(0,0,1),v.push(r/l),v.push(1-a/u)}}for(a=0;a<u;a++)for(r=0;r<l;r++){var b=r+c*a,x=r+c*(a+1),M=r+1+c*(a+1),_=r+1+c*a;p.push(b,x,_),p.push(x,M,_)}this.setIndex(p),this.addAttribute("position",new xe(m,3)),this.addAttribute("normal",new xe(g,3)),this.addAttribute("uv",new xe(v,2))}function Re(){le.call(this),this.type="Camera",this.matrixWorldInverse=new u,this.projectionMatrix=new u}function Ae(e,t,n,i){Re.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==n?n:.1,this.far=void 0!==i?i:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function Ne(e,t,n,i,r,a){Re.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=i,this.near=void 0!==r?r:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()}function Pe(e){function t(t,n){var i=t.array,r=t.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,a=e.createBuffer();e.bindBuffer(n,a),e.bufferData(n,i,r),t.onUploadCallback();var o=e.FLOAT;return i instanceof Float32Array?o=e.FLOAT:i instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array"):i instanceof Uint16Array?o=e.UNSIGNED_SHORT:i instanceof Int16Array?o=e.SHORT:i instanceof Uint32Array?o=e.UNSIGNED_INT:i instanceof Int32Array?o=e.INT:i instanceof Int8Array?o=e.BYTE:i instanceof Uint8Array&&(o=e.UNSIGNED_BYTE),{buffer:a,type:o,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version}}function n(t,n,i){var r=n.array,a=n.updateRange;e.bindBuffer(i,t),!1===n.dynamic?e.bufferData(i,r,e.STATIC_DRAW):-1===a.count?e.bufferSubData(i,0,r):0===a.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(i,a.offset*r.BYTES_PER_ELEMENT,r.subarray(a.offset,a.offset+a.count)),a.count=0)}function i(e){return e.isInterleavedBufferAttribute&&(e=e.data),o[e.uuid]}function r(t){var n=o[t.uuid];n&&(e.deleteBuffer(n.buffer),delete o[t.uuid])}function a(e,i){e.isInterleavedBufferAttribute&&(e=e.data);var r=o[e.uuid];void 0===r?o[e.uuid]=t(e,i):r.version<e.version&&(n(r.buffer,e,i),r.version=e.version)}var o={};return{get:i,remove:r,update:a}}function ke(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program&&t.program&&e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Be(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Fe(){function e(){a=-1,s=-1}function t(e,t,n,i,l){var u,c;n.transparent?(u=o,c=++s):(u=r,c=++a);var h=u[c];h?(h.id=e.id,h.object=e,h.geometry=t,h.material=n,h.program=n.program,h.renderOrder=e.renderOrder,h.z=i,h.group=l):(h={id:e.id,object:e,geometry:t,material:n,program:n.program,renderOrder:e.renderOrder,z:i,group:l},u.push(h))}function n(){r.length=a+1,o.length=s+1}function i(){r.sort(ke),o.sort(Be)}var r=[],a=-1,o=[],s=-1;return{opaque:r,transparent:o,init:e,push:t,finish:n,sort:i}}function He(){function e(e,t){var i=e.id+","+t.id,r=n[i];return void 0===r&&(r=new Fe,n[i]=r),r}function t(){n={}}var n={};return{get:e,dispose:t}}function Ge(e,t,n){function i(e){s=e}function r(n){n.array instanceof Uint32Array&&t.get("OES_element_index_uint")?(l=e.UNSIGNED_INT,u=4):n.array instanceof Uint16Array?(l=e.UNSIGNED_SHORT,u=2):(l=e.UNSIGNED_BYTE,u=1)}function a(t,i){e.drawElements(s,i,l,t*u),n.calls++,n.vertices+=i,s===e.TRIANGLES&&(n.faces+=i/3)}function o(i,r,a){var o=t.get("ANGLE_instanced_arrays");if(null===o)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");o.drawElementsInstancedANGLE(s,a,l,r*u,i.maxInstancedCount),n.calls++,n.vertices+=a*i.maxInstancedCount,s===e.TRIANGLES&&(n.faces+=i.maxInstancedCount*a/3)}var s,l,u;this.setMode=i,this.setIndex=r,this.render=a,this.renderInstances=o}function Ve(e,t,n){function i(e){o=e}function r(t,i){e.drawArrays(o,t,i),n.calls++,n.vertices+=i,o===e.TRIANGLES&&(n.faces+=i/3)}function a(i,r,a){var s=t.get("ANGLE_instanced_arrays");if(null===s)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");var l=i.attributes.position;l.isInterleavedBufferAttribute?(a=l.data.count,s.drawArraysInstancedANGLE(o,0,a,i.maxInstancedCount)):s.drawArraysInstancedANGLE(o,r,a,i.maxInstancedCount),n.calls++,n.vertices+=a*i.maxInstancedCount,o===e.TRIANGLES&&(n.faces+=i.maxInstancedCount*a/3)}var o;this.setMode=i,this.render=r,this.renderInstances=a}function ze(e,t,n){function i(e){var r=e.target,a=s[r.id];null!==a.index&&t.remove(a.index);for(var o in a.attributes)t.remove(a.attributes[o]);r.removeEventListener("dispose",i),delete s[r.id];var u=l[r.id];u&&(t.remove(u),delete l[r.id]),u=l[a.id],u&&(t.remove(u),delete l[a.id]),n.geometries--}function r(e,t){var r=s[t.id];return r||(t.addEventListener("dispose",i),t.isBufferGeometry?r=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Te).setFromObject(e)),r=t._bufferGeometry),s[t.id]=r,n.geometries++,r)}function a(n){var i=n.index,r=n.attributes;null!==i&&t.update(i,e.ELEMENT_ARRAY_BUFFER);for(var a in r)t.update(r[a],e.ARRAY_BUFFER);var o=n.morphAttributes;for(var a in o)for(var s=o[a],l=0,u=s.length;l<u;l++)t.update(s[l],e.ARRAY_BUFFER)}function o(n){var i=l[n.id];if(i)return i;var r=[],a=n.index,o=n.attributes;if(null!==a)for(var s=a.array,u=0,c=s.length;u<c;u+=3){var h=s[u+0],d=s[u+1],f=s[u+2];r.push(h,d,d,f,f,h)}else for(var s=o.position.array,u=0,c=s.length/3-1;u<c;u+=3){var h=u+0,d=u+1,f=u+2;r.push(h,d,d,f,f,h)}return i=new(Ce(r)>65535?be:ye)(r,1),t.update(i,e.ELEMENT_ARRAY_BUFFER),l[n.id]=i,i}var s={},l={};return{get:r,update:a,getWireframeAttribute:o}}function je(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var i;switch(t.type){case"DirectionalLight":i={direction:new l,color:new X,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new n};break;case"SpotLight":i={position:new l,direction:new l,color:new X,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new n};break;case"PointLight":i={position:new l,color:new X,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new n};break;case"HemisphereLight":i={direction:new l,skyColor:new X,groundColor:new X};break;case"RectAreaLight":i={color:new X,position:new l,halfWidth:new l,halfHeight:new l}}return e[t.id]=i,i}}}function We(e,t,n){function i(e){var i=n.frame,r=e.geometry,o=t.get(e,r);return a[o.id]!==i&&(r.isGeometry&&o.updateFromObject(e),t.update(o),a[o.id]=i),o}function r(){a={}}var a={};return{update:i,clear:r}}function Xe(e){for(var t=e.split("\n"),n=0;n<t.length;n++)t[n]=n+1+": "+t[n];return t.join("\n")}function Ye(e,t,n){var i=e.createShader(t);return e.shaderSource(i,n),e.compileShader(i),!1===e.getShaderParameter(i,e.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(i)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(i),Xe(n)),i}function qe(e){switch(e){case ns:return["Linear","( value )"];case is:return["sRGB","( value )"];case as:return["RGBE","( value )"];case os:return["RGBM","( value, 7.0 )"];case ss:return["RGBM","( value, 16.0 )"];case ls:return["RGBD","( value, 256.0 )"];case rs:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function Ze(e,t){var n=qe(t);return"vec4 "+e+"( vec4 value ) { return "+n[0]+"ToLinear"+n[1]+"; }"}function Ke(e,t){var n=qe(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+n[0]+n[1]+"; }"}function Qe(e,t){var n;switch(t){case to:n="Linear";break;case no:n="Reinhard";break;case io:n="Uncharted2";break;case ro:n="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}function Je(e,t,n){return e=e||{},[e.derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&n.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&n.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&n.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(tt).join("\n")}function $e(e){var t=[];for(var n in e){var i=e[n];!1!==i&&t.push("#define "+n+" "+i)}return t.join("\n")}function et(e,t,n){for(var i={},r=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),a=0;a<r;a++){var o=e.getActiveAttrib(t,a),s=o.name;i[s]=e.getAttribLocation(t,s)}return i}function tt(e){return""!==e}function nt(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function it(e){function t(e,t){var n=_s[t];if(void 0===n)throw new Error("Can not resolve #include <"+t+">");return it(n)}var n=/^[ \t]*#include +<([\w\d.]+)>/gm;return e.replace(n,t)}function rt(e){function t(e,t,n,i){for(var r="",a=parseInt(t);a<parseInt(n);a++)r+=i.replace(/\[ i \]/g,"[ "+a+" ]");return r}var n=/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g;return e.replace(n,t)}function at(e,t,n,i){var r=e.context,a=n.extensions,o=n.defines,s=n.__webglShader.vertexShader,l=n.__webglShader.fragmentShader,u="SHADOWMAP_TYPE_BASIC";i.shadowMapType===ha?u="SHADOWMAP_TYPE_PCF":i.shadowMapType===da&&(u="SHADOWMAP_TYPE_PCF_SOFT");var c="ENVMAP_TYPE_CUBE",h="ENVMAP_MODE_REFLECTION",d="ENVMAP_BLENDING_MULTIPLY";if(i.envMap){switch(n.envMap.mapping){case ao:case oo:c="ENVMAP_TYPE_CUBE";break;case co:case ho:c="ENVMAP_TYPE_CUBE_UV";break;case so:case lo:c="ENVMAP_TYPE_EQUIREC";break;case uo:c="ENVMAP_TYPE_SPHERE"}switch(n.envMap.mapping){case oo:case lo:h="ENVMAP_MODE_REFRACTION"}switch(n.combine){case Qa:d="ENVMAP_BLENDING_MULTIPLY";break;case Ja:d="ENVMAP_BLENDING_MIX";break;case $a:d="ENVMAP_BLENDING_ADD"}}var f,p,m=e.gammaFactor>0?e.gammaFactor:1,g=Je(a,i,e.extensions),v=$e(o),y=r.createProgram();n.isRawShaderMaterial?(f=[v,"\n"].filter(tt).join("\n"),
p=[g,v,"\n"].filter(tt).join("\n")):(f=["precision "+i.precision+" float;","precision "+i.precision+" int;","#define SHADER_NAME "+n.__webglShader.name,v,i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+m,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+h:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.vertexColors?"#define USE_COLOR":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+i.numClippingPlanes,i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+u:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.positionOffset?"#define USE_POSITION_OFFSET":"",i.sizeAttribute?"#define USE_ATTRIBUTE_SIZE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif",i.idBuffer?"#define ENABLE_VERTEX_ID":"","\n"].filter(tt).join("\n"),p=[g,i.idBuffer?"#extension GL_EXT_draw_buffers : enable":"",i.idBuffer?"#define ID_BUFFER_MRT":"","precision "+i.precision+" float;","precision "+i.precision+" int;","#define SHADER_NAME "+n.__webglShader.name,v,i.alphaTest?"#define ALPHATEST "+i.alphaTest:"","#define GAMMA_FACTOR "+m,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.envMap?"#define "+h:"",i.envMap?"#define "+d:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.vertexColors?"#define USE_COLOR":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+i.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(i.numClippingPlanes-i.numClipIntersection),i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+u:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",i.envMap&&e.extensions.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",i.toneMapping!==eo?"#define TONE_MAPPING":"",i.toneMapping!==eo?_s.tonemapping_pars_fragment:"",i.toneMapping!==eo?Qe("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.outputEncoding||i.mapEncoding||i.envMapEncoding||i.emissiveMapEncoding?_s.encodings_pars_fragment:"",i.mapEncoding?Ze("mapTexelToLinear",i.mapEncoding):"",i.envMapEncoding?Ze("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMapEncoding?Ze("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.outputEncoding?Ke("linearToOutputTexel",i.outputEncoding):"",i.depthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(tt).join("\n")),s=it(s,i),s=nt(s,i),l=it(l,i),l=nt(l,i),n.isShaderMaterial||(s=rt(s),l=rt(l));var E=f+s,b=p+l,x=Ye(r,r.VERTEX_SHADER,E),M=Ye(r,r.FRAGMENT_SHADER,b);r.attachShader(y,x),r.attachShader(y,M),void 0!==n.index0AttributeName?r.bindAttribLocation(y,0,n.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(y,0,"position"),r.linkProgram(y);var _=r.getProgramInfoLog(y),C=r.getShaderInfoLog(x),I=r.getShaderInfoLog(M),O=!0,T=!0;!1===r.getProgramParameter(y,r.LINK_STATUS)?(O=!1,console.error("THREE.WebGLProgram: shader error: ",r.getError(),"gl.VALIDATE_STATUS",r.getProgramParameter(y,r.VALIDATE_STATUS),"gl.getProgramInfoLog",_,C,I)):""!==_?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",_):""!==C&&""!==I||(T=!1),T&&(this.diagnostics={runnable:O,material:n,programLog:_,vertexShader:{log:C,prefix:f},fragmentShader:{log:I,prefix:p}}),r.deleteShader(x),r.deleteShader(M);var L;this.getUniforms=function(){return void 0===L&&(L=new W(r,y,e)),L};var S;return this.getAttributes=function(){return void 0===S&&(S=et(r,y)),S},this.destroy=function(){r.deleteProgram(y),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=Ls++,this.code=t,this.usedTimes=1,this.program=y,this.vertexShader=x,this.fragmentShader=M,this}function ot(e,t){function n(e){var n=e.skeleton,i=n.bones;if(t.floatVertexTextures)return 1024;var r=t.maxVertexUniforms,a=Math.floor((r-20)/4),o=Math.min(a,i.length);return o<i.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+i.length+" bones. This GPU supports "+o+"."),0):o}function i(e,t){var n;return e?e.isTexture?n=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),n=e.texture.encoding):n=ns,n===ns&&t&&(n=rs),n}var r=[],a={MeshDepthMaterial:"depth",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points"},o=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","positionOffset","sizeAttribute","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];this.getParameters=function(r,o,s,l,u,c){var h=a[r.type],d=c.isSkinnedMesh?n(c):0,f=e.getPrecision();null!==r.precision&&(f=t.getMaxPrecision(r.precision))!==r.precision&&console.warn("THREE.WebGLProgram.getParameters:",r.precision,"not supported, using",f,"instead.");var p=e.getRenderTarget();return{shaderID:h,precision:f,supportsVertexTextures:t.vertexTextures,outputEncoding:i(p?p.texture:null,e.gammaOutput),map:!!r.map,mapEncoding:i(r.map,e.gammaInput),envMap:!!r.envMap,envMapMode:r.envMap&&r.envMap.mapping,envMapEncoding:i(r.envMap,e.gammaInput),envMapCubeUV:!!r.envMap&&(r.envMap.mapping===co||r.envMap.mapping===ho),lightMap:!!r.lightMap,aoMap:!!r.aoMap,emissiveMap:!!r.emissiveMap,emissiveMapEncoding:i(r.emissiveMap,e.gammaInput),bumpMap:!!r.bumpMap,normalMap:!!r.normalMap,displacementMap:!!r.displacementMap,roughnessMap:!!r.roughnessMap,metalnessMap:!!r.metalnessMap,specularMap:!!r.specularMap,alphaMap:!!r.alphaMap,gradientMap:!!r.gradientMap,combine:r.combine,vertexColors:r.vertexColors,fog:!!s,useFog:r.fog,fogExp:s&&s.isFogExp2,flatShading:r.shading===ga,sizeAttenuation:r.sizeAttenuation,positionOffset:r.positionOffset,sizeAttribute:r.sizeAttribute,logarithmicDepthBuffer:t.logarithmicDepthBuffer,skinning:r.skinning&&d>0,maxBones:d,useVertexTexture:t.floatVertexTextures,morphTargets:r.morphTargets,morphNormals:r.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numClippingPlanes:l,numClipIntersection:u,dithering:r.dithering,shadowMapEnabled:e.shadowMap.enabled&&c.receiveShadow&&o.shadows.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:r.premultipliedAlpha,alphaTest:r.alphaTest,doubleSided:r.side===ma,flipSided:r.side===pa,depthPacking:void 0!==r.depthPacking&&r.depthPacking,idBuffer:r.idBuffer}},this.getProgramCode=function(e,t){var n=[];if(t.shaderID?n.push(t.shaderID):(n.push(e.fragmentShader),n.push(e.vertexShader)),void 0!==e.defines)for(var i in e.defines)n.push(i),n.push(e.defines[i]);for(var r=0;r<o.length;r++)n.push(t[o[r]]);return n.join()},this.acquireProgram=function(t,n,i){for(var a,o=0,s=r.length;o<s;o++){var l=r[o];if(l.code===i){a=l,++a.usedTimes;break}}return void 0===a&&(a=new at(e,i,t,n),r.push(a)),a},this.releaseProgram=function(e){if(0==--e.usedTimes){var t=r.indexOf(e);r[t]=r[r.length-1],r.pop(),e.destroy()}},this.programs=r}function st(e,t,n,i,r,a,o){function s(e,t){if(e.width>t||e.height>t){var n=t/Math.max(e.width,e.height),i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");i.width=Math.floor(e.width*n),i.height=Math.floor(e.height*n);return i.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+i.width+"x"+i.height,e),i}return e}function l(e){return hs.isPowerOfTwo(e.width)&&hs.isPowerOfTwo(e.height)}function u(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");t.width=hs.nearestPowerOfTwo(e.width),t.height=hs.nearestPowerOfTwo(e.height);return t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}function c(e){return e.wrapS!==po||e.wrapT!==po||e.minFilter!==go&&e.minFilter!==Eo}function h(t){return t===go||t===vo||t===yo?e.NEAREST:e.LINEAR}function d(e){var t=e.target;t.removeEventListener("dispose",d),p(t),o.textures--}function f(e){var t=e.target;t.removeEventListener("dispose",f),m(t),o.textures--}function p(t){var n=i.get(t);if(t.image&&n.__image__webglTextureCube)e.deleteTexture(n.__image__webglTextureCube);else{if(void 0===n.__webglInit)return;e.deleteTexture(n.__webglTexture)}i.remove(t)}function m(t){var n=i.get(t),r=i.get(t.texture);if(t){if(void 0!==r.__webglTexture&&e.deleteTexture(r.__webglTexture),t.depthTexture&&t.depthTexture.dispose(),t.isWebGLRenderTargetCube)for(var a=0;a<6;a++)e.deleteFramebuffer(n.__webglFramebuffer[a]),n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[a]);else e.deleteFramebuffer(n.__webglFramebuffer),n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer);i.remove(t.texture),i.remove(t)}}function g(t,r){var a=i.get(t);if(t.version>0&&a.__version!==t.version){var o=t.image;if(void 0===o)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(!1!==o.complete)return void b(a,t,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}n.activeTexture(e.TEXTURE0+r),n.bindTexture(e.TEXTURE_2D,a.__webglTexture)}function v(t,u){var c=i.get(t);if(6===t.image.length)if(t.version>0&&c.__version!==t.version){c.__image__webglTextureCube||(t.addEventListener("dispose",d),c.__image__webglTextureCube=e.createTexture(),o.textures++),n.activeTexture(e.TEXTURE0+u),n.bindTexture(e.TEXTURE_CUBE_MAP,c.__image__webglTextureCube),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var h=t&&t.isCompressedTexture,f=t.image[0]&&t.image[0].isDataTexture,p=[],m=0;m<6;m++)p[m]=h||f?f?t.image[m].image:t.image[m]:s(t.image[m],r.maxCubemapSize);var g=p[0],v=l(g),y=a(t.format),b=a(t.type);E(e.TEXTURE_CUBE_MAP,t,v);for(var m=0;m<6;m++)if(h)for(var x,M=p[m].mipmaps,_=0,C=M.length;_<C;_++)x=M[_],t.format!==Po&&t.format!==No?n.getCompressedTextureFormats().indexOf(y)>-1?n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,_,y,x.width,x.height,0,x.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,_,y,x.width,x.height,0,y,b,x.data);else f?n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,y,p[m].width,p[m].height,0,y,b,p[m].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,y,y,b,p[m]);t.generateMipmaps&&v&&e.generateMipmap(e.TEXTURE_CUBE_MAP),c.__version=t.version,t.onUpdate&&t.onUpdate(t)}else n.activeTexture(e.TEXTURE0+u),n.bindTexture(e.TEXTURE_CUBE_MAP,c.__image__webglTextureCube)}function y(t,r){n.activeTexture(e.TEXTURE0+r),n.bindTexture(e.TEXTURE_CUBE_MAP,i.get(t).__webglTexture)}function E(n,o,s){var l;if(s?(e.texParameteri(n,e.TEXTURE_WRAP_S,a(o.wrapS)),e.texParameteri(n,e.TEXTURE_WRAP_T,a(o.wrapT)),e.texParameteri(n,e.TEXTURE_MAG_FILTER,a(o.magFilter)),e.texParameteri(n,e.TEXTURE_MIN_FILTER,a(o.minFilter))):(e.texParameteri(n,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(n,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),o.wrapS===po&&o.wrapT===po||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",o),e.texParameteri(n,e.TEXTURE_MAG_FILTER,h(o.magFilter)),e.texParameteri(n,e.TEXTURE_MIN_FILTER,h(o.minFilter)),o.minFilter!==go&&o.minFilter!==Eo&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",o)),l=t.get("EXT_texture_filter_anisotropic")){if(o.type===Lo&&null===t.get("OES_texture_float_linear"))return;if(o.type===So&&null===t.get("OES_texture_half_float_linear"))return;(o.anisotropy>1||i.get(o).__currentAnisotropy)&&(e.texParameterf(n,l.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,r.getMaxAnisotropy())),i.get(o).__currentAnisotropy=o.anisotropy)}}function b(t,i,h){void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",d),t.__webglTexture=e.createTexture(),o.textures++),n.activeTexture(e.TEXTURE0+h),n.bindTexture(e.TEXTURE_2D,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,i.unpackAlignment);var f=s(i.image,r.maxTextureSize);c(i)&&!1===l(f)&&(f=u(f));var p=l(f),m=a(i.format),g=a(i.type);E(e.TEXTURE_2D,i,p);var v,y=i.mipmaps;if(i.isDepthTexture){var b=e.DEPTH_COMPONENT;if(i.type===Lo){if(!L)throw new Error("Float Depth Texture only supported in WebGL2.0");b=e.DEPTH_COMPONENT32F}else L&&(b=e.DEPTH_COMPONENT16);i.format===Ho&&b===e.DEPTH_COMPONENT&&i.type!==Io&&i.type!==To&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),i.type=Io,g=a(i.type)),i.format===Go&&(b=e.DEPTH_STENCIL,i.type!==Ro&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),i.type=Ro,g=a(i.type))),n.texImage2D(e.TEXTURE_2D,0,b,f.width,f.height,0,m,g,null)}else if(i.isDataTexture)if(y.length>0&&p){for(var x=0,M=y.length;x<M;x++)v=y[x],n.texImage2D(e.TEXTURE_2D,x,m,v.width,v.height,0,m,g,v.data);i.generateMipmaps=!1}else n.texImage2D(e.TEXTURE_2D,0,m,f.width,f.height,0,m,g,f.data);else if(i.isCompressedTexture)for(var x=0,M=y.length;x<M;x++)v=y[x],i.format!==Po&&i.format!==No?n.getCompressedTextureFormats().indexOf(m)>-1?n.compressedTexImage2D(e.TEXTURE_2D,x,m,v.width,v.height,0,v.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):n.texImage2D(e.TEXTURE_2D,x,m,v.width,v.height,0,m,g,v.data);else if(y.length>0&&p){for(var x=0,M=y.length;x<M;x++)v=y[x],n.texImage2D(e.TEXTURE_2D,x,m,m,g,v);i.generateMipmaps=!1}else n.texImage2D(e.TEXTURE_2D,0,m,m,g,f);i.generateMipmaps&&p&&e.generateMipmap(e.TEXTURE_2D),t.__version=i.version,i.onUpdate&&i.onUpdate(i)}function x(t,r,o,s){var l=a(r.texture.format),u=a(r.texture.type);n.texImage2D(s,0,l,r.width,r.height,0,l,u,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,o,s,i.get(r.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function M(t,n){e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer&&!n.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)):n.depthBuffer&&n.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,n.width,n.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}function _(t,n){if(n&&n.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported!");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!n.depthTexture||!n.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");i.get(n.depthTexture).__webglTexture&&n.depthTexture.image.width===n.width&&n.depthTexture.image.height===n.height||(n.depthTexture.image.width=n.width,n.depthTexture.image.height=n.height,n.depthTexture.needsUpdate=!0),g(n.depthTexture,0);var r=i.get(n.depthTexture).__webglTexture;if(n.depthTexture.format===Ho)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0);else{if(n.depthTexture.format!==Go)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,r,0)}}function C(t){var n=i.get(t),r=!0===t.isWebGLRenderTargetCube;if(t.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");_(n.__webglFramebuffer,t)}else if(r){n.__webglDepthbuffer=[];for(var a=0;a<6;a++)e.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[a]),n.__webglDepthbuffer[a]=e.createRenderbuffer(),M(n.__webglDepthbuffer[a],t)}else e.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer),n.__webglDepthbuffer=e.createRenderbuffer(),M(n.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}function I(t){var r=i.get(t),a=i.get(t.texture);t.addEventListener("dispose",f),a.__webglTexture=e.createTexture(),o.textures++;var s=!0===t.isWebGLRenderTargetCube,u=l(t);if(s){r.__webglFramebuffer=[];for(var c=0;c<6;c++)r.__webglFramebuffer[c]=e.createFramebuffer()}else r.__webglFramebuffer=e.createFramebuffer();if(s){n.bindTexture(e.TEXTURE_CUBE_MAP,a.__webglTexture),E(e.TEXTURE_CUBE_MAP,t.texture,u);for(var c=0;c<6;c++)x(r.__webglFramebuffer[c],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+c);t.texture.generateMipmaps&&u&&e.generateMipmap(e.TEXTURE_CUBE_MAP),n.bindTexture(e.TEXTURE_CUBE_MAP,null)}else n.bindTexture(e.TEXTURE_2D,a.__webglTexture),E(e.TEXTURE_2D,t.texture,u),x(r.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),t.texture.generateMipmaps&&u&&e.generateMipmap(e.TEXTURE_2D),n.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&C(t)}function O(n){var r=t.get("WEBGL_draw_buffers"),s=n[0],l=!1;if(s&&!s.__webglFramebuffer){var u=i.get(s);i.get(s.texture);s.__webglFramebuffer=u.__webglFramebuffer=e.createFramebuffer(),void 0===s.depthBuffer&&(s.depthBuffer=!0),void 0===s.stencilBuffer&&(s.stencilBuffer=!0),C(s),l=!0}e.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer);var c;for(c=0;c<n.length;c++){var h=n[c];if(!h.__webglTexture){var d=THREE.Math.isPowerOfTwo(h.width)&&THREE.Math.isPowerOfTwo(h.height),p=a(h.texture.format),m=a(h.texture.type);h.addEventListener("dispose",f);i.get(h.texture).__webglTexture=h.__webglTexture=e.createTexture(),o.textures++,e.bindTexture(e.TEXTURE_2D,h.__webglTexture),E(e.TEXTURE_2D,h.texture,d),e.texImage2D(e.TEXTURE_2D,0,p,h.width,h.height,0,p,m,null),d&&h.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D)}e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL+c,e.TEXTURE_2D,h.__webglTexture,0)}for(var g=e.getParameter(r.MAX_COLOR_ATTACHMENTS_WEBGL);c<g;)e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL+c,e.TEXTURE_2D,null,0),c++;var v=[r.COLOR_ATTACHMENT0_WEBGL];for(c=1;c<n.length;c++)v.push(r.COLOR_ATTACHMENT0_WEBGL+c);r.drawBuffersWEBGL(v),l&&(e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null))}function T(t){function r(t){var r=t.texture;if(r.generateMipmaps&&l(t)&&r.minFilter!==go&&r.minFilter!==Eo){var a=t&&t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,o=i.get(r).__webglTexture;n.bindTexture(a,o),e.generateMipmap(a),n.bindTexture(a,null)}}if(Array.isArray(t))for(var a=0;a<t.length;a++)r(t[a]);else r(t)}var L="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext;this.setTexture2D=g,this.setTextureCube=v,this.setTextureCubeDynamic=y,this.setupRenderTarget=I,this.setupMultiRenderTarget=O,this.updateRenderTargetMipmap=T}function lt(){function e(e){var t=e.uuid,n=i[t];return void 0===n&&(n={},i[t]=n),n}function t(e){delete i[e.uuid]}function n(){i={}}var i={};return{get:e,remove:t,clear:n}}function ut(e,t,n){function i(){var t=!1,n=new r,i=null,a=new r;return{setMask:function(n){i===n||t||(e.colorMask(n,n,n,n),i=n)},setLocked:function(e){t=e},setClear:function(t,i,r,o,s){!0===s&&(t*=o,i*=o,r*=o),n.set(t,i,r,o),!1===a.equals(n)&&(e.clearColor(t,i,r,o),a.copy(n))},reset:function(){t=!1,i=null,a.set(0,0,0,1)}}}function a(){var t=!1,n=null,i=null,r=null;return{setTest:function(t){t?f(e.DEPTH_TEST):p(e.DEPTH_TEST)},setMask:function(i){n===i||t||(e.depthMask(i),n=i)},setFunc:function(t){if(i!==t){if(t)switch(t){case za:e.depthFunc(e.NEVER);break;case ja:e.depthFunc(e.ALWAYS);break;case Wa:e.depthFunc(e.LESS);break;case Xa:e.depthFunc(e.LEQUAL);break;case Ya:e.depthFunc(e.EQUAL);break;case qa:e.depthFunc(e.GEQUAL);break;case Za:e.depthFunc(e.GREATER);break;case Ka:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);i=t}},setLocked:function(e){t=e},setClear:function(t){r!==t&&(e.clearDepth(t),r=t)},reset:function(){t=!1,n=null,i=null,r=null}}}function o(){var t=!1,n=null,i=null,r=null,a=null,o=null,s=null,l=null,u=null;return{setTest:function(t){t?f(e.STENCIL_TEST):p(e.STENCIL_TEST)},setMask:function(i){n===i||t||(e.stencilMask(i),n=i)},setFunc:function(t,n,o){i===t&&r===n&&a===o||(e.stencilFunc(t,n,o),i=t,r=n,a=o)},setOp:function(t,n,i){o===t&&s===n&&l===i||(e.stencilOp(t,n,i),o=t,s=n,l=i)},setLocked:function(e){t=e},setClear:function(t){u!==t&&(e.clearStencil(t),u=t)},reset:function(){t=!1,n=null,i=null,r=null,a=null,o=null,s=null,l=null,u=null}}}function s(t,n,i){var r=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var o=0;o<i;o++)e.texImage2D(n+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,r);return a}function l(){w.setClear(0,0,0,1),U.setClear(1),R.setClear(0),f(e.DEPTH_TEST),U.setFunc(Xa),y(!1),E(la),f(e.CULL_FACE),f(e.BLEND),g(Ma)}function u(){for(var e=0,t=N.length;e<t;e++)N[e]=0}function c(n){if(N[n]=1,0===P[n]&&(e.enableVertexAttribArray(n),P[n]=1),0!==k[n]){t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(n,0),k[n]=0}}function h(n,i){if(N[n]=1,0===P[n]&&(e.enableVertexAttribArray(n),P[n]=1),k[n]!==i){t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(n,i),k[n]=i}}function d(){for(var t=0,n=P.length;t!==n;++t)P[t]!==N[t]&&(e.disableVertexAttribArray(t),P[t]=0)}function f(t){!0!==B[t]&&(e.enable(t),B[t]=!0)}function p(t){!1!==B[t]&&(e.disable(t),B[t]=!1)}function m(){if(null===F&&(F=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")))for(var n=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),i=0;i<n.length;i++)F.push(n[i]);return F}function g(t,i,r,a,o,s,l,u){t!==xa?f(e.BLEND):p(e.BLEND),t===H&&u===Y||(t===_a?u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE,e.ONE,e.ONE)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE)):t===Ca?u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR)):t===Ia?u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR)):u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)),H=t,Y=u),t===Oa?(o=o||i,s=s||r,l=l||a,i===G&&o===j||(e.blendEquationSeparate(n(i),n(o)),G=i,j=o),r===V&&a===z&&s===W&&l===X||(e.blendFuncSeparate(n(r),n(a),n(s),n(l)),V=r,z=a,W=s,X=l)):(G=null,V=null,z=null,j=null,W=null,X=null)}function v(t){t.side===ma?p(e.CULL_FACE):f(e.CULL_FACE),y(t.side===pa),!0===t.transparent?g(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha):g(xa),U.setFunc(t.depthFunc),U.setTest(t.depthTest),U.setMask(t.depthWrite),w.setMask(t.colorWrite),x(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)}function y(t){q!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),q=t)}function E(t){t!==sa?(f(e.CULL_FACE),t!==Z&&(t===la?e.cullFace(e.BACK):t===ua?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):p(e.CULL_FACE),Z=t}function b(t){t!==K&&(ne&&e.lineWidth(t),K=t)}function x(t,n,i){t?(f(e.POLYGON_OFFSET_FILL),Q===n&&J===i||(e.polygonOffset(n,i),Q=n,J=i)):p(e.POLYGON_OFFSET_FILL)}function M(){return $}function _(t){$=t,t?f(e.SCISSOR_TEST):p(e.SCISSOR_TEST)}function C(t){void 0===t&&(t=e.TEXTURE0+ee-1),ie!==t&&(e.activeTexture(t),ie=t)}function I(t,n){null===ie&&C();var i=re[ie];void 0===i&&(i={type:void 0,texture:void 0},re[ie]=i),i.type===t&&i.texture===n||(e.bindTexture(t,n||se[t]),i.type=t,i.texture=n)}function O(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error(e)}}function T(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error(e)}}function L(t){!1===ae.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),ae.copy(t))}function S(t){!1===oe.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),oe.copy(t))}function D(){for(var t=0;t<P.length;t++)1===P[t]&&(e.disableVertexAttribArray(t),P[t]=0);B={},F=null,ie=null,re={},H=null,q=null,Z=null,w.reset(),U.reset(),R.reset()}var w=new i,U=new a,R=new o,A=e.getParameter(e.MAX_VERTEX_ATTRIBS),N=new Uint8Array(A),P=new Uint8Array(A),k=new Uint8Array(A),B={},F=null,H=null,G=null,V=null,z=null,j=null,W=null,X=null,Y=!1,q=null,Z=null,K=null,Q=null,J=null,$=null,ee=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),te=parseFloat(/^WebGL\ ([0-9])/.exec(e.getParameter(e.VERSION))[1]),ne=parseFloat(te)>=1,ie=null,re={},ae=new r,oe=new r,se={};return se[e.TEXTURE_2D]=s(e.TEXTURE_2D,e.TEXTURE_2D,1),se[e.TEXTURE_CUBE_MAP]=s(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),{buffers:{color:w,depth:U,stencil:R},init:l,initAttributes:u,enableAttribute:c,enableAttributeAndDivisor:h,disableUnusedAttributes:d,enable:f,disable:p,getCompressedTextureFormats:m,setBlending:g,setMaterial:v,setFlipSided:y,setCullFace:E,setLineWidth:b,setPolygonOffset:x,getScissorTest:M,setScissorTest:_,activeTexture:C,bindTexture:I,compressedTexImage2D:O,texImage2D:T,scissor:L,viewport:S,reset:D}}function ct(e,t,n){function i(){if(void 0!==a)return a;var n=t.get("EXT_texture_filter_anisotropic");return a=null!==n?e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var a,o=void 0!==n.precision?n.precision:"highp",s=r(o);s!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",s,"instead."),o=s);var l=!0===n.logarithmicDepthBuffer&&!!t.get("EXT_frag_depth"),u=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),c=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_TEXTURE_SIZE),d=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),f=e.getParameter(e.MAX_VERTEX_ATTRIBS),p=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),m=e.getParameter(e.MAX_VARYING_VECTORS),g=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),v=c>0,y=!!t.get("OES_texture_float");return{getMaxAnisotropy:i,getMaxPrecision:r,precision:o,logarithmicDepthBuffer:l,maxTextures:u,maxVertexTextures:c,maxTextureSize:h,maxCubemapSize:d,maxAttributes:f,maxVertexUniforms:p,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:v,floatFragmentTextures:y,floatVertexTextures:v&&y}}function ht(e){var t={};return{get:function(n){if(void 0!==t[n])return t[n];var i;switch(n){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":i=e.getExtension("WEBGL_compressed_texture_etc1");break;default:i=e.getExtension(n)}return null===i&&console.warn("THREE.WebGLRenderer: "+n+" extension not supported."),t[n]=i,i}}}function dt(){function e(){u.value!==i&&(u.value=i,u.needsUpdate=r>0),n.numPlanes=r,n.numIntersection=0}function t(e,t,i,r){var a=null!==e?e.length:0,o=null;if(0!==a){if(o=u.value,!0!==r||null===o){var c=i+4*a,h=t.matrixWorldInverse;l.getNormalMatrix(h),(null===o||o.length<c)&&(o=new Float32Array(c));for(var d=0,f=i;d!==a;++d,f+=4)s.copy(e[d]).applyMatrix4(h,l),s.normal.toArray(o,f),o[f+3]=s.constant}u.value=o,u.needsUpdate=!0}return n.numPlanes=a,o}var n=this,i=null,r=0,a=!1,o=!1,s=new ne,l=new te,u={value:null,needsUpdate:!1}
;this.uniform=u,this.numPlanes=0,this.numIntersection=0,this.init=function(e,n,o){var s=0!==e.length||n||0!==r||a;return a=n,i=t(e,o,0),r=e.length,s},this.beginShadows=function(){o=!0,t(null)},this.endShadows=function(){o=!1,e()},this.setState=function(n,s,l,c,h,d){if(!a||null===n||0===n.length||o&&!l)if(o){var f=o?0:r,p=4*f,m=h.clippingState||null;u.value=m,m=t(n,c,p,d);for(var g=0;g!==p;++g)m[g]=i[g];h.clippingState=m,this.numIntersection=s?this.numPlanes:0,this.numPlanes+=f}else e();else{var f=o?0:r,p=4*f,m=h.clippingState||null;u.value=m,m=t(n,c,p,d);for(var g=0;g!==p;++g)m[g]=i[g];h.clippingState=m,this.numIntersection=s?this.numPlanes:0,this.numPlanes+=f}}}function ft(e){function t(){return null===ae?Ee:1}function n(){Qe.init(),Qe.scissor(ce.copy(be).multiplyScalar(Ee)),Qe.viewport(fe.copy(Me).multiplyScalar(Ee)),Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V)}function i(){ne=null,ue=null,le="",se=-1,Qe.reset()}function a(e){e.preventDefault(),i(),n(),Je.clear(),nt.clear()}function o(e){var t=e.target;t.removeEventListener("dispose",o),s(t)}function s(e){h(e),Je.remove(e)}function h(e){var t=Je.get(e).program;e.program=void 0,void 0!==t&&it.releaseProgram(t)}function d(e,t,n){e.render(function(e){te.renderBufferImmediate(e,t,n)})}function f(e,t){return Math.abs(t[0])-Math.abs(e[0])}function p(e,t,n,i){if(n&&n.isInstancedBufferGeometry&&null===Ze.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===i&&(i=0),Qe.initAttributes();var r=n.attributes,a=t.getAttributes(),o=e.defaultAttributeValues;for(var s in a){var l=a[s];if(l>=0){var u=r[s];if(void 0!==u){var c=u.normalized,h=u.itemSize,d=et.get(u),f=d.buffer,p=d.type,m=d.bytesPerElement;if(u.isInterleavedBufferAttribute){var g=u.data,v=g.stride,y=u.offset;g&&g.isInstancedInterleavedBuffer?(Qe.enableAttributeAndDivisor(l,g.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=g.meshPerAttribute*g.count)):Qe.enableAttribute(l),Ye.bindBuffer(Ye.ARRAY_BUFFER,f),Ye.vertexAttribPointer(l,h,p,c,v*m,(i*v+y)*m)}else u.isInstancedBufferAttribute?(Qe.enableAttributeAndDivisor(l,u.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=u.meshPerAttribute*u.count)):Qe.enableAttribute(l),Ye.bindBuffer(Ye.ARRAY_BUFFER,f),Ye.vertexAttribPointer(l,h,p,c,0,i*h*m)}else if(void 0!==o){var E=o[s];if(void 0!==E)switch(E.length){case 2:Ye.vertexAttrib2fv(l,E);break;case 3:Ye.vertexAttrib3fv(l,E);break;case 4:Ye.vertexAttrib4fv(l,E);break;default:Ye.vertexAttrib1fv(l,E)}}}}Qe.disableUnusedAttributes()}function m(e,t,n){if(e.visible&&!1!==e.alive){if(e.layers.test(t.layers))if(e.isLight)j.push(e);else if(e.isSprite)e.frustumCulled&&!_e.intersectsSprite(e)||J.push(e);else if(e.isLensFlare)$.push(e);else if(e.isImmediateRenderObject)n&&we.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Se),Y.push(e,null,e.material,we.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!e.frustumCulled||_e.intersectsObject(e))){n&&we.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Se);var i=nt.update(e),r=e.material;if(Array.isArray(r))for(var a=i.groups,o=0,s=a.length;o<s;o++){var l=a[o],u=l.materialIndex<0?r[Math.abs(2+l.materialIndex)]:r[l.materialIndex];u&&u.visible&&Y.push(e,i,u,we.z,l)}else r.visible&&Y.push(e,i,r,we.z,null)}for(var c=e.children,o=0,s=c.length;o<s;o++)m(c[o],t,n)}}function g(e,t,n,i){for(var r=0,a=e.length;r<a;r++){var o=e[r],s=o.object,l=o.geometry,u=o.group;if(t.backFrontStencil){var c=o.material;if(i&&c.side==THREE.DoubleSide)continue;if("LineSegments"==s.type)continue;var h=i;if(c.defines&&c.defines.hasOwnProperty("USE_INSTANCE")){h=i.side==THREE.FrontSide?t.frontInstanceMaterial:t.backInstanceMaterial}else if(u&&u.materialIndex>=0)continue}else{var h=void 0===i?o.material:i;u&&u.materialIndex<0&&(u.materialIndex=Math.abs(2+u.materialIndex))}if(s.onBeforeRender(te,t,n,l,h,u),n.isArrayCamera&&n.enabled)for(var d=n.cameras,f=0,p=d.length;f<p;f++){var m=d[f],g=m.bounds;te.setViewport(g.x*ve*Ee,g.y*ye*Ee,g.z*ve*Ee,g.w*ye*Ee),te.setScissor(g.x*ve*Ee,g.y*ye*Ee,g.z*ve*Ee,g.w*ye*Ee),te.setScissorTest(!0),v(s,t,m,l,h,u)}else v(s,t,n,l,h,u);s.onAfterRender(te,t,n,l,h,u)}}function v(e,t,n,i,r,a){if(e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){Qe.setMaterial(r);var o=E(n,t.fog,r,e);le="",d(e,o,r)}else te.renderBufferDirect(n,t.fog,i,r,e,a)}function y(e,t,n){var i=Je.get(e),r=it.getParameters(e,Be,t,Ce.numPlanes,Ce.numIntersection,n),a=it.getProgramCode(e,r),s=i.program,l=!0;if(void 0===s)e.addEventListener("dispose",o);else if(s.code!==a)h(e);else{if(void 0!==r.shaderID)return;l=!1}if(l){if(r.shaderID){var u=Cs[r.shaderID];i.__webglShader={name:e.type,uniforms:Ms.clone(u.uniforms),vertexShader:u.vertexShader,fragmentShader:u.fragmentShader}}else i.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=i.__webglShader,s=it.acquireProgram(e,r,a),i.program=s,e.program=s}var c=s.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var d=0;d<te.maxMorphTargets;d++)c["morphTarget"+d]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(var d=0;d<te.maxMorphNormals;d++)c["morphNormal"+d]>=0&&e.numSupportedMorphNormals++}var f=i.__webglShader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(i.numClippingPlanes=Ce.numPlanes,i.numIntersection=Ce.numIntersection,f.clippingPlanes=Ce.uniform),i.fog=t,i.lightsHash=Be.hash,e.lights&&(f.ambientLightColor.value=Be.ambient,f.directionalLights.value=Be.directional,f.spotLights.value=Be.spot,f.rectAreaLights.value=Be.rectArea,f.pointLights.value=Be.point,f.hemisphereLights.value=Be.hemi,f.directionalShadowMap.value=Be.directionalShadowMap,f.directionalShadowMatrix.value=Be.directionalShadowMatrix,f.spotShadowMap.value=Be.spotShadowMap,f.spotShadowMatrix.value=Be.spotShadowMatrix,f.pointShadowMap.value=Be.pointShadowMap,f.pointShadowMatrix.value=Be.pointShadowMatrix);var p=i.program.getUniforms(),m=W.seqWithValue(p.seq,f);i.uniformsList=m}function E(e,t,n,i){pe=0;var r=Je.get(n);if(Ie&&(Oe||e!==ue)){var a=e===ue&&n.id===se;Ce.setState(n.clippingPlanes,n.clipIntersection,n.clipShadows,e,r,a)}!1===n.needsUpdate&&(void 0===r.program?n.needsUpdate=!0:n.fog&&r.fog!==t?n.needsUpdate=!0:n.lights&&r.lightsHash!==Be.hash?n.needsUpdate=!0:void 0===r.numClippingPlanes||r.numClippingPlanes===Ce.numPlanes&&r.numIntersection===Ce.numIntersection||(n.needsUpdate=!0)),n.needsUpdate&&(y(n,t,i),n.needsUpdate=!1);var o=!1,s=!1,l=!1,u=r.program,h=u.getUniforms(),d=r.__webglShader.uniforms;if(u.id!==ne&&(Ye.useProgram(u.program),ne=u.id,o=!0,s=!0,l=!0),n.id!==se&&(se=n.id,s=!0),o||e!==ue){if(h.setValue(Ye,"projectionMatrix",e.projectionMatrix),Ke.logarithmicDepthBuffer&&h.setValue(Ye,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),e!==ue&&(ue=e,s=!0,l=!0),n.isShaderMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.envMap){var f=h.map.cameraPosition;void 0!==f&&f.setValue(Ye,we.setFromMatrixPosition(e.matrixWorld))}(n.isMeshPhongMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial||n.skinning)&&h.setValue(Ye,"viewMatrix",e.matrixWorldInverse),h.setValue(Ye,"toneMappingExposure",te.toneMappingExposure),h.setValue(Ye,"toneMappingWhitePoint",te.toneMappingWhitePoint)}if(n.skinning){h.setOptional(Ye,i,"bindMatrix"),h.setOptional(Ye,i,"bindMatrixInverse");var p=i.skeleton;if(p){var m=p.bones;if(Ke.floatVertexTextures){if(void 0===p.boneTexture){var g=Math.sqrt(4*m.length);g=hs.nextPowerOfTwo(Math.ceil(g)),g=Math.max(g,4);var v=new Float32Array(g*g*4);v.set(p.boneMatrices);var E=new c(v,g,g,Po,Lo);p.boneMatrices=v,p.boneTexture=E,p.boneTextureSize=g}h.setValue(Ye,"boneTexture",p.boneTexture),h.setValue(Ye,"boneTextureSize",p.boneTextureSize)}else h.setOptional(Ye,p,"boneMatrices")}}if(s&&(n.lights&&w(d,l),t&&n.fog&&C(d,t),(n.isMeshBasicMaterial||n.isMeshLambertMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.isMeshNormalMaterial||n.isMeshDepthMaterial)&&b(d,n),n.isLineBasicMaterial?x(d,n):n.isLineDashedMaterial?(x(d,n),M(d,n)):n.isPointsMaterial?_(d,n):n.isMeshLambertMaterial?I(d,n):n.isMeshToonMaterial?T(d,n):n.isMeshPhongMaterial?O(d,n):n.isMeshPhysicalMaterial?S(d,n):n.isMeshStandardMaterial?L(d,n):n.isMeshDepthMaterial?n.displacementMap&&(d.displacementMap.value=n.displacementMap,d.displacementScale.value=n.displacementScale,d.displacementBias.value=n.displacementBias):n.isMeshNormalMaterial&&D(d,n),void 0!==d.ltcMat&&(d.ltcMat.value=xs.LTC_MAT_TEXTURE),void 0!==d.ltcMag&&(d.ltcMag.value=xs.LTC_MAG_TEXTURE),W.upload(Ye,r.uniformsList,d,te)),h.map.objId){var U=i.originalId;ee.set((U>>16&255)/255,(U>>8&255)/255,(255&U)/255),h.setValue(Ye,"objId",ee)}return h.setValue(Ye,"modelViewMatrix",i.modelViewMatrix),h.setValue(Ye,"normalMatrix",i.normalMatrix),h.setValue(Ye,"modelMatrix",i.matrixWorld),u}function b(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var n;if(t.map?n=t.map:t.specularMap?n=t.specularMap:t.displacementMap?n=t.displacementMap:t.normalMap?n=t.normalMap:t.bumpMap?n=t.bumpMap:t.roughnessMap?n=t.roughnessMap:t.metalnessMap?n=t.metalnessMap:t.alphaMap?n=t.alphaMap:t.emissiveMap&&(n=t.emissiveMap),void 0!==n){n.isWebGLRenderTarget&&(n=n.texture);var i=n.offset,r=n.repeat;e.offsetRepeat.value.set(i.x,i.y,r.x,r.y),e.rotateMatrix.value.copy(n.rotateMatrix)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function x(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function M(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function _(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*Ee,e.scale.value=.5*ye,e.map.value=t.map,null!==t.map){var n=t.map.offset,i=t.map.repeat;e.offsetRepeat.value.set(n.x,n.y,i.x,i.y)}}function C(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function I(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function O(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function T(e,t){O(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}function L(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function S(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,L(e,t)}function D(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function w(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}function U(e){for(var t=0,n=0,i=e.length;n<i;n++){var r=e[n];r.castShadow&&(Be.shadows[t]=r,t++)}Be.shadows.length=t}function R(e,t){var n,i,r,a,o,s,l,u,c=0,h=0,d=0,f=t.matrixWorldInverse,p=0,m=0,g=0,v=0,y=0;for(n=0,i=e.length;n<i;n++)if(r=e[n],o=r.color,s=r.intensity,l=r.distance,u=r.shadow&&r.shadow.map?r.shadow.map.texture:null,r.isAmbientLight)c+=o.r*s,h+=o.g*s,d+=o.b*s;else if(r.isDirectionalLight){var E=rt.get(r);E.color.copy(r.color).multiplyScalar(r.intensity),E.direction.setFromMatrixPosition(r.matrixWorld),we.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(we),E.direction.transformDirection(f),E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),Be.directionalShadowMap[p]=u,Be.directionalShadowMatrix[p]=r.shadow.matrix,Be.directional[p]=E,p++}else if(r.isSpotLight){var E=rt.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(o).multiplyScalar(s),E.distance=l,E.direction.setFromMatrixPosition(r.matrixWorld),we.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(we),E.direction.transformDirection(f),E.coneCos=Math.cos(r.angle),E.penumbraCos=Math.cos(r.angle*(1-r.penumbra)),E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),Be.spotShadowMap[g]=u,Be.spotShadowMatrix[g]=r.shadow.matrix,Be.spot[g]=E,g++}else if(r.isRectAreaLight){var E=rt.get(r);E.color.copy(o).multiplyScalar(s/(r.width*r.height)),E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),ke.identity(),Re.copy(r.matrixWorld),Re.premultiply(f),ke.extractRotation(Re),E.halfWidth.set(.5*r.width,0,0),E.halfHeight.set(0,.5*r.height,0),E.halfWidth.applyMatrix4(ke),E.halfHeight.applyMatrix4(ke),Be.rectArea[v]=E,v++}else if(r.isPointLight){var E=rt.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(r.color).multiplyScalar(r.intensity),E.distance=r.distance,E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),Be.pointShadowMap[m]=u,Be.pointShadowMatrix[m]=r.shadow.matrix,Be.point[m]=E,m++}else if(r.isHemisphereLight){var E=rt.get(r);E.direction.setFromMatrixPosition(r.matrixWorld),E.direction.transformDirection(f),E.direction.normalize(),E.skyColor.copy(r.color).multiplyScalar(s),E.groundColor.copy(r.groundColor).multiplyScalar(s),Be.hemi[y]=E,y++}Be.ambient[0]=c,Be.ambient[1]=h,Be.ambient[2]=d,Be.directional.length=p,Be.spot.length=g,Be.rectArea.length=v,Be.point.length=m,Be.hemi.length=y,Be.hash=p+","+m+","+g+","+v+","+y+","+Be.shadows.length}function A(){var e=pe;return e>=Ke.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+Ke.maxTextures),pe+=1,e}function N(e){var t;if(e===fo)return Ye.REPEAT;if(e===po)return Ye.CLAMP_TO_EDGE;if(e===mo)return Ye.MIRRORED_REPEAT;if(e===go)return Ye.NEAREST;if(e===vo)return Ye.NEAREST_MIPMAP_NEAREST;if(e===yo)return Ye.NEAREST_MIPMAP_LINEAR;if(e===Eo)return Ye.LINEAR;if(e===bo)return Ye.LINEAR_MIPMAP_NEAREST;if(e===xo)return Ye.LINEAR_MIPMAP_LINEAR;if(e===Mo)return Ye.UNSIGNED_BYTE;if(e===Do)return Ye.UNSIGNED_SHORT_4_4_4_4;if(e===wo)return Ye.UNSIGNED_SHORT_5_5_5_1;if(e===Uo)return Ye.UNSIGNED_SHORT_5_6_5;if(e===_o)return Ye.BYTE;if(e===Co)return Ye.SHORT;if(e===Io)return Ye.UNSIGNED_SHORT;if(e===Oo)return Ye.INT;if(e===To)return Ye.UNSIGNED_INT;if(e===Lo)return Ye.FLOAT;if(e===So&&null!==(t=Ze.get("OES_texture_half_float")))return t.HALF_FLOAT_OES;if(e===Ao)return Ye.ALPHA;if(e===No)return Ye.RGB;if(e===Po)return Ye.RGBA;if(e===ko)return Ye.LUMINANCE;if(e===Bo)return Ye.LUMINANCE_ALPHA;if(e===Ho)return Ye.DEPTH_COMPONENT;if(e===Go)return Ye.DEPTH_STENCIL;if(e===Ta)return Ye.FUNC_ADD;if(e===La)return Ye.FUNC_SUBTRACT;if(e===Sa)return Ye.FUNC_REVERSE_SUBTRACT;if(e===Ua)return Ye.ZERO;if(e===Ra)return Ye.ONE;if(e===Aa)return Ye.SRC_COLOR;if(e===Na)return Ye.ONE_MINUS_SRC_COLOR;if(e===Pa)return Ye.SRC_ALPHA;if(e===ka)return Ye.ONE_MINUS_SRC_ALPHA;if(e===Ba)return Ye.DST_ALPHA;if(e===Fa)return Ye.ONE_MINUS_DST_ALPHA;if(e===Ha)return Ye.DST_COLOR;if(e===Ga)return Ye.ONE_MINUS_DST_COLOR;if(e===Va)return Ye.SRC_ALPHA_SATURATE;if((e===Vo||e===zo||e===jo||e===Wo)&&null!==(t=Ze.get("WEBGL_compressed_texture_s3tc"))){if(e===Vo)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===zo)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===jo)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===Wo)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===Xo||e===Yo||e===qo||e===Zo)&&null!==(t=Ze.get("WEBGL_compressed_texture_pvrtc"))){if(e===Xo)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Yo)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===qo)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Zo)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ko&&null!==(t=Ze.get("WEBGL_compressed_texture_etc1")))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===Da||e===wa)&&null!==(t=Ze.get("EXT_blend_minmax"))){if(e===Da)return t.MIN_EXT;if(e===wa)return t.MAX_EXT}return e===Ro&&null!==(t=Ze.get("WEBGL_depth_texture"))?t.UNSIGNED_INT_24_8_WEBGL:0}console.log("THREE.WebGLRenderer",aa),e=e||{};var P=void 0!==e.canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),k=void 0!==e.context?e.context:null,B=void 0!==e.alpha&&e.alpha,F=void 0===e.depth||e.depth,H=void 0===e.stencil||e.stencil,G=void 0!==e.antialias&&e.antialias,V=void 0===e.premultipliedAlpha||e.premultipliedAlpha,z=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,j=[],Y=null,K=new Float32Array(8),J=[],$=[],ee=new l;this.domElement=P,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=to,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var te=this,ne=null,ae=null,oe=null,se=-1,le="",ue=null,ce=new r,he=null,fe=new r,pe=0,me=new X(0),ge=0,ve=P.width,ye=P.height,Ee=1,be=new r(0,0,ve,ye),xe=!1,Me=new r(0,0,ve,ye),_e=new ie,Ce=new dt,Ie=!1,Oe=!1,Se=new u,we=new l,Re=new u,ke=new u,Be={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],shadows:[]},Fe={geometries:0,textures:0},Xe={frame:0,calls:0,vertices:0,faces:0,points:0};this.info={render:Xe,memory:Fe,programs:null};var Ye;try{var qe={alpha:B,depth:F,stencil:H,antialias:G,premultipliedAlpha:V,preserveDrawingBuffer:z};if(null===(Ye=k||P.getContext("webgl",qe)||P.getContext("experimental-webgl",qe)))throw null!==P.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===Ye.getShaderPrecisionFormat&&(Ye.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),P.addEventListener("webglcontextlost",a,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}var Ze=new ht(Ye);Ze.get("WEBGL_depth_texture"),Ze.get("OES_texture_float"),Ze.get("OES_texture_float_linear"),Ze.get("OES_texture_half_float"),Ze.get("OES_texture_half_float_linear"),Ze.get("OES_standard_derivatives"),Ze.get("ANGLE_instanced_arrays"),Ze.get("WEBGL_draw_buffers"),Ze.get("OES_element_index_uint")&&(Te.MaxIndex=4294967296);var Ke=new ct(Ye,Ze,e),Qe=new ut(Ye,Ze,N),Je=new lt,$e=new st(Ye,Ze,Qe,Je,Ke,N,Fe),et=new Pe(Ye),tt=new ze(Ye,et,Fe),nt=new We(Ye,tt,Xe),it=new ot(this,Ke),rt=new je,at=new He;this.info.programs=it.programs;var ft,pt,mt,gt,vt=new Ve(Ye,Ze,Xe),yt=new Ge(Ye,Ze,Xe);n(),this.context=Ye,this.capabilities=Ke,this.extensions=Ze,this.properties=Je,this.state=Qe;var Et=new re(this,Be,nt,Ke);this.shadowMap=Et;var bt=new Z(this,J),xt=new q(this,$);this.getContext=function(){return Ye},this.getContextAttributes=function(){return Ye.getContextAttributes()},this.forceContextLoss=function(){var e=Ze.get("WEBGL_lose_context");e&&e.loseContext()},this.getMaxAnisotropy=function(){return Ke.getMaxAnisotropy()},this.getPrecision=function(){return Ke.precision},this.getPixelRatio=function(){return Ee},this.setPixelRatio=function(e){void 0!==e&&(Ee=e,this.setSize(Me.z,Me.w,!1))},this.getSize=function(){return{width:ve,height:ye}},this.setSize=function(e,t,n){ve=e,ye=t,P.width=e*Ee,P.height=t*Ee,!1!==n&&(P.style.width=e+"px",P.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,n,i){Qe.viewport(Me.set(e,t,n,i))},this.setScissor=function(e,t,n,i){Qe.scissor(be.set(e,t,n,i))},this.setScissorTest=function(e){Qe.setScissorTest(xe=e)},this.getClearColor=function(){return me},this.setClearColor=function(e,t){me.set(e),ge=void 0!==t?t:1,Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V)},this.getClearAlpha=function(){return ge},this.setClearAlpha=function(e){ge=e,Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V)},this.clear=function(e,t,n){var i=0;(void 0===e||e)&&(i|=Ye.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=Ye.DEPTH_BUFFER_BIT),(void 0===n||n)&&(i|=Ye.STENCIL_BUFFER_BIT),Ye.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,n,i){this.setRenderTarget(e),this.clear(t,n,i)},this.resetGLState=i,this.dispose=function(){P.removeEventListener("webglcontextlost",a,!1),at.dispose()},this.renderBufferImmediate=function(e,t,n){Qe.initAttributes();var i=Je.get(e);e.hasPositions&&!i.position&&(i.position=Ye.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=Ye.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=Ye.createBuffer()),e.hasColors&&!i.color&&(i.color=Ye.createBuffer());var r=t.getAttributes();if(e.hasPositions&&(Ye.bindBuffer(Ye.ARRAY_BUFFER,i.position),Ye.bufferData(Ye.ARRAY_BUFFER,e.positionArray,Ye.DYNAMIC_DRAW),Qe.enableAttribute(r.position),Ye.vertexAttribPointer(r.position,3,Ye.FLOAT,!1,0,0)),e.hasNormals){if(Ye.bindBuffer(Ye.ARRAY_BUFFER,i.normal),!n.isMeshPhongMaterial&&!n.isMeshStandardMaterial&&!n.isMeshNormalMaterial&&n.shading===ga)for(var a=0,o=3*e.count;a<o;a+=9){var s=e.normalArray,l=(s[a+0]+s[a+3]+s[a+6])/3,u=(s[a+1]+s[a+4]+s[a+7])/3,c=(s[a+2]+s[a+5]+s[a+8])/3;s[a+0]=l,s[a+1]=u,s[a+2]=c,s[a+3]=l,s[a+4]=u,s[a+5]=c,s[a+6]=l,s[a+7]=u,s[a+8]=c}Ye.bufferData(Ye.ARRAY_BUFFER,e.normalArray,Ye.DYNAMIC_DRAW),Qe.enableAttribute(r.normal),Ye.vertexAttribPointer(r.normal,3,Ye.FLOAT,!1,0,0)}e.hasUvs&&n.map&&(Ye.bindBuffer(Ye.ARRAY_BUFFER,i.uv),Ye.bufferData(Ye.ARRAY_BUFFER,e.uvArray,Ye.DYNAMIC_DRAW),Qe.enableAttribute(r.uv),Ye.vertexAttribPointer(et.uv,2,Ye.FLOAT,!1,0,0)),e.hasColors&&n.vertexColors!==ya&&(Ye.bindBuffer(Ye.ARRAY_BUFFER,i.color),Ye.bufferData(Ye.ARRAY_BUFFER,e.colorArray,Ye.DYNAMIC_DRAW),Qe.enableAttribute(r.color),Ye.vertexAttribPointer(r.color,3,Ye.FLOAT,!1,0,0)),Qe.disableUnusedAttributes(),Ye.drawArrays(Ye.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,n,i,r,a,o){Qe.setMaterial(r);var s=E(e,n,r,a),l=i.id;l+="_",l+=s.id,l+="_",l+=!0===r.wireframe;var u=!1;l!==le&&(le=l,u=!0);var c=a.morphTargetInfluences;if(void 0!==c){for(var h=[],d=0,m=c.length;d<m;d++){var g=c[d];h.push([g,d])}h.sort(f),h.length>8&&(h.length=8);for(var v=i.morphAttributes,d=0,m=h.length;d<m;d++){var g=h[d];if(K[d]=g[0],0!==g[0]){var y=g[1];!0===r.morphTargets&&v.position&&i.addAttribute("morphTarget"+d,v.position[y]),!0===r.morphNormals&&v.normal&&i.addAttribute("morphNormal"+d,v.normal[y])}else!0===r.morphTargets&&i.removeAttribute("morphTarget"+d),!0===r.morphNormals&&i.removeAttribute("morphNormal"+d)}for(var d=h.length,b=K.length;d<b;d++)K[d]=0;s.getUniforms().setValue(Ye,"morphTargetInfluences",K),u=!0}var y=i.index,x=i.attributes.position,M=1;!0===r.wireframe&&(y=tt.getWireframeAttribute(i),M=2);var _=vt;null!==y&&(_=yt,_.setIndex(y)),u&&(p(r,s,i),null!==y&&Ye.bindBuffer(Ye.ELEMENT_ARRAY_BUFFER,et.get(y).buffer));var C=0;null!==y?C=y.count:void 0!==x&&(C=x.count);var I=i.drawRange.start*M,O=i.drawRange.count*M,T=null!==o?o.start*M:0,L=null!==o?o.count*M:1/0,S=Math.max(I,T),D=Math.min(C,I+O,T+L)-1,w=Math.max(0,D-S+1);if(0!==w){if(a.isMesh)if(!0===r.wireframe)Qe.setLineWidth(r.wireframeLinewidth*t()),_.setMode(Ye.LINES);else switch(a.drawMode){case $o:_.setMode(Ye.TRIANGLES);break;case es:_.setMode(Ye.TRIANGLE_STRIP);break;case ts:_.setMode(Ye.TRIANGLE_FAN)}else if(a.isLine){var U=r.linewidth;void 0===U&&(U=1),Qe.setLineWidth(U*t()),a.isLineSegments?_.setMode(Ye.LINES):a.isLineLoop?_.setMode(Ye.LINE_LOOP):_.setMode(Ye.LINE_STRIP)}else a.isPoints&&_.setMode(Ye.POINTS);i&&i.isInstancedBufferGeometry?i.maxInstancedCount>0&&_.renderInstances(i,S,w):_.render(S,w)}},this.compile=function(e,t){j=[],e.traverse(function(e){e.isLight&&j.push(e)}),R(j,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var n=0;n<t.material.length;n++)y(t.material[n],e.fog,t);else y(t.material,e.fog,t)})},this.render=function(e,t,n,i){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");le="",se=-1,ue=null,!0===e.autoUpdate&&e.updateMatrixWorld(),t.onBeforeRender(te),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),Se.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),_e.setFromMatrix(Se),j.length=0,J.length=0,$.length=0,Oe=this.localClippingEnabled,Ie=Ce.init(this.clippingPlanes,Oe,t),Y=at.get(e,t),Y.init(),m(e,t,te.sortObjects),Y.finish(),!0===te.sortObjects&&Y.sort(),Ie&&Ce.beginShadows(),U(j),Et.render(e,t),R(j,t),Ie&&Ce.endShadows(),Xe.frame++,Xe.calls=0,Xe.vertices=0,Xe.faces=0,Xe.points=0,void 0===n&&(n=null),this.setRenderTarget(n);var r=e.background;null===r?Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V):r&&r.isColor&&(Qe.buffers.color.setClear(r.r,r.g,r.b,1,V),i=!0),(this.autoClear||i)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),r&&r.isCubeTexture?(void 0===mt&&(mt=new Ae,gt=new Le(new De(5,5,5),new Q({uniforms:Cs.cube.uniforms,vertexShader:Cs.cube.vertexShader,fragmentShader:Cs.cube.fragmentShader,side:pa,depthTest:!1,depthWrite:!1,fog:!1}))),mt.projectionMatrix.copy(t.projectionMatrix),mt.matrixWorld.extractRotation(t.matrixWorld),mt.matrixWorldInverse.getInverse(mt.matrixWorld),gt.material.uniforms.tCube.value=r,gt.modelViewMatrix.multiplyMatrices(mt.matrixWorldInverse,gt.matrixWorld),nt.update(gt),te.renderBufferDirect(mt,null,gt.geometry,gt.material,gt,null)):r&&r.isTexture&&(void 0===ft&&(ft=new Ne(-1,1,1,-1,0,1),pt=new Le(new Ue(2,2),new de({depthTest:!1,depthWrite:!1,fog:!1}))),pt.material.map=r,nt.update(pt),te.renderBufferDirect(ft,null,pt.geometry,pt.material,pt,null));var a=Y.opaque,o=Y.transparent;if(e.overrideMaterial){var s=e.overrideMaterial;a.length&&g(a,e,t,s),o.length&&g(o,e,t,s)}else a.length&&g(a,e,t),o.length&&g(o,e,t);bt.render(e,t),xt.render(e,t,fe),n&&$e.updateRenderTargetMipmap(n),Qe.buffers.depth.setTest(!0),Qe.buffers.depth.setMask(!0),Qe.buffers.color.setMask(!0),t.isArrayCamera&&t.enabled&&te.setScissorTest(!1),t.onAfterRender(te)},this.setFaceCulling=function(e,t){Qe.setCullFace(e),Qe.setFlipSided(t===ca)},this.allocTextureUnit=A,this.setTexture2D=function(){var e=!1;return function(t,n){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),$e.setTexture2D(t,n)}}(),this.setTexture=function(){var e=!1;return function(t,n){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),$e.setTexture2D(t,n)}}(),this.setTextureCube=function(){var e=!1;return function(t,n){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?$e.setTextureCube(t,n):$e.setTextureCubeDynamic(t,n)}}(),this.getRenderTarget=function(){return ae},this.isMRTSupported=function(){return Ze.get("WEBGL_draw_buffers")},this.setRenderTarget=function(e){if(Array.isArray(e)){if(this.isMRTSupported()){ae=e[0],$e.setupMultiRenderTarget(e);var t,n=Je.get(e[0]);t=n.__webglFramebuffer;var i=ae;ce.copy(i.scissor),he=i.scissorTest,fe.copy(i.viewport),oe!==t&&(Ye.bindFramebuffer(Ye.FRAMEBUFFER,t),oe=t),Qe.scissor(ce),Qe.setScissorTest(he),Qe.viewport(fe)}}else{ae=e,e&&void 0===Je.get(e).__webglFramebuffer&&$e.setupRenderTarget(e);var t,r=e&&e.isWebGLRenderTargetCube;if(e){var n=Je.get(e);t=r?n.__webglFramebuffer[e.activeCubeFace]:n.__webglFramebuffer,ce.copy(e.scissor),he=e.scissorTest,fe.copy(e.viewport)}else t=null,ce.copy(be).multiplyScalar(Ee),he=xe,fe.copy(Me).multiplyScalar(Ee);if(oe!==t&&(Ye.bindFramebuffer(Ye.FRAMEBUFFER,t),oe=t),Qe.scissor(ce),Qe.setScissorTest(he),Qe.viewport(fe),r){var a=Je.get(e.texture);Ye.framebufferTexture2D(Ye.FRAMEBUFFER,Ye.COLOR_ATTACHMENT0,Ye.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,a.__webglTexture,e.activeMipMapLevel)}}},this.readRenderTargetPixels=function(e,t,n,i,r,a){if(!1===(e&&e.isWebGLRenderTarget))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");var o=Je.get(e).__webglFramebuffer;if(o){var s=!1;o!==oe&&(Ye.bindFramebuffer(Ye.FRAMEBUFFER,o),s=!0);try{var l=e.texture,u=l.format,c=l.type;if(u!==Po&&N(u)!==Ye.getParameter(Ye.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(c===Mo||N(c)===Ye.getParameter(Ye.IMPLEMENTATION_COLOR_READ_TYPE)||c===Lo&&(Ze.get("OES_texture_float")||Ze.get("WEBGL_color_buffer_float"))||c===So&&Ze.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");Ye.checkFramebufferStatus(Ye.FRAMEBUFFER)===Ye.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-i&&n>=0&&n<=e.height-r&&Ye.readPixels(t,n,i,r,N(u),N(c),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&Ye.bindFramebuffer(Ye.FRAMEBUFFER,oe)}}}}function pt(e,t){this.name="",this.color=new X(e),this.density=void 0!==t?t:25e-5}function mt(e,t,n){this.name="",this.color=new X(e),this.near=void 0!==t?t:1,this.far=void 0!==n?n:1e3}function gt(){le.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function vt(e,t,n,i,r){le.call(this),this.lensFlares=[],this.positionScreen=new l,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,n,i,r)}function yt(e){K.call(this),this.type="SpriteMaterial",this.color=new X(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Et(e){le.call(this),this.type="Sprite",this.material=void 0!==e?e:new yt}function bt(){le.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function xt(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[]
;for(var n=0,i=this.bones.length;n<i;n++)this.boneInverses.push(new u)}}function Mt(){le.call(this),this.type="Bone"}function _t(e,t){Le.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new u,this.bindMatrixInverse=new u;var n=this.initBones(),i=new xt(n);this.bind(i,this.matrixWorld),this.normalizeSkinWeights()}function Ct(e){K.call(this),this.type="LineBasicMaterial",this.color=new X(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function It(e,t,n){if(1===n)return console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new Ot(e,t);le.call(this),this.type="Line",this.geometry=void 0!==e?e:new Te,this.material=void 0!==t?t:new Ct({color:16777215*Math.random()})}function Ot(e,t){It.call(this,e,t),this.type="LineSegments"}function Tt(e,t){It.call(this,e,t),this.type="LineLoop"}function Lt(e){K.call(this),this.type="PointsMaterial",this.color=new X(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.positionOffset=!1,this.sizeAttribute=!1,this.lights=!1,this.setValues(e)}function St(e,t){le.call(this),this.type="Points",this.geometry=void 0!==e?e:new Te,this.material=void 0!==t?t:new Lt({color:16777215*Math.random()})}function Dt(){le.call(this),this.type="Group"}function wt(e,t,n,r,a,o,s,l,u){function c(){requestAnimationFrame(c),e.readyState>=e.HAVE_CURRENT_DATA&&(h.needsUpdate=!0)}i.call(this,e,t,n,r,a,o,s,l,u),this.generateMipmaps=!1;var h=this;c()}function Ut(e,t,n,r,a,o,s,l,u,c,h,d){i.call(this,null,o,s,l,u,c,r,a,h,d),this.image={width:t,height:n},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function Rt(e,t,n,r,a,o,s,l,u){i.call(this,e,t,n,r,a,o,s,l,u),this.needsUpdate=!0}function At(e,t,n,r,a,o,s,l,u,c){if((c=void 0!==c?c:Ho)!==Ho&&c!==Go)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===n&&c===Ho&&(n=Io),void 0===n&&c===Go&&(n=Ro),i.call(this,null,r,a,o,s,l,c,n,u),this.image={width:e,height:t},this.magFilter=void 0!==s?s:go,this.minFilter=void 0!==l?l:go,this.flipY=!1,this.generateMipmaps=!1}function Nt(e){Te.call(this),this.type="WireframeGeometry";var t,n,i,r,a,o,s,u,c,h,d=[],f=[0,0],p={},m=["a","b","c"];if(e&&e.isGeometry){var g=e.faces;for(t=0,i=g.length;t<i;t++){var v=g[t];for(n=0;n<3;n++)s=v[m[n]],u=v[m[(n+1)%3]],f[0]=Math.min(s,u),f[1]=Math.max(s,u),c=f[0]+","+f[1],void 0===p[c]&&(p[c]={index1:f[0],index2:f[1]})}for(c in p)o=p[c],h=e.vertices[o.index1],d.push(h.x,h.y,h.z),h=e.vertices[o.index2],d.push(h.x,h.y,h.z)}else if(e&&e.isBufferGeometry){var y,E,b,x,M,_,C,I;if(h=new l,null!==e.index){for(y=e.attributes.position,E=e.index,b=e.groups,0===b.length&&(b=[{start:0,count:E.count,materialIndex:0}]),r=0,a=b.length;r<a;++r)for(x=b[r],M=x.start,_=x.count,t=M,i=M+_;t<i;t+=3)for(n=0;n<3;n++)s=E.getX(t+n),u=E.getX(t+(n+1)%3),f[0]=Math.min(s,u),f[1]=Math.max(s,u),c=f[0]+","+f[1],void 0===p[c]&&(p[c]={index1:f[0],index2:f[1]});for(c in p)o=p[c],h.fromBufferAttribute(y,o.index1),d.push(h.x,h.y,h.z),h.fromBufferAttribute(y,o.index2),d.push(h.x,h.y,h.z)}else for(y=e.attributes.position,t=0,i=y.count/3;t<i;t++)for(n=0;n<3;n++)C=3*t+n,h.fromBufferAttribute(y,C),d.push(h.x,h.y,h.z),I=3*t+(n+1)%3,h.fromBufferAttribute(y,I),d.push(h.x,h.y,h.z)}this.addAttribute("position",new xe(d,3))}function Pt(e,t,n){Oe.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:n},this.fromBufferGeometry(new kt(e,t,n)),this.mergeVertices()}function kt(e,t,n){Te.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:n};var i,r,a=[],o=[],s=[],u=[],c=new l,h=new l,d=new l,f=new l,p=new l,m=t+1;for(i=0;i<=n;i++){var g=i/n;for(r=0;r<=t;r++){var v=r/t;h=e(v,g,h),o.push(h.x,h.y,h.z),v-1e-5>=0?(d=e(v-1e-5,g,d),f.subVectors(h,d)):(d=e(v+1e-5,g,d),f.subVectors(d,h)),g-1e-5>=0?(d=e(v,g-1e-5,d),p.subVectors(h,d)):(d=e(v,g+1e-5,d),p.subVectors(d,h)),c.crossVectors(f,p).normalize(),s.push(c.x,c.y,c.z),u.push(v,g)}}for(i=0;i<n;i++)for(r=0;r<t;r++){var y=i*m+r,E=i*m+r+1,b=(i+1)*m+r+1,x=(i+1)*m+r;a.push(y,E,x),a.push(E,b,x)}this.setIndex(a),this.addAttribute("position",new xe(o,3)),this.addAttribute("normal",new xe(s,3)),this.addAttribute("uv",new xe(u,2))}function Bt(e,t,n,i){Oe.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:n,detail:i},this.fromBufferGeometry(new Ft(e,t,n,i)),this.mergeVertices()}function Ft(e,t,i,r){function a(e,t,n,i){var r,a,o=Math.pow(2,i),l=[];for(r=0;r<=o;r++){l[r]=[];var u=e.clone().lerp(n,r/o),c=t.clone().lerp(n,r/o),h=o-r;for(a=0;a<=h;a++)l[r][a]=0===a&&r===o?u:u.clone().lerp(c,a/h)}for(r=0;r<o;r++)for(a=0;a<2*(o-r)-1;a++){var d=Math.floor(a/2);a%2==0?(s(l[r][d+1]),s(l[r+1][d]),s(l[r][d])):(s(l[r][d+1]),s(l[r+1][d+1]),s(l[r+1][d]))}}function o(){for(var e=0;e<m.length;e+=6){var t=m[e+0],n=m[e+2],i=m[e+4],r=Math.max(t,n,i),a=Math.min(t,n,i);r>.9&&a<.1&&(t<.2&&(m[e+0]+=1),n<.2&&(m[e+2]+=1),i<.2&&(m[e+4]+=1))}}function s(e){p.push(e.x,e.y,e.z)}function u(t,n){var i=3*t;n.x=e[i+0],n.y=e[i+1],n.z=e[i+2]}function c(){for(var e=new l,t=new l,i=new l,r=new l,a=new n,o=new n,s=new n,u=0,c=0;u<p.length;u+=9,c+=6){e.set(p[u+0],p[u+1],p[u+2]),t.set(p[u+3],p[u+4],p[u+5]),i.set(p[u+6],p[u+7],p[u+8]),a.set(m[c+0],m[c+1]),o.set(m[c+2],m[c+3]),s.set(m[c+4],m[c+5]),r.copy(e).add(t).add(i).divideScalar(3);var f=d(r);h(a,c+0,e,f),h(o,c+2,t,f),h(s,c+4,i,f)}}function h(e,t,n,i){i<0&&1===e.x&&(m[t]=e.x-1),0===n.x&&0===n.z&&(m[t]=i/2/Math.PI+.5)}function d(e){return Math.atan2(e.z,-e.x)}function f(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}Te.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:r},i=i||1,r=r||0;var p=[],m=[];!function(e){for(var n=new l,i=new l,r=new l,o=0;o<t.length;o+=3)u(t[o+0],n),u(t[o+1],i),u(t[o+2],r),a(n,i,r,e)}(r),function(e){for(var t=new l,n=0;n<p.length;n+=3)t.x=p[n+0],t.y=p[n+1],t.z=p[n+2],t.normalize().multiplyScalar(e),p[n+0]=t.x,p[n+1]=t.y,p[n+2]=t.z}(i),function(){for(var e=new l,t=0;t<p.length;t+=3){e.x=p[t+0],e.y=p[t+1],e.z=p[t+2];var n=d(e)/2/Math.PI+.5,i=f(e)/Math.PI+.5;m.push(n,1-i)}c(),o()}(),this.addAttribute("position",new xe(p,3)),this.addAttribute("normal",new xe(p.slice(),3)),this.addAttribute("uv",new xe(m,2)),this.normalizeNormals()}function Ht(e,t){Oe.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Gt(e,t)),this.mergeVertices()}function Gt(e,t){var n=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],i=[2,1,0,0,3,2,1,3,0,2,3,1];Ft.call(this,n,i,e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Vt(e,t){Oe.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new zt(e,t)),this.mergeVertices()}function zt(e,t){var n=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],i=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];Ft.call(this,n,i,e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function jt(e,t){Oe.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Wt(e,t)),this.mergeVertices()}function Wt(e,t){var n=(1+Math.sqrt(5))/2,i=[-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],r=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];Ft.call(this,i,r,e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Xt(e,t){Oe.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Yt(e,t)),this.mergeVertices()}function Yt(e,t){var n=(1+Math.sqrt(5))/2,i=1/n,r=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-n,0,-i,n,0,i,-n,0,i,n,-i,-n,0,-i,n,0,i,-n,0,i,n,0,-n,0,-i,n,0,-i,-n,0,i,n,0,i],a=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];Ft.call(this,r,a,e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function qt(e,t,n,i,r,a){Oe.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:n,radialSegments:i,closed:r},void 0!==a&&console.warn("THREE.TubeGeometry: taper has been removed.");var o=new Zt(e,t,n,i,r);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals,this.fromBufferGeometry(o),this.mergeVertices()}function Zt(e,t,i,r,a){function o(n){var a=e.getPointAt(n/t),o=c.normals[n],s=c.binormals[n];for(d=0;d<=r;d++){var l=d/r*Math.PI*2,u=Math.sin(l),h=-Math.cos(l);p.x=h*o.x+u*s.x,p.y=h*o.y+u*s.y,p.z=h*o.z+u*s.z,p.normalize(),v.push(p.x,p.y,p.z),f.x=a.x+i*p.x,f.y=a.y+i*p.y,f.z=a.z+i*p.z,g.push(f.x,f.y,f.z)}}function s(){for(d=1;d<=t;d++)for(h=1;h<=r;h++){var e=(r+1)*(d-1)+(h-1),n=(r+1)*d+(h-1),i=(r+1)*d+h,a=(r+1)*(d-1)+h;E.push(e,n,a),E.push(n,i,a)}}function u(){for(h=0;h<=t;h++)for(d=0;d<=r;d++)m.x=h/t,m.y=d/r,y.push(m.x,m.y)}Te.call(this),this.type="TubeBufferGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:a},t=t||64,i=i||1,r=r||8,a=a||!1;var c=e.computeFrenetFrames(t,a);this.tangents=c.tangents,this.normals=c.normals,this.binormals=c.binormals;var h,d,f=new l,p=new l,m=new n,g=[],v=[],y=[],E=[];!function(){for(h=0;h<t;h++)o(h);o(!1===a?t:0),u(),s()}(),this.setIndex(E),this.addAttribute("position",new xe(g,3)),this.addAttribute("normal",new xe(v,3)),this.addAttribute("uv",new xe(y,2))}function Kt(e,t,n,i,r,a,o){Oe.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:n,radialSegments:i,p:r,q:a},void 0!==o&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new Qt(e,t,n,i,r,a)),this.mergeVertices()}function Qt(e,t,n,i,r,a){function o(e,t,n,i,r){var a=Math.cos(e),o=Math.sin(e),s=n/t*e,l=Math.cos(s);r.x=i*(2+l)*.5*a,r.y=i*(2+l)*o*.5,r.z=i*Math.sin(s)*.5}Te.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:n,radialSegments:i,p:r,q:a},e=e||100,t=t||40,n=Math.floor(n)||64,i=Math.floor(i)||8,r=r||2,a=a||3;var s,u,c=[],h=[],d=[],f=[],p=new l,m=new l,g=new l,v=new l,y=new l,E=new l,b=new l;for(s=0;s<=n;++s){var x=s/n*r*Math.PI*2;for(o(x,r,a,e,g),o(x+.01,r,a,e,v),E.subVectors(v,g),b.addVectors(v,g),y.crossVectors(E,b),b.crossVectors(y,E),y.normalize(),b.normalize(),u=0;u<=i;++u){var M=u/i*Math.PI*2,_=-t*Math.cos(M),C=t*Math.sin(M);p.x=g.x+(_*b.x+C*y.x),p.y=g.y+(_*b.y+C*y.y),p.z=g.z+(_*b.z+C*y.z),h.push(p.x,p.y,p.z),m.subVectors(p,g).normalize(),d.push(m.x,m.y,m.z),f.push(s/n),f.push(u/i)}}for(u=1;u<=n;u++)for(s=1;s<=i;s++){var I=(i+1)*(u-1)+(s-1),O=(i+1)*u+(s-1),T=(i+1)*u+s,L=(i+1)*(u-1)+s;c.push(I,O,L),c.push(O,T,L)}this.setIndex(c),this.addAttribute("position",new xe(h,3)),this.addAttribute("normal",new xe(d,3)),this.addAttribute("uv",new xe(f,2))}function Jt(e,t,n,i,r){Oe.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:n,tubularSegments:i,arc:r},this.fromBufferGeometry(new $t(e,t,n,i,r)),this.mergeVertices()}function $t(e,t,n,i,r){Te.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:n,tubularSegments:i,arc:r},e=e||100,t=t||40,n=Math.floor(n)||8,i=Math.floor(i)||6,r=r||2*Math.PI;var a,o,s=[],u=[],c=[],h=[],d=new l,f=new l,p=new l;for(a=0;a<=n;a++)for(o=0;o<=i;o++){var m=o/i*r,g=a/n*Math.PI*2;f.x=(e+t*Math.cos(g))*Math.cos(m),f.y=(e+t*Math.cos(g))*Math.sin(m),f.z=t*Math.sin(g),u.push(f.x,f.y,f.z),d.x=e*Math.cos(m),d.y=e*Math.sin(m),p.subVectors(f,d).normalize(),c.push(p.x,p.y,p.z),h.push(o/i),h.push(a/n)}for(a=1;a<=n;a++)for(o=1;o<=i;o++){var v=(i+1)*a+o-1,y=(i+1)*(a-1)+o-1,E=(i+1)*(a-1)+o,b=(i+1)*a+o;s.push(v,y,b),s.push(y,E,b)}this.setIndex(s),this.addAttribute("position",new xe(u,3)),this.addAttribute("normal",new xe(c,3)),this.addAttribute("uv",new xe(h,2))}function en(e,t){Oe.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new tn(e,t)),this.mergeVertices()}function tn(e,t){if(void 0===e)return void(e=[]);Te.call(this),this.type="ExtrudeBufferGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),this.computeVertexNormals()}function nn(e,t){Oe.call(this),this.type="TextGeometry",this.parameters={text:e,parameters:t},this.fromBufferGeometry(new rn(e,t)),this.mergeVertices()}function rn(e,t){t=t||{};var n=t.font;if(!1===(n&&n.isFont))return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Oe;var i=n.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),tn.call(this,i,t),this.type="TextBufferGeometry"}function an(e,t,n,i,r,a,o){Oe.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:i,phiLength:r,thetaStart:a,thetaLength:o},this.fromBufferGeometry(new on(e,t,n,i,r,a,o)),this.mergeVertices()}function on(e,t,n,i,r,a,o){Te.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:i,phiLength:r,thetaStart:a,thetaLength:o},e=e||50,t=Math.max(3,Math.floor(t)||8),n=Math.max(2,Math.floor(n)||6),i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI,a=void 0!==a?a:0,o=void 0!==o?o:Math.PI;var s,u,c=a+o,h=0,d=[],f=new l,p=new l,m=[],g=[],v=[],y=[];for(u=0;u<=n;u++){var E=[],b=u/n;for(s=0;s<=t;s++){var x=s/t;f.x=-e*Math.cos(i+x*r)*Math.sin(a+b*o),f.y=e*Math.cos(a+b*o),f.z=e*Math.sin(i+x*r)*Math.sin(a+b*o),g.push(f.x,f.y,f.z),p.set(f.x,f.y,f.z).normalize(),v.push(p.x,p.y,p.z),y.push(x,1-b),E.push(h++)}d.push(E)}for(u=0;u<n;u++)for(s=0;s<t;s++){var M=d[u][s+1],_=d[u][s],C=d[u+1][s],I=d[u+1][s+1];(0!==u||a>0)&&m.push(M,_,I),(u!==n-1||c<Math.PI)&&m.push(_,C,I)}this.setIndex(m),this.addAttribute("position",new xe(g,3)),this.addAttribute("normal",new xe(v,3)),this.addAttribute("uv",new xe(y,2))}function sn(e,t,n,i,r,a){Oe.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:n,phiSegments:i,thetaStart:r,thetaLength:a},this.fromBufferGeometry(new ln(e,t,n,i,r,a)),this.mergeVertices()}function ln(e,t,i,r,a,o){Te.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:r,thetaStart:a,thetaLength:o},e=e||20,t=t||50,a=void 0!==a?a:0,o=void 0!==o?o:2*Math.PI,i=void 0!==i?Math.max(3,i):8,r=void 0!==r?Math.max(1,r):1;var s,u,c,h=[],d=[],f=[],p=[],m=e,g=(t-e)/r,v=new l,y=new n;for(u=0;u<=r;u++){for(c=0;c<=i;c++)s=a+c/i*o,v.x=m*Math.cos(s),v.y=m*Math.sin(s),d.push(v.x,v.y,v.z),f.push(0,0,1),y.x=(v.x/t+1)/2,y.y=(v.y/t+1)/2,p.push(y.x,y.y);m+=g}for(u=0;u<r;u++){var E=u*(i+1);for(c=0;c<i;c++){s=c+E;var b=s,x=s+i+1,M=s+i+2,_=s+1;h.push(b,x,_),h.push(x,M,_)}}this.setIndex(h),this.addAttribute("position",new xe(d,3)),this.addAttribute("normal",new xe(f,3)),this.addAttribute("uv",new xe(p,2))}function un(e,t,n,i){Oe.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:n,phiLength:i},this.fromBufferGeometry(new cn(e,t,n,i)),this.mergeVertices()}function cn(e,t,i,r){Te.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:r},t=Math.floor(t)||12,i=i||0,r=r||2*Math.PI,r=hs.clamp(r,0,2*Math.PI);var a,o,s,u=[],c=[],h=[],d=1/t,f=new l,p=new n;for(o=0;o<=t;o++){var m=i+o*d*r,g=Math.sin(m),v=Math.cos(m);for(s=0;s<=e.length-1;s++)f.x=e[s].x*g,f.y=e[s].y,f.z=e[s].x*v,c.push(f.x,f.y,f.z),p.x=o/t,p.y=s/(e.length-1),h.push(p.x,p.y)}for(o=0;o<t;o++)for(s=0;s<e.length-1;s++){a=s+o*e.length;var y=a,E=a+e.length,b=a+e.length+1,x=a+1;u.push(y,E,x),u.push(E,b,x)}if(this.setIndex(u),this.addAttribute("position",new xe(c,3)),this.addAttribute("uv",new xe(h,2)),this.computeVertexNormals(),r===2*Math.PI){var M=this.attributes.normal.array,_=new l,C=new l,I=new l;for(a=t*e.length*3,o=0,s=0;o<e.length;o++,s+=3)_.x=M[s+0],_.y=M[s+1],_.z=M[s+2],C.x=M[a+s+0],C.y=M[a+s+1],C.z=M[a+s+2],I.addVectors(_,C).normalize(),M[s+0]=M[a+s+0]=I.x,M[s+1]=M[a+s+1]=I.y,M[s+2]=M[a+s+2]=I.z}}function hn(e,t){Oe.call(this),this.type="ShapeGeometry","object"===(void 0===t?"undefined":_typeof(t))&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new dn(e,t)),this.mergeVertices()}function dn(e,t){function n(e){var n,s,u,c=r.length/3,h=e.extractPoints(t),d=h.shape,f=h.holes;if(!1===Ss.isClockWise(d))for(d=d.reverse(),n=0,s=f.length;n<s;n++)u=f[n],!0===Ss.isClockWise(u)&&(f[n]=u.reverse());var p=Ss.triangulateShape(d,f);for(n=0,s=f.length;n<s;n++)u=f[n],d=d.concat(u);for(n=0,s=d.length;n<s;n++){var m=d[n];r.push(m.x,m.y,0),a.push(0,0,1),o.push(m.x,m.y)}for(n=0,s=p.length;n<s;n++){var g=p[n],v=g[0]+c,y=g[1]+c,E=g[2]+c;i.push(v,y,E),l+=3}}Te.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:t},t=t||12;var i=[],r=[],a=[],o=[],s=0,l=0;if(!1===Array.isArray(e))n(e);else for(var u=0;u<e.length;u++)n(e[u]),this.addGroup(s,l,u),s+=l,l=0;this.setIndex(i),this.addAttribute("position",new xe(r,3)),this.addAttribute("normal",new xe(a,3)),this.addAttribute("uv",new xe(o,2))}function fn(e,t){Te.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var n,i,r,a,o=[],s=Math.cos(hs.DEG2RAD*t),l=[0,0],u={},c=["a","b","c"];e.isBufferGeometry?(a=new Oe,a.fromBufferGeometry(e)):a=e.clone(),a.mergeVertices(),a.computeFaceNormals();for(var h=a.vertices,d=a.faces,f=0,p=d.length;f<p;f++)for(var m=d[f],g=0;g<3;g++)n=m[c[g]],i=m[c[(g+1)%3]],l[0]=Math.min(n,i),l[1]=Math.max(n,i),r=l[0]+","+l[1],void 0===u[r]?u[r]={index1:l[0],index2:l[1],face1:f,face2:void 0}:u[r].face2=f;for(r in u){var v=u[r];if(void 0===v.face2||d[v.face1].normal.dot(d[v.face2].normal)<=s){var y=h[v.index1];o.push(y.x,y.y,y.z),y=h[v.index2],o.push(y.x,y.y,y.z)}}this.addAttribute("position",new xe(o,3))}function pn(e,t,n,i,r,a,o,s){Oe.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:i,heightSegments:r,openEnded:a,thetaStart:o,thetaLength:s},this.fromBufferGeometry(new mn(e,t,n,i,r,a,o,s)),this.mergeVertices()}function mn(e,t,i,r,a,o,s,u){function c(i){var a,o,c,v=new n,b=new l,x=0,M=!0===i?e:t,_=!0===i?1:-1;for(o=g,a=1;a<=r;a++)f.push(0,y*_,0),p.push(0,_,0),m.push(.5,.5),g++;for(c=g,a=0;a<=r;a++){var C=a/r,I=C*u+s,O=Math.cos(I),T=Math.sin(I);b.x=M*T,b.y=y*_,b.z=M*O,f.push(b.x,b.y,b.z),p.push(0,_,0),v.x=.5*O+.5,v.y=.5*T*_+.5,m.push(v.x,v.y),g++}for(a=0;a<r;a++){var L=o+a,S=c+a;!0===i?d.push(S,S+1,L):d.push(S+1,S,L),x+=3}h.addGroup(E,x,!0===i?1:2),E+=x}Te.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:r,heightSegments:a,openEnded:o,thetaStart:s,thetaLength:u};var h=this;e=void 0!==e?e:20,t=void 0!==t?t:20,i=void 0!==i?i:100,r=Math.floor(r)||8,a=Math.floor(a)||1,o=void 0!==o&&o,s=void 0!==s?s:0,u=void 0!==u?u:2*Math.PI;var d=[],f=[],p=[],m=[],g=0,v=[],y=i/2,E=0;!function(){var n,o,c=new l,b=new l,x=0,M=(t-e)/i;for(o=0;o<=a;o++){var _=[],C=o/a,I=C*(t-e)+e;for(n=0;n<=r;n++){var O=n/r,T=O*u+s,L=Math.sin(T),S=Math.cos(T);b.x=I*L,b.y=-C*i+y,b.z=I*S,f.push(b.x,b.y,b.z),c.set(L,M,S).normalize(),p.push(c.x,c.y,c.z),m.push(O,1-C),_.push(g++)}v.push(_)}for(n=0;n<r;n++)for(o=0;o<a;o++){var D=v[o][n],w=v[o+1][n],U=v[o+1][n+1],R=v[o][n+1];d.push(D,w,R),d.push(w,U,R),x+=6}h.addGroup(E,x,0),E+=x}(),!1===o&&(e>0&&c(!0),t>0&&c(!1)),this.setIndex(d),this.addAttribute("position",new xe(f,3)),this.addAttribute("normal",new xe(p,3)),this.addAttribute("uv",new xe(m,2))}function gn(e,t,n,i,r,a,o){pn.call(this,0,e,t,n,i,r,a,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:n,heightSegments:i,openEnded:r,thetaStart:a,thetaLength:o}}function vn(e,t,n,i,r,a,o){mn.call(this,0,e,t,n,i,r,a,o),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:n,heightSegments:i,openEnded:r,thetaStart:a,thetaLength:o}}function yn(e,t,n,i){Oe.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:n,thetaLength:i},this.fromBufferGeometry(new En(e,t,n,i)),this.mergeVertices()}function En(e,t,i,r){Te.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:r},e=e||50,t=void 0!==t?Math.max(3,t):8,i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI;var a,o,s=[],u=[],c=[],h=[],d=new l,f=new n;for(u.push(0,0,0),c.push(0,0,1),h.push(.5,.5),o=0,a=3;o<=t;o++,a+=3){var p=i+o/t*r;d.x=e*Math.cos(p),d.y=e*Math.sin(p),u.push(d.x,d.y,d.z),c.push(0,0,1),f.x=(u[a]/e+1)/2,f.y=(u[a+1]/e+1)/2,h.push(f.x,f.y)}for(a=1;a<=t;a++)s.push(a,a+1,0);this.setIndex(s),this.addAttribute("position",new xe(u,3)),this.addAttribute("normal",new xe(c,3)),this.addAttribute("uv",new xe(h,2))}function bn(e){Q.call(this,{uniforms:Ms.merge([xs.lights,{opacity:{value:1}}]),vertexShader:_s.shadow_vert,fragmentShader:_s.shadow_frag}),this.lights=!0,this.transparent=!0,Object.defineProperties(this,{opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}}}),this.setValues(e)}function xn(e){Q.call(this,e),this.type="RawShaderMaterial"}function Mn(e){K.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new X(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new X(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function _n(e){Mn.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function Cn(e){K.call(this),this.type="MeshPhongMaterial",this.color=new X(16777215),this.specular=new X(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new X(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Qa,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function In(e){Cn.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function On(e){K.call(this,e),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Tn(e){K.call(this),this.type="MeshLambertMaterial",this.color=new X(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new X(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Qa,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Ln(e){K.call(this),this.type="LineDashedMaterial",this.color=new X(16777215),this.linewidth=1,this.scale=1,this.dashSize=3,this.gapSize=1,this.lights=!1,this.setValues(e)}function Sn(e,t,n){var i=this,r=!1,a=0,o=0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=n,this.itemStart=function(e){o++,!1===r&&void 0!==i.onStart&&i.onStart(e,a,o),r=!0},this.itemEnd=function(e){a++,void 0!==i.onProgress&&i.onProgress(e,a,o),a===o&&(r=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)}}function Dn(e){this.manager=void 0!==e?e:Rs}function wn(e){this.manager=void 0!==e?e:Rs,this._parser=null}function Un(e){this.manager=void 0!==e?e:Rs,this._parser=null}function Rn(e){this.manager=void 0!==e?e:Rs}function An(e){this.manager=void 0!==e?e:Rs}function Nn(e){this.manager=void 0!==e?e:Rs}function Pn(e,t){le.call(this),this.type="Light",this.color=new X(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function kn(e,t,n){Pn.call(this,e,n),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(le.DefaultUp),this.updateMatrix(),this.groundColor=new X(t)}function Bn(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new n(512,512),this.map=null,this.matrix=new u}function Fn(){Bn.call(this,new Ae(50,1,.5,500))}function Hn(e,t,n,i,r,a){Pn.call(this,e,t),this.type="SpotLight",this.position.copy(le.DefaultUp),this.updateMatrix(),this.target=new le,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==n?n:0,this.angle=void 0!==i?i:Math.PI/3,this.penumbra=void 0!==r?r:0,this.decay=void 0!==a?a:1,this.shadow=new Fn}function Gn(e,t,n,i){Pn.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==n?n:0,this.decay=void 0!==i?i:1,this.shadow=new Bn(new Ae(90,1,.5,500))}function Vn(){Bn.call(this,new Ne(-5,5,5,-5,.5,500))}function zn(e,t){Pn.call(this,e,t),this.type="DirectionalLight",this.position.copy(le.DefaultUp),this.updateMatrix(),this.target=new le,this.shadow=new Vn}function jn(e,t){Pn.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function Wn(e,t,n,i){Pn.call(this,e,t),this.type="RectAreaLight",this.position.set(0,1,0),this.updateMatrix(),this.width=void 0!==n?n:10,this.height=void 0!==i?i:10}function Xn(e,t,n,i){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new t.constructor(n),this.sampleValues=t,this.valueSize=n}function Yn(e,t,n,i){Xn.call(this,e,t,n,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function qn(e,t,n,i){Xn.call(this,e,t,n,i)}function Zn(e,t,n,i){Xn.call(this,e,t,n,i)}function Kn(e,t,n,i){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=As.convertArray(t,this.TimeBufferType),this.values=As.convertArray(n,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation),this.validate(),this.optimize()}function Qn(e,t,n,i){Kn.call(this,e,t,n,i)}function Jn(e,t,n,i){Xn.call(this,e,t,n,i)}function $n(e,t,n,i){Kn.call(this,e,t,n,i)}function ei(e,t,n,i){Kn.call(this,e,t,n,i)}function ti(e,t,n,i){Kn.call(this,e,t,n,i)}function ni(e,t,n){Kn.call(this,e,t,n)}function ii(e,t,n,i){Kn.call(this,e,t,n,i)}function ri(e,t,n,i){Kn.apply(this,arguments)}function ai(e,t,n){this.name=e,this.tracks=n,this.duration=void 0!==t?t:-1,this.uuid=hs.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function oi(e){this.manager=void 0!==e?e:Rs,this.textures={}}function si(e){this.manager=void 0!==e?e:Rs}function li(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function ui(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:Rs,this.withCredentials=!1}function ci(e){this.manager=void 0!==e?e:Rs,this.texturePath=""}function hi(e,t,n,i,r){var a=.5*(i-t),o=.5*(r-n),s=e*e;return(2*n-2*i+a+o)*(e*s)+(-3*n+3*i-2*a-o)*s+a*e+n}function di(e,t){var n=1-e;return n*n*t}function fi(e,t){return 2*(1-e)*e*t}function pi(e,t){return e*e*t}function mi(e,t,n,i){return di(e,t)+fi(e,n)+pi(e,i)}function gi(e,t){var n=1-e;return n*n*n*t}function vi(e,t){var n=1-e;return 3*n*n*e*t}function yi(e,t){return 3*(1-e)*e*e*t}function Ei(e,t){return e*e*e*t}function bi(e,t,n,i,r){return gi(e,t)+vi(e,n)+yi(e,i)+Ei(e,r)}function xi(){this.arcLengthDivisions=200}function Mi(e,t){xi.call(this),this.v1=e,this.v2=t}function _i(){xi.call(this),this.curves=[],this.autoClose=!1}function Ci(e,t,n,i,r,a,o,s){xi.call(this),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=i,this.aStartAngle=r,this.aEndAngle=a,this.aClockwise=o,this.aRotation=s||0}function Ii(e){xi.call(this),this.points=void 0===e?[]:e}function Oi(e,t,n,i){xi.call(this),this.v0=e,this.v1=t,this.v2=n,this.v3=i}function Ti(e,t,n){xi.call(this),this.v0=e,this.v1=t,this.v2=n}function Li(e){_i.call(this),this.currentPoint=new n,e&&this.fromPoints(e)}function Si(){Li.apply(this,arguments),this.holes=[]}function Di(){this.subPaths=[],this.currentPath=null}function wi(e){this.data=e}function Ui(e){this.manager=void 0!==e?e:Rs}function Ri(e){this.manager=void 0!==e?e:Rs}function Ai(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Ae,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Ae,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function Ni(e,t,n){le.call(this),this.type="CubeCamera";var i=new Ae(90,1,e,t);i.up.set(0,-1,0),i.lookAt(new l(1,0,0)),this.add(i);var r=new Ae(90,1,e,t);r.up.set(0,-1,0),r.lookAt(new l(-1,0,0)),this.add(r);var a=new Ae(90,1,e,t);a.up.set(0,0,1),a.lookAt(new l(0,1,0)),this.add(a);var s=new Ae(90,1,e,t);s.up.set(0,0,-1),s.lookAt(new l(0,-1,0)),this.add(s);var u=new Ae(90,1,e,t);u.up.set(0,-1,0),u.lookAt(new l(0,0,1)),this.add(u);var c=new Ae(90,1,e,t);c.up.set(0,-1,0),c.lookAt(new l(0,0,-1)),this.add(c);var h={format:No,magFilter:Eo,minFilter:Eo};this.renderTarget=new o(n,n,h),this.renderTarget.texture.name="CubeCamera",this.updateCubeMap=function(e,t){null===this.parent&&this.updateMatrixWorld();var n=this.renderTarget,o=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,n.activeCubeFace=0,e.render(t,i,n),n.activeCubeFace=1,e.render(t,r,n),n.activeCubeFace=2,e.render(t,a,n),n.activeCubeFace=3,e.render(t,s,n),n.activeCubeFace=4,e.render(t,u,n),n.texture.generateMipmaps=o,n.activeCubeFace=5,e.render(t,c,n),e.setRenderTarget(null)}}function Pi(e){Ae.call(this),this.enabled=!1,this.cameras=e||[]}function ki(){le.call(this),this.type="AudioListener",this.context=Vs.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function Bi(e){le.call(this),this.type="Audio",this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function Fi(e){Bi.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function Hi(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function Gi(e,t,n){this.binding=e,this.valueSize=n;var i,r=Float64Array;switch(t){case"quaternion":i=this._slerp;break;case"string":
case"bool":r=Array,i=this._select;break;default:i=this._lerp}this.buffer=new r(4*n),this._mixBufferRegion=i,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function Vi(e,t,n){var i=n||zi.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,i)}function zi(e,t,n){this.path=t,this.parsedPath=n||zi.parseTrackName(t),this.node=zi.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function ji(e){this.uuid=hs.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var n=0,i=arguments.length;n!==i;++n)t[arguments[n].uuid]=n;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var r=this;this.stats={objects:{get total(){return r._objects.length},get inUse(){return this.total-r.nCachedObjects_}},get bindingsPerObject(){return r._bindings.length}}}function Wi(e,t,n){this._mixer=e,this._clip=t,this._localRoot=n||null;for(var i=t.tracks,r=i.length,a=new Array(r),o={endingStart:Jo,endingEnd:Jo},s=0;s!==r;++s){var l=i[s].createInterpolant(null);a[s]=l,l.settings=o}this._interpolantSettings=o,this._interpolants=a,this._propertyBindings=new Array(r),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=Qo,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function Xi(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Yi(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function qi(){Te.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function Zi(e,t,n,i){this.uuid=hs.generateUUID(),this.data=e,this.itemSize=t,this.offset=n,this.normalized=!0===i}function Ki(e,t){this.uuid=hs.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function Qi(e,t,n){Ki.call(this,e,t),this.meshPerAttribute=n||1}function Ji(e,t,n){fe.call(this,e,t),this.meshPerAttribute=n||1}function $i(e,t,n,i){this.ray=new ae(e,t),this.near=n||0,this.far=i||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function er(e,t){return e.distance-t.distance}function tr(e,t,n,i){if(!1!==e.visible&&(e.raycast(t,n),!0===i))for(var r=e.children,a=0,o=r.length;a<o;a++)tr(r[a],t,n,!0)}function nr(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function ir(e,t,n){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==n?n:0,this}function rr(e,t,n){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==n?n:0,this}function ar(e,t){Le.call(this,e,t),this.animationsMap={},this.animationsList=[];var n=this.geometry.morphTargets.length,i=n-1,r=n/1;this.createAnimation("__default",0,i,r),this.setAnimationWeight("__default",1)}function or(e){le.call(this),this.material=e,this.render=function(e){}}function sr(e,t,n,i){this.object=e,this.size=void 0!==t?t:1;var r=void 0!==n?n:16711680,a=void 0!==i?i:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=3*s.faces.length:s&&s.isBufferGeometry&&(o=s.attributes.normal.count);var l=new Te,u=new xe(2*o*3,3);l.addAttribute("position",u),Ot.call(this,l,new Ct({color:r,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function lr(e){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;for(var t=new Te,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],i=0,r=1;i<32;i++,r++){var a=i/32*Math.PI*2,o=r/32*Math.PI*2;n.push(Math.cos(a),Math.sin(a),1,Math.cos(o),Math.sin(o),1)}t.addAttribute("position",new xe(n,3));var s=new Ct({fog:!1});this.cone=new Ot(t,s),this.add(this.cone),this.update()}function ur(e){this.bones=this.getBoneList(e);for(var t=new Te,n=[],i=[],r=new X(0,0,1),a=new X(0,1,0),o=0;o<this.bones.length;o++){var s=this.bones[o];s.parent&&s.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),i.push(r.r,r.g,r.b),i.push(a.r,a.g,a.b))}t.addAttribute("position",new xe(n,3)),t.addAttribute("color",new xe(i,3));var l=new Ct({vertexColors:ba,depthTest:!1,depthWrite:!1,transparent:!0});Ot.call(this,t,l),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function cr(e,t){this.light=e,this.light.updateMatrixWorld();var n=new on(t,4,2),i=new de({wireframe:!0,fog:!1});i.color.copy(this.light.color),Le.call(this,n,i),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1}function hr(e){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;var t=new Ct({color:e.color}),n=new Te;n.addAttribute("position",new fe(new Float32Array(15),3)),this.add(new It(n,t)),this.update()}function dr(e,t){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;var n=new zt(t);n.rotateY(.5*Math.PI);var i=new de({vertexColors:ba,wireframe:!0}),r=n.getAttribute("position"),a=new Float32Array(3*r.count);n.addAttribute("color",new fe(a,3)),this.add(new Le(n,i)),this.update()}function fr(e,t,n,i){e=e||10,t=t||10,n=new X(void 0!==n?n:4473924),i=new X(void 0!==i?i:8947848);for(var r=t/2,a=e/t,o=e/2,s=[],l=[],u=0,c=0,h=-o;u<=t;u++,h+=a){s.push(-o,0,h,o,0,h),s.push(h,0,-o,h,0,o);var d=u===r?n:i;d.toArray(l,c),c+=3,d.toArray(l,c),c+=3,d.toArray(l,c),c+=3,d.toArray(l,c),c+=3}var f=new Te;f.addAttribute("position",new xe(s,3)),f.addAttribute("color",new xe(l,3));var p=new Ct({vertexColors:ba});Ot.call(this,f,p)}function pr(e,t,n,i,r,a){e=e||10,t=t||16,n=n||8,i=i||64,r=new X(void 0!==r?r:4473924),a=new X(void 0!==a?a:8947848);var o,s,l,u,c,h,d,f=[],p=[];for(u=0;u<=t;u++)l=u/t*(2*Math.PI),o=Math.sin(l)*e,s=Math.cos(l)*e,f.push(0,0,0),f.push(o,0,s),d=1&u?r:a,p.push(d.r,d.g,d.b),p.push(d.r,d.g,d.b);for(u=0;u<=n;u++)for(d=1&u?r:a,h=e-e/n*u,c=0;c<i;c++)l=c/i*(2*Math.PI),o=Math.sin(l)*h,s=Math.cos(l)*h,f.push(o,0,s),p.push(d.r,d.g,d.b),l=(c+1)/i*(2*Math.PI),o=Math.sin(l)*h,s=Math.cos(l)*h,f.push(o,0,s),p.push(d.r,d.g,d.b);var m=new Te;m.addAttribute("position",new xe(f,3)),m.addAttribute("color",new xe(p,3));var g=new Ct({vertexColors:ba});Ot.call(this,m,g)}function mr(e,t,n,i){this.object=e,this.size=void 0!==t?t:1;var r=void 0!==n?n:16776960,a=void 0!==i?i:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var l=new Te,u=new xe(2*o*3,3);l.addAttribute("position",u),Ot.call(this,l,new Ct({color:r,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function gr(e,t){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,void 0===t&&(t=1);var n=new Te;n.addAttribute("position",new xe([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var i=new Ct({fog:!1});this.add(new It(n,i)),n=new Te,n.addAttribute("position",new xe([0,0,0,0,0,1],3)),this.add(new It(n,i)),this.update()}function vr(e){function t(e,t,i){n(e,i),n(t,i)}function n(e,t){a.push(0,0,0),o.push(t.r,t.g,t.b),void 0===s[e]&&(s[e]=[]),s[e].push(a.length/3-1)}var i=new Te,r=new Ct({color:16777215,vertexColors:Ea}),a=[],o=[],s={},l=new X(16755200),u=new X(16711680),c=new X(43775),h=new X(16777215),d=new X(3355443);t("n1","n2",l),t("n2","n4",l),t("n4","n3",l),t("n3","n1",l),t("f1","f2",l),t("f2","f4",l),t("f4","f3",l),t("f3","f1",l),t("n1","f1",l),t("n2","f2",l),t("n3","f3",l),t("n4","f4",l),t("p","n1",u),t("p","n2",u),t("p","n3",u),t("p","n4",u),t("u1","u2",c),t("u2","u3",c),t("u3","u1",c),t("c","t",h),t("p","c",d),t("cn1","cn2",d),t("cn3","cn4",d),t("cf1","cf2",d),t("cf3","cf4",d),i.addAttribute("position",new xe(a,3)),i.addAttribute("color",new xe(o,3)),Ot.call(this,i,r),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=s,this.update()}function yr(e,t){this.object=e,void 0===t&&(t=16776960);var n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array(24),r=new Te;r.setIndex(new fe(n,1)),r.addAttribute("position",new fe(i,3)),Ot.call(this,r,new Ct({color:t})),this.matrixAutoUpdate=!1,this.update()}function Er(e,t,n,i,r,a){le.call(this),void 0===i&&(i=16776960),void 0===n&&(n=1),void 0===r&&(r=.2*n),void 0===a&&(a=.2*r),void 0===zs&&(zs=new Te,zs.addAttribute("position",new xe([0,0,0,0,1,0],3)),js=new mn(0,.5,1,5,1),js.translate(0,-.5,0)),this.position.copy(t),this.line=new It(zs,new Ct({color:i})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Le(js,new de({color:i})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(n,r,a)}function br(e){e=e||1;var t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],n=[1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],i=new Te;i.addAttribute("position",new xe(t,3)),i.addAttribute("color",new xe(n,3));var r=new Ct({vertexColors:ba});Ot.call(this,i,r)}function xr(){function e(e,a,o,s){t=e,n=o,i=-3*e+3*a-2*o-s,r=2*e-2*a+o+s}var t=0,n=0,i=0,r=0;return{initCatmullRom:function(t,n,i,r,a){e(n,i,a*(i-t),a*(r-n))},initNonuniformCatmullRom:function(t,n,i,r,a,o,s){var l=(n-t)/a-(i-t)/(a+o)+(i-n)/o,u=(i-n)/o-(r-n)/(o+s)+(r-i)/s;l*=o,u*=o,e(n,i,l,u)},calc:function(e){var a=e*e;return t+n*e+i*a+r*(a*e)}}}function Mr(e){xi.call(this),this.points=e||[],this.closed=!1}function _r(e,t,n,i){xi.call(this),this.v0=e,this.v1=t,this.v2=n,this.v3=i}function Cr(e,t,n){xi.call(this),this.v0=e,this.v1=t,this.v2=n}function Ir(e,t){xi.call(this),this.v1=e,this.v2=t}function Or(e,t,n,i,r,a){Ci.call(this,e,t,n,n,i,r,a)}function Tr(e,t,n,i,r,a,o){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new he(e,t,n,r,a,o)}function Lr(e){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),e}function Sr(e){return void 0===e&&(e=[]),console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,e.materials=e,e.clone=function(){return e.slice()},e}function Dr(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new St(e,t)}function wr(e){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new Et(e)}function Ur(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new St(e,t)}function Rr(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new Lt(e)}function Ar(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new Lt(e)}function Nr(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new Lt(e)}function Pr(e,t,n){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new l(e,t,n)}function kr(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new fe(e,t).setDynamic(!0)}function Br(e,t){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new pe(e,t)}function Fr(e,t){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new me(e,t)}function Hr(e,t){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new ge(e,t)}function Gr(e,t){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new ve(e,t)}function Vr(e,t){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new ye(e,t)}function zr(e,t){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new Ee(e,t)}function jr(e,t){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new be(e,t)}function Wr(e,t){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new xe(e,t)}function Xr(e,t){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new Me(e,t)}function Yr(e){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Mr.call(this,e),this.type="catmullrom",this.closed=!0}function qr(e){console.warn("THREE.SplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Mr.call(this,e),this.type="catmullrom"}function Zr(e){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),Mr.call(this,e),this.type="catmullrom"}function Kr(e,t){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new yr(e,t)}function Qr(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new Ot(new fn(e.geometry),new Ct({color:void 0!==t?t:16777215}))}function Jr(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new Ot(new Nt(e.geometry),new Ct({color:void 0!==t?t:16777215}))}function $r(e){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new Dn(e)}function ea(e){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new Un(e)}function ta(){console.error("THREE.Projector has been moved to /examples/js/renderers/Projector.js."),this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")}}function na(){console.error("THREE.CanvasRenderer has been moved to /examples/js/renderers/CanvasRenderer.js"),this.domElement=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}}function ia(e,t,n,i){function r(e,i){null!==i.index&&t.remove(i.index);for(var r in i.attributes)t.remove(i.attributes[r]);var a=u[e];a&&(t.remove(a),delete u[e]),a=u[i.id],a&&(t.remove(a),delete u[i.id]),n.geometries--}function a(e,t){var i=t.id;if(l.has(i))return l.get(i);var r;return t.isBufferGeometry?r=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Te).setFromObject(e)),r=t._bufferGeometry),l.set(i,r),n.geometries++,r}function o(n){var i=n.index,r=n.attributes;null!==i&&t.update(i,e.ELEMENT_ARRAY_BUFFER);for(var a in r)t.update(r[a],e.ARRAY_BUFFER);var o=n.morphAttributes;for(var a in o)for(var s=o[a],l=0,u=s.length;l<u;l++)t.update(s[l],e.ARRAY_BUFFER)}function s(n){var i=u[n.id];if(i)return i;var r=[],a=n.index,o=n.attributes;if(null!==a)for(var s=a.array,l=0,c=s.length;l<c;l+=3){var h=s[l+0],d=s[l+1],f=s[l+2];r.push(h,d,d,f,f,h)}else for(var s=o.position.array,l=0,c=s.length/3-1;l<c;l+=3){var h=l+0,d=l+1,f=l+2;r.push(h,d,d,f,f,h)}return i=new(Ce(r)>65535?be:ye)(r,1),t.update(i,e.ELEMENT_ARRAY_BUFFER),u[n.id]=i,i}var l=new LRUMap(i),u={};return l.shift=function(){var e=LRUMap.prototype.shift.call(this);r(e[0],e[1])},{get:a,update:o,getWireframeAttribute:s}}function ra(e){function t(){return null===J?fe:1}function n(){Ae.init(),Ae.scissor(ae.copy(pe).multiplyScalar(fe)),Ae.viewport(se.copy(ge).multiplyScalar(fe)),Ae.buffers.color.setClear(ue.r,ue.g,ue.b,ce,B)}function i(){Q=null,ne=null,te="",ee=-1,Ae.reset()}function a(e){e.preventDefault(),i(),n(),Ne.clear(),Fe.clear()}function o(e){var t=e.target;t.removeEventListener("dispose",o),s(t)}function s(e){h(e),Ne.remove(e)}function h(e){var t=Ne.get(e).program;e.program=void 0,void 0!==t&&Xe.releaseProgram(t)}function d(e,t){return Math.abs(t[0])-Math.abs(e[0])}function f(e,t,n,i){if(n&&n.isInstancedBufferGeometry&&null===we.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===i&&(i=0),Ae.initAttributes();var r=n.attributes,a=t.getAttributes(),o=e.defaultAttributeValues;for(var s in a){var l=a[s];if(l>=0){var u=r[s];if(void 0!==u){var c=u.normalized,h=u.itemSize,d=Be.get(u),f=d.buffer,p=d.type,m=d.bytesPerElement;if(u.isInterleavedBufferAttribute){var g=u.data,v=g.stride,y=u.offset;g&&g.isInstancedInterleavedBuffer?(Ae.enableAttributeAndDivisor(l,g.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=g.meshPerAttribute*g.count)):Ae.enableAttribute(l),Se.bindBuffer(Se.ARRAY_BUFFER,f),Se.vertexAttribPointer(l,h,p,c,v*m,(i*v+y)*m)}else u.isInstancedBufferAttribute?(Ae.enableAttributeAndDivisor(l,u.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=u.meshPerAttribute*u.count)):Ae.enableAttribute(l),Se.bindBuffer(Se.ARRAY_BUFFER,f),Se.vertexAttribPointer(l,h,p,c,0,i*h*m)}else if(void 0!==o){var E=o[s];if(void 0!==E)switch(E.length){case 2:Se.vertexAttrib2fv(l,E);break;case 3:Se.vertexAttrib3fv(l,E);break;case 4:Se.vertexAttrib4fv(l,E);break;default:Se.vertexAttrib1fv(l,E)}}}}Ae.disableUnusedAttributes()}function p(e,t,n){var i=Ne.get(e),r=Xe.getParameters(e,Ie,t,ye.numPlanes,ye.numIntersection,n),a=Xe.getProgramCode(e,r),s=i.program,l=!0;if(void 0===s)e.addEventListener("dispose",o);else if(s.code!==a)h(e);else{if(void 0!==r.shaderID)return;l=!1}if(l){if(r.shaderID){var u=Cs[r.shaderID];i.__webglShader={name:e.type,uniforms:Ms.clone(u.uniforms),vertexShader:u.vertexShader,fragmentShader:u.fragmentShader}}else i.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=i.__webglShader,s=Xe.acquireProgram(e,r,a),i.program=s,e.program=s}var c=s.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var d=0;d<K.maxMorphTargets;d++)c["morphTarget"+d]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(var d=0;d<K.maxMorphNormals;d++)c["morphNormal"+d]>=0&&e.numSupportedMorphNormals++}var f=i.__webglShader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(i.numClippingPlanes=ye.numPlanes,i.numIntersection=ye.numIntersection,f.clippingPlanes=ye.uniform),i.fog=t,i.lightsHash=Ie.hash,e.lights&&(f.ambientLightColor.value=Ie.ambient,f.directionalLights.value=Ie.directional,f.spotLights.value=Ie.spot,f.rectAreaLights.value=Ie.rectArea,f.pointLights.value=Ie.point,f.hemisphereLights.value=Ie.hemi,f.directionalShadowMap.value=Ie.directionalShadowMap,f.directionalShadowMatrix.value=Ie.directionalShadowMatrix,f.spotShadowMap.value=Ie.spotShadowMap,f.spotShadowMatrix.value=Ie.spotShadowMatrix,f.pointShadowMap.value=Ie.pointShadowMap,f.pointShadowMatrix.value=Ie.pointShadowMatrix);var p=i.program.getUniforms(),m=W.seqWithValue(p.seq,f);i.uniformsList=m}function m(e,t,n,i){le=0;var r=Ne.get(n);if(Ee&&(be||e!==ne)){var a=e===ne&&n.id===ee;ye.setState(n.clippingPlanes,n.clipIntersection,n.clipShadows,e,r,a)}!1===n.needsUpdate&&(void 0===r.program?n.needsUpdate=!0:n.fog&&r.fog!==t?n.needsUpdate=!0:n.lights&&r.lightsHash!==Ie.hash?n.needsUpdate=!0:void 0===r.numClippingPlanes||r.numClippingPlanes===ye.numPlanes&&r.numIntersection===ye.numIntersection||(n.needsUpdate=!0)),n.needsUpdate&&(p(n,t,i),n.needsUpdate=!1);var o=!1,s=!1,l=!1,u=r.program,h=u.getUniforms(),d=r.__webglShader.uniforms;if(u.id!==Q&&(Se.useProgram(u.program),Q=u.id,o=!0,s=!0,l=!0),n.id!==ee&&(ee=n.id,s=!0),o||e!==ne){if(h.setValue(Se,"projectionMatrix",e.projectionMatrix),Re.logarithmicDepthBuffer&&h.setValue(Se,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),e!==ne&&(ne=e,s=!0,l=!0),n.isShaderMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.envMap){var f=h.map.cameraPosition;void 0!==f&&f.setValue(Se,Me.setFromMatrixPosition(e.matrixWorld))}(n.isMeshPhongMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial||n.skinning)&&h.setValue(Se,"viewMatrix",e.matrixWorldInverse),h.setValue(Se,"toneMappingExposure",K.toneMappingExposure),h.setValue(Se,"toneMappingWhitePoint",K.toneMappingWhitePoint)}if(n.skinning){h.setOptional(Se,i,"bindMatrix"),h.setOptional(Se,i,"bindMatrixInverse");var m=i.skeleton;if(m){var L=m.bones;if(Re.floatVertexTextures){if(void 0===m.boneTexture){var S=Math.sqrt(4*L.length);S=hs.nextPowerOfTwo(Math.ceil(S)),S=Math.max(S,4);var D=new Float32Array(S*S*4);D.set(m.boneMatrices);var w=new c(D,S,S,Po,Lo);m.boneMatrices=D,m.boneTexture=w,m.boneTextureSize=S}h.setValue(Se,"boneTexture",m.boneTexture),h.setValue(Se,"boneTextureSize",m.boneTextureSize)}else h.setOptional(Se,m,"boneMatrices")}}if(s&&(n.lights&&T(d,l),t&&n.fog&&b(d,t),(n.isMeshBasicMaterial||n.isMeshLambertMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.isMeshNormalMaterial||n.isMeshDepthMaterial)&&g(d,n),n.isLineBasicMaterial?v(d,n):n.isLineDashedMaterial?(v(d,n),y(d,n)):n.isPointsMaterial?E(d,n):n.isMeshLambertMaterial?x(d,n):n.isMeshToonMaterial?_(d,n):n.isMeshPhongMaterial?M(d,n):n.isMeshPhysicalMaterial?I(d,n):n.isMeshStandardMaterial?C(d,n):n.isMeshDepthMaterial?n.displacementMap&&(d.displacementMap.value=n.displacementMap,d.displacementScale.value=n.displacementScale,d.displacementBias.value=n.displacementBias):n.isMeshNormalMaterial&&O(d,n),void 0!==d.ltcMat&&(d.ltcMat.value=xs.LTC_MAT_TEXTURE),void 0!==d.ltcMag&&(d.ltcMag.value=xs.LTC_MAG_TEXTURE),W.upload(Se,r.uniformsList,d,K)),h.map.objId){var U=i.originalId;Y.set((U>>16&255)/255,(U>>8&255)/255,(255&U)/255),h.setValue(Se,"objId",Y)}return h.setValue(Se,"modelViewMatrix",i.modelViewMatrix),h.setValue(Se,"normalMatrix",i.normalMatrix),h.setValue(Se,"modelMatrix",i.matrixWorld),u}function g(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var n;if(t.map?n=t.map:t.specularMap?n=t.specularMap:t.displacementMap?n=t.displacementMap:t.normalMap?n=t.normalMap:t.bumpMap?n=t.bumpMap:t.roughnessMap?n=t.roughnessMap:t.metalnessMap?n=t.metalnessMap:t.alphaMap?n=t.alphaMap:t.emissiveMap&&(n=t.emissiveMap),void 0!==n){n.isWebGLRenderTarget&&(n=n.texture);var i=n.offset,r=n.repeat;e.offsetRepeat.value.set(i.x,i.y,r.x,r.y),e.rotateMatrix.value.copy(n.rotateMatrix)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function v(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function y(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function E(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*fe,e.scale.value=.5*de,e.map.value=t.map,null!==t.map){var n=t.map.offset,i=t.map.repeat;e.offsetRepeat.value.set(n.x,n.y,i.x,i.y)}}function b(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function x(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function M(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function _(e,t){M(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}function C(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function I(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,C(e,t)}function O(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function T(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}function L(e){for(var t=0,n=0,i=e.length;n<i;n++){var r=e[n];r.castShadow&&(Ie.shadows[t]=r,t++)}Ie.shadows.length=t}function S(e,t){var n,i,r,a,o,s,l,u,c=0,h=0,d=0,f=t.matrixWorldInverse,p=0,m=0,g=0,v=0,y=0;for(n=0,i=e.length;n<i;n++)if(r=e[n],o=r.color,s=r.intensity,l=r.distance,u=r.shadow&&r.shadow.map?r.shadow.map.texture:null,r.isAmbientLight)c+=o.r*s,h+=o.g*s,d+=o.b*s;else if(r.isDirectionalLight){var E=Ye.get(r);E.color.copy(r.color).multiplyScalar(r.intensity),E.direction.setFromMatrixPosition(r.matrixWorld),Me.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(Me),E.direction.transformDirection(f),E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),Ie.directionalShadowMap[p]=u,Ie.directionalShadowMatrix[p]=r.shadow.matrix,Ie.directional[p]=E,p++}else if(r.isSpotLight){var E=Ye.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(o).multiplyScalar(s),E.distance=l,E.direction.setFromMatrixPosition(r.matrixWorld),Me.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(Me),E.direction.transformDirection(f),E.coneCos=Math.cos(r.angle),E.penumbraCos=Math.cos(r.angle*(1-r.penumbra)),E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),Ie.spotShadowMap[g]=u,Ie.spotShadowMatrix[g]=r.shadow.matrix,Ie.spot[g]=E,g++}else if(r.isRectAreaLight){var E=Ye.get(r);E.color.copy(o).multiplyScalar(s/(r.width*r.height)),E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),Ce.identity(),_e.copy(r.matrixWorld),_e.premultiply(f),Ce.extractRotation(_e),E.halfWidth.set(.5*r.width,0,0),E.halfHeight.set(0,.5*r.height,0),E.halfWidth.applyMatrix4(Ce),E.halfHeight.applyMatrix4(Ce),Ie.rectArea[v]=E,v++}else if(r.isPointLight){var E=Ye.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(r.color).multiplyScalar(r.intensity),E.distance=r.distance,E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),Ie.pointShadowMap[m]=u,Ie.pointShadowMatrix[m]=r.shadow.matrix,Ie.point[m]=E,m++}else if(r.isHemisphereLight){var E=Ye.get(r);E.direction.setFromMatrixPosition(r.matrixWorld),E.direction.transformDirection(f),E.direction.normalize(),E.skyColor.copy(r.color).multiplyScalar(s),E.groundColor.copy(r.groundColor).multiplyScalar(s),Ie.hemi[y]=E,y++}Ie.ambient[0]=c,Ie.ambient[1]=h,Ie.ambient[2]=d,Ie.directional.length=p,Ie.spot.length=g,Ie.rectArea.length=v,Ie.point.length=m,Ie.hemi.length=y,Ie.hash=p+","+m+","+g+","+v+","+y+","+Ie.shadows.length}function D(){var e=le;return e>=Re.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+Re.maxTextures),le+=1,e}function w(e){var t;if(e===fo)return Se.REPEAT;if(e===po)return Se.CLAMP_TO_EDGE;if(e===mo)return Se.MIRRORED_REPEAT;if(e===go)return Se.NEAREST;if(e===vo)return Se.NEAREST_MIPMAP_NEAREST;if(e===yo)return Se.NEAREST_MIPMAP_LINEAR;if(e===Eo)return Se.LINEAR;if(e===bo)return Se.LINEAR_MIPMAP_NEAREST;if(e===xo)return Se.LINEAR_MIPMAP_LINEAR;if(e===Mo)return Se.UNSIGNED_BYTE;if(e===Do)return Se.UNSIGNED_SHORT_4_4_4_4;if(e===wo)return Se.UNSIGNED_SHORT_5_5_5_1;if(e===Uo)return Se.UNSIGNED_SHORT_5_6_5;if(e===_o)return Se.BYTE;if(e===Co)return Se.SHORT;if(e===Io)return Se.UNSIGNED_SHORT;if(e===Oo)return Se.INT;if(e===To)return Se.UNSIGNED_INT;if(e===Lo)return Se.FLOAT;if(e===So&&null!==(t=we.get("OES_texture_half_float")))return t.HALF_FLOAT_OES;if(e===Ao)return Se.ALPHA;if(e===No)return Se.RGB;if(e===Po)return Se.RGBA;if(e===ko)return Se.LUMINANCE;if(e===Bo)return Se.LUMINANCE_ALPHA;if(e===Ho)return Se.DEPTH_COMPONENT;if(e===Go)return Se.DEPTH_STENCIL;if(e===Ta)return Se.FUNC_ADD;if(e===La)return Se.FUNC_SUBTRACT;if(e===Sa)return Se.FUNC_REVERSE_SUBTRACT;if(e===Ua)return Se.ZERO;if(e===Ra)return Se.ONE;if(e===Aa)return Se.SRC_COLOR;if(e===Na)return Se.ONE_MINUS_SRC_COLOR;if(e===Pa)return Se.SRC_ALPHA;if(e===ka)return Se.ONE_MINUS_SRC_ALPHA;if(e===Ba)return Se.DST_ALPHA;if(e===Fa)return Se.ONE_MINUS_DST_ALPHA;if(e===Ha)return Se.DST_COLOR;if(e===Ga)return Se.ONE_MINUS_DST_COLOR;if(e===Va)return Se.SRC_ALPHA_SATURATE;if((e===Vo||e===zo||e===jo||e===Wo)&&null!==(t=we.get("WEBGL_compressed_texture_s3tc"))){if(e===Vo)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===zo)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===jo)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===Wo)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===Xo||e===Yo||e===qo||e===Zo)&&null!==(t=we.get("WEBGL_compressed_texture_pvrtc"))){if(e===Xo)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Yo)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===qo)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Zo)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ko&&null!==(t=we.get("WEBGL_compressed_texture_etc1")))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===Da||e===wa)&&null!==(t=we.get("EXT_blend_minmax"))){if(e===Da)return t.MIN_EXT;if(e===wa)return t.MAX_EXT}return e===Ro&&null!==(t=we.get("WEBGL_depth_texture"))?t.UNSIGNED_INT_24_8_WEBGL:0}console.log("THREE.WebGLRenderer",aa),e=e||{};var U=void 0!==e.canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),R=void 0!==e.context?e.context:null,A=void 0!==e.alpha&&e.alpha,N=void 0===e.depth||e.depth,P=void 0===e.stencil||e.stencil,k=void 0!==e.antialias&&e.antialias,B=void 0===e.premultipliedAlpha||e.premultipliedAlpha,F=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,H=e.maxDrawCacheNum,G=[],V=new Float32Array(8),z=[],j=[],Y=new THREE.Vector3;this.domElement=U,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=to,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var K=this,Q=null,J=null,$=null,ee=-1,te="",ne=null,ae=new r,oe=null,se=new r,le=0,ue=new X(0),ce=0,he=U.width,de=U.height,fe=1,pe=new r(0,0,he,de),me=!1,ge=new r(0,0,he,de),ve=new ie,ye=new dt,Ee=!1,be=!1,xe=new u,Me=new l,_e=new u,Ce=new u,Ie={hash:"",ambient:[0,0,0],directional:[],
directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],shadows:[]},Oe={geometries:0,textures:0},Le={frame:0,calls:0,vertices:0,faces:0,points:0};this.info={render:Le,memory:Oe,programs:null};var Se;try{var De={alpha:A,depth:N,stencil:P,antialias:k,premultipliedAlpha:B,preserveDrawingBuffer:F};if(null===(Se=R||U.getContext("webgl",De)||U.getContext("experimental-webgl",De)))throw null!==U.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===Se.getShaderPrecisionFormat&&(Se.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),U.addEventListener("webglcontextlost",a,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}var we=new ht(Se);we.get("WEBGL_depth_texture"),we.get("OES_texture_float"),we.get("OES_texture_float_linear"),we.get("OES_texture_half_float"),we.get("OES_texture_half_float_linear"),we.get("OES_standard_derivatives"),we.get("ANGLE_instanced_arrays"),we.get("OES_element_index_uint")&&(Te.MaxIndex=4294967296);var Ue,Re=new ct(Se,we,e),Ae=new ut(Se,we,w),Ne=new lt,ke=new st(Se,we,Ae,Ne,Re,w,Oe),Be=new Pe(Se);Ue=void 0!==H?new ia(Se,Be,Oe,H):new ze(Se,Be,Oe);var Fe=new We(Se,Ue,Le),Xe=new ot(this,Re),Ye=new je,qe=new He;this.info.programs=Xe.programs;var Ze=new Ve(Se,we,Le),Ke=new Ge(Se,we,Le);n(),this.context=Se,this.capabilities=Re,this.extensions=we,this.properties=Ne,this.state=Ae;var Qe=new re(this,Ie,Fe,Re);this.shadowMap=Qe;new Z(this,z),new q(this,j);this.getContext=function(){return Se},this.getContextAttributes=function(){return Se.getContextAttributes()},this.forceContextLoss=function(){var e=we.get("WEBGL_lose_context");e&&e.loseContext()},this.getMaxAnisotropy=function(){return Re.getMaxAnisotropy()},this.getPrecision=function(){return Re.precision},this.getPixelRatio=function(){return fe},this.setPixelRatio=function(e){void 0!==e&&(fe=e,this.setSize(ge.z,ge.w,!1))},this.getSize=function(){return{width:he,height:de}},this.setSize=function(e,t,n){he=e,de=t,U.width=e*fe,U.height=t*fe,!1!==n&&(U.style.width=e+"px",U.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,n,i){Ae.viewport(ge.set(e,t,n,i))},this.setScissor=function(e,t,n,i){Ae.scissor(pe.set(e,t,n,i))},this.setScissorTest=function(e){Ae.setScissorTest(me=e)},this.getClearColor=function(){return ue},this.setClearColor=function(e,t){ue.set(e),ce=void 0!==t?t:1,Ae.buffers.color.setClear(ue.r,ue.g,ue.b,ce,B)},this.getClearAlpha=function(){return ce},this.setClearAlpha=function(e){ce=e,Ae.buffers.color.setClear(ue.r,ue.g,ue.b,ce,B)},this.clear=function(e,t,n){var i=0;(void 0===e||e)&&(i|=Se.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=Se.DEPTH_BUFFER_BIT),(void 0===n||n)&&(i|=Se.STENCIL_BUFFER_BIT),Se.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,n,i){this.setRenderTarget(e),this.clear(t,n,i)},this.resetGLState=i,this.dispose=function(){U.removeEventListener("webglcontextlost",a,!1),qe.dispose()},this.renderBufferImmediate=function(e,t,n){Ae.initAttributes();var i=Ne.get(e);e.hasPositions&&!i.position&&(i.position=Se.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=Se.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=Se.createBuffer()),e.hasColors&&!i.color&&(i.color=Se.createBuffer());var r=t.getAttributes();if(e.hasPositions&&(Se.bindBuffer(Se.ARRAY_BUFFER,i.position),Se.bufferData(Se.ARRAY_BUFFER,e.positionArray,Se.DYNAMIC_DRAW),Ae.enableAttribute(r.position),Se.vertexAttribPointer(r.position,3,Se.FLOAT,!1,0,0)),e.hasNormals){if(Se.bindBuffer(Se.ARRAY_BUFFER,i.normal),!n.isMeshPhongMaterial&&!n.isMeshStandardMaterial&&!n.isMeshNormalMaterial&&n.shading===ga)for(var a=0,o=3*e.count;a<o;a+=9){var s=e.normalArray,l=(s[a+0]+s[a+3]+s[a+6])/3,u=(s[a+1]+s[a+4]+s[a+7])/3,c=(s[a+2]+s[a+5]+s[a+8])/3;s[a+0]=l,s[a+1]=u,s[a+2]=c,s[a+3]=l,s[a+4]=u,s[a+5]=c,s[a+6]=l,s[a+7]=u,s[a+8]=c}Se.bufferData(Se.ARRAY_BUFFER,e.normalArray,Se.DYNAMIC_DRAW),Ae.enableAttribute(r.normal),Se.vertexAttribPointer(r.normal,3,Se.FLOAT,!1,0,0)}e.hasUvs&&n.map&&(Se.bindBuffer(Se.ARRAY_BUFFER,i.uv),Se.bufferData(Se.ARRAY_BUFFER,e.uvArray,Se.DYNAMIC_DRAW),Ae.enableAttribute(r.uv),Se.vertexAttribPointer(Be.uv,2,Se.FLOAT,!1,0,0)),e.hasColors&&n.vertexColors!==ya&&(Se.bindBuffer(Se.ARRAY_BUFFER,i.color),Se.bufferData(Se.ARRAY_BUFFER,e.colorArray,Se.DYNAMIC_DRAW),Ae.enableAttribute(r.color),Se.vertexAttribPointer(r.color,3,Se.FLOAT,!1,0,0)),Ae.disableUnusedAttributes(),Se.drawArrays(Se.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,n,i,r,a,o){Ae.setMaterial(r);var s=m(e,n,r,a),l=i.id;l+="_",l+=s.id,l+="_",l+=!0===r.wireframe;var u=!1;l!==te&&(te=l,u=!0);var c=a.morphTargetInfluences;if(void 0!==c){for(var h=[],p=0,g=c.length;p<g;p++){var v=c[p];h.push([v,p])}h.sort(d),h.length>8&&(h.length=8);for(var y=i.morphAttributes,p=0,g=h.length;p<g;p++){var v=h[p];if(V[p]=v[0],0!==v[0]){var E=v[1];!0===r.morphTargets&&y.position&&i.addAttribute("morphTarget"+p,y.position[E]),!0===r.morphNormals&&y.normal&&i.addAttribute("morphNormal"+p,y.normal[E])}else!0===r.morphTargets&&i.removeAttribute("morphTarget"+p),!0===r.morphNormals&&i.removeAttribute("morphNormal"+p)}for(var p=h.length,b=V.length;p<b;p++)V[p]=0;s.getUniforms().setValue(Se,"morphTargetInfluences",V),u=!0}var E=i.index,x=i.attributes.position,M=1;!0===r.wireframe&&(E=Ue.getWireframeAttribute(i),M=2);var _=Ze;null!==E&&(_=Ke,_.setIndex(E)),u&&(f(r,s,i),null!==E&&Se.bindBuffer(Se.ELEMENT_ARRAY_BUFFER,Be.get(E).buffer));var C=0;null!==E?C=E.count:void 0!==x&&(C=x.count);var I=i.drawRange.start*M,O=i.drawRange.count*M,T=null!==o?o.start*M:0,L=null!==o?o.count*M:1/0,S=Math.max(I,T),D=Math.min(C,I+O,T+L)-1,w=Math.max(0,D-S+1);if(0!==w){if(a.isMesh)if(!0===r.wireframe)Ae.setLineWidth(r.wireframeLinewidth*t()),_.setMode(Se.LINES);else switch(a.drawMode){case $o:_.setMode(Se.TRIANGLES);break;case es:_.setMode(Se.TRIANGLE_STRIP);break;case ts:_.setMode(Se.TRIANGLE_FAN)}else if(a.isLine){var U=r.linewidth;void 0===U&&(U=1),Ae.setLineWidth(U*t()),a.isLineSegments?_.setMode(Se.LINES):a.isLineLoop?_.setMode(Se.LINE_LOOP):_.setMode(Se.LINE_STRIP)}else a.isPoints&&_.setMode(Se.POINTS);i&&i.isInstancedBufferGeometry?i.maxInstancedCount>0&&_.renderInstances(i,S,w):_.render(S,w)}},this.compile=function(e,t){G=[],e.traverse(function(e){e.isLight&&G.push(e)}),S(G,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var n=0;n<t.material.length;n++)p(t.material[n],e.fog,t);else p(t.material,e.fog,t)})},this.render=function(e,t,n,i){return null===Je?void console.error("THREE.WebGLRenderer.render: OrderedRenderer is not set."):void 0!==t&&!0!==t.isCamera?void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera."):(te="",ee=-1,ne=null,!0===e.autoUpdate&&e.updateMatrixWorld(),t.onBeforeRender(K),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),be=this.localClippingEnabled,Ee=ye.init(this.clippingPlanes,be,t),xe.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ve.setFromMatrix(xe),Le.frame++,Le.calls=0,Le.vertices=0,Le.faces=0,Le.points=0,Je.update(ve,xe),Qe.needsUpdate&&Je.projectLights(e,G),Ee&&ye.beginShadows(),L(G),Qe.render(e,t),S(G,t),Ee&&ye.endShadows(),Je.render(this,e,t,G,n,i,Ae))},this.setFaceCulling=function(e,t){Ae.setCullFace(e),Ae.setFlipSided(t===ca)},this.allocTextureUnit=D,this.setTexture2D=function(){var e=!1;return function(t,n){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),ke.setTexture2D(t,n)}}(),this.setTexture=function(){var e=!1;return function(t,n){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),ke.setTexture2D(t,n)}}(),this.setTextureCube=function(){var e=!1;return function(t,n){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?ke.setTextureCube(t,n):ke.setTextureCubeDynamic(t,n)}}(),this.getRenderTarget=function(){return J},this.isMRTSupported=function(){return we.get("WEBGL_draw_buffers")},this.setRenderTarget=function(e){if(Array.isArray(e)){if(this.isMRTSupported()){J=e[0],ke.setupMultiRenderTarget(e);var t,n=Ne.get(e[0]);t=n.__webglFramebuffer;var i=J;ae.copy(i.scissor),oe=i.scissorTest,se.copy(i.viewport),$!==t&&(Se.bindFramebuffer(Se.FRAMEBUFFER,t),$=t),Ae.scissor(ae),Ae.setScissorTest(oe),Ae.viewport(se)}}else{J=e,e&&void 0===Ne.get(e).__webglFramebuffer&&ke.setupRenderTarget(e);var t,r=e&&e.isWebGLRenderTargetCube;if(e){var n=Ne.get(e);t=r?n.__webglFramebuffer[e.activeCubeFace]:n.__webglFramebuffer,ae.copy(e.scissor),oe=e.scissorTest,se.copy(e.viewport)}else t=null,ae.copy(pe).multiplyScalar(fe),oe=me,se.copy(ge).multiplyScalar(fe);if($!==t&&(Se.bindFramebuffer(Se.FRAMEBUFFER,t),$=t),Ae.scissor(ae),Ae.setScissorTest(oe),Ae.viewport(se),r){var a=Ne.get(e.texture);Se.framebufferTexture2D(Se.FRAMEBUFFER,Se.COLOR_ATTACHMENT0,Se.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,a.__webglTexture,e.activeMipMapLevel)}}},this.readRenderTargetPixels=function(e,t,n,i,r,a){if(!1===(e&&e.isWebGLRenderTarget))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");var o=Ne.get(e).__webglFramebuffer;if(o){var s=!1;o!==$&&(Se.bindFramebuffer(Se.FRAMEBUFFER,o),s=!0);try{var l=e.texture,u=l.format,c=l.type;if(u!==Po&&w(u)!==Se.getParameter(Se.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(c===Mo||w(c)===Se.getParameter(Se.IMPLEMENTATION_COLOR_READ_TYPE)||c===Lo&&(we.get("OES_texture_float")||we.get("WEBGL_color_buffer_float"))||c===So&&we.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");Se.checkFramebufferStatus(Se.FRAMEBUFFER)===Se.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-i&&n>=0&&n<=e.height-r&&Se.readPixels(t,n,i,r,w(u),w(c),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&Se.bindFramebuffer(Se.FRAMEBUFFER,$)}}},this.updateObject=function(e){return Fe.update(e)};var Je=null;this.setRenderer=function(e){Je=e},this.getRenderer=function(){return Je},this.destroy=function(){Je.destroy(),Ne.clear()},this.resetIncrementRender=function(){Je.restart()},this.setFilterObject=function(e){Je.setFilter(e)},this.setObjectListUpdateState=function(e){Je.updateObjectList(e)},this.computeSelectionBBox=function(){return Je.computeSelectionBBox()},this.computeRenderObjectsBox=function(){return Je.computeRenderObjectsBox()},this.setRenderTicket=function(e){Fe._renderTicket=e},this.setupLights=function(e,t){S(e,t)}}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&function(){Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var i=arguments[n];if(void 0!==i&&null!==i)for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t}}(),Object.assign(t.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var n=this._listeners,i=n[e];if(void 0!==i){var r=i.indexOf(t);-1!==r&&i.splice(r,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners,n=t[e.type];if(void 0!==n){e.target=this;var i=[],r=0,a=n.length;for(r=0;r<a;r++)i[r]=n[r];for(r=0;r<a;r++)i[r].call(this,e)}}}});var aa="85",oa={LEFT:0,MIDDLE:1,RIGHT:2},sa=0,la=1,ua=2,ca=0,ha=1,da=2,fa=0,pa=1,ma=2,ga=1,va=2,ya=0,Ea=1,ba=2,xa=0,Ma=1,_a=2,Ca=3,Ia=4,Oa=5,Ta=100,La=101,Sa=102,Da=103,wa=104,Ua=200,Ra=201,Aa=202,Na=203,Pa=204,ka=205,Ba=206,Fa=207,Ha=208,Ga=209,Va=210,za=0,ja=1,Wa=2,Xa=3,Ya=4,qa=5,Za=6,Ka=7,Qa=0,Ja=1,$a=2,eo=0,to=1,no=2,io=3,ro=4,ao=301,oo=302,so=303,lo=304,uo=305,co=306,ho=307,fo=1e3,po=1001,mo=1002,go=1003,vo=1004,yo=1005,Eo=1006,bo=1007,xo=1008,Mo=1009,_o=1010,Co=1011,Io=1012,Oo=1013,To=1014,Lo=1015,So=1016,Do=1017,wo=1018,Uo=1019,Ro=1020,Ao=1021,No=1022,Po=1023,ko=1024,Bo=1025,Fo=Po,Ho=1026,Go=1027,Vo=2001,zo=2002,jo=2003,Wo=2004,Xo=2100,Yo=2101,qo=2102,Zo=2103,Ko=2151,Qo=2201,Jo=2400,$o=0,es=1,ts=2,ns=3e3,is=3001,rs=3007,as=3002,os=3004,ss=3005,ls=3006,us=3200,cs=3201,hs={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=new Array(36),i=0;return function(){for(var r=0;r<36;r++)8===r||13===r||18===r||23===r?n[r]="-":14===r?n[r]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),e=15&i,i>>=4,n[r]=t[19===r?3&e|8:e]);return n.join("")}}(),clamp:function(e,t,n){return Math.max(t,Math.min(n,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,n,i,r){return i+(e-t)*(r-i)/(n-t)},lerp:function(e,t,n){return(1-n)*e+n*t},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*(3-2*e)},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*hs.DEG2RAD},radToDeg:function(e){return e*hs.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}};Object.defineProperties(n.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(n.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e=new n,t=new n;return function(n,i){return e.set(n,n),t.set(i,i),this.clamp(e,t)}}(),clampLength:function(e,t){var n=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,n))/n)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length())},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y;return t*t+n*n},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,n){return this.subVectors(t,e).multiplyScalar(n).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,n){return void 0!==n&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var n=Math.cos(t),i=Math.sin(t),r=this.x-e.x,a=this.y-e.y;return this.x=r*n-a*i+e.x,this.y=r*i+a*n+e.y,this}});var ds=0;i.DEFAULT_IMAGE=void 0,i.DEFAULT_MAPPING=300,Object.defineProperty(i.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(i.prototype,t.prototype,{constructor:i,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.rotateMatrix.copy(e.rotateMatrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){if(void 0!==e.textures[this.uuid])return e.textures[this.uuid];var t={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var n=this.image;void 0===n.uuid&&(n.uuid=hs.generateUUID()),void 0===e.images[n.uuid]&&(e.images[n.uuid]={uuid:n.uuid,url:function(e){var t;return void 0!==e.toDataURL?t=e:(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)),t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}(n)}),t.image=n.uuid}return e.textures[this.uuid]=t,t},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300===this.mapping){if(e.multiply(this.repeat),e.add(this.offset),e.x<0||e.x>1)switch(this.wrapS){case fo:e.x=e.x-Math.floor(e.x);break;case po:e.x=e.x<0?0:1;break;case mo:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case fo:e.y=e.y-Math.floor(e.y);break;case po:e.y=e.y<0?0:1;break;case mo:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}},setRotateAngle:function(e){var t=THREE.Math.degToRad(e),n=Math.sin(t),i=Math.cos(t);this.rotateMatrix.elements[0]=i,this.rotateMatrix.elements[1]=n,this.rotateMatrix.elements[3]=-n,this.rotateMatrix.elements[4]=i}}),Object.assign(r.prototype,{isVector4:!0,set:function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,n=this.y,i=this.z,r=this.w,a=e.elements;return this.x=a[0]*t+a[4]*n+a[8]*i+a[12]*r,this.y=a[1]*t+a[5]*n+a[9]*i+a[13]*r,this.z=a[2]*t+a[6]*n+a[10]*i+a[14]*r,this.w=a[3]*t+a[7]*n+a[11]*i+a[15]*r,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,n,i,r,a=e.elements,o=a[0],s=a[4],l=a[8],u=a[1],c=a[5],h=a[9],d=a[2],f=a[6],p=a[10];if(Math.abs(s-u)<.01&&Math.abs(l-d)<.01&&Math.abs(h-f)<.01){if(Math.abs(s+u)<.1&&Math.abs(l+d)<.1&&Math.abs(h+f)<.1&&Math.abs(o+c+p-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(o+1)/2,g=(c+1)/2,v=(p+1)/2,y=(s+u)/4,E=(l+d)/4,b=(h+f)/4;return m>g&&m>v?m<.01?(n=0,i=.707106781,r=.707106781):(n=Math.sqrt(m),i=y/n,r=E/n):g>v?g<.01?(n=.707106781,i=0,r=.707106781):(i=Math.sqrt(g),n=y/i,r=b/i):v<.01?(n=.707106781,i=.707106781,r=0):(r=Math.sqrt(v),n=E/r,i=b/r),this.set(n,i,r,t),this}var x=Math.sqrt((f-h)*(f-h)+(l-d)*(l-d)+(u-s)*(u-s));return Math.abs(x)<.001&&(x=1),this.x=(f-h)/x,this.y=(l-d)/x,this.z=(u-s)/x,this.w=Math.acos((o+c+p-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e=new r,t=new r;return function(n,i){return e.set(n,n,n,n),t.set(i,i,i,i),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,n){return this.subVectors(t,e).multiplyScalar(n).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,n){return void 0!==n&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.assign(a.prototype,t.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),o.prototype=Object.create(a.prototype),o.prototype.constructor=o,o.prototype.isWebGLRenderTargetCube=!0,Object.assign(s,{slerp:function(e,t,n,i){return n.copy(e).slerp(t,i)},slerpFlat:function(e,t,n,i,r,a,o){var s=n[i+0],l=n[i+1],u=n[i+2],c=n[i+3],h=r[a+0],d=r[a+1],f=r[a+2],p=r[a+3];if(c!==p||s!==h||l!==d||u!==f){var m=1-o,g=s*h+l*d+u*f+c*p,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var E=Math.sqrt(y),b=Math.atan2(E,g*v);m=Math.sin(m*b)/E,o=Math.sin(o*b)/E}var x=o*v;if(s=s*m+h*x,l=l*m+d*x,u=u*m+f*x,c=c*m+p*x,m===1-o){var M=1/Math.sqrt(s*s+l*l+u*u+c*c);s*=M,l*=M,u*=M,c*=M}}e[t]=s,e[t+1]=l,e[t+2]=u,e[t+3]=c}}),Object.defineProperties(s.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(s.prototype,{set:function(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!1===(e&&e.isEuler))throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var n=e._x,i=e._y,r=e._z,a=e.order,o=Math.cos,s=Math.sin,l=o(n/2),u=o(i/2),c=o(r/2),h=s(n/2),d=s(i/2),f=s(r/2);return"XYZ"===a?(this._x=h*u*c+l*d*f,this._y=l*d*c-h*u*f,this._z=l*u*f+h*d*c,this._w=l*u*c-h*d*f):"YXZ"===a?(this._x=h*u*c+l*d*f,this._y=l*d*c-h*u*f,this._z=l*u*f-h*d*c,this._w=l*u*c+h*d*f):"ZXY"===a?(this._x=h*u*c-l*d*f,this._y=l*d*c+h*u*f,this._z=l*u*f+h*d*c,this._w=l*u*c-h*d*f):"ZYX"===a?(this._x=h*u*c-l*d*f,this._y=l*d*c+h*u*f,this._z=l*u*f-h*d*c,this._w=l*u*c+h*d*f):"YZX"===a?(this._x=h*u*c+l*d*f,this._y=l*d*c+h*u*f,this._z=l*u*f-h*d*c,this._w=l*u*c-h*d*f):"XZY"===a&&(this._x=h*u*c-l*d*f,this._y=l*d*c-h*u*f,this._z=l*u*f+h*d*c,this._w=l*u*c+h*d*f),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,n=e.elements,i=n[0],r=n[4],a=n[8],o=n[1],s=n[5],l=n[9],u=n[2],c=n[6],h=n[10],d=i+s+h;return d>0?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(c-l)*t,this._y=(a-u)*t,this._z=(o-r)*t):i>s&&i>h?(t=2*Math.sqrt(1+i-s-h),this._w=(c-l)/t,this._x=.25*t,this._y=(r+o)/t,this._z=(a+u)/t):s>h?(t=2*Math.sqrt(1+s-i-h),this._w=(a-u)/t,this._x=(r+o)/t,this._y=.25*t,this._z=(l+c)/t):(t=2*Math.sqrt(1+h-i-s),this._w=(o-r)/t,this._x=(a+u)/t,this._y=(l+c)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t=new l;return function(n,i){return void 0===t&&(t=new l),e=n.dot(i)+1,e<1e-6?(e=0,Math.abs(n.x)>Math.abs(n.z)?t.set(-n.y,n.x,0):t.set(0,-n.z,n.y)):t.crossVectors(n,i),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize()}}(),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var n=e._x,i=e._y,r=e._z,a=e._w,o=t._x,s=t._y,l=t._z,u=t._w;return this._x=n*u+a*o+i*l-r*s,this._y=i*u+a*s+r*o-n*l,this._z=r*u+a*l+n*s-i*o,this._w=a*u-n*o-i*s-r*l,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var n=this._x,i=this._y,r=this._z,a=this._w,o=a*e._w+n*e._x+i*e._y+r*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=a,this._x=n,this._y=i,this._z=r,this;var s=Math.sqrt(1-o*o);if(Math.abs(s)<.001)return this._w=.5*(a+this._w),this._x=.5*(n+this._x),
this._y=.5*(i+this._y),this._z=.5*(r+this._z),this;var l=Math.atan2(s,o),u=Math.sin((1-t)*l)/s,c=Math.sin(t*l)/s;return this._w=a*u+this._w*c,this._x=n*u+this._x*c,this._y=i*u+this._y*c,this._z=r*u+this._z*c,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(l.prototype,{isVector3:!0,set:function(e,t,n){return this.x=e,this.y=t,this.z=n,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e=new s;return function(t){return!1===(t&&t.isEuler)&&console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(e.setFromEuler(t))}}(),applyAxisAngle:function(){var e=new s;return function(t,n){return this.applyQuaternion(e.setFromAxisAngle(t,n))}}(),applyMatrix3:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6]*i,this.y=r[1]*t+r[4]*n+r[7]*i,this.z=r[2]*t+r[5]*n+r[8]*i,this},applyMatrix4:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements;this.x=r[0]*t+r[4]*n+r[8]*i+r[12],this.y=r[1]*t+r[5]*n+r[9]*i+r[13],this.z=r[2]*t+r[6]*n+r[10]*i+r[14];var a=r[3]*t+r[7]*n+r[11]*i+r[15];return this.divideScalar(a)},applyQuaternion:function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z,s=e.w,l=s*t+a*i-o*n,u=s*n+o*t-r*i,c=s*i+r*n-a*t,h=-r*t-a*n-o*i;return this.x=l*s+h*-r+u*-o-c*-a,this.y=u*s+h*-a+c*-r-l*-o,this.z=c*s+h*-o+l*-a-u*-r,this},project:function(){var e=new u;return function(t){return e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyMatrix4(e)}}(),unproject:function(){var e=new u;return function(t){return e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyMatrix4(e)}}(),transformDirection:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i,this.y=r[1]*t+r[5]*n+r[9]*i,this.z=r[2]*t+r[6]*n+r[10]*i,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e=new l,t=new l;return function(n,i){return e.set(n,n,n),t.set(i,i,i),this.clamp(e,t)}}(),clampLength:function(e,t){var n=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,n))/n)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,n){return this.subVectors(t,e).multiplyScalar(n).add(e)},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var n=this.x,i=this.y,r=this.z;return this.x=i*e.z-r*e.y,this.y=r*e.x-n*e.z,this.z=n*e.y-i*e.x,this},crossVectors:function(e,t){var n=e.x,i=e.y,r=e.z,a=t.x,o=t.y,s=t.z;return this.x=i*s-r*o,this.y=r*a-n*s,this.z=n*o-i*a,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:function(){var e=new l;return function(t){return e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e=new l;return function(t){return this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(hs.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromCylindrical:function(e){return this.x=e.radius*Math.sin(e.theta),this.y=e.y,this.z=e.radius*Math.cos(e.theta),this},setFromMatrixPosition:function(e){return this.setFromMatrixColumn(e,3)},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=i,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,n){return void 0!==n&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(u.prototype,{isMatrix4:!0,set:function(e,t,n,i,r,a,o,s,l,u,c,h,d,f,p,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=r,g[5]=a,g[9]=o,g[13]=s,g[2]=l,g[6]=u,g[10]=c,g[14]=h,g[3]=d,g[7]=f,g[11]=p,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new u).fromArray(this.elements)},copy:function(e){var t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this},copyPosition:function(e){var t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this},extractBasis:function(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this},extractRotation:function(){var e=new l;return function(t){var n=this.elements,i=t.elements,r=1/e.setFromMatrixColumn(t,0).length(),a=1/e.setFromMatrixColumn(t,1).length(),o=1/e.setFromMatrixColumn(t,2).length();return n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[4]=i[4]*a,n[5]=i[5]*a,n[6]=i[6]*a,n[8]=i[8]*o,n[9]=i[9]*o,n[10]=i[10]*o,this}}(),makeRotationFromEuler:function(e){!1===(e&&e.isEuler)&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,n=e.x,i=e.y,r=e.z,a=Math.cos(n),o=Math.sin(n),s=Math.cos(i),l=Math.sin(i),u=Math.cos(r),c=Math.sin(r);if("XYZ"===e.order){var h=a*u,d=a*c,f=o*u,p=o*c;t[0]=s*u,t[4]=-s*c,t[8]=l,t[1]=d+f*l,t[5]=h-p*l,t[9]=-o*s,t[2]=p-h*l,t[6]=f+d*l,t[10]=a*s}else if("YXZ"===e.order){var m=s*u,g=s*c,v=l*u,y=l*c;t[0]=m+y*o,t[4]=v*o-g,t[8]=a*l,t[1]=a*c,t[5]=a*u,t[9]=-o,t[2]=g*o-v,t[6]=y+m*o,t[10]=a*s}else if("ZXY"===e.order){var m=s*u,g=s*c,v=l*u,y=l*c;t[0]=m-y*o,t[4]=-a*c,t[8]=v+g*o,t[1]=g+v*o,t[5]=a*u,t[9]=y-m*o,t[2]=-a*l,t[6]=o,t[10]=a*s}else if("ZYX"===e.order){var h=a*u,d=a*c,f=o*u,p=o*c;t[0]=s*u,t[4]=f*l-d,t[8]=h*l+p,t[1]=s*c,t[5]=p*l+h,t[9]=d*l-f,t[2]=-l,t[6]=o*s,t[10]=a*s}else if("YZX"===e.order){var E=a*s,b=a*l,x=o*s,M=o*l;t[0]=s*u,t[4]=M-E*c,t[8]=x*c+b,t[1]=c,t[5]=a*u,t[9]=-o*u,t[2]=-l*u,t[6]=b*c+x,t[10]=E-M*c}else if("XZY"===e.order){var E=a*s,b=a*l,x=o*s,M=o*l;t[0]=s*u,t[4]=-c,t[8]=l*u,t[1]=E*c+M,t[5]=a*u,t[9]=b*c-x,t[2]=x*c-b,t[6]=o*u,t[10]=M*c+E}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,n=e._x,i=e._y,r=e._z,a=e._w,o=n+n,s=i+i,l=r+r,u=n*o,c=n*s,h=n*l,d=i*s,f=i*l,p=r*l,m=a*o,g=a*s,v=a*l;return t[0]=1-(d+p),t[4]=c-v,t[8]=h+g,t[1]=c+v,t[5]=1-(u+p),t[9]=f-m,t[2]=h-g,t[6]=f+m,t[10]=1-(u+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e=new l,t=new l,n=new l;return function(i,r,a){var o=this.elements;return n.subVectors(i,r),0===n.lengthSq()&&(n.z=1),n.normalize(),e.crossVectors(a,n),0===e.lengthSq()&&(n.z+=1e-4,e.crossVectors(a,n)),e.normalize(),t.crossVectors(n,e),o[0]=e.x,o[4]=t.x,o[8]=n.x,o[1]=e.y,o[5]=t.y,o[9]=n.y,o[2]=e.z,o[6]=t.z,o[10]=n.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var n=e.elements,i=t.elements,r=this.elements,a=n[0],o=n[4],s=n[8],l=n[12],u=n[1],c=n[5],h=n[9],d=n[13],f=n[2],p=n[6],m=n[10],g=n[14],v=n[3],y=n[7],E=n[11],b=n[15],x=i[0],M=i[4],_=i[8],C=i[12],I=i[1],O=i[5],T=i[9],L=i[13],S=i[2],D=i[6],w=i[10],U=i[14],R=i[3],A=i[7],N=i[11],P=i[15];return r[0]=a*x+o*I+s*S+l*R,r[4]=a*M+o*O+s*D+l*A,r[8]=a*_+o*T+s*w+l*N,r[12]=a*C+o*L+s*U+l*P,r[1]=u*x+c*I+h*S+d*R,r[5]=u*M+c*O+h*D+d*A,r[9]=u*_+c*T+h*w+d*N,r[13]=u*C+c*L+h*U+d*P,r[2]=f*x+p*I+m*S+g*R,r[6]=f*M+p*O+m*D+g*A,r[10]=f*_+p*T+m*w+g*N,r[14]=f*C+p*L+m*U+g*P,r[3]=v*x+y*I+E*S+b*R,r[7]=v*M+y*O+E*D+b*A,r[11]=v*_+y*T+E*w+b*N,r[15]=v*C+y*L+E*U+b*P,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToBufferAttribute:function(){var e=new l;return function(t){for(var n=0,i=t.count;n<i;n++)e.x=t.getX(n),e.y=t.getY(n),e.z=t.getZ(n),e.applyMatrix4(this),t.setXYZ(n,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],n=e[4],i=e[8],r=e[12],a=e[1],o=e[5],s=e[9],l=e[13],u=e[2],c=e[6],h=e[10],d=e[14];return e[3]*(+r*s*c-i*l*c-r*o*h+n*l*h+i*o*d-n*s*d)+e[7]*(+t*s*d-t*l*h+r*a*h-i*a*d+i*l*u-r*s*u)+e[11]*(+t*l*c-t*o*d-r*a*c+n*a*d+r*o*u-n*l*u)+e[15]*(-i*o*u-t*s*c+t*o*h+i*a*c-n*a*h+n*s*u)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var n=this.elements,i=e.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=i[4],u=i[5],c=i[6],h=i[7],d=i[8],f=i[9],p=i[10],m=i[11],g=i[12],v=i[13],y=i[14],E=i[15],b=f*y*h-v*p*h+v*c*m-u*y*m-f*c*E+u*p*E,x=g*p*h-d*y*h-g*c*m+l*y*m+d*c*E-l*p*E,M=d*v*h-g*f*h+g*u*m-l*v*m-d*u*E+l*f*E,_=g*f*c-d*v*c-g*u*p+l*v*p+d*u*y-l*f*y,C=r*b+a*x+o*M+s*_;if(0===C){var I="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(!0===t)throw new Error(I);return console.warn(I),this.identity()}var O=1/C;return n[0]=b*O,n[1]=(v*p*s-f*y*s-v*o*m+a*y*m+f*o*E-a*p*E)*O,n[2]=(u*y*s-v*c*s+v*o*h-a*y*h-u*o*E+a*c*E)*O,n[3]=(f*c*s-u*p*s-f*o*h+a*p*h+u*o*m-a*c*m)*O,n[4]=x*O,n[5]=(d*y*s-g*p*s+g*o*m-r*y*m-d*o*E+r*p*E)*O,n[6]=(g*c*s-l*y*s-g*o*h+r*y*h+l*o*E-r*c*E)*O,n[7]=(l*p*s-d*c*s+d*o*h-r*p*h-l*o*m+r*c*m)*O,n[8]=M*O,n[9]=(g*f*s-d*v*s-g*a*m+r*v*m+d*a*E-r*f*E)*O,n[10]=(l*v*s-g*u*s+g*a*h-r*v*h-l*a*E+r*u*E)*O,n[11]=(d*u*s-l*f*s-d*a*h+r*f*h+l*a*m-r*u*m)*O,n[12]=_*O,n[13]=(d*v*o-g*f*o+g*a*p-r*v*p-d*a*y+r*f*y)*O,n[14]=(g*u*o-l*v*o-g*a*c+r*v*c+l*a*y-r*u*y)*O,n[15]=(l*f*o-d*u*o+d*a*c-r*f*c-l*a*p+r*u*p)*O,this},scale:function(e){var t=this.elements,n=e.x,i=e.y,r=e.z;return t[0]*=n,t[4]*=i,t[8]*=r,t[1]*=n,t[5]*=i,t[9]*=r,t[2]*=n,t[6]*=i,t[10]*=r,t[3]*=n,t[7]*=i,t[11]*=r,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,i))},makeTranslation:function(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var n=Math.cos(t),i=Math.sin(t),r=1-n,a=e.x,o=e.y,s=e.z,l=r*a,u=r*o;return this.set(l*a+n,l*o-i*s,l*s+i*o,0,l*o+i*s,u*o+n,u*s-i*a,0,l*s-i*o,u*s+i*a,r*s*s+n,0,0,0,0,1),this},makeScale:function(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this},makeShear:function(e,t,n){return this.set(1,t,n,0,e,1,n,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,n){return this.makeRotationFromQuaternion(t),this.scale(n),this.setPosition(e),this},decompose:function(){var e=new l,t=new u;return function(n,i,r){var a=this.elements,o=e.set(a[0],a[1],a[2]).length(),s=e.set(a[4],a[5],a[6]).length(),l=e.set(a[8],a[9],a[10]).length();this.determinant()<0&&(o=-o),n.x=a[12],n.y=a[13],n.z=a[14],t.copy(this);var u=1/o,c=1/s,h=1/l;return t.elements[0]*=u,t.elements[1]*=u,t.elements[2]*=u,t.elements[4]*=c,t.elements[5]*=c,t.elements[6]*=c,t.elements[8]*=h,t.elements[9]*=h,t.elements[10]*=h,i.setFromRotationMatrix(t),r.x=o,r.y=s,r.z=l,this}}(),makePerspective:function(e,t,n,i,r,a){void 0===a&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var o=this.elements,s=2*r/(t-e),l=2*r/(n-i),u=(t+e)/(t-e),c=(n+i)/(n-i),h=-(a+r)/(a-r),d=-2*a*r/(a-r);return o[0]=s,o[4]=0,o[8]=u,o[12]=0,o[1]=0,o[5]=l,o[9]=c,o[13]=0,o[2]=0,o[6]=0,o[10]=h,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makeOrthographic:function(e,t,n,i,r,a){var o=this.elements,s=1/(t-e),l=1/(n-i),u=1/(a-r),c=(t+e)*s,h=(n+i)*l,d=(a+r)*u;return o[0]=2*s,o[4]=0,o[8]=0,o[12]=-c,o[1]=0,o[5]=2*l,o[9]=0,o[13]=-h,o[2]=0,o[6]=0,o[10]=-2*u,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},equals:function(e){for(var t=this.elements,n=e.elements,i=0;i<16;i++)if(t[i]!==n[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var n=0;n<16;n++)this.elements[n]=e[n+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}),c.prototype=Object.create(i.prototype),c.prototype.constructor=c,c.prototype.isDataTexture=!0,h.prototype=Object.create(i.prototype),h.prototype.constructor=h,h.prototype.isCubeTexture=!0,Object.defineProperty(h.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var fs=new i,ps=new h,ms=[],gs=[],vs=new Float32Array(16),ys=new Float32Array(9);V.prototype.setValue=function(e,t){for(var n=this.seq,i=0,r=n.length;i!==r;++i){var a=n[i];a.setValue(e,t[a.id])}};var Es=/([\w\d_]+)(\])?(\[|\.)?/g;W.prototype.setValue=function(e,t,n){var i=this.map[t];void 0!==i&&i.setValue(e,n,this.renderer)},W.prototype.setOptional=function(e,t,n){var i=t[n];void 0!==i&&this.setValue(e,n,i)},W.upload=function(e,t,n,i){for(var r=0,a=t.length;r!==a;++r){var o=t[r],s=n[o.id];!1!==s.needsUpdate&&o.setValue(e,s.value,i)}},W.seqWithValue=function(e,t){for(var n=[],i=0,r=e.length;i!==r;++i){var a=e[i];a.id in t&&n.push(a)}return n};var bs={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Object.assign(X.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,n){return this.r=e,this.g=t,this.b=n,this},setHSL:function(){function e(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}return function(t,n,i){if(t=hs.euclideanModulo(t,1),n=hs.clamp(n,0,1),i=hs.clamp(i,0,1),0===n)this.r=this.g=this.b=i;else{var r=i<=.5?i*(1+n):i+n-i*n,a=2*i-r;this.r=e(a,r,t+1/3),this.g=e(a,r,t),this.b=e(a,r,t-1/3)}return this}}(),setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var n;if(n=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var i,r=n[1],a=n[2];switch(r){case"rgb":case"rgba":if(i=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a))return this.r=Math.min(255,parseInt(i[1],10))/255,this.g=Math.min(255,parseInt(i[2],10))/255,this.b=Math.min(255,parseInt(i[3],10))/255,t(i[5]),this;if(i=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a))return this.r=Math.min(100,parseInt(i[1],10))/100,this.g=Math.min(100,parseInt(i[2],10))/100,this.b=Math.min(100,parseInt(i[3],10))/100,t(i[5]),this;break;case"hsl":case"hsla":if(i=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a)){var o=parseFloat(i[1])/360,s=parseInt(i[2],10)/100,l=parseInt(i[3],10)/100;return t(i[5]),this.setHSL(o,s,l)}}}else if(n=/^\#([A-Fa-f0-9]+)$/.exec(e)){var u=n[1],c=u.length;if(3===c)return this.r=parseInt(u.charAt(0)+u.charAt(0),16)/255,this.g=parseInt(u.charAt(1)+u.charAt(1),16)/255,this.b=parseInt(u.charAt(2)+u.charAt(2),16)/255,this;if(6===c)return this.r=parseInt(u.charAt(0)+u.charAt(1),16)/255,this.g=parseInt(u.charAt(2)+u.charAt(3),16)/255,this.b=parseInt(u.charAt(4)+u.charAt(5),16)/255,this}if(e&&e.length>0){var u=bs[e];void 0!==u?this.setHex(u):console.warn("THREE.Color: Unknown color "+e)}return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var n=t>0?1/t:1;return this.r=Math.pow(e.r,n),this.g=Math.pow(e.g,n),this.b=Math.pow(e.b,n),this},convertGammaToLinear:function(){var e=this.r,t=this.g,n=this.b;return this.r=e*e,this.g=t*t,this.b=n*n,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,n,i=e||{h:0,s:0,l:0},r=this.r,a=this.g,o=this.b,s=Math.max(r,a,o),l=Math.min(r,a,o),u=(l+s)/2;if(l===s)t=0,n=0;else{var c=s-l;switch(n=u<=.5?c/(s+l):c/(2-s-l),s){case r:t=(a-o)/c+(a<o?6:0);break;case a:t=(o-r)/c+2;break;case o:t=(r-a)/c+4}t/=6}return i.h=t,i.s=n,i.l=u,i},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,n){var i=this.getHSL();return i.h+=e,i.s+=t,i.l+=n,this.setHSL(i.h,i.s,i.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}});var xs={common:{diffuse:{value:new X(15658734)},opacity:{value:1},map:{value:null},offsetRepeat:{value:new r(0,0,1,1)},rotateMatrix:{value:new te},specularMap:{value:null},alphaMap:{value:null},envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new n(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new X(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new X(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},offsetRepeat:{value:new r(0,0,1,1)}}},Ms={merge:function(e){for(var t={},n=0;n<e.length;n++){var i=this.clone(e[n]);for(var r in i)t[r]=i[r]}return t},clone:function(e){var t={};for(var n in e){t[n]={};for(var i in e[n]){var r=e[n][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?t[n][i]=r.clone():Array.isArray(r)?t[n][i]=r.slice():t[n][i]=r}}return t}},_s={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).a;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",
bsdfs:"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat theta = acos( dot( N, V ) );\n\tvec2 uv = vec2(\n\t\tsqrt( saturate( roughness ) ),\n\t\tsaturate( theta / ( 0.5 * PI ) ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\n\tfloat b = 3.45068 + (4.18814 + y) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transpose( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\n\treturn result;\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = dFdx( surf_pos );\n\t\tvec3 vSigmaY = dFdy( surf_pos );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transpose( const in mat3 v ) {\n\tmat3 tmp;\n\ttmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n\ttmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n\ttmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n  return m[ 2 ][ 3 ] == - 1.0;\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"#ifdef FLIP_SIDED\n\tobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normal * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\tsampleUV.y = saturate( flipNormal * reflectVec.y * 0.5 + 0.5 );\n\t\tsampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\tvec3 reflectView = flipNormal * normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",
lights_pars:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltcMat;\tuniform sampler2D ltcMag;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = saturate( reflectVec.y * 0.5 + 0.5 );\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_BlinnPhong( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = BlinnExponentToGGXRoughness( material.specularShininess );\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform vec4 offsetRepeat;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_flip:"#ifdef DOUBLE_SIDED\n\tfloat flipNormal = ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n#else\n\tfloat flipNormal = 1.0;\n#endif\n",normal_fragment:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal ) * flipNormal;\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 1.0 - 2.0 * rgb.xyz;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"#ifdef USE_SKINNING\n\tvec4 mvPosition = modelViewMatrix * skinned;\n#else\n\tvec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",
shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn 1.0;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\tfloat dp = ( length( lightToPosition ) - shadowBias ) / 1000.0;\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\tskinned  = bindMatrixInverse * skinned;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform vec4 offsetRepeat;\n\tuniform mat3 rotateMatrix;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = mat2(rotateMatrix) * vec2(uv.x - 0.5, uv.y - 0.5) + vec2(0.5, 0.5);\n\tvUv = (vUv -  offsetRepeat.xy)* offsetRepeat.zw;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( PHYSICAL ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n\t#ifdef USE_SKINNING\n\t\tvec4 worldPosition = modelMatrix * skinned;\n\t#else\n\t\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n\t#endif\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"uniform vec3 lightPos;\nvarying vec4 vWorldPosition;\n#include <common>\n#include <packing>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tgl_FragColor = packDepthToRGBA( length( vWorldPosition.xyz - lightPos.xyz ) / 1000.0 );\n}\n",distanceRGBA_vert:"varying vec4 vWorldPosition;\n#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nuniform float tFlip;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = saturate( tFlip * direction.y * -0.5 + 0.5 );\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",
normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"#ifdef USE_ATTRIBUTE_SIZE\n\tattribute float attrSize;\n\t#endif\n\tuniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_ATTRIBUTE_SIZE\n\tgl_PointSize = attrSize;\n\t#else\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#endif\n\t#ifdef USE_POSITION_OFFSET\n\t\tfloat yPos = gl_Position.y;\n\tfloat w = gl_Position.w;\n\tyPos /= w;\n\tyPos += 0.5 * gl_PointSize / scale;\n\tyPos *= w;\n\tgl_Position.y = yPos;\n\t #endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag:"uniform float opacity;\n#include <common>\n#include <packing>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( 0.0, 0.0, 0.0, opacity * ( 1.0 - getShadowMask() ) );\n}\n",shadow_vert:"#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n"},Cs={basic:{uniforms:Ms.merge([xs.common,xs.aomap,xs.lightmap,xs.fog]),vertexShader:_s.meshbasic_vert,fragmentShader:_s.meshbasic_frag},lambert:{uniforms:Ms.merge([xs.common,xs.aomap,xs.lightmap,xs.emissivemap,xs.fog,xs.lights,{emissive:{value:new X(0)}}]),vertexShader:_s.meshlambert_vert,fragmentShader:_s.meshlambert_frag},phong:{uniforms:Ms.merge([xs.common,xs.aomap,xs.lightmap,xs.emissivemap,xs.bumpmap,xs.normalmap,xs.displacementmap,xs.gradientmap,xs.fog,xs.lights,{emissive:{value:new X(0)},specular:{value:new X(1118481)},shininess:{value:30}}]),vertexShader:_s.meshphong_vert,fragmentShader:_s.meshphong_frag},standard:{uniforms:Ms.merge([xs.common,xs.aomap,xs.lightmap,xs.emissivemap,xs.bumpmap,xs.normalmap,xs.displacementmap,xs.roughnessmap,xs.metalnessmap,xs.fog,xs.lights,{emissive:{value:new X(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:_s.meshphysical_vert,fragmentShader:_s.meshphysical_frag},points:{uniforms:Ms.merge([xs.points,xs.fog]),vertexShader:_s.points_vert,fragmentShader:_s.points_frag},dashed:{uniforms:Ms.merge([xs.common,xs.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:_s.linedashed_vert,fragmentShader:_s.linedashed_frag},depth:{uniforms:Ms.merge([xs.common,xs.displacementmap]),vertexShader:_s.depth_vert,fragmentShader:_s.depth_frag},normal:{uniforms:Ms.merge([xs.common,xs.bumpmap,xs.normalmap,xs.displacementmap,{opacity:{value:1}}]),vertexShader:_s.normal_vert,fragmentShader:_s.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:_s.cube_vert,fragmentShader:_s.cube_frag},equirect:{uniforms:{tEquirect:{value:null},tFlip:{value:-1}},vertexShader:_s.equirect_vert,fragmentShader:_s.equirect_frag},distanceRGBA:{uniforms:{lightPos:{value:new l}},vertexShader:_s.distanceRGBA_vert,fragmentShader:_s.distanceRGBA_frag}};Cs.physical={uniforms:Ms.merge([Cs.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:_s.meshphysical_vert,fragmentShader:_s.meshphysical_frag},Object.assign(Y.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new n;return function(t,n){var i=e.copy(n).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new n;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new n;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return(t||new n).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return(t||new n).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new n;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}});var Is=0;Object.assign(K.prototype,t.prototype,{isMaterial:!0,setValues:function(e){if(void 0!==e)for(var t in e){var n=e[t];if(void 0!==n){var i=this[t];void 0!==i?i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[t]="overdraw"===t?Number(n):n:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){function t(e){var t=[];for(var n in e){var i=e[n];delete i.metadata,t.push(i)}return t}var n=void 0===e;n&&(e={textures:{},images:{}});var i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearCoat&&(i.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(i.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,i.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),void 0!==this.positionOffset&&(i.positionOffset=this.positionOffset),void 0!==this.sizeAttribute&&(i.sizeAttribute=this.sizeAttribute),this.blending!==Ma&&(i.blending=this.blending),this.shading!==va&&(i.shading=this.shading),this.side!==fa&&(i.side=this.side),this.vertexColors!==ya&&(i.vertexColors=this.vertexColors),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),i.skinning=this.skinning,i.morphTargets=this.morphTargets,i.dithering=this.dithering,n){var r=t(e.textures),a=t(e.images);r.length>0&&(i.textures=r),a.length>0&&(i.images=a)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.shading=e.shading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,n=null;if(null!==t){var i=t.length;n=new Array(i);for(var r=0;r!==i;++r)n[r]=t[r].clone()}return this.clippingPlanes=n,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Q.prototype=Object.create(K.prototype),Q.prototype.constructor=Q,Q.prototype.isShaderMaterial=!0,Q.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Ms.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},Q.prototype.toJSON=function(e){var t=K.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},J.prototype=Object.create(K.prototype),J.prototype.constructor=J,J.prototype.isMeshDepthMaterial=!0,J.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},Object.assign($.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,n=1/0,i=1/0,r=-1/0,a=-1/0,o=-1/0,s=0,l=e.length;s<l;s+=3){var u=e[s],c=e[s+1],h=e[s+2];u<t&&(t=u),c<n&&(n=c),h<i&&(i=h),u>r&&(r=u),c>a&&(a=c),h>o&&(o=h)}return this.min.set(t,n,i),this.max.set(r,a,o),this},setFromBufferAttribute:function(e){for(var t=1/0,n=1/0,i=1/0,r=-1/0,a=-1/0,o=-1/0,s=0,l=e.count;s<l;s++){var u=e.getX(s),c=e.getY(s),h=e.getZ(s);u<t&&(t=u),c<n&&(n=c),h<i&&(i=h),u>r&&(r=u),c>a&&(a=c),h>o&&(o=h)}return this.min.set(t,n,i),this.max.set(r,a,o),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new l;return function(t,n){var i=e.copy(n).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}}(),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new l;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new l;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var e=new l;return function(t){var n=this;return t.updateMatrixWorld(!0),t.traverse(function(t){var i,r,a=t.geometry;if(void 0!==a)if(a.isGeometry){var o=a.vertices;for(i=0,r=o.length;i<r;i++)e.copy(o[i]),e.applyMatrix4(t.matrixWorld),n.expandByPoint(e)}else if(a.isBufferGeometry){var s=a.attributes.position;if(void 0!==s)for(i=0,r=s.count;i<r;i++)e.fromBufferAttribute(s,i).applyMatrix4(t.matrixWorld),n.expandByPoint(e)}}),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new l).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:function(){var e=new l;return function(t){return this.clampPoint(t.center,e),e.distanceToSquared(t.center)<=t.radius*t.radius}}(),intersectsPlane:function(e){var t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=e.constant&&n>=e.constant},clampPoint:function(e,t){return(t||new l).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new l;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),getBoundingSphere:function(){var e=new l;return function(t){var n=t||new ee;return this.getCenter(n.center),n.radius=.5*this.getSize(e).length(),n}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new l,new l,new l,new l,new l,new l,new l,new l];return function(t){return this.isEmpty()?this:(e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(e),this)}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(ee.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var e=new $;return function(t,n){var i=this.center;void 0!==n?i.copy(n):e.setFromPoints(t).getCenter(i);for(var r=0,a=0,o=t.length;a<o;a++)r=Math.max(r,i.distanceToSquared(t[a]));return this.radius=Math.sqrt(r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(this.center.dot(e.normal)-e.constant)<=this.radius},clampPoint:function(e,t){var n=this.center.distanceToSquared(e),i=t||new l;return i.copy(e),n>this.radius*this.radius&&(i.sub(this.center).normalize(),i.multiplyScalar(this.radius).add(this.center)),i},getBoundingBox:function(e){var t=e||new $;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.assign(te.prototype,{isMatrix3:!0,set:function(e,t,n,i,r,a,o,s,l){var u=this.elements;return u[0]=e,u[1]=i,u[2]=o,u[3]=t,u[4]=r,u[5]=s,u[6]=n,u[7]=a,u[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var e=new l;return function(t){for(var n=0,i=t.count;n<i;n++)e.x=t.getX(n),e.y=t.getY(n),e.z=t.getZ(n),e.applyMatrix3(this),t.setXYZ(n,e.x,e.y,e.z);return t}}(),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var n=e.elements,i=t.elements,r=this.elements,a=n[0],o=n[3],s=n[6],l=n[1],u=n[4],c=n[7],h=n[2],d=n[5],f=n[8],p=i[0],m=i[3],g=i[6],v=i[1],y=i[4],E=i[7],b=i[2],x=i[5],M=i[8];return r[0]=a*p+o*v+s*b,r[3]=a*m+o*y+s*x,r[6]=a*g+o*E+s*M,r[1]=l*p+u*v+c*b,r[4]=l*m+u*y+c*x,r[7]=l*g+u*E+c*M,r[2]=h*p+d*v+f*b,r[5]=h*m+d*y+f*x,r[8]=h*g+d*E+f*M,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*a*u-t*o*l-n*r*u+n*o*s+i*r*l-i*a*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3.getInverse no longer takes a Matrix4 argument.");var n=e.elements,i=this.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],d=n[8],f=d*l-u*h,p=u*c-d*s,m=h*s-l*c,g=r*f+a*p+o*m;if(0===g){var v="THREE.Matrix3.getInverse(): can't invert matrix, determinant is 0";if(!0===t)throw new Error(v);return console.warn(v),this.identity()}var y=1/g;return i[0]=f*y,i[1]=(o*h-d*a)*y,i[2]=(u*a-o*l)*y,i[3]=p*y,i[4]=(d*r-o*c)*y,i[5]=(o*s-u*r)*y,i[6]=m*y,i[7]=(a*c-h*r)*y,i[8]=(l*r-a*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},equals:function(e){for(var t=this.elements,n=e.elements,i=0;i<9;i++)if(t[i]!==n[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var n=0;n<9;n++)this.elements[n]=e[n+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}}),Object.assign(ne.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,n,i){return this.normal.set(e,t,n),this.constant=i,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new l,t=new l;return function(n,i,r){var a=e.subVectors(r,i).cross(t.subVectors(n,i)).normalize();return this.setFromNormalAndCoplanarPoint(a,n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var n=this.distanceToPoint(e);return(t||new l).copy(this.normal).multiplyScalar(n)},intersectLine:function(){var e=new l;return function(t,n){var i=n||new l,r=t.delta(e),a=this.normal.dot(r);if(0!==a){var o=-(t.start.dot(this.normal)+this.constant)/a;if(!(o<0||o>1))return i.copy(r).multiplyScalar(o).add(t.start)}else if(0===this.distanceToPoint(t.start))return i.copy(t.start)}}(),intersectsLine:function(e){var t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return(e||new l).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new l,t=new te;return function(n,i){var r=this.coplanarPoint(e).applyMatrix4(n),a=i||t.getNormalMatrix(n),o=this.normal.applyMatrix3(a).normalize();return this.constant=-r.dot(o),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(ie.prototype,{set:function(e,t,n,i,r,a){var o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(n),o[3].copy(i),o[4].copy(r),o[5].copy(a),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,n=0;n<6;n++)t[n].copy(e.planes[n]);return this},setFromMatrix:function(e){var t=this.planes,n=e.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],u=n[6],c=n[7],h=n[8],d=n[9],f=n[10],p=n[11],m=n[12],g=n[13],v=n[14],y=n[15];return t[0].setComponents(o-i,c-s,p-h,y-m).normalize(),t[1].setComponents(o+i,c+s,p+h,y+m).normalize(),t[2].setComponents(o+r,c+l,p+d,y+g).normalize(),t[3].setComponents(o-r,c-l,p-d,y-g).normalize(),t[4].setComponents(o-a,c-u,p-f,y-v).normalize(),t[5].setComponents(o+a,c+u,p+f,y+v).normalize(),this},intersectsObject:function(){var e=new ee;return function(t){var n=t.geometry;return null===n.boundingSphere&&n.computeBoundingSphere(),e.copy(n.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSprite:function(){var e=new ee;return function(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,n=e.center,i=-e.radius,r=0;r<6;r++){if(t[r].distanceToPoint(n)<i)return!1}return!0},intersectsBox:function(){var e=new l,t=new l;return function(n){for(var i=this.planes,r=0;r<6;r++){var a=i[r];e.x=a.normal.x>0?n.min.x:n.max.x,t.x=a.normal.x>0?n.max.x:n.min.x,e.y=a.normal.y>0?n.min.y:n.max.y,t.y=a.normal.y>0?n.max.y:n.min.y,e.z=a.normal.z>0?n.min.z:n.max.z,t.z=a.normal.z>0?n.max.z:n.min.z;var o=a.distanceToPoint(e),s=a.distanceToPoint(t);if(o<0&&s<0)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}}),Object.assign(ae.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return(t||new l).copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new l;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var n=t||new l;n.subVectors(e,this.origin);var i=n.dot(this.direction);return i<0?n.copy(this.origin):n.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new l;return function(t){var n=e.subVectors(t,this.origin).dot(this.direction);return n<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(n).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:function(){var e=new l,t=new l,n=new l;return function(i,r,a,o){e.copy(i).add(r).multiplyScalar(.5),t.copy(r).sub(i).normalize(),n.copy(this.origin).sub(e);var s,l,u,c,h=.5*i.distanceTo(r),d=-this.direction.dot(t),f=n.dot(this.direction),p=-n.dot(t),m=n.lengthSq(),g=Math.abs(1-d*d);if(g>0)if(s=d*p-f,l=d*f-p,c=h*g,s>=0)if(l>=-c)if(l<=c){var v=1/g;s*=v,l*=v,u=s*(s+d*l+2*f)+l*(d*s+l+2*p)+m}else l=h,s=Math.max(0,-(d*l+f)),u=-s*s+l*(l+2*p)+m;else l=-h,s=Math.max(0,-(d*l+f)),u=-s*s+l*(l+2*p)+m;else l<=-c?(s=Math.max(0,-(-d*h+f)),l=s>0?-h:Math.min(Math.max(-h,-p),h),u=-s*s+l*(l+2*p)+m):l<=c?(s=0,l=Math.min(Math.max(-h,-p),h),u=l*(l+2*p)+m):(s=Math.max(0,-(d*h+f)),l=s>0?h:Math.min(Math.max(-h,-p),h),u=-s*s+l*(l+2*p)+m);else l=d>0?-h:h,s=Math.max(0,-(d*l+f)),u=-s*s+l*(l+2*p)+m;return a&&a.copy(this.direction).multiplyScalar(s).add(this.origin),o&&o.copy(t).multiplyScalar(l).add(e),u}}(),intersectSphere:function(){var e=new l;return function(t,n){e.subVectors(t.center,this.origin);var i=e.dot(this.direction),r=e.dot(e)-i*i,a=t.radius*t.radius;if(r>a)return null;var o=Math.sqrt(a-r),s=i-o,l=i+o;return s<0&&l<0?null:s<0?this.at(l,n):this.at(s,n)}}(),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null},intersectPlane:function(e,t){var n=this.distanceToPlane(e);return null===n?null:this.at(n,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var n,i,r,a,o,s,l=1/this.direction.x,u=1/this.direction.y,c=1/this.direction.z,h=this.origin;return l>=0?(n=(e.min.x-h.x)*l,i=(e.max.x-h.x)*l):(n=(e.max.x-h.x)*l,i=(e.min.x-h.x)*l),u>=0?(r=(e.min.y-h.y)*u,a=(e.max.y-h.y)*u):(r=(e.max.y-h.y)*u,a=(e.min.y-h.y)*u),n>a||r>i?null:((r>n||n!==n)&&(n=r),(a<i||i!==i)&&(i=a),c>=0?(o=(e.min.z-h.z)*c,s=(e.max.z-h.z)*c):(o=(e.max.z-h.z)*c,s=(e.min.z-h.z)*c),n>s||o>i?null:((o>n||n!==n)&&(n=o),(s<i||i!==i)&&(i=s),i<0?null:this.at(n>=0?n:i,t)))},intersectsBox:function(){var e=new l;return function(t){return null!==this.intersectBox(t,e)}}(),intersectTriangle:function(){var e=new l,t=new l,n=new l,i=new l;return function(r,a,o,s,l){t.subVectors(a,r),n.subVectors(o,r),i.crossVectors(t,n);var u,c=this.direction.dot(i);if(c>0){if(s)return null;u=1}else{if(!(c<0))return null;u=-1,c=-c}e.subVectors(this.origin,r);var h=u*this.direction.dot(n.crossVectors(e,n));if(h<0)return null;var d=u*this.direction.dot(t.cross(e));if(d<0)return null;if(h+d>c)return null;var f=-u*e.dot(i);return f<0?null:this.at(f/c,l)}}(),applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),oe.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],oe.DefaultOrder="XYZ",Object.defineProperties(oe.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(oe.prototype,{isEuler:!0,set:function(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._order=i||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,n){var i=hs.clamp,r=e.elements,a=r[0],o=r[4],s=r[8],l=r[1],u=r[5],c=r[9],h=r[2],d=r[6],f=r[10];return t=t||this._order,"XYZ"===t?(this._y=Math.asin(i(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-c,f),this._z=Math.atan2(-o,a)):(this._x=Math.atan2(d,u),this._z=0)):"YXZ"===t?(this._x=Math.asin(-i(c,-1,1)),Math.abs(c)<.99999?(this._y=Math.atan2(s,f),this._z=Math.atan2(l,u)):(this._y=Math.atan2(-h,a),this._z=0)):"ZXY"===t?(this._x=Math.asin(i(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-h,f),this._z=Math.atan2(-o,u)):(this._y=0,this._z=Math.atan2(l,a))):"ZYX"===t?(this._y=Math.asin(-i(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(d,f),this._z=Math.atan2(l,a)):(this._x=0,
this._z=Math.atan2(-o,u))):"YZX"===t?(this._z=Math.asin(i(l,-1,1)),Math.abs(l)<.99999?(this._x=Math.atan2(-c,u),this._y=Math.atan2(-h,a)):(this._x=0,this._y=Math.atan2(s,f))):"XZY"===t?(this._z=Math.asin(-i(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(d,u),this._y=Math.atan2(s,a)):(this._x=Math.atan2(-c,f),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==n&&this.onChangeCallback(),this},setFromQuaternion:function(){var e=new u;return function(t,n,i){return e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,n,i)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(){var e=new s;return function(t){return e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new l(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(se.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!=(this.mask&e.mask)}});var Os=0;le.DefaultUp=new l(0,1,0),le.DefaultMatrixAutoUpdate=!0,Object.assign(le.prototype,t.prototype,{isObject3D:!0,applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var e=new s;return function(t,n){return e.setFromAxisAngle(t,n),this.quaternion.multiply(e),this}}(),rotateX:function(){var e=new l(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new l(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new l(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new l;return function(t,n){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(n)),this}}(),translateX:function(){var e=new l(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new l(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new l(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var e=new u;return function(t){return t.applyMatrix4(e.getInverse(this.matrixWorld))}}(),lookAt:function(){var e=new u;return function(t){this.isCamera?e.lookAt(this.position,t,this.up):e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1)for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);var n=this.children.indexOf(e);-1!==n&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(n,1))},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var n=0,i=this.children.length;n<i;n++){var r=this.children[n],a=r.getObjectByProperty(e,t);if(void 0!==a)return a}},getWorldPosition:function(e){var t=e||new l;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var e=new l,t=new l;return function(n){var i=n||new s;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,i,t),i}}(),getWorldRotation:function(){var e=new s;return function(t){var n=t||new oe;return this.getWorldQuaternion(e),n.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new l,t=new s;return function(n){var i=n||new l;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,i),i}}(),getWorldDirection:function(){var e=new s;return function(t){var n=t||new l;return this.getWorldQuaternion(e),n.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,n=0,i=t.length;n<i;n++)t[n].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,n=0,i=t.length;n<i;n++)t[n].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,n=0,i=t.length;n<i;n++)t[n].updateMatrixWorld(e)},toJSON:function(e){function t(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}function n(e){var t=[];for(var n in e){var i=e[n];delete i.metadata,t.push(i)}return t}var i=void 0===e||""===e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var a={};if(a.uuid=this.uuid,a.type=this.type,""!==this.name&&(a.name=this.name),"{}"!==JSON.stringify(this.userData)&&(a.userData=this.userData),!0===this.castShadow&&(a.castShadow=!0),!0===this.receiveShadow&&(a.receiveShadow=!0),!1===this.visible&&(a.visible=!1),a.matrix=this.matrix.toArray(),void 0!==this.geometry&&(a.geometry=t(e.geometries,this.geometry)),void 0!==this.material)if(Array.isArray(this.material)){for(var o=[],s=0,l=this.material.length;s<l;s++)o.push(t(e.materials,this.material[s]));a.material=o}else a.material=t(e.materials,this.material);if(this.children.length>0){a.children=[];for(var s=0;s<this.children.length;s++)a.children.push(this.children[s].toJSON(e).object)}if(i){var u=n(e.geometries),c=n(e.materials),h=n(e.textures),d=n(e.images);u.length>0&&(r.geometries=u),c.length>0&&(r.materials=c),h.length>0&&(r.textures=h),d.length>0&&(r.images=d)}return r.object=a,r},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var n=0;n<e.children.length;n++){var i=e.children[n];this.add(i.clone())}return this}}),Object.assign(ue.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){return(e||new l).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return(e||new l).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var n=t||new l;return this.delta(n).multiplyScalar(e).add(this.start)},closestPointToPointParameter:function(){var e=new l,t=new l;return function(n,i){e.subVectors(n,this.start),t.subVectors(this.end,this.start);var r=t.dot(t),a=t.dot(e),o=a/r;return i&&(o=hs.clamp(o,0,1)),o}}(),closestPointToPoint:function(e,t,n){var i=this.closestPointToPointParameter(e,t),r=n||new l;return this.delta(r).multiplyScalar(i).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}}),Object.assign(ce,{normal:function(){var e=new l;return function(t,n,i,r){var a=r||new l;a.subVectors(i,n),e.subVectors(t,n),a.cross(e);var o=a.lengthSq();return o>0?a.multiplyScalar(1/Math.sqrt(o)):a.set(0,0,0)}}(),barycoordFromPoint:function(){var e=new l,t=new l,n=new l;return function(i,r,a,o,s){e.subVectors(o,r),t.subVectors(a,r),n.subVectors(i,r);var u=e.dot(e),c=e.dot(t),h=e.dot(n),d=t.dot(t),f=t.dot(n),p=u*d-c*c,m=s||new l;if(0===p)return m.set(-2,-1,-1);var g=1/p,v=(d*h-c*f)*g,y=(u*f-c*h)*g;return m.set(1-v-y,y,v)}}(),containsPoint:function(){var e=new l;return function(t,n,i,r){var a=ce.barycoordFromPoint(t,n,i,r,e);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}()}),Object.assign(ce.prototype,{set:function(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this},setFromPointsAndIndices:function(e,t,n,i){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[i]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new l,t=new l;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){return(e||new l).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return ce.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new ne).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return ce.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return ce.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:function(){var e=new ne,t=[new ue,new ue,new ue],n=new l,i=new l;return function(r,a){var o=a||new l,s=1/0;if(e.setFromCoplanarPoints(this.a,this.b,this.c),e.projectPoint(r,n),!0===this.containsPoint(n))o.copy(n);else{t[0].set(this.a,this.b),t[1].set(this.b,this.c),t[2].set(this.c,this.a);for(var u=0;u<t.length;u++){t[u].closestPointToPoint(n,!0,i);var c=n.distanceToSquared(i);c<s&&(s=c,o.copy(i))}}return o}}(),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),Object.assign(he.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,n=e.vertexNormals.length;t<n;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(var t=0,n=e.vertexColors.length;t<n;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}),de.prototype=Object.create(K.prototype),de.prototype.constructor=de,de.prototype.isMeshBasicMaterial=!0,de.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},Object.defineProperty(fe.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(fe.prototype,{isBufferAttribute:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,n){e*=this.itemSize,n*=t.itemSize;for(var i=0,r=this.itemSize;i<r;i++)this.array[e+i]=t.array[n+i];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,n=0,i=0,r=e.length;i<r;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",i),a=new X),t[n++]=a.r,t[n++]=a.g,t[n++]=a.b}return this},copyIndicesArray:function(e){for(var t=this.array,n=0,i=0,r=e.length;i<r;i++){var a=e[i];t[n++]=a.a,t[n++]=a.b,t[n++]=a.c}return this},copyVector2sArray:function(e){for(var t=this.array,i=0,r=0,a=e.length;r<a;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",r),o=new n),t[i++]=o.x,t[i++]=o.y}return this},copyVector3sArray:function(e){for(var t=this.array,n=0,i=0,r=e.length;i<r;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",i),a=new l),t[n++]=a.x,t[n++]=a.y,t[n++]=a.z}return this},copyVector4sArray:function(e){for(var t=this.array,n=0,i=0,a=e.length;i<a;i++){var o=e[i];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",i),o=new r),t[n++]=o.x,t[n++]=o.y,t[n++]=o.z,t[n++]=o.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=n,this},setXYZ:function(e,t,n,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this},setXYZW:function(e,t,n,i,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this.array[e+3]=r,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),pe.prototype=Object.create(fe.prototype),pe.prototype.constructor=pe,me.prototype=Object.create(fe.prototype),me.prototype.constructor=me,ge.prototype=Object.create(fe.prototype),ge.prototype.constructor=ge,ve.prototype=Object.create(fe.prototype),ve.prototype.constructor=ve,ye.prototype=Object.create(fe.prototype),ye.prototype.constructor=ye,Ee.prototype=Object.create(fe.prototype),Ee.prototype.constructor=Ee,be.prototype=Object.create(fe.prototype),be.prototype.constructor=be,xe.prototype=Object.create(fe.prototype),xe.prototype.constructor=xe,Me.prototype=Object.create(fe.prototype),Me.prototype.constructor=Me,Object.assign(_e.prototype,{computeGroups:function(e){for(var t,n=[],i=void 0,r=e.faces,a=0;a<r.length;a++){var o=r[a];o.materialIndex!==i&&(i=o.materialIndex,void 0!==t&&(t.count=3*a-t.start,n.push(t)),t={start:3*a,materialIndex:i})}void 0!==t&&(t.count=3*a-t.start,n.push(t)),this.groups=n},fromGeometry:function(e){var t,i=e.faces,r=e.vertices,a=e.faceVertexUvs,o=a[0]&&a[0].length>0,s=a[1]&&a[1].length>0,l=e.morphTargets,u=l.length;if(u>0){t=[];for(var c=0;c<u;c++)t[c]=[];this.morphTargets.position=t}var h,d=e.morphNormals,f=d.length;if(f>0){h=[];for(var c=0;c<f;c++)h[c]=[];this.morphTargets.normal=h}for(var p=e.skinIndices,m=e.skinWeights,g=p.length===r.length,v=m.length===r.length,c=0;c<i.length;c++){var y=i[c];this.vertices.push(r[y.a],r[y.b],r[y.c]);var E=y.vertexNormals;if(3===E.length)this.normals.push(E[0],E[1],E[2]);else{var b=y.normal;this.normals.push(b,b,b)}var x=y.vertexColors;if(3===x.length)this.colors.push(x[0],x[1],x[2]);else{var M=y.color;this.colors.push(M,M,M)}if(!0===o){var _=a[0][c];void 0!==_?this.uvs.push(_[0],_[1],_[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",c),this.uvs.push(new n,new n,new n))}if(!0===s){var _=a[1][c];void 0!==_?this.uvs2.push(_[0],_[1],_[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",c),this.uvs2.push(new n,new n,new n))}for(var C=0;C<u;C++){var I=l[C].vertices;t[C].push(I[y.a],I[y.b],I[y.c])}for(var C=0;C<f;C++){var O=d[C].vertexNormals[c];h[C].push(O.a,O.b,O.c)}g&&this.skinIndices.push(p[y.a],p[y.b],p[y.c]),v&&this.skinWeights.push(m[y.a],m[y.b],m[y.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}});var Ts=0;Object.assign(Oe.prototype,t.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new te).getNormalMatrix(e),n=0,i=this.vertices.length;n<i;n++){this.vertices[n].applyMatrix4(e)}for(var n=0,i=this.faces.length;n<i;n++){var r=this.faces[n];r.normal.applyMatrix3(t).normalize();for(var a=0,o=r.vertexNormals.length;a<o;a++)r.vertexNormals[a].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e=new u;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new u;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new u;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new u;return function(t,n,i){return e.makeTranslation(t,n,i),this.applyMatrix(e),this}}(),scale:function(){var e=new u;return function(t,n,i){return e.makeScale(t,n,i),this.applyMatrix(e),this}}(),lookAt:function(){var e=new le;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),fromBufferGeometry:function(e){function t(e,t,n,r){var a=void 0!==s?[d[e].clone(),d[t].clone(),d[n].clone()]:[],o=void 0!==u?[i.colors[e].clone(),i.colors[t].clone(),i.colors[n].clone()]:[],l=new he(e,t,n,a,o,r);i.faces.push(l),void 0!==c&&i.faceVertexUvs[0].push([f[e].clone(),f[t].clone(),f[n].clone()]),void 0!==h&&i.faceVertexUvs[1].push([p[e].clone(),p[t].clone(),p[n].clone()])}var i=this,r=null!==e.index?e.index.array:void 0,a=e.attributes,o=a.position.array,s=void 0!==a.normal?a.normal.array:void 0,u=void 0!==a.color?a.color.array:void 0,c=void 0!==a.uv?a.uv.array:void 0,h=void 0!==a.uv2?a.uv2.array:void 0;void 0!==h&&(this.faceVertexUvs[1]=[]);for(var d=[],f=[],p=[],m=0,g=0;m<o.length;m+=3,g+=2)i.vertices.push(new l(o[m],o[m+1],o[m+2])),void 0!==s&&d.push(new l(s[m],s[m+1],s[m+2])),void 0!==u&&i.colors.push(new X(u[m],u[m+1],u[m+2])),void 0!==c&&f.push(new n(c[g],c[g+1])),void 0!==h&&p.push(new n(h[g],h[g+1]));var v=e.groups;if(v.length>0)for(var m=0;m<v.length;m++)for(var y=v[m],E=y.start,b=y.count,g=E,x=E+b;g<x;g+=3)void 0!==r?t(r[g],r[g+1],r[g+2],y.materialIndex):t(g,g+1,g+2,y.materialIndex);else if(void 0!==r)for(var m=0;m<r.length;m+=3)t(r[m],r[m+1],r[m+2]);else for(var m=0;m<o.length/3;m+=3)t(m,m+1,m+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,n=0===t?1:1/t,i=new u;return i.set(n,0,0,-n*e.x,0,n,0,-n*e.y,0,0,n,-n*e.z,0,0,0,1),this.applyMatrix(i),this},computeFaceNormals:function(){for(var e=new l,t=new l,n=0,i=this.faces.length;n<i;n++){var r=this.faces[n],a=this.vertices[r.a],o=this.vertices[r.b],s=this.vertices[r.c];e.subVectors(s,o),t.subVectors(a,o),e.cross(t),e.normalize(),r.normal.copy(e)}},computeVertexNormals:function(e){void 0===e&&(e=!0);var t,n,i,r,a,o;for(o=new Array(this.vertices.length),t=0,n=this.vertices.length;t<n;t++)o[t]=new l;if(e){var s,u,c,h=new l,d=new l;for(i=0,r=this.faces.length;i<r;i++)a=this.faces[i],s=this.vertices[a.a],u=this.vertices[a.b],c=this.vertices[a.c],h.subVectors(c,u),d.subVectors(s,u),h.cross(d),o[a.a].add(h),o[a.b].add(h),o[a.c].add(h)}else for(this.computeFaceNormals(),i=0,r=this.faces.length;i<r;i++)a=this.faces[i],o[a.a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal);for(t=0,n=this.vertices.length;t<n;t++)o[t].normalize();for(i=0,r=this.faces.length;i<r;i++){a=this.faces[i];var f=a.vertexNormals;3===f.length?(f[0].copy(o[a.a]),f[1].copy(o[a.b]),f[2].copy(o[a.c])):(f[0]=o[a.a].clone(),f[1]=o[a.b].clone(),f[2]=o[a.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,n;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){n=this.faces[e];var i=n.vertexNormals;3===i.length?(i[0].copy(n.normal),i[1].copy(n.normal),i[2].copy(n.normal)):(i[0]=n.normal.clone(),i[1]=n.normal.clone(),i[2]=n.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,n,i,r;for(n=0,i=this.faces.length;n<i;n++)for(r=this.faces[n],r.__originalFaceNormal?r.__originalFaceNormal.copy(r.normal):r.__originalFaceNormal=r.normal.clone(),r.__originalVertexNormals||(r.__originalVertexNormals=[]),e=0,t=r.vertexNormals.length;e<t;e++)r.__originalVertexNormals[e]?r.__originalVertexNormals[e].copy(r.vertexNormals[e]):r.__originalVertexNormals[e]=r.vertexNormals[e].clone();var a=new Oe;for(a.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var o,s,u=this.morphNormals[e].faceNormals,c=this.morphNormals[e].vertexNormals;for(n=0,i=this.faces.length;n<i;n++)o=new l,s={a:new l,b:new l,c:new l},u.push(o),c.push(s)}var h=this.morphNormals[e];a.vertices=this.morphTargets[e].vertices,a.computeFaceNormals(),a.computeVertexNormals();var o,s;for(n=0,i=this.faces.length;n<i;n++)r=this.faces[n],o=h.faceNormals[n],s=h.vertexNormals[n],o.copy(r.normal),s.a.copy(r.vertexNormals[0]),s.b.copy(r.vertexNormals[1]),s.c.copy(r.vertexNormals[2])}for(n=0,i=this.faces.length;n<i;n++)r=this.faces[n],r.normal=r.__originalFaceNormal,r.vertexNormals=r.__originalVertexNormals},computeLineDistances:function(){for(var e=0,t=this.vertices,n=0,i=t.length;n<i;n++)n>0&&(e+=t[n].distanceTo(t[n-1])),this.lineDistances[n]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new $),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new ee),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,n){if(!1===(e&&e.isGeometry))return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);var i,r=this.vertices.length,a=this.vertices,o=e.vertices,s=this.faces,l=e.faces,u=this.faceVertexUvs[0],c=e.faceVertexUvs[0],h=this.colors,d=e.colors;void 0===n&&(n=0),void 0!==t&&(i=(new te).getNormalMatrix(t));for(var f=0,p=o.length;f<p;f++){var m=o[f],g=m.clone();void 0!==t&&g.applyMatrix4(t),a.push(g)}for(var f=0,p=d.length;f<p;f++)h.push(d[f].clone());for(f=0,p=l.length;f<p;f++){var v,y,E,b=l[f],x=b.vertexNormals,M=b.vertexColors;v=new he(b.a+r,b.b+r,b.c+r),v.normal.copy(b.normal),void 0!==i&&v.normal.applyMatrix3(i).normalize();for(var _=0,C=x.length;_<C;_++)y=x[_].clone(),void 0!==i&&y.applyMatrix3(i).normalize(),v.vertexNormals.push(y);v.color.copy(b.color);for(var _=0,C=M.length;_<C;_++)E=M[_],v.vertexColors.push(E.clone());v.materialIndex=b.materialIndex+n,s.push(v)}for(f=0,p=c.length;f<p;f++){var I=c[f],O=[];if(void 0!==I){for(var _=0,C=I.length;_<C;_++)O.push(I[_].clone());u.push(O)}}},mergeMesh:function(e){if(!1===(e&&e.isMesh))return void console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e);e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)},mergeVertices:function(){var e,t,n,i,r,a,o,s,l={},u=[],c=[],h=Math.pow(10,4);for(n=0,i=this.vertices.length;n<i;n++)e=this.vertices[n],t=Math.round(e.x*h)+"_"+Math.round(e.y*h)+"_"+Math.round(e.z*h),void 0===l[t]?(l[t]=n,u.push(this.vertices[n]),c[n]=u.length-1):c[n]=c[l[t]];var d=[];for(n=0,i=this.faces.length;n<i;n++){r=this.faces[n],r.a=c[r.a],r.b=c[r.b],r.c=c[r.c],a=[r.a,r.b,r.c];for(var f=0;f<3;f++)if(a[f]===a[(f+1)%3]){d.push(n);break}}for(n=d.length-1;n>=0;n--){var p=d[n];for(this.faces.splice(p,1),o=0,s=this.faceVertexUvs.length;o<s;o++)this.faceVertexUvs[o].splice(p,1)}var m=this.vertices.length-u.length;return this.vertices=u,m},sortFacesByMaterialIndex:function(){function e(e,t){return e.materialIndex-t.materialIndex}for(var t=this.faces,n=t.length,i=0;i<n;i++)t[i]._id=i;t.sort(e);var r,a,o=this.faceVertexUvs[0],s=this.faceVertexUvs[1];o&&o.length===n&&(r=[]),s&&s.length===n&&(a=[]);for(var i=0;i<n;i++){var l=t[i]._id;r&&r.push(o[l]),a&&a.push(s[l])}r&&(this.faceVertexUvs[0]=r),a&&(this.faceVertexUvs[1]=a)},toJSON:function(){function e(e,t,n){return n?e|1<<t:e&~(1<<t)}function t(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==d[t]?d[t]:(d[t]=h.length/3,h.push(e.x,e.y,e.z),d[t])}function n(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==p[t]?p[t]:(p[t]=f.length,f.push(e.getHex()),p[t])}function i(e){var t=e.x.toString()+e.y.toString();return void 0!==g[t]?g[t]:(g[t]=m.length/2,m.push(e.x,e.y),g[t])}var r={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),void 0!==this.parameters){var a=this.parameters;for(var o in a)void 0!==a[o]&&(r[o]=a[o]);return r}for(var s=[],l=0;l<this.vertices.length;l++){var u=this.vertices[l];s.push(u.x,u.y,u.z)}for(var c=[],h=[],d={},f=[],p={},m=[],g={},l=0;l<this.faces.length;l++){var v=this.faces[l],y=void 0!==this.faceVertexUvs[0][l],E=v.normal.length()>0,b=v.vertexNormals.length>0,x=1!==v.color.r||1!==v.color.g||1!==v.color.b,M=v.vertexColors.length>0,_=0;if(_=e(_,0,0),_=e(_,1,!0),_=e(_,2,!1),_=e(_,3,y),_=e(_,4,E),_=e(_,5,b),_=e(_,6,x),_=e(_,7,M),c.push(_),c.push(v.a,v.b,v.c),c.push(v.materialIndex),y){var C=this.faceVertexUvs[0][l];c.push(i(C[0]),i(C[1]),i(C[2]))}if(E&&c.push(t(v.normal)),b){var I=v.vertexNormals;c.push(t(I[0]),t(I[1]),t(I[2]))}if(x&&c.push(n(v.color)),M){var O=v.vertexColors;c.push(n(O[0]),n(O[1]),n(O[2]))}}return r.data={},r.data.vertices=s,r.data.normals=h,f.length>0&&(r.data.colors=f),m.length>0&&(r.data.uvs=[m]),r.data.faces=c,r},clone:function(){return(new Oe).copy(this)},copy:function(e){var t,n,i,r,a,o;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var s=e.vertices;for(t=0,n=s.length;t<n;t++)this.vertices.push(s[t].clone());var l=e.colors;for(t=0,n=l.length;t<n;t++)this.colors.push(l[t].clone());var u=e.faces;for(t=0,n=u.length;t<n;t++)this.faces.push(u[t].clone());for(t=0,n=e.faceVertexUvs.length;t<n;t++){var c=e.faceVertexUvs[t];for(void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]),i=0,r=c.length;i<r;i++){var h=c[i],d=[];for(a=0,o=h.length;a<o;a++){var f=h[a];d.push(f.clone())}this.faceVertexUvs[t].push(d)}}var p=e.morphTargets;for(t=0,n=p.length;t<n;t++){var m={};if(m.name=p[t].name,void 0!==p[t].vertices)for(m.vertices=[],i=0,r=p[t].vertices.length;i<r;i++)m.vertices.push(p[t].vertices[i].clone());if(void 0!==p[t].normals)for(m.normals=[],i=0,r=p[t].normals.length;i<r;i++)m.normals.push(p[t].normals[i].clone());this.morphTargets.push(m)}var g=e.morphNormals;for(t=0,n=g.length;t<n;t++){var v={};if(void 0!==g[t].vertexNormals)for(v.vertexNormals=[],i=0,r=g[t].vertexNormals.length;i<r;i++){var y=g[t].vertexNormals[i],E={};E.a=y.a.clone(),E.b=y.b.clone(),E.c=y.c.clone(),v.vertexNormals.push(E)}if(void 0!==g[t].faceNormals)for(v.faceNormals=[],i=0,r=g[t].faceNormals.length;i<r;i++)v.faceNormals.push(g[t].faceNormals[i].clone());this.morphNormals.push(v)}var b=e.skinWeights;for(t=0,n=b.length;t<n;t++)this.skinWeights.push(b[t].clone());var x=e.skinIndices;for(t=0,n=x.length;t<n;t++)this.skinIndices.push(x[t].clone());var M=e.lineDistances;for(t=0,n=M.length;t<n;t++)this.lineDistances.push(M[t]);var _=e.boundingBox;null!==_&&(this.boundingBox=_.clone());var C=e.boundingSphere;return null!==C&&(this.boundingSphere=C.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Te.MaxIndex=65535,Object.assign(Te.prototype,t.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(Ce(e)>65535?be:ye)(e,1):this.index=e},addAttribute:function(e,t){return!1===(t&&t.isBufferAttribute)&&!1===(t&&t.isInterleavedBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new fe(arguments[1],arguments[2]))):"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this)},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,n){this.groups.push({start:e,count:t,materialIndex:void 0!==n?n:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var n=this.attributes.normal;if(void 0!==n){(new te).getNormalMatrix(e).applyToBufferAttribute(n),n.needsUpdate=!0}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e=new u;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new u;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new u;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new u;return function(t,n,i){return e.makeTranslation(t,n,i),this.applyMatrix(e),this}}(),scale:function(){var e=new u;return function(t,n,i){return e.makeScale(t,n,i),this.applyMatrix(e),this}}(),lookAt:function(){var e=new le;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e.isPoints||e.isLine){var n=new xe(3*t.vertices.length,3),i=new xe(3*t.colors.length,3);if(this.addAttribute("position",n.copyVector3sArray(t.vertices)),this.addAttribute("color",i.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){
var r=new xe(t.lineDistances.length,1);this.addAttribute("lineDistance",r.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},updateFromObject:function(e){var t=e.geometry;if(e.isMesh){var n=t.__directGeometry;if(!0===t.elementsNeedUpdate&&(n=void 0,t.elementsNeedUpdate=!1),void 0===n)return this.fromGeometry(t);n.verticesNeedUpdate=t.verticesNeedUpdate,n.normalsNeedUpdate=t.normalsNeedUpdate,n.colorsNeedUpdate=t.colorsNeedUpdate,n.uvsNeedUpdate=t.uvsNeedUpdate,n.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=n}var i;return!0===t.verticesNeedUpdate&&(i=this.attributes.position,void 0!==i&&(i.copyVector3sArray(t.vertices),i.needsUpdate=!0),t.verticesNeedUpdate=!1),!0===t.normalsNeedUpdate&&(i=this.attributes.normal,void 0!==i&&(i.copyVector3sArray(t.normals),i.needsUpdate=!0),t.normalsNeedUpdate=!1),!0===t.colorsNeedUpdate&&(i=this.attributes.color,void 0!==i&&(i.copyColorsArray(t.colors),i.needsUpdate=!0),t.colorsNeedUpdate=!1),t.uvsNeedUpdate&&(i=this.attributes.uv,void 0!==i&&(i.copyVector2sArray(t.uvs),i.needsUpdate=!0),t.uvsNeedUpdate=!1),t.lineDistancesNeedUpdate&&(i=this.attributes.lineDistance,void 0!==i&&(i.copyArray(t.lineDistances),i.needsUpdate=!0),t.lineDistancesNeedUpdate=!1),t.groupsNeedUpdate&&(t.computeGroups(e.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new _e).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new fe(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var n=new Float32Array(3*e.normals.length);this.addAttribute("normal",new fe(n,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var i=new Float32Array(3*e.colors.length);this.addAttribute("color",new fe(i,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var r=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new fe(r,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var a=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new fe(a,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var o=Ce(e.indices)>65535?Uint32Array:Uint16Array,s=new o(3*e.indices.length);this.setIndex(new fe(s,1).copyIndicesArray(e.indices))}this.groups=e.groups;for(var l in e.morphTargets){for(var u=[],c=e.morphTargets[l],h=0,d=c.length;h<d;h++){var f=c[h],p=new xe(3*f.length,3);u.push(p.copyVector3sArray(f))}this.morphAttributes[l]=u}if(e.skinIndices.length>0){var m=new xe(4*e.skinIndices.length,4);this.addAttribute("skinIndex",m.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var g=new xe(4*e.skinWeights.length,4);this.addAttribute("skinWeight",g.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new $);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new $,t=new l;return function(){null===this.boundingSphere&&(this.boundingSphere=new ee);var n=this.attributes.position;if(n){var i=this.boundingSphere.center;e.setFromBufferAttribute(n),e.getCenter(i);for(var r=0,a=0,o=n.count;a<o;a++)t.x=n.getX(a),t.y=n.getY(a),t.z=n.getZ(a),r=Math.max(r,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,n=this.groups;if(t.position){var i=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new fe(new Float32Array(i.length),3));else for(var r=t.normal.array,a=0,o=r.length;a<o;a++)r[a]=0;var s,u,c,h=t.normal.array,d=new l,f=new l,p=new l,m=new l,g=new l;if(e){var v=e.array;0===n.length&&this.addGroup(0,v.length);for(var y=0,E=n.length;y<E;++y)for(var b=n[y],x=b.start,M=b.count,a=x,o=x+M;a<o;a+=3)s=3*v[a+0],u=3*v[a+1],c=3*v[a+2],d.fromArray(i,s),f.fromArray(i,u),p.fromArray(i,c),m.subVectors(p,f),g.subVectors(d,f),m.cross(g),h[s]+=m.x,h[s+1]+=m.y,h[s+2]+=m.z,h[u]+=m.x,h[u+1]+=m.y,h[u+2]+=m.z,h[c]+=m.x,h[c+1]+=m.y,h[c+2]+=m.z}else for(var a=0,o=i.length;a<o;a+=9)d.fromArray(i,a),f.fromArray(i,a+3),p.fromArray(i,a+6),m.subVectors(p,f),g.subVectors(d,f),m.cross(g),h[a]=m.x,h[a+1]=m.y,h[a+2]=m.z,h[a+3]=m.x,h[a+4]=m.y,h[a+5]=m.z,h[a+6]=m.x,h[a+7]=m.y,h[a+8]=m.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(!1===(e&&e.isBufferGeometry))return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0);var n=this.attributes;for(var i in n)if(void 0!==e.attributes[i])for(var r=n[i],a=r.array,o=e.attributes[i],s=o.array,l=o.itemSize,u=0,c=l*t;u<s.length;u++,c++)a[c]=s[u];return this},normalizeNormals:function(){for(var e,t,n,i,r=this.attributes.normal,a=0,o=r.count;a<o;a++)e=r.getX(a),t=r.getY(a),n=r.getZ(a),i=1/Math.sqrt(e*e+t*t+n*n),r.setXYZ(a,e*i,t*i,n*i)},toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new Te,t=this.index.array,n=this.attributes;for(var i in n){for(var r=n[i],a=r.array,o=r.itemSize,s=new a.constructor(t.length*o),l=0,u=0,c=0,h=t.length;c<h;c++){l=t[c]*o;for(var d=0;d<o;d++)s[u++]=a[l++]}e.addAttribute(i,new fe(s,o))}return e},toJSON:function(){var e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};var i=this.index;if(null!==i){var r=Array.prototype.slice.call(i.array);e.data.index={type:i.array.constructor.name,array:r}}var a=this.attributes;for(var n in a){var o=a[n],r=Array.prototype.slice.call(o.array);e.data.attributes[n]={itemSize:o.itemSize,type:o.array.constructor.name,array:r,normalized:o.normalized}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var l=this.boundingSphere;return null!==l&&(e.data.boundingSphere={center:l.center.toArray(),radius:l.radius}),e},clone:function(){return(new Te).copy(this)},copy:function(e){var t,n,i;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var r=e.index;null!==r&&this.setIndex(r.clone());var a=e.attributes;for(t in a){var o=a[t];this.addAttribute(t,o.clone())}var s=e.morphAttributes;for(t in s){var l=[],u=s[t];for(n=0,i=u.length;n<i;n++)l.push(u[n].clone());this.morphAttributes[t]=l}var c=e.groups;for(n=0,i=c.length;n<i;n++){var h=c[n];this.addGroup(h.start,h.count,h.materialIndex)}var d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());var f=e.boundingSphere;return null!==f&&(this.boundingSphere=f.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Le.prototype=Object.assign(Object.create(le.prototype),{constructor:Le,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return le.prototype.copy.call(this,e),this.drawMode=e.drawMode,this},updateMorphTargets:function(){var e=this.geometry.morphTargets;if(void 0!==e&&e.length>0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var t=0,n=e.length;t<n;t++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[e[t].name]=t}},raycast:function(){function e(e,t,n,i,r,a,o){return ce.barycoordFromPoint(e,t,n,i,y),r.multiplyScalar(y.x),a.multiplyScalar(y.y),o.multiplyScalar(y.z),r.add(a).add(o),r.clone()}function t(e,t,n,i,r,a,o){var s=e.material;if(null===(s.side===pa?n.intersectTriangle(a,r,i,!0,o):n.intersectTriangle(i,r,a,s.side!==ma,o)))return null;b.copy(o),b.applyMatrix4(e.matrixWorld);var l=t.ray.origin.distanceTo(b);return l<t.near||l>t.far?null:{distance:l,point:b.clone(),object:e}}function i(n,i,r,a,o,l,u,d){s.fromBufferAttribute(a,l),c.fromBufferAttribute(a,u),h.fromBufferAttribute(a,d);var f=t(n,i,r,s,c,h,E);return f&&(o&&(m.fromBufferAttribute(o,l),g.fromBufferAttribute(o,u),v.fromBufferAttribute(o,d),f.uv=e(E,s,c,h,m,g,v)),f.face=new he(l,u,d,ce.normal(s,c,h)),f.faceIndex=l),f}var r=new u,a=new ae,o=new ee,s=new l,c=new l,h=new l,d=new l,f=new l,p=new l,m=new n,g=new n,v=new n,y=new l,E=new l,b=new l;return function(n,l){var u=this.geometry,y=this.material,b=this.matrixWorld;if(void 0!==y&&(null===u.boundingSphere&&u.computeBoundingSphere(),o.copy(u.boundingSphere),o.applyMatrix4(b),!1!==n.ray.intersectsSphere(o)&&(r.getInverse(b),a.copy(n.ray).applyMatrix4(r),null===u.boundingBox||!1!==a.intersectsBox(u.boundingBox)))){var x;if(u.isBufferGeometry){var M,_,C,I,O,T=u.index,L=u.attributes.position,S=u.attributes.uv;if(null!==T)for(I=0,O=T.count;I<O;I+=3)M=T.getX(I),_=T.getX(I+1),C=T.getX(I+2),(x=i(this,n,a,L,S,M,_,C))&&(x.faceIndex=Math.floor(I/3),l.push(x));else for(I=0,O=L.count;I<O;I+=3)M=I,_=I+1,C=I+2,(x=i(this,n,a,L,S,M,_,C))&&(x.index=M,l.push(x))}else if(u.isGeometry){var D,w,U,R,A=Array.isArray(y),N=u.vertices,P=u.faces,k=u.faceVertexUvs[0];k.length>0&&(R=k);for(var B=0,F=P.length;B<F;B++){var H=P[B],G=A?y[H.materialIndex]:y;if(void 0!==G){if(D=N[H.a],w=N[H.b],U=N[H.c],!0===G.morphTargets){var V=u.morphTargets,z=this.morphTargetInfluences;s.set(0,0,0),c.set(0,0,0),h.set(0,0,0);for(var j=0,W=V.length;j<W;j++){var X=z[j];if(0!==X){var Y=V[j].vertices;s.addScaledVector(d.subVectors(Y[H.a],D),X),c.addScaledVector(f.subVectors(Y[H.b],w),X),h.addScaledVector(p.subVectors(Y[H.c],U),X)}}s.add(D),c.add(w),h.add(U),D=s,w=c,U=h}if(x=t(this,n,a,D,w,U,E)){if(R&&R[B]){var q=R[B];m.copy(q[0]),g.copy(q[1]),v.copy(q[2]),x.uv=e(E,D,w,U,m,g,v)}x.face=H,x.faceIndex=B,l.push(x)}}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Se.prototype=Object.create(Oe.prototype),Se.prototype.constructor=Se,De.prototype=Object.create(Te.prototype),De.prototype.constructor=De,we.prototype=Object.create(Oe.prototype),we.prototype.constructor=we,Ue.prototype=Object.create(Te.prototype),Ue.prototype.constructor=Ue,Re.prototype=Object.assign(Object.create(le.prototype),{constructor:Re,isCamera:!0,copy:function(e){return le.prototype.copy.call(this,e),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},getWorldDirection:function(){var e=new s;return function(t){var n=t||new l;return this.getWorldQuaternion(e),n.set(0,0,-1).applyQuaternion(e)}}(),clone:function(){return(new this.constructor).copy(this)}}),Ae.prototype=Object.assign(Object.create(Re.prototype),{constructor:Ae,isPerspectiveCamera:!0,copy:function(e){return Re.prototype.copy.call(this,e),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*hs.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*hs.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*hs.RAD2DEG*Math.atan(Math.tan(.5*hs.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,n,i,r,a){this.aspect=e/t,this.view={fullWidth:e,fullHeight:t,offsetX:n,offsetY:i,width:r,height:a},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*hs.DEG2RAD*this.fov)/this.zoom,n=2*t,i=this.aspect*n,r=-.5*i,a=this.view;if(null!==a){var o=a.fullWidth,s=a.fullHeight;r+=a.offsetX*i/o,t-=a.offsetY*n/s,i*=a.width/o,n*=a.height/s}var l=this.filmOffset;0!==l&&(r+=e*l/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,t,t-n,e,this.far)},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),Ne.prototype=Object.assign(Object.create(Re.prototype),{constructor:Ne,isOrthographicCamera:!0,copy:function(e){return Re.prototype.copy.call(this,e),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,n,i,r,a){this.view={fullWidth:e,fullHeight:t,offsetX:n,offsetY:i,width:r,height:a},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2,r=n-e,a=n+e,o=i+t,s=i-t;if(null!==this.view){var l=this.zoom/(this.view.width/this.view.fullWidth),u=this.zoom/(this.view.height/this.view.fullHeight),c=(this.right-this.left)/this.view.width,h=(this.top-this.bottom)/this.view.height;r+=c*(this.view.offsetX/l),a=r+c*(this.view.width/l),o-=h*(this.view.offsetY/u),s=o-h*(this.view.height/u)}this.projectionMatrix.makeOrthographic(r,a,o,s,this.near,this.far)},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}});var Ls=0;pt.prototype.isFogExp2=!0,pt.prototype.clone=function(){return new pt(this.color.getHex(),this.density)},pt.prototype.toJSON=function(e){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},mt.prototype.isFog=!0,mt.prototype.clone=function(){return new mt(this.color.getHex(),this.near,this.far)},mt.prototype.toJSON=function(e){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},gt.prototype=Object.assign(Object.create(le.prototype),{constructor:gt,copy:function(e,t){return le.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}),vt.prototype=Object.assign(Object.create(le.prototype),{constructor:vt,isLensFlare:!0,copy:function(e){le.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,n=e.lensFlares.length;t<n;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,n,i,r,a){void 0===t&&(t=-1),void 0===n&&(n=0),void 0===a&&(a=1),void 0===r&&(r=new X(16777215)),void 0===i&&(i=Ma),n=Math.min(n,Math.max(0,n)),this.lensFlares.push({texture:e,size:t,distance:n,x:0,y:0,z:0,scale:1,rotation:0,opacity:a,color:r,blending:i})},updateLensFlares:function(){var e,t,n=this.lensFlares.length,i=2*-this.positionScreen.x,r=2*-this.positionScreen.y;for(e=0;e<n;e++)t=this.lensFlares[e],t.x=this.positionScreen.x+i*t.distance,t.y=this.positionScreen.y+r*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),yt.prototype=Object.create(K.prototype),yt.prototype.constructor=yt,yt.prototype.isSpriteMaterial=!0,yt.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},Et.prototype=Object.assign(Object.create(le.prototype),{constructor:Et,isSprite:!0,raycast:function(){var e=new l,t=new l,n=new l;return function(i,r){t.setFromMatrixPosition(this.matrixWorld),i.ray.closestPointToPoint(t,e),n.setFromMatrixScale(this.matrixWorld);var a=n.x*n.y/4;if(!(t.distanceToSquared(e)>a)){var o=i.ray.origin.distanceTo(e);o<i.near||o>i.far||r.push({distance:o,point:e.clone(),face:null,object:this})}}}(),clone:function(){return new this.constructor(this.material).copy(this)}}),bt.prototype=Object.assign(Object.create(le.prototype),{constructor:bt,copy:function(e){le.prototype.copy.call(this,e,!1);for(var t=e.levels,n=0,i=t.length;n<i;n++){var r=t[n];this.addLevel(r.object.clone(),r.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var n=this.levels,i=0;i<n.length&&!(t<n[i].distance);i++);n.splice(i,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,n=1,i=t.length;n<i&&!(e<t[n].distance);n++);return t[n-1].object},raycast:function(){var e=new l;return function(t,n){e.setFromMatrixPosition(this.matrixWorld);var i=t.ray.origin.distanceTo(e);this.getObjectForDistance(i).raycast(t,n)}}(),update:function(){var e=new l,t=new l;return function(n){var i=this.levels;if(i.length>1){e.setFromMatrixPosition(n.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var r=e.distanceTo(t);i[0].object.visible=!0;for(var a=1,o=i.length;a<o&&r>=i[a].distance;a++)i[a-1].object.visible=!1,i[a].object.visible=!0;for(;a<o;a++)i[a].object.visible=!1}}}(),toJSON:function(e){var t=le.prototype.toJSON.call(this,e);t.object.levels=[];for(var n=this.levels,i=0,r=n.length;i<r;i++){var a=n[i];t.object.levels.push({object:a.object.uuid,distance:a.distance})}return t}}),Object.assign(xt.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var n=new u;this.bones[e]&&n.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(n)}},pose:function(){var e,t,n;for(t=0,n=this.bones.length;t<n;t++)(e=this.bones[t])&&e.matrixWorld.getInverse(this.boneInverses[t]);for(t=0,n=this.bones.length;t<n;t++)(e=this.bones[t])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:function(){var e=new u,t=new u;return function(){for(var n=this.bones,i=this.boneInverses,r=this.boneMatrices,a=this.boneTexture,o=0,s=n.length;o<s;o++){var l=n[o]?n[o].matrixWorld:t;e.multiplyMatrices(l,i[o]),e.toArray(r,16*o)}void 0!==a&&(a.needsUpdate=!0)}}(),clone:function(){return new xt(this.bones,this.boneInverses)}}),Mt.prototype=Object.assign(Object.create(le.prototype),{constructor:Mt,isBone:!0}),_t.prototype=Object.assign(Object.create(Le.prototype),{constructor:_t,isSkinnedMesh:!0,initBones:function(){var e,t,n,i,r=[];if(this.geometry&&void 0!==this.geometry.bones){for(n=0,i=this.geometry.bones.length;n<i;n++)t=this.geometry.bones[n],e=new Mt,r.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(n=0,i=this.geometry.bones.length;n<i;n++)t=this.geometry.bones[n],-1!==t.parent&&null!==t.parent&&void 0!==r[t.parent]?r[t.parent].add(r[n]):this.add(r[n])}return this.updateMatrixWorld(!0),r},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var n=this.geometry.skinWeights[t];e=1/n.lengthManhattan(),e!==1/0?n.multiplyScalar(e):n.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var i=new r,a=this.geometry.attributes.skinWeight;for(t=0;t<a.count;t++)i.x=a.getX(t),i.y=a.getY(t),i.z=a.getZ(t),i.w=a.getW(t),e=1/i.lengthManhattan(),e!==1/0?i.multiplyScalar(e):i.set(1,0,0,0),a.setXYZW(t,i.x,i.y,i.z,i.w)}},updateMatrixWorld:function(e){Le.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Ct.prototype=Object.create(K.prototype),Ct.prototype.constructor=Ct,Ct.prototype.isLineBasicMaterial=!0,Ct.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},It.prototype=Object.assign(Object.create(le.prototype),{constructor:It,isLine:!0,raycast:function(){var e=new u,t=new ae,n=new ee;return function(i,r){var a=i.linePrecision,o=a*a,s=this.geometry,u=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),n.copy(s.boundingSphere),n.applyMatrix4(u),!1!==i.ray.intersectsSphere(n)){e.getInverse(u),t.copy(i.ray).applyMatrix4(e);var c=new l,h=new l,d=new l,f=new l,p=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){var m=s.index,g=s.attributes,v=g.position.array;if(null!==m)for(var y=m.array,E=0,b=y.length-1;E<b;E+=p){var x=y[E],M=y[E+1];c.fromArray(v,3*x),h.fromArray(v,3*M);var _=t.distanceSqToSegment(c,h,f,d);if(!(_>o)){f.applyMatrix4(this.matrixWorld);var C=i.ray.origin.distanceTo(f);C<i.near||C>i.far||r.push({distance:C,point:d.clone().applyMatrix4(this.matrixWorld),index:E,face:null,faceIndex:null,object:this})}}else for(var E=0,b=v.length/3-1;E<b;E+=p){c.fromArray(v,3*E),h.fromArray(v,3*E+3);var _=t.distanceSqToSegment(c,h,f,d);if(!(_>o)){f.applyMatrix4(this.matrixWorld);var C=i.ray.origin.distanceTo(f);C<i.near||C>i.far||r.push({distance:C,point:d.clone().applyMatrix4(this.matrixWorld),index:E,face:null,faceIndex:null,object:this})}}}else if(s.isGeometry)for(var I=s.vertices,O=I.length,E=0;E<O-1;E+=p){var _=t.distanceSqToSegment(I[E],I[E+1],f,d);if(!(_>o)){f.applyMatrix4(this.matrixWorld);var C=i.ray.origin.distanceTo(f);C<i.near||C>i.far||r.push({distance:C,point:d.clone().applyMatrix4(this.matrixWorld),index:E,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Ot.prototype=Object.assign(Object.create(It.prototype),{constructor:Ot,isLineSegments:!0}),Tt.prototype=Object.assign(Object.create(It.prototype),{constructor:Tt,isLineLoop:!0}),Lt.prototype=Object.create(K.prototype),Lt.prototype.constructor=Lt,Lt.prototype.isPointsMaterial=!0,Lt.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.positionOffset=e.positionOffset,this.sizeAttribute=e.sizeAttribute,this},St.prototype=Object.assign(Object.create(le.prototype),{constructor:St,isPoints:!0,raycast:function(){var e=new u,t=new ae,n=new ee;return function(i,r){function a(e,n){var a=t.distanceSqToPoint(e);if(a<d){var s=t.closestPointToPoint(e);s.applyMatrix4(u);var l=i.ray.origin.distanceTo(s);if(l<i.near||l>i.far)return;r.push({distance:l,distanceToRay:Math.sqrt(a),point:s.clone(),index:n,face:null,object:o})}}var o=this,s=this.geometry,u=this.matrixWorld,c=i.params.Points.threshold;if(null===s.boundingSphere&&s.computeBoundingSphere(),n.copy(s.boundingSphere),n.applyMatrix4(u),n.radius+=c,!1!==i.ray.intersectsSphere(n)){e.getInverse(u),t.copy(i.ray).applyMatrix4(e);var h=c/((this.scale.x+this.scale.y+this.scale.z)/3),d=h*h,f=new l;if(s.isBufferGeometry){var p=s.index,m=s.attributes,g=m.position.array;if(null!==p)for(var v=p.array,y=0,E=v.length;y<E;y++){var b=v[y];f.fromArray(g,3*b),a(f,b)}else for(var y=0,x=g.length/3;y<x;y++)f.fromArray(g,3*y),a(f,y)}else for(var M=s.vertices,y=0,x=M.length;y<x;y++)a(M[y],y)}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Dt.prototype=Object.assign(Object.create(le.prototype),{constructor:Dt}),wt.prototype=Object.create(i.prototype),wt.prototype.constructor=wt,Ut.prototype=Object.create(i.prototype),Ut.prototype.constructor=Ut,Ut.prototype.isCompressedTexture=!0,Rt.prototype=Object.create(i.prototype),Rt.prototype.constructor=Rt,At.prototype=Object.create(i.prototype),At.prototype.constructor=At,At.prototype.isDepthTexture=!0,Nt.prototype=Object.create(Te.prototype),Nt.prototype.constructor=Nt,Pt.prototype=Object.create(Oe.prototype),Pt.prototype.constructor=Pt,kt.prototype=Object.create(Te.prototype),kt.prototype.constructor=kt,Bt.prototype=Object.create(Oe.prototype),Bt.prototype.constructor=Bt,Ft.prototype=Object.create(Te.prototype),Ft.prototype.constructor=Ft,Ht.prototype=Object.create(Oe.prototype),Ht.prototype.constructor=Ht,Gt.prototype=Object.create(Ft.prototype),Gt.prototype.constructor=Gt,Vt.prototype=Object.create(Oe.prototype),Vt.prototype.constructor=Vt,zt.prototype=Object.create(Ft.prototype),zt.prototype.constructor=zt,jt.prototype=Object.create(Oe.prototype),jt.prototype.constructor=jt,Wt.prototype=Object.create(Ft.prototype),Wt.prototype.constructor=Wt,Xt.prototype=Object.create(Oe.prototype),Xt.prototype.constructor=Xt,Yt.prototype=Object.create(Ft.prototype),Yt.prototype.constructor=Yt,qt.prototype=Object.create(Oe.prototype),qt.prototype.constructor=qt,Zt.prototype=Object.create(Te.prototype),Zt.prototype.constructor=Zt,Kt.prototype=Object.create(Oe.prototype),Kt.prototype.constructor=Kt,Qt.prototype=Object.create(Te.prototype),Qt.prototype.constructor=Qt,Jt.prototype=Object.create(Oe.prototype),Jt.prototype.constructor=Jt,$t.prototype=Object.create(Te.prototype),$t.prototype.constructor=$t;var Ss={area:function(e){for(var t=e.length,n=0,i=t-1,r=0;r<t;i=r++)n+=e[i].x*e[r].y-e[r].x*e[i].y;return.5*n},triangulate:function(){function e(e,t,n,i,r,a){var o,s,l,u,c,h,d,f,p;if(s=e[a[t]].x,l=e[a[t]].y,u=e[a[n]].x,c=e[a[n]].y,h=e[a[i]].x,d=e[a[i]].y,(u-s)*(d-l)-(c-l)*(h-s)<=0)return!1;var m,g,v,y,E,b,x,M,_,C,I,O,T,L,S;for(m=h-u,g=d-c,v=s-h,y=l-d,E=u-s,b=c-l,o=0;o<r;o++)if(f=e[a[o]].x,p=e[a[o]].y,!(f===s&&p===l||f===u&&p===c||f===h&&p===d)&&(x=f-s,M=p-l,_=f-u,C=p-c,I=f-h,O=p-d,S=m*C-g*_,T=E*M-b*x,L=v*O-y*I,S>=-Number.EPSILON&&L>=-Number.EPSILON&&T>=-Number.EPSILON))return!1;return!0}return function(t,n){var i=t.length;if(i<3)return null;var r,a,o,s=[],l=[],u=[];if(Ss.area(t)>0)for(a=0;a<i;a++)l[a]=a;else for(a=0;a<i;a++)l[a]=i-1-a;var c=i,h=2*c;for(a=c-1;c>2;){if(h--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),n?u:s;if(r=a,c<=r&&(r=0),a=r+1,c<=a&&(a=0),o=a+1,c<=o&&(o=0),e(t,r,a,o,c,l)){var d,f,p,m,g;for(d=l[r],f=l[a],p=l[o],s.push([t[d],t[f],t[p]]),u.push([l[r],l[a],l[o]]),m=a,g=a+1;g<c;m++,g++)l[m]=l[g];c--,h=2*c}}return n?u:s}}(),triangulateShape:function(e,t){function n(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function i(e,t,n){return e.x!==t.x?e.x<t.x?e.x<=n.x&&n.x<=t.x:t.x<=n.x&&n.x<=e.x:e.y<t.y?e.y<=n.y&&n.y<=t.y:t.y<=n.y&&n.y<=e.y}function r(e,t,n,r,a){var o=t.x-e.x,s=t.y-e.y,l=r.x-n.x,u=r.y-n.y,c=e.x-n.x,h=e.y-n.y,d=s*l-o*u,f=s*c-o*h;if(Math.abs(d)>Number.EPSILON){var p;if(d>0){if(f<0||f>d)return[];if((p=u*c-l*h)<0||p>d)return[]}else{if(f>0||f<d)return[];if((p=u*c-l*h)>0||p<d)return[]}if(0===p)return!a||0!==f&&f!==d?[e]:[];if(p===d)return!a||0!==f&&f!==d?[t]:[];if(0===f)return[n];if(f===d)return[r];var m=p/d;return[{x:e.x+m*o,y:e.y+m*s}]}if(0!==f||u*c!=l*h)return[];var g=0===o&&0===s,v=0===l&&0===u;if(g&&v)return e.x!==n.x||e.y!==n.y?[]:[e];if(g)return i(n,r,e)?[e]:[];if(v)return i(e,t,n)?[n]:[];var y,E,b,x,M,_,C,I;return 0!==o?(e.x<t.x?(y=e,b=e.x,E=t,x=t.x):(y=t,b=t.x,E=e,x=e.x),n.x<r.x?(M=n,C=n.x,_=r,I=r.x):(M=r,C=r.x,_=n,I=n.x)):(e.y<t.y?(y=e,b=e.y,E=t,x=t.y):(y=t,b=t.y,E=e,x=e.y),n.y<r.y?(M=n,C=n.y,_=r,I=r.y):(M=r,C=r.y,_=n,I=n.y)),b<=C?x<C?[]:x===C?a?[]:[M]:x<=I?[M,E]:[M,_]:b>I?[]:b===I?a?[]:[y]:x<=I?[y,E]:[y,_]}function a(e,t,n,i){var r=t.x-e.x,a=t.y-e.y,o=n.x-e.x,s=n.y-e.y,l=i.x-e.x,u=i.y-e.y,c=r*s-a*o,h=r*u-a*l;if(Math.abs(c)>Number.EPSILON){var d=l*s-u*o;return c>0?h>=0&&d>=0:h>=0||d>=0}return h>0}n(e),t.forEach(n);for(var o,s,l,u,c,h,d={},f=e.concat(),p=0,m=t.length;p<m;p++)Array.prototype.push.apply(f,t[p]);for(o=0,s=f.length;o<s;o++)c=f[o].x+":"+f[o].y,void 0!==d[c]&&console.warn("THREE.ShapeUtils: Duplicate point",c,o),d[c]=o;var g=function(e,t){for(var n,i,o,s,l,u,c,h,d,f,p,m=e.concat(),g=[],v=[],y=0,E=t.length;y<E;y++)g.push(y);for(var b=0,x=2*g.length;g.length>0;){if(--x<0){console.log("Infinite Loop! Holes left:"+g.length+", Probably Hole outside Shape!");break}for(o=b;o<m.length;o++){s=m[o],i=-1;for(var y=0;y<g.length;y++)if(u=g[y],c=s.x+":"+s.y+":"+u,void 0===v[c]){n=t[u];for(var M=0;M<n.length;M++)if(l=n[M],function(e,t){var i=m.length-1,r=e-1;r<0&&(r=i);var o=e+1;o>i&&(o=0);var s=a(m[e],m[r],m[o],n[t]);if(!s)return!1;var l=n.length-1,u=t-1;u<0&&(u=l);var c=t+1;return c>l&&(c=0),!!(s=a(n[t],n[u],n[c],m[e]))}(o,M)&&!function(e,t){var n,i,a;for(n=0;n<m.length;n++)if(i=n+1,i%=m.length,a=r(e,t,m[n],m[i],!0),a.length>0)return!0;return!1}(s,l)&&!function(e,n){var i,a,o,s,l;for(i=0;i<g.length;i++)for(a=t[g[i]],o=0;o<a.length;o++)if(s=o+1,s%=a.length,l=r(e,n,a[o],a[s],!0),l.length>0)return!0;return!1}(s,l)){i=M,g.splice(y,1),h=m.slice(0,o+1),d=m.slice(o),f=n.slice(i),p=n.slice(0,i+1),m=h.concat(f).concat(p).concat(d),b=o;break}if(i>=0)break;v[c]=!0}if(i>=0)break}}return m}(e,t),v=Ss.triangulate(g,!1);for(o=0,s=v.length;o<s;o++)for(u=v[o],l=0;l<3;l++)c=u[l].x+":"+u[l].y,void 0!==(h=d[c])&&(u[l]=h);return v.concat()},isClockWise:function(e){return Ss.area(e)<0}};en.prototype=Object.create(Oe.prototype),en.prototype.constructor=en,tn.prototype=Object.create(Te.prototype),tn.prototype.constructor=tn,tn.prototype.getArrays=function(){var e=this.getAttribute("position"),t=e?Array.prototype.slice.call(e.array):[],n=this.getAttribute("uv"),i=n?Array.prototype.slice.call(n.array):[],r=this.index;return{position:t,uv:i,index:r?Array.prototype.slice.call(r.array):[]}},tn.prototype.addShapeList=function(e,t){var n=e.length;t.arrays=this.getArrays();for(var i=0;i<n;i++){var r=e[i];this.addShape(r,t)}this.setIndex(t.arrays.index),this.addAttribute("position",new xe(t.arrays.position,3)),this.addAttribute("uv",new xe(t.arrays.uv,2))},tn.prototype.addShape=function(e,t){function i(e,t,n){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(n).add(e)}function r(e,t,i){var r,a,o=1,s=e.x-t.x,l=e.y-t.y,u=i.x-e.x,c=i.y-e.y,h=s*s+l*l,d=s*c-l*u;if(Math.abs(d)>Number.EPSILON){var f=Math.sqrt(h),p=Math.sqrt(u*u+c*c),m=t.x-l/f,g=t.y+s/f,v=i.x-c/p,y=i.y+u/p,E=((v-m)*c-(y-g)*u)/(s*c-l*u);r=m+s*E-e.x,a=g+l*E-e.y;var b=r*r+a*a;if(b<=2)return new n(r,a);o=Math.sqrt(b/2)}else{var x=!1;s>Number.EPSILON?u>Number.EPSILON&&(x=!0):s<-Number.EPSILON?u<-Number.EPSILON&&(x=!0):Math.sign(l)===Math.sign(c)&&(x=!0),x?(r=-l,a=s,o=Math.sqrt(h)):(r=s,a=l,o=Math.sqrt(h/2))}return new n(r/o,a/o)}function a(e,t){var n,i;for(Q=e.length;--Q>=0;){n=Q,i=Q-1,i<0&&(i=e.length-1);var r=0,a=L+2*I;for(r=0;r<a;r++){var o=q*r,s=q*(r+1);u(t+n+o,t+i+o,t+i+s,t+n+s,e,r,a,n,i)}}}function o(e,t,n){x.push(e),x.push(t),x.push(n)}function s(e,t,n){c(e),c(t),c(n);var i=y.length/3,r=w.generateTopUV(N,y,i-3,i-2,i-1)
;h(r[0]),h(r[1]),h(r[2])}function u(e,t,n,i,r,a,o,s,l){c(e),c(t),c(i),c(t),c(n),c(i);var u=y.length/3,d=w.generateSideWallUV(N,y,u-6,u-3,u-2,u-1);h(d[0]),h(d[1]),h(d[3]),h(d[1]),h(d[2]),h(d[3])}function c(e){E.push(y.length/3),y.push(x[3*e+0]),y.push(x[3*e+1]),y.push(x[3*e+2])}function h(e){b.push(e.x),b.push(e.y)}var d,f,p,m,g,v=t.arrays?t.arrays:this.getArrays(),y=v.position,E=v.index,b=v.uv,x=[],M=void 0!==t.amount?t.amount:100,_=void 0!==t.bevelThickness?t.bevelThickness:6,C=void 0!==t.bevelSize?t.bevelSize:_-2,I=void 0!==t.bevelSegments?t.bevelSegments:3,O=void 0===t.bevelEnabled||t.bevelEnabled,T=void 0!==t.curveSegments?t.curveSegments:12,L=void 0!==t.steps?t.steps:1,S=t.extrudePath,D=!1,w=void 0!==t.UVGenerator?t.UVGenerator:en.WorldUVGenerator;S&&(d=S.getSpacedPoints(L),D=!0,O=!1,f=void 0!==t.frames?t.frames:S.computeFrenetFrames(L,!1),p=new l,m=new l,g=new l),O||(I=0,_=0,C=0);var U,R,A,N=this,P=e.extractPoints(T),k=P.shape,B=P.holes,F=!Ss.isClockWise(k);if(F){for(k=k.reverse(),R=0,A=B.length;R<A;R++)U=B[R],Ss.isClockWise(U)&&(B[R]=U.reverse());F=!1}var H=Ss.triangulateShape(k,B),G=k;for(R=0,A=B.length;R<A;R++)U=B[R],k=k.concat(U);for(var V,z,j,W,X,Y,q=k.length,Z=H.length,K=[],Q=0,J=G.length,$=J-1,ee=Q+1;Q<J;Q++,$++,ee++)$===J&&($=0),ee===J&&(ee=0),K[Q]=r(G[Q],G[$],G[ee]);var te,ne=[],ie=K.concat();for(R=0,A=B.length;R<A;R++){for(U=B[R],te=[],Q=0,J=U.length,$=J-1,ee=Q+1;Q<J;Q++,$++,ee++)$===J&&($=0),ee===J&&(ee=0),te[Q]=r(U[Q],U[$],U[ee]);ne.push(te),ie=ie.concat(te)}for(V=0;V<I;V++){for(j=V/I,W=_*Math.cos(j*Math.PI/2),z=C*Math.sin(j*Math.PI/2),Q=0,J=G.length;Q<J;Q++)X=i(G[Q],K[Q],z),o(X.x,X.y,-W);for(R=0,A=B.length;R<A;R++)for(U=B[R],te=ne[R],Q=0,J=U.length;Q<J;Q++)X=i(U[Q],te[Q],z),o(X.x,X.y,-W)}for(z=C,Q=0;Q<q;Q++)X=O?i(k[Q],ie[Q],z):k[Q],D?(m.copy(f.normals[0]).multiplyScalar(X.x),p.copy(f.binormals[0]).multiplyScalar(X.y),g.copy(d[0]).add(m).add(p),o(g.x,g.y,g.z)):o(X.x,X.y,0);var re;for(re=1;re<=L;re++)for(Q=0;Q<q;Q++)X=O?i(k[Q],ie[Q],z):k[Q],D?(m.copy(f.normals[re]).multiplyScalar(X.x),p.copy(f.binormals[re]).multiplyScalar(X.y),g.copy(d[re]).add(m).add(p),o(g.x,g.y,g.z)):o(X.x,X.y,M/L*re);for(V=I-1;V>=0;V--){for(j=V/I,W=_*Math.cos(j*Math.PI/2),z=C*Math.sin(j*Math.PI/2),Q=0,J=G.length;Q<J;Q++)X=i(G[Q],K[Q],z),o(X.x,X.y,M+W);for(R=0,A=B.length;R<A;R++)for(U=B[R],te=ne[R],Q=0,J=U.length;Q<J;Q++)X=i(U[Q],te[Q],z),D?o(X.x,X.y+d[L-1].y,d[L-1].x+W):o(X.x,X.y,M+W)}!function(){var e=y.length/3;if(O){var n=0,i=q*n;for(Q=0;Q<Z;Q++)Y=H[Q],s(Y[2]+i,Y[1]+i,Y[0]+i);for(n=L+2*I,i=q*n,Q=0;Q<Z;Q++)Y=H[Q],s(Y[0]+i,Y[1]+i,Y[2]+i)}else{for(Q=0;Q<Z;Q++)Y=H[Q],s(Y[2],Y[1],Y[0]);for(Q=0;Q<Z;Q++)Y=H[Q],s(Y[0]+q*L,Y[1]+q*L,Y[2]+q*L)}N.addGroup(e,y.length/3-e,void 0!==t.material?t.material:0)}(),function(){var e=y.length/3,n=0;for(a(G,n),n+=G.length,R=0,A=B.length;R<A;R++)U=B[R],a(U,n),n+=U.length;N.addGroup(e,y.length/3-e,void 0!==t.extrudeMaterial?t.extrudeMaterial:1)}(),t.arrays||(this.setIndex(E),this.addAttribute("position",new xe(y,3)),this.addAttribute("uv",new xe(t.arrays.uv,2)))},en.WorldUVGenerator={generateTopUV:function(e,t,i,r,a){var o=t[3*i],s=t[3*i+1],l=t[3*r],u=t[3*r+1],c=t[3*a],h=t[3*a+1];return[new n(o,s),new n(l,u),new n(c,h)]},generateSideWallUV:function(e,t,i,r,a,o){var s=t[3*i],l=t[3*i+1],u=t[3*i+2],c=t[3*r],h=t[3*r+1],d=t[3*r+2],f=t[3*a],p=t[3*a+1],m=t[3*a+2],g=t[3*o],v=t[3*o+1],y=t[3*o+2];return Math.abs(l-h)<.01?[new n(s,1-u),new n(c,1-d),new n(f,1-m),new n(g,1-y)]:[new n(l,1-u),new n(h,1-d),new n(p,1-m),new n(v,1-y)]}},nn.prototype=Object.create(Oe.prototype),nn.prototype.constructor=nn,rn.prototype=Object.create(tn.prototype),rn.prototype.constructor=rn,an.prototype=Object.create(Oe.prototype),an.prototype.constructor=an,on.prototype=Object.create(Te.prototype),on.prototype.constructor=on,sn.prototype=Object.create(Oe.prototype),sn.prototype.constructor=sn,ln.prototype=Object.create(Te.prototype),ln.prototype.constructor=ln,un.prototype=Object.create(Oe.prototype),un.prototype.constructor=un,cn.prototype=Object.create(Te.prototype),cn.prototype.constructor=cn,hn.prototype=Object.create(Oe.prototype),hn.prototype.constructor=hn,dn.prototype=Object.create(Te.prototype),dn.prototype.constructor=dn,fn.prototype=Object.create(Te.prototype),fn.prototype.constructor=fn,pn.prototype=Object.create(Oe.prototype),pn.prototype.constructor=pn,mn.prototype=Object.create(Te.prototype),mn.prototype.constructor=mn,gn.prototype=Object.create(pn.prototype),gn.prototype.constructor=gn,vn.prototype=Object.create(mn.prototype),vn.prototype.constructor=vn,yn.prototype=Object.create(Oe.prototype),yn.prototype.constructor=yn,En.prototype=Object.create(Te.prototype),En.prototype.constructor=En;var Ds=Object.freeze({WireframeGeometry:Nt,ParametricGeometry:Pt,ParametricBufferGeometry:kt,TetrahedronGeometry:Ht,TetrahedronBufferGeometry:Gt,OctahedronGeometry:Vt,OctahedronBufferGeometry:zt,IcosahedronGeometry:jt,IcosahedronBufferGeometry:Wt,DodecahedronGeometry:Xt,DodecahedronBufferGeometry:Yt,PolyhedronGeometry:Bt,PolyhedronBufferGeometry:Ft,TubeGeometry:qt,TubeBufferGeometry:Zt,TorusKnotGeometry:Kt,TorusKnotBufferGeometry:Qt,TorusGeometry:Jt,TorusBufferGeometry:$t,TextGeometry:nn,TextBufferGeometry:rn,SphereGeometry:an,SphereBufferGeometry:on,RingGeometry:sn,RingBufferGeometry:ln,PlaneGeometry:we,PlaneBufferGeometry:Ue,LatheGeometry:un,LatheBufferGeometry:cn,ShapeGeometry:hn,ShapeBufferGeometry:dn,ExtrudeGeometry:en,ExtrudeBufferGeometry:tn,EdgesGeometry:fn,ConeGeometry:gn,ConeBufferGeometry:vn,CylinderGeometry:pn,CylinderBufferGeometry:mn,CircleGeometry:yn,CircleBufferGeometry:En,BoxGeometry:Se,BoxBufferGeometry:De});bn.prototype=Object.create(Q.prototype),bn.prototype.constructor=bn,bn.prototype.isShadowMaterial=!0,xn.prototype=Object.create(Q.prototype),xn.prototype.constructor=xn,xn.prototype.isRawShaderMaterial=!0,Mn.prototype=Object.create(K.prototype),Mn.prototype.constructor=Mn,Mn.prototype.isMeshStandardMaterial=!0,Mn.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},_n.prototype=Object.create(Mn.prototype),_n.prototype.constructor=_n,_n.prototype.isMeshPhysicalMaterial=!0,_n.prototype.copy=function(e){return Mn.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},Cn.prototype=Object.create(K.prototype),Cn.prototype.constructor=Cn,Cn.prototype.isMeshPhongMaterial=!0,Cn.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},In.prototype=Object.create(Cn.prototype),In.prototype.constructor=In,In.prototype.isMeshToonMaterial=!0,In.prototype.copy=function(e){return Cn.prototype.copy.call(this,e),this.gradientMap=e.gradientMap,this},On.prototype=Object.create(K.prototype),On.prototype.constructor=On,On.prototype.isMeshNormalMaterial=!0,On.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Tn.prototype=Object.create(K.prototype),Tn.prototype.constructor=Tn,Tn.prototype.isMeshLambertMaterial=!0,Tn.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Ln.prototype=Object.create(K.prototype),Ln.prototype.constructor=Ln,Ln.prototype.isLineDashedMaterial=!0,Ln.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var ws=Object.freeze({ShadowMaterial:bn,SpriteMaterial:yt,RawShaderMaterial:xn,ShaderMaterial:Q,PointsMaterial:Lt,MeshPhysicalMaterial:_n,MeshStandardMaterial:Mn,MeshPhongMaterial:Cn,MeshToonMaterial:In,MeshNormalMaterial:On,MeshLambertMaterial:Tn,MeshDepthMaterial:J,MeshBasicMaterial:de,LineDashedMaterial:Ln,LineBasicMaterial:Ct,Material:K}),Us={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},Rs=new Sn;Object.assign(Dn.prototype,{load:function(e,t,n,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var r=this,a=Us.get(e);if(void 0!==a)return r.manager.itemStart(e),setTimeout(function(){t&&t(a),r.manager.itemEnd(e)},0),a;var o=/^data:(.*?)(;base64)?,(.*)$/,s=e.match(o);if(s){var l=s[1],u=!!s[2],c=s[3];c=window.decodeURIComponent(c),u&&(c=window.atob(c));try{var h,d=(this.responseType||"").toLowerCase();switch(d){case"arraybuffer":case"blob":h=new ArrayBuffer(c.length);for(var f=new Uint8Array(h),p=0;p<c.length;p++)f[p]=c.charCodeAt(p);"blob"===d&&(h=new Blob([h],{type:l}));break;case"document":var m=new DOMParser;h=m.parseFromString(c,l);break;case"json":h=JSON.parse(c);break;default:h=c}window.setTimeout(function(){t&&t(h),r.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){i&&i(t),r.manager.itemEnd(e),r.manager.itemError(e)},0)}}else{var g=new XMLHttpRequest;g.open("GET",e,!0),g.addEventListener("load",function(n){var a=n.target.response;Us.add(e,a),200===this.status?(t&&t(a),r.manager.itemEnd(e)):0===this.status?(console.warn("THREE.FileLoader: HTTP Status 0 received."),t&&t(a),r.manager.itemEnd(e)):(i&&i(n),r.manager.itemEnd(e),r.manager.itemError(e))},!1),void 0!==n&&g.addEventListener("progress",function(e){n(e)},!1),g.addEventListener("error",function(t){i&&i(t),r.manager.itemEnd(e),r.manager.itemError(e)},!1),void 0!==this.responseType&&(g.responseType=this.responseType),void 0!==this.withCredentials&&(g.withCredentials=this.withCredentials),g.overrideMimeType&&g.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(var v in this.requestHeader)g.setRequestHeader(v,this.requestHeader[v]);g.send(null)}return r.manager.itemStart(e),g},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(wn.prototype,{load:function(e,t,n,i){var r=this,a=[],o=new Ut;o.image=a;var s=new Dn(this.manager);if(s.setPath(this.path),s.setResponseType("arraybuffer"),Array.isArray(e))for(var l=0,u=0,c=e.length;u<c;++u)!function(u){s.load(e[u],function(e){var n=r._parser(e,!0);a[u]={width:n.width,height:n.height,format:n.format,mipmaps:n.mipmaps},6===(l+=1)&&(1===n.mipmapCount&&(o.minFilter=Eo),o.format=n.format,o.needsUpdate=!0,t&&t(o))},n,i)}(u);else s.load(e,function(e){var n=r._parser(e,!0);if(n.isCubemap)for(var i=n.mipmaps.length/n.mipmapCount,s=0;s<i;s++){a[s]={mipmaps:[]};for(var l=0;l<n.mipmapCount;l++)a[s].mipmaps.push(n.mipmaps[s*n.mipmapCount+l]),a[s].format=n.format,a[s].width=n.width,a[s].height=n.height}else o.image.width=n.width,o.image.height=n.height,o.mipmaps=n.mipmaps;1===n.mipmapCount&&(o.minFilter=Eo),o.format=n.format,o.needsUpdate=!0,t&&t(o)},n,i);return o},setPath:function(e){return this.path=e,this}}),Object.assign(Un.prototype,{load:function(e,t,n,i){var r=this,a=new c,o=new Dn(this.manager);return o.setResponseType("arraybuffer"),o.load(e,function(e){var n=r._parser(e);n&&(void 0!==n.image?a.image=n.image:void 0!==n.data&&(a.image.width=n.width,a.image.height=n.height,a.image.data=n.data),a.wrapS=void 0!==n.wrapS?n.wrapS:po,a.wrapT=void 0!==n.wrapT?n.wrapT:po,a.magFilter=void 0!==n.magFilter?n.magFilter:Eo,a.minFilter=void 0!==n.minFilter?n.minFilter:xo,a.anisotropy=void 0!==n.anisotropy?n.anisotropy:1,void 0!==n.format&&(a.format=n.format),void 0!==n.type&&(a.type=n.type),void 0!==n.mipmaps&&(a.mipmaps=n.mipmaps),1===n.mipmapCount&&(a.minFilter=Eo),a.needsUpdate=!0,t&&t(a,n))},n,i),a}}),Object.assign(Rn.prototype,{load:function(e,t,n,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var r=this,a=Us.get(e);if(void 0!==a)return r.manager.itemStart(e),setTimeout(function(){t&&t(a),r.manager.itemEnd(e)},0),a;var o=document.createElementNS("http://www.w3.org/1999/xhtml","img");return o.addEventListener("load",function(){Us.add(e,this),t&&t(this),r.manager.itemEnd(e)},!1),o.addEventListener("error",function(t){i&&i(t),r.manager.itemEnd(e),r.manager.itemError(e)},!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(e),o.src=e,o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(An.prototype,{load:function(e,t,n,i){var r=new h,a=new Rn(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);for(var o=0,s=0;s<e.length;++s)!function(n){a.load(e[n],function(e){r.images[n]=e,6==++o&&(r.needsUpdate=!0,t&&t(r))},void 0,i)}(s);return r},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Nn.prototype,{load:function(e,t,n,r){var a=new Rn(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);var o=new i;return o.image=a.load(e,function(){var n=e.search(/\.(jpg|jpeg)$/)>0||0===e.search(/^data\:image\/jpeg/);o.format=n?No:Po,o.needsUpdate=!0,void 0!==t&&t(o)},n,r),o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Pn.prototype=Object.assign(Object.create(le.prototype),{constructor:Pn,isLight:!0,copy:function(e){return le.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),kn.prototype=Object.assign(Object.create(Pn.prototype),{constructor:kn,isHemisphereLight:!0,copy:function(e){return Pn.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(Bn.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),Fn.prototype=Object.assign(Object.create(Bn.prototype),{constructor:Fn,isSpotLightShadow:!0,update:function(e){var t=this.camera,n=2*hs.RAD2DEG*e.angle,i=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;n===t.fov&&i===t.aspect&&r===t.far||(t.fov=n,t.aspect=i,t.far=r,t.updateProjectionMatrix())}}),Hn.prototype=Object.assign(Object.create(Pn.prototype),{constructor:Hn,isSpotLight:!0,copy:function(e){return Pn.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),Gn.prototype=Object.assign(Object.create(Pn.prototype),{constructor:Gn,isPointLight:!0,copy:function(e){return Pn.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),Vn.prototype=Object.assign(Object.create(Bn.prototype),{constructor:Vn}),zn.prototype=Object.assign(Object.create(Pn.prototype),{constructor:zn,isDirectionalLight:!0,copy:function(e){return Pn.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),jn.prototype=Object.assign(Object.create(Pn.prototype),{constructor:jn,isAmbientLight:!0}),Wn.prototype=Object.assign(Object.create(Pn.prototype),{constructor:Wn,isRectAreaLight:!0,copy:function(e){return Pn.prototype.copy.call(this,e),this.width=e.width,this.height=e.height,this},toJSON:function(e){var t=Pn.prototype.toJSON.call(this,e);return t.object.width=this.width,t.object.height=this.height,t}});var As={arraySlice:function(e,t,n){return As.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==n?n:e.length)):e.slice(t,n)},convertArray:function(e,t,n){return!e||!n&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){function t(t,n){return e[t]-e[n]}for(var n=e.length,i=new Array(n),r=0;r!==n;++r)i[r]=r;return i.sort(t),i},sortedArray:function(e,t,n){for(var i=e.length,r=new e.constructor(i),a=0,o=0;o!==i;++a)for(var s=n[a]*t,l=0;l!==t;++l)r[o++]=e[s+l];return r},flattenJSON:function(e,t,n,i){for(var r=1,a=e[0];void 0!==a&&void 0===a[i];)a=e[r++];if(void 0!==a){var o=a[i];if(void 0!==o)if(Array.isArray(o))do{o=a[i],void 0!==o&&(t.push(a.time),n.push.apply(n,o)),a=e[r++]}while(void 0!==a);else if(void 0!==o.toArray)do{o=a[i],void 0!==o&&(t.push(a.time),o.toArray(n,n.length)),a=e[r++]}while(void 0!==a);else do{o=a[i],void 0!==o&&(t.push(a.time),n.push(o)),a=e[r++]}while(void 0!==a)}}};Object.assign(Xn.prototype,{evaluate:function(e){var t=this.parameterPositions,n=this._cachedIndex,i=t[n],r=t[n-1];e:{t:{var a;n:{i:if(!(e<i)){for(var o=n+2;;){if(void 0===i){if(e<r)break i;return n=t.length,this._cachedIndex=n,this.afterEnd_(n-1,e,r)}if(n===o)break;if(r=i,i=t[++n],e<i)break t}a=t.length;break n}{if(e>=r)break e;var s=t[1];e<s&&(n=2,r=s);for(var o=n-2;;){if(void 0===r)return this._cachedIndex=0,this.beforeStart_(0,e,i);if(n===o)break;if(i=r,r=t[--n-1],e>=r)break t}a=n,n=0}}for(;n<a;){var l=n+a>>>1;e<t[l]?a=l:n=l+1}if(i=t[n],void 0===(r=t[n-1]))return this._cachedIndex=0,this.beforeStart_(0,e,i);if(void 0===i)return n=t.length,this._cachedIndex=n,this.afterEnd_(n-1,r,e)}this._cachedIndex=n,this.intervalChanged_(n,r,i)}return this.interpolate_(n,r,e,i)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i,a=0;a!==i;++a)t[a]=n[r+a];return t},interpolate_:function(e,t,n,i){throw new Error("call to abstract method")},intervalChanged_:function(e,t,n){}}),Object.assign(Xn.prototype,{beforeStart_:Xn.prototype.copySampleValue_,afterEnd_:Xn.prototype.copySampleValue_}),Yn.prototype=Object.assign(Object.create(Xn.prototype),{constructor:Yn,DefaultSettings_:{endingStart:Jo,endingEnd:Jo},intervalChanged_:function(e,t,n){var i=this.parameterPositions,r=e-2,a=e+1,o=i[r],s=i[a];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:r=e,o=2*t-n;break;case 2402:r=i.length-2,o=t+i[r]-i[r+1];break;default:r=e,o=n}if(void 0===s)switch(this.getSettings_().endingEnd){case 2401:a=e,s=2*n-t;break;case 2402:a=1,s=n+i[1]-i[0];break;default:a=e-1,s=t}var l=.5*(n-t),u=this.valueSize;this._weightPrev=l/(t-o),this._weightNext=l/(s-n),this._offsetPrev=r*u,this._offsetNext=a*u},interpolate_:function(e,t,n,i){for(var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,u=this._offsetPrev,c=this._offsetNext,h=this._weightPrev,d=this._weightNext,f=(n-t)/(i-t),p=f*f,m=p*f,g=-h*m+2*h*p-h*f,v=(1+h)*m+(-1.5-2*h)*p+(-.5+h)*f+1,y=(-1-d)*m+(1.5+d)*p+.5*f,E=d*m-d*p,b=0;b!==o;++b)r[b]=g*a[u+b]+v*a[l+b]+y*a[s+b]+E*a[c+b];return r}}),qn.prototype=Object.assign(Object.create(Xn.prototype),{constructor:qn,interpolate_:function(e,t,n,i){for(var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,u=(n-t)/(i-t),c=1-u,h=0;h!==o;++h)r[h]=a[l+h]*c+a[s+h]*u;return r}}),Zn.prototype=Object.assign(Object.create(Xn.prototype),{constructor:Zn,interpolate_:function(e,t,n,i){return this.copySampleValue_(e-1)}});var Ns;Ns={TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(e){return new Zn(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new qn(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new Yn(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){var n="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(n);this.setInterpolation(this.DefaultInterpolation)}return void console.warn(n)}this.createInterpolant=t},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,n=0,i=t.length;n!==i;++n)t[n]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,n=0,i=t.length;n!==i;++n)t[n]*=e;return this},trim:function(e,t){for(var n=this.times,i=n.length,r=0,a=i-1;r!==i&&n[r]<e;)++r;for(;-1!==a&&n[a]>t;)--a;if(++a,0!==r||a!==i){r>=a&&(a=Math.max(a,1),r=a-1);var o=this.getValueSize();this.times=As.arraySlice(n,r,a),this.values=As.arraySlice(this.values,r*o,a*o)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("invalid value size in track",this),e=!1);var n=this.times,i=this.values,r=n.length;0===r&&(console.error("track is empty",this),e=!1);for(var a=null,o=0;o!==r;o++){var s=n[o];if("number"==typeof s&&isNaN(s)){console.error("time is not a valid number",this,o,s),e=!1;break}if(null!==a&&a>s){console.error("out of order keys",this,o,s,a),e=!1;break}a=s}if(void 0!==i&&As.isTypedArray(i))for(var o=0,l=i.length;o!==l;++o){var u=i[o];if(isNaN(u)){console.error("value is not a valid number",this,o,u),e=!1;break}}return e},optimize:function(){for(var e=this.times,t=this.values,n=this.getValueSize(),i=2302===this.getInterpolation(),r=1,a=e.length-1,o=1;o<a;++o){var s=!1,l=e[o];if(l!==e[o+1]&&(1!==o||l!==l[0]))if(i)s=!0;else for(var u=o*n,c=u-n,h=u+n,d=0;d!==n;++d){var f=t[u+d];if(f!==t[c+d]||f!==t[h+d]){s=!0;break}}if(s){if(o!==r){e[r]=e[o];for(var p=o*n,m=r*n,d=0;d!==n;++d)t[m+d]=t[p+d]}++r}}if(a>0){e[r]=e[a];for(var p=a*n,m=r*n,d=0;d!==n;++d)t[m+d]=t[p+d];++r}return r!==e.length&&(this.times=As.arraySlice(e,0,r),this.values=As.arraySlice(t,0,r*n)),this}},Qn.prototype=Object.assign(Object.create(Ns),{constructor:Qn,ValueTypeName:"vector"}),Jn.prototype=Object.assign(Object.create(Xn.prototype),{constructor:Jn,interpolate_:function(e,t,n,i){for(var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,l=e*o,u=(n-t)/(i-t),c=l+o;l!==c;l+=4)s.slerpFlat(r,0,a,l-o,a,l,u);return r}}),$n.prototype=Object.assign(Object.create(Ns),{constructor:$n,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(e){return new Jn(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),ei.prototype=Object.assign(Object.create(Ns),{constructor:ei,ValueTypeName:"number"}),ti.prototype=Object.assign(Object.create(Ns),{constructor:ti,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ni.prototype=Object.assign(Object.create(Ns),{constructor:ni,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ii.prototype=Object.assign(Object.create(Ns),{constructor:ii,ValueTypeName:"color"}),ri.prototype=Ns,Ns.constructor=ri,Object.assign(ri,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=ri._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var n=[],i=[];As.flattenJSON(e.keys,n,i,"value"),e.times=n,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,n=e.constructor;if(void 0!==n.toJSON)t=n.toJSON(e);else{t={name:e.name,times:As.convertArray(e.times,Array),values:As.convertArray(e.values,Array)};var i=e.getInterpolation();i!==e.DefaultInterpolation&&(t.interpolation=i)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return ei;case"vector":case"vector2":case"vector3":case"vector4":return Qn;case"color":return ii;case"quaternion":return $n;case"bool":case"boolean":return ni;case"string":return ti}throw new Error("Unsupported typeName: "+e)}}),Object.assign(ai,{parse:function(e){for(var t=[],n=e.tracks,i=1/(e.fps||1),r=0,a=n.length;r!==a;++r)t.push(ri.parse(n[r]).scale(i));return new ai(e.name,e.duration,t)},toJSON:function(e){for(var t=[],n=e.tracks,i={name:e.name,duration:e.duration,tracks:t},r=0,a=n.length;r!==a;++r)t.push(ri.toJSON(n[r]));return i},CreateFromMorphTargetSequence:function(e,t,n,i){for(var r=t.length,a=[],o=0;o<r;o++){var s=[],l=[];s.push((o+r-1)%r,o,(o+1)%r),l.push(0,1,0);var u=As.getKeyframeOrder(s);s=As.sortedArray(s,1,u),l=As.sortedArray(l,1,u),i||0!==s[0]||(s.push(r),l.push(l[0])),a.push(new ei(".morphTargetInfluences["+t[o].name+"]",s,l).scale(1/n))}return new ai(e,-1,a)},findByName:function(e,t){var n=e;if(!Array.isArray(e)){var i=e;n=i.geometry&&i.geometry.animations||i.animations}for(var r=0;r<n.length;r++)if(n[r].name===t)return n[r];return null},CreateClipsFromMorphTargetSequences:function(e,t,n){for(var i={},r=/^([\w-]*?)([\d]+)$/,a=0,o=e.length;a<o;a++){var s=e[a],l=s.name.match(r);if(l&&l.length>1){var u=l[1],c=i[u];c||(i[u]=c=[]),c.push(s)}}var h=[];for(var u in i)h.push(ai.CreateFromMorphTargetSequence(u,i[u],t,n));return h},parseAnimation:function(e,t){if(!e)return console.error("  no animation in JSONLoader data"),null;for(var n=function(e,t,n,i,r){if(0!==n.length){var a=[],o=[];As.flattenJSON(n,a,o,i),0!==a.length&&r.push(new e(t,a,o))}},i=[],r=e.name||"default",a=e.length||-1,o=e.fps||30,s=e.hierarchy||[],l=0;l<s.length;l++){var u=s[l].keys;if(u&&0!==u.length)if(u[0].morphTargets){for(var c={},h=0;h<u.length;h++)if(u[h].morphTargets)for(var d=0;d<u[h].morphTargets.length;d++)c[u[h].morphTargets[d]]=-1;for(var f in c){for(var p=[],m=[],d=0;d!==u[h].morphTargets.length;++d){var g=u[h];p.push(g.time),m.push(g.morphTarget===f?1:0)}i.push(new ei(".morphTargetInfluence["+f+"]",p,m))}a=c.length*(o||1)}else{var v=".bones["+t[l].name+"]";n(Qn,v+".position",u,"pos",i),n($n,v+".quaternion",u,"rot",i),n(Qn,v+".scale",u,"scl",i)}}return 0===i.length?null:new ai(r,a,i)}}),Object.assign(ai.prototype,{resetDuration:function(){for(var e=this.tracks,t=0,n=0,i=e.length;n!==i;++n){var r=this.tracks[n];t=Math.max(t,r.times[r.times.length-1])}this.duration=t},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}}),Object.assign(oi.prototype,{load:function(e,t,n,i){var r=this,a=new Dn(r.manager);a.setResponseType("json"),a.load(e,function(e){t(r.parse(e))},n,i)},setTextures:function(e){this.textures=e},parse:function(e){function t(e){return void 0===i[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),i[e]}var i=this.textures,r=new ws[e.type];if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&r.specular.setHex(e.specular),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.clearCoat&&(r.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(r.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.uniforms&&(r.uniforms=e.uniforms),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(r.vertexColors=e.vertexColors),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.shading&&(r.shading=e.shading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.side&&(r.side=e.side),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.skinning&&(r.skinning=e.skinning),void 0!==e.morphTargets&&(r.morphTargets=e.morphTargets),void 0!==e.size&&(r.size=e.size),
void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.positionOffset&&(r.positionOffset=e.positionOffset),void 0!==e.sizeAttribute&&(r.sizeAttribute=e.sizeAttribute),void 0!==e.map&&(r.map=t(e.map)),void 0!==e.alphaMap&&(r.alphaMap=t(e.alphaMap),r.transparent=!0),void 0!==e.bumpMap&&(r.bumpMap=t(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=t(e.normalMap)),void 0!==e.normalScale){var a=e.normalScale;!1===Array.isArray(a)&&(a=[a,a]),r.normalScale=(new n).fromArray(a)}return void 0!==e.displacementMap&&(r.displacementMap=t(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=t(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=t(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=t(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=t(e.specularMap)),void 0!==e.envMap&&(r.envMap=t(e.envMap)),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.lightMap&&(r.lightMap=t(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=t(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(r.gradientMap=t(e.gradientMap)),r}}),Object.assign(si.prototype,{load:function(e,t,n,i){var r=this,a=new Dn(r.manager);a.setResponseType("json"),a.load(e,function(e){t(r.parse(e))},n,i)},parse:function(e){var t=new Te,n=e.data.index;if(void 0!==n){var i=new Ps[n.type](n.array);t.setIndex(new fe(i,1))}var r=e.data.attributes;for(var a in r){var o=r[a],i=new Ps[o.type](o.array);t.addAttribute(a,new fe(i,o.itemSize,o.normalized))}var s=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==s)for(var u=0,c=s.length;u!==c;++u){var h=s[u];t.addGroup(h.start,h.count,h.materialIndex)}var d=e.data.boundingSphere;if(void 0!==d){var f=new l;void 0!==d.center&&f.fromArray(d.center),t.boundingSphere=new ee(f,d.radius)}return t}});var Ps={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};li.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,n=0,i=t.length;n<i;n+=2){var r=t[n],a=t[n+1];if(r.test(e))return a}return null}},Object.assign(li.prototype,{crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,n){for(var i=[],r=0;r<e.length;++r)i[r]=this.createMaterial(e[r],t,n);return i},createMaterial:function(){var e={NoBlending:xa,NormalBlending:Ma,AdditiveBlending:_a,SubtractiveBlending:Ca,MultiplyBlending:Ia,CustomBlending:Oa},t=new X,n=new Nn,i=new oi;return function(r,a,o){function s(e,t,i,r,s){var u,c=a+e,h=li.Handlers.get(c);null!==h?u=h.load(c):(n.setCrossOrigin(o),u=n.load(c)),void 0!==t&&(u.repeat.fromArray(t),1!==t[0]&&(u.wrapS=fo),1!==t[1]&&(u.wrapT=fo)),void 0!==i&&u.offset.fromArray(i),void 0!==r&&("repeat"===r[0]&&(u.wrapS=fo),"mirror"===r[0]&&(u.wrapS=mo),"repeat"===r[1]&&(u.wrapT=fo),"mirror"===r[1]&&(u.wrapT=mo)),void 0!==s&&(u.anisotropy=s);var d=hs.generateUUID();return l[d]=u,d}var l={},u={uuid:hs.generateUUID(),type:"MeshLambertMaterial"};for(var c in r){var h=r[c];switch(c){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":u.name=h;break;case"blending":u.blending=e[h];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",c,"is no longer supported.");break;case"colorDiffuse":u.color=t.fromArray(h).getHex();break;case"colorSpecular":u.specular=t.fromArray(h).getHex();break;case"colorEmissive":u.emissive=t.fromArray(h).getHex();break;case"specularCoef":u.shininess=h;break;case"shading":"basic"===h.toLowerCase()&&(u.type="MeshBasicMaterial"),"phong"===h.toLowerCase()&&(u.type="MeshPhongMaterial"),"standard"===h.toLowerCase()&&(u.type="MeshStandardMaterial");break;case"mapDiffuse":u.map=s(h,r.mapDiffuseRepeat,r.mapDiffuseOffset,r.mapDiffuseWrap,r.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":u.emissiveMap=s(h,r.mapEmissiveRepeat,r.mapEmissiveOffset,r.mapEmissiveWrap,r.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":u.lightMap=s(h,r.mapLightRepeat,r.mapLightOffset,r.mapLightWrap,r.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":u.aoMap=s(h,r.mapAORepeat,r.mapAOOffset,r.mapAOWrap,r.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":u.bumpMap=s(h,r.mapBumpRepeat,r.mapBumpOffset,r.mapBumpWrap,r.mapBumpAnisotropy);break;case"mapBumpScale":u.bumpScale=h;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":u.normalMap=s(h,r.mapNormalRepeat,r.mapNormalOffset,r.mapNormalWrap,r.mapNormalAnisotropy);break;case"mapNormalFactor":u.normalScale=[h,h];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":u.specularMap=s(h,r.mapSpecularRepeat,r.mapSpecularOffset,r.mapSpecularWrap,r.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":u.metalnessMap=s(h,r.mapMetalnessRepeat,r.mapMetalnessOffset,r.mapMetalnessWrap,r.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":u.roughnessMap=s(h,r.mapRoughnessRepeat,r.mapRoughnessOffset,r.mapRoughnessWrap,r.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":u.alphaMap=s(h,r.mapAlphaRepeat,r.mapAlphaOffset,r.mapAlphaWrap,r.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":u.side=pa;break;case"doubleSided":u.side=ma;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),u.opacity=h;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":u[c]=h;break;case"vertexColors":!0===h&&(u.vertexColors=ba),"face"===h&&(u.vertexColors=Ea);break;default:console.error("THREE.Loader.createMaterial: Unsupported",c,h)}}return"MeshBasicMaterial"===u.type&&delete u.emissive,"MeshPhongMaterial"!==u.type&&delete u.specular,u.opacity<1&&(u.transparent=!0),i.setTextures(l),i.parse(u)}}()}),Object.assign(ui.prototype,{load:function(e,t,n,i){var r=this,a=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:li.prototype.extractUrlBase(e),o=new Dn(this.manager);o.setResponseType("json"),o.setWithCredentials(this.withCredentials),o.load(e,function(n){var i=n.metadata;if(void 0!==i){var o=i.type;if(void 0!==o){if("object"===o.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===o.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}}var s=r.parse(n,a);t(s.geometry,s.materials)},n,i)},setTexturePath:function(e){this.texturePath=e},parse:function(){function e(e,t){function i(e,t){return e&1<<t}var r,a,o,s,u,c,h,d,f,p,m,g,v,y,E,b,x,M,_,C,I,O,T,L,S,D,w,U=e.faces,R=e.vertices,A=e.normals,N=e.colors,P=e.scale,k=0;if(void 0!==e.uvs){for(r=0;r<e.uvs.length;r++)e.uvs[r].length&&k++;for(r=0;r<k;r++)t.faceVertexUvs[r]=[]}for(s=0,u=R.length;s<u;)M=new l,M.x=R[s++]*P,M.y=R[s++]*P,M.z=R[s++]*P,t.vertices.push(M);for(s=0,u=U.length;s<u;)if(p=U[s++],m=i(p,0),g=i(p,1),v=i(p,3),y=i(p,4),E=i(p,5),b=i(p,6),x=i(p,7),m){if(C=new he,C.a=U[s],C.b=U[s+1],C.c=U[s+3],I=new he,I.a=U[s+1],I.b=U[s+2],I.c=U[s+3],s+=4,g&&(f=U[s++],C.materialIndex=f,I.materialIndex=f),o=t.faces.length,v)for(r=0;r<k;r++)for(L=e.uvs[r],t.faceVertexUvs[r][o]=[],t.faceVertexUvs[r][o+1]=[],a=0;a<4;a++)d=U[s++],D=L[2*d],w=L[2*d+1],S=new n(D,w),2!==a&&t.faceVertexUvs[r][o].push(S),0!==a&&t.faceVertexUvs[r][o+1].push(S);if(y&&(h=3*U[s++],C.normal.set(A[h++],A[h++],A[h]),I.normal.copy(C.normal)),E)for(r=0;r<4;r++)h=3*U[s++],T=new l(A[h++],A[h++],A[h]),2!==r&&C.vertexNormals.push(T),0!==r&&I.vertexNormals.push(T);if(b&&(c=U[s++],O=N[c],C.color.setHex(O),I.color.setHex(O)),x)for(r=0;r<4;r++)c=U[s++],O=N[c],2!==r&&C.vertexColors.push(new X(O)),0!==r&&I.vertexColors.push(new X(O));t.faces.push(C),t.faces.push(I)}else{if(_=new he,_.a=U[s++],_.b=U[s++],_.c=U[s++],g&&(f=U[s++],_.materialIndex=f),o=t.faces.length,v)for(r=0;r<k;r++)for(L=e.uvs[r],t.faceVertexUvs[r][o]=[],a=0;a<3;a++)d=U[s++],D=L[2*d],w=L[2*d+1],S=new n(D,w),t.faceVertexUvs[r][o].push(S);if(y&&(h=3*U[s++],_.normal.set(A[h++],A[h++],A[h])),E)for(r=0;r<3;r++)h=3*U[s++],T=new l(A[h++],A[h++],A[h]),_.vertexNormals.push(T);if(b&&(c=U[s++],_.color.setHex(N[c])),x)for(r=0;r<3;r++)c=U[s++],_.vertexColors.push(new X(N[c]));t.faces.push(_)}}function t(e,t){var n=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var i=0,a=e.skinWeights.length;i<a;i+=n){var o=e.skinWeights[i],s=n>1?e.skinWeights[i+1]:0,l=n>2?e.skinWeights[i+2]:0,u=n>3?e.skinWeights[i+3]:0;t.skinWeights.push(new r(o,s,l,u))}if(e.skinIndices)for(var i=0,a=e.skinIndices.length;i<a;i+=n){var c=e.skinIndices[i],h=n>1?e.skinIndices[i+1]:0,d=n>2?e.skinIndices[i+2]:0,f=n>3?e.skinIndices[i+3]:0;t.skinIndices.push(new r(c,h,d,f))}t.bones=e.bones,t.bones&&t.bones.length>0&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}function i(e,t){var n=e.scale;if(void 0!==e.morphTargets)for(var i=0,r=e.morphTargets.length;i<r;i++){t.morphTargets[i]={},t.morphTargets[i].name=e.morphTargets[i].name,t.morphTargets[i].vertices=[];for(var a=t.morphTargets[i].vertices,o=e.morphTargets[i].vertices,s=0,u=o.length;s<u;s+=3){var c=new l;c.x=o[s]*n,c.y=o[s+1]*n,c.z=o[s+2]*n,a.push(c)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');for(var h=t.faces,d=e.morphColors[0].colors,i=0,r=h.length;i<r;i++)h[i].color.fromArray(d,3*i)}}function a(e,t){var n=[],i=[];void 0!==e.animation&&i.push(e.animation),void 0!==e.animations&&(e.animations.length?i=i.concat(e.animations):i.push(e.animations));for(var r=0;r<i.length;r++){var a=ai.parseAnimation(i[r],t.bones);a&&n.push(a)}if(t.morphTargets){var o=ai.CreateClipsFromMorphTargetSequences(t.morphTargets,10);n=n.concat(o)}n.length>0&&(t.animations=n)}return function(n,r){void 0!==n.data&&(n=n.data),void 0!==n.scale?n.scale=1/n.scale:n.scale=1;var o=new Oe;return e(n,o),t(n,o),i(n,o),a(n,o),o.computeFaceNormals(),o.computeBoundingSphere(),void 0===n.materials||0===n.materials.length?{geometry:o}:{geometry:o,materials:li.prototype.initMaterials(n.materials,r,this.crossOrigin)}}}()}),Object.assign(ci.prototype,{load:function(e,t,n,i){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var r=this;new Dn(r.manager).load(e,function(n){var a=null;try{a=JSON.parse(n)}catch(t){return void 0!==i&&i(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var o=a.metadata;if(void 0===o||void 0===o.type||"geometry"===o.type.toLowerCase())return void console.error("THREE.ObjectLoader: Can't load "+e+". Use THREE.JSONLoader instead.");r.parse(a,t)},n,i)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var n=this.parseGeometries(e.geometries),i=this.parseImages(e.images,function(){void 0!==t&&t(o)}),r=this.parseTextures(e.textures,i),a=this.parseMaterials(e.materials,r),o=this.parseObject(e.object,n,a);return e.animations&&(o.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(o),o},parseGeometries:function(e){var t={};if(void 0!==e)for(var n=new ui,i=new si,r=0,a=e.length;r<a;r++){var o,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new Ds[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":o=new Ds[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":o=new Ds[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":o=new Ds[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":o=new Ds[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":o=new Ds[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"IcosahedronGeometry":case"OctahedronGeometry":case"TetrahedronGeometry":o=new Ds[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":o=new Ds[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":o=new Ds[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":o=new Ds[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":o=new Ds[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"BufferGeometry":o=i.parse(s);break;case"Geometry":o=n.parse(s,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t},parseMaterials:function(e,t){var n={};if(void 0!==e){var i=new oi;i.setTextures(t);for(var r=0,a=e.length;r<a;r++){var o=e[r];if("MultiMaterial"===o.type){for(var s=[],l=0;l<o.materials.length;l++)s.push(i.parse(o.materials[l]));n[o.uuid]=s}else n[o.uuid]=i.parse(o)}}return n},parseAnimations:function(e){for(var t=[],n=0;n<e.length;n++){var i=ai.parse(e[n]);t.push(i)}return t},parseImages:function(e,t){var n=this,i={};if(void 0!==e&&e.length>0){var r=new Sn(t),a=new Rn(r);a.setCrossOrigin(this.crossOrigin);for(var o=0,s=e.length;o<s;o++){var l=e[o],u=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(l.url)?l.url:n.texturePath+l.url;i[l.uuid]=function(e){return n.manager.itemStart(e),a.load(e,function(){n.manager.itemEnd(e)},void 0,function(){n.manager.itemEnd(e),n.manager.itemError(e)})}(u)}}return i},parseTextures:function(e,t){function n(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var a=0,o=e.length;a<o;a++){var s=e[a];void 0===s.image&&console.warn('THREE.ObjectLoader: No "image" specified for',s.uuid),void 0===t[s.image]&&console.warn("THREE.ObjectLoader: Undefined image",s.image);var l=new i(t[s.image]);l.needsUpdate=!0,l.uuid=s.uuid,void 0!==s.name&&(l.name=s.name),void 0!==s.mapping&&(l.mapping=n(s.mapping,ks)),void 0!==s.offset&&l.offset.fromArray(s.offset),void 0!==s.repeat&&l.repeat.fromArray(s.repeat),void 0!==s.wrap&&(l.wrapS=n(s.wrap[0],Bs),l.wrapT=n(s.wrap[1],Bs)),void 0!==s.minFilter&&(l.minFilter=n(s.minFilter,Fs)),void 0!==s.magFilter&&(l.magFilter=n(s.magFilter,Fs)),void 0!==s.anisotropy&&(l.anisotropy=s.anisotropy),void 0!==s.flipY&&(l.flipY=s.flipY),r[s.uuid]=l}return r},parseObject:function(){var e=new u;return function(t,n,i){function r(e){return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),n[e]}function a(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],n=0,r=e.length;n<r;n++){var a=e[n];void 0===i[a]&&console.warn("THREE.ObjectLoader: Undefined material",a),t.push(i[a])}return t}return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),i[e]}}var o;switch(t.type){case"Scene":o=new gt,void 0!==t.background&&Number.isInteger(t.background)&&(o.background=new X(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?o.fog=new mt(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(o.fog=new pt(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":o=new Ae(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(o.focus=t.focus),void 0!==t.zoom&&(o.zoom=t.zoom),void 0!==t.filmGauge&&(o.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(o.filmOffset=t.filmOffset),void 0!==t.view&&(o.view=Object.assign({},t.view));break;case"OrthographicCamera":o=new Ne(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":o=new jn(t.color,t.intensity);break;case"DirectionalLight":o=new zn(t.color,t.intensity);break;case"PointLight":o=new Gn(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":o=new Wn(t.color,t.intensity,t.width,t.height);break;case"SpotLight":o=new Hn(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":o=new kn(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var s=r(t.geometry),l=a(t.material);o=s.bones&&s.bones.length>0?new _t(s,l):new Le(s,l);break;case"LOD":o=new bt;break;case"Line":o=new It(r(t.geometry),a(t.material),t.mode);break;case"LineLoop":o=new Tt(r(t.geometry),a(t.material));break;case"LineSegments":o=new Ot(r(t.geometry),a(t.material));break;case"PointCloud":case"Points":o=new St(r(t.geometry),a(t.material));break;case"Sprite":o=new Et(a(t.material));break;case"Group":o=new Dt;break;default:o=new le}if(o.uuid=t.uuid,void 0!==t.name&&(o.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(o.position,o.quaternion,o.scale)):(void 0!==t.position&&o.position.fromArray(t.position),void 0!==t.rotation&&o.rotation.fromArray(t.rotation),void 0!==t.quaternion&&o.quaternion.fromArray(t.quaternion),void 0!==t.scale&&o.scale.fromArray(t.scale)),void 0!==t.castShadow&&(o.castShadow=t.castShadow),void 0!==t.receiveShadow&&(o.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(o.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(o.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&o.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(o.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(o.visible=t.visible),void 0!==t.userData&&(o.userData=t.userData),void 0!==t.children)for(var u in t.children)o.add(this.parseObject(t.children[u],n,i));if("LOD"===t.type)for(var c=t.levels,h=0;h<c.length;h++){var d=c[h],u=o.getObjectByProperty("uuid",d.object);void 0!==u&&o.addLevel(u,d.distance)}return o}}()});var ks={UVMapping:300,CubeReflectionMapping:ao,CubeRefractionMapping:oo,EquirectangularReflectionMapping:so,EquirectangularRefractionMapping:lo,SphericalReflectionMapping:uo,CubeUVReflectionMapping:co,CubeUVRefractionMapping:ho},Bs={RepeatWrapping:fo,ClampToEdgeWrapping:po,MirroredRepeatWrapping:mo},Fs={NearestFilter:go,NearestMipMapNearestFilter:vo,NearestMipMapLinearFilter:yo,LinearFilter:Eo,LinearMipMapNearestFilter:bo,LinearMipMapLinearFilter:xo};Object.assign(xi.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],n=0;n<=e;n++)t.push(this.getPoint(n/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],n=0;n<=e;n++)t.push(this.getPointAt(n/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,n,i=[],r=this.getPoint(0),a=0;for(i.push(0),n=1;n<=e;n++)t=this.getPoint(n/e),a+=t.distanceTo(r),i.push(a),r=t;return this.cacheArcLengths=i,i},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var n,i=this.getLengths(),r=0,a=i.length;n=t||e*i[a-1];for(var o,s=0,l=a-1;s<=l;)if(r=Math.floor(s+(l-s)/2),(o=i[r]-n)<0)s=r+1;else{if(!(o>0)){l=r;break}l=r-1}if(r=l,i[r]===n)return r/(a-1);var u=i[r];return(r+(n-u)/(i[r+1]-u))/(a-1)},getTangent:function(e){var t=e-1e-4,n=e+1e-4;t<0&&(t=0),n>1&&(n=1);var i=this.getPoint(t);return this.getPoint(n).clone().sub(i).normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var n,i,r,a=new l,o=[],s=[],c=[],h=new l,d=new u;for(n=0;n<=e;n++)i=n/e,o[n]=this.getTangentAt(i),o[n].normalize();s[0]=new l,c[0]=new l;var f=Number.MAX_VALUE,p=Math.abs(o[0].x),m=Math.abs(o[0].y),g=Math.abs(o[0].z);for(p<=f&&(f=p,a.set(1,0,0)),m<=f&&(f=m,a.set(0,1,0)),g<=f&&a.set(0,0,1),h.crossVectors(o[0],a).normalize(),s[0].crossVectors(o[0],h),c[0].crossVectors(o[0],s[0]),n=1;n<=e;n++)s[n]=s[n-1].clone(),c[n]=c[n-1].clone(),h.crossVectors(o[n-1],o[n]),h.length()>Number.EPSILON&&(h.normalize(),r=Math.acos(hs.clamp(o[n-1].dot(o[n]),-1,1)),s[n].applyMatrix4(d.makeRotationAxis(h,r))),c[n].crossVectors(o[n],s[n]);if(!0===t)for(r=Math.acos(hs.clamp(s[0].dot(s[e]),-1,1)),r/=e,o[0].dot(h.crossVectors(s[0],s[e]))>0&&(r=-r),n=1;n<=e;n++)s[n].applyMatrix4(d.makeRotationAxis(o[n],r*n)),c[n].crossVectors(o[n],s[n]);return{tangents:o,normals:s,binormals:c}}}),Mi.prototype=Object.create(xi.prototype),Mi.prototype.constructor=Mi,Mi.prototype.isLineCurve=!0,Mi.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},Mi.prototype.getPointAt=function(e){return this.getPoint(e)},Mi.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},_i.prototype=Object.assign(Object.create(xi.prototype),{constructor:_i,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new Mi(t,e))},getPoint:function(e){for(var t=e*this.getLength(),n=this.getCurveLengths(),i=0;i<n.length;){if(n[i]>=t){var r=n[i]-t,a=this.curves[i],o=a.getLength(),s=0===o?0:1-r/o;return a.getPointAt(s)}i++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,n=0,i=this.curves.length;n<i;n++)t+=this.curves[n].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],n=0;n<=e;n++)t.push(this.getPoint(n/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,n=[],i=0,r=this.curves;i<r.length;i++)for(var a=r[i],o=a&&a.isEllipseCurve?2*e:a&&a.isLineCurve?1:a&&a.isSplineCurve?e*a.points.length:e,s=a.getPoints(o),l=0;l<s.length;l++){var u=s[l];t&&t.equals(u)||(n.push(u),t=u)}return this.autoClose&&n.length>1&&!n[n.length-1].equals(n[0])&&n.push(n[0]),n},createPointsGeometry:function(e){var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){for(var t=new Oe,n=0,i=e.length;n<i;n++){var r=e[n];t.vertices.push(new l(r.x,r.y,r.z||0))}return t}}),Ci.prototype=Object.create(xi.prototype),Ci.prototype.constructor=Ci,Ci.prototype.isEllipseCurve=!0,Ci.prototype.getPoint=function(e){for(var t=2*Math.PI,i=this.aEndAngle-this.aStartAngle,r=Math.abs(i)<Number.EPSILON;i<0;)i+=t;for(;i>t;)i-=t;i<Number.EPSILON&&(i=r?0:t),!0!==this.aClockwise||r||(i===t?i=-t:i-=t);var a=this.aStartAngle+e*i,o=this.aX+this.xRadius*Math.cos(a),s=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){var l=Math.cos(this.aRotation),u=Math.sin(this.aRotation),c=o-this.aX,h=s-this.aY;o=c*l-h*u+this.aX,s=c*u+h*l+this.aY}return new n(o,s)},Ii.prototype=Object.create(xi.prototype),Ii.prototype.constructor=Ii,Ii.prototype.isSplineCurve=!0,Ii.prototype.getPoint=function(e){var t=this.points,i=(t.length-1)*e,r=Math.floor(i),a=i-r,o=t[0===r?r:r-1],s=t[r],l=t[r>t.length-2?t.length-1:r+1],u=t[r>t.length-3?t.length-1:r+2];return new n(hi(a,o.x,s.x,l.x,u.x),hi(a,o.y,s.y,l.y,u.y))},Oi.prototype=Object.create(xi.prototype),Oi.prototype.constructor=Oi,Oi.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2,a=this.v3;return new n(bi(e,t.x,i.x,r.x,a.x),bi(e,t.y,i.y,r.y,a.y))},Ti.prototype=Object.create(xi.prototype),Ti.prototype.constructor=Ti,Ti.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2;return new n(mi(e,t.x,i.x,r.x),mi(e,t.y,i.y,r.y))};var Hs=Object.assign(Object.create(_i.prototype),{fromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,n=e.length;t<n;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var i=new Mi(this.currentPoint.clone(),new n(e,t));this.curves.push(i),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,i,r){var a=new Ti(this.currentPoint.clone(),new n(e,t),new n(i,r));this.curves.push(a),this.currentPoint.set(i,r)},bezierCurveTo:function(e,t,i,r,a,o){var s=new Oi(this.currentPoint.clone(),new n(e,t),new n(i,r),new n(a,o));this.curves.push(s),this.currentPoint.set(a,o)},splineThru:function(e){var t=[this.currentPoint.clone()].concat(e),n=new Ii(t);this.curves.push(n),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,n,i,r,a){var o=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+o,t+s,n,i,r,a)},absarc:function(e,t,n,i,r,a){this.absellipse(e,t,n,n,i,r,a)},ellipse:function(e,t,n,i,r,a,o,s){var l=this.currentPoint.x,u=this.currentPoint.y;this.absellipse(e+l,t+u,n,i,r,a,o,s)},absellipse:function(e,t,n,i,r,a,o,s){var l=new Ci(e,t,n,i,r,a,o,s);if(this.curves.length>0){var u=l.getPoint(0);u.equals(this.currentPoint)||this.lineTo(u.x,u.y)}this.curves.push(l);var c=l.getPoint(1);this.currentPoint.copy(c)}});Li.prototype=Hs,Hs.constructor=Li,Si.prototype=Object.assign(Object.create(Hs),{constructor:Si,getPointsHoles:function(e){for(var t=[],n=0,i=this.holes.length;n<i;n++)t[n]=this.holes[n].getPoints(e);return t},extractAllPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},extractPoints:function(e){return this.extractAllPoints(e)}}),Object.assign(Di.prototype,{moveTo:function(e,t){this.currentPath=new Li,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,n,i){this.currentPath.quadraticCurveTo(e,t,n,i)},bezierCurveTo:function(e,t,n,i,r,a){this.currentPath.bezierCurveTo(e,t,n,i,r,a)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function n(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e[n],a=new Si;a.curves=r.curves,t.push(a)}return t}var i=Ss.isClockWise,r=this.subPaths;if(0===r.length)return[];if(!0===t)return n(r);var a,o,s,l=[];if(1===r.length)return o=r[0],s=new Si,s.curves=o.curves,l.push(s),l;var u=!i(r[0].getPoints());u=e?!u:u;var c,h=[],d=[],f=[],p=0;d[p]=void 0,f[p]=[];for(var m=0,g=r.length;m<g;m++)o=r[m],c=o.getPoints(),a=i(c),a=e?!a:a,a?(!u&&d[p]&&p++,d[p]={s:new Si,p:c},d[p].s.curves=o.curves,u&&p++,f[p]=[]):f[p].push({h:o,p:c[0]});if(!d[0])return n(r);if(d.length>1){for(var v=!1,y=[],E=0,b=d.length;E<b;E++)h[E]=[];for(var E=0,b=d.length;E<b;E++)for(var x=f[E],M=0;M<x.length;M++){for(var _=x[M],C=!0,I=0;I<d.length;I++)(function(e,t){for(var n=t.length,i=!1,r=n-1,a=0;a<n;r=a++){var o=t[r],s=t[a],l=s.x-o.x,u=s.y-o.y;if(Math.abs(u)>Number.EPSILON){if(u<0&&(o=t[a],l=-l,s=t[r],u=-u),e.y<o.y||e.y>s.y)continue;if(e.y===o.y){if(e.x===o.x)return!0}else{var c=u*(e.x-o.x)-l*(e.y-o.y);if(0===c)return!0;if(c<0)continue;i=!i}}else{if(e.y!==o.y)continue;if(s.x<=e.x&&e.x<=o.x||o.x<=e.x&&e.x<=s.x)return!0}}return i})(_.p,d[I].p)&&(E!==I&&y.push({froms:E,tos:I,hole:M}),C?(C=!1,h[I].push(_)):v=!0);C&&h[E].push(_)}y.length>0&&(v||(f=h))}for(var O,m=0,T=d.length;m<T;m++){s=d[m].s,l.push(s),O=f[m];for(var L=0,S=O.length;L<S;L++)s.holes.push(O[L].h)}return l}}),Object.assign(wi.prototype,{isFont:!0,generateShapes:function(e,t,n){function i(e,t,n,i){var a=r.glyphs[e]||r.glyphs["?"];if(a){var o,s,l,u,c,h,d,f,p,m=new Di,g=[];if(a.o)for(var v=a._cachedOutline||(a._cachedOutline=a.o.split(" ")),y=0,E=v.length;y<E;){var b=v[y++];switch(b){case"m":o=v[y++]*t+n,s=v[y++]*t+i,m.moveTo(o,s);break;case"l":o=v[y++]*t+n,s=v[y++]*t+i,m.lineTo(o,s);break;case"q":l=v[y++]*t+n,u=v[y++]*t+i,c=v[y++]*t+n,h=v[y++]*t+i,m.quadraticCurveTo(c,h,l,u),p=g[g.length-1],p&&(p.x,p.y);break;case"b":l=v[y++]*t+n,u=v[y++]*t+i,c=v[y++]*t+n,h=v[y++]*t+i,d=v[y++]*t+n,f=v[y++]*t+i,m.bezierCurveTo(c,h,d,f,l,u),p=g[g.length-1],p&&(p.x,p.y)}}return{offsetX:a.ha*t,path:m}}}void 0===t&&(t=100),void 0===n&&(n=4);for(var r=this.data,a=function(e){for(var n=String(e).split(""),a=t/r.resolution,o=(r.boundingBox.yMax-r.boundingBox.yMin+r.underlineThickness)*a,s=0,l=0,u=[],c=0;c<n.length;c++){var h=n[c];if("\n"===h)s=0,l-=o;else{var d=i(h,a,s,l);s+=d.offsetX,u.push(d.path)}}return u}(e),o=[],s=0,l=a.length;s<l;s++)Array.prototype.push.apply(o,a[s].toShapes());return o}}),Object.assign(Ui.prototype,{load:function(e,t,n,i){var r=this;new Dn(this.manager).load(e,function(e){var n;try{n=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),n=JSON.parse(e.substring(65,e.length-2))}var i=r.parse(n);t&&t(i)},n,i)},parse:function(e){return new wi(e)}});var Gs,Vs={getContext:function(){return void 0===Gs&&(Gs=new(window.AudioContext||window.webkitAudioContext)),Gs},setContext:function(e){Gs=e}};Object.assign(Ri.prototype,{load:function(e,t,n,i){var r=new Dn(this.manager);r.setResponseType("arraybuffer"),r.load(e,function(e){Vs.getContext().decodeAudioData(e,function(e){t(e)})},n,i)}}),Object.assign(Ai.prototype,{update:function(){var e,t,n,i,r,a,o,s,l=new u,c=new u;return function(u){if(e!==this||t!==u.focus||n!==u.fov||i!==u.aspect*this.aspect||r!==u.near||a!==u.far||o!==u.zoom||s!==this.eyeSep){e=this,t=u.focus,n=u.fov,i=u.aspect*this.aspect,r=u.near,a=u.far,o=u.zoom;var h=u.projectionMatrix.clone();s=this.eyeSep/2;var d,f,p=s*r/t,m=r*Math.tan(hs.DEG2RAD*n*.5)/o;c.elements[12]=-s,l.elements[12]=s,d=-m*i+p,f=m*i+p,h.elements[0]=2*r/(f-d),h.elements[8]=(f+d)/(f-d),this.cameraL.projectionMatrix.copy(h),d=-m*i-p,f=m*i-p,h.elements[0]=2*r/(f-d),h.elements[8]=(f+d)/(f-d),this.cameraR.projectionMatrix.copy(h)}this.cameraL.matrixWorld.copy(u.matrixWorld).multiply(c),this.cameraR.matrixWorld.copy(u.matrixWorld).multiply(l)}}()}),Ni.prototype=Object.create(le.prototype),Ni.prototype.constructor=Ni,Pi.prototype=Object.assign(Object.create(Ae.prototype),{constructor:Pi,isArrayCamera:!0}),ki.prototype=Object.assign(Object.create(le.prototype),{constructor:ki,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),
this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:function(){var e=new l,t=new s,n=new l,i=new l;return function(r){le.prototype.updateMatrixWorld.call(this,r);var a=this.context.listener,o=this.up;this.matrixWorld.decompose(e,t,n),i.set(0,0,-1).applyQuaternion(t),a.positionX?(a.positionX.setValueAtTime(e.x,this.context.currentTime),a.positionY.setValueAtTime(e.y,this.context.currentTime),a.positionZ.setValueAtTime(e.z,this.context.currentTime),a.forwardX.setValueAtTime(i.x,this.context.currentTime),a.forwardY.setValueAtTime(i.y,this.context.currentTime),a.forwardZ.setValueAtTime(i.z,this.context.currentTime),a.upX.setValueAtTime(o.x,this.context.currentTime),a.upY.setValueAtTime(o.y,this.context.currentTime),a.upZ.setValueAtTime(o.z,this.context.currentTime)):(a.setPosition(e.x,e.y,e.z),a.setOrientation(i.x,i.y,i.z,o.x,o.y,o.z))}}()}),Bi.prototype=Object.assign(Object.create(le.prototype),{constructor:Bi,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");var e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.onended=this.onEnded.bind(this),e.playbackRate.setValueAtTime(this.playbackRate,this.startTime),e.start(0,this.startTime),this.isPlaying=!0,this.source=e,this.connect()},pause:function(){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.source.stop(),this.startTime=this.context.currentTime,this.isPlaying=!1,this)},stop:function(){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.source.stop(),this.startTime=0,this.isPlaying=!1,this)},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this)},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this)},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),Fi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:Fi,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:function(){var e=new l;return function(t){le.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}()}),Object.assign(Hi.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),n=0;n<t.length;n++)e+=t[n];return e/t.length}}),Object.assign(Gi.prototype,{accumulate:function(e,t){var n=this.buffer,i=this.valueSize,r=e*i+i,a=this.cumulativeWeight;if(0===a){for(var o=0;o!==i;++o)n[r+o]=n[o];a=t}else{a+=t;var s=t/a;this._mixBufferRegion(n,r,0,s,i)}this.cumulativeWeight=a},apply:function(e){var t=this.valueSize,n=this.buffer,i=e*t+t,r=this.cumulativeWeight,a=this.binding;if(this.cumulativeWeight=0,r<1){var o=3*t;this._mixBufferRegion(n,i,o,1-r,t)}for(var s=t,l=t+t;s!==l;++s)if(n[s]!==n[s+t]){a.setValue(n,i);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,n=this.valueSize,i=3*n;e.getValue(t,i);for(var r=n,a=i;r!==a;++r)t[r]=t[i+r%n];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,n,i,r){if(i>=.5)for(var a=0;a!==r;++a)e[t+a]=e[n+a]},_slerp:function(e,t,n,i){s.slerpFlat(e,t,e,t,e,n,i)},_lerp:function(e,t,n,i,r){for(var a=1-i,o=0;o!==r;++o){var s=t+o;e[s]=e[s]*a+e[n+o]*i}}}),Object.assign(Vi.prototype,{getValue:function(e,t){this.bind();var n=this._targetGroup.nCachedObjects_,i=this._bindings[n];void 0!==i&&i.getValue(e,t)},setValue:function(e,t){for(var n=this._bindings,i=this._targetGroup.nCachedObjects_,r=n.length;i!==r;++i)n[i].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].unbind()}}),Object.assign(zi,{Composite:Vi,create:function(e,t,n){return e&&e.isAnimationObjectGroup?new zi.Composite(e,t,n):new zi(e,t,n)},parseTrackName:function(){var e=/((?:[\w-]+[\/:])*)/,t=/([\w-\.]+)?/,n=/(?:\.([\w-]+)(?:\[(.+)\])?)?/,i=/\.([\w-]+)(?:\[(.+)\])?/,r=new RegExp("^"+e.source+t.source+n.source+i.source+"$"),a=["material","materials","bones"];return function(e){var t=r.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);var n={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},i=n.nodeName&&n.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){var o=n.nodeName.substring(i+1);-1!==a.indexOf(o)&&(n.nodeName=n.nodeName.substring(0,i),n.objectName=o)}if(null===n.propertyName||0===n.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return n}}(),findNode:function(e,t){if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var n=function(e){for(var n=0;n<e.bones.length;n++){var i=e.bones[n];if(i.name===t)return i}return null}(e.skeleton);if(n)return n}if(e.children){var i=function e(n){for(var i=0;i<n.length;i++){var r=n[i];if(r.name===t||r.uuid===t)return r;var a=e(r.children);if(a)return a}return null}(e.children);if(i)return i}return null}}),Object.assign(zi.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){for(var n=this.resolvedProperty,i=0,r=n.length;i!==r;++i)e[t++]=n[i]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.node[this.propertyName]=e[t]},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){for(var n=this.resolvedProperty,i=0,r=n.length;i!==r;++i)n[i]=e[t++]},function(e,t){for(var n=this.resolvedProperty,i=0,r=n.length;i!==r;++i)n[i]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){for(var n=this.resolvedProperty,i=0,r=n.length;i!==r;++i)n[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,n=t.objectName,i=t.propertyName,r=t.propertyIndex;if(e||(e=zi.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.error("  trying to update node for track: "+this.path+" but it wasn't found.");if(n){var a=t.objectIndex;switch(n){case"materials":if(!e.material)return void console.error("  can not bind to material as node does not have a material",this);if(!e.material.materials)return void console.error("  can not bind to material.materials as node.material does not have a materials array",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("  can not bind to bones as node does not have a skeleton",this);e=e.skeleton.bones;for(var o=0;o<e.length;o++)if(e[o].name===a){a=o;break}break;default:if(void 0===e[n])return void console.error("  can not bind to objectName of node, undefined",this);e=e[n]}if(void 0!==a){if(void 0===e[a])return void console.error("  trying to bind to objectIndex of objectName, but is undefined:",this,e);e=e[a]}}var s=e[i];if(void 0===s){var l=t.nodeName;return void console.error("  trying to update property for track: "+l+"."+i+" but it wasn't found.",e)}var u=this.Versioning.None;void 0!==e.needsUpdate?(u=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(u=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var c=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===i){if(!e.geometry)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry",this);if(!e.geometry.morphTargets)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry.morphTargets",this);for(var o=0;o<this.node.geometry.morphTargets.length;o++)if(e.geometry.morphTargets[o].name===r){r=o;break}}c=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else void 0!==s.fromArray&&void 0!==s.toArray?(c=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(c=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=i;this.getValue=this.GetterByBindingType[c],this.setValue=this.SetterByBindingTypeAndVersioning[c][u]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(zi.prototype,{_getValue_unbound:zi.prototype.getValue,_setValue_unbound:zi.prototype.setValue}),Object.assign(ji.prototype,{isAnimationObjectGroup:!0,add:function(e){for(var t=this._objects,n=t.length,i=this.nCachedObjects_,r=this._indicesByUUID,a=this._paths,o=this._parsedPaths,s=this._bindings,l=s.length,u=0,c=arguments.length;u!==c;++u){var h=arguments[u],d=h.uuid,f=r[d],p=void 0;if(void 0===f){f=n++,r[d]=f,t.push(h);for(var m=0,g=l;m!==g;++m)s[m].push(new zi(h,a[m],o[m]))}else if(f<i){p=t[f];var v=--i,y=t[v];r[y.uuid]=f,t[f]=y,r[d]=v,t[v]=h;for(var m=0,g=l;m!==g;++m){var E=s[m],b=E[v],x=E[f];E[f]=b,void 0===x&&(x=new zi(h,a[m],o[m])),E[v]=x}}else t[f]!==p&&console.error("Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes...")}this.nCachedObjects_=i},remove:function(e){for(var t=this._objects,n=this.nCachedObjects_,i=this._indicesByUUID,r=this._bindings,a=r.length,o=0,s=arguments.length;o!==s;++o){var l=arguments[o],u=l.uuid,c=i[u];if(void 0!==c&&c>=n){var h=n++,d=t[h];i[d.uuid]=c,t[c]=d,i[u]=h,t[h]=l;for(var f=0,p=a;f!==p;++f){var m=r[f],g=m[h],v=m[c];m[c]=g,m[h]=v}}}this.nCachedObjects_=n},uncache:function(e){for(var t=this._objects,n=t.length,i=this.nCachedObjects_,r=this._indicesByUUID,a=this._bindings,o=a.length,s=0,l=arguments.length;s!==l;++s){var u=arguments[s],c=u.uuid,h=r[c];if(void 0!==h)if(delete r[c],h<i){var d=--i,f=t[d],p=--n,m=t[p];r[f.uuid]=h,t[h]=f,r[m.uuid]=d,t[d]=m,t.pop();for(var g=0,v=o;g!==v;++g){var y=a[g],E=y[d],b=y[p];y[h]=E,y[d]=b,y.pop()}}else{var p=--n,m=t[p];r[m.uuid]=h,t[h]=m,t.pop();for(var g=0,v=o;g!==v;++g){var y=a[g];y[h]=y[p],y.pop()}}}this.nCachedObjects_=i},subscribe_:function(e,t){var n=this._bindingsIndicesByPath,i=n[e],r=this._bindings;if(void 0!==i)return r[i];var a=this._paths,o=this._parsedPaths,s=this._objects,l=s.length,u=this.nCachedObjects_,c=new Array(l);i=r.length,n[e]=i,a.push(e),o.push(t),r.push(c);for(var h=u,d=s.length;h!==d;++h){var f=s[h];c[h]=new zi(f,e,t)}return c},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,n=t[e];if(void 0!==n){var i=this._paths,r=this._parsedPaths,a=this._bindings,o=a.length-1,s=a[o];t[e[o]]=n,a[n]=s,a.pop(),r[n]=r[o],r.pop(),i[n]=i[o],i.pop()}}}),Object.assign(Wi.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,n){if(e.fadeOut(t),this.fadeIn(t),n){var i=this._clip.duration,r=e._clip.duration,a=r/i,o=i/r;e.warp(1,a,t),this.warp(o,1,t)}return this},crossFadeTo:function(e,t,n){return e.crossFadeFrom(this,t,n)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,n){var i=this._mixer,r=i.time,a=this._timeScaleInterpolant,o=this.timeScale;null===a&&(a=i._lendControlInterpolant(),this._timeScaleInterpolant=a);var s=a.parameterPositions,l=a.sampleValues;return s[0]=r,s[1]=r+n,l[0]=e/o,l[1]=t/o,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,n,i){if(!this.enabled)return void this._updateWeight(e);var r=this._startTime;if(null!==r){var a=(e-r)*n;if(a<0||0===n)return;this._startTime=null,t=n*a}t*=this._updateTimeScale(e);var o=this._updateTime(t),s=this._updateWeight(e);if(s>0)for(var l=this._interpolants,u=this._propertyBindings,c=0,h=l.length;c!==h;++c)l[c].evaluate(o),u[c].accumulate(i,s)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var n=this._weightInterpolant;if(null!==n){var i=n.evaluate(e)[0];t*=i,e>n.parameterPositions[1]&&(this.stopFading(),0===i&&(this.enabled=!1))}}return this._effectiveWeight=t,t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var n=this._timeScaleInterpolant;if(null!==n){t*=n.evaluate(e)[0],e>n.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var n=this._clip.duration,i=this.loop,r=this._loopCount;if(2200===i){-1===r&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(t>=n)t=n;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var a=2202===i;if(-1===r&&(e>=0?(r=0,this._setEndings(!0,0===this.repetitions,a)):this._setEndings(0===this.repetitions,!0,a)),t>=n||t<0){var o=Math.floor(t/n);t-=n*o,r+=Math.abs(o);var s=this.repetitions-r;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=e>0?n:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(0===s){var l=e<0;this._setEndings(l,!l,a)}else this._setEndings(!1,!1,a);this._loopCount=r,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}if(a&&1==(1&r))return this.time=t,n-t}return this.time=t,t},_setEndings:function(e,t,n){var i=this._interpolantSettings;n?(i.endingStart=2401,i.endingEnd=2401):(i.endingStart=e?this.zeroSlopeAtStart?2401:Jo:2402,i.endingEnd=t?this.zeroSlopeAtEnd?2401:Jo:2402)},_scheduleFading:function(e,t,n){var i=this._mixer,r=i.time,a=this._weightInterpolant;null===a&&(a=i._lendControlInterpolant(),this._weightInterpolant=a);var o=a.parameterPositions,s=a.sampleValues;return o[0]=r,s[0]=t,o[1]=r+e,s[1]=n,this}}),Object.assign(Xi.prototype,t.prototype,{_bindAction:function(e,t){var n=e._localRoot||this._root,i=e._clip.tracks,r=i.length,a=e._propertyBindings,o=e._interpolants,s=n.uuid,l=this._bindingsByRootAndName,u=l[s];void 0===u&&(u={},l[s]=u);for(var c=0;c!==r;++c){var h=i[c],d=h.name,f=u[d];if(void 0!==f)a[c]=f;else{if(void 0!==(f=a[c])){null===f._cacheIndex&&(++f.referenceCount,this._addInactiveBinding(f,s,d));continue}var p=t&&t._propertyBindings[c].binding.parsedPath;f=new Gi(zi.create(n,d,p),h.ValueTypeName,h.getValueSize()),++f.referenceCount,this._addInactiveBinding(f,s,d),a[c]=f}o[c].resultBuffer=f.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,n=e._clip.uuid,i=this._actionsByClip[n];this._bindAction(e,i&&i.knownActions[0]),this._addInactiveAction(e,n,t)}for(var r=e._propertyBindings,a=0,o=r.length;a!==o;++a){var s=r[a];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,n=0,i=t.length;n!==i;++n){var r=t[n];0==--r.useCount&&(r.restoreOriginalState(),this._takeBackBinding(r))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,n){var i=this._actions,r=this._actionsByClip,a=r[t];if(void 0===a)a={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,r[t]=a;else{var o=a.knownActions;e._byClipCacheIndex=o.length,o.push(e)}e._cacheIndex=i.length,i.push(e),a.actionByRoot[n]=e},_removeInactiveAction:function(e){var t=this._actions,n=t[t.length-1],i=e._cacheIndex;n._cacheIndex=i,t[i]=n,t.pop(),e._cacheIndex=null;var r=e._clip.uuid,a=this._actionsByClip,o=a[r],s=o.knownActions,l=s[s.length-1],u=e._byClipCacheIndex;l._byClipCacheIndex=u,s[u]=l,s.pop(),e._byClipCacheIndex=null,delete o.actionByRoot[(e._localRoot||this._root).uuid],0===s.length&&delete a[r],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,n=0,i=t.length;n!==i;++n){var r=t[n];0==--r.referenceCount&&this._removeInactiveBinding(r)}},_lendAction:function(e){var t=this._actions,n=e._cacheIndex,i=this._nActiveActions++,r=t[i];e._cacheIndex=i,t[i]=e,r._cacheIndex=n,t[n]=r},_takeBackAction:function(e){var t=this._actions,n=e._cacheIndex,i=--this._nActiveActions,r=t[i];e._cacheIndex=i,t[i]=e,r._cacheIndex=n,t[n]=r},_addInactiveBinding:function(e,t,n){var i=this._bindingsByRootAndName,r=i[t],a=this._bindings;void 0===r&&(r={},i[t]=r),r[n]=e,e._cacheIndex=a.length,a.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,n=e.binding,i=n.rootNode.uuid,r=n.path,a=this._bindingsByRootAndName,o=a[i],s=t[t.length-1],l=e._cacheIndex;s._cacheIndex=l,t[l]=s,t.pop(),delete o[r];e:{for(var u in o)break e;delete a[i]}},_lendBinding:function(e){var t=this._bindings,n=e._cacheIndex,i=this._nActiveBindings++,r=t[i];e._cacheIndex=i,t[i]=e,r._cacheIndex=n,t[n]=r},_takeBackBinding:function(e){var t=this._bindings,n=e._cacheIndex,i=--this._nActiveBindings,r=t[i];e._cacheIndex=i,t[i]=e,r._cacheIndex=n,t[n]=r},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,n=e[t];return void 0===n&&(n=new qn(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),n.__cacheIndex=t,e[t]=n),n},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,n=e.__cacheIndex,i=--this._nActiveControlInterpolants,r=t[i];e.__cacheIndex=i,t[i]=e,r.__cacheIndex=n,t[n]=r},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var n=t||this._root,i=n.uuid,r="string"==typeof e?ai.findByName(n,e):e,a=null!==r?r.uuid:e,o=this._actionsByClip[a],s=null;if(void 0!==o){var l=o.actionByRoot[i];if(void 0!==l)return l;s=o.knownActions[0],null===r&&(r=s._clip)}if(null===r)return null;var u=new Wi(this,r,t);return this._bindAction(u,s),this._addInactiveAction(u,a,i),u},existingAction:function(e,t){var n=t||this._root,i=n.uuid,r="string"==typeof e?ai.findByName(n,e):e,a=r?r.uuid:e,o=this._actionsByClip[a];return void 0!==o?o.actionByRoot[i]||null:null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,n=this._bindings,i=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var r=0;r!==t;++r)e[r].reset();for(var r=0;r!==i;++r)n[r].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,n=this._nActiveActions,i=this.time+=e,r=Math.sign(e),a=this._accuIndex^=1,o=0;o!==n;++o){t[o]._update(i,e,r,a)}for(var s=this._bindings,l=this._nActiveBindings,o=0;o!==l;++o)s[o].apply(a);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,n=e.uuid,i=this._actionsByClip,r=i[n];if(void 0!==r){for(var a=r.knownActions,o=0,s=a.length;o!==s;++o){var l=a[o];this._deactivateAction(l);var u=l._cacheIndex,c=t[t.length-1];l._cacheIndex=null,l._byClipCacheIndex=null,c._cacheIndex=u,t[u]=c,t.pop(),this._removeInactiveBindingsForAction(l)}delete i[n]}},uncacheRoot:function(e){var t=e.uuid,n=this._actionsByClip;for(var i in n){var r=n[i].actionByRoot,a=r[t];void 0!==a&&(this._deactivateAction(a),this._removeInactiveAction(a))}var o=this._bindingsByRootAndName,s=o[t];if(void 0!==s)for(var l in s){var u=s[l];u.restoreOriginalState(),this._removeInactiveBinding(u)}},uncacheAction:function(e,t){var n=this.existingAction(e,t);null!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}}),Yi.prototype.clone=function(){return new Yi(void 0===this.value.clone?this.value:this.value.clone())},qi.prototype=Object.assign(Object.create(Te.prototype),{constructor:qi,isInstancedBufferGeometry:!0,addGroup:function(e,t,n){this.groups.push({start:e,count:t,materialIndex:n})},copy:function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var n=e.attributes;for(var i in n){var r=n[i];this.addAttribute(i,r.clone())}for(var a=e.groups,o=0,s=a.length;o<s;o++){var l=a[o];this.addGroup(l.start,l.count,l.materialIndex)}return this}}),Object.defineProperties(Zi.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(Zi.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=n,this},setXYZ:function(e,t,n,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=i,this},setXYZW:function(e,t,n,i,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=i,this.data.array[e+3]=r,this}}),Object.defineProperty(Ki.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(Ki.prototype,{isInterleavedBuffer:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,n){e*=this.stride,n*=t.stride;for(var i=0,r=this.stride;i<r;i++)this.array[e+i]=t.array[n+i];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),Qi.prototype=Object.assign(Object.create(Ki.prototype),{constructor:Qi,isInstancedInterleavedBuffer:!0,copy:function(e){return Ki.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Ji.prototype=Object.assign(Object.create(fe.prototype),{constructor:Ji,isInstancedBufferAttribute:!0,copy:function(e){return fe.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Object.assign($i.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,-1).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var n=[];return tr(e,this,n,t),n.sort(er),n},intersectObjects:function(e,t){var n=[];if(!1===Array.isArray(e))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),n;for(var i=0,r=e.length;i<r;i++)tr(e[i],this,n,t);return n.sort(er),n}}),Object.assign(nr.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}),Object.assign(ir.prototype,{set:function(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(hs.clamp(e.y/this.radius,-1,1))),this}}),Object.assign(rr.prototype,{set:function(e,t,n){return this.radius=e,this.theta=t,this.y=n,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.radius=Math.sqrt(e.x*e.x+e.z*e.z),this.theta=Math.atan2(e.x,e.z),this.y=e.y,this}}),ar.prototype=Object.create(Le.prototype),ar.prototype.constructor=ar,ar.prototype.createAnimation=function(e,t,n,i){var r={start:t,end:n,length:n-t+1,fps:i,duration:(n-t)/i,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=r,this.animationsList.push(r)},ar.prototype.autoCreateAnimations=function(e){for(var t,n=/([a-z]+)_?(\d+)/i,i={},r=this.geometry,a=0,o=r.morphTargets.length;a<o;a++){var s=r.morphTargets[a],l=s.name.match(n);if(l&&l.length>1){var u=l[1];i[u]||(i[u]={start:1/0,end:-1/0});var c=i[u];a<c.start&&(c.start=a),a>c.end&&(c.end=a),t||(t=u)}}for(var u in i){var c=i[u];this.createAnimation(u,c.start,c.end,e)}this.firstAnimation=t},ar.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},ar.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},ar.prototype.setAnimationFPS=function(e,t){var n=this.animationsMap[e];n&&(n.fps=t,n.duration=(n.end-n.start)/n.fps)},ar.prototype.setAnimationDuration=function(e,t){var n=this.animationsMap[e];n&&(n.duration=t,n.fps=(n.end-n.start)/n.duration)},ar.prototype.setAnimationWeight=function(e,t){var n=this.animationsMap[e];n&&(n.weight=t)},ar.prototype.setAnimationTime=function(e,t){var n=this.animationsMap[e];n&&(n.time=t)},ar.prototype.getAnimationTime=function(e){var t=0,n=this.animationsMap[e];return n&&(t=n.time),t},ar.prototype.getAnimationDuration=function(e){var t=-1,n=this.animationsMap[e];return n&&(t=n.duration),t},ar.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("THREE.MorphBlendMesh: animation["+e+"] undefined in .playAnimation()")},ar.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},ar.prototype.update=function(e){for(var t=0,n=this.animationsList.length;t<n;t++){var i=this.animationsList[t];if(i.active){var r=i.duration/i.length
;i.time+=i.direction*e,i.mirroredLoop?(i.time>i.duration||i.time<0)&&(i.direction*=-1,i.time>i.duration&&(i.time=i.duration,i.directionBackwards=!0),i.time<0&&(i.time=0,i.directionBackwards=!1)):(i.time=i.time%i.duration,i.time<0&&(i.time+=i.duration));var a=i.start+hs.clamp(Math.floor(i.time/r),0,i.length-1),o=i.weight;a!==i.currentFrame&&(this.morphTargetInfluences[i.lastFrame]=0,this.morphTargetInfluences[i.currentFrame]=1*o,this.morphTargetInfluences[a]=0,i.lastFrame=i.currentFrame,i.currentFrame=a);var s=i.time%r/r;i.directionBackwards&&(s=1-s),i.currentFrame!==i.lastFrame?(this.morphTargetInfluences[i.currentFrame]=s*o,this.morphTargetInfluences[i.lastFrame]=(1-s)*o):this.morphTargetInfluences[i.currentFrame]=o}}},or.prototype=Object.create(le.prototype),or.prototype.constructor=or,or.prototype.isImmediateRenderObject=!0,sr.prototype=Object.create(Ot.prototype),sr.prototype.constructor=sr,sr.prototype.update=function(){var e=new l,t=new l,n=new te;return function(){var i=["a","b","c"];this.object.updateMatrixWorld(!0),n.getNormalMatrix(this.object.matrixWorld);var r=this.object.matrixWorld,a=this.geometry.attributes.position,o=this.object.geometry;if(o&&o.isGeometry)for(var s=o.vertices,l=o.faces,u=0,c=0,h=l.length;c<h;c++)for(var d=l[c],f=0,p=d.vertexNormals.length;f<p;f++){var m=s[d[i[f]]],g=d.vertexNormals[f];e.copy(m).applyMatrix4(r),t.copy(g).applyMatrix3(n).normalize().multiplyScalar(this.size).add(e),a.setXYZ(u,e.x,e.y,e.z),u+=1,a.setXYZ(u,t.x,t.y,t.z),u+=1}else if(o&&o.isBufferGeometry)for(var v=o.attributes.position,y=o.attributes.normal,u=0,f=0,p=v.count;f<p;f++)e.set(v.getX(f),v.getY(f),v.getZ(f)).applyMatrix4(r),t.set(y.getX(f),y.getY(f),y.getZ(f)),t.applyMatrix3(n).normalize().multiplyScalar(this.size).add(e),a.setXYZ(u,e.x,e.y,e.z),u+=1,a.setXYZ(u,t.x,t.y,t.z),u+=1;a.needsUpdate=!0}}(),lr.prototype=Object.create(le.prototype),lr.prototype.constructor=lr,lr.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},lr.prototype.update=function(){var e=new l,t=new l;return function(){var n=this.light.distance?this.light.distance:1e3,i=n*Math.tan(this.light.angle);this.cone.scale.set(i,i,n),e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t.sub(e)),this.cone.material.color.copy(this.light.color)}}(),ur.prototype=Object.create(Ot.prototype),ur.prototype.constructor=ur,ur.prototype.getBoneList=function(e){var t=[];e&&e.isBone&&t.push(e);for(var n=0;n<e.children.length;n++)t.push.apply(t,this.getBoneList(e.children[n]));return t},ur.prototype.update=function(){var e=new l,t=new u,n=new u;return function(){var i=this.geometry,r=i.getAttribute("position");n.getInverse(this.root.matrixWorld);for(var a=0,o=0;a<this.bones.length;a++){var s=this.bones[a];s.parent&&s.parent.isBone&&(t.multiplyMatrices(n,s.matrixWorld),e.setFromMatrixPosition(t),r.setXYZ(o,e.x,e.y,e.z),t.multiplyMatrices(n,s.parent.matrixWorld),e.setFromMatrixPosition(t),r.setXYZ(o+1,e.x,e.y,e.z),o+=2)}i.getAttribute("position").needsUpdate=!0}}(),cr.prototype=Object.create(Le.prototype),cr.prototype.constructor=cr,cr.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},cr.prototype.update=function(){this.material.color.copy(this.light.color)},hr.prototype=Object.create(le.prototype),hr.prototype.constructor=hr,hr.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},hr.prototype.update=function(){var e=this.children[0];e.material.color.copy(this.light.color);var t=.5*this.light.width,n=.5*this.light.height,i=e.geometry.attributes.position,r=i.array;r[0]=t,r[1]=-n,r[2]=0,r[3]=t,r[4]=n,r[5]=0,r[6]=-t,r[7]=n,r[8]=0,r[9]=-t,r[10]=-n,r[11]=0,r[12]=t,r[13]=-n,r[14]=0,i.needsUpdate=!0},dr.prototype=Object.create(le.prototype),dr.prototype.constructor=dr,dr.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},dr.prototype.update=function(){var e=new l,t=new X,n=new X;return function(){var i=this.children[0],r=i.geometry.getAttribute("color");t.copy(this.light.color),n.copy(this.light.groundColor);for(var a=0,o=r.count;a<o;a++){var s=a<o/2?t:n;r.setXYZ(a,s.r,s.g,s.b)}i.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate()),r.needsUpdate=!0}}(),fr.prototype=Object.create(Ot.prototype),fr.prototype.constructor=fr,pr.prototype=Object.create(Ot.prototype),pr.prototype.constructor=pr,mr.prototype=Object.create(Ot.prototype),mr.prototype.constructor=mr,mr.prototype.update=function(){var e=new l,t=new l,n=new te;return function(){this.object.updateMatrixWorld(!0),n.getNormalMatrix(this.object.matrixWorld);for(var i=this.object.matrixWorld,r=this.geometry.attributes.position,a=this.object.geometry,o=a.vertices,s=a.faces,l=0,u=0,c=s.length;u<c;u++){var h=s[u],d=h.normal;e.copy(o[h.a]).add(o[h.b]).add(o[h.c]).divideScalar(3).applyMatrix4(i),t.copy(d).applyMatrix3(n).normalize().multiplyScalar(this.size).add(e),r.setXYZ(l,e.x,e.y,e.z),l+=1,r.setXYZ(l,t.x,t.y,t.z),l+=1}r.needsUpdate=!0}}(),gr.prototype=Object.create(le.prototype),gr.prototype.constructor=gr,gr.prototype.dispose=function(){var e=this.children[0],t=this.children[1];e.geometry.dispose(),e.material.dispose(),t.geometry.dispose(),t.material.dispose()},gr.prototype.update=function(){var e=new l,t=new l,n=new l;return function(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),n.subVectors(t,e);var i=this.children[0],r=this.children[1];i.lookAt(n),i.material.color.copy(this.light.color),r.lookAt(n),r.scale.z=n.length()}}(),vr.prototype=Object.create(Ot.prototype),vr.prototype.constructor=vr,vr.prototype.update=function(){function e(e,a,o,s){i.set(a,o,s).unproject(r);var l=n[e];if(void 0!==l)for(var u=t.getAttribute("position"),c=0,h=l.length;c<h;c++)u.setXYZ(l[c],i.x,i.y,i.z)}var t,n,i=new l,r=new Re;return function(){t=this.geometry,n=this.pointMap;r.projectionMatrix.copy(this.camera.projectionMatrix),e("c",0,0,-1),e("t",0,0,1),e("n1",-1,-1,-1),e("n2",1,-1,-1),e("n3",-1,1,-1),e("n4",1,1,-1),e("f1",-1,-1,1),e("f2",1,-1,1),e("f3",-1,1,1),e("f4",1,1,1),e("u1",.7,1.1,-1),e("u2",-.7,1.1,-1),e("u3",0,2,-1),e("cf1",-1,0,1),e("cf2",1,0,1),e("cf3",0,-1,1),e("cf4",0,1,1),e("cn1",-1,0,-1),e("cn2",1,0,-1),e("cn3",0,-1,-1),e("cn4",0,1,-1),t.getAttribute("position").needsUpdate=!0}}(),yr.prototype=Object.create(Ot.prototype),yr.prototype.constructor=yr,yr.prototype.update=function(){var e=new $;return function(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&e.setFromObject(this.object),!e.isEmpty()){var n=e.min,i=e.max,r=this.geometry.attributes.position,a=r.array;a[0]=i.x,a[1]=i.y,a[2]=i.z,a[3]=n.x,a[4]=i.y,a[5]=i.z,a[6]=n.x,a[7]=n.y,a[8]=i.z,a[9]=i.x,a[10]=n.y,a[11]=i.z,a[12]=i.x,a[13]=i.y,a[14]=n.z,a[15]=n.x,a[16]=i.y,a[17]=n.z,a[18]=n.x,a[19]=n.y,a[20]=n.z,a[21]=i.x,a[22]=n.y,a[23]=n.z,r.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),yr.prototype.setFromObject=function(e){return this.object=e,this.update(),this};var zs,js;Er.prototype=Object.create(le.prototype),Er.prototype.constructor=Er,Er.prototype.setDirection=function(){var e,t=new l;return function(n){n.y>.99999?this.quaternion.set(0,0,0,1):n.y<-.99999?this.quaternion.set(1,0,0,0):(t.set(n.z,0,-n.x).normalize(),e=Math.acos(n.y),this.quaternion.setFromAxisAngle(t,e))}}(),Er.prototype.setLength=function(e,t,n){void 0===t&&(t=.2*e),void 0===n&&(n=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(n,t,n),this.cone.position.y=e,this.cone.updateMatrix()},Er.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},br.prototype=Object.create(Ot.prototype),br.prototype.constructor=br;var Ws=new l,Xs=new xr,Ys=new xr,qs=new xr;Mr.prototype=Object.create(xi.prototype),Mr.prototype.constructor=Mr,Mr.prototype.getPoint=function(e){var t=this.points,n=t.length;n<2&&console.log("duh, you need at least 2 points");var i=(n-(this.closed?0:1))*e,r=Math.floor(i),a=i-r;this.closed?r+=r>0?0:(Math.floor(Math.abs(r)/t.length)+1)*t.length:0===a&&r===n-1&&(r=n-2,a=1);var o,s,u,c;if(this.closed||r>0?o=t[(r-1)%n]:(Ws.subVectors(t[0],t[1]).add(t[0]),o=Ws),s=t[r%n],u=t[(r+1)%n],this.closed||r+2<n?c=t[(r+2)%n]:(Ws.subVectors(t[n-1],t[n-2]).add(t[n-1]),c=Ws),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var h="chordal"===this.type?.5:.25,d=Math.pow(o.distanceToSquared(s),h),f=Math.pow(s.distanceToSquared(u),h),p=Math.pow(u.distanceToSquared(c),h);f<1e-4&&(f=1),d<1e-4&&(d=f),p<1e-4&&(p=f),Xs.initNonuniformCatmullRom(o.x,s.x,u.x,c.x,d,f,p),Ys.initNonuniformCatmullRom(o.y,s.y,u.y,c.y,d,f,p),qs.initNonuniformCatmullRom(o.z,s.z,u.z,c.z,d,f,p)}else if("catmullrom"===this.type){var m=void 0!==this.tension?this.tension:.5;Xs.initCatmullRom(o.x,s.x,u.x,c.x,m),Ys.initCatmullRom(o.y,s.y,u.y,c.y,m),qs.initCatmullRom(o.z,s.z,u.z,c.z,m)}return new l(Xs.calc(a),Ys.calc(a),qs.calc(a))},_r.prototype=Object.create(xi.prototype),_r.prototype.constructor=_r,_r.prototype.getPoint=function(e){var t=this.v0,n=this.v1,i=this.v2,r=this.v3;return new l(bi(e,t.x,n.x,i.x,r.x),bi(e,t.y,n.y,i.y,r.y),bi(e,t.z,n.z,i.z,r.z))},Cr.prototype=Object.create(xi.prototype),Cr.prototype.constructor=Cr,Cr.prototype.getPoint=function(e){var t=this.v0,n=this.v1,i=this.v2;return new l(mi(e,t.x,n.x,i.x),mi(e,t.y,n.y,i.y),mi(e,t.z,n.z,i.z))},Ir.prototype=Object.create(xi.prototype),Ir.prototype.constructor=Ir,Ir.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=new l;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t},Or.prototype=Object.create(Ci.prototype),Or.prototype.constructor=Or;var Zs={createMultiMaterialObject:function(e,t){for(var n=new Dt,i=0,r=t.length;i<r;i++)n.add(new Le(e,t[i]));return n},detach:function(e,t,n){e.applyMatrix(t.matrixWorld),t.remove(e),n.add(e)},attach:function(e,t,n){var i=new u;i.getInverse(n.matrixWorld),e.applyMatrix(i),t.remove(e),n.add(e)}};xi.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(xi.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Yr.prototype=Object.create(Mr.prototype),qr.prototype=Object.create(Mr.prototype),Zr.prototype=Object.create(Mr.prototype),Object.assign(Zr.prototype,{initFromArray:function(e){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(e){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(e){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),fr.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},Object.assign(Y.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign($.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),ue.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},hs.random16=function(){return console.warn("THREE.Math.random16() has been deprecated. Use Math.random() instead."),Math.random()},Object.assign(te.prototype,{flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix3: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},applyToBuffer:function(e,t,n){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,n){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(u.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},getPosition:function(){var e;return function(){return void 0===e&&(e=new l),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),e.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(e,t,n){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,n){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(e,t,n,i,r,a){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,i,n,r,a)}}),ne.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},s.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Object.assign(ae.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign(Si.prototype,{extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new en(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new hn(this,e)}}),Object.assign(n.prototype,{fromAttribute:function(e,t,n){return console.error("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,n)}}),Object.assign(l.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},applyProjection:function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},fromAttribute:function(e,t,n){return console.error("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,n)}}),Object.assign(r.prototype,{fromAttribute:function(e,t,n){return console.error("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,n)}}),Oe.prototype.computeTangents=function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},Object.assign(le.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(le.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(bt.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(xt.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Object.defineProperty(xi.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),Ae.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Pn.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(fe.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}}}),Object.assign(Te.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,n){void 0!==n&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(Te.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(Yi.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(K.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new X}}}),Object.defineProperties(Cn.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(Q.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),Object.assign(ft.prototype,{getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(ft.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(re.prototype,{cullFace:{get:function(){return this.renderReverseSided?ua:la},set:function(e){var t=e!==la;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(a.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Bi.prototype.load=function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var t=this;return(new Ri).load(e,function(e){t.setBuffer(e)}),this},Hi.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()};var Ks={merge:function(e,t,n){console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead.");var i;t.isMesh&&(t.matrixAutoUpdate&&t.updateMatrix(),i=t.matrix,t=t.geometry),e.merge(t,i,n)},center:function(e){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},Qs={crossOrigin:void 0,loadTexture:function(e,t,n,i){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");var r=new Nn;r.setCrossOrigin(this.crossOrigin);var a=r.load(e,n,void 0,i);return t&&(a.mapping=t),a},loadTextureCube:function(e,t,n,i){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");var r=new An;r.setCrossOrigin(this.crossOrigin);var a=r.load(e,n,void 0,i);return t&&(a.mapping=t),a},loadCompressedTexture:function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},loadCompressedTextureCube:function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")}};Object.assign(ra.prototype,{getCurrentRenderTarget:function(){
return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(ra.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),e.LRUMap=LRUMap,e.WebGLRendererByIncrement=ra,e.WebGLRenderTargetCube=o,e.WebGLRenderTarget=a,e.WebGLRenderer=ft,e.ShaderLib=Cs,e.UniformsLib=xs,e.UniformsUtils=Ms,e.ShaderChunk=_s,e.FogExp2=pt,e.Fog=mt,e.Scene=gt,e.LensFlare=vt,e.Sprite=Et,e.LOD=bt,e.SkinnedMesh=_t,e.Skeleton=xt,e.Bone=Mt,e.Mesh=Le,e.LineSegments=Ot,e.LineLoop=Tt,e.Line=It,e.Points=St,e.Group=Dt,e.VideoTexture=wt,e.DataTexture=c,e.CompressedTexture=Ut,e.CubeTexture=h,e.CanvasTexture=Rt,e.DepthTexture=At,e.Texture=i,e.CompressedTextureLoader=wn,e.DataTextureLoader=Un,e.CubeTextureLoader=An,e.TextureLoader=Nn,e.ObjectLoader=ci,e.MaterialLoader=oi,e.BufferGeometryLoader=si,e.DefaultLoadingManager=Rs,e.LoadingManager=Sn,e.JSONLoader=ui,e.ImageLoader=Rn,e.FontLoader=Ui,e.FileLoader=Dn,e.Loader=li,e.Cache=Us,e.AudioLoader=Ri,e.SpotLightShadow=Fn,e.SpotLight=Hn,e.PointLight=Gn,e.RectAreaLight=Wn,e.HemisphereLight=kn,e.DirectionalLightShadow=Vn,e.DirectionalLight=zn,e.AmbientLight=jn,e.LightShadow=Bn,e.Light=Pn,e.StereoCamera=Ai,e.PerspectiveCamera=Ae,e.OrthographicCamera=Ne,e.CubeCamera=Ni,e.ArrayCamera=Pi,e.Camera=Re,e.AudioListener=ki,e.PositionalAudio=Fi,e.AudioContext=Vs,e.AudioAnalyser=Hi,e.Audio=Bi,e.VectorKeyframeTrack=Qn,e.StringKeyframeTrack=ti,e.QuaternionKeyframeTrack=$n,e.NumberKeyframeTrack=ei,e.ColorKeyframeTrack=ii,e.BooleanKeyframeTrack=ni,e.PropertyMixer=Gi,e.PropertyBinding=zi,e.KeyframeTrack=ri,e.AnimationUtils=As,e.AnimationObjectGroup=ji,e.AnimationMixer=Xi,e.AnimationClip=ai,e.Uniform=Yi,e.InstancedBufferGeometry=qi,e.BufferGeometry=Te,e.GeometryIdCount=Ie,e.Geometry=Oe,e.InterleavedBufferAttribute=Zi,e.InstancedInterleavedBuffer=Qi,e.InterleavedBuffer=Ki,e.InstancedBufferAttribute=Ji,e.Face3=he,e.Object3D=le,e.Raycaster=$i,e.Layers=se,e.EventDispatcher=t,e.Clock=nr,e.QuaternionLinearInterpolant=Jn,e.LinearInterpolant=qn,e.DiscreteInterpolant=Zn,e.CubicInterpolant=Yn,e.Interpolant=Xn,e.Triangle=ce,e.Math=hs,e.Spherical=ir,e.Cylindrical=rr,e.Plane=ne,e.Frustum=ie,e.Sphere=ee,e.Ray=ae,e.Matrix4=u,e.Matrix3=te,e.Box3=$,e.Box2=Y,e.Line3=ue,e.Euler=oe,e.Vector4=r,e.Vector3=l,e.Vector2=n,e.Quaternion=s,e.Color=X,e.MorphBlendMesh=ar,e.ImmediateRenderObject=or,e.VertexNormalsHelper=sr,e.SpotLightHelper=lr,e.SkeletonHelper=ur,e.PointLightHelper=cr,e.RectAreaLightHelper=hr,e.HemisphereLightHelper=dr,e.GridHelper=fr,e.PolarGridHelper=pr,e.FaceNormalsHelper=mr,e.DirectionalLightHelper=gr,e.CameraHelper=vr,e.BoxHelper=yr,e.ArrowHelper=Er,e.AxisHelper=br,e.CatmullRomCurve3=Mr,e.CubicBezierCurve3=_r,e.QuadraticBezierCurve3=Cr,e.LineCurve3=Ir,e.ArcCurve=Or,e.EllipseCurve=Ci,e.SplineCurve=Ii,e.CubicBezierCurve=Oi,e.QuadraticBezierCurve=Ti,e.LineCurve=Mi,e.Shape=Si,e.Path=Li,e.ShapePath=Di,e.Font=wi,e.CurvePath=_i,e.Curve=xi,e.ShapeUtils=Ss,e.SceneUtils=Zs,e.WebGLExtensions=ht,e.WireframeGeometry=Nt,e.ParametricGeometry=Pt,e.ParametricBufferGeometry=kt,e.TetrahedronGeometry=Ht,e.TetrahedronBufferGeometry=Gt,e.OctahedronGeometry=Vt,e.OctahedronBufferGeometry=zt,e.IcosahedronGeometry=jt,e.IcosahedronBufferGeometry=Wt,e.DodecahedronGeometry=Xt,e.DodecahedronBufferGeometry=Yt,e.PolyhedronGeometry=Bt,e.PolyhedronBufferGeometry=Ft,e.TubeGeometry=qt,e.TubeBufferGeometry=Zt,e.TorusKnotGeometry=Kt,e.TorusKnotBufferGeometry=Qt,e.TorusGeometry=Jt,e.TorusBufferGeometry=$t,e.TextGeometry=nn,e.TextBufferGeometry=rn,e.SphereGeometry=an,e.SphereBufferGeometry=on,e.RingGeometry=sn,e.RingBufferGeometry=ln,e.PlaneGeometry=we,e.PlaneBufferGeometry=Ue,e.LatheGeometry=un,e.LatheBufferGeometry=cn,e.ShapeGeometry=hn,e.ShapeBufferGeometry=dn,e.ExtrudeGeometry=en,e.ExtrudeBufferGeometry=tn,e.EdgesGeometry=fn,e.ConeGeometry=gn,e.ConeBufferGeometry=vn,e.CylinderGeometry=pn,e.CylinderBufferGeometry=mn,e.CircleGeometry=yn,e.CircleBufferGeometry=En,e.BoxGeometry=Se,e.BoxBufferGeometry=De,e.ShadowMaterial=bn;e.SpriteMaterial=yt,e.RawShaderMaterial=xn,e.ShaderMaterial=Q,e.PointsMaterial=Lt,e.MeshPhysicalMaterial=_n,e.MeshStandardMaterial=Mn,e.MeshPhongMaterial=Cn,e.MeshToonMaterial=In,e.MeshNormalMaterial=On,e.MeshLambertMaterial=Tn,e.MeshDepthMaterial=J,e.MeshBasicMaterial=de,e.LineDashedMaterial=Ln,e.LineBasicMaterial=Ct,e.Material=K,e.Float64BufferAttribute=Me,e.Float32BufferAttribute=xe,e.Uint32BufferAttribute=be,e.Int32BufferAttribute=Ee,e.Uint16BufferAttribute=ye,e.Int16BufferAttribute=ve,e.Uint8ClampedBufferAttribute=ge,e.Uint8BufferAttribute=me,e.Int8BufferAttribute=pe,e.BufferAttribute=fe,e.REVISION=aa,e.MOUSE=oa,e.CullFaceNone=sa,e.CullFaceBack=la,e.CullFaceFront=ua,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=ca,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=ha,e.PCFSoftShadowMap=da,e.FrontSide=fa,e.BackSide=pa,e.DoubleSide=ma,e.FlatShading=ga,e.SmoothShading=va,e.NoColors=ya,e.FaceColors=Ea,e.VertexColors=ba,e.NoBlending=xa,e.NormalBlending=Ma,e.AdditiveBlending=_a,e.SubtractiveBlending=Ca,e.MultiplyBlending=Ia,e.CustomBlending=Oa,e.AddEquation=Ta,e.SubtractEquation=La,e.ReverseSubtractEquation=Sa,e.MinEquation=Da,e.MaxEquation=wa,e.ZeroFactor=Ua,e.OneFactor=Ra,e.SrcColorFactor=Aa,e.OneMinusSrcColorFactor=Na,e.SrcAlphaFactor=Pa,e.OneMinusSrcAlphaFactor=ka,e.DstAlphaFactor=Ba,e.OneMinusDstAlphaFactor=Fa,e.DstColorFactor=Ha,e.OneMinusDstColorFactor=Ga,e.SrcAlphaSaturateFactor=Va,e.NeverDepth=za,e.AlwaysDepth=ja,e.LessDepth=Wa,e.LessEqualDepth=Xa,e.EqualDepth=Ya,e.GreaterEqualDepth=qa,e.GreaterDepth=Za,e.NotEqualDepth=Ka,e.MultiplyOperation=Qa,e.MixOperation=Ja,e.AddOperation=$a,e.NoToneMapping=eo,e.LinearToneMapping=to,e.ReinhardToneMapping=no,e.Uncharted2ToneMapping=io,e.CineonToneMapping=ro,e.UVMapping=300,e.CubeReflectionMapping=ao,e.CubeRefractionMapping=oo,e.EquirectangularReflectionMapping=so,e.EquirectangularRefractionMapping=lo,e.SphericalReflectionMapping=uo,e.CubeUVReflectionMapping=co,e.CubeUVRefractionMapping=ho,e.RepeatWrapping=fo,e.ClampToEdgeWrapping=po,e.MirroredRepeatWrapping=mo,e.NearestFilter=go,e.NearestMipMapNearestFilter=vo,e.NearestMipMapLinearFilter=yo,e.LinearFilter=Eo,e.LinearMipMapNearestFilter=bo,e.LinearMipMapLinearFilter=xo,e.UnsignedByteType=Mo,e.ByteType=_o,e.ShortType=Co,e.UnsignedShortType=Io,e.IntType=Oo,e.UnsignedIntType=To,e.FloatType=Lo,e.HalfFloatType=So,e.UnsignedShort4444Type=Do,e.UnsignedShort5551Type=wo,e.UnsignedShort565Type=Uo,e.UnsignedInt248Type=Ro,e.AlphaFormat=Ao,e.RGBFormat=No,e.RGBAFormat=Po,e.LuminanceFormat=ko,e.LuminanceAlphaFormat=Bo,e.RGBEFormat=Fo,e.DepthFormat=Ho,e.DepthStencilFormat=Go,e.RGB_S3TC_DXT1_Format=Vo,e.RGBA_S3TC_DXT1_Format=zo,e.RGBA_S3TC_DXT3_Format=jo,e.RGBA_S3TC_DXT5_Format=Wo,e.RGB_PVRTC_4BPPV1_Format=Xo,e.RGB_PVRTC_2BPPV1_Format=Yo,e.RGBA_PVRTC_4BPPV1_Format=qo,e.RGBA_PVRTC_2BPPV1_Format=Zo,e.RGB_ETC1_Format=Ko,e.LoopOnce=2200,e.LoopRepeat=Qo,e.LoopPingPong=2202,e.InterpolateDiscrete=2300,e.InterpolateLinear=2301,e.InterpolateSmooth=2302,e.ZeroCurvatureEnding=Jo,e.ZeroSlopeEnding=2401,e.WrapAroundEnding=2402,e.TrianglesDrawMode=$o,e.TriangleStripDrawMode=es,e.TriangleFanDrawMode=ts,e.LinearEncoding=ns,e.sRGBEncoding=is,e.GammaEncoding=rs,e.RGBEEncoding=as,e.LogLuvEncoding=3003,e.RGBM7Encoding=os,e.RGBM16Encoding=ss,e.RGBDEncoding=ls,e.BasicDepthPacking=us,e.RGBADepthPacking=cs,e.CubeGeometry=Se,e.Face4=Tr,e.LineStrip=0,e.LinePieces=1,e.MeshFaceMaterial=Lr,e.MultiMaterial=Sr,e.PointCloud=Dr,e.Particle=wr,e.ParticleSystem=Ur,e.PointCloudMaterial=Rr,e.ParticleBasicMaterial=Ar,e.ParticleSystemMaterial=Nr,e.Vertex=Pr,e.DynamicBufferAttribute=kr,e.Int8Attribute=Br,e.Uint8Attribute=Fr,e.Uint8ClampedAttribute=Hr,e.Int16Attribute=Gr,e.Uint16Attribute=Vr,e.Int32Attribute=zr,e.Uint32Attribute=jr,e.Float32Attribute=Wr,e.Float64Attribute=Xr,e.ClosedSplineCurve3=Yr,e.SplineCurve3=qr,e.Spline=Zr,e.BoundingBoxHelper=Kr,e.EdgesHelper=Qr,e.WireframeHelper=Jr,e.XHRLoader=$r,e.BinaryTextureLoader=ea,e.GeometryUtils=Ks,e.ImageUtils=Qs,e.Projector=ta,e.CanvasRenderer=na,Object.defineProperty(e,"__esModule",{value:!0})});var CollisionManager=function(){function e(){_classCallCheck(this,e),this.condition=[{categoryId:"-2000011"}],this.distance=15}return _createClass(e,[{key:"setCondition",value:function(e){e instanceof Array&&(this.condition=e)}},{key:"getCondition",value:function(){return this.condition}},{key:"getDistance",value:function(){return this.distance}},{key:"matchConditions",value:function(e){var t=this.condition;if(0==t.length)return!1;for(var n=!0,i=0,r=t.length;i<r;i++){var a=t[i];for(var o in a)if(!e.hasOwnProperty(o)||e[o]!=a[o]){n=!1;break}if(1==n)break;i<t.length-1&&(n=!0)}return n}},{key:"hasCollision",value:function(e,t){if(!e)return!1;var n=this.matchConditions(e),i=t<=this.distance;return!(!n||!i)}}]),e}();CLOUD.CollisionManager=CollisionManager,CLOUD.CameraControl=function(e,t,n,i,r){function a(){if(m.viewer.getRotationCenter())return m.viewer.getRotationCenter();var t=m.viewer.modelManager.sceneState;if(t.hasSelection()){var n=m.viewer.getFilter(),i=n.getVisibleComponentSet(t.getSelectionSet()),r=e.getBoundingBoxByIds(i);if(r&&!r.isEmpty())return r.getCenter()}return m.pivot?m.pivot:m.scene.getBoundingBox().getCenter()}function o(){var e=m.camera,t=e.position,n=m.camera.target.clone().sub(t);n.normalize();var i=new THREE.Plane;i.setFromNormalAndCoplanarPoint(n.clone().negate(),a()),i.normalize();var r=i.distanceToPoint(t),o=r*Math.tan(.5*e.fov),s=m.getContainerDimensions();return 2*o/(s.height-s.top)}function s(){m.pivotBallGroup=m.scene.getOrCreateObjectGroup(CLOUD.ObjectGroupType.PIVOTBALL,{priority:10,globalSpace:!1});var e=new THREE.SphereBufferGeometry(15,64,64),t=new THREE.Mesh(e,new CLOUD.PhongLightingMaterial({color:16777215,depthTest:!1,opacity:.5,transparent:!0,side:THREE.DoubleSide}));e=new THREE.SphereBufferGeometry(1,64,64);var n=new THREE.Mesh(e,new CLOUD.PhongLightingMaterial({color:16711680,depthTest:!1,opacity:.5,transparent:!0,side:THREE.DoubleSide}));m.pivotBallGroup.add(t),m.pivotBallGroup.add(n)}function l(e,t,n){if(null==n||void 0===n)return!0;var i=n[0],r=n[1],a=m.camera,o=a.position,s=a.getWorldDirection(),l=a.realUp||a.up,u=s.clone().cross(l).normalize(),c=(new THREE.Quaternion).setFromAxisAngle(u,e);o.clone().sub(t).normalize();var f=s.clone().negate(),p=f.angleTo(h.clone()),g=f.clone().projectOnPlane(h.clone()),v=g.angleTo(d.clone());g.x<0&&(v=2*Math.PI-v),s.applyQuaternion(c).normalize();var y=s.clone().negate(),E=y.angleTo(h.clone()),b=y.clone().projectOnPlane(h.clone()),x=b.angleTo(d.clone());if(b.x<0&&(x=2*Math.PI-x),Math.abs(x-v)>.001)return!1;if(p>i&&p<r){if(E>r||E<i)return!1}else{if((p>r?E-p:p-E)>0)return!1}return!0}function u(e,t,n,i){var r=new THREE.Matrix4;r.getInverse(t);var a=new THREE.Vector3(e.position.x,e.position.y,e.position.z),o=a.clone();o.applyMatrix4(r);var s=new THREE.Vector3(n.x,n.y,n.z);return s.add(a),s.applyMatrix4(r),s.sub(o).normalize().multiplyScalar(i),s.add(o),s.applyMatrix4(t),s.sub(a),s}this.viewer=e,this.camera=n,this.domElement=i,this.scene=t,this.intersector=new CLOUD.IntersectHelper(e);var c,h=new THREE.Vector3(0,1,0),d=new THREE.Vector3(0,0,1),f=new THREE.Vector3,p=new THREE.Quaternion,m=this,g=!1;this.collisionManager=new CLOUD.CollisionManager,this.pivotBallGroup=null,this.minDollyDistance=.7,this.gravity=0,this.farFactor=2,this.destroy=function(){this.viewer=null,this.camera=null,this.domElement=null,this.scene=null,this.intersector.destroy(),this.intersector=null,this.collisionManager=null,this.pivotBallGroup=null},this.isCameraChanging=function(){return g},this.setCameraChanging=function(e){g=e},this.setCamera=function(e){this.camera=e},this.getCamera=function(){return this.camera.updateMVP(),this.camera},this.dirtyCamera=function(e){this.camera.dirty=e},this.getFrustum=function(){return this.camera.getFrustum()},this.lockAxisZ=function(e){CLOUD.EditorConfig.LockAxisZ=e},this.isLockedAxisZ=function(){return CLOUD.EditorConfig.LockAxisZ},this.setLockAxisZRange=function(e){CLOUD.EditorConfig.LockAxisZRange=e},this.getLockAxisZRange=function(){return CLOUD.EditorConfig.LockAxisZRange},this.getClientSize=function(){var e=m.domElement===document?m.domElement.body:m.domElement;return new THREE.Vector2(e.clientWidth,e.clientHeight)},this.delayHandle=function(){function e(){m.update(!0,!0)}this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(e,200),this.needUpdateRenderList(!1)},this.processRotate=function(e,t){var n=this.getClientSize(),i=-2*Math.PI*e.x/n.x,r=-2*Math.PI*e.y/n.y;m.handleRotation(i,r,t)},this.handleRotation=function(e,t,n){var i=this.camera,r=i.position,a=i.target,o=i.getWorldDirection(),s=a.clone().sub(r),u=s.length(),c=null,d=function(e){var t,i,l,c=new THREE.Vector3;n?(t=r.clone().sub(n),i=t.length(),t.normalize(),l=t.clone().applyQuaternion(e).normalize(),r.copy(n).add(l.multiplyScalar(i)),o.applyQuaternion(e).normalize(),c.copy(r).add(o.multiplyScalar(u)),a.copy(c)):(t=s.clone(),i=u,t.normalize(),l=t.clone().applyQuaternion(e).normalize(),c.copy(r).add(l.multiplyScalar(i)),a.copy(c))},f=i.up,p=o.clone().cross(f).normalize(),m=p.clone().cross(o).normalize();i.realUp.copy(m);var g;if(CLOUD.EditorConfig.LockAxisZ){if(Math.abs(e)>Math.abs(t))g=h,c=(new THREE.Quaternion).setFromAxisAngle(g,e),d(c),i.realUp.applyQuaternion(c).normalize();else if(null!=CLOUD.EditorConfig.LockAxisZRange&&Math.abs(t)>1e-4){var v=CLOUD.EditorConfig.LockAxisZRange;l(t,n,v)&&(g=o.clone().cross(f).normalize(),c=(new THREE.Quaternion).setFromAxisAngle(g,t),d(c),i.realUp.applyQuaternion(c).normalize(),this.adjustCameraUp())}}else Math.abs(e)>Math.abs(t)?((Math.abs(o.y+1)<1e-4||Math.abs(o.y-1)<1e-4)&&(g=o.clone().cross(i.realUp).normalize(),c=(new THREE.Quaternion).setFromAxisAngle(g,.1),d(c),i.realUp.applyQuaternion(c).normalize(),this.adjustCameraUp()),g=o.y>0&&i.realUp.y<0?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),c=(new THREE.Quaternion).setFromAxisAngle(g,e),d(c),i.realUp.applyQuaternion(c).normalize()):Math.abs(t)>1e-4&&(g=o.clone().cross(i.realUp).normalize(),c=(new THREE.Quaternion).setFromAxisAngle(g,t),d(c),i.realUp.applyQuaternion(c).normalize(),this.adjustCameraUp());this.dirtyCamera(!0),this.setCameraChanging(!0)},this.adjustCameraForPan=function(e){var t=this.camera;t.target.add(e),t.position.add(e),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.updateCamera=function(){var e=this.camera;e.dirty&&(e.lookAt(e.target),e.updateMVP())},this.update=function(e,t){this.updateCamera();var n=this.camera;e?(void 0!==t&&this.needUpdateRenderList(t),r(),f.copy(n.position),p.copy(n.quaternion)):(f.distanceToSquared(n.position)>1e-6||8*(1-p.dot(n.quaternion))>1e-6)&&(r(),f.copy(n.position),p.copy(n.quaternion))},this.updateView=function(e){void 0!==e&&this.needUpdateRenderList(e),r()},this.updateHighlight=function(){r(!0)},this.needUpdateRenderList=function(e){this.viewer.editorManager.isUpdateRenderList=e},this.pan=function(e,t){function n(e){var t=m.camera.matrix.elements;a.set(t[0],t[1],t[2]),a.multiplyScalar(-e),m.camera.target.add(a),m.camera.position.add(a)}function i(e){var t=m.camera.matrix.elements;a.set(t[4],t[5],t[6]),a.multiplyScalar(e),m.camera.target.add(a),m.camera.position.add(a)}var r=m.domElement===document?m.domElement.body:m.domElement,a=new THREE.Vector3;if(m.camera.isPerspective){var o=m.camera.position,s=o.clone().sub(m.camera.target).length();s*=Math.tan(m.camera.fov/2*Math.PI/180),n(2*e*s/r.clientHeight),i(2*t*s/r.clientHeight)}else void 0!==m.camera.top?(n(e*(m.camera.right-m.camera.left)/r.clientWidth),i(t*(m.camera.top-m.camera.bottom)/r.clientHeight)):CLOUD.Logger.warn("WARNING: CloudPickEditor.js encountered an unknown camera type - pan disabled.");this.dirtyCamera(!0),this.setCameraChanging(!0)},this.panOnWorld=function(){var e=new THREE.Vector3,t=new THREE.Vector3,n=new THREE.Vector3;return function(i,r,a,o){var s=m.getContainerDimensions(),l=i.x-s.left,u=i.y-s.top;e.x=l/s.width,e.y=u/s.height,l=r.x-s.left,u=r.y-s.top,t.x=l/s.width,t.y=u/s.height,n.subVectors(t,e);var c=-n.x*o.x,h=n.y*o.y,d=m.getWorldRight().multiplyScalar(c),f=m.getWorldUp().multiplyScalar(h);a.addVectors(d,f),m.dirtyCamera(!0),m.setCameraChanging(!0)}}(),this.adjustCameraForDolly=function(e,t){var n=e-1;if(Math.abs(n)<1e-6)return!1;var i=this.camera,r=i.position,a=this.getWorldEye(),o=new THREE.Vector3;t?o.subVectors(t,r):o.copy(a),o.multiplyScalar(n);var s=o.length();i.isPerspective?s<this.minDollyDistance&&o.normalize().multiplyScalar(this.minDollyDistance):(i.orthoScale*=e,i.setZoom(i.orthoScale));var l=new THREE.Vector3;l.addVectors(r,o),this._goingToDolly(i,l,n)?(i.position.copy(l),i.target.copy(a.add(l)),this.dirtyCamera(!0),this.setCameraChanging(!0)):n<0&&this.resetCameraToMaximumRange()},this._goingToDolly=function(e,t,n){if(!e.isPerspective||!CLOUD.GlobalData.ConstraintZoom)return!0;var i=this.scene.getBoundingBox();if(n>0){return!!e.getFrustum().intersectsBox(i)}var r=i.getSize().length(),a=i.getCenter(),o=.5*r/Math.tan(THREE.Math.degToRad(.5*e.fov)),s=o*this.farFactor;return t.distanceTo(a)<s},this.dolly=function(e,t,n){var i=new THREE.Vector2(e,t),r=this.getIntersectContext(i),a=this.intersector.hitTest(r);null!=a?this.adjustCameraForDolly(n,a):this.adjustCameraForDolly(n,null)},this.dollyByPoint=function(e,t,n){var i=this.getTrackingPoint(e,t);this.adjustCameraForDolly(n,i)},this.endOperation=function(){this.intersector.lastIntersect=null},this.zoom=function(e,t,n){var i;i=e>0?1/(1-e):1+e,void 0===t||void 0===n?this.adjustCameraForDolly(i,null):this.dollyByPoint(t,n,i),this.update()},this.getContainerDimensions=function(){return CLOUD.DomUtil.getContainerOffsetToClient(this.domElement)},this.computeFrustum=function(){var e=new THREE.Matrix4,t=new THREE.Matrix4;return function(n,i,r,a,o,s){var l=this.camera,u=l.near*Math.tan(THREE.Math.degToRad(.5*l.fov)),c=u*l.aspect,h=(n-s.left)/s.width*2-1,d=(i-s.left)/s.width*2-1,f=-(r-s.top)/s.height*2+1,p=-(a-s.top)/s.height*2+1;e.makePerspective(h*c,d*c,f*u,p*u,l.near,l.far),l.updateMatrixWorld(),l.matrixWorldInverse.getInverse(l.matrixWorld),t.multiplyMatrices(e,l.matrixWorldInverse),o.setFromMatrix(t)}}(),this.screenToCanvas=function(e,t){var n=this.getContainerDimensions();return{x:e-n.left,y:t-n.top}},this.mapScreenToLocal=function(e,t,n){var i=this.getContainerDimensions();n.set(e-i.left,i.height-(t-i.top))},this.mapWindowToViewport=function(e,t,n){var i=this.getContainerDimensions(),r=n||new THREE.Vector2;return r.x=(e-i.left)/i.width*2-1,r.y=-(t-i.top)/i.height*2+1,r},this.getCameraName=function(){return this.camera===e.defaultCamera?this.camera.isPerspective?"persp":"orth":this.camera.name},this.getCameraInfo=function(){var e=new CLOUD.CameraInfo(this.getCameraName(),this.camera.position,this.camera.target,this.camera.up);return JSON.stringify(e)},this.isKeepZoom=function(e,t,n){this.dirtyCamera(!0),this.setCameraChanging(!0),void 0===t&&(t=this.minDistance),void 0===n&&(n=this.maxDistance);var i=this.camera.position,r=this.camera.target,a=new THREE.Vector3;a.copy(i).sub(r);var o=a.length()*(2-e);return!(o<t||o>n)},this.computeRotation=function(){var e=new THREE.Matrix4;e.lookAt(this.camera.position,this.camera.target,this.camera.up);var t=new THREE.Quaternion;t.setFromRotationMatrix(e);var n=new THREE.Euler;return n.setFromQuaternion(t,void 0,!1),n},this.adjustCameraUp=function(){this.camera.realUp.y>0?this.camera.up=new THREE.Vector3(0,1,0):this.camera.realUp.y<0?this.camera.up=new THREE.Vector3(0,-1,0):this.camera.realUp.x>0?this.camera.up=new THREE.Vector3(1,0,0):this.camera.realUp.x<0?this.camera.up=new THREE.Vector3(-1,0,0):this.camera.realUp.z>0?this.camera.up=new THREE.Vector3(0,0,1):this.camera.realUp.z<0&&(this.camera.up=new THREE.Vector3(0,0,-1))},this.getWorldEye=function(){return this.camera.target.clone().sub(this.camera.position)},this.getWorldRight=function(){var e=new THREE.Vector3,t=this.camera.up,n=this.getWorldEye();return e.crossVectors(n,t),0===e.lengthSq()&&(t.z>t.y?n.y-=1e-4:n.z+=1e-4,e.crossVectors(n,t)),e.normalize()},this.getWorldRightByRealUp=function(){var e=new THREE.Vector3,t=this.camera.realUp,n=this.getWorldEye();return e.crossVectors(n,t),0===e.lengthSq()&&(t.z>t.y?n.y-=1e-4:n.z+=1e-4,e.crossVectors(n,t)),e.normalize()},this.getWorldUp=function(){var e=this.getWorldRight(),t=this.getWorldEye();return e.cross(t).normalize()},this.getWorldDimension=function(e,t){var n=this.camera.position,i=this.getWorldEye().normalize(),r=this.getTrackingPoint(e,t),a=r.clone().sub(n),o=Math.abs(i.dot(a)),s=this.getContainerDimensions(),l=s.width/s.height,u=2*o*Math.tan(THREE.Math.degToRad(.5*this.camera.fov)),c=u*l;return new THREE.Vector2(c,u)},this.getWorldPointFromNearPlane=function(e,t){var i=new THREE.Vector3(e,t,0);return i.unproject(n),i},this.getTrackingPoint=function(e,t){var n=new THREE.Vector2(e,t),i=this.getIntersectContext(n),r=this.intersector.hitTest(i);if(!r){var a=i.mouse,o=this.camera.position,s=this.getWorldEye(),l=s.clone().normalize(),u=this.getWorldPointFromNearPlane(a.x,a.y),h=new THREE.Ray;if(this.camera.isPerspective)h.origin.copy(o),h.direction.copy(u.clone().sub(o).normalize());else{var d=u.clone();d.sub(s),h.origin.copy(d),h.direction.copy(l)}if(c){var f=new THREE.Plane;if(f.setFromNormalAndCoplanarPoint(l,c),r=h.intersectPlane(f)){r.distanceTo(o)<1e-6&&(r=this.getTrackingPointFromBoundingBox(l,h))}else r=this.getTrackingPointFromBoundingBox(l,h)}else r=this.getTrackingPointFromBoundingBox(l,h);r||(CLOUD.Logger.log("tracking point is default!"),r=u)}return c=r.clone(),r},this.getTrackingPointFromBoundingBox=function(e,t){return this.scene.getTrackingPointFromBoundingBox(e,t)},this.setCameraPosition=function(e){var t=this.camera,n=this.getWorldEye(),i=n.length(),r=n.clone();r.normalize(),r.setLength(i),t.position.copy(e),t.target.addVectors(t.position,r),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.moveStraight=function(e,t){var n=this.camera.position,i=this.camera.target;if(t){var r=new THREE.Vector3(i.x-n.x,0,i.z-n.z),a=r.length(),o=e/a,s=new THREE.Vector3(r.x*o,0,r.z*o);n.add(s),i.add(s)}else{var l=i.clone().sub(n);this.camera.translateZ(-e),i.addVectors(n,l)}this.dirtyCamera(!0),this.setCameraChanging(!0)},this.getIntersectContext=function(e){var t=new CLOUD.IntersectContext,n=this,i=n.viewer.modelManager;return t.scene=n.scene,t.camera=this.camera,t.isExploded=0!=i.explosionExtent||0!=i.floorExplosionExtent,null!=e&&n.mapWindowToViewport(e.x,e.y,t.mouse),t.viewportSize=n.viewer.getViewportSize(),t.octreeRoots=i.getOctreeRoots(),t.octantMap=i.getOctantMap(),t},this.getLastIntersect=function(){return this.intersector.lastIntersect},this.calculatePivot=function(e,t){function n(e){var t=i.getIntersectContext(e),n=i.intersector.hitTest(t);if(e&&n)return n;var r=a.getVisibleComponentsBbox().clone();if(r.applyMatrix4(o.getMatrixGlobal()),r.isEmpty()&&(r=o.getBoundingBox()),o.hasClipPlanes()&&CLOUD.ClipPlaneManager.getInstance(o).isEnabled()){var s=CLOUD.ClipPlaneManager.getInstance(o).getClipBoundingBox();r.intersect(s)}else if(o.hasFillClipPlanes()&&CLOUD.FillClipPlaneManager.getInstance(o).isEnabled()){var l=CLOUD.FillClipPlaneManager.getInstance(o).getFillClipBoundingBox();r.intersect(l)}return r.getCenter()}var i=this,r=this.viewer,a=r.getFilter(),o=this.scene,s=null;if(r.getRotationCenter())return r.getRotationCenter();switch(e){case CLOUD.RotatePivotMode.SELECTION:if(o.hasClipPlanes()&&CLOUD.ClipPlaneManager.getInstance(o).isEnabled()){var l=CLOUD.ClipPlaneManager.getInstance(o).getClipBoundingBox();if(l&&!l.isEmpty()&&CLOUD.ClipPlaneManager.getInstance(o).isVisible()){s=l.getCenter();break}}if(o.hasFillClipPlanes()&&CLOUD.FillClipPlaneManager.getInstance(o).isEnabled())var u=CLOUD.FillClipPlaneManager.getInstance(o).getFillClipBoundingBox();var c=r.modelManager.sceneState,h=a.getVisibleComponentSet(c.getSelectionSet()),d=r.getBoundingBoxByIds(h);CLOUD.GlobalData.IsMobile?s=n(t):!d||d.isEmpty()?s=n(t):(l?d.intersect(l):u&&d.intersect(u),s=d.getCenter());break;case CLOUD.RotatePivotMode.CENTER:s=o.getBoundingBox().getCenter();break;case CLOUD.RotatePivotMode.CAMERA:s=null;break;default:s=n(t)}return this.dirtyCamera(!0),this.setCameraChanging(!0),this.pivot=s,s},this.touchUpdateRotationInPersonView=function(e,t){this.dirtyCamera(!0),this.setCameraChanging(!0);var n=this,i=this.camera.position,r=this.camera.target.clone().sub(i),a=r.length(),o=this.camera.getWorldDirection(),s=this.camera.realUp||this.camera.up,u=o.clone().cross(s).normalize(),c=u.clone().cross(o).normalize();this.camera.realUp.copy(c);var d,f,p=CLOUD.EditorConfig.LockAxisZRange;if(Math.abs(e)>Math.abs(t))d=h,f=e;else{if(CLOUD.EditorConfig.LockAxisZ&&!l(t,this.camera.target,p))return;d=u;var m=new THREE.Vector3(0,1,0).clone().cross(s),g=m.dot(u),v=Math.asin(m.length());g<0&&(v=-v),v+t>Math.PI/4-1e-6?t=Math.PI/4-1e-6-v:v+t<-Math.PI/4+1e-6&&(t=-Math.PI/4+1e-6-v),f=t}var y=(new THREE.Quaternion).setFromAxisAngle(d,f);!function(e){var t=new THREE.Vector3;o.applyQuaternion(e).normalize(),t.copy(i).add(o.multiplyScalar(a)),n.camera.target.copy(t)}(y),this.camera.realUp.applyQuaternion(y).normalize()},this.touchUpdateRotationInModelView=function(e,t,n){this.dirtyCamera(!0),this.setCameraChanging(!0);var i=n||this.scene.getBoundingBox().getCenter(),r=this.camera.position,u=this.camera.target.clone().sub(r),c=u.length(),d=r.clone().sub(i),f=d.length(),p=null,g=this.camera.getWorldDirection();d.normalize();var v=function(e){var t=new THREE.Vector3,n=d.clone().applyQuaternion(e).normalize();r.copy(i).add(n.multiplyScalar(f)),g.applyQuaternion(e).normalize(),t.copy(r).add(g.multiplyScalar(c)),m.camera.target.copy(t)},y=this.camera.up,E=g.clone().cross(y).normalize(),b=E.clone().cross(g).normalize();this.camera.realUp.copy(b);var x;if(CLOUD.EditorConfig.LockAxisZ){if(Math.abs(e)>Math.abs(t))x=h,p=(new THREE.Quaternion).setFromAxisAngle(x,e),v(p),this.camera.realUp.applyQuaternion(p).normalize();else if(null!=CLOUD.EditorConfig.LockAxisZRange&&Math.abs(t)>1e-4){var M=CLOUD.EditorConfig.LockAxisZRange;l(t,i,M)&&(x=g.clone().cross(y).normalize(),p=(new THREE.Quaternion).setFromAxisAngle(x,t),v(p),this.camera.realUp.applyQuaternion(p).normalize(),this.adjustCameraUp())}}else if(Math.abs(e)>Math.abs(t))(Math.abs(g.y+1)<1e-4||Math.abs(g.y-1)<1e-4)&&(x=g.clone().cross(this.camera.realUp).normalize(),p=(new THREE.Quaternion).setFromAxisAngle(x,.1),v(p),this.camera.realUp.applyQuaternion(p).normalize(),this.adjustCameraUp()),x=g.y>0&&this.camera.realUp.y<0?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),p=(new THREE.Quaternion).setFromAxisAngle(x,e),v(p),this.camera.realUp.applyQuaternion(p).normalize();else if(Math.abs(t)>.01){x=g.clone().cross(this.camera.realUp).normalize();var _=new THREE.Vector3(0,1,0).clone().cross(y),C=_.dot(E),I=Math.asin(_.length());C<0&&(I=-I),I+t>Math.PI/2-1e-6?t=Math.PI/2-1e-6-I:I+t<-Math.PI/2+1e-6&&(t=-Math.PI/2+1e-6-I),p=(new THREE.Quaternion).setFromAxisAngle(x,t),v(p),this.camera.realUp.applyQuaternion(p).normalize(),this.adjustCameraUp()}this.pivotBallGroup||s(),this.pivotBallGroup.visible=!0;for(var O=o(),T=a(),L=0;L<this.pivotBallGroup.children.length;L++){var S=this.pivotBallGroup.children[L];S.position.copy(T),S.scale.set(O,O,O),S.updateMatrixWorld()}},this.touchUpdateRotation=function(e,t){var n=this.camera.position;this.scene.getBoundingBox().containsPoint(n)?this.touchUpdateRotationInPersonView(e,t):this.touchUpdateRotationInModelView(e,t,a())},this.clearTouchRotateState=function(){this.pivotBallGroup&&(this.pivotBallGroup.visible=!1)},this.touchEndHandler=function(){this.viewer.editorManager.cameraChange=!1,this.clearTouchRotateState(),this.touchUpdate()},this._adjustCameraForDolly=function(e,t){var n=.5*(t-1);if(Math.abs(n)<1e-6)return!1;var i=this.camera,r=i.position,a=this.getWorldEye(),o=new THREE.Vector3;e?o.subVectors(e,r):o.copy(a),o.multiplyScalar(n);var s=o.length();i.isPerspective&&s<this.minDollyDistance&&o.normalize().multiplyScalar(this.minDollyDistance);var l=new THREE.Vector3;return l.addVectors(r,o),i.isPerspective||(i.orthoScale*=t,i.setZoom(i.orthoScale)),i.position.copy(l),i.target.copy(a.add(l)),this.dirtyCamera(!0),this.setCameraChanging(!0),!0},this.touchDolly=function(e,t,n){var i=new THREE.Vector2(e,t),r=this.getIntersectContext(i),a=this.intersector.hitTest(r);null!=a?this._adjustCameraForDolly(a,n):this._adjustCameraForDolly(null,n)},this.touchUpdate=function(){var e=new THREE.Vector3,t=new THREE.Quaternion;return function(){var n=new THREE.Vector3;n.copy(this.camera.up),this.camera.up.copy(this.camera.realUp),this.camera.lookAt(this.camera.target),this.camera.up.copy(n),this.camera.updateMVP(),(e.distanceToSquared(this.camera.position)>1e-6||8*(1-t.dot(this.camera.quaternion))>1e-6)&&(r(),this.dirtyCamera(!1),e.copy(this.camera.position),t.copy(this.camera.quaternion))}}(),this.goTurnForWalk=function(e){var t=this.getCamera(),n=t.position,i=t.target,r=new THREE.Vector3(i.x-n.x,0,i.z-n.z),a=Math.cos(e),o=Math.sin(e),s=new THREE.Vector3(r.x*a-r.z*o,0,r.x*o+r.z*a);i.x=n.x+s.x,i.z=n.z+s.z,this.dirtyCamera(!0),this.setCameraChanging(!0)},this.goPitchForWalk=function(e){var t=this.getCamera(),n=t.position,i=t.target,r=i.x-n.x,a=i.z-n.z,o=Math.sqrt(r*r+a*a),s=new THREE.Vector3(o,i.y-n.y,0),l=Math.cos(e),u=Math.sin(e),c=new THREE.Vector3(s.x*l-s.y*u,s.x*u+s.y*l,0);i.y=n.y+c.y,this.dirtyCamera(!0),
this.setCameraChanging(!0)},this.goUpDownForWalk=function(e){var t=this.getCamera(),n=t.position,i=t.target,r=new THREE.Vector3(0,1,0),a=this.scene.getMatrixGlobal(),o=u(t,a,r,e);n.y+=o.y,i.y+=o.y,this.dirtyCamera(!0),this.setCameraChanging(!0)},this.stepCameraForWalk=function(e,t){var n,i=this.getCamera(),r=i.position,a=i.target,o=new THREE.Vector3(a.x-r.x,0,a.z-r.z).normalize(),s=new THREE.Vector3(0,1,0),l=o.clone().cross(s),c=this.scene.getMatrixGlobal();switch(e){case CLOUD.MoveDirection.FORWARD:n=u(i,c,o,t),n.y=0;break;case CLOUD.MoveDirection.BACK:o.multiplyScalar(-1),n=u(i,c,o,t),n.y=0;break;case CLOUD.MoveDirection.LEFT:l.multiplyScalar(-1),n=u(i,c,l,t),n.y=0;break;case CLOUD.MoveDirection.RIGHT:n=u(i,c,l,t),n.y=0}r.add(n),a.add(n),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.hitTestWithGround=function(){var e=this.getCamera(),t=e.up.clone().multiplyScalar(-1),n=new THREE.Ray(e.position.clone(),t),i=this.getIntersectContext(null),r=this.intersector.byGravity;this.intersector.byGravity=!0;var a=this.intersector.intersect(i,n,!1);return this.intersector.byGravity=r,a},this.hitTestForward=function(e){var t=this.getCamera(),n=this.getWorldEye();n.normalize(),n=n.multiplyScalar(e);var i=new THREE.Ray(t.position.clone(),n),r=this.getIntersectContext(null);return this.intersector.intersect(r,i,!1)},this.hitTestRight=function(e){var t=this.getCamera(),n=this.getWorldEye();n.normalize();var i=t.up,r=n.cross(i).normalize();r=r.multiplyScalar(e);var a=new THREE.Ray(t.position.clone(),r),o=this.getIntersectContext(null);return this.intersector.intersect(o,a,!1)},this.computeGravity=function(){this.gravity=0;var e=this.hitTestWithGround();if(null==e){var t=this.scene.getMatrixGlobal(),n=new THREE.Matrix4;n.getInverse(t);var i=this.camera.position.clone();i.applyMatrix4(n),i.z=0,i.applyMatrix4(t),this.distanceToGround=Math.abs(this.camera.position.y-i.y),void 0!=this.hitNullCount&&0!=this.hitNullCount||(this.hitNullCount=1)}else this.hitNullCount=0;if(1==this.hitNullCount)return void(this.gravity=0);if(void 0===this.manHeight)this.computeManHeight();else{var r=e?e.distance-this.manHeight:this.distanceToGround-this.manHeight;if(r/=this.scene.getGlobalScaleFactor(),Math.abs(r)<.1)return;this.gravity=r}},this.computeManHeight=function(){if(!this.manHeight){var e=this.hitTestWithGround(),t=this.scene.getMatrixGlobal(),n=new THREE.Matrix4;if(n.getInverse(t),null!=e){var i=e.point.clone();i.applyMatrix4(n),i.z+=1650,i.applyMatrix4(t),this.manHeight=Math.abs(e.point.y-i.y)}else{var r=this.camera.position.clone();r.applyMatrix4(n),r.z=0;var a=r.clone();a.z+=1650,r.applyMatrix4(t),a.applyMatrix4(t),this.manHeight=Math.abs(a.y-r.y)}}},this.walkWithParallelEye=function(){var e=this.camera,t=this.getWorldEye(),n=t.length(),i=this.scene,r=i.getBoundingBox().getCenter(),a=new THREE.Vector3;a.subVectors(r,e.position);var o=a.length();a.y=0,a.normalize(),a.multiplyScalar(o),e.position.subVectors(r,a),e.target.addVectors(e.position,a.normalize().multiplyScalar(n));var s=new THREE.Vector3(0,1,0);e.up.copy(s),e.realUp.copy(s),this.dirtyCamera(!0),this.setCameraChanging(!0),this.update(!0)},this.updateFlyMove=function(e,t){var n=this.camera;this.dirtyCamera(!0),this.setCameraChanging(!0);var i=CLOUD.MoveDirection;e&i.FORWARD&&n.translateZ(-t),e&i.BACK&&n.translateZ(t),e&i.LEFT&&n.translateX(-t),e&i.RIGHT&&n.translateX(t),e&i.UP&&n.translateY(t),e&i.DOWN&&n.translateY(-t),this.flyOnWorld()},this.flyOnWorld=function(e){var t=this.camera,n=t.up.clone();e=!1!==e,e&&t.realUp&&(t.up.copy(t.realUp),t.lookAt(t.target),t.up.copy(n)),r(),this.dirtyCamera(!1),f.copy(t.position),p.copy(t.quaternion)},this.rotateForFly=function(e,t,n,i){var r=this.camera,a=r.position,o=r.target,s=o.clone().sub(a),l=new THREE.Vector3(0,1,0),u=r.realUp||r.up,c=s.clone().cross(u).normalize();if(this.dirtyCamera(!0),this.setCameraChanging(!0),CLOUD.EditorConfig.LockAxisZ&&(t=0),0!=t){var h=(new THREE.Quaternion).setFromAxisAngle(c,-t),d=s.clone();d.applyQuaternion(h);var f=d.angleTo(l);f-=.5*Math.PI,f>=n&&f<=i&&s.applyQuaternion(h)}if(0!=e){var p=(new THREE.Quaternion).setFromAxisAngle(l,-e);s.applyQuaternion(p)}o.addVectors(a,s),this.flyOnWorld()},this.fitAndRotateBySelection=function(){this.viewer.zoomToSelection()},this.flyToPointWithParallelEye=function(e){var t=this.getWorldEye(),n=t.length(),i=t.clone();i.y=0,i.normalize(),i.setLength(n);var r=new THREE.Vector3(0,1,0);this.camera.up=r,this.camera.realUp=r.clone(),this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,i),this.update(!0)},this.flyToPoint=function(e){var t=this.getWorldEye();this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,t),this.update(!0)},this.setCameraHeight=function(e,t){this.cameraAbsoluteHeightEnabled=!1,this.cameraRelativeHeight=t,void 0===this.cameraConstraintHeights?this.cameraConstraintHeights=[]:this.cameraConstraintHeights.length=0;for(var n=0,i=e.length;n<i;++n)this.cameraConstraintHeights[n]=e[n]},this.setCameraAbsoluteHeight=function(e){this.cameraAbsoluteHeightEnabled=!0,this.cameraAbsoluteHeight=e},this.updateCameraHeight=function(){var e,t,n=this.scene,i=this.getCamera(),r=n.drawingToWorld(i.position),a=r.z;if(this.cameraAbsoluteHeightEnabled)void 0===this.cameraAbsoluteHeight&&(this.cameraAbsoluteHeight=a),e=this.cameraAbsoluteHeight;else if(void 0===this.cameraConstraintHeights)e=a;else{var o=CLOUD.Utils.findRange(this.cameraConstraintHeights,a);if(e=this.cameraConstraintHeights[o],e+=this.cameraRelativeHeight,o<this.cameraConstraintHeights.length-1){var s=this.cameraConstraintHeights[o+1];e>s&&(e=s)}}e!==a&&(t=n.worldToDrawing({x:r.x,y:r.y,z:e}),this.setCameraPosition(t))},this.getRaycaster=function(e,t){var n=new CLOUD.Raycaster,i=new THREE.Vector2;return this.mapWindowToViewport(e,t,i),n.setFromCamera(i,this.camera),n},this.translateCameraForWalk=function(e,t){var n=this.collisionManager;if(0!==e.x){if(!1===CLOUD.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(CLOUD.MoveDirection.RIGHT,e.x*t);var i=1;e.x<0&&(i=-1);var r=this.hitTestRight(i);if(r){var a=this.viewer.modelManager.getNodeInfosByUserId(r.userId),o=a?a[0].userData:null,s=n.hasCollision(o,r.distance);0==s&&this.stepCameraForWalk(CLOUD.MoveDirection.RIGHT,e.x*t)}else this.stepCameraForWalk(CLOUD.MoveDirection.RIGHT,e.x*t)}if(0!==e.y)this.goUpDownForWalk(e.y*t*.5);else{var l=t;if(0!=this.gravity){var u=Math.abs(this.gravity);l=l>=u?u:.2*u}this.gravity>0?this.goUpDownForWalk(-l):this.gravity<0&&this.goUpDownForWalk(l)}if(0!==e.z){if(!1===CLOUD.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(CLOUD.MoveDirection.BACK,e.z*t);var i=1;e.z>0&&(i=-1);var c=this.hitTestForward(i);if(c){var a=this.viewer.modelManager.getNodeInfosByUserId(c.userId),o=a?a[0].userData:null,s=n.hasCollision(o,c.distance);0==s&&this.stepCameraForWalk(CLOUD.MoveDirection.BACK,e.z*t)}else this.stepCameraForWalk(CLOUD.MoveDirection.BACK,e.z*t)}},this.rotateCameraForWalk=function(e,t){0!==e.y&&(this.goTurnForWalk(-e.y*Math.PI*t),e.y=0),0!==e.x&&(this.goPitchForWalk(e.x*Math.PI),e.x=0)},this.zoomCameraForWalk=function(e){this.adjustCameraForDolly(e,null)},this.movePlane=function(e,t,n,i,r){if(void 0==r){var a=new THREE.Plane;a.setComponents(e.x,e.y,e.z,e.w),r=new THREE.Vector3,a.coplanarPoint(r)}var o=new THREE.Vector3(e.x,e.y,e.z),s=this.camera,l=s.getWorldDirection(),u=new THREE.Plane;u.setFromNormalAndCoplanarPoint(l,r);var c=this.getRaycaster(t.clientX,t.clientY),h=new THREE.Vector3,d=this.getRaycaster(n.x,n.y),f=new THREE.Vector3;if(c.ray.intersectPlane(u,h)&&d.ray.intersectPlane(u,f)){h.subVectors(h,f),h.projectOnVector(o);var p=h.length();if(h.dot(o)<0&&(p=-p),0!=p)return i&&(o.multiplyScalar(p),p=o.x+o.y+o.z),p}return null},this.getZenith=function(){var e=n.position,t=m.viewer.getBoundingBox().getCenter();return e.clone().sub(t.clone()).clone().angleTo(h.clone())},this.getAzimuth=function(){var e=n.position,t=m.viewer.getBoundingBox().getCenter(),i=e.clone().sub(t.clone()),r=i.clone().projectOnPlane(h.clone()),a=r.angleTo(d.clone());return r.x<0&&(a=360-a),a},this.getCurrentRangeofCamera=function(){var e=this.viewer,t=this.camera,n=e.getBoundingBox(),i=n.getCenter(),r=t.position,a=n.getSize().length(),o=.5*a/Math.tan(THREE.Math.degToRad(.5*t.fov));return i.distanceTo(r)/o},this.setMaximalRangeofCamera=function(e){this.farFactor=e||2},this.getMaximalRangeofCamera=function(){return this.farFactor},this.cameraWithinMaximumRange=function(e){var t=e||this.farFactor;return!(this.getCurrentRangeofCamera()>t)},this.resetCameraToMaximumRange=function(e){var t=this.viewer,n=this.camera,i=t.getBoundingBox(),r=i.getCenter(),a=n.position,o=e||this.farFactor,s=(new THREE.Vector3).subVectors(r,a),l=i.getSize().length(),u=.5*l/Math.tan(THREE.Math.degToRad(.5*n.fov));s.setLength(o*u);var c=r.clone().sub(s),h=this.getWorldEye();this.camera.position.copy(c),this.camera.target.copy(h.add(c)),this.updateView(!0)}},CLOUD.IntersectContext=function(){this.scene=null,this.camera=null,this.octreeRoots=null,this.octantMap=null,this.mouse=new THREE.Vector2},CLOUD.IntersectHelper=function(e){this.viewer=e,this.filter=e.getFilter(),this.raycaster=new CLOUD.Raycaster,this.lastIntersect=null,this.highPriorities=[CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER]},CLOUD.IntersectHelper.prototype.destroy=function(){this.viewer=null,this.filter=null,this.raycaster=null,this.lastIntersect=null,this.highPriorities=null},CLOUD.IntersectHelper.prototype.defaultIntersect=function(e,t,n,i,r){if(e.visible||r){var a=[];e.raycast(this.raycaster,a);var o=[];if(a.length>0)for(var s=0;s<a.length;s++)a[s].distance<=n.far&&a[s].distance>=n.near&&!this.viewer.clipPoint(a[s].point)&&o.push(a[s]);return i?o:(o.sort(function(e,t){return e.distance-t.distance}),o.length>0?o[0]:null)}},CLOUD.IntersectHelper.prototype.intersectMeshesWithDistance=function(e,t,n,i,r,a){if(!t||!t.mesh)return null;var o,s=CLOUD.Utils.MinusEpsilon,l=this.raycaster,u=[],c=this.filter,h=c._hasVisibleFilter(),d=c._hasPickableFilter(),f=this.viewer.modelManager;1==this.byGravity?i.near=0:i.near+=s;var p,m,g=t.info,v=t.mesh,y=[],E=this.viewer.modelManager.getMatrixWorldGlobal();if(r){for(p=0,m=e.length;p<m;p++)!function e(t,n){if(n.push(t),t.childOctants)for(var i=0,r=t.childOctants.length;i<r;i++)e(t.childOctants[i],n)}(e[p],y)}else for(p=0,m=e.length;p<m;p++)l.intersectOctantForNode(e[p],y);for(p=0,m=y.length;p<m;p++){var b=g[y[p].octantId];if(b)for(var x=0,M=b.length;x<M;x++){var _=b[x];if(!function(e,t){var n=f.isHiddenSourceObjectUserId(e.userId);if(t){if(h&&!c._isVisible(e)||d&&!c._isPickable(e)||n)return!0}else if(h&&!c._isVisible(e)||n)return!0;return!1}(_,n)){var C=_.boundingBox.clone();if(C.applyMatrix4(E),!((o=l.ray.intersectBoxWithDistance(C))<i.near||o>i.far)){var I=CLOUD.ModelView.BaseDescriptor.getMeshIdFromOctantMap(_),O=v[I];if(O)for(var T=0,L=O.length;T<L;T++)u.push({object:O[T],distance:o,nodeInfo:_})}}}}u.sort(function(e,t){return e.distance-t.distance});var S=[];for(p=0;p<u.length;p++)u[p].distance>i.far||u[p].distance<i.near||u[p].object.raycast(l,u[p].nodeInfo,i,this.viewer,S,a);if(S.sort(function(e,t){return e.distance-t.distance}),a){var D=[];for(p=0,m=S.length;p<m;p++){var w=S[p];D.push({object:w.object.object,distance:w.distance,matrix:w.object.matrix,userId:w.userId,face:w.face,point:w.point})}return D}return S.length>0?S[0]:null},CLOUD.IntersectHelper.prototype.intersect=function(e,t,n){var i=this,r=i.raycaster;if(null===t)r.setFromCamera(e.mouse,e.camera);else{var a=t.origin,o=t.direction;r.set(a,o)}r.camera=e.camera,r.viewportSize=e.viewportSize;var s={near:e.camera.near,far:e.camera.far};e.scene.shrinkScopeByClipPlane(r,s);for(var l=[],u=e.scene.getObjectGroups(),c=0;c<u.length;c++)if(u[c].isPickable()&&0!==u[c].children.length){var h=null,d=e.scene.getObjectGroupType(u[c].name);if(i.highPriorities.indexOf(d.groupType)>-1)(h=this.defaultIntersect(u[c],n,s,void 0,!0))&&(h.objectType=u[c].pickableType,h.hoverEnabled=u[c].hoverEnabled,l.push(h));else switch(d.groupType){case CLOUD.ObjectGroupType.MODEL:var f=d.databagId;e.octreeRoots[f]&&e.octantMap[f]&&(h=this.intersectMeshesWithDistance(e.octreeRoots[f],e.octantMap[f],n,s,e.isExploded))&&(h.objectType=u[c].pickableType,h.hoverEnabled=u[c].hoverEnabled,l.push(h));break;case CLOUD.ObjectGroupType.GEOMETRY:for(var f in e.octreeRoots)(h=this.intersectMeshesWithDistance(e.octreeRoots[f],e.octantMap[f],n,s,e.isExploded))&&(h.objectType=u[c].pickableType,h.hoverEnabled=u[c].hoverEnabled,l.push(h));break;default:h=this.defaultIntersect(u[c],n,s),h&&(h.objectType=u[c].pickableType,h.hoverEnabled=u[c].hoverEnabled,l.push(h))}}l.sort(function(e,t){return e.distance-t.distance});var p=l.length;if(p>0)for(var m=0;m<p;++m){h=l[m];var g=h.object;if(g.geometry)return h.objectType===CLOUD.PICKABLETYPE.Marker3d?h.userId=h.id:void 0===h.userId&&(h.userId=g.userId||g.name),h.databagId=g.databagId,this.lastIntersect={intersect:h,pickable:n},h}return this.lastIntersect=null,null},CLOUD.IntersectHelper.prototype.getObjectsByClientCoordinates=function(e){var t=this.viewer.cameraControl.getIntersectContext(e),n=this.raycaster;return n.setFromCamera(t.mouse,t.camera),n.camera=t.camera,n.viewportSize=t.viewportSize,this.getObjectsByRaycaster(t,n)},CLOUD.IntersectHelper.prototype.getObjectsByRaycaster=function(e,t,n){this.raycaster=t;var i=n?0:e.camera.near,r=n?1/0:e.camera.far,a={near:i,far:r};e.scene.shrinkScopeByClipPlane(t,a);for(var o=[],s=e.scene.getObjectGroups(),l=0;l<s.length;l++)if(s[l].isPickable()&&0!==s[l].children.length){var u=[],c=e.scene.getObjectGroupType(s[l].name);switch(c.groupType){case CLOUD.ObjectGroupType.MODEL:var h=c.databagId;e.octreeRoots[h]&&e.octantMap[h]&&(u=this.intersectMeshesWithDistance(e.octreeRoots[h],e.octantMap[h],!1,a,e.isExploded,!0),o=o.concat(u));break;case CLOUD.ObjectGroupType.GEOMETRY:for(var h in e.octreeRoots)u=this.intersectMeshesWithDistance(e.octreeRoots[h],e.octantMap[h],!1,a,e.isExploded,!0),o=o.concat(u);break;default:u=this.defaultIntersect(s[l],!1,a,!0),o=o.concat(u)}}return o.sort(function(e,t){return e.distance-t.distance}),o},CLOUD.IntersectHelper.prototype.hitTest=function(e){var t=this.intersect(e,null,!1);return null!==t?t.point:null},CLOUD.IntersectHelper.prototype.pick=function(e,t){var n=this.intersect(e,null,!0);return t&&t(n),n},CLOUD.IntersectHelper.prototype.getIntersectByRay=function(e,t){return this.intersect(e,t,!0)},CLOUD.PickUtil={pickByRect:function(e,t,n,i,r,a,o){function s(e,t){for(var n=0,i=e.planes,r=0;r<6;r++){var a=i[r];v.x=a.normal.x>0?t.min.x:t.max.x,y.x=a.normal.x>0?t.max.x:t.min.x,v.y=a.normal.y>0?t.min.y:t.max.y,y.y=a.normal.y>0?t.max.y:t.min.y,v.z=a.normal.z>0?t.min.z:t.max.z,y.z=a.normal.z>0?t.max.z:t.min.z;var o=a.distanceToPoint(v),s=a.distanceToPoint(y);if(o<0&&s<0)return!1;o*s>=0&&++n}return 6===n?"in":"intersect"}function l(e,n){if(g.set(e.min,e.max),t.intersectsBox(g)){n.push(e);for(var i=0,r=e.childOctants.length;i<r;++i){l(e.childOctants[i],n)}}}var u;u=a&&o?o.x>a.x?"window":"cross":"window";var c={},h=i.modelManager,d=h.getOctreeRoots(),f=h.getOctantMap(),p=h.getSceneState(),m=e.getMatrixGlobal(),g=new THREE.Box3,v=new THREE.Vector3,y=new THREE.Vector3,E=h.getFilter(),b=E._hasVisibleFilter(),x=E._hasPickableFilter();if(n===CLOUD.OPSELECTIONTYPE.Clear)return void p.clearSelection();var M,_,C;for(var I in d){M=[],C=f[I],_=d[I];var O,T,L={},S={};for(O=0,T=_.length;O<T;O++)l(_[O],M);for(O=0,T=M.length;O<T;O++){var D=C.info[M[O].octantId];if(D)for(var w=0,U=D.length;w<U;w++){var R=D[w];(function(e){var t=h.isHiddenSourceObjectUserId(e.userId);return b&&!E._isVisible(e)||x&&!E._isPickable(e)||t})(R)||(g.copy(R.boundingBox),g.applyMatrix4(m),function(e){for(var t=new THREE.Vector3,n=0;n<8;++n)if(t.x=n<4?e.min.x:e.max.x,t.y=n/2<2?e.min.y:e.max.y,t.z=n%2==0?e.min.z:e.max.z,!i.clipPoint(t))return!1;return!0}(g)||("window"!==u||L[R.userId]?"cross"!==u||S[R.userId]||("in"===s(t,g)||"intersect"===s(t,g)&&function(e){function t(e,t,n,i,r){var a,o;for(a=0,o=e.length-3;a<=o;a+=3){var s=new THREE.Vector3(e[a],e[a+1],e[a+2]),l=r.x*Math.abs(s.x)+r.y*Math.abs(s.y)+r.z*Math.abs(s.z),u=t.dot(s),c=n.dot(s),h=i.dot(s);if(Math.max(-Math.max(u,c,h),Math.min(u,c,h))>l)return!1}return!0}var n=[];i.modelManager.traverseModels(function(t){t._handler&&(n=n.concat(t._handler.getGeometryBuffersByUserId(e)))}),n.sort(function(e,t){return e.index.length-t.index.length});for(var r=new THREE.Vector3(Math.min(a.x,o.x),Math.min(a.y,o.y),0),s=new THREE.Vector3(Math.max(a.x,o.x),Math.max(a.y,o.y),0),l=new THREE.Box3(r,s),u=0;u<n.length;u++)for(var c=n[u].position,h=n[u].index,d=n[u].matrix,f=0;f<h.length;f+=3){var p=new THREE.Vector3(c[3*h[f]],c[3*h[f]+1],c[3*h[f]+2]),m=new THREE.Vector3(c[3*h[f+1]],c[3*h[f+1]+1],c[3*h[f+1]+2]),g=new THREE.Vector3(c[3*h[f+2]],c[3*h[f+2]+1],c[3*h[f+2]+2]);d&&(p.applyMatrix4(d),m.applyMatrix4(d),g.applyMatrix4(d));var v=i.worldToClient(p),y=i.worldToClient(m),E=i.worldToClient(g),b=new THREE.Vector3(v.x,v.y,0),x=new THREE.Vector3(y.x,y.y,0),M=new THREE.Vector3(E.x,E.y,0),_=new THREE.Triangle(b,x,M);if(function(e,n){var i=new Vector3,r=new Vector3,a=new Vector3,o=new Vector3,s=new Vector3,l=new Vector3,u=new Vector3,c=new Vector3,h=new Vector3;u.copy(e.getCenter()),c=e.max.clone().sub(u),i=n.a.clone().sub(u),r=n.b.clone().sub(u),a=n.c.clone().sub(u),o=r.clone().sub(i),s=a.clone().sub(r),l=i.clone().sub(a);var d=[0,-o.z,o.y,0,-s.z,s.y,0,-l.z,l.y,o.z,0,-o.x,s.z,0,-s.x,l.z,0,-l.x,-o.y,o.x,0,-s.y,s.x,0,-l.y,l.x,0];return!!t(d,i,r,a,c)&&(d=[1,0,0,0,1,0,0,0,1],!!t(d,i,r,a,c)&&(h=o.clone().cross(s),d=[h.x,h.y,h.z],t(d,i,r,a,c)))}(l,_))return!0}return!1}(R.userId))&&(c[R.userId]=!0,S[R.userId]=!0):"in"===s(t,g)||"intersect"===s(t,g)&&function(e){var n=[],r=[];i.modelManager.traverseModels(function(t){t._handler&&(n=n.concat(t._handler.getGeometryBuffersByUserId(e)))});for(var a=0;a<n.length;a++)for(var o=n[a].position,s=n[a].matrix,l=0;l<o.length;l+=3){var u=new THREE.Vector3(o[l],o[l+1],o[l+2]);s&&u.applyMatrix4(s),u.applyMatrix4(m),r.push(u)}var c=!0;return r.every(function(e){return t.containsPoint(e)||(c=!1),c}),c}(R.userId)?c[R.userId]=!0:(L[R.userId]=!0,delete c[R.userId])))}}}var A=Object.keys(c);return A.length>0&&!1!==r&&(CLOUD.OPSELECTIONTYPE.Remove===n&&p.removeSelection(A),CLOUD.OPSELECTIONTYPE.Add===n&&p.addSelection(A)),A},getObjectsInBox:function(e,t,n,i){function r(e){return!(e.max.x<t.min.x||e.min.x>t.max.x||e.max.y<t.min.y||e.min.y>t.max.y||e.max.z<t.min.z||e.min.z>t.max.z)}function a(e,t){if(c.set(e.min,e.max),r(c)){t.push(e);for(var n=0,i=e.childOctants.length;n<i;++n){a(e.childOctants[n],t)}}}var o={},s=n.getOctreeRoots(),l=n.getOctantMap(),u=e.getMatrixGlobal(),c=new THREE.Box3,h=n.getFilter(),d=h._hasVisibleFilter(),f=h._hasPickableFilter();for(var p in s){var m,g,v=[],y=l[p],E=s[p];for(m=0,g=E.length;m<g;m++)a(E[m],v);for(m=0,g=v.length;m<g;m++){var b=y.info[v[m].octantId];if(b)for(var x=0,M=b.length;x<M;x++){var _=b[x];(function(e){var t=n.isHiddenSourceObjectUserId(e.userId);return d&&!h._isVisible(e)||f&&!h._isPickable(e)||t})(_)||(c.copy(_.boundingBox),c.applyMatrix4(u),!r(c)||function(e){return e.max.x>=t.max.x&&e.min.x<=t.min.x&&e.max.y>=t.max.y&&e.min.y<=t.min.y&&e.max.z>=t.max.z&&e.min.z<=t.min.z}(c)||function(e){for(var t=new THREE.Vector3,n=0;n<8;++n)if(t.x=n<4?e.min.x:e.max.x,t.y=n/2<2?e.min.y:e.max.y,t.z=n%2==0?e.min.z:e.max.z,!i.clipPoint(t))return!1;return!0}(c)||(o[_.userId]=!0))}}}return Object.keys(o)}},CLOUD.PickHelper=function(e){this.cameraControl=e,this.scene=e.scene,this.timerId=null,this.lastIntersected=null},CLOUD.PickHelper.prototype={constructor:CLOUD.PickHelper,destroy:function(){this.cameraControl=null,this.scene=null,this.lastIntersected=null,this.timerId&&(clearTimeout(this.timerId),this.timerId=null)},click:function(e,t){function n(){t&&!1===t.pickable&&(t=null),CLOUD.Logger.time("handle mouse pick."),i.handleMousePick(e,!1,t),CLOUD.Logger.timeEnd("handle mouse pick.")}var i=this;if(e.button===THREE.MOUSE.RIGHT)return void n();this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(n,500)},doubleClick:function(e){e.preventDefault(),this.timerId&&clearTimeout(this.timerId),this.handleMousePick(e,!0,null)},handleMousePick:function(e,t,n){function i(n,i){var r=null;if(n&&n.objectType==CLOUD.PICKABLETYPE.Room){var a=n.face.contourIndex,o=n.object.geometry.contour;r=a?{startPoint:o[a.st],endPoint:o[a.ed]}:null}u.dispatchEvent({type:CLOUD.EVENTS.ON_CLICK_PICK,event:e,doubleClick:t,canvasPos:{x:l.x,y:l.y},intersectInfo:n?{selectedObjectId:n.userId,objectType:n.objectType,selectable:i,modelId:n.databagId,worldPosition:n.worldPosition,worldBoundingBox:n.worldBoundingBox,point:n.point,innnerDebugging:n.innnerDebugging,normal:n.face?n.face.normal:null,boundaryPoints:r}:null})}if(this._canPick()||e.button!==THREE.MOUSE.LEFT){var r=this,a=this.cameraControl,o=a.viewer.modelManager.sceneState,s=new THREE.Vector2(e.clientX,e.clientY),l=a.screenToCanvas(e.clientX,e.clientY),u=a.viewer.modelManager,c=null;if(n)n.pickable&&(c=n.intersect);else{var h=a.getIntersectContext(s);c=a.intersector.pick(h,null)}if(!c){var d=o.getSelection();if(e.ctrlKey)return;return e.button!=THREE.MOUSE.RIGHT&&d.length>0&&(o.clearSelection(),a.updateView(!0)),r.setSelectedIdsForOutline(o.getSelection()),void(n&&!n.pickable?(c=n.intersect,c.cx=s.x,c.cy=s.y,i(c,!1)):i(null))}var f=c.userId;if(CLOUD.Utils.isMobileDevice()&&(a.pivot=c.point),r.scene.intersectToWorld(c,a.viewer),c.innnerDebugging=e.altKey,c.cx=s.x,c.cy=s.y,c.face&&c.face.normal){var p=c.face.normal;for(var m in p)p[m]=p[m]==-p[m]?Math.abs(p[m]):p[m]}if(e.button===THREE.MOUSE.RIGHT)return void i(c,!1);if(t)CLOUD.GlobalData.EnableDemolishByDClick?(o.setSelection([f]),i(c,!0),a.updateView(!0)):(o.setSelection([f]),a.fitAndRotateBySelection(),i(c,!0));else{var g=o.getSelection();if(e.ctrlKey){var v=g.indexOf(f);-1==v?o.addSelection([f]):(g.splice(v,1),o.setSelection(g))}else-1==g.indexOf(f)?o.setSelection([f]):o.clearSelection();r.setSelectedIdsForOutline(o.getSelection()),i(c,!0),a.updateView(!0)}}},handleShiftMeasure:function(e,t,n){function i(n,i,a,o){var s=r.viewer.modelManager;if(null!=n){var l=r.scene.drawingToWorld(n);n.copy(l)}if(null!=i){var u=r.scene.drawingToWorld(i[0]),c=r.scene.drawingToWorld(i[1]);i[0].copy(u),i[1].copy(c)}s.dispatchEvent({type:CLOUD.EVENTS.ON_MEASURE_PICK,event:e,pick:t,pickPoint:n,pickLine:i,pickPlane:a,userId:o})}if(this._canPick()){var r=this.cameraControl,a=new THREE.Vector2(e.clientX,e.clientY),o=r.getIntersectContext(a);r.intersector.pick(o,function(e){if(e){var r=new THREE.Vector3;r.subVectors(e.point,n),r.normalize();var a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=a.dot(r),u=o.dot(r),c=s.dot(r),h=new THREE.Vector3;h.copy(n),Math.abs(u)>=.707?h.y=e.point.y:Math.abs(c)>=Math.abs(l)?h.z=e.point.z:h.x=e.point.x,t&&n.copy(h),i(h,null,!1,e.userId)}else i(null,null,!1)})}},handleMouseMeasure:function(e,t,n,i){function r(n,i,r,o,l){var u=a.viewer.modelManager;if(null!=n){var c=a.scene.drawingToWorld(n);n.copy(c)}if(null!=i){var h=a.scene.drawingToWorld(i[0]),d=a.scene.drawingToWorld(i[1]);i[0].copy(h),i[1].copy(d)}u.dispatchEvent({type:s,event:e,pick:t,pickPoint:n,pickLine:i,pickPlane:r,normal:o,userId:l})}if(this._canPick()){var a=this.cameraControl,o=a.scene,s=i||CLOUD.EVENTS.ON_MEASURE_PICK,l={x:e.clientX,y:e.clientY},u=this.pickToPoint(l,5);null!=u?(t&&n.copy(u.pickPoint),r(u.pickPoint,u.pickLine,u.pickPlane,u.face.normal,u.userId)):(o.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE)&&o.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPLANE),r(null,null,!1))}},handleMouseHover:function(e){function t(t,i){var a=n.viewer.modelManager;null!=t&&r.scene.intersectToWorld(t,n.viewer),a.dispatchEvent({type:CLOUD.EVENTS.ON_HOVER_PICK,event:e,canvasPos:{x:h.x,y:h.y},intersectInfo:t?{selectedObjectId:t.userId,objectType:t.objectType,selectable:i,modelId:t.databagId,worldPosition:t.worldPosition,worldBoundingBox:t.worldBoundingBox,point:t.point,innnerDebugging:t.innnerDebugging}:null})}if(this._canPick()){var n=this.cameraControl,i=n.viewer.modelManager.sceneState,r=this;if(function(){if(0==r.scene.hasObjectGroup(CLOUD.ObjectGroupType.AXISGRIDMANAGER))return!1;var e=CLOUD.AxisGridManager.getInstance(r.scene);return 0!=e.getElements().length&&!1!==e.getIsEnableHover()}()){var a=this.scene.getMatrixGlobal(),o=new THREE.Vector2(e.clientX,e.clientY),s=n.getRaycaster(o.x,o.y),l=CLOUD.AxisGridManager.getInstance(this.scene),u=l.getIntersectPoints(s,a),c=l.snapOnFloors(u);n.viewer.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_AXIS_GRID_HOVER,snaps:c})}if(CLOUD.GlobalData.Hover||function(){if(r.scene.hasObjectGroup(CLOUD.ObjectGroupType.MARKER3D)){return r.scene.getObjectGroup(CLOUD.ObjectGroupType.MARKER3D).children.length>0}return!1}()){var h=n.screenToCanvas(e.clientX,e.clientY),d=new THREE.Vector2(e.clientX,e.clientY),f=n.getIntersectContext(d);n.intersector.pick(f,function(e){function a(e){switch(e.objectType){case CLOUD.PICKABLETYPE.Marker3d:e.object.setAttributeSize(e.index,e.currentSize);break;default:i.clearHover()}}if(e){var o=CLOUD.GlobalData.Hover||e.hoverEnabled;r.lastIntersected&&(r.lastIntersected.userId!=e.userId&&a(r.lastIntersected),r.lastIntersected.hoverEnabled&&t(null)),o?(r.lastIntersected&&r.lastIntersected.userId==e.userId||(!function(e){switch(e.objectType){case CLOUD.PICKABLETYPE.Marker3d:var t=e.object;e.currentSize=t.getAttributeSize(e.index),t.setAttributeSize(e.index,Math.floor(1.5*e.currentSize));break;default:CLOUD.GlobalData.EnableRenderPass?i.setHoverId(e.object.originalId):i.setHoverId(e.userId)}}(e),r.lastIntersected=e),t(e,!0)):r.lastIntersected=e,n.updateHighlight()}else r.lastIntersected&&(a(r.lastIntersected),r.lastIntersected=null,t(null),n.updateHighlight())})}}},_canPick:function(){return!!this.cameraControl.viewer.modelManager.hasModelDataReady()},setSelectedIdsForOutline:function(e){this.cameraControl.viewer.composer&&this.cameraControl.viewer.composer.setSelectedIds(e)},pickToPoint:function(e,t){void 0==t&&(t=5);var n=this.cameraControl,i=n.scene,r=new THREE.Vector2(e.x,e.y),a=n.getIntersectContext(r),o=n.intersector.pick(a);if(o){if(o.object.parent instanceof CLOUD.ExtrudeBodyManager)return null;var s,l=o.point,u=o.object.geometry,c=o.object.matrixWorld.clone(),h=n.camera.projScreenMatrix,d=a.mouse,f=a.viewportSize;if(void 0!==o.indexInfo&&(s=o.indexInfo),!u.attributes&&!u._bufferGeometry)return null;var p=u.attributes?u:u._bufferGeometry;if(!p.index||void 0===p.attributes.normal)return null;var m=p.attributes.position.array,g=p.attributes.normal.array,v=[],y=0,E=0;s?(v=p.index.array,y=s.indexStart,E=s.indexStart+s.indexCount):(CLOUD.GlobalData.BatchMergeEnabled&&o.matrix&&c.multiply(o.matrix),v=CLOUD.RemoveDuplicateVertex(p.attributes.position.array,p.index.array),E=v.length);for(var b=1/0,e=new THREE.Vector3,x=[],M=[],_=CLOUD.Utils.getMin(v.slice(y,E)),C=y;C<E;++C){var I=new THREE.Vector3(m[3*v[C]],m[3*v[C]+1],m[3*v[C]+2]);I.applyMatrix4(c);var r=I.clone();r.applyMatrix4(h);var O=.5*(r.x-d.x)*f.width,T=.5*(r.y-d.y)*f.height,L=Math.sqrt(O*O+T*T);L<b&&(b=L,e.copy(I)),s&&M.push(v[C]-_)}var S=l.clone(),D=null,w=!1;if(b<t)i.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPICKPLANE)&&i.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPICKPLANE),S=e.clone();else{var b=1/0,U=new THREE.Vector3,R=new THREE.Vector3,e=new THREE.Vector3,A=[];s?(x=m.slice(s.positionStart,s.positionStart+s.positionCount),A=CLOUD.BuildEdge(x,M)):(x=m,A=CLOUD.BuildEdge(p.attributes.position.array,p.index.array));for(var C=0;C<A.length;C+=2){var N=new THREE.Vector3(x[3*A[C]],x[3*A[C]+1],x[3*A[C]+2]);N.applyMatrix4(c);var P=new THREE.Vector3(x[3*A[C+1]],x[3*A[C+1]+1],x[3*A[C+1]+2]);P.applyMatrix4(c);var k=function(e,t,n){var i=new THREE.Vector3;i.subVectors(t,e);var r=new THREE.Vector3;r.subVectors(n,e);var a=i.dot(r);if(a<0)return e;var o=i.dot(i);if(a>o)return t;a/=o;var s=e.clone();return s.addScaledVector(i,a),s}(N,P,l),r=k.clone();r.applyMatrix4(h);var O=.5*(r.x-d.x)*f.width,T=.5*(r.y-d.y)*f.height,L=Math.sqrt(O*O+T*T);L<b&&(b=L,U.copy(N),R.copy(P),e.copy(k))}if(x=null,M=null,b<t)i.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE)&&i.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPLANE),D=new Array,D.push(U),D.push(R),S=e.clone();else{if(CLOUD.GlobalData.MeasureHighlightPlane){v=p.index.array;var B=new THREE.Matrix4;B.getInverse(c);var F=new THREE.Vector3(l.x,l.y,l.z);F.applyMatrix4(B);var H=CLOUD.GetFaceIndex(m,g,v,F,o.face.normal),G=new THREE.BufferGeometry;G.setIndex(H),G.addAttribute("position",p.attributes.position,3),G.addAttribute("normal",p.attributes.normal,3);var V=CLOUD.BuildEdge(m,H),z=new THREE.BufferGeometry;z.setIndex(V),z.addAttribute("position",p.attributes.position,3),i.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE)&&i.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPLANE);var j=i.getOrCreateObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE,{priority:1,globalSpace:!0}),W=new THREE.Mesh(G,new THREE.MeshBasicMaterial({color:1170103,opacity:.1,transparent:!0}));W.applyMatrix(o.object.matrix),j.add(W);var X=new THREE.LineSegments(z,new THREE.LineBasicMaterial({color:1170103}));X.applyMatrix(o.object.matrix),j.add(X),j.updateMatrixWorld(!0),n.updateHighlight()}w=!0}}var Y={};return Y.pickPoint=S,Y.pickLine=D,Y.pickPlane=w,Y.face=o.face,Y.userId=o.userId,Y}return null}},CLOUD.EditTool=function(e){this.name=e,this._mousePressed=!1},CLOUD.EditTool.prototype.getName=function(){return this.name},CLOUD.EditTool.prototype.onExit=function(){},CLOUD.EditTool.prototype.destroy=function(){},CLOUD.EditTool.prototype.processMouseDown=function(e){return!1},CLOUD.EditTool.prototype.processMouseMove=function(e){return!1},CLOUD.EditTool.prototype.processMouseUp=function(e){return!1},CLOUD.EditTool.prototype.processMouseWheel=function(e){return!1},CLOUD.EditTool.prototype.processMouseDoubleClick=function(e){return!1},CLOUD.EditTool.prototype.processKeyDown=function(e){return!1},CLOUD.EditTool.prototype.processKeyUp=function(e){switch(e.keyCode){case CLOUD.Keys.ESC:this._mousePressed=!1}return!1},CLOUD.EditTool.prototype.processTouchstart=function(e){return!1},CLOUD.EditTool.prototype.processTouchmove=function(e){return!1},CLOUD.EditTool.prototype.processTouchend=function(e){return!1},CLOUD.EditTool.prototype.processHover=function(e){return!1},CLOUD.EditTool.prototype.onEvent=function(e){var t=!1;switch(e.type){case"touchmove":t=this.processTouchmove(e);break;case"touchstart":t=this.processTouchstart(e);break;case"touchend":t=this.processTouchend(e);case"keydown":t=this.processKeyDown(e);break;case"keyup":t=this.processKeyUp(e);break;case"mousewheel":case"DOMMouseScroll":t=this.processMouseWheel(e);break;case"mousedown":this._mousePressed=!0,t=this.processMouseDown(e);break;case"mousemove":t=this._mousePressed?this.processMouseMove(e):this.processHover(e);break;case"mouseup":this._mousePressed=!1,t=this.processMouseUp(e);break;case"dblclick":t=this.processMouseDoubleClick(e)}return t},CLOUD.RectOpTool=function(e,t,n){CLOUD.EditTool.call(this,e),this.cameraControl=t,this.frustum=new THREE.Frustum,this.startPt=new THREE.Vector2,this.endPt=new THREE.Vector2,this.eventDispatcher=n},CLOUD.RectOpTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.RectOpTool.prototype.constructor=CLOUD.RectOpTool,CLOUD.RectOpTool.prototype.destroy=function(e){CLOUD.EditTool.prototype.destroy.call(this),this.cameraControl=null,this.frustum=null,this.startPt=null,this.endPt=null,this.eventDispatcher=null},CLOUD.RectOpTool.prototype.onUpdateUI=function(e){this.eventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_UPDATEUI,data:e,editor:this.name})},CLOUD.RectOpTool.prototype.updateFrustum=function(e,t){var n=this.startPt.x,i=this.endPt.x,r=this.startPt.y,a=this.endPt.y;if(n>i){var o=n;n=i,i=o}if(r>a){var s=r;r=a,a=s}if(i-n==0||a-r==0)return!1;var l=this.cameraControl,u=l.getContainerDimensions();return e&&l.computeFrustum(n,i,r,a,this.frustum,u),t&&this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,
left:n-u.left,top:r-u.top,width:i-n,height:a-r}),!0},CLOUD.RectOpTool.prototype.computeFrustum=function(){function e(e,t){var n=[],i=!0,r=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=e.clientToWorld(l.clone()),c=e.worldToDrawing(u);n.push(new THREE.Vector3(c.x,c.y,c.z))}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}return n}function t(e){return(new THREE.Plane).setFromCoplanarPoints(e[0],e[1],e[2])}var n=this.startPt.x,i=this.endPt.x,r=this.startPt.y,a=this.endPt.y,o=new THREE.Vector3(n,r),s=new THREE.Vector3(n,a),l=new THREE.Vector3(i,a),u=new THREE.Vector3(i,r),c=[];c.push(o,s,l,u);for(var h=this.cameraControl.viewer,d=[],f=0;f<c.length;f++){var p=[];p.push(c[f]),p.push(c[(f+1)%c.length]),p.push(c[f].clone().setZ(1)),d.push(t(e(h,p)))}var m=[];m.push(o,u,l),d.push(t(e(h,m)));var g=[];g.push(o.setZ(1),s.setZ(1),l.setZ(1)),d.push(t(e(h,g)));for(var v=new THREE.Frustum,y=0;y<d.length;y++)v.planes[y].copy(d[y]);return v},CLOUD.RectPickTool=function(e){CLOUD.RectOpTool.call(this,CLOUD.EditToolMode.PICK_BY_RECT,e.cameraControl,e.modelManager),this.viewer=e,this.scene=e.getScene(),this.pickHelper=new CLOUD.PickHelper(this.cameraControl),this.activatePick=!1,this.pickPoint=new THREE.Vector3,this.snapIsEnabled=!1},CLOUD.RectPickTool.prototype=Object.create(CLOUD.RectOpTool.prototype),CLOUD.RectPickTool.prototype.constructor=CLOUD.RectPickTool,CLOUD.RectPickTool.prototype.destroy=function(){CLOUD.RectOpTool.prototype.destroy.call(this),this.pickHelper.destroy(),this.pickHelper=null,this.viewer=null,this.scene=null,this.pickPoint=null},CLOUD.RectPickTool.prototype.processMouseDown=function(e){if(!CLOUD.EditorConfig.NoKey)return e.preventDefault(),this.activatePick=e.ctrlKey||e.altKey,this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),!0):CLOUD.RectOpTool.prototype.processMouseDown(this,e)},CLOUD.RectPickTool.prototype.processMouseMove=function(e){if(!CLOUD.EditorConfig.NoKey)return this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):CLOUD.RectOpTool.prototype.processMouseMove(this,e)},CLOUD.RectPickTool.prototype.processMouseUp=function(e){if(!CLOUD.EditorConfig.NoKey){if(this.onUpdateUI({visible:!1}),this.activatePick&&e.button===THREE.MOUSE.LEFT){if(this.activatePick=!1,Math.abs(this.startPt.x-e.clientX)<2&&Math.abs(this.startPt.y-e.clientY)<2)return this.pickHelper.click(e,null),!0;if(this.endPt.set(e.clientX,e.clientY),!this.updateFrustum(!0,!1))return this.pickHelper.click(e),!0;var t=CLOUD.OPSELECTIONTYPE.Clear;return e.ctrlKey?t=CLOUD.OPSELECTIONTYPE.Add:e.altKey&&(t=CLOUD.OPSELECTIONTYPE.Remove),CLOUD.PickUtil.pickByRect(this.scene,this.frustum,t,this.viewer,void 0,this.startPt,this.endPt),this.pickHelper.lastPickedUserId="",this.cameraControl.updateView(!0),!0}return CLOUD.RectOpTool.prototype.processMouseUp(this,e)}},CLOUD.RectPickTool.prototype.processHover=function(e){if(this.snapIsEnabled)return!!CLOUD.GlobalData.IsMobile||(this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint,CLOUD.EVENTS.ON_HOVER_SNAP),!0)},CLOUD.RectPickTool.prototype.enableSnap=function(e){this.snapIsEnabled=e},CLOUD.RectZoomTool=function(e){CLOUD.RectOpTool.call(this,CLOUD.EditToolMode.ZOOM_BY_RECT,e.cameraControl,e.modelManager),this.scene=e.getScene(),this.camera=e.camera,this.activateZoom=!1},CLOUD.RectZoomTool.prototype=Object.create(CLOUD.RectOpTool.prototype),CLOUD.RectZoomTool.prototype.constructor=CLOUD.RectZoomTool,CLOUD.RectZoomTool.prototype.destroy=function(){CLOUD.RectOpTool.prototype.destroy.call(this),this.scene=null},CLOUD.RectZoomTool.prototype.processMouseDown=function(e){return e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),this.activateZoom=!0,!0):CLOUD.RectOpTool.prototype.processMouseDown.call(this,e)},CLOUD.RectZoomTool.prototype.processMouseMove=function(e){return this.activateZoom?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):CLOUD.RectOpTool.prototype.processMouseMove.call(this,e)},CLOUD.RectZoomTool.prototype.processMouseUp=function(e){if(this.activateZoom){if(this.activateZoom=!1,this.onUpdateUI({visible:!1}),this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!0,!1)){this.zoomToRectangle()&&!0!==this.camera.isPerspective&&this.orthoCameraZoom()}return!0}return CLOUD.RectOpTool.prototype.processMouseUp.call(this,e)},CLOUD.RectZoomTool.prototype.orthoCameraZoom=function(){var e=this.cameraControl.getContainerDimensions(),t=e.width/e.height,n=Math.abs(this.endPt.x-this.startPt.x),i=Math.abs(this.endPt.y-this.startPt.y),r=n/i,a=1;a=t<r?n/e.width:i/e.height;var o=this.cameraControl.camera;o.orthoScale/=a,this.cameraControl.dirtyCamera(!0),o.setZoom(o.orthoScale),this.cameraControl.setCameraChanging(!0),this.cameraControl.update(!0,!0)},CLOUD.RectZoomTool.prototype.zoomToRectangle=function(){var e=this.cameraControl.camera,t=this.cameraControl.camera.target,n=this.cameraControl.getContainerDimensions(),i=this.startPt.x,r=this.startPt.y,a=this.endPt.x,o=this.endPt.y,s=Math.abs(a-i),l=Math.abs(r-o);if(0!==s&&0!==l){var u=new THREE.Vector2((i+a)/2,(r+o)/2),c=this.cameraControl.getIntersectContext(u),h=this.cameraControl.intersector.hitTest(c);if(!h){var d=this.cameraControl.viewer,f=new CLOUD.RectPickTool(d);f.startPt.set(i,a),f.endPt.set(r,o);var p=CLOUD.PickUtil.pickByRect(this.scene,this.computeFrustum(),CLOUD.OPSELECTIONTYPE.Add,d,!1),m=new THREE.Box3,g=!0,v=!1,y=void 0;try{for(var E,b=p[Symbol.iterator]();!(g=(E=b.next()).done);g=!0){var x=E.value,M=d.getComponentInfoByUserId(x).boundingBox;m.expandByPoint(M.min),m.expandByPoint(M.max)}}catch(e){v=!0,y=e}finally{try{!g&&b.return&&b.return()}finally{if(v)throw y}}if(!1===m.isEmpty()){var _=d.worldToDrawing(m.getCenter());h=new THREE.Vector3(_.x,_.y,_.z)}}if(!h)return!1;var C=e.position.clone(),I=s/l>n.width/n.height?s/n.width:l/n.height,O=h.distanceTo(C),T=O*I,L=t.clone().sub(C),S=L.length();L.normalize();var D=L.clone().negate().multiplyScalar(T);return C=h.clone().add(D),e.position.copy(C),t.copy(C).sub(D.clone().normalize().multiplyScalar(S)),this.cameraControl.updateView(!0),!0}},CLOUD.RectZoomTool.prototype.worldToClient=function(e){var t=this.cameraControl.camera,n=new THREE.Vector3(e.x,e.y,e.z);return n.project(t),n},CLOUD.RectZoomTool.prototype.clientToWorld=function(e){var t=this.cameraControl.getContainerDimensions(),n=this.cameraControl.camera,i=new THREE.Vector3;return i.x=e.x/t.width*2-1,i.y=-e.y/t.height*2+1,i.z=e.z,i.unproject(n),i},CLOUD.MeasureTool=function(e){CLOUD.EditTool.call(this,CLOUD.EditToolMode.PICK_BY_MEASURE),this.editorManager=e.editorManager,this.viewer=e,this.pickHelper=new CLOUD.PickHelper(e.cameraControl),this.mouseDown=new THREE.Vector2,this.lastEvent=null,this.pick=!1,this.pickPoint=new THREE.Vector3},CLOUD.MeasureTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.MeasureTool.prototype.constructor=CLOUD.MeasureTool,CLOUD.MeasureTool.prototype.destroy=function(){CLOUD.EditTool.prototype.destroy.call(this),this.editorManager=null,this.mouseDown=null,this.lastEvent=null,this.pickPoint=null,this.pickHelper.destroy(),this.pickHelper=null},CLOUD.MeasureTool.prototype.processMouseDown=function(e){return!!CLOUD.GlobalData.IsMobile||(e.button===THREE.MOUSE.LEFT?(this.mouseDown.x=e.clientX,this.mouseDown.y=e.clientY,!1):CLOUD.EditTool.prototype.processMouseDown.call(this,e))},CLOUD.MeasureTool.prototype.processMouseMove=function(e){return!1},CLOUD.MeasureTool.prototype.processMouseUp=function(e){if(CLOUD.GlobalData.IsMobile)return!0;if(e.button===THREE.MOUSE.LEFT){if(new THREE.Vector2(e.clientX,e.clientY).distanceTo(this.mouseDown)<=2){this.editorManager.isUpdateRenderList=!0;var t=this.pickPoint.clone();e.shiftKey?this.pickHelper.handleShiftMeasure(e,!0,t):this.pickHelper.handleMouseMeasure(e,!0,t),t.equals(this.pickPoint)||(this.pick=!this.pick,this.pickPoint.copy(t))}return this.dispatchEvent({type:CLOUD.EVENTS.ON_TOOL_END}),!0}return CLOUD.EditTool.prototype.processMouseUp.call(this,e)},CLOUD.MeasureTool.prototype.processHover=function(e){return!!CLOUD.GlobalData.IsMobile||(e.shiftKey?this.pickHelper.handleShiftMeasure(e,!1,this.pickPoint):this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint),!0)},CLOUD.MeasureTool.prototype.processTouchstart=function(e){return this.mouseDown.x=e.touches[0].clientX,this.mouseDown.y=e.touches[0].clientY,e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,this.lastEvent=e,CLOUD.EditTool.prototype.processTouchstart.call(this,e)},CLOUD.MeasureTool.prototype.processTouchmove=function(e){return this.lastEvent=null,CLOUD.EditTool.prototype.processTouchmove.call(this,e)},CLOUD.MeasureTool.prototype.processTouchend=function(e){return null!=this.lastEvent&&(this.pickHelper.handleMouseMeasure(this.lastEvent,!0,this.pickPoint),this.editorManager.isUpdateRenderList=!0),CLOUD.EditTool.prototype.processTouchend.call(this,e)},CLOUD.MeasureTool.prototype.onExit=function(e){var t=this.pickHelper.scene;t.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPICKPLANE)&&t.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPICKPLANE)},CLOUD.MeasureTool.prototype.dispatchEvent=function(e){this.viewer.modelManager.dispatchEvent(e)},CLOUD.Keys={ALT:18,BACKSPACE:8,LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189,ZERO:48,ESC:27,TAB:9},CLOUD.EditorConfig={ReverseWheelDirection:!1,MovementSpeedRate:1,WalkSpeedRate:1,RotatePivotMode:0,NoPan:!1,NoRotate:!1,NoZoom:!1,NoKey:!1,LockAxisZ:!1,LockAxisZRange:null},CLOUD.BaseEditor=function(e,t){this.name=e,this.cameraControl=t,this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.StateType={NONE:-1,ROTATE:0,DOLLY:1,PAN:2},this.state=this.StateType.NONE,this.zoomSpeed=Math.pow(.95,.2),this.defaultMovementSpeed=.005*CLOUD.GlobalData.SceneSize,this.movementSpeed=this.defaultMovementSpeed,this.minMovementSpeed=.001,this.defaultKeyPanSpeed=2,this.keyPanSpeed=this.defaultKeyPanSpeed,this.minKeyPanSpeed=.01,this.wheelZoomFactor=45e-5},CLOUD.BaseEditor.prototype.getName=function(){return this.name},CLOUD.BaseEditor.prototype.destroy=function(){this.scene=null,this.cameraControl=null,this.mouseButtons=null,this.StateType=null},CLOUD.BaseEditor.prototype.onExit=function(){},CLOUD.BaseEditor.prototype.onEnter=function(){},CLOUD.BaseEditor.prototype.processMouseDown=function(e){},CLOUD.BaseEditor.prototype.processMouseMove=function(e){},CLOUD.BaseEditor.prototype.processMouseUp=function(e){},CLOUD.BaseEditor.prototype.processMouseWheel=function(e){},CLOUD.BaseEditor.prototype.processMouseDoubleClick=function(e){},CLOUD.BaseEditor.prototype.processKeyDown=function(e){},CLOUD.BaseEditor.prototype.processKeyUp=function(e){},CLOUD.BaseEditor.prototype.processTouchstart=function(e){},CLOUD.BaseEditor.prototype.processTouchmove=function(e){},CLOUD.BaseEditor.prototype.processTouchend=function(e){},CLOUD.BaseEditor.prototype.processHover=function(e){},CLOUD.BaseEditor.prototype.moveTo=function(e,t,n){},CLOUD.BaseEditor.prototype.rotateTo=function(e){},CLOUD.BaseEditor.prototype.dispatchEvent=function(e){this.cameraControl.viewer.modelManager.dispatchEvent(e)},CLOUD.BaseEditor.prototype.updateButtons=function(e){void 0!==e.ORBIT&&(this.mouseButtons.ORBIT=e.ORBIT),void 0!==e.PAN&&(this.mouseButtons.PAN=e.PAN),void 0!==e.PAN2&&(this.mouseButtons.PAN2=e.PAN2),void 0!==e.ZOOM&&(this.mouseButtons.ZOOM=e.ZOOM)},CLOUD.NormalEditor=function(e,t){CLOUD.BaseEditor.call(this,e,t),this.oldMouseX=-1,this.oldMouseY=-1,this.rotatePivot=null,this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._lastTrackingPoint=null,this.rotateSpeed=1,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this._dollyCenter=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this.modelManager=t.viewer.modelManager,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,this.pickHelper=new CLOUD.PickHelper(t),this.intersectOfMouseDown=null,this.timeId=null,this.longTapFlag=!1,CLOUD.Utils.isMobileDevice()?this.selectPad=new CLOUD.SelectPad(this):this.selectPad=null,this.startPt=new THREE.Vector2;var n=this;this.longTap=function(){n.longTapFlag=!0,CLOUD.Logger.log("long tap"),n.selectPad&&n.selectPad.showOverlay(n.startPt)},this._reqid=0,this._animateBinded=this._animate.bind(this),this._clock=new THREE.Clock,this._moving=!1},CLOUD.NormalEditor.prototype=Object.create(CLOUD.BaseEditor.prototype),CLOUD.NormalEditor.prototype.constructor=CLOUD.NormalEditor,CLOUD.NormalEditor.prototype.destroy=function(){CLOUD.BaseEditor.prototype.destroy.call(this),this.modelManager=null,this.intersectOfMouseDown=null,this.rotatePivot=null,this._rotateStart=null,this._rotateEnd=null,this._rotateDelta=null,this._lastTrackingPoint=null,this._dollyStart=null,this._dollyEnd=null,this._dollyDelta=null,this._dollyCenter=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this._worldDimension=null,this.startPt=null,this._animateBinded=null,this._clock=null,this.timeId&&(clearTimeout(this.timeId),this.timeId=null),this.pickHelper.destroy(),this.pickHelper=null,this.selectPad&&(this.selectPad.destroy(),this.selectPad=null)},CLOUD.NormalEditor.prototype.beginPan=function(e,t){this._panStart.set(e,t),this._worldDimension=this.getWorldDimension(e,t)},CLOUD.NormalEditor.prototype.processMouseDown=function(e){this.oldMouseX=e.clientX,this.oldMouseY=e.clientY;var t=this.cameraControl;this.intersectOfMouseDown=null,e.preventDefault();var n="",i=null;if(e.button===this.mouseButtons.ORBIT){if(CLOUD.EditorConfig.NoRotate)return;this.rotatePivot=t.calculatePivot(CLOUD.EditorConfig.RotatePivotMode,{x:e.clientX,y:e.clientY}),this.state=this.StateType.ROTATE,this._rotateStart.set(e.clientX,e.clientY),i=this._rotateStart,this._lastTrackingPoint=null,n=CLOUD.EditorMode.ORBIT}else if(e.button===this.mouseButtons.ZOOM){if(CLOUD.EditorConfig.NoZoom)return;this.state=this.StateType.DOLLY,this._dollyStart.set(e.clientX,e.clientY),i=this._dollyStart,n=CLOUD.EditorMode.ZOOM}else if(e.button===this.mouseButtons.PAN||e.button===this.mouseButtons.PAN2){if(CLOUD.EditorConfig.NoPan)return;this._panStart.set(e.clientX,e.clientY),i=this._panStart,this._worldDimension=t.getWorldDimension(e.clientX,e.clientY),this.state=this.StateType.PAN,this.intersectOfMouseDown=t.getLastIntersect(),n=CLOUD.EditorMode.PAN}this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_BEGIN,name:n,editor:this.name,startPt:i})},CLOUD.NormalEditor.prototype.processMouseMove=function(e){var t=this.cameraControl;e.preventDefault();var n="";switch(this.state){case this.StateType.ROTATE:if(CLOUD.EditorConfig.NoRotate)return;if(this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),0==this._rotateDelta.x&&0==this._rotateDelta.y)return;this._rotateStart.copy(this._rotateEnd),t.processRotate(this._rotateDelta,this.rotatePivot),n=CLOUD.EVENTS.ON_EDITOR_ROTATING;break;case this.StateType.DOLLY:if(this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),0===this._dollyDelta.x&&0===this._dollyDelta.y)return;var i;i=this._dollyDelta.y>0?this.zoomSpeed:1/this.zoomSpeed,this.cameraControl.adjustCameraForDolly(i,null),this._dollyStart.copy(this._dollyEnd);break;case this.StateType.PAN:if(this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart),0==this._panDelta.x&&0==this._panDelta.y)return;this.cameraControl.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),this.cameraControl.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),n=CLOUD.EVENTS.ON_EDITOR_PANING;break;case this.StateType.NONE:}this.state!==this.StateType.NONE&&this.cameraControl.update(!0),this.dispatchEvent({type:n,editor:this.name})},CLOUD.NormalEditor.prototype.processMouseUp=function(e){if(this.state===this.StateType.NONE)return!1;this.intersectOfMouseDown=null;var t=this.cameraControl;this.oldMouseX===e.clientX&&this.oldMouseY===e.clientY||t.update(!0),this.state=this.StateType.NONE,this.rotatePivot=null,t.endOperation();var n="";return e.button===this.mouseButtons.ORBIT?n=CLOUD.EditorMode.ORBIT:e.button===this.mouseButtons.ZOOM?n=CLOUD.EditorMode.ZOOM:e.button!==this.mouseButtons.PAN&&e.button!==this.mouseButtons.PAN2||(n=CLOUD.EditorMode.PAN),this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:n,editor:this.name}),!0},CLOUD.NormalEditor.prototype.processMouseWheel=function(e){var t=this.cameraControl;if(!CLOUD.EditorConfig.NoZoom){e.preventDefault(),e.stopPropagation();var n=0;e.wheelDelta?n=e.wheelDelta:e.detail&&(n=40*-e.detail),Math.abs(n)>720&&(n=n>0?720:-720),n*=this.wheelZoomFactor,CLOUD.EditorConfig.ReverseWheelDirection&&(n*=-1),!CLOUD.GlobalData.ConstraintZoom||t.cameraWithinMaximumRange()?t.zoom(n,e.clientX,e.clientY):t.resetCameraToMaximumRange(),t.delayHandle(),this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_ZOOM})}},CLOUD.NormalEditor.prototype.processKeyDown=function(e){if(!CLOUD.EditorConfig.NoKey&&!CLOUD.EditorConfig.NoPan){var t,n=this.cameraControl;CLOUD.GlobalData.BatchMergeEnabled?(this.animationStarted||(this.animationStarted=!0,this._start()),t=!1):(t=!0,n.delayHandle()),this._moving=!0;var i=!1,r=this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate,a=this.keyPanSpeed*CLOUD.EditorConfig.MovementSpeedRate;switch(e.keyCode){case CLOUD.Keys.ZERO:this.keyPanSpeed=n.defaultKeyPanSpeed,this.movementSpeed=n.defaultMovementSpeed;break;case CLOUD.Keys.PLUS:this.keyPanSpeed*=1.1,this.movementSpeed*=1.1;break;case CLOUD.Keys.SUB:this.keyPanSpeed*=.9,this.keyPanSpeed<this.minKeyPanSpeed&&(this.keyPanSpeed=this.minKeyPanSpeed),this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case CLOUD.Keys.Q:n.pan(0,a),i=!0;break;case CLOUD.Keys.E:n.pan(0,-a),i=!0;break;case CLOUD.Keys.LEFT:case CLOUD.Keys.A:n.pan(a,0),i=!0;break;case CLOUD.Keys.RIGHT:case CLOUD.Keys.D:n.pan(-a,0),i=!0;break;case CLOUD.Keys.UP:case CLOUD.Keys.W:n.moveStraight(r,!e.shiftKey),i=!0;break;case CLOUD.Keys.DOWN:case CLOUD.Keys.S:n.moveStraight(-r,!e.shiftKey),i=!0}i&&t&&n.update(!0)}},CLOUD.NormalEditor.prototype.processKeyUp=function(e){if(!CLOUD.EditorConfig.NoKey&&!CLOUD.EditorConfig.NoPan)switch(e.keyCode){case CLOUD.Keys.ESC:this.cameraControl.viewer.modelManager.sceneState.clearSelection(),this.pickHelper.lastPickedUserId=void 0,this.cameraControl.updateView(!0)}},CLOUD.NormalEditor.prototype.processTouchstart=function(e){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId);var t=this;switch(t.timeId=setTimeout(t.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return;this.cameraControl.calculatePivot(CLOUD.EditorConfig.RotatePivotMode,{x:e.touches[0].clientX,y:e.touches[0].clientY}),this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE;break;case 2:if(!CLOUD.EditorConfig.NoZoom){var n=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY;this._dollyStart.set(0,Math.sqrt(n*n+i*i))}if(!CLOUD.EditorConfig.NoPan){var r=.5*(e.touches[0].clientX+e.touches[1].clientX),a=.5*(e.touches[0].clientY+e.touches[1].clientY);this._panStart.set(r,a)}break;default:this.state=this.StateType.NONE}},CLOUD.NormalEditor.prototype.processTouchmove=function(e){this.timeId&&clearTimeout(this.timeId);var t=this.cameraControl;switch(e.preventDefault(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateStart,this._rotateEnd);var n=this.cameraControl.getClientSize(),i=2*Math.PI*this._rotateDelta.x/n.x*this.rotateSpeed,r=2*Math.PI*this._rotateDelta.y/n.y*this.rotateSpeed;t.touchUpdateRotation(i,r),this._rotateStart.copy(this._rotateEnd);break;case 2:if(t.clearTouchRotateState(),!CLOUD.EditorConfig.NoZoom){var a=e.touches[0].clientX-e.touches[1].clientX,o=e.touches[0].clientY-e.touches[1].clientY,s=Math.sqrt(a*a+o*o);if(this._dollyEnd.set(0,s),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),Math.abs(this._dollyDelta.y)>3){var l;this._dollyDelta.y>0?l=1/Math.pow(this.zoomSpeed,.5*this._dollyDelta.y):this._dollyDelta.y<0&&(l=Math.pow(this.zoomSpeed,.5*-this._dollyDelta.y)),console.log(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);var u=.5*(e.touches[0].clientX+e.touches[1].clientX),c=.5*(e.touches[0].clientY+e.touches[1].clientY);t.touchDolly(u,c,l),this.state=this.StateType.DOLLY}}if(!CLOUD.EditorConfig.NoPan){var h=.5*(e.touches[0].clientX+e.touches[1].clientX),d=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(h,d),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<3&&Math.abs(this._panDelta.y)<3)return;this._worldDimension=t.getWorldDimension(h,d),t.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),t.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN}}t.touchUpdate()},CLOUD.NormalEditor.prototype.processTouchend=function(e){this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault());var t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}},CLOUD.NormalEditor.prototype.processHover=function(e){this.pickHelper.handleMouseHover(e)},CLOUD.NormalEditor.prototype.moveTo=function(e){if(void 0!==e){var t=this.cameraControl;if(!CLOUD.EditorConfig.NoKey&&!CLOUD.EditorConfig.NoPan){var n=this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate,i=this.keyPanSpeed*CLOUD.EditorConfig.MovementSpeedRate,r=CLOUD.MoveDirection;switch(e){case r.FORWARD:t.moveForward(n,!0);break;case r.BACK:t.moveBackward(n,!0);break;case r.LEFT:t.pan(i,0);break;case r.RIGHT:t.pan(-i,0);break;case r.UP:t.pan(0,i);break;case r.DOWN:t.pan(0,-i);break;default:e=r.NONE}e!==r.NONE&&t.update(!0,!0)}}},CLOUD.NormalEditor.prototype._updateMove=function(){this._moving&&(this._moving=!1,this.cameraControl.update(!0))},CLOUD.NormalEditor.prototype._animate=function(){this._reqid=requestAnimationFrame(this._animateBinded),this._updateMove()},CLOUD.NormalEditor.prototype._start=function(){this._animate()},CLOUD.NormalEditor.prototype._stop=function(){cancelAnimationFrame(this._reqid)},CLOUD.NormalEditor.prototype.onExit=function(){CLOUD.GlobalData.BatchMergeEnabled&&this.animationStarted&&(this._stop(),this.animationStarted=!1)},CLOUD.OrbitEditor=function(e,t){CLOUD.NormalEditor.call(this,t||CLOUD.EditorMode.ORBIT,e),this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT}},CLOUD.OrbitEditor.prototype=Object.create(CLOUD.NormalEditor.prototype),CLOUD.OrbitEditor.prototype.constructor=CLOUD.OrbitEditor,CLOUD.PickEditor=function(e){CLOUD.OrbitEditor.call(this,e,CLOUD.EditorMode.PICK)},CLOUD.PickEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype),CLOUD.PickEditor.prototype.constructor=CLOUD.PickEditor,CLOUD.PickEditor.prototype.processMouseUp=function(e){e.preventDefault(),this.state=this.StateType.NONE;var t=Math.abs(this.oldMouseX-e.clientX)<=1&&Math.abs(this.oldMouseY-e.clientY)<=1;if((e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&t)return this.pickHelper.click(e,this.intersectOfMouseDown),this.cameraControl.update(!0),void(this.intersectOfMouseDown=null);t||e.button!==this.mouseButtons.ORBIT&&e.button!==this.mouseButtons.PAN||this.cameraControl.update(!0),this.intersectOfMouseDown=null;var n="";e.button===this.mouseButtons.ORBIT?n=CLOUD.EditorMode.ORBIT:e.button===this.mouseButtons.ZOOM?n=CLOUD.EditorMode.ZOOM:e.button!==this.mouseButtons.PAN&&e.button!==this.mouseButtons.PAN2||(n=CLOUD.EditorMode.PAN,t||this.dispatchEvent({type:CLOUD.EVENTS.ON_MOUSE_DRAGGED,event:e})),this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:n,editor:this.name})},CLOUD.PickEditor.prototype.processMouseDoubleClick=function(e){e.button===THREE.MOUSE.LEFT&&this.pickHelper.doubleClick(e)},CLOUD.ZoomEditor=function(e){CLOUD.NormalEditor.call(this,CLOUD.EditorMode.ZOOM,e),this.mouseButtons={ZOOM:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT}},CLOUD.ZoomEditor.prototype=Object.create(CLOUD.NormalEditor.prototype),CLOUD.ZoomEditor.prototype.constructor=CLOUD.ZoomEditor,CLOUD.PanEditor=function(e){CLOUD.NormalEditor.call(this,CLOUD.EditorMode.PAN,e),this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT}},CLOUD.PanEditor.prototype=Object.create(CLOUD.NormalEditor.prototype),CLOUD.PanEditor.prototype.constructor=CLOUD.PanEditor,CLOUD.FlyEditor=function(e){CLOUD.BaseEditor.call(this,CLOUD.EditorMode.FLY,e),this.lookSpeed=.001,this.constrainPitch=!0,this.pitchMin=THREE.Math.degToRad(5)-.5*Math.PI,this.pitchMax=.5*Math.PI-this.pitchMin,this.pitchDeltaTotal=0,this.moveState=CLOUD.MoveDirection.NONE,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,this.lastMousePoint=new THREE.Vector2,this.isLockHeight=!1,this.lockedHeight=0,this.pickHelper=new CLOUD.PickHelper(e),this.intersectOfMouseDown=null},CLOUD.FlyEditor.prototype=Object.create(CLOUD.BaseEditor.prototype),CLOUD.FlyEditor.prototype.constructor=CLOUD.FlyEditor,CLOUD.FlyEditor.prototype.destroy=function(){CLOUD.BaseEditor.prototype.destroy.call(this),this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this._worldDimension=null,this.lastMousePoint=null,this.intersectOfMouseDown=null,this.pickHelper.destroy(),this.pickHelper=null},CLOUD.FlyEditor.prototype.processMouseDown=function(e){e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY);var t=this.cameraControl;if(this.intersectOfMouseDown=null,e.button===this.mouseButtons.ORBIT){if(CLOUD.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}else if(e.button===this.mouseButtons.PAN||e.button===this.mouseButtons.PAN2){if(CLOUD.EditorConfig.NoPan)return;this._panStart.set(e.clientX,e.clientY),this._worldDimension=t.getWorldDimension(e.clientX,e.clientY),this.intersectOfMouseDown=t.getLastIntersect(),this.state=this.StateType.PAN,this.isLockHeight&&(this.lockedHeight=e.clientY)}},CLOUD.FlyEditor.prototype.doPan=function(e,t){var n=this.cameraControl;this._panEnd.set(e,this.isLockHeight?this.lockedHeight:t),this._panDelta.subVectors(this._panEnd,this._panStart),0===this._panDelta.x&&0===this._panDelta.y||(n.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),n.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),n.update(!0))},CLOUD.FlyEditor.prototype.processMouseMove=function(e){var t=this.cameraControl;if(e.preventDefault(),this.state===this.StateType.ROTATE){if(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),0!=this.rotateDelta.x||0!=this.rotateDelta.y){var n=this.rotateDelta.x*this.lookSpeed,i=this.rotateDelta.y*this.lookSpeed;t.rotateForFly(n,i,this.pitchMin,this.pitchMax)}}else this.state===this.StateType.PAN&&this.doPan(e.clientX,e.clientY)},CLOUD.FlyEditor.prototype.processMouseUp=function(e){if(e.preventDefault(),e.stopPropagation(),e.button===THREE.MOUSE.LEFT&&this.lastMousePoint.x===e.clientX&&this.lastMousePoint.y===e.clientY)return void this.pickHelper.click(e,this.intersectOfMouseDown);this.intersectOfMouseDown=null;var t=this.cameraControl;switch(this.state){case this.StateType.ROTATE:this.rotateDelta.set(0,0);t.rotateForFly(0,0,this.pitchMin,this.pitchMax),this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:"look",editor:this.name});break;case this.StateType.PAN:this.doPan(e.clientX,e.clientY)}t.endOperation(),this.state=this.StateType.NONE},CLOUD.FlyEditor.prototype.processHover=function(e){this.pickHelper.handleMouseHover(e)},CLOUD.FlyEditor.prototype.processMouseWheel=function(e){e.preventDefault(),e.stopPropagation();var t=this.cameraControl;if(!CLOUD.EditorConfig.NoZoom){var n=e.wheelDelta||e.detail;n=Math.abs(n)>10?n:40*-n,n*=5e-4,CLOUD.EditorConfig.ReverseWheelDirection&&(n*=-1),this.cameraControl.delayHandle();var i=t.getContainerDimensions(),r=i.left+.5*i.width,a=i.top+.5*i.height;t.zoom(n,r,a)}},CLOUD.FlyEditor.prototype.processKeyDown=function(e){if(!CLOUD.EditorConfig.NoKey&&!e.altKey){var t=CLOUD.MoveDirection,n=t.NONE;switch(e.keyCode){case CLOUD.Keys.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case CLOUD.Keys.PLUS:this.movementSpeed*=1.1;break;case CLOUD.Keys.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case CLOUD.Keys.UP:case CLOUD.Keys.W:n=t.FORWARD;break;case CLOUD.Keys.DOWN:case CLOUD.Keys.S:n=t.BACK;break;case CLOUD.Keys.LEFT:case CLOUD.Keys.A:n=t.LEFT;break;case CLOUD.Keys.RIGHT:case CLOUD.Keys.D:n=t.RIGHT;break;case CLOUD.Keys.Q:n=t.UP;break;case CLOUD.Keys.E:n=t.DOWN}n!==t.NONE&&(this.moveState|=n,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYDOWN,event:e,state:n,direction:t,editor:this.name}),this.cameraControl.delayHandle(),this.cameraControl.updateFlyMove(this.moveState,this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate))}},CLOUD.FlyEditor.prototype.processKeyUp=function(e){if(!CLOUD.EditorConfig.NoKey){var t=CLOUD.MoveDirection,n=t.NONE;switch(e.keyCode){case CLOUD.Keys.UP:case CLOUD.Keys.W:n=t.FORWARD;break;case CLOUD.Keys.DOWN:case CLOUD.Keys.S:n=t.BACK;break;case CLOUD.Keys.LEFT:case CLOUD.Keys.A:n=t.LEFT;break;case CLOUD.Keys.RIGHT:case CLOUD.Keys.D:n=t.RIGHT;break;case CLOUD.Keys.Q:n=t.UP;break;case CLOUD.Keys.E:n=t.DOWN}n!==t.NONE&&(this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYUP,event:e,state:n,direction:t,editor:this.name}),this.moveState&=~n)}},CLOUD.FlyEditor.prototype.moveTo=function(e){this.cameraControl.updateFlyMove(e,this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate)},CLOUD.WalkEditor=function(e){CLOUD.BaseEditor.call(this,CLOUD.EditorMode.WALK,e),this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.pickHelper=new CLOUD.PickHelper(e),this.lastMousePoint=new THREE.Vector2,this._reqid=0,this._animateBinded=this._animate.bind(this),this._clock=new THREE.Clock,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.startPt=new THREE.Vector2,this.timeId=null,this.rotateSpeed=1,this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this._dollyCenter=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,CLOUD.Utils.isMobileDevice()?this.selectPad=new CLOUD.SelectPad(this):this.selectPad=null,this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0),this.zoomDelta=0,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this.firstRotate=!0,this.dragLook=!0,this.lockHeightEnabled=!1,this.isLockHeight=!1,this.lockedHeight=0,this.pickEnabled=!0,this.defaultMovementSpeed=750,this.movementSpeed=this.defaultMovementSpeed},
CLOUD.WalkEditor.prototype=Object.create(CLOUD.BaseEditor.prototype),CLOUD.WalkEditor.prototype.constructor=CLOUD.WalkEditor,CLOUD.WalkEditor.prototype.destroy=function(){CLOUD.BaseEditor.prototype.destroy.call(this),this.pickHelper.destroy(),this.pickHelper=null,this.selectPad&&(this.selectPad.destroy(),this.selectPad=null),this.timeId&&(clearTimeout(this.timeId),this.timeId=null),this._clock=null,this._animateBinded=null,this.mouseButtons=null,this.moveState=null,this.startPt=null,this.lastMousePoint=null,this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this._rotateStart=null,this._rotateEnd=null,this._rotateDelta=null,this._dollyStart=null,this._dollyEnd=null,this._dollyDelta=null,this._dollyCenter=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this.moveVector=null,this.rotationVector=null,this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null},CLOUD.WalkEditor.prototype._animate=function(){this._reqid=requestAnimationFrame(this._animateBinded),this.updateWalkMove()},CLOUD.WalkEditor.prototype._start=function(){this._animate()},CLOUD.WalkEditor.prototype._stop=function(){cancelAnimationFrame(this._reqid)},CLOUD.WalkEditor.prototype._updateMovement=function(){this.moveVector.x=-this.moveState.left+this.moveState.right,this.isLockHeight?this.moveVector.y=0:this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-this.moveState.forward+this.moveState.back},CLOUD.WalkEditor.prototype._updateRotation=function(){CLOUD.EditorConfig.LockAxisZ?this.rotationVector.x=0:this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},CLOUD.WalkEditor.prototype._doRotate=function(e){var t=this.cameraControl.getContainerDimensions(),n=t.width/2,i=t.height/2;this.moveState.yawLeft=-e.x/n,this.moveState.pitchDown=e.y/i,this._updateRotation()},CLOUD.WalkEditor.prototype.processMouseDown=function(e){if(e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY),this.firstRotate=!1,e.button===this.mouseButtons.ORBIT){if(CLOUD.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}},CLOUD.WalkEditor.prototype.processMouseUp=function(e){return e.preventDefault(),e.stopPropagation(),this.pickEnabled&&(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&Math.abs(this.lastMousePoint.x-e.clientX)<2&&Math.abs(this.lastMousePoint.y-e.clientY)<2?(this.state=this.StateType.NONE,void this.pickHelper.click(e)):(this.state===this.StateType.ROTATE&&(this.moveState.yawLeft=this.moveState.pitchDown=0,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:"look",editor:this.name})),this.state=this.StateType.NONE,!0)},CLOUD.WalkEditor.prototype.processMouseMove=function(e){e.preventDefault(),this.dragLook&&this.state===this.StateType.ROTATE&&(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))},CLOUD.WalkEditor.prototype.processTouchstart=function(e){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId);var t=this;switch(t.timeId=setTimeout(t.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE,console.log(this._rotateStart);break;case 2:if(!CLOUD.EditorConfig.NoPan){var n=.5*(e.touches[0].clientX+e.touches[1].clientX),i=.5*(e.touches[0].clientY+e.touches[1].clientY);this._panStart.set(n,i)}break;default:this.state=this.StateType.NONE}},CLOUD.WalkEditor.prototype.processTouchmove=function(e){this.timeId&&clearTimeout(this.timeId);var t=this.cameraControl;switch(e.preventDefault(),e.touches.length){case 1:this.dragLook&&this.state===this.StateType.ROTATE&&(this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateStart.copy(this._rotateEnd),this._doRotate(this._rotateDelta));break;case 2:if(t.clearTouchRotateState(),!CLOUD.EditorConfig.NoPan){var n=.5*(e.touches[0].clientX+e.touches[1].clientX),i=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(n,i),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<3&&Math.abs(this._panDelta.y)<3)return;this._worldDimension=t.getWorldDimension(n,i),t.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),t.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN}}t.touchUpdate()},CLOUD.WalkEditor.prototype.processTouchend=function(e){this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault());var t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}},CLOUD.WalkEditor.prototype.processHover=function(e){e.preventDefault(),this.dragLook||(this.firstRotate&&(this.firstRotate=!1,this.rotateStart.set(e.clientX,e.clientY)),this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))},CLOUD.WalkEditor.prototype.processKeyDown=function(e){if(!CLOUD.EditorConfig.NoKey&&!e.altKey){var t=CLOUD.MoveDirection.NONE,n=CLOUD.Keys;switch(e.keyCode){case n.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case n.PLUS:this.movementSpeed*=1.1;break;case n.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case n.UP:case n.W:t=CLOUD.MoveDirection.FORWARD,this.moveState.forward=1;break;case n.DOWN:case n.S:t=CLOUD.MoveDirection.BACK,this.moveState.back=1;break;case n.LEFT:case n.A:t=CLOUD.MoveDirection.LEFT,this.moveState.left=1;break;case n.RIGHT:case n.D:t=CLOUD.MoveDirection.RIGHT,this.moveState.right=1;break;case n.Q:t=CLOUD.MoveDirection.UP,this.moveState.up=1;break;case n.E:t=CLOUD.MoveDirection.DOWN,this.moveState.down=1;break;case n.TAB:return this.moveVector.set(0,0,0),this.moveState.forward=0,this.moveState.back=0,this.moveState.left=0,this.moveState.right=0,this.moveState.up=0,void(this.moveState.down=0);default:return}this._updateMovement(),this._updateRotation(),t!==CLOUD.MoveDirection.NONE&&this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYDOWN,event:e,direction:t,editor:this.name})}},CLOUD.WalkEditor.prototype.processKeyUp=function(e){if(!CLOUD.EditorConfig.NoKey){var t=CLOUD.MoveDirection.NONE,n=CLOUD.Keys;switch(e.keyCode){case n.UP:case n.W:t=CLOUD.MoveDirection.FORWARD,this.moveState.forward=0;break;case n.DOWN:case n.S:t=CLOUD.MoveDirection.BACK,this.moveState.back=0;break;case n.LEFT:case n.A:t=CLOUD.MoveDirection.LEFT,this.moveState.left=0;break;case n.RIGHT:case n.D:t=CLOUD.MoveDirection.RIGHT,this.moveState.right=0;break;case n.Q:t=CLOUD.MoveDirection.UP,this.moveState.up=0;break;case n.E:t=CLOUD.MoveDirection.DOWN,this.moveState.down=0;break;default:return}this._updateMovement(),this._updateRotation(),t!==CLOUD.MoveDirection.NONE&&this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYUP,event:e,direction:t,editor:this.name})}},CLOUD.WalkEditor.prototype.updateWalkMove=function(){var e=this._clock.getDelta(),t=this.cameraControl,n=t.camera.position.y;if(0!==this.moveVector.x||0!==this.moveVector.y||0!==this.moveVector.z||0!==this.rotationVector.x||0!==this.rotationVector.y||0!==this.rotationVector.z||0!==this.zoomDelta||0!==t.gravity){var i=this.movementSpeed*CLOUD.EditorConfig.WalkSpeedRate*e;if(1==CLOUD.GlobalData.WalkingWithGravity&&(this.moveVector.y=0,t.computeManHeight(),t.computeGravity()),t.dirtyCamera(!0),0!==this.zoomDelta){var r=1+this.zoomDelta*e;t.zoomCameraForWalk(r),this.zoomDelta=0}t.translateCameraForWalk(this.moveVector,i),this.dragLook?t.rotateCameraForWalk(this.rotationVector,1):t.rotateCameraForWalk(this.rotationVector,2),t.flyOnWorld(!1);var a=t.viewer.modelManager;n!==t.camera.position.y&&a.dispatchEvent({type:CLOUD.EVENTS.ON_CAMERA_HEIGHT_CHANGED,cameraPosition:t.camera.position.clone()}),a.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_WALKING})}},CLOUD.WalkEditor.prototype.onEnter=function(){var e=this.cameraControl.scene,t=this.cameraControl.getCamera();t.isPerspective||(console.log("Current camera is Orthographic"),t.toPerspective()),e.getBoundingBox().containsPoint(t.position)&&t.position.y!=t.target.y&&function(e){var t=e.target.clone().sub(e.position),n=t.length(),i=t.clone();i.y=0,i.normalize(),i.multiplyScalar(n),e.target.addVectors(e.position,i)}(t),this._start()},CLOUD.WalkEditor.prototype.onExit=function(){this._stop()},CLOUD.WalkEditor.prototype.rotateTo=function(e){this._doRotate(e)},CLOUD.WalkEditor.prototype.moveTo=function(e,t,n){if(void 0===n&&(n=!0),void 0===t&&(t=1),n)switch(e){case CLOUD.MoveDirection.FORWARD:this.moveState.forward=t;break;case CLOUD.MoveDirection.BACK:this.moveState.back=t;break;case CLOUD.MoveDirection.LEFT:this.moveState.left=t;break;case CLOUD.MoveDirection.RIGHT:this.moveState.right=t;break;case CLOUD.MoveDirection.UP:this.moveState.up=t;break;case CLOUD.MoveDirection.DOWN:this.moveState.down=t}else switch(e){case CLOUD.MoveDirection.FORWARD:this.moveState.forward=0;break;case CLOUD.MoveDirection.BACK:this.moveState.back=0;break;case CLOUD.MoveDirection.LEFT:this.moveState.left=0;break;case CLOUD.MoveDirection.RIGHT:this.moveState.right=0;break;case CLOUD.MoveDirection.UP:this.moveState.up=0;break;case CLOUD.MoveDirection.DOWN:this.moveState.down=0}this._updateMovement()},CLOUD.WalkEditor.prototype.setHeightLocked=function(e){this.lockHeightEnabled&&this.isLockHeight!==e&&(this.isLockHeight=e)},CLOUD.WalkEditor.prototype.setDragLook=function(e){this.dragLook!==e&&(this.firstRotate=!0,this.dragLook=e)},CLOUD.EditorManager=function(){function e(e){r(),o=!0,s.isUpdateRenderList=!1,s.editor.processMouseDown(e)}function t(e){o?(s.isUpdateRenderList=!1,s.cameraChange=!0,s.editor.processMouseMove(e)):s.editor.processHover(e)}function n(e){s.isUpdateRenderList=!0,o&&(s.editor.processMouseUp(e),o=!1)}function i(i){if(!s.enabled)return void(s.cameraChange=!1);for(var r=s.tools,a=r.length-1;a>=0;a--)if(r[a].onEvent(i)){switch(i.type){case"mouseup":o=!1}return}switch(i.type){case"touchmove":s.editor.processTouchmove(i);break;case"touchstart":s.editor.processTouchstart(i);break;case"touchend":s.editor.processTouchend(i);case"keydown":s.editor.processKeyDown(i);break;case"keyup":s.editor.processKeyUp(i);break;case"mousewheel":case"DOMMouseScroll":s.cameraChange=!0,s.editor.processMouseWheel(i);break;case"mousedown":e(i);break;case"mousemove":t(i);break;case"mouseup":n(i);break;case"dblclick":s.editor.processMouseDoubleClick(i)}}function r(){if(s.domElement){var e=s.domElement.querySelector("#cloud-main-canvas");e&&e.focus&&e.focus()}}function a(e){e.preventDefault()}this.editor=null,this.editors={},this.tools=[],this.domElement=null,this.enabled=!0,this.isUpdateRenderList=!0;var o=!1,s=this;this.registerDomEventListeners=function(e){this.domElement=e,e.addEventListener("touchstart",i,!1),e.addEventListener("touchend",i,!1),e.addEventListener("touchmove",i,!1),e.addEventListener("contextmenu",a,!1),e.addEventListener("mousedown",i,!1),e.addEventListener("mousewheel",i,!1),e.addEventListener("DOMMouseScroll",i,!1),e.addEventListener("dblclick",i,!1),window.addEventListener("mousemove",i,!1),window.addEventListener("mouseup",i,!1),e.addEventListener("keydown",i,!1),e.addEventListener("keyup",i,!1),r()},this.unregisterDomEventListeners=function(e){e.removeEventListener("touchstart",i,!1),e.removeEventListener("touchend",i,!1),e.removeEventListener("touchmove",i,!1),e.removeEventListener("contextmenu",a,!1),e.removeEventListener("mousedown",i,!1),e.removeEventListener("mousewheel",i,!1),e.removeEventListener("DOMMouseScroll",i,!1),e.removeEventListener("dblclick",i,!1),window.removeEventListener("mousemove",i,!1),window.removeEventListener("mouseup",i,!1),e.removeEventListener("keydown",i,!1),e.removeEventListener("keyup",i,!1)}},CLOUD.EditorManager.prototype={constructor:CLOUD.EditorManager,destroy:function(){for(var e in this.editors){this.editors[e].destroy()}this.editors=null,this.editor=null;for(var t=0,n=this.tools.length;t<n;t++)this.tools[t].destroy();this.tools=null,this.unregisterDomEventListeners(this.domElement),this.domElement=null},getCurrentEditorName:function(){return this.editor?this.editor.name:""},_getEditorByName:function(e,t){var n=this.editors[t];if(n)return n;var i=CLOUD.EditorMode;this.viewer=e;var r=e.cameraControl;e.getScene(),e.domElement;switch(t){case i.ORBIT:n=new CLOUD.OrbitEditor(r);break;case i.PICK:n=new CLOUD.PickEditor(r);break;case i.PAN:n=new CLOUD.PanEditor(r);break;case i.ZOOM:n=new CLOUD.ZoomEditor(r);break;case i.FLY:n=new CLOUD.FlyEditor(r);break;case i.WALK:n=new CLOUD.WalkEditor(r);break;default:n=null,console.error("invalid editor name")}return n&&(n.name=t,this.editors[t]=n),n},getCurrentEditor:function(){return this.editor},setEditorMode:function(e,t){var n=this._getEditorByName(e,t);n&&this.editor!==n&&(null!==this.editor&&(this.editor.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_EXIST,name:this.editor.getName()}),this.editor.onExit()),this.editor=n,this.editor.onEnter(),this.editor.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_ENTER,name:this.editor.getName()}))},getToolByName:function(e){for(var t=this.tools.length,n=0;n<t;++n)if(this.tools[n].name==e)return this.tools[n]},enableTool:function(e,t){for(var n=CLOUD.EditToolMode,i=this.tools,r=0,a=i.length;r<a;r++)if(i[r].name==t)return;var o=null;switch(t){case n.PICK_BY_RECT:o=new CLOUD.RectPickTool(e);break;case n.ZOOM_BY_RECT:o=new CLOUD.RectZoomTool(e);break;case n.CLIP_BY_BOX:o=new CLOUD.ClipPlanesTool(e);break;case n.CLIP_FILL:o=new CLOUD.FillClipPlaneTool(e);break;case n.PICK_BY_MEASURE:o=new CLOUD.MeasureTool(e)}o&&i.push(o)},disableTool:function(e){for(var t=this.tools,n=0,i=t.length;n<i;n++)if(t[n].name==e){t[n].onExit(),t.splice(n,1);break}},setInteractiveState:function(e){this.enabled=e}},CLOUD.SelectPad=function(e){this.editor=e,this.cameraControl=e.cameraControl,this.dim=this.cameraControl.getContainerDimensions(),this.pad=null,this.padSize=96,this.startPt=new THREE.Vector2,this.position=new THREE.Vector2,this.callback=null,this.intersect=null,this.destroy=function(){this.editor=null,this.cameraControl=null,this.dim=null,this.pad=null,this.startPt=null,this.position=null,this.callback=null,this.intersect=null},this.init=function(){window.addEventListener("resize",this.padInitBind,!1),this.pad=document.createElement("div"),this.padInit(),this.cameraControl.domElement.appendChild(this.pad),this.addEventListener()},this.addEventListener=function(){this.pad.addEventListener("touchstart",this.padOnTouchStartBind,!1),this.pad.addEventListener("touchmove",this.padOnTouchMoveBind,!1),this.pad.addEventListener("touchend",this.padOnTouchEndBind,!1)},this.padInit=function(){null!=this.pad&&(this.pad.style.backgroundImage="url(images/selectPad.png)",this.pad.style.backgroundSize="100%",this.pad.style.position="absolute",this.pad.style.width=this.padSize.toString()+"px",this.pad.style.height=this.padSize.toString()+"px",this.pad.style.zIndex="10",this.pad.style.display="none")},this.showOverlay=function(e){this.position=e,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.pad.style.display=""},this.hideOverlay=function(){this.pad.style.display="none"},this.pick=function(){var e=this.position.x,t=this.position.y,n=this.cameraControl,i=(this.editor.pickHelper,n.viewer.modelManager.sceneState),r=this,a=new THREE.Vector2(e,t),o=n.getIntersectContext(a);n.intersector.pick(o,function(e){if(i.clearSelection(),!e)return n.updateView(!0),void(r.intersect=null);var t=e.userId;n.viewer.getScene().intersectToWorld(e,n.viewer),i.addSelection([t]),r.intersect=e,n.updateView(!0)}),null!=r.intersect&&(r.intersect.cx=e,r.intersect.cy=t)},this.onTouchStart=function(e){1===e.touches.length&&(e.stopPropagation(),e.preventDefault(),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY))},this.onTouchMove=function(e){if(1===e.touches.length){e.stopPropagation(),e.preventDefault();var t=e.touches[0].clientX-this.startPt.x,n=e.touches[0].clientY-this.startPt.y;this.position.x+=t,this.position.y+=n,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.pick(e)}},this.onTouchEnd=function(e){e.stopPropagation(),null!=this.callback?this.callback(this.intersect):console.log("selectPad click",this.intersect)},this.padInitBind=this.padInit.bind(this),this.padOnTouchStartBind=this.onTouchStart.bind(this),this.padOnTouchEndBind=this.onTouchEnd.bind(this),this.padOnTouchMoveBind=this.onTouchMove.bind(this),this.init()},function(){function e(e,t,n){return t<=e&&e<=n}function t(e){if(void 0===e)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function n(e){for(var t=String(e),n=t.length,i=0,r=[];i<n;){var a=t.charCodeAt(i);if(a<55296||a>57343)r.push(a);else if(56320<=a&&a<=57343)r.push(65533);else if(55296<=a&&a<=56319)if(i===n-1)r.push(65533);else{var o=e.charCodeAt(i+1);if(56320<=o&&o<=57343){var s=1023&a,l=1023&o;r.push(65536+(s<<10)+l),i+=1}else r.push(65533)}i+=1}return r}function i(e){for(var t="",n=0;n<e.length;++n){var i=e[n];i<=65535?t+=String.fromCharCode(i):(i-=65536,t+=String.fromCharCode(55296+(i>>10),56320+(1023&i)))}return t}function r(e){this.tokens=[].slice.call(e)}function a(e,t){if(e)throw TypeError("Decoder error");return t||65533}function o(e,n){if(!(this instanceof o))return new o(e,n);if((e=void 0!==e?String(e).toLowerCase():f)!==f)throw new Error("Encoding not supported. Only utf-8 is supported");n=t(n),this._streaming=!1,this._BOMseen=!1,this._decoder=null,this._fatal=Boolean(n.fatal),this._ignoreBOM=Boolean(n.ignoreBOM),Object.defineProperty(this,"encoding",{value:"utf-8"}),Object.defineProperty(this,"fatal",{value:this._fatal}),Object.defineProperty(this,"ignoreBOM",{value:this._ignoreBOM})}function s(e,n){if(!(this instanceof s))return new s(e,n);if((e=void 0!==e?String(e).toLowerCase():f)!==f)throw new Error("Encoding not supported. Only utf-8 is supported");n=t(n),this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(n.fatal)},Object.defineProperty(this,"encoding",{value:"utf-8"})}function l(t){var n=t.fatal,i=0,r=0,o=0,s=128,l=191;this.handler=function(t,u){if(u===h&&0!==o)return o=0,a(n);if(u===h)return d;if(0===o){if(e(u,0,127))return u;if(e(u,194,223))o=1,i=u-192;else if(e(u,224,239))224===u&&(s=160),237===u&&(l=159),o=2,i=u-224;else{if(!e(u,240,244))return a(n);240===u&&(s=144),244===u&&(l=143),o=3,i=u-240}return i<<=6*o,null}if(!e(u,s,l))return i=o=r=0,s=128,l=191,t.prepend(u),a(n);if(s=128,l=191,r+=1,i+=u-128<<6*(o-r),r!==o)return null;var c=i;return i=o=r=0,c}}function u(t){t.fatal;this.handler=function(t,n){if(n===h)return d;if(e(n,0,127))return n;var i,r;e(n,128,2047)?(i=1,r=192):e(n,2048,65535)?(i=2,r=224):e(n,65536,1114111)&&(i=3,r=240);for(var a=[(n>>6*i)+r];i>0;){var o=n>>6*(i-1);a.push(128|63&o),i-=1}return a}}function c(){if("undefined"!=typeof self)return self;if("undefined"!=typeof global)return global;throw new Error("No global found")}var h=-1;r.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.shift():h},prepend:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.unshift(t.pop());else this.tokens.unshift(e)},push:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.push(t.shift());else this.tokens.push(e)}};var d=-1,f="utf-8";o.prototype={decode:function(e,n){var a;a="object"===(void 0===e?"undefined":_typeof(e))&&e instanceof ArrayBuffer?new Uint8Array(e):"object"===(void 0===e?"undefined":_typeof(e))&&"buffer"in e&&e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0),n=t(n),this._streaming||(this._decoder=new l({fatal:this._fatal}),this._BOMseen=!1),this._streaming=Boolean(n.stream);for(var o,s=new r(a),u=[];!s.endOfStream()&&(o=this._decoder.handler(s,s.read()))!==d;)null!==o&&(Array.isArray(o)?u.push.apply(u,o):u.push(o));if(!this._streaming){do{if((o=this._decoder.handler(s,s.read()))===d)break;null!==o&&(Array.isArray(o)?u.push.apply(u,o):u.push(o))}while(!s.endOfStream());this._decoder=null}return u.length&&(-1===["utf-8"].indexOf(this.encoding)||this._ignoreBOM||this._BOMseen||(65279===u[0]?(this._BOMseen=!0,u.shift()):this._BOMseen=!0)),i(u)}},s.prototype={encode:function(e,i){e=e?String(e):"",i=t(i),this._streaming||(this._encoder=new u(this._options)),this._streaming=Boolean(i.stream);for(var a,o=[],s=new r(n(e));!s.endOfStream()&&(a=this._encoder.handler(s,s.read()))!==d;)Array.isArray(a)?o.push.apply(o,a):o.push(a);if(!this._streaming){for(;;){if((a=this._encoder.handler(s,s.read()))===d)break;Array.isArray(a)?o.push.apply(o,a):o.push(a)}this._encoder=null}return new Uint8Array(o)}},"function"!=typeof TextDecoder&&(c().TextDecoder=o),"function"!=typeof TextEncoder&&(c().TextEncoder=s)}();var PntsParser=function(){function e(){_classCallCheck(this,e),this.utf8Decoder=new TextDecoder("utf-8")}return _createClass(e,[{key:"parse",value:function(e){if(!e)return Promise.reject(e);var t=new DataView(e),n=0,i={},r={},a={};if(i.magic=this.utf8Decoder.decode(new Uint8Array(e,n,4)),n+=4,i.magic){if(i.version=t.getUint32(n,!0),n+=Uint32Array.BYTES_PER_ELEMENT,i.byteLength=t.getUint32(n,!0),n+=Uint32Array.BYTES_PER_ELEMENT,i.FTJSONLength=t.getUint32(n,!0),n+=Uint32Array.BYTES_PER_ELEMENT,i.FTBinaryLength=t.getUint32(n,!0),n+=Uint32Array.BYTES_PER_ELEMENT,i.BTJSONLength=t.getUint32(n,!0),n+=Uint32Array.BYTES_PER_ELEMENT,i.BTBinaryLength=t.getUint32(n,!0),n+=Uint32Array.BYTES_PER_ELEMENT,i.FTBinaryLength>0&&(a=this.parseFeatureBinary(e,n,i.FTJSONLength)),i.BTJSONLength>0){var o=28+i.FTJSONLength+i.FTBinaryLength;r=BatchTableParser.parse(e.slice(o,i.BTJSONLength+o))}var s={point:a,batchTable:r};return Promise.resolve(s)}throw new Error("Invalid pnts file.")}},{key:"parseFeatureBinary",value:function(e,t,n){var i=new THREE.BufferGeometry,r=this.utf8Decoder.decode(new Uint8Array(e,t,n)),a=JSON.parse(r),o=void 0;if(a.POINTS_LENGTH&&(o=a.POINTS_LENGTH),a.POSITION){var s=a.POSITION.byteOffset+r.length+t,l=new Float32Array(e,s,3*o);i.addAttribute("position",new THREE.BufferAttribute(l,3))}if(a.RGB){var u=a.RGB.byteOffset+r.length+t,c=new Uint8Array(e,u,3*o);i.addAttribute("color",new THREE.BufferAttribute(c,3,!0))}if(a.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(a.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(a.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(a.NORMAL){var h=a.RGB.byteOffset+r.length+t,d=new Float32Array(e,h,3*o);i.addAttribute("normal",new THREE.BufferAttribute(d,3))}if(a.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(a.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:i,offset:a.RTC_CENTER?(new THREE.Vector3).fromArray(a.RTC_CENTER):void 0}}}]),e}();CLOUD.PntsParser=PntsParser;var ExtendTileset=function(){function e(t,n){_classCallCheck(this,e),this.tileset=t,this.baseURL=n,this.counter=1,this.index={},this.inverseTileTransform=new THREE.Matrix4,this.recurse(t.root,n)}return _createClass(e,[{key:"recurse",value:function(e,t,n){if(e.transform=e.transform?(new THREE.Matrix4).fromArray(e.transform):void 0,e._worldFromLocalTransform=e.transform,n&&n._worldFromLocalTransform&&(e.transform?e._worldFromLocalTransform=(new THREE.Matrix4).multiplyMatrices(n._worldFromLocalTransform,e.transform):e._worldFromLocalTransform=n._worldFromLocalTransform),(e.viewerRequestVolume&&e.viewerRequestVolume.region||e.boundingVolume.region)&&(e._worldFromLocalTransform?this.inverseTileTransform.getInverse(e._worldFromLocalTransform):this.inverseTileTransform.identity()),e.viewerRequestVolume=e.viewerRequestVolume?this.getBox(e.viewerRequestVolume,this.inverseTileTransform):void 0,e.boundingVolume=this.getBox(e.boundingVolume,this.inverseTileTransform),this.index[this.counter]=e,e.tileId=this.counter,e.baseURL=t,e.points=void 0,e.b3dm=void 0,this.counter++,e.children){var i=!0,r=!1,a=void 0;try{for(var o,s=e.children[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;this.recurse(l,t,e)}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}}}},{key:"getBox",value:function(e,t){if(e.region){var n=e.region;extent.set(THREE.Math.radToDeg(n[0]),THREE.Math.radToDeg(n[2]),THREE.Math.radToDeg(n[1]),THREE.Math.radToDeg(n[3]));var i=(new OBB).setFromExtent(extent);return i.matrix.premultiply(t),i.matrix.decompose(i.position,i.quaternion,i.scale),{region:i}}if(e.box){var r=e.box,a=new THREE.Vector3(r[0],r[1],r[2]),o=a.x-r[3],s=a.x+r[3],l=a.y-r[7],u=a.y+r[7],c=a.z-r[11],h=a.z+r[11];return{box:new THREE.Box3(new THREE.Vector3(o,l,c),new THREE.Vector3(s,u,h))}}if(e.sphere){return{sphere:new THREE.Sphere(new THREE.Vector3(e.sphere[0],e.sphere[1],e.sphere[2]),e.sphere[3])}}}}]),e}();CLOUD.ExtendTileset=ExtendTileset;var PntLoader=function(){function e(t,n){_classCallCheck(this,e),this.unitScale=n,this.pntParser=new PntsParser,this.utf8Decoder=new TextDecoder("utf-8"),this.tileIndexMap={},this.rootPntUrl=void 0,this.sseThreshold=void 0===t?5:t,this.loadPromises=[],this.camera=void 0,this.globalInverseMatrix=new THREE.Matrix4,this.box=null,this.loadJsonPromises=[],this.pntFileList={}}return _createClass(e,[{key:"loadPntTotalJson",value:function(e,t){var n=this;return n.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1),new Promise(function(i,r){(new THREE.FileLoader).load(e,function(e){var r=JSON.parse(e);n.box=r.root.boundingVolume.box,t&&t(n.box),n.parseTilesJson(r.root);var a=Promise.all(n.loadJsonPromises.map(function(e){return e.catch(function(e){return e})})),o=new CLOUD.TaskManager;a.then(function(e){var t=0;for(var r in n.tileIndexMap){var a=n.tileIndexMap[r],s=r.slice(0,r.lastIndexOf("/")+1);for(var l in a.index){var u=s+a.index[l].content.url;o.addTask(t),n.pntFileList[t]={},n.pntFileList[t].jsonUrl=r,n.pntFileList[t].pntUrl=u,n.pntFileList[t].index=l,t++}}o.processTasks(n.loadPnt.bind(n),void 0,function(e){var t={};for(var r in n.pntFileList){var a=n.pntFileList[r].jsonUrl;if(!(a in t)){var o=new CLOUD.ObjectGroup(CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0});t[a]=o}n.tileIndexMap[a].index[n.pntFileList[r].index].points=n.pntFileList[r].result,t[a].add(n.pntFileList[r].result)}var s=[];for(var a in t)s.push(t[a]);i(s)})})})})}},{key:"parseTilesJson",value:function(e){var t=this;if(e.content&&e.content.url){var n=this.rootPntUrl+e.content.url;t.loadTileSetJson(n)}if(e.children){var i=!0,r=!1,a=void 0;try{for(var o,s=e.children[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;this.parseTilesJson(l)}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}}}},{key:"loadTileSetJson",value:function(e){var t=this,n=new Promise(function(n,i){var r=new THREE.FileLoader;r.setResponseType("json"),r.load(e,function(r){if(null===r||void 0===r)i(r);else{var a=new ExtendTileset(r,"");t.tileIndexMap[e]=a;a.index[1],e.slice(0,e.lastIndexOf("/")+1);n(a)}},void 0,function(t){i(data),console.error("Load "+e+" failed, "+t)})});return t.loadJsonPromises.push(n),n}},{key:"ProcessTileIndexs",value:function(e,t){this.camera=e,this.globalInverseMatrix=t;for(var n in this.tileIndexMap){var i=this.tileIndexMap[n],r=i.index[1];this.ProcessNode(r,n)}}},{key:"ProcessNode",value:function(e,t,n){e.visible=!1;var i=this.tileIndexMap[t].index[e.tileId].points;if(void 0!=i){i.visible=!1;if(this.$3dTilesSubdivisionControl(this.camera,e)&&(i.visible=!0,e.visible=!0),void 0!=n)if("ADD"===n.refine.toUpperCase());else{n.visible=!1;var r=this.tileIndexMap[t].index[n.tileId];r.visible=!1}if(e.children){var a=!0,o=!1,s=void 0;try{for(var l,u=e.children[Symbol.iterator]();!(a=(l=u.next()).done);a=!0){var c=l.value;this.ProcessNode(c,t,e)}}catch(e){o=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(o)throw s}}}}}},{key:"$3dTilesSubdivisionControl",value:function(e,t){return this.computeNodeSSE(e,t)>this.sseThreshold}},{key:"computeNodeSSE",value:function(e,t){var n=new THREE.Box3,i=new THREE.Sphere,r=e.position.clone();if(r.multiplyScalar(1/this.unitScale),r.applyMatrix4(this.globalInverseMatrix),t.distance=0,t.boundingVolume.region)n.copy(t.boundingVolume.region.box3D),n.applyMatrix4(t.boundingVolume.region.matrixWorld),t.distance=n.distanceToPoint(r);else if(t.boundingVolume.box)n.copy(t.boundingVolume.box),t.matrixWorld&&n.applyMatrix4(t.matrixWorld),t.distance=n.distanceToPoint(r);else{if(!t.boundingVolume.sphere)return 1/0;i.copy(t.boundingVolume.sphere),i.applyMatrix4(t.matrixWorld),t.distance=Math.max(0,i.distanceToPoint(r))}return 0===t.distance?1/0:(t.geometricError-0<1e-4&&(t.geometricError=1),e._preSSE*(t.geometricError/t.distance))}},{key:"updatePreSse",value:function(e,t){var n=e.fov,i=THREE.Math.degToRad(n),r=t/(2*Math.tan(.5*i));e._preSSE=r}},{key:"loadPnt",value:function(e,t){var n=this,i=n.pntFileList[e].pntUrl;return new Promise(function(r,a){var o=new THREE.FileLoader;o.setResponseType("arraybuffer"),o.load(i,function(r){if(void 0!==r){var a=n.utf8Decoder.decode(new Uint8Array(r,0,4));if("{"===a[0]){r=JSON.parse(n.utf8Decoder.decode(new Uint8Array(r)));i.slice(0,i.lastIndexOf("/")+1)}else if("b3dm"==a)console.log("b3dm is load");else{if("pnts"!=a)return Promise.reject("Unsupported magic code "+a);console.log("pnts is load")}n.pntParser.parse(r).then(function(r){var a=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),o=new THREE.Points(r.point.geometry,a);r.point.offset&&o.position.copy(r.point.offset),o.visible=!1,o.name=i,n.pntFileList[e].result=o,t()})}},void 0,function(e){a(void 0)})})}},{key:"loadPntByPromise",value:function(e){var t=this;return new Promise(function(n,i){var r=new THREE.FileLoader;r.setResponseType("arraybuffer"),r.load(e,function(i){if(void 0!==i){var r=t.utf8Decoder.decode(new Uint8Array(i,0,4));if("{"===r[0]){i=JSON.parse(t.utf8Decoder.decode(new Uint8Array(i)));e.slice(0,e.lastIndexOf("/")+1)}else if("b3dm"==r)console.log("b3dm is load");else{if("pnts"!=r)return Promise.reject("Unsupported magic code "+r);console.log("pnts is load")}t.pntParser.parse(i).then(function(t){var i=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),r=new THREE.Points(t.point.geometry,i);t.point.offset&&r.position.copy(t.point.offset),r.visible=!1,r.name=e,n(r)})}},void 0,function(e){i(void 0)})})}},{key:"loadPntTotalJsonByPromise",value:function(e,t){var n=this;return n.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1),new Promise(function(i,r){(new THREE.FileLoader).load(e,function(e){var r=JSON.parse(e);n.box=r.root.boundingVolume.box,t&&t(n.box),n.parseTilesJson(r.root),Promise.all(n.loadJsonPromises.map(function(e){return e.catch(function(e){return e})})).then(function(e){var t=[];for(var r in n.tileIndexMap)!function(e){n.urlPointGroupMap[e]={};var i=n.tileIndexMap[e],r=e.slice(0,e.lastIndexOf("/")+1);for(var a in i.index)!function(a){var o=r+i.index[a].content.url;t.push(n.loadPnt(o).then(function(t){return{url:e,context:{index:a,result:t}}}))}(a)}(r);Promise.all(t.map(function(e){return e.catch(function(e){return e})})).then(function(e){for(var t in n.urlPointGroupMap){
var r=new CLOUD.ObjectGroup(CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0});n.urlPointGroupMap[t]=r}var a=!0,o=!1,s=void 0;try{for(var l,u=e[Symbol.iterator]();!(a=(l=u.next()).done);a=!0){var c=l.value;void 0!==c&&(n.tileIndexMap[c.url].index[c.context.index].points=c.context.result,n.urlPointGroupMap[c.url].add(c.context.result))}}catch(e){o=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(o)throw s}}var h=[];for(var d in n.urlPointGroupMap)h.push(n.urlPointGroupMap[d]);i(h)})}).catch(function(e){console.log("promise reject failed reason",e)})})})}}]),e}();CLOUD.PntLoader=PntLoader,CLOUD.Version="1.0.0.20200210",CLOUD.GlobalData={SceneSize:1e3,TextureResRoot:"images/",EnableTextureMapping:!1,EnableTextureLoading:!0,MaxTexturePixels:25e4,EnableLightmap:!1,LightmapIntensity:1,ClippingCaps:!1,SelectionColor:{color:1170103,side:THREE.DoubleSide},DisableAntialias:!1,EnableDemolishByDClick:!1,IsMobile:!1,WorkersRoot:"../libs/",EnableWorker:!1,ZipResourcePostfix:".gz",JsonResourcePostfix:".json",HasLayerData:!1,Instance:!0,DataProvider:0,Renderer:0,MaxMemeorySizeToFullRender:1500,BatchMergeEnabled:!1,SegmentedBatchMergeEnable:!1,maxIndicesNumberPerBathSegment:65535,IncrementRender:!0,LimitFrameTime:250,maxObjectNumInPool:6e4,maxDrawCacheNum:4e4,OctantDepth:15,MaximumDepth:0,ConcurrencyRequestCount:8,ShowOctant:!1,EnableOctant:!0,EnableRenderPass:!1,LightPreset:3,IBL:!1,ToneMapping:1,LightIntensityFactor:1.5,Hover:!0,OcclusionTranslucentEnabled:!1,OcclusionOpacity:.5,OcclusionDistanceToCamera:1e3,LineSelectRange:30,DrawingStyle:0,DrawingBoardlineEnabled:!0,DrawingBoardlineLimit:!0,DrawingBoardlineLimitThreshold:2e5,CanUseWireframeFromData:!0,BorderLineBatched:!1,BorderLineDelayLoaded:!1,InitWireframeData:!1,SSAO:!1,MeasureHighlightPlane:!1,WalkingWithGravity:!1,EnableHitDetection:!1,TranslucentDepthDisabled:!1,SharedMeshInstanceEnable:!1,LoadMpkOnDemand:!1,EnableLoadOnDemand:!0,EnableSelectionOutline:!1,EnableDisposeBufferAfterVbo:!0,OrganizeNodesByCameraView:!1,CanUseCompressedTexture:!1,CanUseSmallTexture:!0,DEBUG:!1,EnableExplosion:!1,EnableLogarithmicDepthBuffer:!1,ConstraintZoom:!1,PickingEffect:!0,PickingLineWidthEnabled:!1,EnableGisMap:!1,TerrainScale:1,TerrainResourceFileName:"terrain.bin",TilePlaneGroupName:"TilePlaneGroup",TileGlobalGroupName:"TileGlobalGroup",TdTileGroupName:"3dTilesGroup",BimTilesGroupName:"TilePlaneGroup",DracoLibUrl:void 0,DynamicScheduling:!1,EnableSplitComponent:!1},CLOUD.EnumStandardView={ISO:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44},CLOUD.CAMERATYPE={ORTHOGRAPHIC:0,PERSPECTIVE:1},CLOUD.OPSELECTIONTYPE={Clear:0,Add:1,Remove:2},CLOUD.PICKABLETYPE={Geometry:1,Marker3d:2,Room:3,ExternalComponent:4,Axis:5,Map:6,UnPickable:0},CLOUD.LOADERROREVENTS={LOAD_ERROR:1e3,LOAD_SCENE_ERROR:1001,LOAD_MATERIAL_ERROR:1002,LOAD_SYMBOL_ERROR:1003,LOAD_OCTREEINNER_ERROR:1004,LOAD_OCTREEOUTER_ERROR:1005,LOAD_USERID_ERROR:1006,LOAD_USERDATA_ERROR:1007,LOAD_CAMERA_ERROR:1008,LOAD_TEXTURE_ERROR:1009,LOAD_MPK_ERROR:1010,LOAD_IBLCONFIG_ERROR:1011},CLOUD.EnumRenderType={RENDER:0,RENDER_FINISHED:1,RESIZE:2},CLOUD.PrimitiveCount={vertexCount:0,triangleCount:0},CLOUD.RotatePivotMode={MOUSEPOINT:0,SELECTION:1,CENTER:2,CAMERA:3},CLOUD.EditorMode={ORBIT:"orbit",PICK:"pick",PAN:"pan",ZOOM:"zoom",FLY:"fly",WALK:"walk"},CLOUD.EditToolMode={PICK_BY_RECT:"pickByRect",ZOOM_BY_RECT:"zoomByRect",CLIP_BY_BOX:"clipByBox",CLIP_FILL:"fillClip",PICK_BY_MEASURE:"pickByMeasure",EDIT_CONTROL:"editControl"},CLOUD.MoveDirection={NONE:0,UP:1,DOWN:2,LEFT:4,RIGHT:8,FORWARD:16,BACK:32},CLOUD.DrawingStyle={SHADING:0,BOARDLINE:1,SHADINGWITHLINE:2},CLOUD.EnumInstanceState={HIDDEN:-1,NONE:0,HOVER:1,SELECTED:2,OVERRIDED:3,TRANSPARENT:4,BLINK:5},CLOUD.EnumDataProvider={AUTO:0,DEFAULT:1,MERGED:2,LAYER:3,LAYER_SCENE:4},CLOUD.EnumRendererType={AUTO:0,FULL:1,INCREMENT:2},CLOUD.EnumShaderColorState={NONE:0,BLINK:1,SELECT:2},CLOUD.EnumCesiumImageryLayerType={AUTO:0,BAIDU:1,GAODE:2,MAPBOX:3,ARCGIS:4,GOOGLE:5},CLOUD.FILLPATTERN={fullFill:[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],noFill:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],horizontalLine:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255],verticalLine:[128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128],rightDiagonalLine:[1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,0,0,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,0,0,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128],leftDiagonalLine:[0,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,0,0,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,0],orthogonalCrossLine:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255],skewCrossLine:[65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128],halftone:[136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34],doubleCross:[65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255]},function(e){function t(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function n(e,t){return e<<t|e>>>32-t}function i(e,i,r,a,o,s){return t(n(t(t(i,e),t(a,s)),o),r)}function r(e,t,n,r,a,o,s){return i(t&n|~t&r,e,t,a,o,s)}function a(e,t,n,r,a,o,s){return i(t&r|n&~r,e,t,a,o,s)}function o(e,t,n,r,a,o,s){return i(t^n^r,e,t,a,o,s)}function s(e,t,n,r,a,o,s){return i(n^(t|~r),e,t,a,o,s)}function l(e,n){e[n>>5]|=128<<n%32,e[14+(n+64>>>9<<4)]=n;var i,l,u,c,h,d=1732584193,f=-271733879,p=-1732584194,m=271733878;for(i=0;i<e.length;i+=16)l=d,u=f,c=p,h=m,d=r(d,f,p,m,e[i],7,-680876936),m=r(m,d,f,p,e[i+1],12,-389564586),p=r(p,m,d,f,e[i+2],17,606105819),f=r(f,p,m,d,e[i+3],22,-1044525330),d=r(d,f,p,m,e[i+4],7,-176418897),m=r(m,d,f,p,e[i+5],12,1200080426),p=r(p,m,d,f,e[i+6],17,-1473231341),f=r(f,p,m,d,e[i+7],22,-45705983),d=r(d,f,p,m,e[i+8],7,1770035416),m=r(m,d,f,p,e[i+9],12,-1958414417),p=r(p,m,d,f,e[i+10],17,-42063),f=r(f,p,m,d,e[i+11],22,-1990404162),d=r(d,f,p,m,e[i+12],7,1804603682),m=r(m,d,f,p,e[i+13],12,-40341101),p=r(p,m,d,f,e[i+14],17,-1502002290),f=r(f,p,m,d,e[i+15],22,1236535329),d=a(d,f,p,m,e[i+1],5,-165796510),m=a(m,d,f,p,e[i+6],9,-1069501632),p=a(p,m,d,f,e[i+11],14,643717713),f=a(f,p,m,d,e[i],20,-373897302),d=a(d,f,p,m,e[i+5],5,-701558691),m=a(m,d,f,p,e[i+10],9,38016083),p=a(p,m,d,f,e[i+15],14,-660478335),f=a(f,p,m,d,e[i+4],20,-405537848),d=a(d,f,p,m,e[i+9],5,568446438),m=a(m,d,f,p,e[i+14],9,-1019803690),p=a(p,m,d,f,e[i+3],14,-187363961),f=a(f,p,m,d,e[i+8],20,1163531501),d=a(d,f,p,m,e[i+13],5,-1444681467),m=a(m,d,f,p,e[i+2],9,-51403784),p=a(p,m,d,f,e[i+7],14,1735328473),f=a(f,p,m,d,e[i+12],20,-1926607734),d=o(d,f,p,m,e[i+5],4,-378558),m=o(m,d,f,p,e[i+8],11,-2022574463),p=o(p,m,d,f,e[i+11],16,1839030562),f=o(f,p,m,d,e[i+14],23,-35309556),d=o(d,f,p,m,e[i+1],4,-1530992060),m=o(m,d,f,p,e[i+4],11,1272893353),p=o(p,m,d,f,e[i+7],16,-155497632),f=o(f,p,m,d,e[i+10],23,-1094730640),d=o(d,f,p,m,e[i+13],4,681279174),m=o(m,d,f,p,e[i],11,-358537222),p=o(p,m,d,f,e[i+3],16,-722521979),f=o(f,p,m,d,e[i+6],23,76029189),d=o(d,f,p,m,e[i+9],4,-640364487),m=o(m,d,f,p,e[i+12],11,-421815835),p=o(p,m,d,f,e[i+15],16,530742520),f=o(f,p,m,d,e[i+2],23,-995338651),d=s(d,f,p,m,e[i],6,-198630844),m=s(m,d,f,p,e[i+7],10,1126891415),p=s(p,m,d,f,e[i+14],15,-1416354905),f=s(f,p,m,d,e[i+5],21,-57434055),d=s(d,f,p,m,e[i+12],6,1700485571),m=s(m,d,f,p,e[i+3],10,-1894986606),p=s(p,m,d,f,e[i+10],15,-1051523),f=s(f,p,m,d,e[i+1],21,-2054922799),d=s(d,f,p,m,e[i+8],6,1873313359),m=s(m,d,f,p,e[i+15],10,-30611744),p=s(p,m,d,f,e[i+6],15,-1560198380),f=s(f,p,m,d,e[i+13],21,1309151649),d=s(d,f,p,m,e[i+4],6,-145523070),m=s(m,d,f,p,e[i+11],10,-1120210379),p=s(p,m,d,f,e[i+2],15,718787259),f=s(f,p,m,d,e[i+9],21,-343485551),d=t(d,l),f=t(f,u),p=t(p,c),m=t(m,h);return[d,f,p,m]}function u(e){var t,n="",i=32*e.length;for(t=0;t<i;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function c(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function h(e){return u(l(c(e),8*e.length))}function d(e,t){var n,i,r=c(e),a=[],o=[];for(a[15]=o[15]=void 0,r.length>16&&(r=l(r,8*e.length)),n=0;n<16;n+=1)a[n]=909522486^r[n],o[n]=1549556828^r[n];return i=l(a.concat(c(t)),512+8*t.length),u(l(o.concat(i),640))}function f(e){var t,n,i="0123456789abcdef",r="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),r+=i.charAt(t>>>4&15)+i.charAt(15&t);return r}function p(e){return unescape(encodeURIComponent(e))}function m(e){return h(p(e))}function g(e){return f(m(e))}function v(e,t){return d(p(e),p(t))}function y(e,t){return f(v(e,t))}function E(e,t,n){return t?n?v(t,e):y(t,e):n?m(e):g(e)}CLOUD.md5=E}(),CLOUD.Utils={TemporaryMatrix:new THREE.Matrix4,MinusEpsilon:-1e-6,isDefined:function(e){return void 0!==e&&null!==e},isDesktop:function(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),n=/(?:SymbianOS)/.test(e)||t,i=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=(/(?:Chrome|CriOS)/.test(e),/(?:iPad|PlayBook)/.test(e)||i&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e));return!(/(?:iPhone)/.test(e)&&!a||i||n||a)},supportWorker:function(){return"undefined"!=typeof Worker||(console.log("Sorry! Web Worker is not supported."),!1)},box3FromArray:function(e,t){if(e instanceof Array){var n=t||new THREE.Box3;return n.min.fromArray(e,0),n.max.fromArray(e,3),n}return null},box3FromArrayRange:function(e,t,n){for(var i=new THREE.Box3,r=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,u=-1/0,c=t,h=n;c<h;c+=3){var d=e[c],f=e[c+1],p=e[c+2];d<r&&(r=d),f<a&&(a=f),p<o&&(o=p),d>s&&(s=d),f>l&&(l=f),p>u&&(u=p)}return i.min.set(r,a,o),i.max.set(s,l,u),i},computeBBox:function(e){for(var t=new THREE.Box3,n=new THREE.Vector3,i=0,r=e.length;i<r;++i)n.fromArray(e[i],0),t.expandByPoint(n);return t},mergeBBox:function(e){if(e.length<1)return null;for(var t=new THREE.Box3,n=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Box3,a=0,o=e.length;a<o;a++)n.set(e[a].max.x,e[a].max.y,e[a].max.z),i.set(e[a].min.x,e[a].min.y,e[a].min.z),r.set(i,n),t.union(r);return t},parseTransform:function(e,t,n){var i=!1;if(t.rotation&&(e.rotation.fromArray(t.rotation),i=!0),t.position&&(e.position.fromArray(t.position),i=!0),t.scale&&(e.scale.fromArray(t.scale),i=!0),t.quaternion&&(e.quaternion.fromArray(t.quaternion),i=!0),i&&e.updateMatrix(),t.matrix&&e.matrix.fromArray(t.matrix),n){var r=e.matrix.clone();r.multiplyMatrices(n,e.matrix),e.matrix=r}e.matrixAutoUpdate=!1,void 0!==e.boundingBox&&(e.boundingBox=CLOUD.Utils.box3FromArray(t.bbox))},isMobileDevice:function(){var e=navigator.platform;return 0!==e.indexOf("Win")&&0!==e.indexOf("Mac")},findRange:function(e,t){if(t<Math.min.apply(null,e))return 0;if(t>Math.max.apply(null,e))return e.length-1;for(var n=0,i=0,r=e.length;i<r;++i)if(e[i]>t){n=i-1;break}return n},stringToByte:function(e){var t,n,i=new Array;t=e.length;for(var r=0;r<t;r++)n=e.charCodeAt(r),n>=65536&&n<=1114111?(i.push(n>>18&7|240),i.push(n>>12&63|128),i.push(n>>6&63|128),i.push(63&n|128)):n>=2048&&n<=65535?(i.push(n>>12&15|224),i.push(n>>6&63|128),i.push(63&n|128)):n>=128&&n<=2047?(i.push(n>>6&31|192),i.push(63&n|128)):i.push(255&n);return i},byteToString:function(e){if("string"==typeof e)return e;for(var t="",n=e,i=0;i<n.length;i++){var r=n[i].toString(2),a=r.match(/^1+?(?=0)/);if(a&&8==r.length){for(var o=a[0].length,s=n[i].toString(2).slice(7-o),l=1;l<o;l++)s+=n[l+i].toString(2).slice(2);t+=String.fromCharCode(parseInt(s,2)),i+=o-1}else t+=String.fromCharCode(n[i])}return t},strToBinary:function(e){for(var t=[],n=e.split(""),i=0;i<n.length;i++){0!=i&&t.push(" ");var r=n[i],a=r.charCodeAt().toString(2);t.push(a)}return t.join("")},binaryToStr:function(e){for(var t=[],n=e.split(" "),i=0;i<n.length;i++){var r=n[i],a=parseInt(r,2),o=String.fromCharCode(a);t.push(o)}return t.join("")},byteArr2Int:function(e){return(255&e[0])<<24|(255&e[1])<<16|(255&e[2])<<8|(255&e[3])<<0},int2ByteArr:function(e){var t=[];return t[0]=e>>24,t[1]=e>>16,t[2]=e>>8,t[3]=e>>0,t},checkVersionMatch:function(e,t){var n=e.split(".");if(n.length>1){var i=parseInt(n[0]),r=parseInt(n[1]),a=t.toLowerCase();if((a=parseFloat(a))<.04&&0===i&&r<7)return!0;if(a>=.04&&(i>0||0===i&&r>=7))return!0}return!1},isMirror:function(e){var t=new THREE.Vector3(e[0],e[1],e[2]),n=new THREE.Vector3(e[4],e[5],e[6]),i=new THREE.Vector3(e[8],e[9],e[10]);return(new THREE.Vector3).crossVectors(t,n).dot(i)<0},isEmptyObject:function(e){if(!e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},isEmptyObjectSimple:function(e){for(var t in e)return!1;return!0},isOwnEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},hexStrToRgb:function(e){var t=e.replace("#",""),n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return n?{r:parseInt(n[1],16)/255,g:parseInt(n[2],16)/255,b:parseInt(n[3],16)/255}:null},hexToRgb:function(e){var t={};return t.r=(e>>16&255)/255,t.g=(e>>8&255)/255,t.b=(255&e)/255,t},getMin:function(e){for(var t=e.length,n=1/0;t--;)n=e[t]<n?e[t]:n;return n},getMax:function(e){for(var t=e.length,n=-1/0;t--;)n=e[t]>n?e[t]:n;return n},freezeObject:function(e){return Object.freeze?Object.freeze(e):e},getEncodedId:function(e){return CLOUD.md5&&"function"==typeof CLOUD.md5?CLOUD.md5(e):e},arrayToMap:function(e,t){t=t||{};for(var n=0,i=e.length;n<i;n++)t[e[n]]=!0;return t},getDifferentialIdxs:function(e,t){var n,i={},r={},a={};if(t)if(this.isEmptyObject(e))r=t;else{for(n in t)e[n]&&(a[n]=!0);if(this.isEmptyObject(a))i=e,r=t;else{for(n in t)a[n]||(r[n]=!0);for(n in e)a[n]||(i[n]=!0)}}else this.isEmptyObject(e)||(i=e);return{objCurrUsedIdxs:e,addIdxs:Object.keys(i),removeIdxs:Object.keys(r)}},getCombinedKeyString:function(e,t){return t=t||"&",e.join(t)},splitCombinedKeyString:function(e,t){return t=t||"&",e.split(t)},isGroupObject:function(e){return!(!e.children||!e.children.length)},isMeshObject:function(e){return!!(e.isMesh||e.isLine||e.isPoints)},extendObject:function(e,t,n){if(n)for(var i in t)"object"===_typeof(t[i])?CLOUD.Utils.extendObject(e[i],t[i],!0):e[i]=t[i];else for(var i in t)null!==e[i]&&void 0!==e[i]?"object"===_typeof(t[i])&&CLOUD.Utils.extendObject(e[i],t[i],!1):e[i]=t[i];return e},computeExplodeTranslation:function(e,t,n){var i=t.getCenter(),r=e.distanceTo(i),a=n*r,o=new THREE.Vector3;return o.subVectors(i,e),o.normalize(),o.multiplyScalar(a),o},minDistanceBetweenTriToMesh:function(e,t,n,i){function r(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function a(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function o(e,t,n){return new THREE.Vector3(e.x+t.x*n,e.y+t.y*n,e.z+t.z*n)}function s(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function l(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function u(e,t,n,i){var u,c,h=s(t,i),d=s(t,t),f=s(i,i),p=r(n,e),m=s(t,p),g=s(i,p);u=(m*f-g*h)/(d*f-h*h),u<0||isNaN(u)?u=0:u>1&&(u=1),c=(u*h-g)/f;var v,y,E,b;return c<=0||isNaN(c)?(y=n,u=m/d,u<=0||isNaN(u)?(v=e,E=r(n,e)):u>=1?(v=a(e,t),E=r(n,v)):(v=o(e,t,u),b=l(p,t),E=l(t,b))):c>=1?(y=a(n,i),u=(h+m)/d,u<=0||isNaN(u)?(v=e,E=r(y,e)):u>=1?(v=a(e,t),E=r(y,v)):(v=o(e,t,u),p=r(y,e),b=l(p,t),E=l(t,b))):(y=o(n,i,c),u<=0||isNaN(u)?(v=e,b=l(p,i),E=l(i,b)):u>=1?(v=a(e,t),p=r(n,v),b=l(p,i),E=l(i,b)):(v=o(e,t,u),E=l(t,i),s(E,p)<0&&E.multiplyScalar(-1))),{vec:E,closestP:v,closestQ:y}}for(var c,h,d,f,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},y=t.geometry,E=y.attributes.position,b=n?n.indexStart:0,x=y.getIndex().array,M=n?n.indexStart+n.indexCount:x.length,_=b,f=M;_<f;_+=3){c=x[_],h=x[_+1],d=x[_+2];var C=[];!function(e,t,n,i,r,a){p.fromBufferAttribute(t,n),m.fromBufferAttribute(t,i),g.fromBufferAttribute(t,r),a&&(p.applyMatrix4(a),m.applyMatrix4(a),g.applyMatrix4(a)),e.push(p),e.push(m),e.push(g)}(C,E,c,h,d,i);var I=function(e,t){var n,i,a,c=[],h=[];c[0]=r(e[1],e[0]),c[1]=r(e[2],e[1]),c[2]=r(e[0],e[2]),h[0]=r(t[1],t[0]),h[1]=r(t[2],t[1]),h[2]=r(t[0],t[2]);for(var d,f,p,m,g=0,v=e[0].distanceToSquared(t[0])+1,y=0;y<3;y++)for(var E=0;E<3;E++){var b=u(e[y],c[y],t[E],h[E]);a=b.vec,n=b.closestP,i=b.closestQ,d=r(i,n);var x=s(d,d);if(x<=v){p=n.clone(),m=i.clone(),v=x,f=r(e[(y+2)%3],n);var M=s(f,a);f=r(t[(E+2)%3],i);var _=s(f,a);if(M<=0&&_>=0)return{start:n.clone(),end:i.clone(),minDistance:Math.sqrt(x)};var C=s(d,a);M<0&&(M=0),_>0&&(_=0),C-M+_>0&&(g=1)}}var I=l(c[0],c[1]),O=s(I,I);if(O>1e-15){var T=[];d=r(e[0],t[0]),T[0]=s(d,I),d=r(e[0],t[1]),T[1]=s(d,I),d=r(e[0],t[2]),T[2]=s(d,I);var L=-1;if(T[0]>0&&T[1]>0&&T[2]>0?(L=T[0]<T[1]?0:1,T[2]<T[L]&&(L=2)):T[0]<0&&T[1]<0&&T[2]<0&&(L=T[0]>T[1]?0:1,T[2]>T[L]&&(L=2)),L>=0&&(g=1,d=r(t[L],e[0]),f=l(I,c[0]),s(d,f)>0&&(d=r(t[L],e[1]),f=l(I,c[1]),s(d,f)>0&&(d=r(t[L],e[2]),f=l(I,c[2]),s(d,f)>0))))return n=o(t[L],I,T[L]/O),i=t[L].clone(),{start:n.clone(),end:i,minDistance:n.distanceTo(i)}}var S=l(h[0],h[1]),D=s(S,S);if(D>1e-15){var w=[];d=r(t[0],e[0]),w[0]=s(d,S),d=r(t[0],e[1]),w[1]=s(d,S),d=r(t[0],e[2]),w[2]=s(d,S);var L=-1;if(w[0]>0&&w[1]>0&&w[2]>0?(L=w[0]<w[1]?0:1,w[2]<w[L]&&(L=2)):w[0]<0&&w[1]<0&&w[2]<0&&(L=w[0]>w[1]?0:1,w[2]>w[L]&&(L=2)),L>=0&&(g=1,d=r(e[L],t[0]),f=l(S,h[0]),s(d,f)>0&&(d=r(e[L],t[1]),f=l(S,h[1]),s(d,f)>0&&(d=r(e[L],t[2]),f=l(S,h[2]),s(d,f)>0))))return n=e[L].clone(),i=o(e[L],S,w[L]/D),{start:n,end:i.clone(),minDistance:n.distanceTo(i)}}return g?(n=p,i=m,{start:p.clone(),end:m.clone(),minDistance:Math.sqrt(v)}):{start:p.clone(),end:m.clone(),minDistance:0}}(e,C);if(I.minDistance<=0)return v.minDistance=0,v;v.minDistance>I.minDistance&&(v.minDistance=I.minDistance,v.start=I.start.clone(),v.end=I.end.clone())}return v},asyncProcess:function(e,t,n,i,r){function a(o){var s=o;return function(){var o,l;for(l=s+n>t?t:s+n,o=s;o<l;o++){var u=o;i&&i(e,u),o===l-1&&(l!==t?requestAnimationFrame(a(o+1)):r&&r(e))}}}requestAnimationFrame(a(0))},hasSimilarProperty:function(e,t){if(!(e instanceof Object&&t instanceof Object))return!1;for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0},equalsWithEpsilon:function(e,t){var n=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y),r=Math.abs(e.z-t.z);return n<=1e-7&&i<=1e-7&&r<=1e-7},arrayMax:function(e){if(0===e.length)return-1/0;for(var t=e[0],n=1,i=e.length;n<i;++n)e[n]>t&&(t=e[n]);return t},arrayMin:function(e){if(0===e.length)return 1/0;for(var t=e[0],n=1,i=e.length;n<i;++n)e[n]<t&&(t=e[n]);return t},ab2str:function(e){return(new TextDecoder).decode(new Uint8Array(e))},str2ab:function(e){return(new TextEncoder).encode(e).buffer},getEncodedString:function(e){return CLOUD.md5&&"function"==typeof CLOUD.md5?CLOUD.md5(e):e}},CLOUD.Compatibility={convertAnnotationsToV3:function(e,t){function n(e,t,n){var i;i="string"==typeof e?JSON.parse(window.atob(e)):{position:{x:e.position.x,y:e.position.y,z:e.position.z},target:{x:e.target.x,y:e.target.y,z:e.target.z},up:{x:e.up.x,y:e.up.y,z:e.up.z}};var r=new THREE.Vector3(i.position.x,i.position.y,i.position.z),a=new THREE.Vector3(i.target.x,i.target.y,i.target.z),o=new THREE.Vector3(i.up.x,i.up.y,i.up.z),s=new CLOUD.CameraInfo("persp",r,a,o);return s=CLOUD.Camera.drawingToWorld(s,t),s=new CLOUD.CameraInfo("persp",s.position,s.target,s.up),s=CLOUD.Camera.worldToDrawing(s,n),i.position.x=s.position.x,i.position.y=s.position.y,i.position.z=s.position.z,i.target.x=s.target.x,i.target.y=s.target.y,i.target.z=s.target.z,i.up.x=s.up.x,i.up.y=s.up.y,i.up.z=s.up.z,"string"==typeof e&&(i=window.btoa(JSON.stringify(i))),i}var i=JSON.parse(t);if(i.filter){var r=JSON.parse(i.filter);if(r.filter||r.basicIds){var a=e.getScene(),o=a.getTransformMatrixGlobal();(new THREE.Matrix4).getInverse(o);var s=a.getMatrixGlobal();(new THREE.Matrix4).getInverse(s);var l=e.getFilter().getFilterType(),u={};u.state={},r.filter?(r.fileFilter&&(u.state[l.FILE_HIDDEN]=r.fileFilter),r.selectionSet&&(u.state[l.SELECTED]=r.selectionSet),r.filter.visibleIds&&(u.state[l.VISIBLE]=r.filter.visibleIds),r.filter.invisibleIds&&(u.state[l.HIDDEN]=r.filter.invisibleIds),r.filter.conditions&&(u.state[l.CONDITION_HIDDEN_OTHERS]=r.filter.conditions),r.filter.filters&&(u.state[l.USER_HIDDEN]=r.filter.filters),r.frozenSet&&(u.state[l.FROZENFILTER]=r.frozenSet),r.isolateSet&&(u.state[l.ISOLATE_HIDDEN_OTHERS]=r.isolateSet),r.overriderByIds&&(u.state[l.OVERRIDEFILTER]=r.overriderByIds),r.overriderByData&&(u.state[l.USER_OVERRIDE]=r.overriderByData),r.overriderCondition&&(u.state[l.CONDITION_OVERRIDE]=r.overriderCondition),r.isolateCondition&&(u.state[l.ISOLATE_CONDITION_HIDDEN_OTHERS]=r.isolateCondition),u.state.sceneState=r.overriderByScene):r.basicIds&&(r.basicIds[1]&&(u.state[l.FILE_HIDDEN]=r.basicIds[1]),r.basicIds[2]&&(u.state[l.SELECTED]=r.basicIds[2]),r.basicIds[3]&&(u.state[l.VISIBLE]=r.basicIds[3]),r.basicIds[4]&&(u.state[l.HIDDEN]=r.basicIds[4]),r.conditions[0]&&(u.state[l.CONDITION_HIDDEN_OTHERS]=r.conditions[0]),r.userHiddenIds&&(u.state[l.USER_HIDDEN]=r.userHiddenIds),r.frozenIds&&(u.state[l.FROZENFILTER]=r.frozenIds),r.isolateIds&&(u.state[l.ISOLATE_HIDDEN_OTHERS]=r.isolateIds),r.overrideByIds&&(u.state[l.OVERRIDEFILTER]=r.overrideByIds),r.overrideByData&&(u.state[l.USER_OVERRIDE]=r.overrideByData),r.conditions[2]&&(u.state[l.CONDITION_OVERRIDE]=r.conditions[2]),r.isolateConditions&&(r.isolateConditions[0]&&(u.state[l.ISOLATE_CONDITION_HIDDEN]=r.isolateConditions[0]),r.isolateConditions[1]&&(u.state[l.ISOLATE_CONDITION_HIDDEN_OTHERS]=r.isolateConditions[1]),r.isolateConditions[2]&&(u.state[l.ISOLATE_CONDITION_TRANSLUCENT]=r.isolateConditions[2]),r.isolateConditions[3]&&(u.state[l.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.isolateConditions[3])),u.state.sceneState=r.sceneState),r.camera?u.camera=n(r.camera,o,s):u.camera=n(i.camera,o,s),r=u,i.filter=JSON.stringify(r)}}return i},isLoadLinesEnabled:function(e){return!(parseFloat(e)<=.12)},isLoadBMpkEnabled:function(e){return!(parseFloat(e)<.13)},isLoadLayerSceneEnabled:function(e){return!(parseFloat(e)<.15)},isUse32MpkData:function(e){return!(parseFloat(e)<.15)},use32MpkData:!1,isUseMergeTexturePkg:function(e){return!(parseFloat(e)<.16)},useMergeTexturePkg:!1},CLOUD.DomUtil={getContainerOffsetToClient:function(e){var t,n=function(e){for(var t=0,n=0;e;)t+=e.offsetTop,n+=e.offsetLeft,e=e.offsetParent;var i=document.body,r=document.documentElement,a=window.pageYOffset||r.scrollTop||i.scrollTop,o=window.pageXOffset||r.scrollLeft||i.scrollLeft;return t-=a,n-=o,{top:t,left:n}},i=function(e){var t=e.getBoundingClientRect(),n=document.body,i=document.documentElement,r=i.clientTop||n.clientTop,a=i.clientLeft||n.clientLeft,o=t.top-r,s=t.left-a;return{top:Math.round(o),left:Math.round(s)}};if(e!=document){var r=function(e){return e.getBoundingClientRect?i(e):n(e)}(e);t={width:e.offsetWidth,height:e.offsetHeight,left:r.left,top:r.top}}else t={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return t}},CLOUD.GeomUtil={EmptyGeometry:new THREE.Geometry,UnitCylinderInstance:new THREE.CylinderBufferGeometry(1,1,1,32,1,!1),UnitBoxInstance:new THREE.BoxBufferGeometry(1,1,1),UnitTextureCylinder:null,UnitTextureBox:null,initializeUnitInstances:function(){CLOUD.GeomUtil.UnitCylinderInstance.boundingBox||CLOUD.GeomUtil.UnitCylinderInstance.computeBoundingBox(),CLOUD.GeomUtil.UnitBoxInstance.boundingBox||CLOUD.GeomUtil.UnitBoxInstance.computeBoundingBox()},destroyUnitInstances:function(){CLOUD.GeomUtil.UnitCylinderInstance.dispose(),CLOUD.GeomUtil.UnitBoxInstance.dispose()},getBoxData:function(e){for(var t=[[-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5],[-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,.5],[-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5],[-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5],[-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5],[.5,-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5]],n=[[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3]],i=[[],[],[],[],[],[]],r=0;r<4;++r)i[0].push(-1,0,0);for(var r=0;r<4;++r)i[1].push(0,-1,0);for(var r=0;r<4;++r)i[2].push(0,0,-1);for(var r=0;r<4;++r)i[3].push(0,0,1);for(var r=0;r<4;++r)i[4].push(0,1,0);for(var r=0;r<4;++r)i[5].push(1,0,0);var a=[[],[],[],[],[],[]];return a[0]=a[2]=a[4]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],a[1]=a[3]=a[5]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],{vertex:t[e],normal:i[e],uv:a[e],index:n[e]}},getPipeData2:function(){var e=[.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5,.5,0,-.5,.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5],t=[0,9,1,1,9,10,1,10,2,2,10,11,2,11,3,3,11,12,3,12,4,4,12,13,4,13,5,5,13,14,5,14,6,6,14,15,6,15,7,7,15,16,7,16,8,8,16,17,18,19,20,18,20,21,18,21,22,18,22,23,18,23,24,18,24,25,26,28,27,26,29,28,26,30,29,26,31,30,26,32,31,26,33,32],n=[1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],i=[-.5,.5,-.375,.5,-.25,.5,-.125,.5,0,.5,.125,.5,.25,.5,.375,.5,.5,.5,-.5,-.5,-.375,-.5,-.25,-.5,-.125,-.5,0,-.5,.125,-.5,.25,-.5,.375,-.5,.5,-.5,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875];return function(){return{vertex:e,normal:n,uv:i,index:t}}}(),getPipeData:function(e){(void 0===e||e<8)&&(e=8),e>256&&(e=256);var t,n,i=4*e+2,r=3*(4*e-4),a=e+1,o=1/e,s=6.28318530714/e,l=[];for(t=0;t<e;++t)l.push(.5*Math.cos(t*s)),l.push(.5*Math.sin(t*s));l.push(.5),l.push(0);var u=[];for(n=2*a,t=0;t<n;t+=2)u.push(l[t]),u.push(l[t+1]),u.push(.5);for(t=0;t<n;t+=2)u.push(l[t]),u.push(l[t+1]),u.push(-.5);for(n=2*e,t=0;t<n;t+=2)u.push(l[t]),u.push(l[t+1]),u.push(.5);for(t=n;t>0;t-=2)u.push(l[t]),u.push(l[t+1]),u.push(-.5);var c=[],h=e+1;for(t=0;t<e;++t)c.push(t),c.push(t+h),c.push(t+1),c.push(t+1),c.push(t+h),c.push(t+h+1);var d=2*a;for(t=1;t<e-1;++t)c.push(d),c.push(d+t),c.push(d+t+1);for(d+=e,t=1;t<e-1;++t)c.push(d),c.push(d+t),c.push(d+t+1);var f=[];for(t=e;t>=0;--t)f.push(t*o-.5),f.push(-.5);for(t=e;t>=0;--t)f.push(t*o-.5),f.push(.5);for(n=2*e,t=0;t<n;t+=2)f.push(l[t]),f.push(l[t+1]);for(t=n;t>0;t-=2)f.push(l[t]),f.push(l[t+1]);n=3*i;var p=[];for(t=0;t<n;++t)p.push(0);var m,g,v,y=new THREE.Vector3,E=new THREE.Vector3,b=new THREE.Vector3,x=new THREE.Vector3,M=new THREE.Vector3;for(t=0;t<r;t+=3)m=3*c[t],g=3*c[t+1],v=3*c[t+2],y.fromArray(u,m),E.fromArray(u,g),b.fromArray(u,v),x.subVectors(b,E),M.subVectors(y,E),x.cross(M),p[m]+=x.x,p[m+1]+=x.y,p[m+2]+=x.z,p[g]+=x.x,p[g+1]+=x.y,p[g+2]+=x.z,p[v]+=x.x,p[v+1]+=x.y,p[v+2]+=x.z;var _=new THREE.Vector3;for(n=3*i,t=0;t<n;t+=3)_.fromArray(p,t),_.normalize(),p[t]=_.x,p[t+1]=_.y,p[t+2]=_.z;return{vertex:u,normal:p,uv:f,index:c,edges:e}},getInstancePipeData:function(e,t){var n=this.getPipeData(e);(void 0===e||e<8)&&(e=8),e>256&&(e=256);var i=2*(e+1),r=i+e,a=4*e+2,o=[[],[],[]];o[0]=n.vertex.slice(0,3*i),o[1]=n.vertex.slice(3*i,3*r),o[2]=n.vertex.slice(3*r,3*a);var s=[[],[],[]],l=e+1,u=0;for(u=0;u<e;++u)s[0].push(u),s[0].push(u+l),s[0].push(u+1),s[0].push(u+1),s[0].push(u+l),s[0].push(u+l+1);for(u=1;u<e-1;++u)s[1].push(0),s[1].push(u),s[1].push(u+1);for(u=1;u<e-1;++u)s[2].push(0),s[2].push(u),s[2].push(u+1);var c=[[],[],[]];c[0]=n.uv.slice(0,2*i),c[1]=n.uv.slice(2*i,2*r),c[2]=n.uv.slice(2*r,2*a);var h=[[],[],[]];return h[0]=n.normal.slice(0,3*i),h[1]=n.normal.slice(3*i,3*r),h[2]=n.normal.slice(3*r,3*a),{vertex:o[t],normal:h[t],uv:c[t],index:s[t]}},getUnitTextureCylinder:function(){if(null==CLOUD.GeomUtil.UnitTextureCylinder){CLOUD.GeomUtil.UnitTextureCylinder=new Array(3);for(var e=0;e<3;++e){var t=CLOUD.GeomUtil.getInstancePipeData(32,e);CLOUD.GeomUtil.UnitTextureCylinder[e]=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitTextureCylinder[e].setIndex(t.index),CLOUD.GeomUtil.UnitTextureCylinder[e].addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),CLOUD.GeomUtil.UnitTextureCylinder[e].addAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),CLOUD.GeomUtil.UnitTextureCylinder[e].addAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return CLOUD.GeomUtil.UnitTextureCylinder},getUnitTextureBox:function(){
if(null===CLOUD.GeomUtil.UnitTextureBox){CLOUD.GeomUtil.UnitTextureBox=new Array(6);for(var e=0;e<6;++e){var t=CLOUD.GeomUtil.getBoxData(e);CLOUD.GeomUtil.UnitTextureBox[e]=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitTextureBox[e].setIndex(t.index),CLOUD.GeomUtil.UnitTextureBox[e].addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),CLOUD.GeomUtil.UnitTextureBox[e].addAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),CLOUD.GeomUtil.UnitTextureBox[e].addAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return CLOUD.GeomUtil.UnitTextureBox},getBoxBufferGeometryWithUvMatrices:function(e){for(var t,n=[],i=new THREE.Matrix3,r=new THREE.Vector3,a=!!e,o=0;o<6;++o){t=new THREE.BufferGeometry;var s=CLOUD.GeomUtil.getBoxData(o);if(a){var l=[];i.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1);for(var u=0,c=s.uv.length;u<c;u+=2)r.set(s.uv[u],s.uv[u+1],1),r.applyMatrix3(i),l.push(r.x),l.push(r.y);t.addAttribute("uv",new THREE.Float32BufferAttribute(l,2))}t.setIndex(new THREE.BufferAttribute(Uint32Array.from(s.index),1)),t.addAttribute("position",new THREE.Float32BufferAttribute(s.vertex,3)),t.addAttribute("normal",new THREE.Float32BufferAttribute(s.normal,3)),n.push(t)}return CLOUD.GeomUtil.mergeBufferGeometries2(n)},getPipeBufferGeometryWithUvMatrices:function(e){var t=CLOUD.GeomUtil.getPipeData(32),n=t.edges,i=!(!e||18!==e.length),r=new THREE.BufferGeometry;if(i){for(var a=[],o=0,s=e.length;o<s;o+=6){var l=new THREE.Matrix3;l.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1),a.push(l)}for(var u=[],c=new THREE.Vector3,h=4*(n+1),d=h+2*n,f=0,p=t.uv.length;f<p;f+=2)c.set(t.uv[f],t.uv[f+1],1),f<h?c.applyMatrix3(a[0]):f<d?c.applyMatrix3(a[1]):c.applyMatrix3(a[2]),u.push(c.x),u.push(c.y);r.addAttribute("uv",new THREE.Float32BufferAttribute(u,2))}return r.setIndex(new THREE.Uint32BufferAttribute(t.index,1)),r.addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),r.addAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),r},getWorldMatrixOfMesh:function(e){for(var t=[],n=e.parent;n;)t.push(n.matrix),n=n.parent;var i=new THREE.Matrix4;if(t.length>0){i=t[t.length-1];for(var r=t.length-2;r>=0;--r)i.multiply(t[r])}var a=new THREE.Matrix4;return a.multiplyMatrices(i,e.matrix),a},getWorldPositionOfMesh:function(e,t){t||(t=new THREE.Matrix4);var n=new THREE.Matrix4;n.getInverse(t);var i=e.clone();return i.applyMatrix4(n),i},getBoundingBoxWorldOfMesh:function(e,t){var n=e.boundingBox;n||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),n=e.geometry.boundingBox);var i=n.clone();i.applyMatrix4(e.matrixWorld);var r=new THREE.Matrix4;return r.getInverse(t),i.applyMatrix4(r),i},mergeBufferGeometries:function(e,t){for(var n=null!==e[0].geometry.index,i=new Set(Object.keys(e[0].geometry.attributes)),r=new Set(Object.keys(e[0].geometry.morphAttributes)),a={},o={},s=new THREE.BufferGeometry,l=0;l<e.length;++l){var u=e[l].geometry;if(n!==(null!==u.index))return null;for(var c in u.attributes){if(!i.has(c))return console.log("attributes not Used: ",c),null;void 0===a[c]&&(a[c]=[]),a[c].push(u.attributes[c])}for(var c in u.morphAttributes){if(!r.has(c))return null;void 0===o[c]&&(o[c]=[]),o[c].push(u.morphAttributes[c])}void 0!==u.userData&&(s.userData=s.userData||{},s.userData.mergedUserData=s.userData.mergedUserData||[],s.userData.mergedUserData.push(u.userData))}if(n){for(var h=0,d=[],f=0,l=0;l<e.length;++l){var p=e[l].geometry.index;if(h>0){p=p.clone();for(var m=0;m<p.count;++m)p.setX(m,p.getX(m)+h)}d.push(p),h+=e[l].geometry.attributes.position.count,void 0===t[e[l].name]&&(t[e[l].name]=[]),t[e[l].name].push({nodeId:e[l].nodeId,indexStart:f,indexCount:p.count}),f+=p.count}var g=this.mergeBufferAttributes(d);if(!g)return null;s.index=g}for(var c in a){var v=this.mergeBufferAttributes(a[c]);if(!v)return null;s.addAttribute(c,v)}for(var c in o){var y=o[c][0].length;if(0===y)break;s.morphAttributes=s.morphAttributes||{},s.morphAttributes[c]=[];for(var l=0;l<y;++l){for(var E=[],m=0;m<o[c].length;++m)E.push(o[c][m][l]);var b=this.mergeBufferAttributes(E);if(!b)return null;s.morphAttributes[c].push(b)}}return s},mergeBufferGeometries2:function(e){for(var t=null!==e[0].index,n=new Set(Object.keys(e[0].attributes)),i={},r=new THREE.BufferGeometry,a=0;a<e.length;++a){var o=e[a];if(t!==(null!==o.index))return null;for(var s in o.attributes){if(!n.has(s))return null;void 0===i[s]&&(i[s]=[]),i[s].push(o.attributes[s])}}if(t){for(var l=0,u=[],a=0;a<e.length;++a){var c=e[a].index;if(l>0){c=c.clone();for(var h=0;h<c.count;++h)c.setX(h,c.getX(h)+l)}u.push(c),l+=e[a].attributes.position.count}var d=this.mergeBufferAttributes(u);if(!d)return null;r.index=d}for(var s in i){var f=this.mergeBufferAttributes(i[s]);if(!f)return null;r.addAttribute(s,f)}return r},mergeBufferAttributes:function(e){for(var t,n,i,r=0,a=0;a<e.length;++a){var o=e[a];if(o.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return null;if(void 0===n&&(n=o.itemSize),n!==o.itemSize)return null;if(void 0===i&&(i=o.normalized),i!==o.normalized)return null;r+=o.array.length}for(var s=new t(r),l=0,u=0;u<e.length;++u)s.set(e[u].array,l),l+=e[u].array.length;return new THREE.BufferAttribute(s,n,i)},applyMatrix3ToBuffer:function(){var e=new THREE.Vector3;return function(t,n){for(var i=0,r=n.length;i<r;i+=3)e.x=n[i+0],e.y=n[i+1],e.z=n[i+2],e.applyMatrix3(t),n[i+0]=e.x,n[i+1]=e.y,n[i+2]=e.z;return n}}(),applyMatrix4ToBuffer:function(){var e=new THREE.Vector3;return function(t,n){for(var i=0,r=n.length;i<r;i+=3)e.x=n[i+0],e.y=n[i+1],e.z=n[i+2],e.applyMatrix4(t),n[i+0]=e.x,n[i+1]=e.y,n[i+2]=e.z;return n}}(),normalizeBuffer:function(e){for(var t,n,i,r,a=0,o=e.length;a<o;a+=3)t=e[a],n=e[a+1],i=e[a+2],r=1/Math.sqrt(t*t+n*n+i*i),e[a+0]=t*r,e[a+1]=n*r,e[a+2]=i*r},disposeBufferFromGeometry:function(e,t){for(var n=0,i=t.length;n<i;n++){var r=e.getAttribute(t[n]);r&&(r.array=null)}},disposeIndexBufferFromGeometry:function(e){e.index&&(e.index.array=null)},copyMeshProperties:function(e,t){e.name=t.name,e.up.copy(t.up),e.position.copy(t.position),e.quaternion.copy(t.quaternion),e.scale.copy(t.scale),e.matrix.copy(t.matrix),e.matrixWorld.copy(t.matrixWorld),e.matrixAutoUpdate=t.matrixAutoUpdate,e.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate},createBufferGeometryWithPosAndSkin:function(e){var t=new THREE.BufferGeometry;if(e.isBufferGeometry||e._bufferGeometry){var n=e.isBufferGeometry?e:e._bufferGeometry;if(!n.getAttribute("position"))return null;t.addAttribute("position",n.getAttribute("position")),n.getAttribute("skinIndex")&&t.addAttribute("skinIndex",n.getAttribute("skinIndex")),n.getAttribute("skinWeight")&&t.addAttribute("skinWeight",n.getAttribute("skinWeight"));var i=n.getIndex();i&&t.setIndex(i)}else if(e.isGeometry){if(0===e.vertices.length)return null;var r=new THREE.Float32BufferAttribute(3*e.vertices.length,3);if(t.addAttribute("position",r.copyVector3sArray(e.vertices)),e.skinIndices.length>0){var a=new THREE.Float32BufferAttribute(4*e.skinIndices.length,4);t.addAttribute("skinIndex",a.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var o=new THREE.Float32BufferAttribute(4*e.skinWeights.length,4);this.addAttribute("skinWeight",o.copyVector4sArray(e.skinWeights))}if(e.faces.length){for(var s=e.faces,l=[],u=0;u<s.length;u++){var c=s[u];l.push(c.a,c.b,c.c)}t.setIndex(l)}}if(!t.getIndex()){for(var h,d=[],f=Math.floor(t.attributes.position.count/3),p=0;p<f;p++)h=3*p,d.push(h,h+1,h+2);t.setIndex(d)}return t},limitGeometryBufferSize:function(e){var t,n,i,r,a,o;if(e.groups.length){var s=e.groups,l=!1;for(n=0,i=s.length;n<i;n++)if(s[n].count>45e6){l=!0;break}if(!l)return;for(e.clearGroups(),n=0,i=s.length;n<i;n++){var u=s[n];if((r=u.count)>45e6){for(a=Math.floor(r/45e6),o=r%45e6,t=0;t<a;t++)e.addGroup(u.start+45e6*t,45e6,u.materialIndex);o&&e.addGroup(u.start+45e6*a,o,u.materialIndex)}else e.addGroup(u.start,u.count,u.materialIndex)}}else if((r=e.index?e.index.count:0)>45e6){for(a=Math.floor(r/45e6),o=r%45e6,t=0;t<a;t++)e.addGroup(45e6*t,45e6,0);o&&e.addGroup(45e6*a,o,0)}},getUnitLightmapBox:function(){if(void 0===CLOUD.GeomUtil.UnitLightmapBoxGeometry){for(var e,t,n=[],i=[],r=[],a=[],o=0,s=0;s<6;++s){var l=CLOUD.GeomUtil.getBoxData(s);for(e=0,t=l.index.length;e<t;e++){var u=l.index[e];n.push(l.vertex[3*u]),n.push(l.vertex[3*u+1]),n.push(l.vertex[3*u+2]),i.push(l.normal[3*u]),i.push(l.normal[3*u+1]),i.push(l.normal[3*u+2]),r.push(l.uv[2*u]),r.push(l.uv[2*u+1]),a.push(e+o)}o+=l.index.length}CLOUD.GeomUtil.UnitLightmapBoxGeometry=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitLightmapBoxGeometry.setIndex(a),CLOUD.GeomUtil.UnitLightmapBoxGeometry.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),CLOUD.GeomUtil.UnitLightmapBoxGeometry.addAttribute("normal",new THREE.Float32BufferAttribute(i,3)),CLOUD.GeomUtil.UnitLightmapBoxGeometry.addAttribute("uv",new THREE.Float32BufferAttribute(r,2))}return CLOUD.GeomUtil.UnitLightmapBoxGeometry},getUnitLightmapBoxM:function(){if(void 0===CLOUD.GeomUtil.UnitLightmapBoxMGeometry){CLOUD.GeomUtil.UnitLightmapBoxMGeometry=new Array(6);for(var e=0;e<6;++e){for(var t=CLOUD.GeomUtil.getBoxData(e),n=[],i=[],r=[],a=[],o=0,s=t.index.length;o<s;o++){var l=t.index[o];i.push(t.vertex[3*l]),i.push(t.vertex[3*l+1]),i.push(t.vertex[3*l+2]),r.push(t.normal[3*l]),r.push(t.normal[3*l+1]),r.push(t.normal[3*l+2]),a.push(t.uv[2*l]),a.push(t.uv[2*l+1]),n.push(o)}CLOUD.GeomUtil.UnitLightmapBoxMGeometry[e]=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitLightmapBoxMGeometry[e].setIndex(n),CLOUD.GeomUtil.UnitLightmapBoxMGeometry[e].addAttribute("position",new THREE.Float32BufferAttribute(i,3)),CLOUD.GeomUtil.UnitLightmapBoxMGeometry[e].addAttribute("normal",new THREE.Float32BufferAttribute(r,3)),CLOUD.GeomUtil.UnitLightmapBoxMGeometry[e].addAttribute("uv",new THREE.Float32BufferAttribute(a,2))}}return CLOUD.GeomUtil.UnitLightmapBoxMGeometry},getUnitLightmapPipeM:function(){if(void 0===CLOUD.GeomUtil.UnitLightmapPipeMGeometry){var e,t,n=[],i=[],r=[],a=[],o=CLOUD.GeomUtil.getPipeData(32);for(e=0,t=o.index.length;e<t;e++){var s=o.index[e];n.push(o.vertex[3*s]),n.push(o.vertex[3*s+1]),n.push(o.vertex[3*s+2]),i.push(o.normal[3*s]),i.push(o.normal[3*s+1]),i.push(o.normal[3*s+2]),r.push(o.uv[2*s]),r.push(o.uv[2*s+1]),a.push(e)}CLOUD.GeomUtil.UnitLightmapPipeMGeometry=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitLightmapPipeMGeometry.setIndex(a),CLOUD.GeomUtil.UnitLightmapPipeMGeometry.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),CLOUD.GeomUtil.UnitLightmapPipeMGeometry.addAttribute("normal",new THREE.Float32BufferAttribute(i,3)),CLOUD.GeomUtil.UnitLightmapPipeMGeometry.addAttribute("uv",new THREE.Float32BufferAttribute(r,2))}return CLOUD.GeomUtil.UnitLightmapPipeMGeometry},getUnitLightmapPipe:function(){if(void 0===CLOUD.GeomUtil.UnitLightmapPipeGeometry){var e,t,n=[],i=[],r=[],a=[],o=CLOUD.GeomUtil.UnitCylinderInstance,s=o.getAttribute("position").array,l=o.getAttribute("normal").array,u=o.getAttribute("uv").array,c=o.getIndex().array;for(e=0,t=c.length;e<t;e++){var h=c[e];n.push(s[3*h]),n.push(s[3*h+1]),n.push(s[3*h+2]),i.push(l[3*h]),i.push(l[3*h+1]),i.push(l[3*h+2]),r.push(u[2*h]),r.push(u[2*h+1]),a.push(e)}CLOUD.GeomUtil.UnitLightmapPipeGeometry=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitLightmapPipeGeometry.setIndex(a),CLOUD.GeomUtil.UnitLightmapPipeGeometry.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),CLOUD.GeomUtil.UnitLightmapPipeGeometry.addAttribute("normal",new THREE.Float32BufferAttribute(i,3)),CLOUD.GeomUtil.UnitLightmapPipeGeometry.addAttribute("uv",new THREE.Float32BufferAttribute(r,2))}return CLOUD.GeomUtil.UnitLightmapPipeGeometry},getGeometrySplitByPlane:function(e,t){var n="front",i="back",r="on",a=["a","b","c"];if("BufferGeometry"!=e.type){var o=new THREE.BufferGeometry;o.fromGeometry(e),e=o}for(var s=new CLOUD.SplitGeometryBuilder(e,t),l=[],u=[],c=e.attributes.position.array,h=new THREE.Vector3,d=0;d<c.length;d+=3){h.set(c[d],c[d+1],c[d+2]);var f=function(e,t){return t.distanceToPoint(e)}(h,t),p=function(e){return e<0?i:e>0?n:r}(f);l.push(f),u.push(p)}for(var m=e.index.array,g=0,d=(m.length,0);d<m.length;d+=3){for(var v=[],y=d;y<d+3;y++)v.push(u[m[y]]);if(-1!==v.indexOf(n)||-1===v.indexOf(i)){var E={a:m[d],b:m[d+1],c:m[d+2]};s.startFace(g,E);var b=a[a.length-1],x=m[d+2],M=l[x],_=u[x];a.map(function(e){var t=E[e],a=l[t],o=u[t];o===n&&(_===i?(s.addIntersection(b,e,M,a),s.addVertex(e)):s.addVertex(e)),o===r&&s.addVertex(e),o===i&&_===n&&s.addIntersection(b,e,M,a),b=e,x=t,_=o,M=a}),s.endFace(),g++}}var C=new THREE.BufferGeometry;return C.addAttribute("position",new THREE.Float32BufferAttribute(s.targetPositions,3)),C.addAttribute("normal",new THREE.Float32BufferAttribute(s.targetNormals,3)),C.addAttribute("uv",new THREE.Float32BufferAttribute(s.targetUvs,2)),C.setIndex(new THREE.Uint32BufferAttribute(s.targetIndices,1)),C}},CLOUD.GeomUtil.getBoxMBuffer=function(){for(var e,t,n=[],i=[],r=[],a=0,o=0;o<6;++o){var s=CLOUD.GeomUtil.getBoxData(o);for(e=0,t=s.vertex.length;e<t;e++)n.push(s.vertex[e]);for(e=0,t=s.index.length;e<t;e++)r.push(s.index[e]+a);for(a+=s.vertex.length/3,e=0,t=s.normal.length;e<t;e++)i.push(s.normal[e])}return function(e){var t=null;if(e){var a=new THREE.Matrix3,o=new THREE.Vector3;t=[];for(var s=0;s<6;++s){var l=CLOUD.GeomUtil.getBoxData(s);a.set(e[6*s],e[6*s+2],e[6*s+4],e[6*s+1],e[6*s+3],e[6*s+5],0,0,1);for(var u=0,c=l.uv.length;u<c;u+=2)o.set(l.uv[u],l.uv[u+1],1),o.applyMatrix3(a),t.push(o.x),t.push(o.y)}}return{vertex:n,normal:i,uv:t,index:r}}}(),CLOUD.GeomUtil.getPipeMBuffer=function(){var e=CLOUD.GeomUtil.getPipeData(32),t=e.edges,n=e.vertex,i=e.normal,r=e.index;return function(e){var a=null;if(!(!e||18!==e.length)){a=[];for(var o=[],s=0,l=e.length/6;s<l;s++){var u=new THREE.Matrix3;u.set(e[6*s],e[6*s+2],e[6*s+4],e[6*s+1],e[6*s+3],e[6*s+5],0,0,1),o.push(u)}for(var c=CLOUD.GeomUtil.getPipeData(32),h=4*(t+1),d=h+2*t,f=new THREE.Vector3,p=0,m=c.uv.length;p<m;p+=2)f.set(c.uv[p],c.uv[p+1],1),p<h?f.applyMatrix3(o[0]):p<d?f.applyMatrix3(o[1]):f.applyMatrix3(o[2]),a.push(f.x),a.push(f.y)}return{vertex:n,normal:i,uv:a,index:r}}}(),CLOUD.Logger={log:function(){CLOUD.GlobalData.DEBUG&&console.log.apply(console,arguments)},debug:function(){CLOUD.GlobalData.DEBUG&&console.debug.apply(console,arguments)},warn:function(){CLOUD.GlobalData.DEBUG&&console.warn.apply(console,arguments)},error:function(){CLOUD.GlobalData.DEBUG&&console.error.apply(console,arguments)},time:function(){CLOUD.GlobalData.DEBUG&&console.time.apply(console,arguments)},timeEnd:function(){CLOUD.GlobalData.DEBUG&&console.timeEnd.apply(console,arguments)}},CLOUD.MaterialUtil={DefaultMaterial:new THREE.MeshPhongMaterial({color:255,side:THREE.DoubleSide}),DefaultWireframeColor:{color:new THREE.Color(0,0,0),opacity:.4},getDefaultStandardMaterial:function(){var e=null;return function(){return e||(e=new CLOUD.CloudStandardMaterial({color:0,side:THREE.DoubleSide})),e}}(),createInstancePhongMaterial:function(e){return e.clone()},updateBasicMaterial:function(e,t){e.needsUpdate=!0},setMatrixUniform:function(e){CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.transformMatrix.value=e},createPhongMaterial:function(e){var t=new THREE.MeshPhongMaterial(e);return t.type="FillFacePhong",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.fillFacePhong.uniforms]),t.vertexShader=THREE.ShaderLib.fillFacePhong.vertexShader,t.fragmentShader=THREE.ShaderLib.fillFacePhong.fragmentShader,t.side=THREE.DoubleSide,t},createStandardMaterial:function(e){var t=new CLOUD.CloudStandardMaterial(e);return e.fillMap&&(t.defines.USE_FILLPATTERN=""),t},createInstanceMaterial:function(e,t){var n=CLOUD.MaterialUtil.createStandardMaterial(e);return n.defines.USE_INSTANCE="",t&&(n.defines.USE_INSTANCE_NORMAL=""),n.colorState=CLOUD.EnumShaderColorState.BLINK,n.refreshUniforms(),n},createNewStyleMaterial:function(e){var t=new THREE.MeshStandardMaterial(e);return t.type="NewStyle",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms]),t.vertexShader=THREE.ShaderLib.newStyle.vertexShader,t.fragmentShader=THREE.ShaderLib.newStyle.fragmentShader,t.metalness=0,t},createHighlightMaterial:function(){return this.createStandardMaterial(CLOUD.GlobalData.SelectionColor)},getBlinkMaterial:function(e,t){var n=CLOUD.MaterialUtil.getMaterialParameters(e),i=CLOUD.MaterialUtil.createStandardMaterial(n);return i.blinkColor.copy(t),i.colorState=CLOUD.EnumShaderColorState.BLINK,i.refreshUniforms(),i},getMaterialParameters:function(e){var t={};return e.hasOwnProperty("color")&&(t.color=e.color),t.opacity=1,t.transparent=!1,e.hasOwnProperty("opacity")&&(t.opacity=e.opacity,e.opacity<1&&(t.transparent=!0)),e.hasOwnProperty("side")&&(t.side=e.side),e.hasOwnProperty("emissive")&&(t.emissive=e.emissive),e.hasOwnProperty("specular")&&(t.specular=e.specular),e.hasOwnProperty("shininess")&&(t.shininess=e.shininess),e.hasOwnProperty("map")&&(t.map=e.map),e.hasOwnProperty("bumpMap")&&(t.bumpMap=e.bumpMap),e.hasOwnProperty("bumpScale")&&(t.bumpScale=e.bumpScale),e.hasOwnProperty("normalMap")&&(t.normalMap=e.normalMap),e.hasOwnProperty("normalScale")&&(t.normalScale=e.normalScale),e.hasOwnProperty("alphaMap")&&(t.alphaMap=e.alphaMap),e.hasOwnProperty("alphaTest")&&(t.alphaTest=e.alphaTest),e.hasOwnProperty("transparent")&&(t.transparent=e.transparent),e.hasOwnProperty("emissiveMap")&&(t.emissiveMap=e.emissiveMap),e.hasOwnProperty("envMap")&&(t.envMap=e.envMap),e.hasOwnProperty("envMapIntensity")&&(t.envMapIntensity=e.envMapIntensity),e.hasOwnProperty("roughness")&&(t.roughness=e.roughness),e.hasOwnProperty("metalness")&&(t.metalness=e.metalness),e.hasOwnProperty("originRoughness")&&(t.originRoughness=e.originRoughness),e.hasOwnProperty("originMetalness")&&(t.originMetalness=e.originMetalness),CLOUD.GlobalData.IBL&&e.hasOwnProperty("iblProbe")&&(t.iblProbe=e.iblProbe),e.hasOwnProperty("shift")&&(t.shift=e.shift),e.hasOwnProperty("pureColor")&&(t.pureColor=e.pureColor),e.hasOwnProperty("textureColor")&&(t.textureColor=e.textureColor),e.hasOwnProperty("imageFade")&&(t.imageFade=e.imageFade),"cloudStandard"==e.type&&e.hasOwnProperty("lights")&&(t.lights=e.lights),e.hasOwnProperty("lightMap")&&(t.lightMap=e.lightMap),e.hasOwnProperty("lightMapIntensity")&&(t.lightMapIntensity=e.lightMapIntensity),e.hasOwnProperty("viewportSize")&&(t.viewportSize=e.viewportSize),e.hasOwnProperty("fillMap")&&(t.fillMap=e.fillMap),t},nextHighestPowerOfTwo:function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},ensurePowerOfTwo:function(e){if(0==e.width||0==e.height)return e;if(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=CLOUD.MaterialUtil.nextHighestPowerOfTwo(e.width),t.height=CLOUD.MaterialUtil.nextHighestPowerOfTwo(e.height);return t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},ensureQuadrate:function(e){var t=e.width,n=e.height;if(0==t||0==n||THREE.Math.isPowerOfTwo(t)&&THREE.Math.isPowerOfTwo(n)&&t===n)return e;THREE.Math.isPowerOfTwo(t)||(t=CLOUD.MaterialUtil.nextHighestPowerOfTwo(t)),THREE.Math.isPowerOfTwo(n)||(n=CLOUD.MaterialUtil.nextHighestPowerOfTwo(n));var i=0,r=0;t>=n?r=.5*(t-n):i=.5*(n-t);var a=document.createElement("canvas");return a.width=a.height=Math.max(t,n),a.getContext("2d").drawImage(e,0,0,e.width,e.height,i,r,t,n),a},getColorParamsByMaterial:function(e){return{rgbaColor:[e.color.r,e.color.g,e.color.b,e.opacity],transparent:e.transparent}},getHoverColorByColor:function(e){var t={};return t.r=e.r,t.g=e.g,t.b=e.b,t.a=CLOUD.MaterialUtil.getHoverOpacity(e.a),t},getHoverOpacity:function(e){return e>=.3?e-.3:e+.3},cloneMaterialBaseOnColor:function(e,t){if(!e.color&&!e.diffuse)return e;var n=e.clone();return n.opacity=t.opacity,n.transparent=t.transparent,n.color&&n.color.isColor&&t.color&&t.color.isColor&&n.color.copy(t.color),n.diffuse&&n.diffuse.isColor&&t.diffuse&&t.diffuse.isColor&&n.diffuse.copy(t.diffuse),n}},CLOUD.UIHelper={debugInfoDiv:null,lastDebugInfoDivShow:null,showPickedInformation:function(e){function t(){var e=r.debugInfoDiv;e&&"none"!==e.style.display&&(e.style.display="none",r.lastDebugInfoDivShow&&(e.removeEventListener("dblclick",t,!1),r.lastDebugInfoDivShow=!1))}var n=340,i=320,r=this;if(!e||!e.intersectInfo)return void t();var a=e.intersectInfo,o=e.canvasPos.x,s=e.canvasPos.y;this.debugInfoDiv||(this.debugInfoDiv=document.createElement("div"),this.debugInfoDiv.id="debugPickedInfo",this.debugInfoDiv.style.display="block",this.debugInfoDiv.style.position="absolute",this.debugInfoDiv.style.width=n+"px",this.debugInfoDiv.style.height=i+"px",this.debugInfoDiv.style.backgroundColor="#ffffdd",this.debugInfoDiv.style.borderWidth="2px",this.debugInfoDiv.style.borderStyle="solid",this.debugInfoDiv.style.opacity="0.8",document.body.appendChild(this.debugInfoDiv)),this.debugInfoDiv.style.display="",this.lastDebugInfoDivShow||(this.lastDebugInfoDivShow=!0,this.debugInfoDiv.addEventListener("dblclick",t,!1));var l=a.axisGridInfo,u=a.worldPosition,c="";c+="<span>&#9830;&nbsp;&nbsp;Base Information</span><ul style='width:340px;list-style:none'>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;border-bottom: 1px solid #ccc;float:left;width:80px;height:66px;text-align:left;line-height:66px'>ID</li>",c+="<li style='border:1px solid #ccc;float:left;width:200px;height:66px;text-align:left;'>"+a.selectedObjectId+"</li>",c+="</ul>",c+="</br><span>&#9830;&nbsp;&nbsp;Position</span><ul style='width:340px;list-style:none'>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>X</li>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+u.x+"</li>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>Y</li>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+u.y+"</li>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>Z</li>",c+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>"+u.z+"</li>",c+="</ul>",l?(c+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>distanceX</li>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>("+l.numeralName+", "+l.offsetX+")</li>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>distanceY</li>",c+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>("+l.abcName+", "+l.offsetY+")</li>",c+="</ul>"):(c+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",c+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>message</li>",c+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'><span style='color: red'> not exist axis grid!!!</span></li>",c+="</ul>"),this.debugInfoDiv.innerHTML=c+"<br /><br />",function(e,t,r){if(e&&"none"!=e.style.display){var a,o,s=t+n,l=r+i;if(void 0!==t&&void 0!==r)if(window.innerWidth)a=s>window.innerWidth?window.pageXOffset+(t-n)+"px":window.pageXOffset+t+"px",o=l>window.innerHeight?window.pageYOffset+(r-i)+"px":window.pageYOffset+r+"px";else{var u=document.documentElement;a=u.scrollLeft+t+"px",o=u.scrollTop+r+"px"}else if(window.innerWidth)a=window.pageXOffset+(window.innerWidth-n)/2+"px",o=window.pageYOffset+(window.innerHeight-i)/2+"px";else{var u=document.documentElement;a=u.scrollLeft+(u.offsetWidth-n)/2+"px",o=u.scrollTop+(u.offsetHeight-i)/2+"px"}e.style.left=a,e.style.top=o}}(this.debugInfoDiv,o,s)}},CLOUD.Edge=function(){this.vertexIndex=new Array(2),this.faceIndex=new Array(2)},CLOUD.RemoveDuplicateIndex=function(e,t){function n(e,t){var n=a[e],i=a[t];return n.x!=i.x?n.x-i.x:n.y!=i.y?n.y-i.y:n.z-i.z}function i(e,t){var i=n(e,t);return 0==i?e-t:i}for(var r=e.length/3,a=new Array(r),o=new Array(r),s=0;s<r;++s)a[s]=new THREE.Vector3(e[3*s],e[3*s+1],e[3*s+2]),o[s]=s;o.sort(i);for(var l={},u=o[0],s=1;s<r;++s)0==n(u,o[s])?l[o[s]]=u:u=o[s];for(var c=new Array(t.length),s=0;s<t.length;++s)l.hasOwnProperty(t[s])?c[s]=l[t[s]]:c[s]=t[s];return c},CLOUD.RemoveDuplicateVertex=function(e,t){function n(e,t){return e-t}var i=CLOUD.RemoveDuplicateIndex(e,t);i.sort(n);var r=new Array,a=i[0];r.push(a);for(var o=1;o<i.length;++o)i[o]!=a&&(a=i[o],r.push(a));return r.sort(n)},CLOUD.BuildEdge=function(e,t,n){n=void 0==n?Math.PI/4:n;for(var i=CLOUD.RemoveDuplicateIndex(e,t),r=i.length,a=e.length/3,o=new Array(a+r),s=a,l=i.length/3,u=0;u<a;++u)o[u]=-1;for(var c=new Array(r),h=0,u=0;u<l;++u)for(var d=i[3*u+2],f=0;f<3;++f){var p=!1,m=i[3*u+f];if(d>m){p=!0;var g=d;d=m,m=g}var v=new CLOUD.Edge;v.vertexIndex[0]=d,v.vertexIndex[1]=m,v.faceIndex[0]=u,v.faceIndex[1]=u;var y=o[d];if(-1==y)o[d]=h,c[h]=v,o[s+h]=-1,h++;else for(;;){var E=c[y];if(E.vertexIndex[1]==m){E.faceIndex[1]=u;break}var b=o[s+y];if(-1==b){o[s+y]=h,c[h]=v,o[s+h]=-1,h++;break}y=b}p||(d=m)}for(var x=[],u=0;u<h;++u){var E=c[u];if(E.faceIndex[0]==E.faceIndex[1])x.push(E.vertexIndex[0]),x.push(E.vertexIndex[1]);else{var M=E.faceIndex[0],_=i[3*M],C=i[3*M+1],I=i[3*M+2],O=new THREE.Vector3(e[3*_],e[3*_+1],e[3*_+2]),T=new THREE.Vector3(e[3*C],e[3*C+1],e[3*C+2]),L=new THREE.Vector3(e[3*I],e[3*I+1],e[3*I+2]),S=O.sub(T),D=T.sub(L),w=S.cross(D);w.normalize();var U=E.faceIndex[1];_=i[3*U],C=i[3*U+1],I=i[3*U+2],O=new THREE.Vector3(e[3*_],e[3*_+1],e[3*_+2]),T=new THREE.Vector3(e[3*C],e[3*C+1],e[3*C+2]),L=new THREE.Vector3(e[3*I],e[3*I+1],e[3*I+2]),S=O.sub(T),D=T.sub(L);var R=S.cross(D);R.normalize(),Math.abs(w.dot(R))<n&&(x.push(E.vertexIndex[0]),x.push(E.vertexIndex[1]))}}return x},CLOUD.GetFaceIndex=function(e,t,n,i,r){for(var a=n.length/3,o=new Array,s=0;s<a;++s){var l=n[3*s],u=new THREE.Vector3(t[3*l],t[3*l+1],t[3*l+2]),c=u.dot(r);if(Math.abs(c-1)<.001){var h=new THREE.Vector3(e[3*l],e[3*l+1],e[3*l+2]),d=-h.dot(u),f=Math.abs(i.dot(u)+d);Math.abs(f)<3&&o.push(n[3*s],n[3*s+1],n[3*s+2])}}return o},CLOUD.BuildRoomEdge=function(e,t,n,i,r){function a(e,t){return Math.abs(e-t)<=.1}var o=e.length;a(e[0].x,e[o-1].x)&&a(e[0].y,e[o-1].y)||e.push(e[0]),o=e.length;for(var s=[],l=[],u=new THREE.BufferGeometry,c=0;c<o;++c)l.push(e[c].x-t,e[c].y-n,e[c].z-i);for(var c=0;c<o;++c)l.push(e[c].x-t,e[c].y-n,e[c].z-i+r);for(var c=0;c<2*o-1;++c)c!=o-1&&s.push(c,c+1);for(var c=0;c<o-1;++c)s.push(c,c+o);return u.setIndex(new THREE.BufferAttribute(new Uint16Array(s),1)),u.addAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),u.computeBoundingSphere(),u},THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse,this.loadBuffer=THREE.DDSLoader.loadBuffer},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var i={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},r=n("DXT1"),a=n("DXT3"),o=n("DXT5"),s=n("ETC1"),l=new Int32Array(e,0,31);if(542327876!==l[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),i;if(4&!l[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),i;var u,c=l[21],h=!1;switch(c){case r:u=8,i.format=THREE.RGB_S3TC_DXT1_Format;break;case a:u=16,i.format=THREE.RGBA_S3TC_DXT3_Format;break;case o:u=16,i.format=THREE.RGBA_S3TC_DXT5_Format;break;case s:u=8,i.format=THREE.RGB_ETC1_Format;break;default:if(!(32===l[22]&&16711680&l[23]&&65280&l[24]&&255&l[25]&&4278190080&l[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(c)),i;h=!0,u=64,i.format=THREE.RGBAFormat}i.mipmapCount=1,131072&l[2]&&!1!==t&&(i.mipmapCount=Math.max(1,l[7]));var d=l[28];if(i.isCubemap=!!(512&d),i.isCubemap&&(!(1024&d)||!(2048&d)||!(4096&d)||!(8192&d)||!(16384&d)||!(32768&d)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),i;i.width=l[4],i.height=l[3];for(var f=l[1]+4,p=i.isCubemap?6:1,m=0;m<p;m++)for(var g=i.width,v=i.height,y=0;y<i.mipmapCount;y++){if(h)var E=function(e,t,n,i){for(var r=n*i*4,a=new Uint8Array(e,t,r),o=new Uint8Array(r),s=0,l=0,u=0;u<i;u++)for(var c=0;c<n;c++){var h=a[l];l++;var d=a[l];l++;var f=a[l];l++;var p=a[l];l++,o[s]=f,s++,o[s]=d,s++,o[s]=h,s++,o[s]=p,s++}return o}(e,f,g,v),b=E.length;else var b=Math.max(4,g)/4*Math.max(4,v)/4*u,E=new Uint8Array(e,f,b);var x={data:E,width:g,height:v};i.mipmaps.push(x),f+=b,g=Math.max(g>>1,1),v=Math.max(v>>1,1)}return i},THREE.DDSLoader.loadBuffer=function(e,t){var n=[],i=new THREE.CompressedTexture;i.image=n;var r=this._parser(e,!0);if(r.isCubemap)for(var a=r.mipmaps.length/r.mipmapCount,o=0;o<a;o++){n[o]={mipmaps:[]};for(var s=0;s<r.mipmapCount;s++)n[o].mipmaps.push(r.mipmaps[o*r.mipmapCount+s]),n[o].format=r.format,n[o].width=r.width,n[o].height=r.height}else i.image.width=r.width,i.image.height=r.height,i.mipmaps=r.mipmaps;1===r.mipmapCount&&(i.minFilter=THREE.LinearFilter),i.format=r.format,i.needsUpdate=!0,t&&t(i)},function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.sourceGeometry=t,this.slicePlane=n,this.addedVertices=[],this.addedIntersections=[];var i=this.sourceGeometry.getAttribute("uv");this.uvs=i?i.array:null;var r=this.sourceGeometry.getAttribute("normal");this.normals=r?r.array:null;var a=this.sourceGeometry.getAttribute("position");this.positions=a?a.array:null,this.targetIndices=[],this.targetNormals=[],this.targetUvs=[],this.targetPositions=[]}return _createClass(e,[{key:"startFace",value:function(e,t){this.sourceFaceIndex=e,this.sourceFace=t,this.faceIndices=[]}},{key:"endFace",value:function(){this._addFace(this.faceIndices)}},{key:"addVertex",value:function(e){var t,n=this.sourceFace[e];if(this.addedVertices.hasOwnProperty(n))t=this.addedVertices[n];else{var i=3*n;this.targetPositions.push(this.positions[i]),this.targetPositions.push(this.positions[i+1]),this.targetPositions.push(this.positions[i+2]),t=this.targetPositions.length/3-1,this.addedVertices[n]=t,this._addUv(e),this._addNormal(e)}this.faceIndices.push(t)}},{key:"addIntersection",value:function(e,t,n,i){var r,a=Math.abs(n)/(Math.abs(n)+Math.abs(i)),o=this.sourceFace[e],s=this.sourceFace[t],l=this._intersectionId(o,s);if(this.addedIntersections.hasOwnProperty(l))r=this.addedIntersections[l];else{var u=3*o,c=3*s,h=this.positions[u],d=this.positions[u+1],f=this.positions[u+2];this.targetPositions.push(h+(this.positions[c]-h)*a),this.targetPositions.push(d+(this.positions[c+1]-d)*a),this.targetPositions.push(f+(this.positions[c+2]-f)*a),r=this.targetPositions.length/3-1,this.addedIntersections[l]=r,this._addIntersectionUv(e,t,a),this._addIntersectionNormal(e,t,a)}this.faceIndices.push(r)}},{key:"_addUv",value:function(e){if(this.uvs){var t=2*this._keyIndex(e),n=this.uvs[t],i=this.uvs[t+1];this.targetUvs.push(n),this.targetUvs.push(i)}}},{key:"_addIntersectionUv",value:function(e,t,n){if(this.uvs){var i=2*this._keyIndex(e),r=2*this._keyIndex(t),a=this.uvs[i],o=this.uvs[i+1],s=this.uvs[r],l=this.uvs[r+1],u=a+(s-a)*n,c=o+(l-o)*n
;this.targetUvs.push(u),this.targetUvs.push(c)}}},{key:"_addNormal",value:function(e){if(this.normals){var t=3*this._keyIndex(e);this.targetNormals.push(this.normals[t]),this.targetNormals.push(this.normals[t+1]),this.targetNormals.push(this.normals[t+2])}}},{key:"_addIntersectionNormal",value:function(e,t,n){if(this.normals){var i=3*this._keyIndex(e),r=3*this._keyIndex(t),a=this.normals[i],o=this.normals[i+1],s=this.normals[i+2];this.targetNormals.push(a+(this.normals[r]-a)*n),this.targetNormals.push(o+(this.normals[r+1]-o)*n),this.targetNormals.push(s+(this.normals[r+2]-s)*n)}}},{key:"_addFace",value:function(e){if(3===e.length)return this.targetIndices.push(e[0]),this.targetIndices.push(e[1]),void this.targetIndices.push(e[2]);for(var t=[],n=0;n<e.length;n++)for(var i=n+1;i<e.length;i++){var r=Math.abs(n-i);r>1&&r<e.length-1&&t.push([e[n],e[i]])}t.sort(function(e,t){return this._faceEdgeLength(e[0],e[1])-this._faceEdgeLength(t[0],t[1])}.bind(this));var a=e.indexOf(t[0][0]);e=e.slice(a).concat(e.slice(0,a));var o=e.indexOf(t[0][1]),s=e.slice(0,o+1),l=e.slice(o).concat(e.slice(0,1));this._addFace(s),this._addFace(l)}},{key:"_faceEdgeLength",value:function(e,t){var n=3*this.faceIndices[e],i=3*this.faceIndices[t],r=this.targetPositions[n],a=this.targetPositions[n+1],o=this.targetPositions[n+2],s=this.targetPositions[i],l=this.targetPositions[i+1],u=this.targetPositions[i+2],c=r-s,h=a-l,d=o-u;return c*c+h*h+d*d}},{key:"_intersectionId",value:function(e,t){return[e,t].sort().join(",")}},{key:"_keyIndex",value:function(e){return this.sourceFace[e]}}]),e}();CLOUD.SplitGeometryBuilder=e}(),CLOUD.Math={EPSILON6:1e-6,EPSILON15:1e-15,ONE_Megabytes:1048576,ONE_GIGABYTES:1073741824,mod:function(e,t){return(e%t+t)%t},clamp:function(e,t,n){return e<t?t:e>n?n:e},equalsEpsilon:function(e,t,n,i){i=void 0!==i?i:n;var r=Math.abs(e-t);return r<=i||r<=n*Math.max(Math.abs(e),Math.abs(t))},lessThan:function(e,t,n){return e-t<-n},lessThanOrEquals:function(e,t,n){return e-t<n},greaterThan:function(e,t,n){return e-t>n},greaterThanOrEquals:function(e,t,n){return e-t>-n},incrementWrap:function(e,t,n){return n=void 0!==n?n:0,++e,e>t&&(e=n),e},isPowerOfTwo:function(e){return 0!==e&&0==(e&e-1)},nextPowerOfTwo:function(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},maxComponent:function(e,t){var n=Math.max(Math.abs(e.x),Math.abs(t.x)),i=Math.max(Math.abs(e.y),Math.abs(t.y)),r=Math.max(Math.abs(e.z),Math.abs(t.z));return Math.max(Math.max(n,i),r)},equalsEpsilonVec3:function(e,t,n){return CLOUD.Math.equalsEpsilon(e.x,t.x,n)&&CLOUD.Math.equalsEpsilon(e.y,t.y,n)&&CLOUD.Math.equalsEpsilon(e.z,t.z,n)}},function(){CLOUD.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,activate:function(){CLOUD.debug.isActive=!0},deactivate:function(){CLOUD.debug.isActive=!1},doLog:function(e,t){if(CLOUD.debug.isActive)switch(e){case CLOUD.debug.INFO:console.info(t);break;case CLOUD.debug.WARNING:console.warn(t);break;case CLOUD.debug.ERROR:console.error(t);break;case CLOUD.debug.EXCEPTION:console.debug(t)}},logInfo:function(e){CLOUD.debug.doLog(CLOUD.debug.INFO,e)},logWarning:function(e){CLOUD.debug.doLog(CLOUD.debug.WARNING,e)},logError:function(e){CLOUD.debug.doLog(CLOUD.debug.ERROR,e)},logException:function(e){CLOUD.debug.doLog(CLOUD.debug.EXCEPTION,e)}}}(),function(){CLOUD.Runtime=function(){this.config={},this.isReady=!1,this.fps=0,this.states={measurements:[],infos:[]}},CLOUD.Runtime.prototype.addMeasurement=function(e,t){this.states.measurements[e]=t},CLOUD.Runtime.prototype.removeMeasurement=function(e){this.states.measurements[e]&&delete this.states.measurements[e]},CLOUD.Runtime.prototype.addInfo=function(e,t){this.states.infos[e]=t},CLOUD.Runtime.prototype.removeInfo=function(e){delete this.states.infos[e]},CLOUD.Runtime.prototype.getFPS=function(){return this.fps}}(),function(){function e(e,t){return t-e}var t=function(){function t(){_classCallCheck(this,t),this._listeners=[],this._scopes=[],this._toRemove=[],this._insideFireEvent=!1}return _createClass(t,[{key:"addEventListener",value:function(e,t){this._listeners.push(e),this._scopes.push(t);var n=this;return function(){n.removeEventListener(e,t)}}},{key:"removeEventListener",value:function(e,t){for(var n=this._listeners,i=this._scopes,r=-1,a=0;a<n.length;a++)if(n[a]===e&&i[a]===t){r=a;break}return-1!==r&&(this._insideFireEvent?(this._toRemove.push(r),n[r]=void 0,i[r]=void 0):(n.splice(r,1),i.splice(r,1)),!0)}},{key:"fireEvent",value:function(){this._insideFireEvent=!0;var t,n=this._listeners,i=this._scopes,r=n.length;for(t=0;t<r;t++){n[t]&&n[t].apply(i[t],arguments)}var a=this._toRemove;if((r=a.length)>0){for(a.sort(e),t=0;t<r;t++){var o=a[t];n.splice(o,1),i.splice(o,1)}a.length=0}this._insideFireEvent=!1}}]),t}();CLOUD.Event=t}(),function(){var e=0;CLOUD.EVENTS={ERROR:e++,WEBGL_CONTEXT_LOST:e++,WEBGL_CONTEXT_RESTORED:e++,ON_LOAD_START:e++,ON_LOAD_PROGRESS:e++,ON_LOAD_COMPLETE:e++,ON_LOAD_EMPTY_SCENE:e++,ON_LOAD_INVALID_SCENE:e++,ON_DEMAND_LOAD_START:e++,ON_DEMAND_LOAD_PROGRESS:e++,ON_DEMAND_LOAD_COMPLETE:e++,ON_EDITOR_ENTER:e++,ON_EDITOR_EXIST:e++,ON_EDITOR_BEGIN:e++,ON_EDITOR_END:e++,ON_TOOL_END:e++,ON_EDITOR_UPDATEUI:e++,ON_EDITOR_ZOOM:e++,ON_EDITOR_PANING:e++,ON_EDITOR_ROTATING:e++,ON_EDITOR_WALKING:e++,ON_SELECTION_CHANGED:e++,ON_CLICK_PICK:e++,ON_HOVER_PICK:e++,ON_MEASURE_PICK:e++,ON_SELECTION_FAILED:e++,ON_CLIP_HOVER:e++,ON_HOVER_SNAP:e++,ON_CLIP_MOUSE_MOVE:e++,ON_MOUSE_DRAGGED:e++,ON_CAMERA_CHANGED_AND_RENDERED:e++,ON_VERSION_NO_MATCH:e++,ON_AXIS_GRID_HOVER:e++,ON_VIEWER_RESTORED:e++,ON_CAMERA_HEIGHT_CHANGED:e++,ON_CAMERA_ANIMATION_UPDATE:e++,ON_FLOOR_EXPLOSION:e++,ON_EXPLOSION:e++,ON_PRE_UPDATE:e++,ON_POST_UPDATE:e++,ON_PRE_RENDER:e++,ON_POST_RENDER:e++},CLOUD.EventDispatcher=new THREE.EventDispatcher}(),function(){var e=0;CLOUD.ErrorTypes={ERROR:e++,INVALID_FRAMEBUFFER:e++,WEBGL_NOT_SUPPORTED:e++,WEBGL_CONTEXT_LOST:e++},CLOUD.Error={_getErrorName:function(e){for(var t in CLOUD.ErrorTypes)if(CLOUD.ErrorTypes.hasOwnProperty(t)&&CLOUD.ErrorTypes[t]==e)return t;return null},fatalError:function(e,t){return"string"==typeof e&&(t=e,e=CLOUD.ErrorTypes.ERROR),CLOUD.EventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ERROR,params:{errorName:this._getErrorName(e)||"ERROR",code:e,exception:t,fatal:!0}}),t},error:function(e,t){return CLOUD.EventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ERROR,params:{errorName:this._getErrorName(e)||"ERROR",code:e,exception:t,fatal:!1}}),t}}}(),function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.canvasId=t||0,this.domContainer=n;var i=document.createElement("div");this.domContainer.appendChild(i),this.canvas=this._createHTMLCanvas(i)}return _createClass(e,[{key:"destroy",value:function(){var e=this.canvas.parentNode;e&&(e.removeChild(this.canvas),this.domContainer.removeChild(e),e=null),this.canvas=null,this.domContainer=null}},{key:"addEventListener",value:function(e,t,n){this.canvas.addEventListener(e,t,n)}},{key:"removeEventListener",value:function(e,t,n){this.canvas.removeEventListener(e,t,n)}},{key:"_createHTMLCanvas",value:function(e){var t=document.createElement("canvas");return t.setAttribute("id","cloud-canvas-"+this.canvasId),t.setAttribute("class","cloud-main-canvas"),t.setAttribute("tabindex","0"),e.appendChild(t),t}},{key:"initWebGL",value:function(){for(var t=e.WEBGL_CONTEXT_NAMES,n=0;!this.gl&&n<t.length;n++)try{this.gl=this.canvas.getContext(t[n],this.contextAttr)}catch(e){}if(!this.gl)throw CLOUD.Error.fatalError(CLOUD.ErrorTypes.WEBGL_NOT_SUPPORTED,"Failed to get a WebGL context")}},{key:"loseWebGLContext",value:function(){this.canvas.loseContext()}},{key:"getWidth",value:function(){return this.canvas.width}},{key:"getHeight",value:function(){return this.canvas.height}}]),e}();e.WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],CLOUD.Canvas=e}(),function(){function e(){this.head=void 0,this.tail=void 0,this._length=0}function t(e,t,n){this.item=e,this.previous=t,this.next=n}function n(e,t){t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=void 0,e.tail=t.previous):t.next?(t.next.previous=void 0,e.head=t.next):(e.head=void 0,e.tail=void 0),t.next=void 0,t.previous=void 0}Object.defineProperties(e.prototype,{length:{get:function(){return this._length}}}),e.prototype.add=function(e){var n=new t(e,this.tail,void 0);return this.tail?(this.tail.next=n,this.tail=n):(this.head=n,this.tail=n),++this._length,n},e.prototype.remove=function(e){e&&(n(this,e),--this._length)},e.prototype.splice=function(e,t){if(e!==t){n(this,t);var i=e.next;e.next=t,this.tail===e?this.tail=t:i.previous=t,t.next=i,t.previous=e}},CLOUD.DoublyLinkedList=e}(),CLOUD.Object3DEx=function(e,t){THREE.Object3D.call(this),this.type="Object3DEx",this.geometry=e||CLOUD.GeomUtil.EmptyGeometry,this.material=t||CLOUD.MaterialUtil.getDefaultStandardMaterial(),this.matrixAutoUpdate=!1,this.alive=!1,this.originalId=void 0,this.drawMode=THREE.TrianglesDrawMode},CLOUD.Object3DEx.prototype=Object.create(THREE.Mesh.prototype),CLOUD.Object3DEx.prototype.constructor=CLOUD.Object3DEx,CLOUD.Object3DEx.prototype.init=function(e){e&&e.parent&&e.parent.add(this)},CLOUD.Object3DEx.prototype.destroy=function(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null},CLOUD.Object3DEx.prototype.spawn=function(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),void 0!=e.meshId?this.meshId=e.meshId:this.meshId="",e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),e.databagId?this.databagId=e.databagId:this.databagId="",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),void 0!=e.visible&&(this.visible=e.visible),void 0!=e.isMesh&&(this.isMesh=e.isMesh),void 0!=e.isLine&&(this.isLine=e.isLine),void 0!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),void 0!=e.instanceOrNot?this.instanceOrNot=e.instanceOrNot:this.instanceOrNot=!1,this.renderOrder=e.renderOrder||0,this.alive=!0,this.frustumCulled=!1,this.material.visible=!0},CLOUD.Object3DEx.prototype.clear=function(){this.geometry=CLOUD.GeomUtil.EmptyGeometry,this.material=CLOUD.MaterialUtil.DefaultMaterial,this.alive=!1,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1},CLOUD.Object3DEx.prototype.isVisible=function(){return this.visible&&this.alive},CLOUD.Object3DEx.prototype.intersectBoxWithDistance=function(){var e=new THREE.Box3;return function(t,n){var i=this.geometry,r=this.material,a=this.matrixWorld;return n&&(a=new THREE.Matrix4,a.multiplyMatrices(this.matrixWorld,n)),void 0===r?-1:(i.boundingBox||i.computeBoundingBox(),e.copy(i.boundingBox),e.applyMatrix4(a),t.ray.intersectBoxWithDistance(e))}}(),CLOUD.Object3DEx.prototype.intersectBoxWithDistanceByIndices=function(e,t){var n=this.matrixWorld,i=this.computeBoundingBox(t);return i.applyMatrix4(n),e.ray.intersectBoxWithDistance(i)},CLOUD.Object3DEx.prototype.intersectBoxWithClipPlane=function(e,t){var n=this.matrixWorld,i=this.computeBoundingBox(t);return i.applyMatrix4(n),i.intersectsPlane(e)},CLOUD.Object3DEx.prototype.raycastByIndices=function(){function e(e,t,n,i,r,a,o){return THREE.Triangle.barycoordFromPoint(e,t,n,i,d),r.multiplyScalar(d.x),a.multiplyScalar(d.y),o.multiplyScalar(d.z),r.add(a).add(o),r.clone()}function t(e,t,n,i,r,a,o){var s=e.material;if(null===(s instanceof Array?n.intersectTriangle(i,r,a,!1,o):s.side===THREE.BackSide?n.intersectTriangle(a,r,i,!0,o):n.intersectTriangle(i,r,a,s.side!==THREE.DoubleSide,o)))return null;p.copy(o),p.applyMatrix4(m);var l=t.ray.origin.distanceTo(p);return l<t.near||l>t.far?null:{distance:l,point:p.clone(),object:e}}function n(n,i,r,a,d,p,m,g){o.fromBufferAttribute(a,p),s.fromBufferAttribute(a,m),l.fromBufferAttribute(a,g);var v=t(n,i,r,o,s,l,f);if(v){if(d&&d.array&&d.array.length&&(u.fromBufferAttribute(d,p),c.fromBufferAttribute(d,m),h.fromBufferAttribute(d,g),v.uv=e(f,o,s,l,u,c,h)),a.instanceMatrix){var y=o.clone().applyMatrix4(a.instanceMatrix),E=s.clone().applyMatrix4(a.instanceMatrix),b=l.clone().applyMatrix4(a.instanceMatrix);v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(y,E,b))}else v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(o,s,l));v.faceIndex=p}return v}var i=new THREE.Matrix4,r=new THREE.Ray,a=new THREE.Sphere,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,u=new THREE.Vector2,c=new THREE.Vector2,h=new THREE.Vector2,d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4;return function(e,t,o,s){var l=this.geometry,u=this.material;if(s){var l=this.geometry,u=this.material;if(m=new THREE.Matrix4,m.multiplyMatrices(this.matrixWorld,s),void 0===u)return;if(null===l.boundingSphere&&l.computeBoundingSphere(),a.copy(l.boundingSphere),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;if(i.getInverse(m),r.copy(e.ray).applyMatrix4(i),null!==l.boundingBox&&!1===r.intersectsBox(l.boundingBox))return;var c,h,d,f,p=l.index,g=l.attributes.position;g.instanceMatrix=s;var v,y,E=l.attributes.uv;if(null!==p)for(v=0,y=p.count;v<y;v+=3)h=p.getX(v),d=p.getX(v+1),f=p.getX(v+2),(c=n(this,e,r,g,E,h,d,f))&&(c.faceIndex=Math.floor(v/3),t.push(c));else for(v=0,y=g.count;v<y;v+=3)h=v,d=v+1,f=v+2,(c=n(this,e,r,g,E,h,d,f))&&(c.index=h,t.push(c))}else{if(m=this.matrixWorld,void 0===u)return;if(a.copy(this.computeBoundingSphere(o)),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;i.getInverse(m),r.copy(e.ray).applyMatrix4(i);var b=this.computeBoundingBox(o);if(!1===r.intersectsBox(b))return;var c,h,d,f,v,x,g=l.attributes.position,E=l.attributes.uv,M=o.indexStart,_=o.indexStart+o.indexCount,C=l.getIndex().array;for(v=M,x=_;v<x;v+=3)h=C[v],d=C[v+1],f=C[v+2],(c=n(this,e,r,g,E,h,d,f))&&(c.faceIndex=Math.floor(v/3),t.push(c))}}}(),CLOUD.Object3DEx.prototype.minDistanceToTri=function(e,t,n){function i(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function r(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function a(e,t,n){return new THREE.Vector3(e.x+t.x*n,e.y+t.y*n,e.z+t.z*n)}function o(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function s(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function l(e,t,n,l){var u,c,h=o(t,l),d=o(t,t),f=o(l,l),p=i(n,e),m=o(t,p),g=o(l,p);u=(m*f-g*h)/(d*f-h*h),u<0||isNaN(u)?u=0:u>1&&(u=1),c=(u*h-g)/f;var v,y,E,b;return c<=0||isNaN(c)?(y=n,u=m/d,u<=0||isNaN(u)?(v=e,E=i(n,e)):u>=1?(v=r(e,t),E=i(n,v)):(v=a(e,t,u),b=s(p,t),E=s(t,b))):c>=1?(y=r(n,l),u=(h+m)/d,u<=0||isNaN(u)?(v=e,E=i(y,e)):u>=1?(v=r(e,t),E=i(y,v)):(v=a(e,t,u),p=i(y,e),b=s(p,t),E=s(t,b))):(y=a(n,l,c),u<=0||isNaN(u)?(v=e,b=s(p,l),E=s(l,b)):u>=1?(v=r(e,t),p=i(n,v),b=s(p,l),E=s(l,b)):(v=a(e,t,u),E=s(t,l),o(E,p)<0&&E.multiplyScalar(-1))),{vec:E,closestP:v,closestQ:y}}for(var u,c,h,d,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},v=this.geometry,y=v.attributes.position,E=t?t.indexStart:0,b=v.getIndex().array,x=t?t.indexStart+t.indexCount:b.length,M=E,d=x;M<d;M+=3){u=b[M],c=b[M+1],h=b[M+2];var _=[];!function(e,t,n,i,r,a){f.fromBufferAttribute(t,n),p.fromBufferAttribute(t,i),m.fromBufferAttribute(t,r),a&&(f.applyMatrix4(a),p.applyMatrix4(a),m.applyMatrix4(a)),e.push(f),e.push(p),e.push(m)}(_,y,u,c,h,n);var C=function(e,t){var n,r,u,c=[],h=[];c[0]=i(e[1],e[0]),c[1]=i(e[2],e[1]),c[2]=i(e[0],e[2]),h[0]=i(t[1],t[0]),h[1]=i(t[2],t[1]),h[2]=i(t[0],t[2]);for(var d,f,p,m,g=0,v=e[0].distanceToSquared(t[0])+1,y=0;y<3;y++)for(var E=0;E<3;E++){var b=l(e[y],c[y],t[E],h[E]);u=b.vec,n=b.closestP,r=b.closestQ,d=i(r,n);var x=o(d,d);if(x<=v){p=n.clone(),m=r.clone(),v=x,f=i(e[(y+2)%3],n);var M=o(f,u);f=i(t[(E+2)%3],r);var _=o(f,u);if(M<=0&&_>=0)return{start:n.clone(),end:r.clone(),minDistance:Math.sqrt(x)};var C=o(d,u);M<0&&(M=0),_>0&&(_=0),C-M+_>0&&(g=1)}}var I=s(c[0],c[1]),O=o(I,I);if(O>1e-15){var T=[];d=i(e[0],t[0]),T[0]=o(d,I),d=i(e[0],t[1]),T[1]=o(d,I),d=i(e[0],t[2]),T[2]=o(d,I);var L=-1;if(T[0]>0&&T[1]>0&&T[2]>0?(L=T[0]<T[1]?0:1,T[2]<T[L]&&(L=2)):T[0]<0&&T[1]<0&&T[2]<0&&(L=T[0]>T[1]?0:1,T[2]>T[L]&&(L=2)),L>=0&&(g=1,d=i(t[L],e[0]),f=s(I,c[0]),o(d,f)>0&&(d=i(t[L],e[1]),f=s(I,c[1]),o(d,f)>0&&(d=i(t[L],e[2]),f=s(I,c[2]),o(d,f)>0))))return n=a(t[L],I,T[L]/O),r=t[L].clone(),{start:n.clone(),end:r,minDistance:n.distanceTo(r)}}var S=s(h[0],h[1]),D=o(S,S);if(D>1e-15){var w=[];d=i(t[0],e[0]),w[0]=o(d,S),d=i(t[0],e[1]),w[1]=o(d,S),d=i(t[0],e[2]),w[2]=o(d,S);var L=-1;if(w[0]>0&&w[1]>0&&w[2]>0?(L=w[0]<w[1]?0:1,w[2]<w[L]&&(L=2)):w[0]<0&&w[1]<0&&w[2]<0&&(L=w[0]>w[1]?0:1,w[2]>w[L]&&(L=2)),L>=0&&(g=1,d=i(e[L],t[0]),f=s(S,h[0]),o(d,f)>0&&(d=i(e[L],t[1]),f=s(S,h[1]),o(d,f)>0&&(d=i(e[L],t[2]),f=s(S,h[2]),o(d,f)>0))))return n=e[L].clone(),r=a(e[L],S,w[L]/D),{start:n,end:r.clone(),minDistance:n.distanceTo(r)}}return g?(n=p,r=m,{start:p.clone(),end:m.clone(),minDistance:Math.sqrt(v)}):{start:p.clone(),end:m.clone(),minDistance:0}}(e,_);if(C.minDistance<=0)return g.minDistance=0,g;g.minDistance>C.minDistance&&(g.minDistance=C.minDistance,g.start=C.start.clone(),g.end=C.end.clone())}return g},CLOUD.Object3DEx.prototype.computeBoundingBox=function(e){var t,n,i=new THREE.Box3,r=this.geometry,a=r.attributes.position.array;return e?(t=e.positionStart,n=e.positionStart+e.positionCount):(t=0,n=a.length),this.setBoundingBoxFromArray(i,a,t,n),i},CLOUD.Object3DEx.prototype.computeBoundingSphere=function(e){var t,n,i=new THREE.Box3,r=new THREE.Vector3,a=this.geometry,o=a.attributes.position.array;e?(t=e.positionStart,n=e.positionStart+e.positionCount):(t=0,n=o.length);var s=new THREE.Sphere,l=s.center;this.setBoundingBoxFromArray(i,o,t,n),i.getCenter(l);for(var u=0,c=t,h=n;c<h;c+=3)r.x=o[c],r.y=o[c+1],r.z=o[c+2],u=Math.max(u,l.distanceToSquared(r));return s.radius=Math.sqrt(u),s},CLOUD.Object3DEx.prototype.setBoundingBoxFromArray=function(e,t,n,i){for(var r=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,u=-1/0,c=n,h=i;c<h;c+=3){var d=t[c],f=t[c+1],p=t[c+2];d<r&&(r=d),f<a&&(a=f),p<o&&(o=p),d>s&&(s=d),f>l&&(l=f),p>u&&(u=p)}e.min.set(r,a,o),e.max.set(s,l,u)},CLOUD.MaterialEx=function(){this.materialDefaultParams={color:14540253,opacity:.5,transparent:!0,side:THREE.DoubleSide},this.material=CLOUD.MaterialUtil.createStandardMaterial(this.materialDefaultParams)},CLOUD.MaterialEx.prototype.destroy=function(){this.material=null},CLOUD.MaterialEx.prototype.resetColor=function(){this.material.color.setHex(this.materialDefaultParams.color)},CLOUD.MaterialEx.prototype.resetOpacity=function(){this.material.opacity=this.materialDefaultParams.opacity},CLOUD.MaterialEx.prototype.reset=function(){this.material.color.setHex(this.materialDefaultParams.color),this.material.opacity=this.materialDefaultParams.opacity,this.material.transparent=this.materialDefaultParams.transparent,this.material.side=this.materialDefaultParams.side,this.material.needsUpdate=!0},CLOUD.PointsEx=function(e,t){THREE.Points.call(this,e,t),this.pointIds=[]},CLOUD.PointsEx.prototype=Object.create(THREE.Points.prototype),CLOUD.PointsEx.prototype.constructor=CLOUD.PointsEx,CLOUD.PointsEx.prototype.raycast=function(){var e=new THREE.Matrix4,t=new THREE.Ray,n=new THREE.Sphere;return function(i,r){function a(t,n){var i=t.clone();return i.applyMatrix4(u),i.project(h),i.y+=n/d,i.unproject(h),i.applyMatrix4(e),i}function o(e,n,o){var l=a(e,n),c=l.distanceToSquared(e),h=t.distanceSqToPoint(l);if(h<c){var d=t.closestPointToPoint(l);d.applyMatrix4(u);var p=i.ray.origin.distanceTo(d);if(p<i.near||p>i.far)return;r.push({id:f[o],distance:p,distanceToRay:Math.sqrt(h),point:d.clone(),index:o,face:null,object:s})}}var s=this,l=this.geometry,u=this.matrixWorld,c=this.size,h=i.camera,d=i.viewportSize.height,f=this.pointIds;e.getInverse(u),null===l.boundingSphere&&l.computeBoundingSphere(),n.copy(l.boundingSphere);var p=n.center,m=a(p,c),g=m.distanceToSquared(p);if(n.radius+=g,n.center.copy(m),n.applyMatrix4(u),!1!==i.ray.intersectsSphere(n)){t.copy(i.ray).applyMatrix4(e);var v=new THREE.Vector3,y=c;if(l.isBufferGeometry){var E,b=l.index,x=l.attributes,M=x.position.array,_=!1;if(x.attrSize&&(_=!0,E=x.attrSize.array),null!==b)for(var C=b.array,I=0,O=C.length;I<O;I++){var T=C[I];v.fromArray(M,3*T),_&&(y=E[T]),o(v,y,T)}else for(var I=0,L=M.length/3;I<L;I++)v.fromArray(M,3*I),_&&(y=E[I]),o(v,y,I)}else for(var S=l.vertices,I=0,L=S.length;I<L;I++)o(S[I],y,I)}}}(),CLOUD.PointsEx.prototype.setAttributeSize=function(e,t){var n=this.geometry.attributes;n.attrSize&&(n.attrSize.array[e]=t,n.attrSize.needsUpdate=!0)},CLOUD.PointsEx.prototype.getAttributeSize=function(e){var t=this.geometry.attributes,n=this.size;return t.attrSize&&(n=t.attrSize.array[e]),n},CLOUD.MeshEx=function(e,t){e=e||CLOUD.GeomUtil.EmptyGeometry,t=t||CLOUD.MaterialUtil.getDefaultStandardMaterial(),THREE.Mesh.call(this,e,t),this.type="MeshEx",this.matrixAutoUpdate=!1,this.alive=!1,this.originalId=void 0,this.pickable=!0},CLOUD.MeshEx.prototype=Object.create(THREE.Mesh.prototype),CLOUD.MeshEx.prototype.constructor=CLOUD.MeshEx,CLOUD.MeshEx.prototype.init=function(e){e&&e.parent&&e.parent.add(this)},CLOUD.MeshEx.prototype.destroy=function(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null},CLOUD.MeshEx.prototype.spawn=function(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),e.databagId?this.databagId=e.databagId:this.databagId="",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),void 0!=e.visible&&(this.visible=e.visible),void 0!=e.isMesh&&(this.isMesh=e.isMesh),void 0!=e.isLine&&(this.isLine=e.isLine),void 0!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),void 0!=e.pickable?this.pickable=e.pickable:this.pickable=!0,this.renderOrder=e.renderOrder||0,this.alive=!0,this.frustumCulled=!1,this.material.visible=!0},CLOUD.MeshEx.prototype.clear=function(){this.geometry=CLOUD.GeomUtil.EmptyGeometry,this.material=CLOUD.MaterialUtil.DefaultMaterial,this.alive=!1,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1},CLOUD.MeshEx.prototype.isVisible=function(){return this.visible&&this.alive},CLOUD.MeshEx.prototype.intersectBoxWithDistance=function(){var e=new THREE.Box3;return function(t,n){var i=this.geometry,r=this.material,a=this.matrixWorld;return n&&(a=new THREE.Matrix4,a.multiplyMatrices(this.matrixWorld,n)),void 0===r?-1:(i.boundingBox||i.computeBoundingBox(),e.copy(i.boundingBox),e.applyMatrix4(a),t.ray.intersectBoxWithDistance(e))}}(),CLOUD.MeshEx.prototype.intersectBoxWithDistanceByIndices=function(e,t){var n=this.matrixWorld,i=this.computeBoundingBox(t);return i.applyMatrix4(n),e.ray.intersectBoxWithDistance(i)},CLOUD.MeshEx.prototype.intersectBoxWithClipPlane=function(e,t){var n=this.matrixWorld,i=t.boundingBox.clone();return i.applyMatrix4(n),i.intersectsPlane(e)},CLOUD.MeshEx.prototype.getIntersectionPoints=function(e,t,n,i){function r(e,t){var i=t.intersectLine(e);i&&n.push(i.x,i.y,i.z)}var a=new THREE.Matrix4;a.getInverse(this.matrixWorld);var o=e.clone();o.constant*=-1,o=o.applyMatrix4(a);for(var s,l,u,c=(n.length,this.geometry.getIndex().array),h=this.geometry.getAttribute("position").array,d=i?0:t.indexStart,f=i?c.length:t.indexStart+t.indexCount,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Line3,y=new THREE.Line3,E=new THREE.Line3,b=d,x=f;b<x;b+=3)s=3*c[b],l=3*c[b+1],u=3*c[b+2],p.set(h[s],h[s+1],h[s+2]),m.set(h[l],h[l+1],h[l+2]),g.set(h[u],h[u+1],h[u+2]),i&&(p.applyMatrix4(t.matrix),m.applyMatrix4(t.matrix),g.applyMatrix4(t.matrix)),v.set(p,m),y.set(m,g),E.set(g,p),r(v,o),r(y,o),r(E,o)},CLOUD.MeshEx.prototype.raycastByIndices=function(){function e(e,t,n,i,r,a,o){return THREE.Triangle.barycoordFromPoint(e,t,n,i,d),r.multiplyScalar(d.x),a.multiplyScalar(d.y),o.multiplyScalar(d.z),r.add(a).add(o),r.clone()}function t(e,t,n,i,r,a,o){var s=e.material;if(null===(s instanceof Array?n.intersectTriangle(i,r,a,!1,o):s.side===THREE.BackSide?n.intersectTriangle(a,r,i,!0,o):n.intersectTriangle(i,r,a,s.side!==THREE.DoubleSide,o)))return null;p.copy(o),p.applyMatrix4(m);var l=t.ray.origin.distanceTo(p);return l<t.near||l>t.far?null:{distance:l,point:p.clone(),object:e}}function n(n,i,r,a,d,p,m,g){o.fromBufferAttribute(a,p),s.fromBufferAttribute(a,m),l.fromBufferAttribute(a,g);var v=t(n,i,r,o,s,l,f);if(v){if(d&&d.array&&d.array.length&&(u.fromBufferAttribute(d,p),c.fromBufferAttribute(d,m),h.fromBufferAttribute(d,g),v.uv=e(f,o,s,l,u,c,h)),a.instanceMatrix){var y=o.clone().applyMatrix4(a.instanceMatrix),E=s.clone().applyMatrix4(a.instanceMatrix),b=l.clone().applyMatrix4(a.instanceMatrix);v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(y,E,b))}else v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(o,s,l));v.faceIndex=p}return v}var i=new THREE.Matrix4,r=new THREE.Ray,a=new THREE.Sphere,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,u=new THREE.Vector2,c=new THREE.Vector2,h=new THREE.Vector2,d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4;return function(e,t,o,s,l){var u=this.geometry,c=this.material;if(s){var u=this.geometry,c=this.material;if(m=new THREE.Matrix4,m.multiplyMatrices(this.matrixWorld,s),void 0===c)return;if(null===u.boundingSphere&&u.computeBoundingSphere(),a.copy(u.boundingSphere),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;if(i.getInverse(m),r.copy(e.ray).applyMatrix4(i),null!==u.boundingBox&&!1===r.intersectsBox(u.boundingBox))return;var h,d,f,p,g=u.index,v=u.attributes.position;v.instanceMatrix=s;var y,E,b=u.attributes.uv;if(null!==g)for(y=0,E=g.count;y<E;y+=3)d=g.getX(y),f=g.getX(y+1),p=g.getX(y+2),(h=n(this,e,r,v,b,d,f,p))&&(h.faceIndex=Math.floor(y/3),t.push(h));else for(y=0,E=v.count;y<E;y+=3)d=y,f=y+1,p=y+2,(h=n(this,e,r,v,b,d,f,p))&&(h.index=d,t.push(h))}else{if(m=this.matrixWorld,void 0===c)return;if(a.copy(this.computeBoundingSphere(o)),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;i.getInverse(m),r.copy(e.ray).applyMatrix4(i);var x=this.computeBoundingBox(o);if(!1===r.intersectsBox(x))return;var h,d,f,p,y,M,v=u.attributes.position,b=u.attributes.uv,_=o.indexStart,C=o.indexStart+o.indexCount,I=u.getIndex().array;for(y=_,M=C;y<M;y+=3)d=I[y],f=I[y+1],p=I[y+2],(h=n(this,e,r,v,b,d,f,p))&&(h.faceIndex=Math.floor(y/3),t.push(h))}}}(),CLOUD.MeshEx.prototype.raycastByIndices2=function(){function e(e,t,n,i,r,a,o){return THREE.Triangle.barycoordFromPoint(e,t,n,i,d),r.multiplyScalar(d.x),a.multiplyScalar(d.y),o.multiplyScalar(d.z),r.add(a).add(o),r.clone()}function t(e,t,n,i,r,a,o){var s=e.material;if(null===(s instanceof Array?n.intersectTriangle(i,r,a,!1,o):s.side===THREE.BackSide?n.intersectTriangle(a,r,i,!0,o):n.intersectTriangle(i,r,a,s.side!==THREE.DoubleSide,o)))return null;p.copy(o),p.applyMatrix4(m);var l=t.ray.origin.distanceTo(p);return l<t.near||l>t.far?null:{distance:l,point:p.clone(),object:e}}function n(n,i,r,a,d,p,m,g){o.fromBufferAttribute(a,p),s.fromBufferAttribute(a,m),l.fromBufferAttribute(a,g);var v=t(n,i,r,o,s,l,f);if(v){if(d&&d.array&&d.array.length&&(u.fromBufferAttribute(d,p),c.fromBufferAttribute(d,m),h.fromBufferAttribute(d,g),v.uv=e(f,o,s,l,u,c,h)),a.instanceMatrix){var y=o.clone().applyMatrix4(a.instanceMatrix),E=s.clone().applyMatrix4(a.instanceMatrix),b=l.clone().applyMatrix4(a.instanceMatrix);v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(y,E,b))}else v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(o,s,l));v.faceIndex=p}return v}var i=new THREE.Matrix4,r=new THREE.Ray,a=new THREE.Sphere,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,u=new THREE.Vector2,c=new THREE.Vector2,h=new THREE.Vector2,d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4;return function(e,t,o,s){var l=this.geometry,u=this.material;if(s=!!s,o.isInstanced){if(void 0===o.matrix)return;if(m.multiplyMatrices(this.matrixWorld,o.matrix),void 0===u)return;if(s&&(null===l.boundingSphere&&l.computeBoundingSphere(),a.copy(l.boundingSphere),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a)))return;if(i.getInverse(m),r.copy(e.ray).applyMatrix4(i),s&&null!==l.boundingBox&&!1===r.intersectsBox(l.boundingBox))return;var c,h,d,f,p=l.index,g=l.attributes.position;g.instanceMatrix=o.matrix;var v,y,E=l.attributes.uv;if(null!==p)for(v=0,y=p.count;v<y;v+=3)h=p.getX(v),d=p.getX(v+1),f=p.getX(v+2),(c=n(this,e,r,g,E,h,d,f))&&(c.faceIndex=Math.floor(v/3),t.push(c));else for(v=0,y=g.count;v<y;v+=3)h=v,d=v+1,f=v+2,(c=n(this,e,r,g,E,h,d,f))&&(c.index=h,t.push(c))}else if(o.matrix?m.multiplyMatrices(this.matrixWorld,o.matrix):m=this.matrixWorld,void 0!==u&&(!s||(a.copy(this.computeBoundingSphere(o)),a.applyMatrix4(m),!1!==e.ray.intersectsSphere(a)))){if(i.getInverse(m),r.copy(e.ray).applyMatrix4(i),s){var b=this.computeBoundingBox(o);if(!1===r.intersectsBox(b))return}var c,h,d,f,v,x,g=l.attributes.position,E=l.attributes.uv,M=o.indexStart,_=o.indexStart+o.indexCount,C=l.getIndex().array;for(v=M,x=_;v<x;v+=3)h=C[v],d=C[v+1],f=C[v+2],(c=n(this,e,r,g,E,h,d,f))&&(c.faceIndex=Math.floor(v/3),t.push(c))}}}(),CLOUD.MeshEx.prototype.computeBoundingBox=function(e){var t,n,i=new THREE.Box3,r=this.geometry,a=r.attributes.position.array;return e?(t=e.positionStart,n=e.positionStart+e.positionCount):(t=0,n=a.length),this.setBoundingBoxFromArray(i,a,t,n),i},CLOUD.MeshEx.prototype.computeBoundingSphere=function(e){var t,n,i=new THREE.Box3,r=new THREE.Vector3,a=this.geometry,o=a.attributes.position.array;e?(t=e.positionStart,n=e.positionStart+e.positionCount):(t=0,n=o.length);var s=new THREE.Sphere,l=s.center;this.setBoundingBoxFromArray(i,o,t,n),i.getCenter(l);for(var u=0,c=t,h=n;c<h;c+=3)r.x=o[c],r.y=o[c+1],r.z=o[c+2],u=Math.max(u,l.distanceToSquared(r));return s.radius=Math.sqrt(u),s},CLOUD.MeshEx.prototype.setBoundingBoxFromArray=function(e,t,n,i){for(var r=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,u=-1/0,c=n,h=i;c<h;c+=3){var d=t[c],f=t[c+1],p=t[c+2];d<r&&(r=d),f<a&&(a=f),p<o&&(o=p),d>s&&(s=d),f>l&&(l=f),p>u&&(u=p)}e.min.set(r,a,o),e.max.set(s,l,u)},function(){var e=new THREE.Box3,t=new THREE.Matrix4,n=new THREE.Ray,i=new THREE.Sphere,r=function(r){function a(e,t){_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e,t));return n.type="LineSegmentsEx",n}return _inherits(a,r),_createClass(a,[{key:"init",value:function(e){}},{key:"destroy",value:function(){}},{key:"intersectBoxWithDistance",value:function(t,n){var i=this.geometry,r=this.matrixWorld;return n&&(r=this.matrixWorld.clone(),r.multiplyMatrices(this.matrixWorld,n)),i.boundingBox||i.computeBoundingBox(),e.copy(i.boundingBox),e.applyMatrix4(r),t.ray.intersectBoxWithDistance(e)}},{key:"intersectBoxWithDistanceByIndices",value:function(e,t){var n=this.geometry.attributes.position.array,i=0,r=n.length;t&&t.indexCount>0&&(i=t.positionStart,r=t.positionStart+t.positionCount);var a=CLOUD.Utils.box3FromArrayRange(n,i,r);return a.applyMatrix4(this.matrixWorld),e.ray.intersectBoxWithDistance(a)}},{key:"raycastByIndices",value:function(e,r,a,o){var s=e.linePrecision;e.linePrecision=CLOUD.GlobalData.LineSelectRange;var l,u=e.linePrecision,c=u*u;o?(l=this.matrixWorld.clone(),l.multiplyMatrices(this.matrixWorld,o)):l=this.matrixWorld;var h=this.geometry;if(null===h.boundingSphere&&h.computeBoundingSphere(),i.copy(h.boundingSphere),i.applyMatrix4(l),!1!==e.ray.intersectsSphere(i)){t.getInverse(l),n.copy(e.ray).applyMatrix4(t);var d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=h.attributes.position.array,v=h.index.array,y=0,E=v.length;a&&a.indexCount>0&&(y=a.indexStart,E=a.indexStart+a.indexCount);for(var b=y;b<E-1;b+=2){var x=v[b],M=v[b+1];d.fromArray(g,3*x),f.fromArray(g,3*M)
;if(!(n.distanceSqToSegment(d,f,m,p)>c)){m.applyMatrix4(l);var _=e.ray.origin.distanceTo(m);_<e.near||_>e.far||r.push({distance:_,point:p.clone().applyMatrix4(l),index:b,face:null,faceIndex:null,object:this})}}e.linePrecision=s}}}]),a}(THREE.LineSegments);CLOUD.LineSegmentsEx=r}(),function(){function e(e,t){THREE.LineSegments.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new THREE.Matrix4,this.bindMatrixInverse=new THREE.Matrix4;var n=this.initBones(),i=new THREE.Skeleton(n);this.bind(i,this.matrixWorld),this.normalizeSkinWeights()}e.prototype=Object.assign(Object.create(THREE.LineSegments.prototype),{constructor:e,isSkinnedMesh:!0,initBones:function(){var e,t,n,i,r=[];if(this.geometry&&void 0!==this.geometry.bones){for(n=0,i=this.geometry.bones.length;n<i;n++)t=this.geometry.bones[n],e=new THREE.Bone,r.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(n=0,i=this.geometry.bones.length;n<i;n++)t=this.geometry.bones[n],-1!==t.parent&&null!==t.parent&&void 0!==r[t.parent]?r[t.parent].add(r[n]):this.add(r[n])}return this.updateMatrixWorld(!0),r},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var n=this.geometry.skinWeights[t];e=1/n.lengthManhattan(),e!==1/0?n.multiplyScalar(e):n.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var i=new THREE.Vector4,r=this.geometry.attributes.skinWeight;for(t=0;t<r.count;t++)i.x=r.getX(t),i.y=r.getY(t),i.z=r.getZ(t),i.w=r.getW(t),e=1/i.lengthManhattan(),e!==1/0?i.multiplyScalar(e):i.set(1,0,0,0),r.setXYZW(t,i.x,i.y,i.z,i.w)}},updateMatrixWorld:function(e){THREE.LineSegments.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),CLOUD.SkinnedLineEx=e}(),THREE.LineSegmentsGeometry=function(){THREE.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";var e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],n=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(n),this.addAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.addAttribute("uv",new THREE.Float32BufferAttribute(t,2))},THREE.LineSegmentsGeometry.prototype=Object.assign(Object.create(THREE.InstancedBufferGeometry.prototype),{constructor:THREE.LineSegmentsGeometry,isLineSegmentsGeometry:!0,applyMatrix:function(e){var t=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==t&&(e.applyToBufferAttribute(t),e.applyToBufferAttribute(n),t.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var n=new THREE.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceStart",new THREE.InterleavedBufferAttribute(n,3,0)),this.addAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var n=new THREE.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(n,3,0)),this.addAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(n,3,3)),this},fromWireframeGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromEdgesGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromMesh:function(e){return this.fromWireframeGeometry(new THREE.WireframeGeometry(e.geometry)),this},fromLineSegments:function(e){var t=e.geometry;if(t.isGeometry)this.setPositions(t.vertices);else if(t.isBufferGeometry)if(null===t.index)this.setPositions(t.position.array);else{for(var n=t.index.array,i=t.attributes.position.array,r=t.attributes.position.itemSize,a=new i.constructor(n.length*r),o=0,s=0,l=0,u=n.length;l<u;l++){o=n[l]*r;for(var c=0;c<r;c++)a[s++]=i[o++]}this.setPositions(a)}return this},fromLine:function(e){var t,n=e.geometry;n.isGeometry?t=n.vertices:n.isBufferGeometry&&(t=n.attributes.position.array);for(var i=t.length-3,r=new Float32Array(2*i),a=0;a<i;a+=3)r[2*a]=t[a],r[2*a+1]=t[a+1],r[2*a+2]=t[a+2],r[2*a+3]=t[a+3],r[2*a+4]=t[a+4],r[2*a+5]=t[a+5];return this.setPositions(r),this},fromLineLoop:function(e){var t,n=line.geometry;n.isGeometry?t=n.vertices:n.isBufferGeometry&&(t=n.attributes.position.array);for(var i=t.length,r=new Float32Array(2*i),a=0;a<i;a+=3)a<i-3?(r[2*a]=t[a],r[2*a+1]=t[a+1],r[2*a+2]=t[a+2],r[2*a+3]=t[a+3],r[2*a+4]=t[a+4],r[2*a+5]=t[a+5]):(r[2*a]=t[a],r[2*a+1]=t[a+1],r[2*a+2]=t[a+2],r[2*a+3]=t[0],r[2*a+4]=t[1],r[2*a+5]=t[2]);return this.setPositions(r),this},computeBoundingBox:function(){var e=new THREE.Box3;return function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var t=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==t&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(t),e.setFromBufferAttribute(n),this.boundingBox.union(e))}}(),computeBoundingSphere:function(){var e=new THREE.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==t&&void 0!==n){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var r=0,a=0,o=t.count;a<o;a++)e.fromBufferAttribute(t,a),r=Math.max(r,i.distanceToSquared(e)),e.fromBufferAttribute(n,a),r=Math.max(r,i.distanceToSquared(e));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}}(),toJSON:function(){},clone:function(){},copy:function(e){return this}}),THREE.LineGeometry=function(){THREE.LineSegmentsGeometry.call(this),this.type="LineGeometry"},THREE.LineGeometry.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.LineGeometry,isLineGeometry:!0,setPositions:function(e){for(var t=e.length-3,n=new Float32Array(2*t),i=0;i<t;i+=3)n[2*i]=e[i],n[2*i+1]=e[i+1],n[2*i+2]=e[i+2],n[2*i+3]=e[i+3],n[2*i+4]=e[i+4],n[2*i+5]=e[i+5];return THREE.LineSegmentsGeometry.prototype.setPositions.call(this,n),this},setColors:function(e){for(var t=e.length-3,n=new Float32Array(2*t),i=0;i<t;i+=3)n[2*i]=e[i],n[2*i+1]=e[i+1],n[2*i+2]=e[i+2],n[2*i+3]=e[i+3],n[2*i+4]=e[i+4],n[2*i+5]=e[i+5];return THREE.LineSegmentsGeometry.prototype.setColors.call(this,n),this},fromLine:function(e){var t=e.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this},copy:function(e){return this}}),THREE.LineSegments2=function(e,t){THREE.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.LineSegments2.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.LineSegments2,isLineSegments2:!0,computeLineDistances:function(){var e=new THREE.Vector3,t=new THREE.Vector3;return function(){for(var n=this.geometry,i=n.attributes.instanceStart,r=n.attributes.instanceEnd,a=new Float32Array(2*i.data.count),o=0,s=0,l=i.data.count;o<l;o++,s+=2)e.fromBufferAttribute(i,o),t.fromBufferAttribute(r,o),a[s]=0===s?0:a[s-1],a[s+1]=a[s]+e.distanceTo(t);var u=new THREE.InstancedInterleavedBuffer(a,2,1);return n.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(u,1,0)),n.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(u,1,1)),this}}(),copy:function(e){return this},raycast:function(){var e=new THREE.Vector4,t=new THREE.Vector4,n=new THREE.Vector4,i=new THREE.Vector3,r=new THREE.Matrix4,a=new THREE.Line3,o=new THREE.Vector3;return function(s,l){null===s.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var u=s.ray,c=s.camera,h=c.projectionMatrix,d=this.geometry,f=this.material,p=f.resolution,m=f.linewidth,g=d.attributes.instanceStart,v=d.attributes.instanceEnd;u.at(1,n),n.w=1,n.applyMatrix4(c.matrixWorldInverse),n.applyMatrix4(h),n.multiplyScalar(1/n.w),n.x*=p.x/2,n.y*=p.y/2,n.z=0,i.copy(n);var y=this.matrixWorld;r.multiplyMatrices(c.matrixWorldInverse,y);for(var E=0,b=g.count;E<b;E++){e.fromBufferAttribute(g,E),t.fromBufferAttribute(v,E),e.w=1,t.w=1,e.applyMatrix4(r),t.applyMatrix4(r),e.applyMatrix4(h),t.applyMatrix4(h),e.multiplyScalar(1/e.w),t.multiplyScalar(1/t.w);var x=e.z<-1&&t.z<-1,M=e.z>1&&t.z>1;if(!x&&!M){e.x*=p.x/2,e.y*=p.y/2,t.x*=p.x/2,t.y*=p.y/2,a.start.copy(e),a.start.z=0,a.end.copy(t),a.end.z=0;var _=a.closestPointToPointParameter(i,!0);a.at(_,o);var C=THREE.Math.lerp(e.z,t.z,_),I=C>=-1&&C<=1,O=i.distanceTo(o)<.5*m;if(I&&O){a.start.fromBufferAttribute(g,E),a.end.fromBufferAttribute(v,E),a.start.applyMatrix4(y),a.end.applyMatrix4(y);var T=new THREE.Vector3,L=new THREE.Vector3;u.distanceSqToSegment(a.start,a.end,L,T),l.push({point:L,pointOnLine:T,distance:u.origin.distanceTo(L),object:this,face:null,faceIndex:E,uv:null,uv2:null})}}}}}()}),THREE.Line2=function(e,t){THREE.LineSegments2.call(this),this.type="Line2",this.geometry=void 0!==e?e:new THREE.LineGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Line2.prototype=Object.assign(Object.create(THREE.LineSegments2.prototype),{constructor:THREE.Line2,isLine2:!0,copy:function(e){return this}}),THREE.UniformsLib.line={linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\t\t\t#include <logdepthbuf_vertex>\n\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"},THREE.LineMaterial=function(e){THREE.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}}}),this.setValues(e)},THREE.LineMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),THREE.LineMaterial.prototype.constructor=THREE.LineMaterial,THREE.LineMaterial.prototype.isLineMaterial=!0,THREE.LineMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.resolution=e.resolution,this},THREE.Wireframe=function(e,t){THREE.Mesh.call(this),this.type="Wireframe",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Wireframe.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.Wireframe,isWireframe:!0,computeLineDistances:function(){var e=new THREE.Vector3,t=new THREE.Vector3;return function(){for(var n=this.geometry,i=n.attributes.instanceStart,r=n.attributes.instanceEnd,a=new Float32Array(2*i.data.count),o=0,s=0,l=i.data.count;o<l;o++,s+=2)e.fromBufferAttribute(i,o),t.fromBufferAttribute(r,o),a[s]=0===s?0:a[s-1],a[s+1]=a[s]+e.distanceTo(t);var u=new THREE.InstancedInterleavedBuffer(a,2,1);return n.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(u,1,0)),n.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(u,1,1)),this}}(),copy:function(e){return this}}),THREE.WireframeGeometry2=function(e){THREE.LineSegmentsGeometry.call(this),this.type="WireframeGeometry2",this.fromWireframeGeometry(new THREE.WireframeGeometry(e))},THREE.WireframeGeometry2.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.WireframeGeometry2,isWireframeGeometry2:!0,copy:function(e){return this}}),CLOUD.BBoxNode=function(e,t){var n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(new Float32Array(72),3)),THREE.LineSegments.call(this,n,new THREE.LineBasicMaterial({color:t})),void 0!==e&&this.updateBBox(e)},CLOUD.BBoxNode.prototype=Object.create(THREE.LineSegments.prototype),CLOUD.BBoxNode.prototype.constructor=CLOUD.BBoxNode,CLOUD.BBoxNode.prototype.unload=function(){},CLOUD.BBoxNode.prototype.updateBBox=function(e){var t=e.min,n=e.max,i=this.geometry.attributes.position.array;i[0]=n.x,i[1]=n.y,i[2]=n.z,i[3]=t.x,i[4]=n.y,i[5]=n.z,i[6]=t.x,i[7]=n.y,i[8]=n.z,i[9]=t.x,i[10]=t.y,i[11]=n.z,i[12]=t.x,i[13]=t.y,i[14]=n.z,i[15]=n.x,i[16]=t.y,i[17]=n.z,i[18]=n.x,i[19]=t.y,i[20]=n.z,i[21]=n.x,i[22]=n.y,i[23]=n.z,i[24]=n.x,i[25]=n.y,i[26]=t.z,i[27]=t.x,i[28]=n.y,i[29]=t.z,i[30]=t.x,i[31]=n.y,i[32]=t.z,i[33]=t.x,i[34]=t.y,i[35]=t.z,i[36]=t.x,i[37]=t.y,i[38]=t.z,i[39]=n.x,i[40]=t.y,i[41]=t.z,i[42]=n.x,i[43]=t.y,i[44]=t.z,i[45]=n.x,i[46]=n.y,i[47]=t.z,i[48]=n.x,i[49]=n.y,i[50]=n.z,i[51]=n.x,i[52]=n.y,i[53]=t.z,i[54]=t.x,i[55]=n.y,i[56]=n.z,i[57]=t.x,i[58]=n.y,i[59]=t.z,i[60]=t.x,i[61]=t.y,i[62]=n.z,i[63]=t.x,i[64]=t.y,i[65]=t.z,i[66]=n.x,i[67]=t.y,i[68]=n.z,i[69]=n.x,i[70]=t.y,i[71]=t.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.matrixAutoUpdate=!1},CLOUD.ObjectPool=function(e,t){this.cls=e,this.size=t,this._pool=[],this.counter=0},CLOUD.ObjectPool.prototype.init=function(e){for(var t=0,n=this.size;t<n;++t){var i=new this.cls;i.init(e),this._pool[t]=i}},CLOUD.ObjectPool.prototype.resize=function(e,t){this.size=e,this.collect(),this.init(t)},CLOUD.ObjectPool.prototype.get=function(e){if(this.counter>=this.size)return null;var t=this._pool[this.counter];return t.spawn(e),++this.counter,t},CLOUD.ObjectPool.prototype.clear=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].clear();this.counter=0},CLOUD.ObjectPool.prototype.destroy=function(){this.collect()},CLOUD.ObjectPool.prototype.collect=function(){this._pool=[],this.counter=0},CLOUD.ObjectPool.prototype.getObjects=function(){return this._pool},CLOUD.ExpandableObjectPool=function(){this.size=0,this.counter=0,this.expansion=1,this._pool=null},CLOUD.ExpandableObjectPool.prototype.init=function(e,t){this.classType=e,this._pool=[],this._expand(t)},CLOUD.ExpandableObjectPool.prototype._expand=function(e){this.size+=e;for(var t=0;t<e;t++)this._pool.push(new this.classType)},CLOUD.ExpandableObjectPool.prototype.acquire=function(){return this.counter>=this.size&&(this.expansion=Math.round(1.2*this.expansion)+1,this._expand(this.expansion),console.log("_expand")),this._pool[this.counter++]},CLOUD.ExpandableObjectPool.prototype.clear=function(){this.counter=0},CLOUD.ExpandableObjectPool.prototype.destroy=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].destroy();this.counter=0,this.size=0,this.expansion=1,this._pool=null},CLOUD.ExpandableObjectPool.prototype.getObjects=function(){return this._pool},CLOUD.ObjectGroup=function(e,t){THREE.Group.call(this),this.name=e,this.priority=t&&t.priority?t.priority:5,this.pickableType=t&&t.pickableType?t.pickableType:CLOUD.PICKABLETYPE.UnPickable,this.globalSpace=!(!t||!t.globalSpace)&&t.globalSpace,this.boundingBox=null,this.hoverEnabled=!(!t||!t.hoverEnabled)&&t.hoverEnabled},CLOUD.ObjectGroup.prototype=Object.create(THREE.Group.prototype),CLOUD.ObjectGroup.prototype.constructor=CLOUD.ObjectGroup,CLOUD.ObjectGroup.prototype.removeByName=function(e){for(var t=this.children,n=0,i=t.length;n<i;++n)if(t[n].name===e){t.splice(n,1);break}},CLOUD.ObjectGroup.prototype.clear=function(){this.children.length=0},CLOUD.ObjectGroup.prototype.isGlobalSpace=function(){return this.globalSpace},CLOUD.ObjectGroup.prototype.hasChild=function(e){for(var t=0,n=this.children.length;t<n;t++)if(this.children[t].name==e)return!0;return!1},CLOUD.ObjectGroup.prototype.isPickable=function(){return this.pickableType!==CLOUD.PICKABLETYPE.UnPickable},CLOUD.ObjectGroup.prototype.raycast=function(e,t){for(var n=0,i=this.children.length;n<i;n++){var r=this.children[n];if(CLOUD.Utils.isGroupObject(r)){var a=r.name;r.traverseVisible(function(n){CLOUD.Utils.isMeshObject(n)&&(void 0===n.userId&&(n.userId=a),n.raycast(e,t))})}else r.visible&&r.raycast(e,t)}},CLOUD.ObjectGroupType={MODEL:"Model",GEOMETRY:"Geometry",LINESEGMENTS:"LineSegments",INSTANCEGEOMETRY:"InstanceGeometry",INSTANCEWIREFRAMEGEOMETRY:"InstanceWireframeGeometry",WIREFRAME:"Wireframe",MARKER3D:"Marker3D",CLIPPLANE:"ClipPlane",FILLCLIPPLANE:"FillClipPlane",CAPSWIREFRAME:"CapsWireframe",IBLCUBE:"IBLCube",CUSTOMPLANE:"CustomPlane",PIVOTBALL:"PivotBall",MEASUREPICKPOINT:"MeasurePickPoint",MEASUREPICKLINE:"MeasurePickLine",MEASUREPLANE:"MeasurePlane",MEASURELINE:"MeasureLine",OCTREENODE:"OctreeNode",BOUNDARYEDGEMANAGER:"BoundaryEdgeManager",AXISGRIDMANAGER:"AxisGridManager",EXTRUDEBODYMANAGER:"ExtrudeBodyManager",EXTERNALCOMPONENTMANAGER:"ExternalComponentManager",TILEGROUP:"TileGroup",ROADNETWORK:"RoadNetworkGroup",RECEIVESHADOWPLANE:"ReceiveShadowPlane"},CLOUD.Scene=function(){THREE.Object3D.call(this),this.type="Scene",this.autoUpdate=!1,this.objectGroups=new CLOUD.ObjectGroup,this.add(this.objectGroups),this.geometryGroup=new CLOUD.ObjectGroup(CLOUD.ObjectGroupType.GEOMETRY,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroups.add(this.geometryGroup),this.pool=new CLOUD.ObjectPool(CLOUD.MeshEx,0),this.expandScalar=1.02,this.clipPlanes=null,this.fillClipPlane=null,this.boundaryEdge=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.customPlaneManager=null,this.axisGridManager=null,this.IBLMaps=new ImageBasedLighting.IBLMaps,this.transformMatrix=new THREE.Matrix4,this.lightArray=[],this.lightHelperArray=[],this.lightHelper=!1,this.lightPreset(),this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedInstanceMeshes=[],this.nonSelectedInstanceMeshes=[]},CLOUD.Scene.prototype=Object.create(THREE.Object3D.prototype),CLOUD.Scene.prototype.constructor=CLOUD.Scene,CLOUD.Scene.prototype.createCapStencilMaterials=function(){this.backMaterial||(this.backMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.frontMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.backInstanceMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.backInstanceMaterial.defines.USE_INSTANCE="",this.backInstanceMaterial.defines.USE_INSTANCE_NORMAL="",this.frontInstanceMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.frontInstanceMaterial.defines.USE_INSTANCE="",this.frontInstanceMaterial.defines.USE_INSTANCE_NORMAL="")},CLOUD.Scene.prototype.destroy=function(){this.clearLight(),this.clearLightHelper(),this.sunLight&&(this.remove(this.sunLight),this.sunLight=null),this.fillLight0&&(this.remove(this.fillLight0),this.fillLight0=null),this.fillLight1&&(this.remove(this.fillLight1),this.fillLight1=null),this.fillLight2&&(this.remove(this.fillLight2),this.fillLight2=null),this.hemisphereLight&&(this.remove(this.hemisphereLight),this.hemisphereLight=null),this.dirLight&&(this.remove(this.dirLight),this.dirLight=null),this.clearAll(),this.pool.destroy(),this.pool=null,this.geometryGroup=null,this.objectGroups=null,this.clipPlanes=null,this.fillClipPlane=null,this.boundaryEdge=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.axisGridManager=null,this.IBLMaps=null,this.transformMatrix=null,this.lightArray=null,this.lightHelperArray=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedInstanceMeshes=null,this.nonSelectedInstanceMeshes=null},CLOUD.Scene.prototype.resizePool=function(e){CLOUD.GlobalData.BatchMergeEnabled||(this.geometryGroup.clear(),this.pool.resize(e,{parent:this.geometryGroup}))},CLOUD.Scene.prototype.clearAll=function(){this.pool.clear(),this.autoUpdate=!1},CLOUD.Scene.prototype.getRootNode=function(){return this.geometryGroup},CLOUD.Scene.prototype.getBoundingBox=function(){var e=new THREE.Box3;return function(){return e.copy(this.geometryGroup.boundingBox),e.applyMatrix4(this.geometryGroup.matrix),e}}(),CLOUD.Scene.prototype.getOriginalBoundingBoxWorld=function(){return this.originalBoundingBoxWorld},CLOUD.Scene.prototype.getBoundingBoxWorld=function(){return this.geometryGroup.boundingBox.clone()},CLOUD.Scene.prototype.getMatrixGlobal=function(){return this.geometryGroup.matrix.clone()},CLOUD.Scene.prototype.getGlobalScaleFactor=function(){return this.geometryGroup.matrix.elements[0]},CLOUD.Scene.prototype.getMatrixWorldGlobal=function(){return this.geometryGroup.matrixWorld},CLOUD.Scene.prototype.getRotationGlobal=function(){if(this.geometryGroup.matrix){var e=new THREE.Matrix4;e.extractRotation(this.geometryGroup.matrix);var t=new THREE.Euler;return t.setFromRotationMatrix(e),t}return null},CLOUD.Scene.prototype.getTrackingPointFromBoundingBox=function(e,t){if(!this.geometryGroup.boundingBox)return null;var n=t.origin,i=this.getBoundingBox(),r=0,a=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];a[0].set(i.min.x,i.min.y,i.min.z),a[1].set(i.min.x,i.min.y,i.max.z),a[2].set(i.min.x,i.max.y,i.min.z),a[3].set(i.min.x,i.max.y,i.max.z),a[4].set(i.max.x,i.min.y,i.min.z),a[5].set(i.max.x,i.min.y,i.max.z),a[6].set(i.max.x,i.max.y,i.min.z),a[7].set(i.max.x,i.max.y,i.max.z);for(var o=0;o<8;o++){var s=new THREE.Vector3;s.subVectors(a[o],n);var l=s.dot(e);r<l&&(r=l)}var u=e.clone().multiplyScalar(r),c=n.clone().add(u),h=new THREE.Plane;return h.setFromNormalAndCoplanarPoint(e,c),t.intersectPlane(h)},CLOUD.Scene.prototype.getNearDepthByRect=function(){function e(e){a.setFromMatrixPosition(e.matrixWorld),a.applyProjection(r);var t=a.z;t<i&&t>=0&&t<=1&&(i=t)}function t(e,t){if(!t.boundingBox||t instanceof THREE.Mesh){var i=t.geometry;null===i.boundingBox&&i.computeBoundingBox(),n.copy(i.boundingBox),n.applyMatrix4(t.matrixWorld)}else n.copy(t.boundingBox),n.applyMatrix4(t.matrixWorld);return e.intersectsBox(n)}var n=new THREE.Box3,i=1/0,r=new THREE.Matrix4,a=new THREE.Vector3;return function(n,a){function o(i){if(i instanceof CLOUD.MeshEx){if(!t(n,i))return;e(i)}else if(i.worldBoundingBox){if(!n.intersectsBox(i.worldBoundingBox))return;e(i)}var r=i.children;if(r)for(var a=0,s=r.length;a<s;a++){var l=r[a];l.visible&&o(l)}}i=1/0,r.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);for(var s=this.geometryGroup.children,l=0,u=s.length;l<u;l++){var c=s[l];c.visible&&o(c)}return i}}(),CLOUD.Scene.prototype.getExpandScalar=function(){return this.expandScalar},CLOUD.Scene.prototype.hasClipPlanes=function(){return null!=this.clipPlanes},CLOUD.Scene.prototype.hasFillClipPlanes=function(){return null!=this.fillClipPlane},CLOUD.Scene.prototype.shrinkScopeByClipPlane=function(e,t){if(this.clipPlanes&&this.clipPlanes.isEnabled()){var n=this.clipPlanes.hitTest(e);if(null==n.distance)return;n.sign?n.distance>t.near&&(t.near=n.distance):n.distance<t.far&&(t.far=n.distance)}},CLOUD.Scene.prototype.updateWorldMatrix=function(e,t,n){var i=new THREE.Matrix4;i.compose(e,t,n),this.updateWorldMatrixByMatrix(i)},CLOUD.Scene.prototype.updateWorldMatrixByMatrix=function(e){for(var t=this.objectGroups.children,n=0,i=t.length;n<i;n++)t[n].globalSpace&&(t[n].matrix.copy(e),t[n].matrixAutoUpdate=!1,t[n].updateMatrixWorld(!0))},CLOUD.Scene.prototype.clearLight=function(){for(var e=0;e<this.lightArray.length;e++){var t=this.lightArray[e];this.remove(t)}this.lightArray=[]},CLOUD.Scene.prototype.defaultLightPreset=function(){var e=.3;this.hemisphereLight||(this.hemisphereLight=new THREE.HemisphereLight(16777215,16777215,e*CLOUD.GlobalData.LightIntensityFactor)),this.add(this.hemisphereLight),this.lightArray.push(this.hemisphereLight),this.hemisphereLight.initIntensity=e,this.hemisphereLight.position.set(0,500,0),this.hemisphereLight.updateMatrixWorld(!0),e=.7,this.dirLight||(this.dirLight=new THREE.DirectionalLight(16777215,e*CLOUD.GlobalData.LightIntensityFactor)),this.add(this.dirLight),this.lightArray.push(this.dirLight),this.dirLight.initIntensity=e,this.dirLight.color.setHSL(.1,1,.95),this.dirLight.position.set(-1,.75,1),this.dirLight.position.multiplyScalar(50)},CLOUD.Scene.prototype.updateDefaultLight=function(e){var t=this.dirLight;t.intensity=t.initIntensity*CLOUD.GlobalData.LightIntensityFactor,t.position.set(e.x,e.y,e.z),t.updateMatrixWorld(!0);var n=this.hemisphereLight;n.intensity=n.initIntensity*CLOUD.GlobalData.LightIntensityFactor},CLOUD.Scene.prototype.setupCommonLight=function(){this.ambientLight||(this.ambientLight=new THREE.AmbientLight(16777215,.6)),this.ambientLight.intensity=.6,this.add(this.ambientLight),this.lightArray.push(this.ambientLight),this.sunLight||(this.sunLight=new THREE.DirectionalLight(16777215,1)),this.add(this.sunLight),this.lightArray.push(this.sunLight),this.sunLight.color.setHex(14800580),this.sunLight.position.set(-100,160,100),this.sunLight.intensity=.72,this.sunLight.distance=300,this.sunLight.updateMatrixWorld()},CLOUD.Scene.prototype.lightPreset01=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),
this.fillLight01.intensity=1,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.24,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.6,this.sunLight.intensity=.9},CLOUD.Scene.prototype.lightPreset02=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.position.set(60,80,130),this.fillLight01.intensity=.28,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(8100788),this.fillLight02.position.set(100,80,-100),this.fillLight02.intensity=.22,this.fillLight02.updateMatrixWorld(),this.fillLight03||(this.fillLight03=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight03),this.lightArray.push(this.fillLight03),this.fillLight03.color.setHex(8100788),this.fillLight03.position.set(-140,80,-50),this.fillLight03.intensity=.18,this.fillLight03.updateMatrixWorld()},CLOUD.Scene.prototype.lightPreset03=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.75,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.21,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.4,this.sunLight.intensity=.56},CLOUD.Scene.prototype.lightPreset04=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.4,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.1,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.3,this.sunLight.intensity=.2,this.lightCastShadow||(this.lightCastShadow=new THREE.DirectionalLight(16777215,.15)),this.lightCastShadow.intensity=.5,this.lightCastShadow.castShadow=!0,this.lightCastShadow.shadow.mapSize.width=1024,this.lightCastShadow.shadow.mapSize.height=1024,this.lightCastShadow.shadow.bias=-9e-4,this.updateShadowLight(),this.add(this.lightCastShadow),this.lightArray.push(this.lightCastShadow)},CLOUD.Scene.prototype.getReceivingPlane=function(){if(null==this.receivingPlane){this.receivingPlane=this.getOrCreateObjectGroup(CLOUD.ObjectGroupType.RECEIVESHADOWPLANE);var e=new THREE.ShadowMaterial;e.transparent=!0,e.opacity=.2,e.side=THREE.DoubleSide;var t=new THREE.PlaneBufferGeometry(1e6,1e6),n=new THREE.Mesh(t,e);n.receiveShadow=!0,this.receivingPlane.add(n),this.objectGroups.add(this.receivingPlane),this.receivingPlane.matrix.copy(this.geometryGroup.matrix),this.receivingPlane.matrixAutoUpdate=!1,this.updateReceivingPlane()}return this.receivingPlane},CLOUD.Scene.prototype.updateReceivingPlane=function(){var e=this.receivingPlane.children[0],t=this.getBoundingBoxWorld(),n=t.getSize();e.position.z=t.min.z-.05*n.z,this.receivingPlane.updateMatrixWorld(!0)},CLOUD.Scene.prototype.updateShadowLight=function(){if(null!=this.geometryGroup.boundingBox){var e=this.getBoundingBox(),t=e.getCenter(),n=new THREE.Vector3(100,-160,-100),i=new THREE.Vector3(t.x-n.x,t.y-n.y,t.z-n.z);this.lightCastShadow.position.set(i.x,i.y,i.z),this.lightCastShadow.target.position.set(t.x,t.y,t.z),this.lightCastShadow.target.updateMatrixWorld(!0),this.lightCastShadow.updateMatrixWorld(!0);var r=this.lightCastShadow.shadow.camera;r.position.set(i.x,i.y,i.z);var a=t;r.lookAt(a),r.updateMatrixWorld(),r.matrixWorldInverse.getInverse(r.matrixWorld);var o=e.getSize();e.min.y=e.min.y-.05*o.y;var s=new THREE.Plane(new THREE.Vector3(0,1,0),-e.min.y),l=s.normal.dot(n),u=e.max.clone(),c=-(u.dot(s.normal)+s.constant)/l,h=new THREE.Vector3;h.copy(n).multiplyScalar(c).add(u),e.expandByPoint(h),e.applyMatrix4(r.matrixWorldInverse),r.left=e.min.x,r.right=e.max.x,r.top=e.max.y,r.bottom=e.min.y,r.far=-e.min.z,r.near=-e.max.z,r.updateProjectionMatrix()}},CLOUD.Scene.prototype.lightPreset=function(){switch(this.clearLight(),CLOUD.GlobalData.LightPreset){case 0:this.defaultLightPreset();break;case 1:this.lightPreset01();break;case 2:this.lightPreset02();break;case 3:this.lightPreset03();break;case 4:this.lightPreset04();break;default:this.setupCommonLight(),this.sunLight.color.setHex(16777215),this.ambientLight.intensity=.72}this.lightHelper&&this.addLightHelper()},CLOUD.Scene.prototype.clearLightHelper=function(){for(var e=0;e<this.lightHelperArray.length;e++){var t=this.lightHelperArray[e];this.remove(t)}this.lightHelperArray=[],this.remove(this.cameraHelper),this.cameraHelper=null},CLOUD.Scene.prototype.addLightHelper=function(){this.clearLightHelper();for(var e=0;e<this.lightArray.length;++e){var t=this.lightArray[e];if(t instanceof THREE.DirectionalLight){var n=new THREE.DirectionalLightHelper(t,200);this.add(n),this.lightHelperArray.push(n)}}this.lightCastShadow&&(this.cameraHelper=new THREE.CameraHelper(this.lightCastShadow.shadow.camera),this.add(this.cameraHelper))},CLOUD.Scene.prototype.updateLightHelper=function(){for(var e=0;e<this.lightHelperArray.length;++e){var t=this.lightHelperArray[e];t.update(),t.updateMatrixWorld(!0)}this.cameraHelper&&(this.cameraHelper.update(),this.cameraHelper.updateMatrixWorld(!0))},CLOUD.Scene.prototype.updateLights=function(e){var t=new THREE.Vector3(0,1,0),n=Math.PI/4,i=e.position.clone();i.sub(e.target),i.normalize();var r=CLOUD.GlobalData.LightPreset;switch(r){case 0:this.updateDefaultLight(i);break;case 1:case 3:case 4:var a=i.clone().applyAxisAngle(t,-1.2*n);this.fillLight01.position.copy(a).normalize(),this.fillLight01.position.multiplyScalar(1e3),this.fillLight01.position.y=600,this.fillLight01.updateMatrixWorld(),a=i.clone().applyAxisAngle(t,1*n),this.fillLight02.position.copy(a).normalize(),this.fillLight02.position.multiplyScalar(1e3),this.fillLight02.position.y=600,this.fillLight02.updateMatrixWorld(),4==r&&this.updateShadowLight();break;case 2:break;default:var a=i.clone().applyAxisAngle(t,-2*n);this.sunLight.position.copy(a).normalize(),this.sunLight.position.multiplyScalar(1e3),this.sunLight.position.y=600,this.sunLight.updateMatrixWorld()}this.lightHelper&&this.updateLightHelper()},CLOUD.Scene.prototype.getOrCreateObjectGroup=function(e,t){for(var n=this.objectGroups.children,i=0,r=n.length;i<r;i++)if(n[i].name==e)return n[i];var a=new CLOUD.ObjectGroup(e,t);return a.isGlobalSpace()&&(a.matrix.copy(this.geometryGroup.matrix),a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0)),this.objectGroups.add(a),a},CLOUD.Scene.prototype.getObjectGroup=function(e){for(var t=this.objectGroups.children,n=0,i=t.length;n<i;n++)if(t[n].name==e)return t[n];return null},CLOUD.Scene.prototype.getObjectGroupType=function(e){var t=e.split("|");return{groupType:t[0],databagId:t.length>1?t[1]:void 0}},CLOUD.Scene.prototype.getObjectGroups=function(){return this.objectGroups.children},CLOUD.Scene.prototype.removeObjectGroup=function(e){this.objectGroups.remove(e)},CLOUD.Scene.prototype.removeObjectGroupByName=function(e){this.objectGroups.removeByName(e)},CLOUD.Scene.prototype.hasObjectGroup=function(e){return this.objectGroups.hasChild(e)},CLOUD.Scene.prototype.intersectToWorld=function(e,t){var n=this.getMatrixGlobal();e.worldPosition=CLOUD.GeomUtil.getWorldPositionOfMesh(e.point,n);var i=t.getComponentInfoByUserId(e.userId);i&&(e.worldBoundingBox=i.boundingBox.clone())},CLOUD.Scene.prototype.worldToDrawing=function(e){var t=this.getMatrixGlobal(),n=new THREE.Vector3(e.x,e.y,e.z);return n.applyMatrix4(t),n},CLOUD.Scene.prototype.drawingToWorld=function(e){var t=this.getMatrixGlobal(),n=new THREE.Matrix4;n.getInverse(t);var i=new THREE.Vector3(e.x,e.y,e.z);return i.applyMatrix4(n),i},CLOUD.Scene.prototype.getBoundingBoxWorldByMesh=function(e){var t=this.getMatrixGlobal(),n=e.boundingBox;n||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),n=e.geometry.boundingBox);var i=n.clone();i.applyMatrix4(e.matrixWorld);var r=new THREE.Matrix4;return r.getInverse(t),i.applyMatrix4(r),i},CLOUD.Scene.prototype.getObjectPool=function(){return this.pool},CLOUD.Scene.prototype.setBoundingBoxWorld=function(e){this.geometryGroup.boundingBox?this.geometryGroup.boundingBox.copy(e):(this.geometryGroup.boundingBox=e,this.originalBoundingBoxWorld=e.clone())},CLOUD.Scene.prototype.getBoundingBoxOfGeometries=function(e){for(var t=!e,n=new THREE.Box3,i=this.pool._pool,r=0,a=this.pool.counter;r<a;++r){var o=i[r];if(o.isVisible()){var s=o.geometry;if(s){if(t||void 0!==e[o.name]){s.boundingBox||s.computeBoundingBox();var l=s.boundingBox;if(l){var u=l.clone();o.matrixWorld&&u.applyMatrix4(o.matrixWorld),n.expandByPoint(u.min),n.expandByPoint(u.max)}}}else CLOUD.Logger.log("empty geometry!")}}return n},CLOUD.Scene.prototype.getTransformMatrixGlobal=function(){return this.transformMatrix},CLOUD.Scene.prototype.setTransformMatrixGlobal=function(e){this.transformMatrix.copy(e)},CLOUD.Scene.prototype.adjustInstanceVisibility=function(e){function t(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&t.geometry instanceof THREE.InstancedBufferGeometry){var n=t.visible;e&&!t.bVisible||(t.visible=e),t.bVisible=n}}this.traverse(t)},CLOUD.Scene.prototype.adjustVisibility=function(e){function t(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&!(t.geometry instanceof THREE.InstancedBufferGeometry)){var n=t.visible;e&&!t.bVisible||(t.visible=e),t.bVisible=n}}this.traverse(t)},CLOUD.Scene.prototype.changeVisibilityOfSelectedObjects=function(e){function t(e){if(e._indicesGroup&&e.visible){var t=[],n=e.geometry.groups;if(n&&n.length){for(var i=0,r=n.length;i<r;i++){var a=n[i];a.materialIndex===CLOUD.Model.EnumFilterState.SELECTED&&(t.push({idx:i,start:a.start,count:a.count}),a.start=0,a.count=0)}t.length&&s.push({object:e,indices:t})}}}function n(e){for(var t=0,n=o.selectedMeshes.length;t<n;t++){if(e===o.selectedMeshes[t].object)for(var i=o.selectedMeshes[t].indices,r=0,a=i.length;r<a;r++){var s=i[r],l=e.geometry.groups[s.idx];l.start=s.start,l.count=s.count}}}function i(e){if(e.visible){for(var t=[],n=e.geometry.getAttribute("vState").array,i=0;i<n.length;++i)n[i]===CLOUD.EnumInstanceState.SELECTED&&(t.push(i),n[i]=CLOUD.EnumInstanceState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,l.push({object:e,indices:t}))}}function r(e){for(var t=0,n=o.selectedInstanceMeshes.length;t<n;t++){if(e===o.selectedInstanceMeshes[t].object){for(var i=o.selectedInstanceMeshes[t].indices,r=e.geometry.getAttribute("vState").array,a=0,s=i.length;a<s;a++)r[i[a]]=CLOUD.EnumInstanceState.SELECTED;e.geometry.getAttribute("vState").needsUpdate=!0}}}function a(a){(a instanceof THREE.Mesh||a instanceof THREE.LineSegments)&&(a.geometry instanceof THREE.InstancedBufferGeometry?e?r(a):i(a):e?n(a):t(a))}var o=this;e||(o.selectedMeshes.length=0,o.selectedInstanceMeshes.length=0);var s=o.selectedMeshes,l=o.selectedInstanceMeshes;this.traverse(a)},CLOUD.Scene.prototype.changeVisibilityOfNonSelectedObjects=function(e){function t(e){if(e._indicesGroup&&e.visible){var t=[],n=e.geometry.groups;if(n&&n.length){for(var i=0,r=n.length;i<r;i++){var a=n[i];a.materialIndex!==CLOUD.Model.EnumFilterState.SELECTED&&(t.push({idx:i,start:a.start,count:a.count}),a.start=0,a.count=0)}t.length?s.push({object:e,indices:t}):(e.visible=!1,s.push({object:e,indices:null}))}else e.visible=!1,s.push({object:e,indices:null})}}function n(e){for(var t=0,n=o.nonSelectedMeshes.length;t<n;t++){if(e===o.nonSelectedMeshes[t].object){var i=o.nonSelectedMeshes[t].indices;if(null===i)e.visible=!0;else for(var r=0,a=i.length;r<a;r++){var s=i[r],l=e.geometry.groups[s.idx];l.start=s.start,l.count=s.count}}}}function i(e){if(e.visible){for(var t=[],n=e.geometry.getAttribute("vState").array,i=0,r=n.length;i<r;++i)n[i]!==CLOUD.EnumInstanceState.SELECTED&&n[i]!==CLOUD.EnumInstanceState.HIDDEN&&(t.push({idx:i,state:n[i]}),n[i]=CLOUD.EnumInstanceState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,l.push({object:e,indices:t}))}}function r(e){for(var t=0,n=o.nonSelectedInstanceMeshes.length;t<n;t++){if(e===o.nonSelectedInstanceMeshes[t].object){for(var i=o.nonSelectedInstanceMeshes[t].indices,r=e.geometry.getAttribute("vState").array,a=0,s=i.length;a<s;a++)r[i[a].idx]=i[a].state;e.geometry.getAttribute("vState").needsUpdate=!0}}}function a(a){(a instanceof THREE.Mesh||a instanceof THREE.LineSegments)&&(a.geometry instanceof THREE.InstancedBufferGeometry?e?r(a):i(a):e?n(a):t(a))}var o=this;e||(o.nonSelectedMeshes.length=0,o.nonSelectedInstanceMeshes.length=0);var s=o.nonSelectedMeshes,l=o.nonSelectedInstanceMeshes;this.traverse(a)},CLOUD.Scene.prototype.clearSelectedAndNonSelectedMeshes=function(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0,this.selectedInstanceMeshes.length=0,this.nonSelectedInstanceMeshes.length=0},CLOUD.Scene.prototype.drawBoundingBox=function(e){if(!e)return void this.removeObjectGroupByName("BoundingBox");var t=this.getOrCreateObjectGroup("BoundingBox",{pickable:0,priority:2}),n=this.getBoundingBox();void 0===this.boudingBoxNode?(this.boudingBoxNode=new CLOUD.BBoxNode(n,16711680),t.add(this.boudingBoxNode)):this.boudingBoxNode.updateBBox(n),this.boudingBoxNode.updateMatrixWorld(!0)},CLOUD.Scene.prototype.calculateGisMapBox=function(e){var t=this.getObjectGroup(CLOUD.GlobalData.TileGlobalGroupName)||this.getObjectGroup(CLOUD.GlobalData.TilePlaneGroupName),n=this.getBoundingBoxWorld(),i=n.clone();if(t){var r=e.position.clone(),a=this.getMatrixWorldGlobal(),o=(new THREE.Matrix4).getInverse(a);r.applyMatrix4(o);var s=6370856e3,l=r.z-n.min.z;l=Math.abs(l);var u=s*Math.acos(s/(s+l));i.min.x=r.x-u,i.max.x=r.x+u,i.min.y=r.y-u,i.max.y=r.y+u,i.min.z=n.min.z,i.max.z=n.max.z}return i},CLOUD.Raycaster=function(e,t,n,i){this.ray=new THREE.Ray(e,t),this.near=n||0,this.far=i||1/0,this.params={Sprite:{},Mesh:{},Points:{threshold:1},LOD:{},Line:{}}},CLOUD.Raycaster.prototype={constructor:CLOUD.Raycaster,precision:1e-4,linePrecision:1,descSort:function(e,t){return e.distance-t.distance},set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t instanceof CLOUD.CombinedCamera?t.isPerspective?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):t instanceof THREE.PerspectiveCamera?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):t instanceof THREE.OrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("CLOUD.Raycaster: Unsupported camera type.")},intersectOctantForNode:function(e,t){function n(e){var a,o;if(r.set(e.min,e.max),i.ray.intersectBox(r)&&(t.push(e),e.childOctants))for(a=0,o=e.childOctants.length;a<o;a++)n(e.childOctants[a])}var i=this,r=new THREE.Box3;n(e)}},THREE.Ray.prototype.intersectBoxWithDistance=function(e){var t,n,i,r,a,o,s=1/this.direction.x,l=1/this.direction.y,u=1/this.direction.z,c=this.origin;if(s>=0?(t=(e.min.x-c.x)*s,n=(e.max.x-c.x)*s):(t=(e.max.x-c.x)*s,n=(e.min.x-c.x)*s),l>=0?(i=(e.min.y-c.y)*l,r=(e.max.y-c.y)*l):(i=(e.max.y-c.y)*l,r=(e.min.y-c.y)*l),t>r||i>n)return-1;if((i>t||t!==t)&&(t=i),(r<n||n!==n)&&(n=r),u>=0?(a=(e.min.z-c.z)*u,o=(e.max.z-c.z)*u):(a=(e.max.z-c.z)*u,o=(e.min.z-c.z)*u),t>o||a>n)return-1;if((a>t||t!==t)&&(t=a),(o<n||n!==n)&&(n=o),n<0)return-1;if(t<0)return 0;var h=this.at(t>=0?t:n),d=h.x-c.x,f=h.y-c.y,p=h.z-c.z;return Math.sqrt(d*d+f*f+p*p)},function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.id=t,this.object=n}return _createClass(e,[{key:"destroy",value:function(){this.object=null}},{key:"_inDistanceRange",value:function(e,t){return e>=t.near&&e<=t.far}},{key:"raycast",value:function(e,t,n,i,r){}}]),e}();CLOUD.CapsuleObject=e}(),function(){var e=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,e),_createClass(t,[{key:"raycast",value:function(e,t,n,i,r,a){var o=this.object,s=[];if(o.raycast(e,s),s.length>0){s.sort(function(e,t){return e.distance-t.distance});for(var l=0,u=s.length;l<u;l++){var c=s[l];if(this._inDistanceRange(c.distance,n)&&!i.clipPoint(c.point)){a||(n.far=c.distance-CLOUD.Utils.MinusEpsilon),r.push(c);break}}}}}]),t}(CLOUD.CapsuleObject),t=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,e),_createClass(t,[{key:"raycast",value:function(e,t,n,i,r){var a=this.object,o=[],s=a.geometry,l={indexStart:s.drawRange.start,indexCount:s.drawRange.count};if(a.raycastByIndices2(e,o,l,!1),o.length>0){o.sort(function(e,t){return e.distance-t.distance});for(var u=0,c=o.length;u<c;u++){var h=o[u];if(this._inDistanceRange(h.distance,n)&&!i.clipPoint(h.point)){n.far=h.distance-CLOUD.Utils.MinusEpsilon,h.userId=t.userId,h.indexInfo=l,r.push(h);break}}}}}]),t}(CLOUD.CapsuleObject);CLOUD.SingleCapsuleObject=e,CLOUD.SingleCapsuleObjectWithDrawRange=t}(),function(){var e=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,e),_createClass(t,[{key:"raycast",value:function(e,t,n,i,r,a){var o=this.object,s=o._indicesGroup;if(s){var l=s[t.userId];if(l){for(var u,c=!1,h=0,d=l.length;h<d;h++)if(l[h].nodeId===t.nodeId){u=l[h],c=!0;break}if(c){var f=[];if(o.raycastByIndices(e,f,u),f.length>0){f.sort(function(e,t){return e.distance-t.distance});for(var p=0,m=f.length;p<m;p++){var g=f[p];if(this._inDistanceRange(g.distance,n)&&!i.clipPoint(g.point)){a||(n.far=g.distance-CLOUD.Utils.MinusEpsilon),g.userId=u.userId,g.indexInfo=u,r.push(g);break}}}}}}}}]),t}(CLOUD.CapsuleObject);CLOUD.BatchedCapsuleObject=e}(),function(){var e=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,e),_createClass(t,[{key:"raycast",value:function(e,t,n,i,r,a){var o=this.object,s=[];if(o.raycastByIndices(e,s,null,t.matrix),s.length>0){s.sort(function(e,t){return e.distance-t.distance});for(var l=0,u=s.length;l<u;l++){var c=s[l];if(this._inDistanceRange(c.distance,n)&&!i.clipPoint(c.point)){a||(n.far=c.distance-CLOUD.Utils.MinusEpsilon),c.userId=t.userId,c.matrix=t.matrix,r.push(c);break}}}}}]),t}(CLOUD.CapsuleObject);CLOUD.InstancedCapsuleObject=e}(),CLOUD.CombinedCamera=function(e,t){THREE.Camera.call(this),this.target=new THREE.Vector3,this.name=t.name||"",this.near=t.near,this.far=t.far,e===CLOUD.CAMERATYPE.PERSPECTIVE?(this.aspect=t.width/t.height,this.fov=t.fov,this.left=-t.width/2,this.right=t.width/2,this.top=t.height/2,this.bottom=-t.height/2,this.perspectiveCamera=new CLOUD.CloudPerspectiveCamera(this.fov,this.aspect,this.near,this.far),this.orthoCamera=null,this.toPerspective()):(this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.fov=45,this.aspect=(this.right-this.left)/(this.top-this.bottom),this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far),this.perspectiveCamera=null,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.isPerspective=!1),this.zoom=t.zoom||1,this.updateProjectionMatrixByFrustum=!1},CLOUD.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),CLOUD.CombinedCamera.prototype.constructor=CLOUD.CombinedCamera,CLOUD.CombinedCamera.prototype.toPerspective=function(){if(null===this.perspectiveCamera)return void console.log("Can not convert to perspective camera because the camera original type is orthographic.");this.updateProjectionMatrixByFrustum||(this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.isPerspective=!0,this.dirty=!0)},CLOUD.CombinedCamera.prototype.toOrthographic=function(){null===this.orthoCamera&&(this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far));var e=this.fov,t=this.target.clone().sub(this.position).length(),n=Math.tan(e*Math.PI/180/2)*t,i=n*this.aspect;n/=this.zoom,i/=this.zoom,this.left=this.orthoCamera.left=-i,this.right=this.orthoCamera.right=i,this.top=this.orthoCamera.top=n,this.bottom=this.orthoCamera.bottom=-n,this.orthoCamera.near=this.near,this.orthoCamera.far=this.far,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.isPerspective=!1,this.dirty=!0},CLOUD.CombinedCamera.prototype.setSize=function(e,t){this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.aspect=e/t,this.dirty=!0},CLOUD.CombinedCamera.prototype.setSizeByFrustum=function(e,t){var n=2*this.right,i=2*this.top;this.aspect=n/i;var r;n/i<e/t?(r=i/n,this.perspectiveCamera.setProjectOnWidth(!0)):(r=n/i,this.perspectiveCamera.setProjectOnWidth(!1)),this.dirty=!0,this.isPerspective&&(this.perspectiveCamera.aspect=r,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrixByFrustum(e,t),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.isPerspective=!0,this.dirty=!0)},CLOUD.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.dirty=!0,this.updateProjectionMatrix()},CLOUD.CombinedCamera.prototype.setNearFar=function(e,t){this.near=e,this.far=t,this.dirty=!0,this.updateProjectionMatrix()},CLOUD.CombinedCamera.prototype.updateProjectionMatrix=function(){this.isPerspective?this.toPerspective():this.toOrthographic()},CLOUD.CombinedCamera.prototype.setLens=function(e,t){void 0===t&&(t=24);var n=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(n),this.dirty=!0,n},CLOUD.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.dirty=!0,this.updateProjectionMatrix()},CLOUD.CombinedCamera.prototype.copy=function(e){THREE.Camera.prototype.copy.call(this,e),this.target.copy(e.target),this.aspect=e.aspect,this.fov=e.fov,this.near=e.near,this.far=e.far,this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.zoom=e.zoom,this.isPerspective=e.isPerspective,this.orthoCamera.copy(e.orthoCamera),this.perspectiveCamera.copy(e.perspectiveCamera)},CLOUD.CombinedCamera.prototype.isDirty=function(){return this.dirty};var CloudPerspectiveCamera=function(e){function t(e,n,i,r){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,i,r));return a.projectOnWidth=!1,a}return _inherits(t,e),_createClass(t,[{key:"updateProjectionMatrixByFrustum",value:function(e,t){var n,i,r,a,o=this.near;this.projectOnWidth?(r=e,i=-.5*r,a=this.aspect*r,n=.5*a):(a=t,n=.5*a,r=this.aspect*a,i=-.5*r);var s=this.view;if(null!==s){var l=s.fullWidth,u=s.fullHeight;i+=s.offsetX*r/l,n-=s.offsetY*a/u,r*=s.width/l,a*=s.height/u}var c=this.filmOffset;0!==c&&(i+=o*c/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+r,n,n-a,o,this.far)}},{key:"setProjectOnWidth",value:function(e){this.projectOnWidth=e}}]),t}(THREE.PerspectiveCamera);CLOUD.CloudPerspectiveCamera=CloudPerspectiveCamera,CLOUD.Camera=function(e,t){CLOUD.CombinedCamera.call(this,e,t),this.realUp=this.up.clone(),this.dirty=!1,this.orthoScale=1,this.positionPlane=new THREE.Plane,this.projScreenMatrix=new THREE.Matrix4,this.viewProjInverse=new THREE.Matrix4,this.frustum=new THREE.Frustum},CLOUD.Camera.prototype=Object.create(CLOUD.CombinedCamera.prototype),CLOUD.Camera.prototype.constructor=CLOUD.Camera,CLOUD.Camera.prototype._updatePositionPlane=function(){this.positionPlane.setFromNormalAndCoplanarPoint(this.getWorldDirection(),this.position)},CLOUD.Camera.prototype._updateFrustum=function(){this.frustum.setFromMatrix(this.projScreenMatrix)},CLOUD.Camera.prototype.updateMVP=function(){this.dirty&&(null===this.parent&&this.updateMatrixWorld(),this.matrixWorldInverse.getInverse(this.matrixWorld),this.projScreenMatrix.multiplyMatrices(this.projectionMatrix,this.matrixWorldInverse),this.viewProjInverse.getInverse(this.projScreenMatrix),this._updateFrustum(),this._updatePositionPlane(),this.dirty=!1)},CLOUD.Camera.prototype.getFrustum=function(){return this.dirty&&this.updateMVP(),this.frustum},CLOUD.Camera.prototype.LookAt=function(e,t,n,i){var r=new THREE.Vector3;r.copy(t),void 0!==i&&r.setLength(i),this.position.subVectors(e,r),this.up=n,this.lookAt(e),this.realUp=n.clone(),this.target=e.clone(),this.dirty=!0},CLOUD.Camera.prototype.copy=function(e){return CLOUD.CombinedCamera.prototype.copy.call(this,e),this.realUp.copy(e.realUp),this.orthoScale=e.orthoScale,this.dirty=e.dirty,this.updateProjectionMatrix(),this.updateMVP(),this},CLOUD.Camera.prototype.setStandardView=function(e,t){var n;n=t?t.getCenter():new THREE.Vector3(0,0,0);var i=CLOUD.GlobalData.SceneSize,r=i/2;switch(e){case CLOUD.EnumStandardView.ISO:var a=new THREE.Vector3(-i,i,i),o=new THREE.Vector3,s=new THREE.Vector3(0,0,0);o.subVectors(s,a),this.LookAt(n,o,THREE.Object3D.DefaultUp);break;case CLOUD.EnumStandardView.Top:this.LookAt(n,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.Bottom:this.LookAt(n,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.Front:this.LookAt(n,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Back:this.LookAt(n,new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Right:this.LookAt(n,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Left:this.LookAt(n,new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.SouthEast:this.LookAt(n,new THREE.Vector3(-1,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.SouthWest:this.LookAt(n,new THREE.Vector3(1,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.NorthWest:this.LookAt(n,new THREE.Vector3(1,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.NorthEast:this.LookAt(n,new THREE.Vector3(-1,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomFront:this.LookAt(n,new THREE.Vector3(0,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomBack:this.LookAt(n,new THREE.Vector3(0,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomRight:this.LookAt(n,new THREE.Vector3(-1,1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomLeft:this.LookAt(n,new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomSouthEast:this.LookAt(n,new THREE.Vector3(-1,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomSouthWest:this.LookAt(n,new THREE.Vector3(1,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomNorthWest:this.LookAt(n,new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomNorthEast:this.LookAt(n,new THREE.Vector3(-1,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofFront:this.LookAt(n,new THREE.Vector3(0,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofBack:this.LookAt(n,new THREE.Vector3(0,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofRight:this.LookAt(n,new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofLeft:this.LookAt(n,new THREE.Vector3(1,-1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofSouthEast:this.LookAt(n,new THREE.Vector3(-1,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofSouthWest:this.LookAt(n,new THREE.Vector3(1,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofNorthWest:this.LookAt(n,new THREE.Vector3(1,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofNorthEast:this.LookAt(n,new THREE.Vector3(-1,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.TopTurnRight:this.LookAt(n,new THREE.Vector3(0,-1,0),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.TopTurnBack:this.LookAt(n,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.TopTurnLeft:this.LookAt(n,new THREE.Vector3(0,-1,0),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.BottomTurnRight:this.LookAt(n,new THREE.Vector3(0,1,0),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.BottomTurnBack:this.LookAt(n,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.BottomTurnLeft:this.LookAt(n,new THREE.Vector3(0,1,0),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.FrontTurnTop:this.LookAt(n,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.FrontTurnLeft:this.LookAt(n,new THREE.Vector3(0,0,-1),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.FrontTurnRight:this.LookAt(n,new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.RightTurnTop:this.LookAt(n,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.RightTurnFront:this.LookAt(n,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.RightTurnBack:this.LookAt(n,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.BackTurnTop:this.LookAt(n,new THREE.Vector3(0,0,1),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.BackTurnLeft:this.LookAt(n,new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.BackTurnRight:this.LookAt(n,new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.LeftTurnTop:this.LookAt(n,new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.LeftTurnBack:this.LookAt(n,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.LeftTurnFront:this.LookAt(n,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),r)}return this.updateProjectionMatrix(),n},CLOUD.Camera.prototype.zoomToBBox=function(e,t,n,i){n=n||1,t=t||0,t=t<-1?-1:t;var r=new THREE.Box3;if(r.copy(e),0!==t){var a=.5*e.getSize().length(),o=new THREE.Vector3;o.subVectors(r.max,r.min).normalize(),o.multiplyScalar(a*t),r.expandByVector(o)}var s=i||this.getWorldDirection(),l=this.up,u=this.aspect,c=THREE.Math.degToRad(.5*this.fov),h=r.getSize(),d=r.getCenter(),f=.5*h.length(),p=f/Math.sin(c)*n,m=new THREE.Vector3;m.copy(s),m.setLength(p);var g=new THREE.Vector3;g.subVectors(d,m);var v=new THREE.Vector3;v.crossVectors(s,l),v.normalize();var y=new THREE.Vector3;y.crossVectors(s,v),y.normalize();var E=new THREE.Plane;E.setFromNormalAndCoplanarPoint(v,g);var b=new THREE.Plane
;b.setFromNormalAndCoplanarPoint(y,g);var x=0,M=0,_=0,C=0,I=0,O=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];O[0].set(r.min.x,r.min.y,r.min.z),O[1].set(r.min.x,r.min.y,r.max.z),O[2].set(r.min.x,r.max.y,r.min.z),O[3].set(r.min.x,r.max.y,r.max.z),O[4].set(r.max.x,r.min.y,r.min.z),O[5].set(r.max.x,r.min.y,r.max.z),O[6].set(r.max.x,r.max.y,r.min.z),O[7].set(r.max.x,r.max.y,r.max.z);for(var T=0;T<8;T++){var L=new THREE.Vector3;L.subVectors(O[T],g);var S=Math.abs(L.dot(s)),D=Math.abs(b.distanceToPoint(O[T])),w=D*u,U=Math.abs(E.distanceToPoint(O[T])),R=U/u,A=Math.max(D,R),N=Math.max(w,U);x<A&&(x=A),(!M||!_||A>M*S/_)&&(M=A,_=S),(!C||!I||N>C*S/I)&&(C=N,I=S)}var P,k=C/Math.tan(c)+(p-I),B=M/Math.tan(c)+(p-_);if((P=u<1?Math.max(k,B):Math.min(k,B))<this.near){this.near=(P*P+.001*P)/16777.216}if(m.copy(s).normalize().setLength(P),g.subVectors(d,m),this.position.copy(g),this.lookAt(d),this.target.copy(d),!this.isPerspective){var F=Math.tan(this.fov*Math.PI/180/2)*P;this.orthoScale=F/x,this.zoom=this.orthoScale}return this.updateProjectionMatrix(),this.dirty=!0,d},CLOUD.Camera.prototype.computeRay=function(e,t,n){var i=new THREE.Vector2;if(void 0===n)i.x=window.innerWidth,i.y=window.innerHeight;else{var r=n===document?n.body:n;i.x=r.offsetWidth,i.y=r.offsetHeight}var a=new THREE.Vector2;a.x=e/i.x*2-1,a.y=-t/i.y*2+1;var o=new THREE.Ray;return this.isPerspective?(o.origin.copy(this.position),o.direction.set(a.x,a.y,.5).unproject(this).sub(this.position).normalize()):(o.origin.set(a.x,a.y,-1).unproject(this),o.direction.set(0,0,-1).transformDirection(this.matrixWorld)),o},CLOUD.Camera.prototype.screenToWorld=function(e,t,n,i){var r=this.computeRay(e,t,n),a=this.getWorldDirection().normalize(),o=new THREE.Plane(a);return o.setFromNormalAndCoplanarPoint(a,i),r.intersectPlane(o,i)},CLOUD.Camera.prototype.getWorldFrustum=function(e){var t=new THREE.Matrix4,n=new THREE.Frustum,i=this.clone(),r=this.target,a=r.clone().sub(this.position).length(),o=new THREE.Matrix4;o.getInverse(e);var s=new THREE.Matrix4;s.extractRotation(e);var l=new THREE.Quaternion;l.setFromRotationMatrix(s),l.inverse(),i.position.applyMatrix4(o);var u=r.clone();u.applyMatrix4(o);var c=u.clone().sub(i.position),h=c.length();c.normalize();var d=h/a;return i.far=camera.far*d,i.up.applyQuaternion(l).normalize(),i.realUp.applyQuaternion(l).normalize(),i.updateProjectionMatrix(),i.updateMatrixWorld(),t.getInverse(i.matrixWorld),n.setFromMatrix((new THREE.Matrix4).multiplyMatrices(i.projectionMatrix,t)),i=null,n},CLOUD.Camera.prototype.distanceFromWorldToDrawing=function(e,t){var n=this.position.clone(),i=this.target.clone();i.subVectors(this.target,this.position),i.normalize();var r=new THREE.Matrix4;return r.getInverse(e),i.add(n).applyMatrix4(r),n.applyMatrix4(r),i.sub(n),i.normalize().multiplyScalar(t),i.add(n).applyMatrix4(e),i.sub(this.position),i.length()},CLOUD.Camera.drawingToWorld=function(e,t){var n=e.position.clone(),i=e.target.clone(),r=e.up.clone(),a=new THREE.Matrix4;return a.getInverse(t),r.add(n),r.applyMatrix4(a),n.applyMatrix4(a),i.applyMatrix4(a),r.sub(n),r.normalize(),{position:n,target:i,up:r}},CLOUD.Camera.worldToDrawing=function(e,t){var n=e.position.clone(),i=e.target.clone(),r=e.up.clone();return r.add(n),r.applyMatrix4(t),n.applyMatrix4(t),i.applyMatrix4(t),r.sub(n),r.normalize(),{position:n,target:i,up:r}},CLOUD.Animation=function(){var e=this,t=null,n={},i={},r=1e3,a=null,o=null,s=null,l=!1,u=null,c=null,h=null;this.from=function(e){t=e;for(var i in t)n[i]=t[i];return this},this.to=function(e,t){return void 0!==t&&(r=t),i=e,this},this.onStart=function(e){return u=e,this},this.onUpdate=function(e){return c=e,this},this.onComplete=function(e){return h=e,this},this.start=function(e){function d(){var f,p=n,m=i,g=Date.now();!1===l&&(null!==u&&u.call(t),l=!0),f=(g-a)/r,f=f>1?1:f,t=s(p,m,f),1===f?(cancelAnimationFrame(o),null!==h&&h.call(t)):(requestAnimationFrame(d,e),null!==c&&c.call(t,f))}l=!1,o&&cancelAnimationFrame(o),a=Date.now(),s=this.interpolate,o=requestAnimationFrame(d,e)},this.isAngleGreaterThanPi=function(e,t,n){var i=new THREE.Vector3;return i.crossVectors(e,t),!(i.dot(n)>=0)},this.conicInterpolate=function(e,t,n,i){var r=t.angleTo(e),a=-r*i,o=new THREE.Vector3;o.crossVectors(t,e).normalize();var s=new THREE.Quaternion;s.setFromAxisAngle(o,a),n.copy(e),n.applyQuaternion(s)},this.quaternionInterpolate=function(e,t,n,i,r){var a=new THREE.Quaternion(e.x,e.y,e.z,1).normalize(),o=new THREE.Quaternion(t.x,t.y,t.z,1).normalize(),s=new THREE.Quaternion(0,0,0,1),l=new THREE.Quaternion(0,0,0,1),u=new THREE.Vector3;u.crossVectors(e,n).normalize(),s.set(u.x,u.y,u.z,1).normalize();var c=0;r<.5?(c=2*r,THREE.Quaternion.slerp(a,s,l,c),i.set(l.x,l.y,l.z)):(c=2*(r-.5),THREE.Quaternion.slerp(s,o,l,c),i.set(l.x,l.y,l.z))},this.slerpInterpolate=function(e,t,n,i,r,a){var o=e.dot(t);a<o?i.copy(t):a<Math.abs(o)?this.quaternionInterpolate(e,t,n,i,r):this.conicInterpolate(e,t,i,r),i.normalize()},this.linearInterpolate=function(e,t,n,i,r){if(e.equals(t))return void n.copy(t);var a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,0,1),s=new THREE.Vector3,l=0,u=e.dot(t);r<u?n.copy(t):r<-u?(r>Math.abs(e.dot(o))?s.crossVectors(e,o).normalize():s.crossVectors(e,a).normalize(),i<.5?(l=2*i,n.lerpVectors(e,s,l)):(l=2*(i-.5),n.lerpVectors(s,t,l))):n.lerpVectors(e,t,i),n.normalize()},this.linearInterpolatePosition=function(e,t,n,i){n.lerpVectors(e,t,i)},this.sphericalInterpolate=function(e,t,n,i,r,a){var o=e.clone().sub(t),s=n.clone().sub(i),l=new THREE.Spherical;l.setFromVector3(o);var u=new THREE.Spherical;u.setFromVector3(s);var c=l.theta+(u.theta-l.theta)*a,h=l.phi+(u.phi-l.phi)*a,d=o.length(),f=new THREE.Spherical;f.set(d,h,c);var p=new THREE.Vector3;p.setFromSpherical(f),r.copy(p).multiplyScalar(-1)},this.interpolate=function(t,n,i){var r=new THREE.Vector3,a=new THREE.Vector3,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,u=t.animPos,c=t.animTarget,h=(t.animDir,t.animUp),d=t.animFocal,f=t.zoom,p=n.animPos,m=n.animTarget,g=(n.animDir,n.animUp),v=n.animFocal,y=n.zoom;return e.sphericalInterpolate(u,c,p,m,r,i),e.linearInterpolate(h,g,a,i,.9995),e.linearInterpolatePosition(c,m,o,i),e.linearInterpolatePosition(d,v,s,i),e.linearInterpolatePosition(f,y,l,i),{animDir:r,animUp:a,animTarget:o,animFocal:s,zoomScale:l}}},CLOUD.CameraAnimator=function(){var e=500,t=13,n=new CLOUD.Animation;this.setDuration=function(t){e=t},this.setFrameTime=function(e){t=e},this.setStandardView=function(i,r,a,o,s,l){var u=r.camera,c=u.position.clone(),h=u.target.clone(),d=u.getWorldDirection().clone();d.normalize();var f=new THREE.Vector3;f.copy(u.realUp||u.up),f.normalize();var p=new THREE.Vector3(u.position.clone().sub(h).length(),0,0),m=u.setStandardView(i,a);m=r.camera.zoomToBBox(a,o);var g=u.position.clone(),v=u.getWorldDirection().clone();v.normalize();var y=new THREE.Vector3;y.copy(u.realUp||u.up),y.normalize();var E=new THREE.Vector3(u.position.clone().sub(m).length(),0,0);r.getEditorManager().setInteractiveState(!1),n.from({animPos:c,animDir:d,animUp:f,animTarget:h,animFocal:p,zoom:1}).to({animPos:g,animDir:v,animUp:y,animTarget:m,animFocal:E,zoom:1},e).onUpdate(function(){var e=this.animTarget,t=this.animDir,n=this.animUp,i=this.animFocal.x;r.camera.LookAt(e,t,n,i),r.cameraControl.update(!0,!0),r.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),s&&s()}).onComplete(function(){r.camera.LookAt(m,v,y,E.x),r.cameraControl.update(!0,!0),l&&l(),r.getEditorManager().setInteractiveState(!0)}).start(t)},this.active=function(i,r,a,o,s){var l=a.camera,u=new THREE.Vector3(i.position.x,i.position.y,i.position.z),c=new THREE.Vector3(i.target.x,i.target.y,i.target.z),h=new THREE.Vector3(c.distanceTo(u),0,0),d=c.clone().sub(u).normalize(),f=new THREE.Vector3(i.up.x,i.up.y,i.up.z);f.normalize();var p=new THREE.Vector3(i.zoom),m=new THREE.Vector3(r.position.x,r.position.y,r.position.z),g=new THREE.Vector3(r.target.x,r.target.y,r.target.z),v=new THREE.Vector3(g.distanceTo(m),0,0),y=g.clone().sub(m).normalize(),E=new THREE.Vector3(r.up.x,r.up.y,r.up.z);E.normalize();var b=new THREE.Vector3(r.zoom,0,0);if(0==function(){var e=m.clone().sub(u).length()<.01,t=y.clone().sub(d).length()<.01,n=E.clone().sub(f).length()<.01;return!(e&&t&&n)}())return console.log("Current camera status is equal with before."),void(s&&s());a.getEditorManager().setInteractiveState(!1),n.from({animPos:u,animDir:d,animUp:f,animTarget:c,animFocal:h,zoom:p}).to({animPos:m,animDir:y,animUp:E,animTarget:g,animFocal:v,zoom:b},e).onUpdate(function(){var e=this.animTarget,t=this.animDir,n=this.animUp,i=this.animFocal.x,r=this.zoomScale.x;l.setZoom(r),l.LookAt(e,t,n,i),a.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),o&&o(e)}).onComplete(function(){l.setZoom(b.x),l.LookAt(g,y,E,v.x),o&&o(g),s&&s(),a.getEditorManager().setInteractiveState(!0)}).start(t)}},CLOUD.CameraInfo=function(e,t,n,i,r,a,o,s,l){this.name=e,this.position=t,this.target=n,this.up=i,this.fov=r,this.zoom=a,this.frustumWidth=s,this.frustumHeight=l,this.version=void 0===o?1:o},CLOUD.CameraUtil={createCameraInfo:function(e){var t=e.camera,n=new CameraInfo(e.getCameraName(),t.position,t.target,t.up);return JSON.stringify(n)},transformCamera:function(e,t){var n=new THREE.Vector3,i=function(e){return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])]};n.fromArray(i(e.position.split(",")));var r=new THREE.Vector3;r.fromArray(i(e.direction.split(",")));var a=new THREE.Vector3;a.fromArray(i(e.up.split(",")));var o=new THREE.Vector3;o.addVectors(n,r),n.applyMatrix4(t.rootNode.matrix),o.applyMatrix4(t.rootNode.matrix);var s=new THREE.Matrix4;return s.makeRotationFromEuler(t.rootNode.rotation),a.applyMatrix4(s),a.normalize(),new CLOUD.CameraInfo(e.name,n,o,a)},parseCameraInfo:function(e){if(!e)return null;var t=JSON.parse(e);if(!t.hasOwnProperty("position")||!t.hasOwnProperty("target")||!t.hasOwnProperty("up"))return null;var n=t.name||"persp",i=new THREE.Vector3;i.x=t.position.x,i.y=t.position.y,i.z=t.position.z;var r=new THREE.Vector3;r.x=t.target.x,r.y=t.target.y,r.z=t.target.z;var a=new THREE.Vector3;a.x=t.up.x,a.y=t.up.y,a.z=t.up.z;var o=void 0===t.version?0:t.version,s=t.frustumWidth,l=t.frustumHeight;return new CLOUD.CameraInfo(n,i,r,a,void 0,t.zoom,o,s,l)},canvasToNormalized:function(e,t,n){var i={x:0,y:0,z:0};return i.x=e.x/t*2-1,i.y=-e.y/n*2+1,i.z=e.z||0,i},normalizedToCanvas:function(e,t,n){var i={x:0,y:0,z:0};return i.x=Math.floor(.5*(e.x+1)*t+.5),i.y=Math.floor(-.5*(e.y-1)*n+.5),i.z=e.z||0,i},drawingToCanvas:function(e,t,n,i){var r=new THREE.Vector3(t.x,t.y,t.z);return r.project(e),this.normalizedToCanvas(r,n,i)},drawingPointsToCanvas:function(e,t,n,i,r){var a={},o=(new THREE.Matrix4).getInverse(e.matrixWorld),s=new THREE.Vector3(t.x,t.y,t.z);s.applyMatrix4(o);var l=new THREE.Vector3(n.x,n.y,n.z);if(l.applyMatrix4(o),s.z>0&&l.z>0)return null;var u=s.clone().sub(l);if(u.normalize(),s.z>0){var c=(s.z+e.near)/u.z;s.sub(u.multiplyScalar(c))}else if(l.z>0){var c=(l.z+e.near)/u.z;l.sub(u.multiplyScalar(c))}return s.applyMatrix4(e.projectionMatrix),l.applyMatrix4(e.projectionMatrix),a.start=this.normalizedToCanvas(s,i,r),a.end=this.normalizedToCanvas(l,i,r),a},lineIntersectWithRect:function(e,t){if(e&&e.start.x==e.end.x&&e.start.y==e.end.y)return console.log("Invalid line."),null;var n=0,i=0;e.start.x!=e.end.x&&(n=(e.start.y-e.end.y)/(e.start.x-e.end.x)),i=e.start.y-n*e.start.x;var r=[],a=t.min,o=t.max;return n*a.x+i>=a.y&&n*a.x+i<=o.y&&r.push(new THREE.Vector2(a.x,n*a.x+i)),n*o.x+i>=a.y&&n*o.x+i<=o.y&&r.push(new THREE.Vector2(o.x,n*o.x+i)),0==n&&(r.push(new THREE.Vector2(a.x,i)),r.push(new THREE.Vector2(o.x,i))),(a.y-i)/n>a.x&&(a.y-i)/n<o.x&&r.push(new THREE.Vector2((a.y-i)/n,a.y)),(o.y-i)/n>a.x&&(o.y-i)/n<o.x&&r.push(new THREE.Vector2((o.y-i)/n,o.y)),r},canvasToDrawing:function(e,t,n,i){var r=this.canvasToNormalized(t,n,i),a=new THREE.Vector3(r.x,r.y,r.z);return a.unproject(e),{x:a.x,y:a.y,z:a.z}},intersectBoxByRay:function(e,t){var n,i,r,a,o,s,l=1/e.direction.x,u=1/e.direction.y,c=1/e.direction.z,h=e.origin;return l>=0?(n=(t.min.x-h.x)*l,i=(t.max.x-h.x)*l):(n=(t.max.x-h.x)*l,i=(t.min.x-h.x)*l),u>=0?(r=(t.min.y-h.y)*u,a=(t.max.y-h.y)*u):(r=(t.max.y-h.y)*u,a=(t.min.y-h.y)*u),n>a||r>i?null:((r>n||n!==n)&&(n=r),(a<i||i!==i)&&(i=a),c>=0?(o=(t.min.z-h.z)*c,s=(t.max.z-h.z)*c):(o=(t.max.z-h.z)*c,s=(t.min.z-h.z)*c),n>s||o>i?null:((o>n||n!==n)&&(n=o),(s<i||i!==i)&&(i=s),i<0?null:n>=0?n:i))},intersectObjectWithFrustum:function(){var e=new THREE.Box3;return function(t,n){if(!t.boundingBox||t instanceof THREE.Mesh){var i=t.geometry;null===i.boundingBox&&i.computeBoundingBox(),e.copy(i.boundingBox)}else e.copy(t.boundingBox);return e.applyMatrix4(t.matrixWorld),n.intersectsBox(e)}}()},function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.manager=t,this.viewer=t.viewer,this.countRenderRequest=0,this.maxCountRenderRequest=1e4,this.rendering=!1,this.incrementRenderHandle=0,this.renderer=new THREE.WebGLRendererByIncrement(n),this.orderedRenderer=new CLOUD.OrderedRenderer,this.renderer.setRenderer(this.orderedRenderer),this.renderer.setRenderTicket(0)}return _createClass(e,[{key:"destroy",value:function(){this.incrementRenderHandle>0&&cancelAnimationFrame(this.incrementRenderHandle),this.renderer&&(this.renderer.destroy&&this.orderedRenderer&&(this.renderer.destroy(),this.renderer.setRenderer&&this.renderer.setRenderer(null),this.orderedRenderer=null),this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.viewer=null,this.manager=null}},{key:"forceRenderOneFrame",value:function(){var e=this.viewer,t=e.camera,n=e.modelManager.getScene();this.orderedRenderer.restart(),this.orderedRenderer.setNonBreakingRender(!0),this.renderer.render(n,t,null,!0),this.orderedRenderer.setNonBreakingRender(!1)}},{key:"_render",value:function(){function e(c,h){var d=c;return function(){s.autoClear=h,a.cameraChange?(s.resetIncrementRender(),s.autoClear=!0,a.cameraChange=!1,t.orderedRenderer.forceClear=!0,n.getIBLManager().renderWithOrthCamera(n,s,l)):(s.autoClear=h,t.orderedRenderer.forceClear=h||t.orderedRenderer.forceClear),s.render(o,i)||d!==t.countRenderRequest?(t.rendering=!1,d!==t.countRenderRequest?n.render():(t.pickingEffectRendering=!0,t._applyPickingEffect(),r.setFilterApplied(!1),n.onRenderFinishedCallback(),r.disposeBufferAfterVbo(),t.pickingEffectRendering=!1,s.autoClear=u)):t.incrementRenderHandle=requestAnimationFrame(e(d,!1))}}if(this.manager.prepareRender()&&(++this.countRenderRequest,this.countRenderRequest>this.maxCountRenderRequest&&(this.countRenderRequest=0),!this.rendering&&!this.pickingEffectRendering)){this.rendering=!0;var t=this,n=this.viewer,i=n.camera,r=n.modelManager,a=n.editorManager,o=n.getScene(),s=this.renderer;r.calculateCameraModelRelation(i.position),n.calculateNearFar(),n.cameraControl.updateCamera(),o.updateLights(i);var l=a.isUpdateRenderList;s.resetIncrementRender(),s.setObjectListUpdateState(l);var u=s.autoClear;l&&r.prepareScene(i),n.getIBLManager().renderWithOrthCamera(n,s,l),this.incrementRenderHandle=requestAnimationFrame(e(t.countRenderRequest,s.autoClear)),n.onRenderCallback(),n.cameraControl.setCameraChanging(!1)}}},{key:"render",value:function(e){this._render(e)}},{key:"_applyPickingEffect",value:function(){var e=this.manager.getPickingEffecter();if(e){var t=this.viewer.modelManager.isFilterApplied();this.orderedRenderer.restart(),this.orderedRenderer.setNonBreakingRender(!0),e.apply(t),this.orderedRenderer.setNonBreakingRender(!1)}}},{key:"setSize",value:function(e,t){this.renderer.setSize(e,t)}},{key:"getSize",value:function(){return this.renderer.getSize()}}]),e}();CLOUD.IncrementedRenderer=e}(),function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.manager=t,this.viewer=t.viewer,this.composer=null,this.blinkHandle=0,this.renderer=new THREE.WebGLRenderer(n);var i=this.viewer,r=i.domElement.offsetWidth,a=i.domElement.offsetHeight;CLOUD.GlobalData.EnableSelectionOutline&&(this.renderer.shadowMap.enabled=!0,this.composer=new CLOUD.RenderEffectComposer(this.renderer),this.composer.init(i.modelManager,i.getScene(),i.camera,r,a))}return _createClass(e,[{key:"destroy",value:function(){this.blinkHandle>0&&cancelAnimationFrame(this.blinkHandle),this.composer&&(this.composer.destroy(),this.composer=null),this.renderer&&(this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.viewer=null,this.manager=null}},{key:"_render",value:function(e){function t(){a.calculateCameraModelRelation(r.position),i.calculateNearFar(),i.cameraControl.updateCamera(),o.updateLights(r),a.prepareScene(r,function(){a.setRenderStateChanged(!0),i.render()}),a.getBlinkEnabled()&&a.updateBlinkMaterial();var e=s.autoClear;if(o.fillClipPlane&&CLOUD.GlobalData.ClippingCaps){a.prepareCapScene(),s.clear(),i.getIBLManager().renderWithOrthCamera(i,s),s.autoClear=!1;var l=s.context,u=s.state;u.buffers.stencil.setTest(!0),u.buffers.stencil.setFunc(l.ALWAYS,1,255),u.buffers.stencil.setOp(l.KEEP,l.KEEP,l.INCR),o.overrideMaterial=o.backMaterial,o.backFrontStencil=!0,s.render(o,r),u.buffers.stencil.setFunc(l.ALWAYS,1,255),u.buffers.stencil.setOp(l.KEEP,l.KEEP,l.DECR),o.overrideMaterial=o.frontMaterial,s.render(o,r),o.backFrontStencil=!1,u.buffers.stencil.setFunc(l.LEQUAL,1,255),u.buffers.stencil.setOp(l.KEEP,l.KEEP,l.KEEP),s.render(a.capsScene,r),u.buffers.stencil.setTest(!1),o.overrideMaterial=null,s.render(o,r),CLOUD.ExtrudeBodyManager.getInstance(i).setVisible(!1),s.render(o,r),s.autoClear=e,CLOUD.ExtrudeBodyManager.getInstance(i).applyFrontEffect(s,o,r)}else n.composer?n.composer.render():(i.getIBLManager().renderWithOrthCamera(i,s),CLOUD.ExtrudeBodyManager.getInstance(i).setVisible(!1),s.render(o,r),s.autoClear=e,CLOUD.ExtrudeBodyManager.getInstance(i).applyFrontEffect(s,o,r));n._applyPickingEffect(),a.setFilterApplied(!1),i.onRenderCallback(),i.onRenderFinishedCallback(),i.cameraControl.isCameraChanging()&&a.dispatchEvent({type:CLOUD.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED}),i.cameraControl.setCameraChanging(!1),a.getBlinkEnabled()&&(n.blinkHandle=requestAnimationFrame(t)),a.disposeBufferAfterVbo()}if(this.manager.prepareRender()){var n=this,i=this.viewer,r=i.camera,a=i.modelManager,o=i.getScene(),s=this.renderer;this.blinkHandle>0&&cancelAnimationFrame(this.blinkHandle),t()}}},{key:"render",value:function(e){this._render(e)}},{key:"_applyPickingEffect",value:function(){var e=this.manager.getPickingEffecter();if(e){var t=this.viewer.modelManager.isFilterApplied();e.apply(t)}}},{key:"setSize",value:function(e,t){this.renderer.setSize(e,t),this.composer&&this.composer.setSize(e,t)}},{key:"getSize",value:function(){return this.renderer.getSize()}}]),e}();CLOUD.BatchedRenderer=e}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return i.fps=n.fps||0,i._running=!1,i._paused=!1,i._destroyed=!1,i._showRenderErrors=!0,i._renderRequested=!0,i._frameState=new CLOUD.FrameState,i.start(),i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this._destroyed=!0,this._frameState=this._frameState.destroy(),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"renderLoop",value:function(){var e=new Date,t=this._frameState;t.newFrame=!1;var n=this.checkCameraChange(),i=this._renderRequested||n;if(i){this._renderRequested=!1;var r=CLOUD.Math.incrementWrap(t.frameNumber,15e6,1);this.updateFrameNumber(r,e),t.newFrame=!0}this.preUpdate(t),i&&this.update(t),this.postUpdate(t),this._callFunctionsForAfterRender()}},{key:"render",value:function(){}},{key:"preUpdate",value:function(e){CLOUD.EventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ON_PRE_UPDATE,params:{}}),this.viewer.getModelManager().traverseValidModels(function(t){t.preUpdate(e)})}},{key:"update",value:function(e){this.updateFrameState(),this.viewer.getModelManager().traverseValidModels(function(t){t.update(e)}),this.createPotentiallyVisibleSet(),this._render()}},{key:"postUpdate",value:function(e){CLOUD.EventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ON_POST_UPDATE,params:{}}),this.viewer.getModelManager().traverseValidModels(function(t){t.postUpdate(e)})}},{key:"createPotentiallyVisibleSet",value:function(){}},{key:"updateFrameNumber",value:function(e,t){var n=this._frameState;n.frameNumber=e,n.time=t}},{key:"updateFrameState",value:function(){var e=this.viewer.camera;this._frameState.camera=e}},{key:"_callFunctionsForAfterRender",value:function(){for(var e=this,t=this._frameState.afterRender,n=0,i=t.length;n<i;++n)t[n](),e.requestRender();t.length=0}},{key:"requestRender",value:function(){this._renderRequested=!0}},{key:"start",value:function(){function e(i){if(!t.isDestroyed()&&(t._running||t._paused))try{var r=t.fps;if(r>0){var a=1e3/r,o=i-n;o>a&&(t.resize(),t._running&&!t._paused&&t.renderLoop(),n=i-o%a),requestAnimationFrame(e)}else t.resize(),t._running&&!t._paused&&t.renderLoop(),requestAnimationFrame(e)}catch(e){t._running=!1,t._showRenderErrors&&(console.error("An error occurred while rendering. Rendering has stopped."),console.error(e))}}if(!this._running){this._running=!0,this._paused=!1;var t=this,n=0;requestAnimationFrame(e)}}},{key:"pause",value:function(e){this._paused=e}},{key:"stop",value:function(){this._running&&(this._running=!1,this._paused=!1)}},{key:"checkCameraChange",value:function(){return!0}},{key:"resize",value:function(){}},{key:"isDestroyed",value:function(){return this._destroyed}},{key:"frameState",get:function(){return this._frameState}}]),t}(CLOUD.BatchedRenderer);CLOUD.OoCRenderer=e}(),CLOUD.RenderGroup=function(){function e(e,t){return e.material.id!==t.material.id?e.material.id-t.material.id:e.id-t.id}function t(e,t){return e.z!==t.z?t.z-e.z:e.id-t.id}function n(e,t,n,i,r,a,o){c=Date.now();for(var l=t.length,u=s;u<l;u++){var f=t[u],p=f.object,m=f.material,g=f.group,v=f.geometry;if(p.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,p.matrixWorld),p.normalMatrix.getNormalMatrix(p.modelViewMatrix),v=e.updateObject(p),e.renderBufferDirect(n,r,v,m,p,g),!o&&(h=Date.now(),(d=h-c)>CLOUD.GlobalData.LimitFrameTime))return s=u+1,!1}return s=0,!0}var i=[],r=[],a=-1,o=-1,s=0,l=!1,u=!1,c=0,h=0,d=0;this.getOpaqueObjects=function(){return i},this.getTransparentObjects=function(){return r},this.destroy=function(){i=[],r=[]},this.restart=function(){s=0,l=!1,u=!1},this.prepare=function(){this.restart(),a=-1,o=-1},this.renderableCount=function(){return a+o},this.pushRenderItem=function(e,t,n,s,l){var u,c;n.transparent?(u=r,c=++o):(u=i,c=++a);var h=u[c];void 0!==h?(h.id=e.id,h.object=e,h.geometry=t,h.material=n,h.z=s,h.group=l||null):(h={id:e.id,object:e,geometry:t,material:n,z:s,group:l||null},u[c]=h)},this.sortRenderList=function(n){i.length=a+1,r.length=o+1,n&&(i.sort(e),r.sort(t))},this.renderOpaqueObjects=function(e,t,r,a,o,s){return l||(l=n(e,i,t,r,a,o,s)),l},this.renderTransparentObjects=function(e,t,i,a,o,s){return u||(u=n(e,r,t,i,a,o,s)),u}},CLOUD.OrderedRenderer=function(){function e(){++o>1e5&&(o=0);for(var e=0,t=h.length;e<t;++e){var n=h[e];void 0!==n&&n.prepare()}}function t(e,t,n,i,r){var a=h[e.renderOrder];void 0===a&&(a=new CLOUD.RenderGroup,h[e.renderOrder]=a),a.pushRenderItem(e,t,n,i,r)}function n(){for(var e=0,t=h.length;e<t;++e){var n=h[e];void 0!==n&&n.sortRenderList(s)}}function i(e,n){if(!1===e.visible||!1===e.alive)return!0;if(e._cullTicket!=o){if(!v){if(Date.now()-u>30)return!1}if(e._cullTicket=o,(e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!1===e.frustumCulled||!0===d.intersectsObject(e))){var r=e.material,a=e.geometry;if(p.setFromMatrixPosition(e.matrixWorld),p.applyMatrix4(f),Array.isArray(r))for(var s=a.groups,l=0,c=s.length;l<c;l++){var h=s[l],m=r[h.materialIndex];m.transparent?t(e,a,m,p.z,h):t(e,a,m,0,h)}else r.transparent?t(e,a,r,p.z):t(e,a,r,0)}}var g=e.children;if(g)for(var l=0,c=g.length;l<c;l++)if(!i(g[l],n))return!1;return!0}function r(t,r,a){if(!m)return void(s=!0);s&&(e(),y.projectLights(t,a)),u=Date.now(),s=i(t,r),n()}function a(){m&&!g||++c,c>1e4&&(c=0)}var o=0,s=!1,l=!1,u=0,c=0,h=[],d=null,f=null,p=new THREE.Vector3,m=!0,g=!0;this.updateObjectList=function(e){m=e};var v=!1;this.setNonBreakingRender=function(e){v=e},this.destroy=function(){for(var e=0,t=h.length;e<t;++e){var n=h[e];void 0!==n&&n.destroy()}},this.restart=function(){for(var e=0,t=h.length;e<t;++e){var n=h[e];void 0!==n&&n.restart()}g=!0,s=!0},this.setFilter=function(e){},this.projectLights=function(e,t){t.length=0;for(var n=e.children,i=0,r=n.length;i<r;i++){var a=n[i];a.isLight&&t.push(a)}};var y=this;this.update=function(e,t){f=t,d=e},this.render=function(e,t,n,i,o,u,d){if(a(),g){if(CLOUD.Logger.time("build object list"),r(t,n,i),CLOUD.Logger.timeEnd("build object list"),!s)return!1;u=this.forceClear||e.autoClear,g=!1,this.forceClear=!1,e.setupLights(i,n),e.setRenderTarget(o)}CLOUD.Logger.time("increment render object"),(e.autoClear||u)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil,m);var f=t.fog;e.setRenderTicket(c),d.setBlending(THREE.NoBlending);for(var p=h.length-1;p>=0;--p){var y=h[p];if(void 0!==y&&!(l=y.renderOpaqueObjects(e,n,i,f,m,v)))break}if(l)for(var p=h.length-1;p>=0;--p){var y=h[p];if(void 0!==y&&!(l=y.renderTransparentObjects(e,n,i,f,void 0,v)))break}return 0==h.length&&(l=!0),d.buffers.depth.setTest(!0),d.buffers.depth.setMask(!0),d.buffers.color.setMask(!0),CLOUD.Logger.timeEnd("increment render object"),l}},CLOUD.RenderComposer=function(){function e(){function e(e){e.material.blending=THREE.NoBlending,e.material.depthWrite=!1,e.material.depthTest=!1}r=new CLOUD.ShaderPass(FXAAShader),e(r),a=new CLOUD.ShaderPass(CopyShader),e(a)}var t,n,i,r,a,o,s,l=null,u=null,c=!1,h=!0,d=!1;this.init=function(n,i,r){if(e(),!n)return void console.log("You need a gl context to make a renderer. Things will go downhill from here.");o=i,s=r,t=n,this.setSize(i,r,!0)},this.cleanup=function(){l&&(l.dispose(),l=null),u&&(u.dispose(),u=null)},this.setSize=function(e,n,i){if(o=e,s=n,0===e&&0===n||!t)return void this.cleanup();var a=0|e*t.getPixelRatio(),c=0|n*t.getPixelRatio(),h=1/a,d=1/c;!i&&l&&l.width==a&&l.height==c||(this.cleanup(),l=new THREE.WebGLRenderTarget(a,c,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1}),l.texture.generateMipmaps=!1,l.texture.name="_color_rt1",u=l.clone(),u.texture.name="_write_rt1"),r.uniforms.uResolution.value.set(h,d)},this.renderIncrement=function(e,r){if(!l&&o)this.setSize();else if(!l&&!o)return;return CLOUD.GlobalData.SSAO&&!i&&(i=new THREE.SSAOPass(e,r,o,s)),n=r,h&&(d||(t.resetIncrementRender(),t.setClearColor(0,0),t.clearTarget(l,!0,!0,!1)),h=!1),t.autoClear=!1,c||(c=t.render(e,n,l))&&(a.renderToScreen=!0,t.resetIncrementRender(),a.render(t,null,l)),c},this.render=function(e,r){if(!l&&o)this.setSize();else if(!l&&!o)return;var u=CLOUD.GlobalData.SSAO;u&&!i&&(i=new THREE.SSAOPass(e,r,o,s)),n=r,h&&(d||(t.setClearColor(0,0),t.clearTarget(l,!0,!0,!1)),h=!1),t.autoClear=!1,d||t.render(e,n,l);var c=u?i:a;c.renderToScreen=!0,c.render(t,null,l)},this.restart=function(e,t){d=!!e,c=!1,h=!0},this.finish=function(){}},CLOUD._renderComposer=new CLOUD.RenderComposer,function(){var e=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.renderer=null,this.pickingEffecter=null}return _createClass(e,[{key:"destroy",value:function(){this.renderer&&(this.renderer.destroy(),this.renderer=null),this.pickingEffecter&&(this.pickingEffecter.destroy(),this.pickingEffecter=null),this.viewer=null}},{key:"setupRenderer",value:function(e){if(!this.renderer){var t=this.viewer;CLOUD.GlobalData.BatchMergeEnabled?CLOUD.GlobalData.DynamicScheduling?(console.log("renderer: BatchedRenderer(OOC)"),this.renderer=new CLOUD.OoCRenderer(this,e)):(console.log("renderer: BatchedRenderer"),this.renderer=new CLOUD.BatchedRenderer(this,e)):(t.modelManager.permitBlink(!0),console.log("renderer: IncrementedRenderer"),this.renderer=new CLOUD.IncrementedRenderer(this,e)),this._initRenderer()}}},{key:"prepareRender",value:function(){var e=this.renderer;if(!e)return!1;var t=this.viewer,n=t.modelManager;return!!n.isDrawable()&&(n.hasModel()?(!CLOUD.GlobalData.IBL||0!=t.getIBLManager().textureLoad)&&(!n.checkLayerDataLoading()&&(t.getScene().fillClipPlane&&CLOUD.GlobalData.ClippingCaps&&CLOUD.GlobalData.BatchMergeEnabled&&t.setRenderStateChanged(!0),!0)):(CLOUD.Logger.log("model not loaded!"),e.forceRenderOneFrame(),!1))}},{key:"render",value:function(e){this.renderer.render(e)}},{key:"getRenderer",value:function(){if(this.renderer)return this.renderer.renderer}},{key:"setSize",value:function(e,t){this.renderer&&this.renderer.setSize(e,t)}},{key:"getRendererSize",value:function(){return this.renderer?this.renderer.getSize():{width:0,height:0}}},{key:"getPickingEffecter",value:function(){return CLOUD.GlobalData.PickingEffect?(this.pickingEffecter||(this.pickingEffecter=new CLOUD.PickingEffecter(this.viewer)),this.pickingEffecter):null}},{key:"_initRenderer",value:function(){var e=this.viewer,t=e.domElement,n=t.offsetWidth,i=t.offsetHeight,r=this.renderer.renderer;r.setClearColor(0,0),r.setPixelRatio(window.devicePixelRatio||1),r.setSize(n,i),r.toneMapping=CLOUD.GlobalData.ToneMapping,r.gammaFactor=2.2,r.gammaInput=!0,r.gammaOutput=!0,r.domElement.setAttribute("tabindex","0"),r.domElement.setAttribute("id","cloud-main-canvas"),e.domElement.appendChild(r.domElement)}}]),e}();CLOUD.RendererManager=e}(),THREE.SSAOShader={uniforms:{tDiffuse:{value:null},tDepth:{value:null},size:{value:new THREE.Vector2(512,512)},cameraNear:{value:1},cameraFar:{value:100},radius:{value:32},onlyAO:{value:0},aoClamp:{value:.25},lumInfluence:{value:.7}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),
fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","#ifdef USE_LOGDEPTHBUF","uniform float logDepthBufFC;","#endif","uniform float radius;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","const int samples = 64;","const bool useNoise = true;","const float noiseAmount = 0.0004;","const float diffArea = 0.4;","const float gDisplace = 0.4;","#include <packing>","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( size.x / 2.0 ) );","float gg = fract( coord.t * ( size.y / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","vec4 blurX( sampler2D texture, vec2 uv, float s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x - 4.0 * s, uv.y ) ) * 0.051;","\tsum += texture2D( texture, vec2( uv.x - 3.0 * s, uv.y ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x - 2.0 * s, uv.y ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x - 1.0 * s, uv.y ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.1633;","\tsum += texture2D( texture, vec2( uv.x + 1.0 * s, uv.y ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x + 2.0 * s, uv.y ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x + 3.0 * s, uv.y ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x + 4.0 * s, uv.y ) ) * 0.051;","\treturn sum;","}","vec4 blurY( sampler2D texture, vec2 uv, float s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x, uv.y - 4.0 * s ) ) * 0.051;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 3.0 * s ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 2.0 * s ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 1.0 * s ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.1633;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 1.0 * s ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 2.0 * s ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 3.0 * s ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 4.0 * s ) ) * 0.051;","\treturn sum;","}","vec4 blur( sampler2D texture, vec2 uv, vec2 s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x - s.x, uv.y + s.y ) ) * 0.0947416;","\tsum += texture2D( texture, vec2( uv.x, uv.y + s.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x + s.x, uv.y + s.y ) ) * 0.0947416;","\tsum += texture2D( texture, vec2( uv.x - s.x, uv.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.147761;","\tsum += texture2D( texture, vec2( uv.x + s.x, uv.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x - s.x, uv.y - s.y ) ) * 0.0947416;","\tsum += texture2D( texture, vec2( uv.x, uv.y - s.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x + s.x, uv.y - s.y ) ) * 0.0947416;","\treturn sum;","}","float readDepth( const in vec2 coord ) {","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","vec4 depthColor = texture2D( tDepth, coord );","#ifdef USE_LOGDEPTHBUF","float logz = unpackRGBAToDepth( depthColor );","float w = pow(2.0, (logz / logDepthBufFC)) - 1.0;","float z = (logz / w) + 1.0;","#else","float z = unpackRGBAToDepth( depthColor );","#endif","return cameraCoef / ( cameraFarPlusNear - z * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 8.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * ( dd * dd ) / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + radius * vv;","vec2 coord2 = vUv - radius * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / size.x ) / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / size.y ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float ao = 0.0;","float dz = 1.0 / float( samples );","float l = 0.0;","float z = 1.0 - dz / 2.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","float pw = cos( l ) * r;","float ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","vec4 color = texture2D( tDiffuse, vUv ).rgba;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color.rgb * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, color.a );","}"].join("\n")},THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),
fragmentShader:["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","varying vec2 vUv;","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","/*--------------------------------------------------------------------------*/","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","/*==========================================================================*/","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","/*============================================================================","                        FXAA QUALITY - TUNING KNOBS","------------------------------------------------------------------------------","NOTE the other tuning knobs are now in the shader function inputs!","============================================================================*/","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","/*============================================================================","","                           FXAA QUALITY - PRESETS","","============================================================================*/","","/*============================================================================","                     FXAA QUALITY - MEDIUM DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","/*============================================================================","                     FXAA QUALITY - LOW DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","/*============================================================================","                     FXAA QUALITY - EXTREME QUALITY","============================================================================*/","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","/*============================================================================","","                                API PORTING","","============================================================================*/","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","/*============================================================================","                   GREEN AS LUMA OPTION SUPPORT FUNCTION","============================================================================*/","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","/*============================================================================","","                             FXAA3 QUALITY - PC","","============================================================================*/","#if (FXAA_PC == 1)","/*--------------------------------------------------------------------------*/","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immediates.","    // Immediates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","/*--------------------------------------------------------------------------*/","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","/*--------------------------------------------------------------------------*/","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","/*--------------------------------------------------------------------------*/","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","/*--------------------------------------------------------------------------*/","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","/*--------------------------------------------------------------------------*/","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","/*--------------------------------------------------------------------------*/","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","/*--------------------------------------------------------------------------*/","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","/*--------------------------------------------------------------------------*/","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","/*--------------------------------------------------------------------------*/","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","/*--------------------------------------------------------------------------*/","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","    #endif","/*--------------------------------------------------------------------------*/","                        }","                        #endif","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","/*--------------------------------------------------------------------------*/","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","/*--------------------------------------------------------------------------*/","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","/*--------------------------------------------------------------------------*/","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","/*--------------------------------------------------------------------------*/","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","/*==========================================================================*/","#endif","","void main() {","  gl_FragColor = FxaaPixelShader(","    vUv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  gl_FragColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n")
},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},i=e.getSize();t=new THREE.WebGLRenderTarget(i.width,i.height,n),t.texture.name="EffectComposer.rt1"}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,n,i=!1,r=this.passes.length;for(n=0;n<r;n++)if(t=this.passes[n],!1!==t.enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),t.needsSwap){if(i){var a=this.renderer.context;a.stencilFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),a.stencilFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(t instanceof THREE.MaskPass?i=!0:t instanceof THREE.ClearMaskPass&&(i=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getSize();e=this.renderTarget1.clone(),e.setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var n=0;n<this.passes.length;n++)this.passes[n].setSize(e,t)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(e,t){},render:function(e,t,n,i,r){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),function(){var e=function(){function e(t){_classCallCheck(this,e),this.renderer=t,this.composer=null,this.renderPass=null,this.outlinePass=null,this.effectFXAA=null,this.selectedObjectIds=[]}return _createClass(e,[{key:"destroy",value:function(){this.renderer=null,this.composer=null,this.renderPass.dispose(),this.renderPass=null,this.outlinePass.dispose(),this.outlinePass=null,this.effectFXAA=null,this.selectedObjectIds=null}},{key:"init",value:function(e,t,n,i,r){this.composer=new THREE.EffectComposer(this.renderer),this.renderPass=new THREE.RenderPass(t,n),this.composer.addPass(this.renderPass),this.outlinePass=new CLOUD.OutlinePass(new THREE.Vector2(i,r),e,t,n),this.composer.addPass(this.outlinePass),this.effectFXAA=new THREE.ShaderPass(THREE.FXAAShader),this.effectFXAA.uniforms.resolution.value.set(1/i,1/r),this.effectFXAA.renderToScreen=!0,this.composer.addPass(this.effectFXAA)}},{key:"render",value:function(){this.composer.render()}},{key:"setSize",value:function(e,t){this.composer.setSize(e,t),this.effectFXAA.uniforms.resolution.value.set(1/e,1/t)}},{key:"addSelectedId",value:function(e){this.selectedObjectIds.push(e)}},{key:"clearSelectedIds",value:function(){this.selectedObjectIds.length=0}},{key:"setSelectedIds",value:function(e){if(this.outlinePass){this.clearSelectedIds();for(var t=0,n=e.length;t<n;t++)this.addSelectedId(e[t]);this.outlinePass.selectedObjectIds=this.selectedObjectIds}}},{key:"setOutlineEdgeColor",value:function(e){this.outlinePass.setOutlineEdgeColor(e)}}]),e}();CLOUD.RenderEffectComposer=e}(),THREE.ShaderPass=function(e,t){THREE.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(e,t,n,i,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),THREE.SSAOPass=function(e,t,n,i){if(void 0===THREE.SSAOShader)return console.warn("THREE.SSAOPass depends on THREE.SSAOShader"),new THREE.ShaderPass;THREE.ShaderPass.call(this,THREE.SSAOShader),this.width=void 0!==n?n:512,this.height=void 0!==i?i:256,this.renderToScreen=!1,this.camera2=t,this.scene2=e,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.depthRenderTarget=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.uniforms.tDepth.value=this.depthRenderTarget.texture,this.uniforms.size.value.set(this.width,this.height),this.uniforms.cameraNear.value=this.camera2.near,this.uniforms.cameraFar.value=this.camera2.far,this.uniforms.radius.value=4,this.uniforms.onlyAO.value=!1,this.uniforms.aoClamp.value=.25,this.uniforms.lumInfluence.value=.7,Object.defineProperties(this,{radius:{get:function(){return this.uniforms.radius.value},set:function(e){this.uniforms.radius.value=e}},onlyAO:{get:function(){return this.uniforms.onlyAO.value},set:function(e){this.uniforms.onlyAO.value=e}},aoClamp:{get:function(){return this.uniforms.aoClamp.value},set:function(e){this.uniforms.aoClamp.value=e}},lumInfluence:{get:function(){return this.uniforms.lumInfluence.value},set:function(e){this.uniforms.lumInfluence.value=e}}})},THREE.SSAOPass.prototype=Object.create(THREE.ShaderPass.prototype),THREE.SSAOPass.prototype.render=function(e,t,n,i,r){this.scene2.overrideMaterial=this.depthMaterial,e.render(this.scene2,this.camera2,this.depthRenderTarget,!0),this.scene2.overrideMaterial=null,THREE.ShaderPass.prototype.render.call(this,e,t,n,i,r)},THREE.SSAOPass.prototype.setScene=function(e){this.scene2=e},THREE.SSAOPass.prototype.setCamera=function(e){this.camera2=e,this.uniforms.cameraNear.value=this.camera2.near,this.uniforms.cameraFar.value=this.camera2.far},THREE.SSAOPass.prototype.setSize=function(e,t){this.width=e,this.height=t,this.uniforms.size.value.set(this.width,this.height),this.depthRenderTarget.setSize(this.width,this.height)},THREE.RenderPass=function(e,t,n,i,r){THREE.Pass.call(this),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=i,this.clearAlpha=void 0!==r?r:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},THREE.RenderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.RenderPass,render:function(e,t,n,i,r){var a=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial;var o,s;this.clearColor&&(o=e.getClearColor().getHex(),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:n,this.clear),this.clearColor&&e.setClearColor(o,s),this.scene.overrideMaterial=null,e.autoClear=a}}),function(){var e=function(e){function t(e,n,i,r,a){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));o.modelManager=n,o.renderScene=i,o.renderCamera=r,o.selectedObjectIds=void 0!==a?a:[],o.defaultEdgeColor=(new THREE.Color).setHex(7733223),o.defaultEdgeAlpha=.95,o.edgeColor=new THREE.Vector4(o.defaultEdgeColor.r,o.defaultEdgeColor.g,o.defaultEdgeColor.b,o.defaultEdgeAlpha),o.edgeLength=2,o.resolution=void 0!==e?new THREE.Vector2(e.x,e.y):new THREE.Vector2(256,256);var s={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};o.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetDepthBuffer.texture.name="OutlinePass.depth",o.renderTargetDepthBuffer.texture.generateMipmaps=!1,o.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetMaskBuffer.texture.name="OutlinePass.mask",o.renderTargetMaskBuffer.texture.generateMipmaps=!1,o.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",o.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,o.renderTargetEdgeBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetEdgeBuffer.texture.name="OutlinePass.edge",o.renderTargetEdgeBuffer.texture.generateMipmaps=!1,o.renderTargetColorBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetColorBuffer.texture.name="OutlinePass.color",o.renderTargetColorBuffer.texture.generateMipmaps=!1,o.depthMaterial=new THREE.MeshDepthMaterial,o.depthMaterial.side=THREE.DoubleSide,o.depthMaterial.depthPacking=THREE.RGBADepthPacking,o.depthMaterial.blending=THREE.NoBlending,o.InstancedDepthMaterial=new CLOUD.InstancedDepthMaterial,o.InstancedDepthMaterial.side=THREE.DoubleSide,o.InstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,o.InstancedDepthMaterial.blending=THREE.NoBlending,o.prepareMaskMaterial=o.getPrepareMaskMaterial(),o.prepareMaskMaterial.side=THREE.DoubleSide,o.prepareMaskInstancedMaterial=o.getPrepareMaskInstancedMaterial(),o.prepareMaskInstancedMaterial.side=THREE.DoubleSide,o.edgeDetectionMaterial=o.getEdgeDetectionMaterial(),o.overlayMaterial=o.getOverlayMaterial(),void 0===THREE.CopyShader&&console.error("CLOUD.OutlinePass relies on THREE.CopyShader");var l=THREE.CopyShader;return o.copyUniforms=THREE.UniformsUtils.clone(l.uniforms),o.copyUniforms.opacity.value=1,o.materialCopy=new THREE.ShaderMaterial({uniforms:o.copyUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),o.enabled=!0,o.needsSwap=!1,o.oldClearColor=new THREE.Color,o.oldClearAlpha=1,o.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),o.scene=new THREE.Scene,o.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),o.quad.frustumCulled=!1,o.scene.add(o.quad),o.textureMatrix=new THREE.Matrix4,o}return _inherits(t,e),_createClass(t,[{key:"dispose",value:function(){this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetEdgeBuffer.dispose(),this.renderTargetColorBuffer.dispose()}},{key:"setSize",value:function(e,t){this.renderTargetDepthBuffer.setSize(e,t),this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetMaskDownSampleBuffer.setSize(e,t),this.renderTargetEdgeBuffer.setSize(e,t),this.renderTargetColorBuffer.setSize(e,t)}},{key:"adjustVisibility",value:function(e){this.modelManager.adjustVisibility(e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){this.modelManager.changeVisibilityOfSelectedObjects(e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){this.modelManager.changeVisibilityOfNonSelectedObjects(e)}},{key:"adjustInstanceVisibility",value:function(e){this.modelManager.adjustInstanceVisibility(e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){this.modelManager.changeInstanceVisibilityOfSelectedObjects(e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){this.modelManager.changeInstanceVisibilityOfNonSelectedObjects(e)}},{key:"restoreVisibilityOfObjects",value:function(){this.modelManager.restoreVisibilityOfObjects()}},{key:"updateTextureMatrix",value:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)}},{key:"render",value:function(e,t,n,i,r){if(0!==this.selectedObjectIds.length){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var a=e.autoClear;e.autoClear=!1,r&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(0,0),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.depthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.InstancedDepthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!1),this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.adjustInstanceVisibility(!1),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfNonSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskInstancedMaterial,this.prepareMaskInstancedMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskInstancedMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskInstancedMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!1),this.renderScene.overrideMaterial=null,this.adjustVisibility(!0),this.changeInstanceVisibilityOfNonSelectedObjects(!0),this.restoreVisibilityOfObjects(),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.edgeColor.value=this.edgeColor,this.edgeDetectionMaterial.uniforms.edgeLength.value=this.edgeLength,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.colorTexture.value=n.texture,this.overlayMaterial.uniforms.outlineTexture.value=this.renderTargetEdgeBuffer.texture,e.render(this.scene,this.camera,this.renderTargetColorBuffer,!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetColorBuffer.texture,r&&e.context.enable(e.context.STENCIL_TEST),e.render(this.scene,this.camera,n,!0),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=a}}},{key:"getPrepareMaskMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                #include <packing>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tuniform sampler2D depthTexture;\n\t\t\t\tuniform vec2 cameraNearFar;\n\t\t\t\t\n\t\t\t\tfloat linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = vec4(depth);\n\t\t\t\t}"})}},{key:"getPrepareMaskInstancedMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                attribute float vState;            \n                attribute vec4 aColor;            \n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec2 muvCol0;\n                    attribute vec2 muvCol1;\n                    attribute vec2 muvCol2;\n                #endif\n                \n                varying float vfState;\n                varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\t\n\t\t\t\tvec3 getInstancePosition(vec3 position) {\n                    return vec3(mat4(vec4(mcol0, 0.0),\n                                     vec4(mcol1, 0.0),\n                                     vec4(mcol2, 0.0),\n                                     vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                }\n                \n                vec2 getInstanceUV(vec2 uv) {\n                \n                    #if defined(USE_MAP)\n                        return vec2(mat3(vec3(muvCol0, 0.0),\n                                         vec3(muvCol1, 0.0), \n                                         vec3(muvCol2, 1.0)) * vec3(uv, 1.0));\n                    #else\n                        return uv;\n                    #endif                    \n                    \n                }\n            \n\t\t\t\tvoid main() {\n\t\t\t\t    vfState = vState;\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = vec4(getInstancePosition(position), 1.0);\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vPosition;\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vPosition;\n\t\t\t\t}",fragmentShader:"#include <packing>\n                varying float vfState;\n                varying vec2 vUv;\n                varying vec4 vPosition;\n                varying vec4 projTexCoord;\n                uniform sampler2D depthTexture;\n                uniform vec2 cameraNearFar;\n                \n                float linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n                \n                void main() {\n                    if (vfState <= -0.99 && vfState >= -1.01) discard;\n                    float depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\n                    gl_FragColor = vec4(depth);\n                }"})}},{key:"getEdgeDetectionMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},edgeColor:{value:new THREE.Vector4(1,1,1,1)},edgeLength:{value:2}},vertexShader:"\n                varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                varying vec2 vUv;\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec4 edgeColor;\n                uniform float edgeLength; \n                \n                void main(void)\n                {\n                    float directions[3];\n                    directions[0] = -1.0;\n                    directions[1] = 0.0;\n                    directions[2] = 1.0;\n                \n                    float scalars[3];\n                    scalars[0] = 3.0;\n                    scalars[1] = 10.0;\n                    scalars[2] = 3.0;\n                \n                    float padx = 1.0 / texSize.x;\n                    float pady = 1.0 / texSize.y ; \n                \n                    float edgeSize  = 0.0; \n                    float horizEdge = 0.0;\n                    float vertEdge = 0.0;                    \n                \n                    for (int i = 0; i < 3; ++i)\n                    {\n                        float dir = directions[i];\n                        float scale = scalars[i];\n                \n                        horizEdge -= texture2D(maskTexture, vUv + vec2(-padx, dir * pady)).x * scale;\n                        horizEdge += texture2D(maskTexture, vUv + vec2(padx, dir * pady)).x * scale;\n                \n                        vertEdge -= texture2D(maskTexture, vUv + vec2(dir * padx, -pady)).x * scale;\n                        vertEdge += texture2D(maskTexture, vUv + vec2(dir * padx, pady)).x * scale;\n                    }                    \n                  \n                    float len = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);    \n                    float alpha = len > edgeLength ? edgeColor.a : (texture2D(maskTexture, vUv).w > 0.1 ? 0.1 : 0.0);\n                    gl_FragColor = vec4(edgeColor.rgb, alpha);\n                }"})}},{key:"getOverlayMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{colorTexture:{value:null},outlineTexture:{value:null}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform sampler2D outlineTexture;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 outlineColor = texture2D(outlineTexture, vUv);\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = mix(texture2D(colorTexture, vUv), outlineColor, outlineColor.a);\t\t\t\t\t\n\t\t\t\t}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}},{key:"setOutlineEdgeColor",value:function(e){var t=CLOUD.Utils.hexToRgb(e.color);this.edgeColor.fromArray([t.r,t.g,t.b,e.opacity?e.opacity:1])}}]),t}(THREE.Pass);CLOUD.OutlinePass=e}(),CLOUD.ShaderPass2=function(e,t){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1,this.textureID=void 0!==t?t:"tDiffuse",e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},CLOUD.ShaderPass2.prototype={constructor:CLOUD.ShaderPass2,render:function(e,t,n,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}};var HighlightShader={uniforms:{tDiffuse:{type:"t",value:null},tID:{type:"t",value:null},objID:{type:"i",value:0},objIDv3:{type:"v3",value:new THREE.Vector3(0,0,0)},highlightIntensity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tID;","uniform int objID;","uniform vec3 objIDv3;","uniform float highlightIntensity;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","if (objID != 0) {","vec4 idAtPixel = texture2D(tID, vUv);","vec3 idDelta = abs(idAtPixel.rgb - objIDv3.rgb);","if (max(max(idDelta.r, idDelta.g), idDelta.b) < 1e-3) {","texel.rgb += highlightIntensity * 0.2;","}","}","gl_FragColor = texel;","}"].join("\n")},FXAAShader={uniforms:{tDiffuse:{type:"t",value:null},uResolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 uResolution;","varying vec2 vPos;","varying vec4 vPosPos;","void main() {","vPos = uv;","vPosPos.xy = uv + vec2(-0.5, -0.5) * uResolution;","vPosPos.zw = uv + vec2( 0.5,  0.5) * uResolution;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#define FXAA_EDGE_SHARPNESS (8.0)","#define FXAA_EDGE_THRESHOLD (0.125)","#define FXAA_EDGE_THRESHOLD_MIN (0.05)","#define FXAA_RCP_FRAME_OPT (0.50)","#define FXAA_RCP_FRAME_OPT2 (2.0)","uniform sampler2D tDiffuse;","uniform highp vec2 uResolution;","varying vec2 vPos;","varying vec4 vPosPos;","float FxaaLuma(vec3 rgb) {","return dot(rgb, vec3(0.299, 0.587, 0.114));","}","void main() {","float lumaNw = FxaaLuma(texture2D(tDiffuse, vPosPos.xy).rgb);","float lumaSw = FxaaLuma(texture2D(tDiffuse, vPosPos.xw).rgb);","float lumaNe = FxaaLuma(texture2D(tDiffuse, vPosPos.zy).rgb) + 1.0/384.0;","float lumaSe = FxaaLuma(texture2D(tDiffuse, vPosPos.zw).rgb);","vec3 rgbM = texture2D(tDiffuse, vPos.xy).rgb;","float lumaM = FxaaLuma(rgbM.rgb);","float lumaMax = max(max(lumaNe, lumaSe), max(lumaNw, lumaSw));","float lumaMin = min(min(lumaNe, lumaSe), min(lumaNw, lumaSw));","float lumaMaxSubMinM = max(lumaMax, lumaM) - min(lumaMin, lumaM);","float lumaMaxScaledClamped = max(FXAA_EDGE_THRESHOLD_MIN, lumaMax * FXAA_EDGE_THRESHOLD);","if (lumaMaxSubMinM < lumaMaxScaledClamped) {","   gl_FragColor = rgbM;","   return;","}","float dirSwMinusNe = lumaSw - lumaNe;","float dirSeMinusNw = lumaSe - lumaNw;","vec2 dir1 = normalize(vec2(dirSwMinusNe + dirSeMinusNw, dirSwMinusNe - dirSeMinusNw));","vec3 rgbN1 = texture2D(tDiffuse, vPos.xy - dir1 * FXAA_RCP_FRAME_OPT*uResolution).rgb;","vec3 rgbP1 = texture2D(tDiffuse, vPos.xy + dir1 * FXAA_RCP_FRAME_OPT*uResolution).rgb;","float dirAbsMinTimesC = min(abs(dir1.x), abs(dir1.y)) * FXAA_EDGE_SHARPNESS;","vec2 dir2 = clamp(dir1.xy / dirAbsMinTimesC, -2.0, 2.0);","vec3 rgbN2 = texture2D(tDiffuse, vPos.xy - dir2 * FXAA_RCP_FRAME_OPT2*uResolution).rgb;","vec3 rgbP2 = texture2D(tDiffuse, vPos.xy + dir2 * FXAA_RCP_FRAME_OPT2*uResolution).rgb;","vec3 rgbA = rgbN1 + rgbP1;","vec3 rgbB = ((rgbN2 + rgbP2) * 0.25) + (rgbA * 0.25);","float lumaB = FxaaLuma(rgbB);","if ((lumaB < lumaMin) || (lumaB > lumaMax))","   gl_FragColor = vec4(rgbA * 0.5, rgbM.a);","else","   gl_FragColor = vec4(rgbB, rgbM.a);","}"].join("\n")};CLOUD.PhongLightingMaterial=function(e){THREE.ShaderMaterial.call(this),this.type="PhoneLightingMaterial",this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.emissive=new THREE.Color(0),this.map=null,this.defines={},this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(16711680)},opacity:{value:1},specular:{value:new THREE.Color(1118481)},shininess:{value:30},emissive:{value:new THREE.Color(0)}}]),this.vertexShader=["varying vec3 vViewPosition;","varying vec3 vNormal;","#include <uv_pars_vertex>","void main() {","   #include <uv_vertex>","   #include <begin_vertex>","   #include <project_vertex>","   #include <beginnormal_vertex>","   #include <defaultnormal_vertex>","   vNormal = normalize( transformedNormal );","   vViewPosition = - mvPosition.xyz;","}"].join("\n"),this.fragmentShader=["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 specular;","uniform float shininess;","uniform vec3 emissive;","#include <common>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <packing>","#include <bsdfs>","#include <lights_pars>","#include <lights_phong_pars_fragment>","#include <specularmap_pars_fragment>","void main() {","   vec4 diffuseColor = vec4( diffuse, opacity );","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   diffuseColor = vec4(texelColor.rgb, opacity);","#endif","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","   vec3 totalEmissiveRadiance = emissive;","   float specularStrength = 1.0;","   #include <normal_flip>","   #include <normal_fragment>","   #include <lights_phong_fragment>","   #include <lights_template>","   vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","   #if defined( TONE_MAPPING )","       gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );","   #endif","   gl_FragColor = linearToOutputTexel( gl_FragColor );","}"].join("\n"),this.lights=!0,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("PhoneLightingMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()},CLOUD.PhongLightingMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),CLOUD.PhongLightingMaterial.prototype.constructor=CLOUD.PhongLightingMaterial,CLOUD.PhongLightingMaterial.prototype.isShaderMaterial=!0,CLOUD.PhongLightingMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.emissive.copy(e.emissive),this},CLOUD.PhongLightingMaterial.prototype.refreshUniforms=function(){this.uniforms.diffuse.value.set(this.color),this.uniforms.opacity.value=this.opacity,this.uniforms.specular.value.set(this.specular),this.uniforms.shininess.value=this.shininess,this.uniforms.emissive.value.set(this.emissive),this.uniforms.map.value=this.map}
;var lights_fillFace_template=["GeometricContext geometry;","geometry.position = - vViewPosition;","#if NUM_CLIPPING_PLANES == 1","\tif (gl_FrontFacing) geometry.normal = normal;","\telse if (fillFaceClipDistance < 0.0) geometry.normal = -clippingPlanes[0].xyz;","\telse geometry.normal = -normal;","#else","\tgeometry.normal = normal;","#endif","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","\tPointLight pointLight;","\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","\t\tpointLight = pointLights[ i ];","\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );","\t\t#ifdef USE_SHADOWMAP","\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","\t\t#endif","\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","\tSpotLight spotLight;","\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","\t\tspotLight = spotLights[ i ];","\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );","\t\t#ifdef USE_SHADOWMAP","\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","\t\t#endif","\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","\tDirectionalLight directionalLight;","\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","\t\tdirectionalLight = directionalLights[ i ];","\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","\t\t#ifdef USE_SHADOWMAP","\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\t\t#endif","\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","#endif","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","\tRectAreaLight rectAreaLight;","\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","\t\trectAreaLight = rectAreaLights[ i ];","\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","\t}","#endif","#if defined( RE_IndirectDiffuse )","\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","\t#ifdef USE_LIGHTMAP","\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;","\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS","\t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage","\t\t#endif","\t\tirradiance += lightMapIrradiance;","\t#endif","\t#if ( NUM_HEMI_LIGHTS > 0 )","\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","\t\t}","\t#endif","\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","\t\tirradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 8 );","\t#endif","\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","#endif","#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","\tvec3 radiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, Material_BlinnShininessExponent( material ), 8 );","\t#ifndef STANDARD","\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );","\t#else","\t\tvec3 clearCoatRadiance = vec3( 0.0 );","\t#endif","\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );","#endif"].join("\n"),fillFaceFragment=["#define PHONG","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform float opacity;","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <gradientmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <lights_phong_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","\t#include <clipping_planes_fragment>","\tvec4 diffuseColor = vec4( diffuse, opacity );","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","\tvec3 totalEmissiveRadiance = emissive;","\t#include <logdepthbuf_fragment>","\t#include <map_fragment>","\t#include <color_fragment>","\t#include <alphamap_fragment>","\t#include <alphatest_fragment>","\t#include <specularmap_fragment>","\t#include <normal_flip>","\t#include <normal_fragment>","\t#include <emissivemap_fragment>","   float fillFaceClipDistance = 0.0;","   #if NUM_CLIPPING_PLANES == 1","       vec4 plane = clippingPlanes[ 0 ];","\t    fillFaceClipDistance = dot( vViewPosition, plane.xyz ) - plane.w;","   #endif","\t#include <lights_phong_fragment>","\t#include <lights_fillFace_template>","\t#include <aomap_fragment>","\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","\t#include <envmap_fragment>","\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );","\t#include <tonemapping_fragment>","\t#include <encodings_fragment>","\t#include <fog_fragment>","\t#include <premultiplied_alpha_fragment>","\t#include <dithering_fragment>","}"].join("\n"),meshphongIdVertex=["#define PHONG","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <envmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <envmap_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),newStyleVertex=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),newStyleFragment=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","vec4 diffuseColor = vec4( diffuse, opacity );","vec3 totalEmissiveRadiance = emissive;","#include <logdepthbuf_fragment>","#include <map_fragment>","#include <color_fragment>","#include <alphamap_fragment>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","#include <normal_flip>","#include <normal_fragment>","#include <emissivemap_fragment>","const mat4 diffuseMatrix = mat4(-0.07425443828105927, -0.05652861297130585, 0.12247831374406815, 0.2297295778989792,","                               -0.05652860924601555, 0.034799136221408844, -0.08437120914459229, -0.13896968960762024,","                               0.12247832119464874, -0.08437121659517288, 0.021763987839221954, 0.12510454654693604,","                               0.2297295778989792, -0.13896968960762024, 0.12510454654693604, 0.6190560460090637);","const vec3 sunDir = vec3(-0.6632131338119507, 0.5486575961112976, -0.509041428565979);","vec3 viewDir = normalize( vViewPosition );","vec4 diffuseDir = diffuseMatrix * vec4(normal, 1.0);","float diffuseTerm = dot(vec4(normal, 1.0), diffuseDir);","float nv = max(dot(normal, -viewDir), 0.0);","float vl = max(dot(viewDir, sunDir), 0.0);","diffuseTerm = diffuseTerm + (nv * (1.0 - vl)) * 0.8;","vec3 H = -normalize(sunDir + viewDir);","float nh = max(dot(normal, H), 0.0);","float specularTerm = pow(nh, 100.0);","vec3 color = 1.05 * vec3(0.5, 0.497, 0.49) * (diffuse * diffuseTerm + vec3(specularTerm)) + diffuse * 0.5;","vec3 outgoingLight = color + totalEmissiveRadiance;","gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","}"].join("\n"),cloudStandardVertex=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   attribute float vState;","   attribute float vState2;","   varying float fState;","   attribute vec4 aColor;","   varying vec4 vaColor;","   attribute vec3 mcol0;","   attribute vec3 mcol1;","   attribute vec3 mcol2;","   attribute vec3 mcol3;","   #if defined(USE_MAP)||defined(USE_BUMPMAP) ","       attribute vec2 muvCol0;","       attribute vec2 muvCol1;","       attribute vec2 muvCol2;","   #endif","   #if defined(USE_LIGHTMAP)","       attribute vec4 uv2OffsetRepeat;","   #endif","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","#ifdef USE_FILLPATTERN","   varying vec4 vClipPosition;","#endif","mat3 inverse_mat3(in mat3 m)","{","   float determinant =","    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])","    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])","    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    mat3 inverse;","    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);","    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);","    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);","    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);","    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);","    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);","    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);","    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);","    inverse /= determinant;","    return inverse;","}","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  ","   vUv = vec2(mat3(vec3(muvCol0, 0.0),","                   vec3(muvCol1, 0.0),","                   vec3(muvCol2, 1.0)) * vec3(uv, 1.0));","   vUv = mat2(rotateMatrix) * vec2(vUv.x - 0.5, vUv.y - 0.5) + vec2(0.5, 0.5);","   vUv = (vUv -  offsetRepeat.xy)* offsetRepeat.zw;","#endif","#if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  ","   vUv2.x = uv2OffsetRepeat.x*vUv2.x/ 65535.0 + uv2OffsetRepeat.z ;","   vUv2.y = uv2OffsetRepeat.y*vUv2.y/ 65535.0 + uv2OffsetRepeat.w ;","#endif","vec3 transformed = vec3( position );","#ifdef USE_INSTANCE","vaColor = aColor;","#ifdef INSTANCE_STATE_SECONDARY","fState = vState2;","#else","fState = vState;","#endif","transformed = vec3(mat4(vec4(mcol0, 0.0),","                   vec4(mcol1, 0.0),","                   vec4(mcol2, 0.0),","                   vec4(mcol3, 1.0)) * vec4(transformed, 1.0));","#ifdef USE_INSTANCE_NORMAL","    mat3 normalMat = mat3(mcol0, mcol1, mcol2);","    normalMat = inverse_mat3(normalMat);","    normalMat = transpose(normalMat);","    transformedNormal = normalMat * objectNormal;","    transformedNormal = normalMatrix * transformedNormal;","#ifdef FLIP_SIDED","   transformedNormal = - transformedNormal;","#endif","    transformedNormal = normalize( transformedNormal );","#endif","#endif","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#ifdef USE_FILLPATTERN","    vClipPosition = gl_Position;","#endif","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),cloudStandardFragment=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float imageFade;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   varying vec4 vaColor;","   varying float fState;","#endif","#ifdef USE_FILLPATTERN","   uniform vec2 viewportSize;","   uniform sampler2D fillMap;","   varying vec4 vClipPosition;","#endif","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","uniform vec4 blinkColor;","uniform float blinkCoefficient;","uniform float colorState;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","vec3 hdrDecode(in vec4 rgbm) {","const float rgbmScale = 2.82842712;","vec3 r = rgbm.rgb * (rgbmScale * (1.0 - rgbm.a));","return r * r;","}","vec3 linearToGammaUnreal(in vec3 rgb) {","    return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);","}","bool floatEqual(in float x, in float y) {","    return (x >= y - 0.01) && (x <= y + 0.01);","}","bool floatNotEqual(in float x, in float y) {","    return (x <= y - 0.01) || (x >= y + 0.01);","}","void main() {","#include <clipping_planes_fragment>","#ifdef USE_FILLPATTERN","    vec4 clipPosition = vClipPosition;","    clipPosition.xyz /= clipPosition.w; ","    clipPosition.xyz = clipPosition.xyz * 0.5 + 0.5; ","    vec2 screenPosition = vec2(clipPosition.x * viewportSize.x, clipPosition.y * viewportSize.y);","    float flag = texture2D(fillMap, vec2(screenPosition.x/32.0, screenPosition.y/32.0)).r;","    if(flag == 0.0)","    {","        discard;","    }","#endif","vec4 diffuseColor = vec4( diffuse, opacity );","#ifdef USE_INSTANCE","   if (floatEqual(fState, -1.0)) ","       discard;","   if (floatNotEqual(fState, 0.0)) ","       diffuseColor = vaColor;","#endif","vec4 selectedColor = diffuseColor;","#ifndef USE_LIGHTMAP","diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));","#endif","ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive;","#include <logdepthbuf_fragment>","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);","   #ifdef USE_INSTANCE","       if (floatNotEqual(fState, 0.0)) ","           diffuseColor.a = vaColor.a;","   #endif","#endif","#include <color_fragment>","#include <alphamap_fragment>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","float flipNormal = 1.0;","#include <normal_fragment>","#include <emissivemap_fragment>","#include <lights_physical_fragment>"," GeometricContext geometry;","geometry.position = - vViewPosition;","geometry.normal = normal;","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","PointLight pointLight;","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {"," pointLight = pointLights[ i ];","getPointDirectLightIrradiance( pointLight, geometry, directLight );","#ifdef USE_SHADOWMAP","        directLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","        #endif","        RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","    SpotLight spotLight;","    for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","        spotLight = spotLights[ i ];","        getSpotDirectLightIrradiance( spotLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","        directLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","        #endif","        RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","    DirectionalLight directionalLight;","    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","        directionalLight = directionalLights[ i ];","        getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","        if(opacity > 0.9)","        directLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","        #endif","       RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","   RectAreaLight rectAreaLight;","    for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","        rectAreaLight = rectAreaLights[ i ];","        RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","    }","#endif","#if defined( RE_IndirectDiffuse )","    vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","    #if ( NUM_HEMI_LIGHTS > 0 )","       for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","           irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","       }","    #endif","    #if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","       irradiance += getLightProbeIndirectIrradiance( geometry, 8 );","    #endif","    RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","    #endif","    #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","    vec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );","    #ifndef STANDARD","    vec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );","    #else","    vec3 clearCoatRadiance = vec3( 0.0 );","    #endif","    RE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );","    #endif","#include <aomap_fragment>","vec3 diffuseSpecularEmissive = vec3(0.0);","#ifdef USE_LIGHTMAP","   vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity;","   vec3 diffuseSpecular =  clamp(diffuseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;","   diffuseSpecularEmissive = diffuseSpecular + diffuseColor.rgb * 0.0;","#endif","vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","#ifdef USE_COLORWITHOUTLIGHT","   gl_FragColor = diffuseColor;","#else","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#endif","#ifdef USE_INSTANCE","    #ifdef USE_MAP","         if (floatEqual(fState, 3.0))","             gl_FragColor = vaColor;","    #endif","#endif","#if defined( TONE_MAPPING )","   #if defined(USE_LIGHTMAP)","       gl_FragColor.rgb = linearToGammaUnreal(diffuseSpecularEmissive.xyz );","   #else","       gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );","   #endif","#endif","#ifdef USE_INSTANCE","       if (floatEqual(fState, 2.0))","           gl_FragColor = selectedColor;","       if (floatEqual(fState, 5.0) && floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","#else","       if (floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","       if (floatEqual(colorState, 2.0))","           gl_FragColor = selectedColor;","#endif","#ifndef USE_LIGHTMAP","  #include <encodings_fragment>","#endif","#include <fog_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","}"].join("\n");THREE.ShaderChunk.meshphong_id_vert=meshphongIdVertex,THREE.ShaderChunk.lights_fillFace_template=lights_fillFace_template,THREE.ShaderChunk.fillFaceFragment=fillFaceFragment,THREE.ShaderChunk.cloudStandardVertex=cloudStandardVertex,THREE.ShaderChunk.cloudStandardFragment=cloudStandardFragment,THREE.ShaderChunk.newStyleVertex=newStyleVertex,THREE.ShaderChunk.newStyleFragment=newStyleFragment,THREE.ShaderLib.fillFacePhong={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.gradientmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,{emissive:{value:new THREE.Color(0)},specular:{value:new THREE.Color(1118481)},shininess:{value:30}}]),vertexShader:THREE.ShaderChunk.meshphong_id_vert,fragmentShader:THREE.ShaderChunk.fillFaceFragment},THREE.ShaderLib.newStyle={vertexShader:THREE.ShaderChunk.newStyleVertex,fragmentShader:THREE.ShaderChunk.newStyleFragment},THREE.ShaderLib.cloudStandard={vertexShader:THREE.ShaderChunk.cloudStandardVertex,fragmentShader:THREE.ShaderChunk.cloudStandardFragment},CLOUD.CloudStandardMaterial=function(e){THREE.MeshStandardMaterial.call(this),this.type="cloudStandard",this.roughness=1,this.metalness=0,this.originRoughness=1,this.originMetalness=0,this.pureColor=0,this.textureColor=0,this.imageFade=1,this.shift=.5,this.A=.64,this.B=.03,this.C=.02,this.D=.54,this.E=0,this.F=.81,this.scale=.92;var t=(new THREE.Color).setHex(3330982),n=[t.r,t.g,t.b,1];this.colorState=CLOUD.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(n),this.blinkCoefficient=0,this.fillMap=null,this.viewportSize=new THREE.Vector2(0,0),this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.roughnessmap,THREE.UniformsLib.metalnessmap,THREE.UniformsLib.fog,{emissive:{value:new THREE.Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}},{shift:{value:.5},A:{value:.64},B:{value:.03},C:{value:.02},D:{value:.54},E:{value:0},F:{value:.81},scale:{value:.92},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(n)},blinkCoefficient:{value:0},imageFade:{value:1}},{viewportSize:{value:new THREE.Vector2(0,0)},fillMap:{value:null}}]),this.vertexShader=THREE.ShaderChunk.cloudStandardVertex,this.fragmentShader=THREE.ShaderChunk.cloudStandardFragment,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.lights&&(this.uniforms=THREE.UniformsUtils.merge([this.uniforms,THREE.UniformsLib.lights]))},CLOUD.CloudStandardMaterial.prototype=Object.create(THREE.MeshStandardMaterial.prototype),CLOUD.CloudStandardMaterial.prototype.constructor=CLOUD.CloudStandardMaterial,CLOUD.CloudStandardMaterial.prototype.destroy=function(){THREE.MeshStandardMaterial.prototype.dispose.call(this),this.blinkColor=null,this.uniforms=null,this.defaultAttributeValues=null,this.lights=null},CLOUD.CloudStandardMaterial.prototype.copy=function(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.imageFade=e.imageFade,this.fillMap=e.fillMap,this.viewportSize.copy(e.viewportSize),this},CLOUD.CloudStandardMaterial.prototype.refreshUniforms=function(){this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.uniforms.imageFade.value=this.imageFade,this.uniforms.fillMap.value=this.fillMap,this.uniforms.viewportSize.value=this.viewportSize},CLOUD.CloudStandardMaterial.prototype.setBlinkColor=function(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=CLOUD.EnumShaderColorState.BLINK},CLOUD.CloudStandardMaterial.prototype.updateBlinkUniformValue=function(e,t,n){this.uniforms.colorState.value=e,this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=n},CLOUD.CloudStandardMaterial.prototype.resetBlinkUniformValue=function(){this.uniforms.colorState.value=this.colorState,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient},function(){function e(e){return e.replace("void main() {","\n            attribute float vState;            \n            attribute vec4 aColor;            \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)\n                attribute vec2 muvCol0;\n                attribute vec2 muvCol1;\n                attribute vec2 muvCol2;\n            #endif\n            \n            varying float vfState;\n            \n            vec3 getInstancePosition(vec3 position) {\n                return vec3(mat4(vec4(mcol0, 0.0),\n                                 vec4(mcol1, 0.0),\n                                 vec4(mcol2, 0.0),\n                                 vec4(mcol3, 1.0)) * vec4(position, 1.0));\n            }\n            \n            void main() {\n                vfState = vState;\n        ")}function t(e){return e.replace("#include <project_vertex>",i)}function n(e){return e.replace("void main() {","\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                \n        ")}var i="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ",r=function(i){function r(i){_classCallCheck(this,r);var a=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,i));return a.type="InstancedDepthMaterial",a.uniforms=THREE.ShaderLib.depth.uniforms,a.vertexShader=t(e(THREE.ShaderLib.depth.vertexShader)),a.fragmentShader=n(THREE.ShaderLib.depth.fragmentShader),a}return _inherits(r,i),r}(THREE.MeshDepthMaterial);CLOUD.InstancedDepthMaterial=r}(),function(){function e(e){
return e.replace("void main() {","\n            attribute float vState;           \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3; \n            varying float vfState;\n            \n            vec3 getInstancePosition(vec3 position) {\n                return vec3(mat4(vec4(mcol0, 0.0),\n                                 vec4(mcol1, 0.0),\n                                 vec4(mcol2, 0.0),\n                                 vec4(mcol3, 1.0)) * vec4(position, 1.0));\n            }\n            \n            void main() {\n                vfState = vState;\n        ")}function t(e){return e.replace("#include <project_vertex>",i)}function n(e){return e.replace("void main() {","\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                \n        ")}var i="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ",r=function(i){function r(i){_classCallCheck(this,r);var a=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,i));return a.type="InstancedMeshBasicMaterial",a.uniforms=THREE.ShaderLib.basic.uniforms,a.vertexShader=t(e(THREE.ShaderLib.basic.vertexShader)),a.fragmentShader=n(THREE.ShaderLib.basic.fragmentShader),a}return _inherits(r,i),r}(THREE.MeshBasicMaterial);CLOUD.InstancedMeshBasicMaterial=r}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.viewer=t;this.wireframeMaterial=new THREE.MeshBasicMaterial({color:1170103,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation}),this.selectedMaterial=new THREE.MeshBasicMaterial({color:1170103,opacity:.3,transparent:!0}),this.skinningWireframeMaterial=new THREE.MeshBasicMaterial({color:1170103,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation,skinning:!0}),this.skinningSelectedMaterial=new THREE.MeshBasicMaterial({color:1170103,opacity:.3,transparent:!0,skinning:!0}),this.selectedLineMaterial=new THREE.LineMaterial({color:1170103,opacity:1,transparent:!0,linewidth:2,dashed:!1}),this.instancedWireFrameMaterial=new CLOUD.InstancedMeshBasicMaterial({color:1170103,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation}),this.instancedSelectedMaterial=new CLOUD.InstancedMeshBasicMaterial({color:1170103,opacity:.3,transparent:!0}),this.selectionScene=new THREE.Scene,this.selectionScene.autoUpdate=!1,this.selectionObjectGroup=new CLOUD.ObjectGroup,this.selectionObjectGroup.name="PickingObjectGroup",this.selectionObjectGroup.matrixAutoUpdate=!1,this.selectionScene.add(this.selectionObjectGroup),this.lastSelectedUserIdMap=null,this.lastSelectedUserIds=null}return _createClass(e,[{key:"destroy",value:function(){this.wireframeMaterial.dispose(),this.wireframeMaterial=null,this.selectedMaterial.dispose(),this.selectedMaterial=null,this.skinningWireframeMaterial.dispose(),this.skinningWireframeMaterial=null,this.skinningSelectedMaterial.dispose(),this.skinningSelectedMaterial=null,this.selectedLineMaterial.dispose(),this.selectedLineMaterial=null,this.instancedWireFrameMaterial.dispose(),this.instancedWireFrameMaterial=null,this.instancedSelectedMaterial.dispose(),this.instancedSelectedMaterial=null,this.selectionObjectGroup.clear(),this.selectionObjectGroup=null,this.selectionScene=null,this.lastSelectedUserIdMap=null,this.lastSelectedUserIds=null,this.viewer=null}},{key:"apply",value:function(e){var t=this.viewer,n=t.getSelection();if(!n||!n.length)return this._clearSelectedUserIdsCache(),void this._clearMeshesFromScene();(e||this._isSelectionsChanged())&&(this._cacheSelectedUserIds(n),this._updateScene(n)),this._render(t.rendererManager.getRenderer(),t.camera)}},{key:"_isSelectionsChanged",value:function(){var e=this.lastSelectedUserIds;if(!e)return!0;var t=this.viewer.getSelection(),n=t.length;if(n!==e.length)return!0;for(var i=!1,r=this.lastSelectedUserIdMap,a=n-1;a>=0;a--)if(!r[t[a]]){i=!0;break}return i}},{key:"_cacheSelectedUserIds",value:function(e){this.lastSelectedUserIds=e.slice(0),this.lastSelectedUserIdMap=CLOUD.Utils.arrayToMap(e)}},{key:"_clearSelectedUserIdsCache",value:function(){this.lastSelectedUserIds=null,this.lastSelectedUserIdMap=null}},{key:"_render",value:function(e,t){var n=e.autoClearColor,i=e.autoClearDepth,r=e.autoClearStencil;e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.render(this.selectionScene,t),e.autoClearColor=n,e.autoClearDepth=i,e.autoClearStencil=r}},{key:"_updateScene",value:function(e){this._clearMeshesFromScene(),this._addMeshesToScene(this._getSelectedMeshes(e)),this._updateMatrixWorldForScene(),this._updateSelectedLineMaterial()}},{key:"_clearMeshesFromScene",value:function(){this.selectionObjectGroup.clear()}},{key:"_addMeshesToScene",value:function(e){for(var t=0,n=e.length;t<n;t++)this.selectionObjectGroup.add(e[t])}},{key:"_updateMatrixWorldForScene",value:function(){this.selectionObjectGroup.matrix.copy(this.viewer.getScene().getMatrixGlobal()),this.selectionObjectGroup.updateMatrixWorld(!0)}},{key:"_getSelectedMeshes",value:function(e){var t={meshes:[]},n=this,i=CLOUD.Utils.arrayToMap(e);return this.viewer.getModelManager().traverseLoadedModels(function(r){r.getPickingMeshes(n,t,e,i)}),t.meshes}},{key:"_updateSelectedLineMaterial",value:function(){CLOUD.GlobalData.PickingLineWidthEnabled&&this.selectedLineMaterial.resolution.set(this.viewer.domElement.offsetWidth,this.viewer.domElement.offsetHeight)}}]),e}();CLOUD.PickingEffecter=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.pickingNodeMap=null,this.pickingNodeGroup=null,this.nodeGroupName="PickingNodeGroup"}return _createClass(e,[{key:"destroy",value:function(){this.clearData(),this.pickingNodeGroup=null,this.manager=null}},{key:"clearData",value:function(){this.clearAllFromPickingNodeGroup(),this.clearAllFromPickingNodeMap()}},{key:"addToPickingNodeMap",value:function(e,t){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]=t,this.addToPickingNodeGroup(t)}},{key:"removeFromPickingNodeMap",value:function(e){this.pickingNodeMap&&this.pickingNodeMap[e]&&(this.removeFormPickingNodeGroup(e),this.disposePickingNodeById(e),delete this.pickingNodeMap[e])}},{key:"addToPickingNodeGroup",value:function(e){this.pickingNodeGroup||(this.pickingNodeGroup=new THREE.Group,this.pickingNodeGroup.name=this.nodeGroupName);for(var t=0,n=e.length;t<n;t++)this.pickingNodeGroup.add(e[t])}},{key:"removeFormPickingNodeGroup",value:function(e){if(this.pickingNodeGroup)for(var t=this.pickingNodeMap[e],n=0,i=t.length;n<i;n++)this.pickingNodeGroup.remove(t[n])}},{key:"disposePickingNodeById",value:function(e){for(var t=this.pickingNodeMap[e],n=0,i=t.length;n<i;n++)t[n].material=null,t[n].geometry.dispose(),t[n]=null}},{key:"clearAllFromPickingNodeMap",value:function(){if(this.pickingNodeMap){for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)this.disposePickingNodeById(t[n]);this.pickingNodeMap=null}}},{key:"clearAllFromPickingNodeGroup",value:function(){this.pickingNodeGroup&&(this.pickingNodeGroup.children.length=0)}},{key:"isPickingMeshesGenerated",value:function(){return!!this.pickingNodeMap}},{key:"generatePickingMeshes",value:function(){}},{key:"updatePickingMeshesState",value:function(e,t,n){}},{key:"resetPickingMeshesState",value:function(){}},{key:"updatePickingMeshes",value:function(e,t,n){return this.isPickingMeshesGenerated()||(this.generatePickingMeshes(),this.isPickingMeshesGenerated())?(this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,n),this.getPickingNodeGroup()):null}},{key:"getPickingNodeGroup",value:function(){return this.pickingNodeGroup}}]),e}();CLOUD.PickingNodeGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingBatchedMeshGroup",n}return _inherits(t,e),_createClass(t,[{key:"disposePickingNodeById",value:function(e){for(var t=this.pickingNodeMap[e],n=0,i=t.length;n<i;n++)t[n]._indicesGroup=null,t[n].material=null,t[n].geometry.dispose(),t[n]=null}},{key:"generatePickingMeshes",value:function(){for(var e=this,t=this.manager,n=Object.keys(t.mapMaterialIdToMergedNode),i=0,r=n.length;i<r;i++){for(var a=n[i],o=t.getPropertyValueByMaterialKey(a),s=t.mapMaterialIdToMergedNode[a],l=[],u=0,c=s.length;u<c;u++){var h=s[u],d=h.geometry,f=h.indices,p=new THREE.BufferGeometry;p.addAttribute("position",d.getAttribute("position")),p.setIndex(d.getIndex());var m="lines"===o.type?THREE.LineSegments:THREE.Mesh,g=new m(p,CLOUD.MaterialUtil.DefaultMaterial);g.name=a,g.frustumCulled=!1,g.renderOrder=0,g._indicesGroup=f,l.push(g)}e.addToPickingNodeMap(a,l)}}},{key:"_rebuildGeometryGroup",value:function(e,t,n){var i,r,a,o,s,l,u=this.manager.manager,c=e._indicesGroup,h=Object.keys(c);h.length<t.length?(s=h,l=n):(s=t,l=c);var d=[];for(a=0,o=s.length;a<o;a++){var f=s[a];if(u.isPickableNode(f)&&l[f]){var p=c[f];if(p&&p.length>0)for(i=0,r=p.length;i<r;i++)d.push({indexStart:p[i].indexStart,indexCount:p[i].indexCount})}}e.visible=!0;var m=e.geometry;if(m.clearGroups(),0===d.length)return void(e.visible=!1);for(d.sort(function(e,t){return e.indexStart-t.indexStart}),i=0,r=d.length;i<r;i++){var g=d[i].indexStart,v=d[i].indexCount;if(0===i)m.addGroup(g,v,0);else{g===d[i-1].indexStart+d[i-1].indexCount?m.groups[m.groups.length-1].count+=v:m.addGroup(g,v,0)}}}},{key:"updatePickingMeshesState",value:function(e,t,n){for(var i=this.pickingNodeMap,r=Object.keys(i),a=0,o=r.length;a<o;a++)for(var s=i[r[a]],l=0,u=s.length;l<u;l++)s[l].material=[e],s[l].visible=!1,this._rebuildGeometryGroup(s[l],t,n)}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingBatchedMeshGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingBatchedWireFrameGroup",n}return _inherits(t,e),_createClass(t,[{key:"disposePickingNodeById",value:function(e){for(var t=this.pickingNodeMap[e],n=0,i=t.length;n<i;n++)t[n]._indicesGroup=null,t[n].material=null,t[n].geometry.dispose(),t[n]=null}},{key:"generatePickingMeshes",value:function(){var e=this.manager.getWireFrameLineSegments();if(e)for(var t=0,n=e.length;t<n;t++){var i=e[t].geometry,r=new THREE.BufferGeometry;r.addAttribute("position",i.getAttribute("position")),r.setIndex(i.getIndex());var a=new THREE.LineSegments(r,CLOUD.MaterialUtil.DefaultMaterial);a._indicesGroup=e[t]._indicesGroup,a.frustumCulled=!1,a.renderOrder=1,this.addToPickingNodeMap(t,[a])}}},{key:"_rebuildGeometryGroup",value:function(e,t,n){var i,r,a,o,s,l,u=this.manager.manager,c=e._indicesGroup,h=Object.keys(c);h.length<t.length?(s=h,l=n):(s=t,l=c);var d=[];for(a=0,o=s.length;a<o;a++){var f=s[a];if(u.isPickableNode(f)&&l[f]){var p=c[f];if(p&&p.length>0)for(i=0,r=p.length;i<r;i++)d.push({indexStart:p[i].indexStart,indexCount:p[i].indexCount})}}e.visible=!0;var m=e.geometry;if(m.clearGroups(),0===d.length)return void(e.visible=!1);for(d.sort(function(e,t){return e.indexStart-t.indexStart}),i=0,r=d.length;i<r;i++){var g=d[i].indexStart,v=d[i].indexCount;if(0===i)m.addGroup(g,v,0);else{g===d[i-1].indexStart+d[i-1].indexCount?m.groups[m.groups.length-1].count+=v:m.addGroup(g,v,0)}}}},{key:"updatePickingMeshesState",value:function(e,t,n){for(var i=this.pickingNodeMap,r=Object.keys(i),a=0,o=r.length;a<o;a++)for(var s=i[r[a]],l=0,u=s.length;l<u;l++)s[l].material=[e],s[l].visible=!1,this._rebuildGeometryGroup(s[l],t,n)}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingBatchedWireFrameGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingMeshGroup",n}return _inherits(t,e),_createClass(t,[{key:"disposePickingNodeById",value:function(e){for(var t=Object.keys(this.pickingNodeMap[e]),n=0,i=t.length;n<i;n++)for(var r=this.pickingNodeMap[e][t[n]],a=0,o=r.length;a<o;a++)r[a].material=null,r[a].geometry.dispose(),r[a]=null}},{key:"removeFormPickingNodeGroup",value:function(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),n=0,i=t.length;n<i;n++)for(var r=this.pickingNodeMap[e][t[n]],a=0,o=r.length;a<o;a++)this.pickingNodeGroup.remove(nodes[a])}},{key:"addToPickingNodeMap",value:function(e,t,n){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=n,this.addToPickingNodeGroup(n)}},{key:"generatePickingMeshes",value:function(e){var t=this;this.manager.traverseActiveMeshMap(e,function(e,n,i){if(!t._isExistNode(e,n)){for(var r=[],a=0,o=i.length;a<o;a++){var s=i[a],l=new THREE.BufferGeometry;l.addAttribute("position",s.geometry.getAttribute("position")),l.setIndex(s.geometry.getIndex()),l._withDrawRange&&l.setDrawRange(s.geometry.drawRange.start,s.geometry.drawRange.count);var u=s.isLineSegments?THREE.LineSegments:THREE.Mesh,c=new u(l,CLOUD.MaterialUtil.DefaultMaterial);CLOUD.GeomUtil.copyMeshProperties(c,s),c.renderOrder=1,r.push(c)}t.addToPickingNodeMap(e,n,r)}})}},{key:"_isExistNode",value:function(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.pickingNodeMap,r=this.manager,a=0,o=t.length;a<o;a++){var s=t[a];if(i[s]&&r.isPickableNode(s)){var l=r.getActiveMeshMapById(s);if(l)for(var u=Object.keys(i[s]),c=0,h=u.length;c<h;c++){var d=u[c];if(l[d]){var f=i[s][d];if(f)for(var p=0,m=f.length;p<m;p++)f[p].material=e,f[p].visible=!0}}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=t[n],a=Object.keys(e[r]),o=0,s=a.length;o<s;o++)for(var l=e[r][a[o]],u=0,c=l.length;u<c;u++)l[u].visible=!1}},{key:"updatePickingMeshes",value:function(e,t,n){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,n),this.getPickingNodeGroup()}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingMeshGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingWireFrameGroup",n}return _inherits(t,e),_createClass(t,[{key:"disposePickingNodeById",value:function(e){for(var t=Object.keys(this.pickingNodeMap[e]),n=0,i=t.length;n<i;n++)for(var r=this.pickingNodeMap[e][t[n]],a=0,o=r.length;a<o;a++)r[a].material=null,r[a].geometry.dispose(),r[a]=null}},{key:"addToPickingNodeMap",value:function(e,t,n){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=n,this.addToPickingNodeGroup(n)}},{key:"removeFormPickingNodeGroup",value:function(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),n=0,i=t.length;n<i;n++)for(var r=this.pickingNodeMap[e][t[n]],a=0,o=r.length;a<o;a++)this.pickingNodeGroup.remove(nodes[a])}},{key:"generatePickingMeshes",value:function(e){var t=this,n=this.manager;this.manager.manager.getMeshManager().traverseActiveMeshMap(e,function(e,i,r){if(!(r&&r.length&&r[0].isLineSegments||t._isExistNode(e,i))){var a,o,s=r[0].geometryId,l=[];for(a=0,o=r.length;a<o;a++)l.push(r[a].geometry);var u=n._getWireframeGeometryById(s,l),c=[];for(a=0,o=u.length;a<o;a++){var h=new THREE.LineSegments(u[a],CLOUD.MaterialUtil.DefaultMaterial);CLOUD.GeomUtil.copyMeshProperties(h,r[a]),h.renderOrder=0,c.push(h)}t.addToPickingNodeMap(e,i,c)}})}},{key:"_isExistNode",value:function(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.pickingNodeMap,r=this.manager.manager.getMeshManager(),a=0,o=t.length;a<o;a++){var s=t[a];if(i[s]&&r.isPickableNode(s)){var l=r.getActiveMeshMapById(s);if(l)for(var u=Object.keys(i[s]),c=0,h=u.length;c<h;c++){var d=u[c];if(l[d]){var f=i[s][d];if(f)for(var p=0,m=f.length;p<m;p++)f[p].material=e,f[p].visible=!0}}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=t[n],a=Object.keys(e[r]),o=0,s=a.length;o<s;o++)for(var l=e[r][a[o]],u=0,c=l.length;u<c;u++)l[u].visible=!1}},{key:"updatePickingMeshes",value:function(e,t,n){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,n),this.getPickingNodeGroup()}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingWireFrameGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingInstancedMeshGroup",n}return _inherits(t,e),_createClass(t,[{key:"generatePickingMeshes",value:function(){var e=this,t=this.manager,n=t.cachedInstance,i=!CLOUD.GlobalData.BatchMergeEnabled;t.traverseInstanceNodeMap(null,function(t,r){for(var a=[],o=0,s=r.length;o<s;o++){var l=r[o].geometry,u=new THREE.InstancedBufferGeometry;u.addAttribute("position",l.getAttribute("position")),u.addAttribute("mcol0",l.getAttribute("mcol0")),u.addAttribute("mcol1",l.getAttribute("mcol1")),u.addAttribute("mcol2",l.getAttribute("mcol2")),u.addAttribute("mcol3",l.getAttribute("mcol3")),u.addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[t]),1,1)),u.setIndex(l.getIndex());var c=new THREE.Mesh(u,CLOUD.MaterialUtil.DefaultMaterial);c.name=t,c.frustumCulled=!1,c.renderOrder=i?1:0,a.push(c)}e.addToPickingNodeMap(t,a)})}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.manager.manager,r=this.pickingNodeMap,a=0,o=t.length;a<o;a++){var s=t[a];if(i.isPickableNode(s)){var l=i.getMeshManager().getNodeIdxMapByUserId(s);if(l)for(var u=Object.keys(l),c=0,h=u.length;c<h;c++){var d=u[c],f=r[d];if(f)for(var p=l[d],m=0,g=f.length;m<g;m++){var v=f[m];v.material=e,v.visible=!0;for(var y=v.geometry,E=y.getAttribute("vState").array,b=0,x=p.length;b<x;b++)E[p[b]]=CLOUD.EnumInstanceState.NONE;y.getAttribute("vState").needsUpdate=!0}}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=e[t[n]],a=0,o=r.length;a<o;a++)r[a].visible=!1,r[a].geometry.getAttribute("vState").array.fill(CLOUD.EnumInstanceState.HIDDEN),r[a].geometry.getAttribute("vState").needsUpdate=!0}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingInstancedMeshGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingInstancedWireFrameGroup",n}return _inherits(t,e),_createClass(t,[{key:"generatePickingMeshes",value:function(){var e=this,t=this.manager,n=t.manager.getCachedInstanceData(),i=!CLOUD.GlobalData.BatchMergeEnabled;t._traverseWireframeGeometryMap(function(t,r){for(var a=[],o=0,s=r.length;o<s;o++){var l=r[o],u=new THREE.InstancedBufferGeometry;u.addAttribute("position",l.getAttribute("position")),u.addAttribute("mcol0",l.getAttribute("mcol0")),u.addAttribute("mcol1",l.getAttribute("mcol1")),u.addAttribute("mcol2",l.getAttribute("mcol2")),u.addAttribute("mcol3",l.getAttribute("mcol3")),u.addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[t]),1,1)),u.setIndex(l.getIndex());var c=new THREE.LineSegments(u,CLOUD.MaterialUtil.DefaultMaterial);c.name=t,c.frustumCulled=!1,c.renderOrder=i?0:1,a.push(c)}e.addToPickingNodeMap(t,a)})}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.manager.manager,r=this.pickingNodeMap,a=0,o=t.length;a<o;a++){var s=t[a];if(i.isPickableNode(s)){var l=i.getMeshManager().getNodeIdxMapByUserId(s);if(l)for(var u=Object.keys(l),c=0,h=u.length;c<h;c++){var d=u[c],f=r[d];if(f)for(var p=l[d],m=0,g=f.length;m<g;m++){var v=f[m];v.material=e,v.visible=!0;for(var y=v.geometry,E=y.getAttribute("vState").array,b=0,x=p.length;b<x;b++)E[p[b]]=CLOUD.EnumInstanceState.NONE;y.getAttribute("vState").needsUpdate=!0}}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=e[t[n]],a=0,o=r.length;a<o;a++)r[a].visible=!1,r[a].geometry.getAttribute("vState").array.fill(CLOUD.EnumInstanceState.HIDDEN),r[a].geometry.getAttribute("vState").needsUpdate=!0}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingInstancedWireFrameGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingIncrementInstancedMeshGroup",n}return _inherits(t,e),_createClass(t,[{key:"_isExistNode",value:function(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}},{key:"generatePickingMeshes",value:function(){var e=this,t=this.manager,n=t.getCachedInstanceData(),i=!CLOUD.GlobalData.BatchMergeEnabled;t.traverseActiveMeshMap(null,function(t,r){if(!e._isExistNode(t)){for(var a=[],o=0,s=r.length;o<s;o++){var l=r[o].geometry,u=new THREE.InstancedBufferGeometry;u.addAttribute("position",l.getAttribute("position")),u.addAttribute("mcol0",l.getAttribute("mcol0")),u.addAttribute("mcol1",l.getAttribute("mcol1")),u.addAttribute("mcol2",l.getAttribute("mcol2")),u.addAttribute("mcol3",l.getAttribute("mcol3")),u.addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[t]),1,1)),u.setIndex(l.getIndex());var c=new THREE.Mesh(u,CLOUD.MaterialUtil.DefaultMaterial);c.name=t,c.frustumCulled=!1,c.renderOrder=i?1:0,a.push(c)}e.addToPickingNodeMap(t,a)}})}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.manager.manager,r=this.pickingNodeMap,a=0,o=t.length;a<o;a++){var s=t[a];if(i.isPickableNode(s)){var l=i.getMeshManager().getNodeIdxMapByUserId(s);if(l){var u=Object.keys(l);i.getMeshManager().traverseActiveMeshMap(u,function(t,n){if(r[t])for(var i=l[t],a=r[t],o=0,s=a.length;o<s;o++){var u=a[o];u.material=e,u.visible=!0;for(var c=u.geometry,h=c.getAttribute("vState").array,d=0,f=i.length;d<f;d++)h[i[d]]=CLOUD.EnumInstanceState.NONE;c.getAttribute("vState").needsUpdate=!0}})}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=e[t[n]],a=0,o=r.length;a<o;a++)r[a].visible=!1,r[a].geometry.getAttribute("vState").array.fill(CLOUD.EnumInstanceState.HIDDEN),r[a].geometry.getAttribute("vState").needsUpdate=!0}},{key:"updatePickingMeshes",value:function(e,t,n){return this.generatePickingMeshes(),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,n),this.getPickingNodeGroup()}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingIncrementInstancedMeshGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingIncrementInstancedWireFrameGroup",n}return _inherits(t,e),_createClass(t,[{key:"_isExistNode",value:function(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}},{key:"generatePickingMeshes",value:function(){var e=this,t=this.manager.manager,n=t.getMeshManager(),i=t.getWireFrameManager(),r=n.getCachedInstanceData(),a=!CLOUD.GlobalData.BatchMergeEnabled;n.traverseActiveMeshMap(null,function(t,n){if(!e._isExistNode(t)){var o=[];i._createGeometryById(t),i._traverseWireframeGeometryMapById(t,function(e,t){var n=new THREE.InstancedBufferGeometry;n.addAttribute("position",e.getAttribute("position")),n.addAttribute("mcol0",e.getAttribute("mcol0")),n.addAttribute("mcol1",e.getAttribute("mcol1")),n.addAttribute("mcol2",e.getAttribute("mcol2")),n.addAttribute("mcol3",e.getAttribute("mcol3")),n.addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(r.vState[t]),1,1)),n.setIndex(e.getIndex());var i=new THREE.Mesh(n,CLOUD.MaterialUtil.DefaultMaterial);i.name=t,i.frustumCulled=!1,i.renderOrder=a?1:0,o.push(i)}),e.addToPickingNodeMap(t,o)}})}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.manager.manager,r=this.pickingNodeMap,a=0,o=t.length;a<o;a++){var s=t[a];if(i.isPickableNode(s)){var l=i.getMeshManager().getNodeIdxMapByUserId(s);if(l){var u=Object.keys(l);i.getMeshManager().traverseActiveMeshMap(u,function(t,n){if(r[t])for(var i=l[t],a=r[t],o=0,s=a.length;o<s;o++){var u=a[o];u.material=e,u.visible=!0;for(var c=u.geometry,h=c.getAttribute("vState").array,d=0,f=i.length;d<f;d++)h[i[d]]=CLOUD.EnumInstanceState.NONE;c.getAttribute("vState").needsUpdate=!0}})}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=e[t[n]],a=0,o=r.length;a<o;a++)r[a].visible=!1,r[a].geometry.getAttribute("vState").array.fill(CLOUD.EnumInstanceState.HIDDEN),r[a].geometry.getAttribute("vState").needsUpdate=!0}},{key:"updatePickingMeshes",value:function(e,t,n){return this.generatePickingMeshes(),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,n),this.getPickingNodeGroup()}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingIncrementInstancedWireFrameGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingExternalMeshGroup",n.pickingEffecter=n.manager.getModelManager().viewer.rendererManager.getPickingEffecter(),n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.pickingEffecter=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"_disposeGeometryByNode",value:function(e){e.traverseVisible(function(t){t!==e&&(t.isMesh||t.isLine)&&(t.material=null,t.geometry.dispose())})}},{key:"disposePickingNodeById",value:function(e){for(var t=this.pickingNodeMap[e],n=0,i=t.length;n<i;n++)this._disposeGeometryByNode(t[n]),t[n]=null}},{key:"updatePickingMeshes",value:function(e,t,n){if(this.pickingNodeMap){for(var i=Object.keys(this.pickingNodeMap),r=0,a=i.length;r<a;r++){var o,s,l=i[r],u=this.pickingNodeMap[l];if(n[l]&&this.manager.isPickableNode({userId:l,name:l}))for(o=0,s=u.length;o<s;o++)u[o].visible=!0;else for(o=0,s=u.length;o<s;o++)u[o].visible=!1}return this.getPickingNodeGroup()}}},{key:"addNode",value:function(e,t){this.addToPickingNodeMap(e,t)}},{key:"removeNodeById",value:function(e){this.removeFromPickingNodeMap(e)}},{key:"clearNodes",value:function(){this.clearData()}},{key:"addToPickingNodeMap",value:function(e,t){for(var n=[],i=!CLOUD.GlobalData.BatchMergeEnabled,r=0,a=t.length;r<a;r++){var o=this._createPickingNodeBy(t[r],i);if(o)if(Array.isArray(o))for(var s=0,l=o.length;s<l;s++)o[s].name=e,n.push(o[s]),t[r]._oriMatrix&&(o[s]._oriMatrix=(new THREE.Matrix4).compose(o[s].position,o[s].quaternion,o[s].scale));else o.name=e,n.push(o),t[r]._oriMatrix&&(o._oriMatrix=(new THREE.Matrix4).compose(o.position,o.quaternion,o.scale))}this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]=n,this.addToPickingNodeGroup(n)}},{key:"_createPickingNodeBy",value:function(e,t){var n=this,i={},r={};if("Object3D"===e.type||e instanceof THREE.Group||e instanceof CLOUD.ObjectGroup){var a=new THREE.Group;a.copy(e,!1),e.animations&&(a.animations=e.animations),e.traverseVisible(function(a){if(a!==e){var o=null;if("Object3D"===a.type||a instanceof THREE.Group||a instanceof CLOUD.ObjectGroup||a instanceof THREE.Bone)o=a instanceof THREE.Bone?new THREE.Bone:new THREE.Group,o.copy(a,!1),i[a.uuid]={destination:o,source:a};else{if(!a.isMesh&&!a.isLine)return;o=n._createPickingMeshesBy(a,t),o&&(r[a.uuid]={destination:o,source:a})}o=null}});var o,s,l,u=Object.keys(i);for(o=0,s=u.length;o<s;o++){var c=i[u[o]];c.source.parent!==e?(l=c.source.parent.uuid,i[l].destination.add(c.destination)):a.add(c.destination)}var h=Object.keys(r);for(o=0,s=h.length;o<s;o++){var d,f,p=r[h[o]];if(p.source.parent===e)if(Array.isArray(p.destination))for(d=0,f=p.destination.length;d<f;d++)a.add(p.destination[d]);else a.add(p.destination);else if(l=p.source.parent.uuid,Array.isArray(p.destination))for(d=0,f=p.destination.length;d<f;d++)i[l].destination.add(p.destination[d]);else i[l].destination.add(p.destination)}return a}return e.isMesh||e.isLine?n._createPickingMeshesBy(e,t):null}},{key:"_createLineMeshBy",value:function(e,t,n){var i,r,a=this.pickingEffecter;if(CLOUD.GlobalData.PickingLineWidthEnabled){i=a.selectedLineMaterial;var o=new THREE.LineSegmentsGeometry;e.isLineSegments?o.fromLineSegments(e):e.isLineLoop?o.fromLineLoop(e):o.fromLine(e),r=new THREE.LineSegments2(o,i),CLOUD.GeomUtil.copyMeshProperties(r,e),r.renderOrder=n?1:0}else i=a.selectedMaterial,r=e.isLineSegments?new THREE.LineSegments(t,i):e.isLineLoop?new THREE.LineLoop(t,i):new THREE.Line(t,i),CLOUD.GeomUtil.copyMeshProperties(r,e),r.renderOrder=n?1:0;return r}},{key:"_createMeshBy",value:function(e,t,n){var i=this.pickingEffecter.selectedMaterial,r=new THREE.Mesh(t,i);return CLOUD.GeomUtil.copyMeshProperties(r,e),r.renderOrder=n?1:0,r}},{key:"_createSkinnedMeshBy",value:function(e,t,n){var i=this.pickingEffecter.skinningSelectedMaterial,r=new THREE.SkinnedMesh(t,i);return CLOUD.GeomUtil.copyMeshProperties(r,e),r.renderOrder=n?1:0,r.bindMatrix.copy(e.bindMatrix),r.bindMatrixInverse.copy(e.bindMatrixInverse),r.bindMode=e.bindMode,r.userData=e.userData,r.skeleton=e.skeleton,r}},{key:"_createSkinnedWireFrameBy",value:function(e,t,n){if(!t.index)return null;var i=this.pickingEffecter.skinningWireframeMaterial,r=CLOUD.BuildEdge(t.attributes.position.array,t.index.array),a=new THREE.BufferGeometry;a.setIndex(new THREE.Uint32BufferAttribute(r,1)),a.addAttribute("position",t.getAttribute("position")),a.addAttribute("skinIndex",t.getAttribute("skinIndex")),a.addAttribute("skinWeight",t.getAttribute("skinWeight"));var o=new CLOUD.SkinnedLineEx(a,i);return CLOUD.GeomUtil.copyMeshProperties(o,e),o.bindMatrix.copy(e.bindMatrix),o.bindMatrixInverse.copy(e.bindMatrixInverse),o.bindMode=e.bindMode,o.userData=e.userData,o.skeleton=e.skeleton,o.renderOrder=n?0:1,o}},{key:"_createWireFrameBy",value:function(e,t,n){if(!t.index)return null;var i=this.pickingEffecter.wireframeMaterial,r=CLOUD.BuildEdge(t.attributes.position.array,t.index.array),a=new THREE.BufferGeometry;a.setIndex(new THREE.Uint32BufferAttribute(r,1)),a.addAttribute("position",t.getAttribute("position"));var o=new THREE.LineSegments(a,i);return CLOUD.GeomUtil.copyMeshProperties(o,e),o.renderOrder=n?0:1,o}},{key:"_createPickingMeshesBy",value:function(e,t){var n=CLOUD.GeomUtil.createBufferGeometryWithPosAndSkin(e.geometry);if(!n)return null;if(e.isLineSegments)return this._createLineMeshBy(e,n,t);var i,r;return e.isSkinnedMesh?(i=this._createSkinnedMeshBy(e,n,t),r=this._createSkinnedWireFrameBy(e,n,t)):(i=this._createMeshBy(e,n,t),r=this._createWireFrameBy(e,n,t)),r?[i,r]:i}},{key:"_hasObjectId",value:function(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}},{key:"setAccumulateTransform",value:function(e,t,n,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],a=0,o=r.length;a<o;a++)this.manager.setAccumulateTransformForMesh(r[a],t,n,i)}},{key:"setTransform",value:function(e,t,n,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],a=0,o=r.length;a<o;a++)this.manager.setTransformForMesh(r[a],t,n,i)}},{
key:"rotateOnBasePoint",value:function(e,t,n,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],a=0,o=r.length;a<o;a++){var s=r[a],l=(new THREE.Quaternion).setFromAxisAngle(n,i);s.quaternion.premultiply(l),s.position.sub(t),s.position.applyQuaternion(l),s.position.add(t),s.updateMatrixWorld()}}},{key:"scaleOnBasePoint",value:function(e,t,n){if(this._hasObjectId(e))for(var i=this.pickingNodeMap[e],r=0,a=i.length;r<a;r++){var o=i[r];o.scale.multiply(n),o.position.sub(t).multiply(n).add(t),o.updateMatrixWorld()}}},{key:"applyTransform",value:function(e,t,n,i){if(this._hasObjectId(e)){var r=this.manager.getTransformMatrix(t,n,i);this.applyTransformMatrix(e,r)}}},{key:"applyTransformMatrix",value:function(e,t){if(this._hasObjectId(e))for(var n=this.pickingNodeMap[e],i=0,r=n.length;i<r;i++)this.manager.updateMatrixWorldForMesh(n[i],t)}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingExternalMeshGenerator=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.nodeGroupName="PickingSegmentMeshGroup",n.pickingEffecter=n.manager.viewer.rendererManager.getPickingEffecter(),n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.pickingEffecter=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"_createPickingMeshBy",value:function(e,t){var n=this.pickingEffecter.selectedMaterial,i=e.geometry,r=new THREE.BufferGeometry;r.addAttribute("position",i.getAttribute("position")),r.setIndex(i.getIndex());var a=e.isLineSegments?THREE.LineSegments:THREE.Mesh,o=new a(r,n);return CLOUD.GeomUtil.copyMeshProperties(o,e),o.renderOrder=t?1:0,o}},{key:"_createPickingWireFrameBy",value:function(e,t){if(e.isLineSegments)return null;var n=this.pickingEffecter.wireframeMaterial,i=e.geometry,r=CLOUD.BuildEdge(i.attributes.position.array,i.index.array),a=new THREE.BufferGeometry;a.addAttribute("position",i.getAttribute("position")),a.setIndex(new THREE.Uint32BufferAttribute(r,1));var o=new THREE.LineSegments(a,n);return CLOUD.GeomUtil.copyMeshProperties(o,e),o.renderOrder=t?0:1,o}},{key:"disposePickingNodeById",value:function(e){for(var t=Object.keys(this.pickingNodeMap[e]),n=0,i=t.length;n<i;n++)for(var r=this.pickingNodeMap[e][t[n]],a=0,o=r.length;a<o;a++)r[a].material=null,r[a].geometry.dispose(),r[a]=null}},{key:"removeFormPickingNodeGroup",value:function(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),n=0,i=t.length;n<i;n++)for(var r=this.pickingNodeMap[e][t[n]],a=0,o=r.length;a<o;a++)this.pickingNodeGroup.remove(nodes[a])}},{key:"addToPickingNodeMap",value:function(e,t,n){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=n,this.addToPickingNodeGroup(n)}},{key:"generatePickingMeshes",value:function(e){var t=this,n=this.manager,i=!CLOUD.GlobalData.BatchMergeEnabled;n.traverseMeshNodeMapByUserIds(e,function(e,n,r){var a=r.userId;if(!t._isExistNode(a,n)){for(var o=[],s=0,l=e.length;s<l;s++){var u=e[s],c=t._createPickingMeshBy(u,i);o.push(c);var h=t._createPickingWireFrameBy(u,i);h&&o.push(h)}t.addToPickingNodeMap(a,n,o)}})}},{key:"_isExistNode",value:function(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}},{key:"updatePickingMeshesState",value:function(e,t,n){if(this.pickingNodeMap)for(var i=this.pickingNodeMap,r=this.manager,a=0,o=t.length;a<o;a++){var s=t[a];if(i[s]){var l=r.getNodeIdsByUserId(s);if(l&&l.length)for(var u=0,c=l.length;u<c;u++){var h=l[u],d=r.getNodeInfoByNodeId(h);if(r.isPickableNode(d)){var f=i[s][h];if(f)for(var p=0,m=f.length;p<m;p++)f[p].visible=!0}}}}}},{key:"resetPickingMeshesState",value:function(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=t[n],a=Object.keys(e[r]),o=0,s=a.length;o<s;o++)for(var l=e[r][a[o]],u=0,c=l.length;u<c;u++)l[u].visible=!1}},{key:"updatePickingMeshes",value:function(e,t,n){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,n),this.getPickingNodeGroup()}}]),t}(CLOUD.PickingNodeGenerator);CLOUD.PickingSegmentMeshGenerator=e}();var ImageBasedLighting=ImageBasedLighting||{};ImageBasedLighting.brdf_vs=["varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.brdf_fs=["varying vec2 vUV;","uniform sampler2D HammersleyTable;","const float PI = 3.14159265358979;","float GGX(float NdotV, float alpha)","{","\tfloat alpha2 = pow(alpha, 2.0);","\treturn 2.0 * NdotV / (NdotV + sqrt(alpha2 + (1.0 - alpha2) * NdotV * NdotV));","}","float G_Smith(float NdotV, float NdotL, float roughness)","{","\tfloat alpha = pow(roughness, 2.0);","\treturn GGX(NdotV, alpha) * GGX(NdotL, alpha);","}","vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)","{","\tfloat a = roughness * roughness;","\tfloat Phi = 2.0 * PI * Xi.x; ","\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); ","\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);","\tvec3 H;","\tH.x = SinTheta * cos(Phi); ","\tH.y = SinTheta * sin(Phi); ","\tH.z = CosTheta;","\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); ","\tvec3 TangentX = normalize(cross(UpVector, N)); ","\tvec3 TangentY = cross(N, TangentX);","\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);","}","vec2 IntegrateBRDF(float NdotV, float roughness)","{","\tvec3 N = vec3(0.0, 0.0, 1.0);","\tvec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);","\tvec2 result = vec2(0.0, 0.0);","\tconst int NumSamples = 1024;","\tfor (int i = 0; i < NumSamples; i++)","\t{","\t\tfloat u = float(i) / float(NumSamples);","\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);","\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);","\t\tvec3 L = 2.0 * dot(V, H) * H - V;","\t\tfloat NdotL = saturate(L.z);","\t\tfloat NdotH = saturate(H.z);","\t\tfloat VdotH = saturate(dot(V, H));","\t\tfloat NdotV = saturate(dot(N, V));","\t\tif (NdotL > 0.0)","\t\t{","\t\t\tfloat G = G_Smith(NdotV, NdotL, roughness);","\t\t\tfloat G_Vis = G * VdotH / (NdotH * NdotV); ","\t\t\tfloat F = pow(1.0 - VdotH, 5.0);","\t\t\tresult.x += (1.0 - F) * G_Vis;","\t\t\tresult.y += F * G_Vis;","\t\t}","\t}","\treturn result / float(NumSamples);","}","void main()","{","\tvec2 brdf = IntegrateBRDF(vUV.x, vUV.y);","\tgl_FragColor = vec4(brdf, 0.0, 1.0);","}"].join("\n"),ImageBasedLighting.BRDFMap=function(e,t){this.texture=null,this.resolution=t||512,this.brdfMaterial=new THREE.ShaderMaterial({vertexShader:ImageBasedLighting.brdf_vs,fragmentShader:ImageBasedLighting.brdf_fs,uniforms:{HammersleyTable:{value:e}},lights:!1}),this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(window.innerWidth,window.innerHeight),this.brdfMaterial),this.quad.position.z=-100},ImageBasedLighting.BRDFMap.prototype.constructor=ImageBasedLighting.BRDFMap,ImageBasedLighting.BRDFMap.prototype.generateMap=function(e){var t=new THREE.Scene;t.add(this.quad);var n=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4);n.position.z=100;var i=new THREE.WebGLRenderTarget(this.resolution,this.resolution,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat});e.render(t,n,i,!0),this.texture=i.texture},THREE.HDRCubeTextureLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.hdrLoader=new THREE.RGBELoader},THREE.HDRCubeTextureLoader.prototype.load=function(e,t,n,i,r){var a=function(e,t,n,i){var r=e[t+3],a=Math.pow(2,r-128)/255;n[i+0]=e[t+0]*a,n[i+1]=e[t+1]*a,n[i+2]=e[t+2]*a},o=function(){function e(e){t[0]=e;var i=n[0],r=i>>16&32768,a=i>>12&2047,o=i>>23&255;return o<103?r:o>142?(r|=31744,r|=(255==o?0:1)&&8388607&i):o<113?(a|=2048,r|=(a>>114-o)+(a>>113-o&1)):(r|=o-112<<10|a>>1,r+=1&a)}var t=new Float32Array(1),n=new Int32Array(t.buffer);return function(t,n,i,r){var a=t[n+3],o=Math.pow(2,a-128)/255;i[r+0]=e(t[n+0]*o),i[r+1]=e(t[n+1]*o),i[r+2]=e(t[n+2]*o)}}(),s=new THREE.CubeTexture;s.type=e,s.encoding=e===THREE.UnsignedByteType?THREE.RGBEEncoding:THREE.LinearEncoding,s.format=e===THREE.UnsignedByteType?THREE.RGBAFormat:THREE.RGBFormat,s.minFilter=s.encoding===THREE.RGBEEncoding?THREE.NearestFilter:THREE.LinearFilter,s.magFilter=s.encoding===THREE.RGBEEncoding?THREE.NearestFilter:THREE.LinearFilter,s.generateMipmaps=s.encoding!==THREE.RGBEEncoding,s.anisotropy=0;for(var l=this.hdrLoader,u=this.manager,c=0,h=0;h<t.length;h++)!function(n,i,r,h){var d=new THREE.FileLoader(u);d.setResponseType("arraybuffer"),d.load(t[n],function(t){c++;var r=l._parser(t);if(r){if(e===THREE.FloatType){for(var u=r.data.length/4*3,h=new Float32Array(u),d=0;d<u;d++)a(r.data,4*d,h,3*d);r.data=h}else if(e===THREE.HalfFloatType){for(var u=r.data.length/4*3,f=new Uint16Array(u),d=0;d<u;d++)o(r.data,4*d,f,3*d);r.data=f}if(void 0!==r.image)s[n].images=r.image;else if(void 0!==r.data){var p=new THREE.DataTexture(r.data,r.width,r.height);p.format=s.format,p.type=s.type,p.encoding=s.encoding,p.minFilter=s.minFilter,p.magFilter=s.magFilter,p.generateMipmaps=s.generateMipmaps,s.images[n]=p}6===c&&(s.needsUpdate=!0,i&&i(s))}},r,h)}(h,n,i,r);return s},ImageBasedLighting.HDRTextureLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.hdrLoader=new THREE.RGBELoader},ImageBasedLighting.HDRTextureLoader.prototype.load=function(e,t,n,i){var r=new THREE.DataTexture;return this.hdrLoader.load(e,function(e,n){e.flipY=!0,e.type=THREE.FloatType,e.format=THREE.RGBFormat,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter;for(var i=e.image.width*e.image.height*3,a=new Float32Array(i),o=0;o<i;o++)!function(e,t,n,i){var r=e[t+3],a=Math.pow(2,r-128)/256;n[i+0]=e[t+0]*a,n[i+1]=e[t+1]*a,n[i+2]=e[t+2]*a}(e.image.data,4*o,a,3*o);e.image.data=a,r=e,t&&t(r)},n,i),r},ImageBasedLighting.equirectangular_vs=["varying vec3 pos;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.equirectangular_fs=["varying vec3 pos;","uniform sampler2D map;","const float PI = 3.14159265358979;","const float INV_PI = 1.0 / PI;","vec2 sampleSphericalMap(vec3 v)","{","\tvec2 uv = vec2(atan(v.z, v.x), asin(v.y));","\tuv *= vec2(INV_PI * 0.5, INV_PI);","\tuv += 0.5;","\treturn uv;","}","void main() {","\tvec2 uv = sampleSphericalMap(normalize(pos));","\tvec4 color = texture2D(map, uv);","\tgl_FragColor = vec4(color.rgb, 1.0);","}"].join("\n"),ImageBasedLighting.EquirectangularMaterial=function(e){THREE.ShaderMaterial.call(this),this.type="EquirectangularMaterial",this.map=null,this.lights=!1,this.side=THREE.BackSide,this.defines={},this.uniforms=THREE.UniformsUtils.merge([{map:{value:null}}]),this.vertexShader=ImageBasedLighting.equirectangular_vs,this.fragmentShader=ImageBasedLighting.equirectangular_fs,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()},ImageBasedLighting.EquirectangularMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),ImageBasedLighting.EquirectangularMaterial.prototype.constructor=ImageBasedLighting.EquirectangularMaterial,ImageBasedLighting.EquirectangularMaterial.prototype.isShaderMaterial=!0,ImageBasedLighting.EquirectangularMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.map=e.map,this},ImageBasedLighting.EquirectangularMaterial.prototype.refreshUniforms=function(){this.uniforms.map.value=this.map},ImageBasedLighting.HDRToCubeMap=function(e,t,n,i){var r=new THREE.CubeCamera(.1,10,i||512);if(n){var a={type:THREE.FloatType,format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};r.renderTarget=new THREE.WebGLRenderTargetCube(i||512,i||512,a)}var o=new THREE.Scene,s=new EquirectangularMaterial({map:e}),l=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),s);return o.add(l),r.updateCubeMap(t,o),r.renderTarget.texture},ImageBasedLighting.IBLMaps=function(e,t,n){this.environmentMap=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,e&&this.loadMaps(e,t,n)},ImageBasedLighting.IBLMaps.prototype.constructor=ImageBasedLighting.IBLMaps,ImageBasedLighting.IBLMaps.prototype.loadMaps=function(e,t,n){t?this.loadHDRMaps(e,n):this.loadJPGMaps(e,n)},ImageBasedLighting.IBLMaps.prototype.loadHDRMaps=function(e,t){for(var n=this,i=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],r=[],a=0;a<6;++a)r.push(e+"/EnvMap_"+i[a]);var o=new THREE.HDRCubeTextureLoader;o.load(THREE.FloatType,r,function(r){n.environmentMap=r;for(var a=[],s=0;s<6;++s)a.push(e+"/IrradianceMap_"+i[s]);o.load(THREE.FloatType,a,function(r){n.irradianceMap=r;for(var a=[],s=0;s<6;++s)a.push(e+"/PrefilterMap_"+i[s]);o.load(THREE.FloatType,a,function(i){n.prefilterMap=i;var r=new ImageBasedLighting.HDRTextureLoader,a=e+"/brdf.hdr";r.load(a,function(e){n.brdfMap=e,t(n,!0)})})})})},ImageBasedLighting.IBLMaps.prototype.loadJPGMaps=function(e,t){for(var n=this,i=["posx.jpg","negx.jpg","posy.jpg","negy.jpg","posz.jpg","negz.jpg"],r=[],a=0;a<6;++a)r.push(e+"/EnvMap_"+i[a]);var o=new THREE.CubeTextureLoader;o.setCrossOrigin("anonymous"),o.load(r,function(e){n.environmentMap=e,t(n,!1)})},ImageBasedLighting.IBLMaterial=function(e){THREE.MeshStandardMaterial.call(this),this.type="IBLMaterial",this.IBLEnabled=!0,this.debug=0,this.gamma=2.2,this.color=new THREE.Color(16777215),this.roughness=.5,this.metalness=.5,this.originRoughness=.5,this.originMetalness=.5,this.opacity=1,this.aoMap=null,this.IBLMaps=null,this.shift=.18,this.A=.27,this.B=.29,this.C=.052,this.D=.2,this.E=0,this.F=.18,this.scale=.897105,this.emissive=new THREE.Color,this.defines={},this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms,{IBLEnabled:{value:!0},debug:{value:0},gamma:{value:2.2},albedo:{value:new THREE.Color(16777215)},aoMap:{value:null},irradianceMap:{value:null},prefilterMap:{value:null},brdfMap:{value:null},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105}}]),this.lights=!0,this.vertexShader=ImageBasedLighting.IBLVertexShader,this.fragmentShader=ImageBasedLighting.IBLFragmentShader,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))},ImageBasedLighting.IBLMaterial.prototype=Object.create(THREE.MeshStandardMaterial.prototype),ImageBasedLighting.IBLMaterial.prototype.constructor=ImageBasedLighting.IBLMaterial,ImageBasedLighting.IBLMaterial.prototype.copy=function(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.IBLEnabled=e.IBLEnabled,this.debug=e.debug,this.gamma=e.gamma,this.color.copy(e.color),this.aoMap=e.aoMap,this.IBLMaps=e.IBLMaps,this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this},ImageBasedLighting.IBLMaterial.prototype.refreshUniforms=function(){this.uniforms.IBLEnabled.value=this.IBLEnabled,this.uniforms.debug.value=this.debug,this.uniforms.gamma.value=this.gamma,this.uniforms.albedo.value.set(this.color),this.uniforms.aoMap.value=this.aoMap,this.IBLMaps&&(this.uniforms.irradianceMap.value=this.IBLMaps.irradianceMap,this.uniforms.prefilterMap.value=this.IBLMaps.prefilterMap,this.uniforms.brdfMap.value=this.IBLMaps.brdfMap),this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale},ImageBasedLighting.IBLProbe=function(e,t,n,i,r,a,o){this.environmentMap=e,this.hammersleyTable=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,this.hammersleyUrl=t,this.irradianceResolution=i||32,this.prefilterResolution=r||128,this.brdfResolution=a||512,this.maxMipLevel=o||1,this.isHDR=!1,this.isComputed=!1,this.onSuccess=n,this.loadHammersleyTable()},ImageBasedLighting.IBLProbe.prototype.constructor=ImageBasedLighting.IBLProbe,ImageBasedLighting.IBLProbe.prototype.loadHammersleyTable=function(){var e=this;(new THREE.TextureLoader).load(this.hammersleyUrl,function(t){e.hammersleyTable=t,e.initMap(),e.onSuccess&&e.onSuccess()})},ImageBasedLighting.IBLProbe.prototype.initMap=function(){this.irradianceMap=new ImageBasedLighting.IrradianceMap(this.environmentMap,this.irradianceResolution),this.prefilterMap=new ImageBasedLighting.PrefilterMap(this.environmentMap,this.hammersleyTable,this.prefilterResolution,this.maxMipLevel),this.brdfMap=new ImageBasedLighting.BRDFMap(this.hammersleyTable,this.brdfResolution)},ImageBasedLighting.IBLProbe.prototype.setEnvironmentMap=function(e){this.environmentMap=e,this.irradianceMap.irradianceMaterial.uniforms.environmentMap.value=this.environmentMap,this.prefilterMap.prefilterMaterial.uniforms.environmentMap.value=this.environmentMap},ImageBasedLighting.IBLProbe.prototype.computed=function(e){this.irradianceMap.generateMap(e,this.isHDR),this.prefilterMap.generateMap(e,this.isHDR),this.brdfMap.generateMap(e),this.isComputed=!0},ImageBasedLighting.IBLVertexShader=["uniform vec4 offsetRepeat;","uniform mat3 rotateMatrix;","varying vec2 vUv;","varying vec3 Normal;","varying vec3 Pos;","varying vec3 mvPosition;","varying vec3 mvNormal;","#include <shadowmap_pars_vertex>","void main()","{","    vUv = mat2(rotateMatrix) * vec2(uv.x - 0.5, uv.y - 0.5) + vec2(0.5, 0.5);","    vUv = (vUv -  offsetRepeat.xy)* offsetRepeat.zw;","    Pos = vec3(modelMatrix * vec4(position, 1.0));","    Normal = normalize(mat3(modelMatrix) * normal);","    mvPosition = vec3(modelViewMatrix * vec4(position, 1.0));","    mvNormal = normalize(normalMatrix * normal);","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","#include <begin_vertex>","#include <worldpos_vertex>","#include <shadowmap_vertex>","}"].join("\n"),ImageBasedLighting.varying_pars=["varying vec2 vUv;","varying vec3 Normal;","varying vec3 Pos;","varying vec3 mvPosition;","varying vec3 mvNormal;"].join("\n"),ImageBasedLighting.clipping_pars=["#if NUM_CLIPPING_PLANES > 0","    uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];","#endif"].join("\n"),ImageBasedLighting.maps_pars=["#ifdef USE_MAP","    uniform sampler2D map;","#endif","#ifdef USE_NORMALMAP","    uniform sampler2D normalMap;","    uniform vec2 normalScale;","vec3 perturbNormal2Arb(vec3 pos, vec3 normal)","{","    vec3 q0 = vec3(dFdx(pos.x), dFdx(pos.y), dFdx(pos.z));","    vec3 q1 = vec3(dFdy(pos.x), dFdy(pos.y), dFdy(pos.z));","    vec2 st0 = dFdx(vUv.st);","    vec2 st1 = dFdy(vUv.st);","    vec3 S = normalize(q0 * st1.t - q1 * st0.t);","    vec3 T = normalize(-q0 * st1.s + q1 * st0.s);","    vec3 N = normalize(normal);","    vec3 mapN = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;","    mapN.xy = normalScale * mapN.xy;","    mat3 tsn = mat3(S, T, N);","    return normalize(tsn * mapN);","}","#endif","#ifdef USE_ROUGHNESSMAP","    uniform sampler2D roughnessMap;","#endif","#ifdef USE_METALNESSMAP","    uniform sampler2D metalnessMap;","#endif","#ifdef USE_AOMAP","    uniform sampler2D aoMap;","    uniform float aoMapIntensity;","#endif"].join("\n"),ImageBasedLighting.iblMaps_pars=["uniform samplerCube irradianceMap;","uniform samplerCube prefilterMap;","uniform sampler2D brdfMap;"].join("\n"),ImageBasedLighting.lighting_pars=["#include <packing>","#include <shadowmap_pars_fragment>","uniform vec3 ambientLightColor;","#if NUM_DIR_LIGHTS > 0","struct DirectionalLight","{","    vec3 direction;","    vec3 color;","    int shadow;","    float shadowBias;","    float shadowRadius;","    vec2 shadowMapSize;","};","uniform DirectionalLight directionalLights[NUM_DIR_LIGHTS];","#endif","#if NUM_POINT_LIGHTS > 0","struct PointLight","{","    vec3 position;","    vec3 color;","    float distance;","    float decay;","    int shadow;","    float shadowBias;","    float shadowRadius;","    vec2 shadowMapSize;","};","uniform PointLight pointLights[NUM_POINT_LIGHTS];","#endif","#if NUM_SPOT_LIGHTS > 0","struct SpotLight","{","    vec3 position;","    vec3 direction;","    vec3 color;","    float distance;","    float decay;","    float coneCos;","    float penumbraCos;","    int shadow;","    float shadowBias;","    float shadowRadius;","    vec2 shadowMapSize;","};","uniform SpotLight spotLights[NUM_SPOT_LIGHTS];","#endif","float punctualLightIntensityToIrradianceFactor(const in float lightDistance, const in float cutoffDistance, const in float decayExponent)","{","    if(decayExponent > 0.0)","    {","        float distanceFalloff = 1.0 / max(pow(abs(lightDistance), decayExponent), 0.01);","        float maxDistanceCutoffFactor = pow(abs(clamp(1.0 - pow(abs(lightDistance / cutoffDistance), 4.0), 0.0, 1.0)), 2.0);","        return distanceFalloff * maxDistanceCutoffFactor;","    }","    float distanceFalloff = 1.0 / max(pow(abs(lightDistance), 2.0), 0.01);","    return distanceFalloff;","}"].join("\n"),ImageBasedLighting.toneMap_pars=["uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}"].join("\n"),ImageBasedLighting.Uniforms=[ImageBasedLighting.varying_pars,ImageBasedLighting.clipping_pars,"uniform bool IBLEnabled;","uniform int debug;","uniform float gamma;","uniform vec3 albedo;","uniform float metalness;","uniform float roughness;","uniform float opacity;",ImageBasedLighting.maps_pars,ImageBasedLighting.iblMaps_pars,ImageBasedLighting.lighting_pars,ImageBasedLighting.toneMap_pars].join("\n"),ImageBasedLighting.IBLFragmentShader=[ImageBasedLighting.Uniforms,"const float PI = 3.14159265358979;","#include <bumpmap_pars_fragment>","float D_GGX(float NdotH, float roughness)","{","    float alpha = pow(roughness, 2.0);","    float alpha2 = pow(alpha, 2.0);","    return alpha2 / (PI * pow(abs(NdotH * NdotH * (alpha2 - 1.0) + 1.0), 2.0));","}","float GGX_Schlick(float NdotV, float roughness)","{","    float k = (roughness + 1.0) * 0.125;","    return NdotV / (NdotV * (1.0 - k) + k);","}","float G_Smith(float NdotV, float NdotL, float roughness)","{","    return GGX_Schlick(NdotV, roughness) * GGX_Schlick(NdotL, roughness);","}","vec3 F_Schlick(float HdotV, vec3 F0)","{","    return F0 + (vec3(1.0) - F0) * pow((1.0 - HdotV), 5.0);","}","vec3 F_SchlickRoughness(float NdotV, vec3 F0, float roughness)","{","    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - NdotV, 5.0);","}","vec3 postProcessing(vec3 color, bool toneMap)","{","    vec3 result = toneMap ? toneMapCanonFilmic(color) : color;","    result = pow(result, vec3(1.0 / gamma));","    return result;","}","void main()","{","#if NUM_CLIPPING_PLANES > 0","    vec3 vViewPosition = -mvPosition;","    for (int i = 0; i < UNION_CLIPPING_PLANES; ++ i)","    {","        vec4 plane = clippingPlanes[ i ];","        if (dot(vViewPosition, plane.xyz) > plane.w) discard;","    }","    #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES","        bool clipped = true;","        for (int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i)","        {","            vec4 plane = clippingPlanes[ i ];","            clipped = (dot(vViewPosition, plane.xyz) > plane.w) && clipped;","        }","        if (clipped) discard;","    #endif","#endif","    vec3 baseColor = pow(albedo, vec3(gamma));","#ifdef USE_MAP","    baseColor = pow(texture2D(map, vUv).rgb, vec3(gamma));","#endif","#ifdef DOUBLE_SIDED","    float flipNormal = float(gl_FrontFacing) * 2.0 - 1.0;","#else","    float flipNormal = 1.0;","#endif","    vec3 normal = Normal * flipNormal;","    vec3 vNormal = mvNormal * flipNormal;","#ifdef USE_NORMALMAP","    normal = perturbNormal2Arb(Pos, normal);","    vNormal = perturbNormal2Arb(mvPosition, vNormal);","#endif","#ifdef USE_BUMPMAP","    normal = perturbNormalArb( mvPosition, normal, dHdxy_fwd() );","#endif","    float roughnessFactor = roughness;","#ifdef USE_ROUGHNESSMAP","    roughnessFactor = texture2D(roughnessMap, vUv).r;","#endif","    float metalnessFactor = metalness;","#ifdef USE_METALNESSMAP","    metalnessFactor = texture2D(metalnessMap, vUv).r;","#endif","    float aoFactor = 1.0;","#ifdef USE_AOMAP","    aoFactor = texture2D(aoMap, vUv).r;","#endif","    vec3 N = normal;","    vec3 V = normalize(cameraPosition - Pos);","    vec3 R = reflect(-V, N);","    vec3 F0 = vec3(0.04);","    F0 = mix(F0, baseColor, metalnessFactor);","    vec3 totalLightColor = vec3(0.0);","    vec3 viewVector = normalize(-mvPosition);","    vec3 normalVector = normalize(vNormal);","    float NdotV = max(dot(normalVector, viewVector), 0.0);","    totalLightColor += ambientLightColor * baseColor / PI;","#if NUM_DIR_LIGHTS > 0","    vec3 dirColor = vec3(0.0);","    for (int i = 0; i < NUM_DIR_LIGHTS; ++i)","    {","        DirectionalLight directionalLight = directionalLights[i];","        vec3 dirVector = normalize(directionalLight.direction);","        vec3 halfVector = normalize(dirVector + viewVector);","        float NdotL = max(dot(normalVector, dirVector), 0.0);","        float NdotH = max(dot(normalVector, halfVector), 0.0);","        float HdotV = max(dot(halfVector, viewVector), 0.0);","        vec3 F = F_Schlick(HdotV, F0);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        float D = D_GGX(NdotH, roughnessFactor);","        float G = G_Smith(NdotV, NdotL, roughnessFactor);","        vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","        #ifdef USE_SHADOWMAP","        if(opacity > 0.9)","        directionalLight.color *= all( bvec2( directionalLight.shadow, true ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","        #endif","        dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;","    }","    totalLightColor += dirColor;","#endif","#if NUM_POINT_LIGHTS > 0","    vec3 pointColor  = vec3(0.0);","    for (int i = 0; i < NUM_POINT_LIGHTS; ++i)","    {","        PointLight pointLight = pointLights[i];","        vec3 dirVector = pointLight.position - mvPosition;","        float distance = length(dirVector);","        dirVector = normalize(dirVector);","        vec3 halfVector = normalize(dirVector + viewVector);","        float NdotL = max(dot(normalVector, dirVector), 0.0);","        float NdotH = max(dot(normalVector, halfVector), 0.0);","        float HdotV = max(dot(halfVector, viewVector), 0.0);","        vec3 F = F_Schlick(HdotV, F0);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        float D = D_GGX(NdotH, roughnessFactor);","        float G = G_Smith(NdotV, NdotL, roughnessFactor);","        vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","        pointColor += (kD * baseColor / PI + specular) * pointLight.color * NdotL * punctualLightIntensityToIrradianceFactor(distance, pointLight.distance, pointLight.decay);","    }","    totalLightColor += pointColor;","#endif","#if NUM_SPOT_LIGHTS > 0","    vec3 spotColor  = vec3(0.0);","    for (int i = 0; i < NUM_SPOT_LIGHTS; ++i)","    {","        SpotLight spotLight = spotLights[i];","        vec3 dirVector = spotLight.position - mvPosition;","        float distance = length(dirVector);","        dirVector = normalize(dirVector);","        vec3 halfVector = normalize(dirVector + viewVector);","        float angleCos = dot(dirVector, spotLight.direction);","        if (angleCos > spotLight.coneCos)","        {","            float spotEffect = smoothstep(spotLight.coneCos, spotLight.penumbraCos, angleCos);","            float NdotL = max(dot(normalVector, dirVector), 0.0);","            float NdotH = max(dot(normalVector, halfVector), 0.0);","            float HdotV = max(dot(halfVector, viewVector), 0.0);","            vec3 F = F_Schlick(HdotV, F0);","            vec3 kS = F;","            vec3 kD = 1.0 - kS;","            kD *= 1.0 - metalnessFactor;","            float D = D_GGX(NdotH, roughnessFactor);","            float G = G_Smith(NdotV, NdotL, roughnessFactor);","            vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","            spotColor += (kD * baseColor / PI + specular) * spotLights[i].color * spotEffect * NdotL","                * punctualLightIntensityToIrradianceFactor(distance, spotLight.distance, spotLight.decay);","            totalLightColor += spotColor;","        }","    }","#endif","    if (IBLEnabled)","    {","        vec3 F = F_SchlickRoughness(max(dot(N, V), 0.0), F0, roughnessFactor);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        vec3 irradiance = textureCube(irradianceMap, N, 0.0).rgb;","        vec3 diffuse = irradiance * baseColor;","        const float MAX_REFLECTION_LOD = 1.0;","        vec3 prefilteredColor = textureCube(prefilterMap, R, roughnessFactor * MAX_REFLECTION_LOD).rgb;","        vec2 brdf = texture2D(brdfMap, vec2(max(dot(N, V), 0.0), roughnessFactor)).rg;","        vec3 specular = prefilteredColor * (F * brdf.x + brdf.y);","        vec3 color = (kD * diffuse + specular + totalLightColor) * aoFactor;","        color = postProcessing(color, true);","        if (debug == 1) ","        {","            baseColor = postProcessing(baseColor, false);","            gl_FragColor = vec4(baseColor, opacity);","        }","        else if (debug == 2)","        {","            irradiance = postProcessing(irradiance, true);","            gl_FragColor = vec4(irradiance, opacity);","        }","        else if (debug == 3)","        {","            prefilteredColor = postProcessing(prefilteredColor, true);","            gl_FragColor = vec4(prefilteredColor, opacity);","        }","        else if (debug == 4)","        {","            diffuse = postProcessing(diffuse, true);","            gl_FragColor = vec4(diffuse, opacity);","        }","        else if (debug == 5)","        {","            specular = postProcessing(specular, true);","            gl_FragColor = vec4(specular, opacity);","        }","        else if (debug == 6)","        {","            gl_FragColor = vec4(brdf, 0.0, opacity);","        }","        else if (debug == 7)","        {","            gl_FragColor = vec4(normal, opacity);","        }","        else","        {","            gl_FragColor = vec4(color, opacity);","        }","    }","    else","    {","        totalLightColor = postProcessing(totalLightColor, true);","        gl_FragColor = vec4(totalLightColor, opacity);","    }","}"].join("\n"),ImageBasedLighting.cube_vs=["varying vec3 pos;","void main()","{","    pos = position;","    gl_Position = projectionMatrix * mat4(mat3(viewMatrix)) * modelMatrix * vec4(position, 1.0);","    gl_Position = gl_Position.xyww;","}"].join("\n"),
ImageBasedLighting.cube_fs=["varying vec3 pos;","uniform samplerCube environmentMap;","uniform bool hdr;","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","void main()","{","    vec3 envColor = textureCube(environmentMap, pos, 0.0).rgb;","    if (hdr)","    {","        envColor = toneMapCanonFilmic(envColor);","        envColor = pow(envColor, vec3(1.0 / 2.2));","    }","    gl_FragColor = vec4(envColor, 1.0);","}"].join("\n"),ImageBasedLighting.irradiance_vs=["varying vec3 pos;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.irradiance_fs=["varying vec3 pos;","uniform samplerCube environmentMap;","const float PI = 3.14159265358979;","vec3 caluIrradiance(vec3 normal, vec3 up, vec3 right)","{","\tvec3 irradiance = vec3(0.0);","\tint count = 0;","\tconst int phiSampleCount = 1024;","\tconst int thetaSampleCount = phiSampleCount / 4;","\tfloat phiDelta = 2.0 * PI / float(phiSampleCount);","\tfloat thetaDelta = 0.5 * PI / float(thetaSampleCount);","\tfor(int i = 0; i < phiSampleCount; ++i)","\t{","\t\tfloat phi = float(i) * phiDelta;","\t\tfor(int j = 0; j < thetaSampleCount; ++j)","\t\t{","\t\t\tfloat theta = float(j) * thetaDelta;","\t\t\tvec3 tangentSample = vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));","\t\t\tvec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * normal; ","\t\t\tirradiance += textureCube(environmentMap, sampleVec, 0.0).rgb * cos(theta) * sin(theta);","\t\t\t++count;","\t\t}","\t}","\tirradiance = PI * irradiance * (1.0 / float(count));","\treturn irradiance;","}","void main()","{","\tvec3 normal = normalize(pos);","\tvec3 up = vec3(0.0, 1.0, 0.0);","\tvec3 right = cross(up, normal);","\tup = cross(normal, right);","\tvec3 irradiance = caluIrradiance(normal, up, right);","\tgl_FragColor = vec4(irradiance, 1.0);","}"].join("\n"),ImageBasedLighting.IrradianceMap=function(e,t){this.cubeTexture=null,this.resolution=t||32,this.irradianceMaterial=new THREE.ShaderMaterial({vertexShader:ImageBasedLighting.irradiance_vs,fragmentShader:ImageBasedLighting.irradiance_fs,uniforms:{environmentMap:{value:e}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.irradianceMaterial)},ImageBasedLighting.IrradianceMap.prototype.constructor=ImageBasedLighting.IrradianceMap,ImageBasedLighting.IrradianceMap.prototype.generateMap=function(e,t){var n=new THREE.Scene;n.add(this.cube);var i=new THREE.CubeCamera(.1,10,this.resolution);if(t){var r={type:THREE.FloatType,format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};i.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,r)}i.updateCubeMap(e,n),this.cubeTexture=i.renderTarget.texture},ImageBasedLighting.prefilter_vs=["varying vec3 pos;","varying vec3 Normal;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tNormal = mat3(modelMatrix) * normal;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.prefilter_fs=["varying vec3 pos;","varying vec3 Normal;","uniform float roughness;","uniform samplerCube environmentMap;","uniform sampler2D HammersleyTable;","const float PI = 3.14159265358979;","float D_GGX(float NdotH, float roughness)","{","\tfloat alpha = pow(roughness, 2.0);","\tfloat alpha2 = pow(alpha, 2.0);","\treturn alpha2 / (PI * pow(NdotH * NdotH * (alpha2 - 1.0) + 1.0, 2.0));","}","vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness) ","{","\tfloat a = roughness * roughness;","\tfloat Phi = 2.0 * PI * Xi.x; ","\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); ","\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);","\tvec3 H;","\tH.x = SinTheta * cos(Phi); ","\tH.y = SinTheta * sin(Phi); ","\tH.z = CosTheta;","\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); ","\tvec3 TangentX = normalize(cross(UpVector, N)); ","\tvec3 TangentY = cross(N, TangentX);","\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);","}","void main()","{","\tvec3 N = normalize(pos);","\tvec3 R = N;","\tvec3 V = R;","\tconst int sampleCount = 1024;","\tfloat totalWeight = 0.0;","\tvec3 prefilteredColor = vec3(0.0);","\tfor (int i = 0; i < sampleCount; ++i) {","\t\tfloat u = float(i) / float(sampleCount);","\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);","\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);","\t\tvec3 L = normalize(2.0 * dot(V, H) * H - V);","\t\tfloat NdotL = max(dot(N, L), 0.0);","\t\tif(NdotL > 0.0)","\t\t{","\t\t\tfloat NdotH = max(dot(N, H), 0.0);","\t\t\tfloat D = D_GGX(NdotH, roughness);","\t\t\tfloat HdotV = max(dot(H, V), 0.0);","\t\t\tfloat pdf = D * NdotH / (4.0 * HdotV);","\t\t\tfloat resolution = 2048.0; // resolution of source cubemap (per face)","\t\t\tfloat solidAngleTexel= 4.0 * PI / (6.0 * resolution * resolution);","\t\t\tfloat solidAngleSample = 1.0 / (float(sampleCount) * pdf);","\t\t\tfloat mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(solidAngleSample / solidAngleTexel);","\t\t\tprefilteredColor += textureCube(environmentMap, L, mipLevel).rgb * NdotL;","\t\t\ttotalWeight += NdotL;","\t\t}","\t}","\tprefilteredColor = prefilteredColor / totalWeight;","\tgl_FragColor = vec4(prefilteredColor, 1.0);","}"].join("\n"),ImageBasedLighting.PrefilterMap=function(e,t,n,i){this.cubeTexture=null,this.resolution=n||128,this.maxMipLevel=i||1,this.prefilterMaterial=new THREE.ShaderMaterial({vertexShader:ImageBasedLighting.prefilter_vs,fragmentShader:ImageBasedLighting.prefilter_fs,uniforms:{roughness:{value:0},environmentMap:{value:e},HammersleyTable:{value:t}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.prefilterMaterial)},ImageBasedLighting.PrefilterMap.prototype.constructor=ImageBasedLighting.PrefilterMap,ImageBasedLighting.PrefilterMap.prototype.generateMap=function(e,t){var n=new THREE.Scene;n.add(this.cube);var i=new THREE.CubeCamera(.1,10,this.resolution);if(t){var r={type:THREE.FloatType,format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};i.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,r)}for(var a=this.maxMipLevel<=1?1:this.maxMipLevel-1,o=0;o<this.maxMipLevel;o++){var s=this.resolution*Math.pow(.5,o);i.renderTarget.width=i.renderTarget.height=s;var l=o/a;this.prefilterMaterial.uniforms.roughness.value=l,i.renderTarget.activeMipMapLevel=o,i.updateCubeMap(e,n)}this.cubeTexture=i.renderTarget.texture},THREE.HDRLoader=THREE.RGBELoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.RGBELoader.prototype=Object.create(THREE.DataTextureLoader.prototype),THREE.RGBELoader.prototype._parser=function(e){var t=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},n=function(e,t,n){t=t||1024;for(var i=e.pos,r=-1,a=0,o="",s=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));0>(r=s.indexOf("\n"))&&a<t&&i<e.byteLength;)o+=s,a+=s.length,i+=128,s+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));return-1<r&&(!1!==n&&(e.pos+=a+r+1),o+s.slice(0,r))},i=new Uint8Array(e);i.pos=0;var r=function(e){var i,r,a=/^#\?(\S+)$/,o=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,l=/^\s*FORMAT=(\S+)\s*$/,u=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,c={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(e.pos>=e.byteLength||!(i=n(e)))return t(1,"no header found");if(!(r=i.match(a)))return t(3,"bad initial token");for(c.valid|=1,c.programtype=r[1],c.string+=i+"\n";;){if(!1===(i=n(e)))break;if(c.string+=i+"\n","#"!==i.charAt(0)){if((r=i.match(o))&&(c.gamma=parseFloat(r[1],10)),(r=i.match(s))&&(c.exposure=parseFloat(r[1],10)),(r=i.match(l))&&(c.valid|=2,c.format=r[1]),(r=i.match(u))&&(c.valid|=4,c.height=parseInt(r[1],10),c.width=parseInt(r[2],10)),2&c.valid&&4&c.valid)break}else c.comments+=i+"\n"}return 2&c.valid?4&c.valid?c:t(3,"missing image size specifier"):t(3,"missing format specifier")}(i);if(-1!==r){var a=r.width,o=r.height,s=function(e,n,i){var r,a,o,s,l,u,c,h,d,f,p,m,g,v=n,y=i;if(v<8||v>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(v!==(e[2]<<8|e[3]))return t(3,"wrong scanline width");if(!(r=new Uint8Array(4*n*i))||!r.length)return t(4,"unable to allocate buffer space");for(a=0,o=0,h=4*v,g=new Uint8Array(4),u=new Uint8Array(h);y>0&&o<e.byteLength;){if(o+4>e.byteLength)return t(1);if(g[0]=e[o++],g[1]=e[o++],g[2]=e[o++],g[3]=e[o++],2!=g[0]||2!=g[1]||(g[2]<<8|g[3])!=v)return t(3,"bad rgbe scanline format");for(c=0;c<h&&o<e.byteLength;){if(s=e[o++],m=s>128,m&&(s-=128),0===s||c+s>h)return t(3,"bad scanline data");if(m)for(l=e[o++],d=0;d<s;d++)u[c++]=l;else u.set(e.subarray(o,o+s),c),c+=s,o+=s}for(f=v,d=0;d<f;d++)p=0,r[a]=u[d+p],p+=v,r[a+1]=u[d+p],p+=v,r[a+2]=u[d+p],p+=v,r[a+3]=u[d+p],a+=4;y--}return r}(i.subarray(i.pos),a,o);if(-1!==s)return{width:a,height:o,data:s,header:r.string,gamma:r.gamma,exposure:r.exposure,format:THREE.RGBEFormat,type:THREE.UnsignedByteType}}return null},CLOUD.IBLManager=function(e){this.viewer=e,this.IBLConfig=null,this.isHDR=!0,this.textureLoad=!1;var t=0,n=null,i=null;this.enableIBL=function(e){CLOUD.GlobalData.IBL!==e&&(CLOUD.GlobalData.IBL=e,this.viewer.setRenderStateChanged(!0),e?null!=n?this.initIBLByName(n):this.initIBLByIndex(t):(this.viewer.modelManager.changeAllMaterials(!1),this.removeSkyBox()))},this.loadIBLConfig=function(e){var t=this,n=this.viewer;(new THREE.FileLoader).load(e,function(e){t.IBLConfig=JSON.parse(e),CLOUD.GlobalData.IBL&&t.initIBLByIndex(0)},void 0,function(){n.modelManager.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_IBLCONFIG_ERROR,event:event})})},this.initIBLByIndex=function(e){if(CLOUD.GlobalData.IBL&&null!=this.IBLConfig){var i=Object.keys(this.IBLConfig);if(i.length>e){var r=this.IBLConfig[i[e]];this.loadIBLMaps(r.url,r.isHDR,!0,r.uniforms),t=e,n=i[e]}}},this.initIBLByName=function(e){if(CLOUD.GlobalData.IBL&&null!=this.IBLConfig&&this.IBLConfig.hasOwnProperty(e)){var t=this.IBLConfig[e];this.loadIBLMaps(t.url,t.isHDR,!0,t.uniforms),n=e}},this.loadIBLMaps=function(e,t,n,i){if(CLOUD.GlobalData.IBL){var r=this,a=this.viewer;a.getScene().IBLMaps.loadMaps(e,t,function(e,t){a.modelManager.changeAllMaterials(!0),a.modelManager.updateMaterials();for(var o in i)"shift"!=o&&a.modelManager.updateMaterialsValue(o,i[o]);n&&r.addSkyBox(t,i),r.textureLoad=!0,a.setRenderStateChanged(!0),a.render()})}},this.loadSkyBox=function(e,t){var n=this,i=this.viewer;i.getScene().IBLMaps.loadMaps(e,t,function(e,t){n.addSkyBox(t),i.render()})},this.addSkyBox=function(e,t){var e=void 0==e?this.isHDR:e;this.isHDR=e;var n=null,i=this.viewer.getScene();if(i.hasObjectGroup(CLOUD.ObjectGroupType.IBLCUBE)){var r=i.getObjectGroup(CLOUD.ObjectGroupType.IBLCUBE);n=r.children[0],n.material.uniforms.environmentMap.value=i.IBLMaps.environmentMap,n.material.uniforms.hdr.value=e}else{n=new THREE.Mesh(new THREE.BoxBufferGeometry(2e3,2e3,2e3),new THREE.ShaderMaterial({uniforms:{environmentMap:{value:i.IBLMaps.environmentMap},hdr:{value:e},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105}},vertexShader:ImageBasedLighting.cube_vs,fragmentShader:ImageBasedLighting.cube_fs,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,fog:!1})),n.frustumCulled=!1;var r=i.getOrCreateObjectGroup(CLOUD.ObjectGroupType.IBLCUBE,{priority:10});r.add(n)}if(t){var a=n.material;for(var o in t)a.uniforms.hasOwnProperty(o)&&(a.uniforms[o].value=t[o])}},this.renderWithOrthCamera=function(e,t,n){var i=e.getScene(),r=e.camera;if(t.autoClear=!0,i.hasObjectGroup(CLOUD.ObjectGroupType.IBLCUBE)&&(i.getOrCreateObjectGroup(CLOUD.ObjectGroupType.IBLCUBE).visible=!0,!r.isPerspective)){e.switchToCamera("persp"),CLOUD.GlobalData.IncrementRender&&0==n&&t.setObjectListUpdateState(!0);for(var a=i.getObjectGroups(),o=a.length,s=new Array(o),l=0;l<o;++l)s[l]=a[l].visible,a[l].visible=!1;i.getOrCreateObjectGroup(CLOUD.ObjectGroupType.IBLCUBE).visible=!0,t.render(i,r);for(var l=0;l<o;++l)a[l].visible=s[l];s=null,i.getOrCreateObjectGroup(CLOUD.ObjectGroupType.IBLCUBE).visible=!1,e.switchToCamera("orth"),t.autoClear=!1,CLOUD.GlobalData.IncrementRender&&t.resetIncrementRender()}},this.removeSkyBox=function(){var e=this.viewer.getScene();e.hasObjectGroup(CLOUD.ObjectGroupType.IBLCUBE)&&(e.removeObjectGroupByName(CLOUD.ObjectGroupType.IBLCUBE),this.viewer.render())},this.setSkyBoxType=function(e){i=e},this.getSkyBoxType=function(){return i}},CLOUD.ModelView=CLOUD.ModelView||{},function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.manager=t,this.id=n.modelId,this.databagId=this.id,this.encodedDatabagId=this.id,this.filter=null,this.visible=!0,this.loaded=!1,this.emptyScene=!1,this.statistics={renderableCount:0,renderableTotal:CLOUD.GlobalData.maxObjectNumInPool,renderableTotalForPool:CLOUD.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,memoeryInfo:{maxMemorySize:0,minMemorySize:0,triangleNumber:0,instanceEnabled:CLOUD.GlobalData.Instance}},this.transformInfos={octreeTransformed:!1,boundingBox:null,position:new THREE.Vector3,rotation:(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray([-1.5708,0,0]),!1),scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4},this.containsCamera=!1,this.destroyed=!1,this.config=void 0}return _createClass(e,[{key:"destroy",value:function(){this.destroyed=!0,this.statistics=null,this.transformInfos=null,this.filter&&(this.filter.destroy(),this.filter=null),this.manager=null,this.config=void 0}},{key:"calculateClippingIds",value:function(){}},{key:"load",value:function(e){}},{key:"prepare",value:function(e,t){}},{key:"isEmptyScene",value:function(){return!1}},{key:"isLayerData",value:function(){return!1}},{key:"isLoaded",value:function(){return!0}},{key:"isDataReady",value:function(){return!0}},{key:"isVisible",value:function(){return this.visible}},{key:"setVisible",value:function(e){this.visible=e}},{key:"isUseable",value:function(){return this.isLoaded()&&this.isVisible()}},{key:"getTransforms",value:function(){return this.transformInfos}},{key:"getStatistics",value:function(){return this.statistics}},{key:"getBoundingBoxWorld",value:function(){return this.getTransforms().boundingBox}},{key:"applyFilter",value:function(){}},{key:"applySelection",value:function(){}},{key:"clearSelection",value:function(){}},{key:"applyHover",value:function(){}},{key:"clearHover",value:function(){}},{key:"applyBlink",value:function(){}},{key:"clearBlink",value:function(){}},{key:"applyReplacement",value:function(){}},{key:"getId",value:function(){return this.id}},{key:"getDatabagId",value:function(){return this.databagId}},{key:"getEncodedDatabagId",value:function(){return this.encodedDatabagId}},{key:"getOctreeRoots",value:function(e){}},{key:"updateOctreeNode",value:function(e){}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"setRenderableCount",value:function(e){}},{key:"updateMeshNodes",value:function(){}},{key:"getNodeInfosByUserId",value:function(e){return[]}},{key:"getAllNodeInfos",value:function(){return{}}},{key:"getMaterialByMaterialId",value:function(e){return null}},{key:"updateMaterialsValue",value:function(e,t,n){}},{key:"updateMaterials",value:function(){}},{key:"switchNewStyleMaterial",value:function(e){}},{key:"changeAllMaterials",value:function(e){}},{key:"getWireframeElementCount",value:function(){return 0}},{key:"getCameraNameList",value:function(){return[]}},{key:"getCamera",value:function(e){return null}},{key:"calculateCameraModelRelation",value:function(e){this.containsCamera=!1}},{key:"isUserIdExist",value:function(e){return!0}},{key:"hasUserId",value:function(e){return!1}},{key:"isHiddenUserId",value:function(e){return!1}},{key:"hasTransforms",value:function(){return!0}},{key:"explode",value:function(){}},{key:"getFilter",value:function(){return this.filter}},{key:"getModelManager",value:function(){return this.manager}},{key:"isDestroyed",value:function(){return this.destroyed}},{key:"getPickingMeshes",value:function(e,t,n,i){}},{key:"getBlinkMaterials",value:function(){return[]}},{key:"getLoadedUserIdsObject",value:function(){return null}},{key:"dispatchEvent",value:function(e){}},{key:"enableColorWithoutLight",value:function(e){}},{key:"adjustVisibility",value:function(e){}},{key:"changeVisibilityOfSelectedObjects",value:function(e){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){}},{key:"adjustInstanceVisibility",value:function(e){}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"calculateClippingIds",value:function(){}},{key:"preUpdate",value:function(){}},{key:"update",value:function(){}},{key:"postUpdate",value:function(){}}]),e}();CLOUD.BaseModel=e}(),CLOUD.TaskWorker=function(e,t){this.MaxThreadCount=e||8;var n=this;n.todoList={},n.todoCount=0,n.doingCount=0,this.hasTask=function(){return n.todoCount>0},this.addItem=function(e,t){n.todoList[e]=t,n.todoCount++},this.clearTasks=function(){n.todoList={},n.todoCount=0},this.run=function(e,n){function i(n){if(n>=l)r.doingCount<1&&t();else{var o=a[n];e(o,n+u,i)}}var r=this;if(!(r.doingCount>0)){var a=[],o=r.todoList;for(var s in o)o.hasOwnProperty(s)&&a.push(s);r.todoList={},r.todoCount=0;var l=a.length;if(0!==l){n&&a.sort(n);var u=Math.min(this.MaxThreadCount,CLOUD.GlobalData.ConcurrencyRequestCount,l);r.doingCount=l;for(var c=0;c<u;++c)i(c)}}}},CLOUD.TaskWorker2=function(e){this.MaxThreadCount=e||8,this.todoList=[],this.doingCount=0,this.addItem=function(e){void 0!==e&&this.todoList.push(e)},this.run=function(e,t,n){function i(l){l>=a?s.doingCount<1&&(t(s.doingCount,a),n()):(t(s.doingCount,a),e(r[l],l+o,i))}if(!(this.doingCount>0)){if(0===this.todoList.length)return void n();var r=this.todoList,a=r.length;this.todoList=[],this.doingCount=a;for(var o=Math.min(this.MaxThreadCount,CLOUD.GlobalData.ConcurrencyRequestCount,a),s=this,l=0;l<o;++l)i(l)}}},CLOUD.TaskManager=function(){this.worker=new CLOUD.TaskWorker2(8)},CLOUD.TaskManager.prototype={constructor:CLOUD.TaskManager,addTask:function(e){this.worker.addItem(e)},processTasks:function(e,t,n){function i(t,n,i){e(t,function(){--r.doingCount,i(n)})}t=t||function(){},n=n||function(){};var r=this.worker;this.worker.run(i,t,n)}},function(){var e=function(){function e(){_classCallCheck(this,e),this.instanceMaterials={},this.materials={},this.textures={},this.lightmaps={},this.ensureImagePowerOfTwo=!1}return _createClass(e,[{key:"destroy",value:function(){this.instanceMaterials=null,this.materials=null,this.textures=null,this.lightmaps=null}},{key:"disposeInstanceMaterials",value:function(e){var t=this.instanceMaterials;for(var n in t){var i=t[n];if(i instanceof Array)for(var r=0,a=i.length;r<a;r++)i[r].dispose();else i.dispose()}}},{key:"disposeMaterials",value:function(e){var t;for(var n in this.materials)t=this.materials[n],t.dispose();this.disposeInstanceMaterials(e)}},{key:"updateMaterialsValue",value:function(e,t,n){var i,r=this.materials,a=this.instanceMaterials;for(var o in r)(i=r[o])&&i[t]&&(i[t]=n,void 0!==i.refreshUniforms&&i.refreshUniforms(),i.needsUpdate=!0);for(var o in a)if(i=a[o])if(i instanceof Array)for(var s=0,l=i.length;s<l;s++)i[s][t]&&(i[s][t]=n,void 0!==i[s].refreshUniforms&&i[s].refreshUniforms(),i[s].needsUpdate=!0);else i[t]&&(i[t]=n,void 0!==i.refreshUniforms&&i.refreshUniforms(),i.needsUpdate=!0)}},{key:"enableColorWithoutLight",value:function(e){var t,n=this.materials,i=this.instanceMaterials;if(e){for(var r in n)(t=n[r])&&(t.defines.USE_COLORWITHOUTLIGHT="",t.needsUpdate=!0);for(var r in i)if(t=i[r])if(t instanceof Array)for(var a=0,o=t.length;a<o;a++)t[a].defines.USE_COLORWITHOUTLIGHT="",t[a].needsUpdate=!0;else t.defines.USE_COLORWITHOUTLIGHT="",t.needsUpdate=!0}else{for(var r in n)(t=n[r])&&(delete t.defines.USE_COLORWITHOUTLIGHT,t.needsUpdate=!0);for(var r in i)if(t=i[r])if(t instanceof Array)for(var a=0,o=t.length;a<o;a++)delete t[a].defines.USE_COLORWITHOUTLIGHT,t[a].needsUpdate=!0;else delete t.defines.USE_COLORWITHOUTLIGHT,t.needsUpdate=!0}}},{key:"_updateTextureMapping",value:function(e){function t(e,t){if(t){if(void 0===t.length)e.map=t;else for(var n=0;n<t.length;n++)i||(t[n]instanceof THREE.CompressedTexture?THREE.Math.isPowerOfTwo(t[n].image.width)&&THREE.Math.isPowerOfTwo(t[n].image.height)||console.log("Warning: THREE.CompressedTexture is not power of two."):t[n].image=CLOUD.MaterialUtil.ensurePowerOfTwo(t[n].image)),"map"==t[n].texturetype?e.map=t[n]:"bumpMap"==t[n].texturetype?(e.bumpMap=t[n],void 0!=t[n].depth&&(e.bumpScale=t[n].depth)):"specularMap"==t[n].texturetype?e.specularMap=t[n]:"alphaMap"==t[n].texturetype?(e.alphaMap=t[n],e.alphaTest=.01,e.map=t[n],e.transparent=!0):"emissiveMap"==t[n].texturetype?e.emissiveMap=t[n]:"environmentMap"==t[n].texturetype?e.envMap=t[n]:"normalMap"==t[n].texturetype?(e.normalMap=t[n],t[n].depth&&e.normalScale.set(t[n].depth,t[n].depth)):console.warn("This map type is not supported yet:",t[n].texturetype);CLOUD.GlobalData.IBL&&e.refreshUniforms(),e.needsUpdate=!0}else e.textureColor&&e.color.setStyle(e.textureColor),e.needsUpdate=!0}var n=CLOUD.GlobalData.EnableTextureMapping,i=this.ensureImagePowerOfTwo;if(this.lastTextureEnabled!==n){var r=this.textures,a=this.materials;if(e)var o=e.manager.getMaterialOverrideSet(),s=o?o.materialsByName:null,l=o?o.textures:null;var u,c,h=this.instanceMaterials;if(n){for(u in a)if(c=a[u]){var d=CLOUD.Utils.splitCombinedKeyString(u,"_")[0],f=r[d];t(c,f)}for(u in h)if(c=h[u]){var d=CLOUD.Utils.splitCombinedKeyString(u,"_")[0],f=r[d],p=d.split("#")[0];if(l&&l[p]&&(f=l[p]),c instanceof Array)for(var m=0,g=c.length;m<g;m++)t(c[m],f);else t(c,f)}for(u in s)if(c=s[u]){var p=u.split("#")[0],f=l[p];t(c,f)}this.ensureImagePowerOfTwo=!0}else{if(!o)for(u in a)(c=a[u])&&(c.map=null,c.needsUpdate=!0);for(u in h)if(c=h[u])if(c instanceof Array)for(var m=0,g=c.length;m<g;m++)c[m].pureColor&&(c[m].color.setStyle(c[m].pureColor),c[m].map=null,c[m].needsUpdate=!0),o||(c[m].map=null,c[m].needsUpdate=!0);else c.pureColor&&(c.color.setStyle(c.pureColor),c.map=null,c.needsUpdate=!0),o||(c.map=null,c.needsUpdate=!0);for(u in s)(c=s[u])&&(c.map=null,c.needsUpdate=!0,c.pureColor&&c.color.setStyle(c.pureColor))}this.lastTextureEnabled=n}}},{key:"updateMaterials",value:function(e){var t=this.materials;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i.IBLMaps=e.manager.scene.IBLMaps,i.refreshUniforms()}}},{key:"_updateIBL",value:function(e){var t=e.manager.scene;if(CLOUD.GlobalData.IBL&&null!=t.iblProbe&&t.iblProbe.isComputed){this.materialManager.updateMaterials(e);var n=t.IBLcfg,i=Object.keys(n),r=n[i[t.IBLIndex]];for(var a in r)this.materialManager.updateMaterialsValue(e,a,r[a])}}},{key:"changeAllMaterials",value:function(e,t){var n=this.materials;for(var i in n)if(n.hasOwnProperty(i)){var r,a=n[i],o=CLOUD.MaterialUtil.getMaterialParameters(a);t?(delete o.textureColor,delete o.pureColor,delete o.imageFade,o.lights=!0,r=new ImageBasedLighting.IBLMaterial(o),r.type="IBL",r.refreshUniforms()):(delete o.iblProbe,o.lights=!e.lightmap,r=CLOUD.MaterialUtil.createStandardMaterial(o),r.roughness=o.originRoughness,r.metalness=o.originMetalness,r.refreshUniforms()),r.name=i,n[i]=r,o=null}}},{key:"switchNewStyleMaterial",value:function(e,t){var n=this.materials;for(var i in n)if(n.hasOwnProperty(i)){var r,a=n[i],o=CLOUD.MaterialUtil.getMaterialParameters(a);r=t?CLOUD.MaterialUtil.createNewStyleMaterial(o):CLOUD.MaterialUtil.createStandardMaterial(o),r.name=i,n[i]=r,o=null}}},{key:"updateLightmapMaterial",value:function(e){if(!this.materials[e]){var t=this.materials,n=CLOUD.Utils.splitCombinedKeyString(e,"_"),i=n[0],r=n[1],a=CLOUD.MaterialUtil.getMaterialParameters(t[i]);a.lights=!1;var o=this.lightmaps[r];a.lightMap=o,a.lightMapIntensity=CLOUD.GlobalData.LightmapIntensity,this.materials[e]=CLOUD.MaterialUtil.createStandardMaterial(a)}}},{key:"getInstanceMaterialById",value:function(e,t){if(this.instanceMaterials[e])return this.instanceMaterials[e];var n=CLOUD.Utils.splitCombinedKeyString(e,"_"),i=n[0],r=n[1],a=CLOUD.MaterialUtil.getMaterialParameters(t.manager.getOverrideMaterialByName(i)||this.materials[i]),o=a.transparent;if(t.lightmap&&r){a.lights=!1;var s=this.lightmaps[r];a.lightMap=s,a.lightMapIntensity=CLOUD.GlobalData.LightmapIntensity}var l=CLOUD.MaterialUtil.createInstanceMaterial(a,!0);l.transparent=!1;var u=CLOUD.MaterialUtil.createInstanceMaterial(a,!0);return u.transparent=!0,CLOUD.GlobalData.TranslucentDepthDisabled&&(u.depthWrite=!1),o===l.transparent?(this.instanceMaterials[e]=[l,u],u.defines.INSTANCE_STATE_SECONDARY=""):(this.instanceMaterials[e]=[u,l],l.defines.INSTANCE_STATE_SECONDARY=""),this.instanceMaterials[e]}},{key:"getMaterialById",value:function(e){return this.materials[e]}}]),e}();CLOUD.MaterialManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.hiddenUserIdMap={}}return _createClass(e,[{key:"destroy",value:function(){this.hiddenUserIdMap=null}},{key:"hideByUserId",value:function(e,t){this.hiddenUserIdMap||(this.hiddenUserIdMap={}),this.hiddenUserIdMap[e]=!!t}},{key:"cancelHiddenByUserId",value:function(e){this.hiddenUserIdMap&&delete this.hiddenUserIdMap[e]}},{key:"cancelAllHidden",value:function(){this.hiddenUserIdMap=null}},{key:"isHidden",value:function(e){return!!this.hiddenUserIdMap[e]}},{key:"hasHidden",value:function(){return!CLOUD.Utils.isEmptyObject(this.hiddenUserIdMap)}}]),e}();CLOUD.SourceObjectManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return CLOUD.GlobalData.IsMobile&&(CLOUD.GlobalData.maxObjectNumInPool=6e3,CLOUD.GlobalData.maxDrawCacheNum=4e3),n.viewer=e,n.scene=new CLOUD.Scene,n.filterHelper=new CLOUD.ModelView.FilterHelper(n),n.filter=new CLOUD.ModelView.FilterDirector(n),n.crossOrigin=!0,n.models={},n.loadingModels={},n.materialPool=null,n.occlusionCamera=null,n.containsCamera=!1,n.highPriorityCategories={inner:{},outer:{}},n.octantToObjectMap={},n.sceneState=new CLOUD.SceneStateHelper(n),n.rotation=new THREE.Quaternion,n.boundingBox=new THREE.Box3,n.IBLMaterial=!1,n.clippingCaps=!1,n.addedCapPlane=null,n.blinkStartTime=null,n.blinkEnabled=!1,n.blinkIntervalTime=600,n.blinkPermited=!1,n.defaultBlinkColor=(new THREE.Color).setHex(3330982),n.defaultBlinkAlpha=1,n.blinkColor=new THREE.Vector4(n.defaultBlinkColor.r,n.defaultBlinkColor.g,n.defaultBlinkColor.b,n.defaultBlinkAlpha),n.selectPriority=!0,n.materialOverrideSet=null,n._renderStateChanged=!1,n.explosionExtent=0,n.explosionTranslation={},n.floorInfos=void 0,n.totalHeight=void 0,n.floorExplosionExtent=0,n.floorExplosionList=[],n.isDrawableModel=!1,n.filterApplied=!1,n.modelLoader=new CLOUD.ModelLoader,n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.removeAllEventListener();for(var e in this.models)this.models[e].destroy();this.models=null,this.octantToObjectMap=null,this.materialPool&&(this.materialPool.destroy(),this.materialPool=null),this.occlusionCamera&&(this.occlusionCamera=null),this.loadOnDemandDirector&&(this.loadOnDemandDirector.destroy(),this.loadOnDemandDirector=null),this.highPriorityCategories=null,this.rotation=null,this.boundingBox=null,this.scene.destroy(),this.scene=null,this.filter.destroy(),this.filter=null,this.sceneState.destroy(),this.sceneState=null,this.blinkStartTime=null,this.defaultBlinkColor=null,this.blinkColor=null,this.floorExplosionList=null,this.explosionTranslation=null,this.filterHelper=null}},{key:"getFilter",value:function(){return this.filter}},{key:"getFilterHelper",value:function(){return this.filterHelper}},{key:"removeAllEventListener",value:function(){this._listeners=void 0}},{key:"prepareCapScene",value:function(){if(this.capsScene)return void(this.clippingCaps||this.initCapPlane());this.capsScene=new CLOUD.Scene,this.clippingCaps||this.initCapPlane(),this.scene.createCapStencilMaterials()}},{key:"resetClippingCapsStatus",value:function(){this.clippingCaps=!1}},{key:"initCapPlane",value:function(){var e=CLOUD.FillClipPlaneManager.getInstance(this.scene),t=e.initCapsPlane();null!==this.addedCapPlane&&(this.capsScene.remove(this.addedCapPlane.lineMesh),this.capsScene.remove(this.addedCapPlane.planeMesh)),this.capsScene.add(t.lineMesh),this.capsScene.add(t.planeMesh),this.addedCapPlane=t,this.clippingCaps=!0}},{key:"initCapBox",value:function(){var e=CLOUD.ClipPlaneManager.getInstance(this.scene),t=e.initCapsBox();t.material.needsUpdate=!0,t.visible=!0,this.capsScene.add(t),this.clippingCaps=!0}},{key:"_updateOcclusionCamera",value:function(e){var t=e.near,n=e.distanceFromWorldToDrawing(this.getMatrixWorldGlobal(),CLOUD.GlobalData.OcclusionDistanceToCamera);this.occlusionCamera?this.occlusionCamera.copy(e):this.occlusionCamera=e.clone(),this.occlusionCamera.setNearFar(t,n),this.occlusionCamera.updateMVP()}},{key:"_clearMaterialPool",value:function(){this.materialPool&&this.materialPool.clear()}},{key:"acquireMaterial",value:function(){return this.materialPool?this.materialPool.acquire():null}},{key:"getObjectPool",value:function(){return this.scene.getObjectPool()}},{key:"getFrustumFromOcclusionCamera",value:function(){return this.occlusionCamera.getFrustum(!1)}},{key:"getOcclusionCamera",value:function(){return this.occlusionCamera}},{key:"prepareScene",value:function(e,t){var n=this.models;CLOUD.GlobalData.BatchMergeEnabled||(this.clearPool(),this.clearObjectRangeFromOctantMap()),CLOUD.GlobalData.OcclusionTranslucentEnabled&&(null==this.materialPool&&(this.materialPool=new CLOUD.ExpandableObjectPool,this.materialPool.init(CLOUD.MaterialEx,50)),this._clearMaterialPool(),this._updateOcclusionCamera(e));for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];r.isLoaded()&&!r.isEmptyScene()&&r.prepare(e,t)}this.dealStateChanged()}},{key:"clearPool",value:function(){this.scene.getObjectPool().clear()}},{key:"clearObjectRangeFromOctantMap",value:function(){this.octantToObjectMap&&this.octantToObjectMap.pool&&(this.octantToObjectMap.pool={})}},{key:"setDrawableModel",value:function(e){this.isDrawableModel=e}},{key:"isDrawable",value:function(){return this.isDrawableModel}},{key:"load",value:function(e,t,n){var i=this,r=e.modelId=void 0!==e.modelId?e.modelId:CLOUD.Utils.getEncodedString(e.databagId);if(this.loadingModels[r])return r;this.setDrawableModel(!1);var a=this.models[r];if(void 0!==a)return this.setDrawableModel(!0),a.isVisible()||(a.setVisible(!0),a.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE})),r;e.notifyProgress=void 0===e.notifyProgress||e.notifyProgress;var o=this.getModelIndex();return this.modelLoader.load({viewer:this.viewer,manager:this,parameters:e,index:o,parseCfgFinish:t,debut:n},function(t){i.models[r]=t,t.load(e.notifyProgress),delete i.loadingModels[r]},function(e){delete i.loadingModels[r]}),r}},{key:"getModelIndex",value:function(){var e=0,t=[],n=this.models;for(var i in n)n.hasOwnProperty(i)&&t.push(n[i].index);t.sort();for(var r=0;r<t.length;r++)if(t[r]!==r){e=r;break}return e}},{key:"unload",value:function(e,t){var n=this.models[e];n&&(delete this.models[e],n.destroy(),n=null,this.updateScene(),this.updateFilterManager(),
this.getFilter().calculateVisibleComponentsBbox(),t&&t())}},{key:"unloadAll",value:function(){for(var e=Object.keys(this.models),t=0,n=e.length;t<n;++t)this.unload(e[t]);this.clearPool(),this.models={}}},{key:"addModel",value:function(e){this.models[e.id]=e}},{key:"removeModel",value:function(e){this.models[e]&&delete this.models[e]}},{key:"getModelIds",value:function(e){if(e){var t=[];for(var n in this.models){var i=this.models[n];i&&i.isUseable()&&t.push(n)}return t}return Object.keys(this.models)}},{key:"setModelVisibility",value:function(e,t,n){var i=this.getModel(e);i&&(i.setVisible(t),n&&n())}},{key:"updateScene",value:function(){this._needUpdateScene()&&(this.updateSceneBoundingBox(),this.updateSceneRootMatrix(),this.updateSceneRenderable(),this.updateOctreeNode())}},{key:"_needUpdateScene",value:function(){var e=!1,t=this.models;for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];if(i.isEmptyScene())continue;var r=i.getBoundingBoxWorld();if(r&&!r.isEmpty()){e=!0;break}}return e}},{key:"updateSceneBoundingBox",value:function(){var e=this.models,t=this.boundingBox.clone();t.makeEmpty();for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];if(!i.isEmptyScene()){var r=i.getBoundingBoxWorld();r&&(t.isEmpty()?t.copy(r):(t.expandByPoint(r.min),t.expandByPoint(r.max)))}}t.isEmpty()||(this.boundingBox.copy(t),this.scene.setBoundingBoxWorld(t))}},{key:"updateSceneRootMatrix",value:function(){var e=!1,t=new THREE.Matrix4,n=new THREE.Matrix4,i=new THREE.Quaternion,r=this.models;for(var a in this.models)if(r.hasOwnProperty(a)){var o=r[a];if(!o.isEmptyScene()&&o.hasTransforms()){i.copy(o.getTransforms().rotation),t.copy(o.getTransforms().transformMatrix),e=o.getTransforms().octreeTransformed;break}}if(this.scene.setTransformMatrixGlobal(t),e)n.copy(t);else{var s=new THREE.Vector3(1,1,1),l=CLOUD.GlobalData.SceneSize,u=this.boundingBox.getSize(),c=Math.max(u.x,u.y,u.z),h=l/c;s.multiplyScalar(h),n.makeRotationFromQuaternion(i),n.scale(s)}this.scene.updateWorldMatrixByMatrix(n)}},{key:"updateSceneRenderable",value:function(){var e=this.models,t=CLOUD.GlobalData.maxObjectNumInPool,n=[],i=0;for(var r in e)if(e.hasOwnProperty(r)){var a=e[r];a.isEmptyScene()||(i+=a.getStatistics().renderableTotalForPool,n.push(r))}for(var o=0,s=0,l=n.length;s<l;++s){var r=n[s],a=e[r],u=Math.floor(a.getStatistics().renderableTotalForPool/i*t);u>a.getStatistics().renderableTotalForPool&&(u=a.getStatistics().renderableTotalForPool),a.setRenderableCount(u),o+=u}this.scene.resizePool(o>t?t:o)}},{key:"updateOctreeNode",value:function(){var e=this.models;for(var t in this.models)if(e.hasOwnProperty(t)){var n=e[t];n.isLoaded()&&!n.isEmptyScene()&&n.updateOctreeNode(!0)}}},{key:"updateMaterials",value:function(){var e=this.models;for(var t in this.models)if(e.hasOwnProperty(t)){var n=e[t];n.isLoaded()&&!n.isEmptyScene()&&n.updateMaterials()}}},{key:"updateMaterialsValue",value:function(e,t){var n=this.models;for(var i in this.models)if(n.hasOwnProperty(i)){var r=n[i];r.isLoaded()&&!r.isEmptyScene()&&r.updateMaterialsValue(e,t)}this.materialOverrideSet&&this.materialOverrideSet.updateMaterialsValue(e,t)}},{key:"enableColorWithoutLight",value:function(e){var t=this.models;for(var n in this.models)if(t.hasOwnProperty(n)){var i=t[n];i.isLoaded()&&!i.isEmptyScene()&&i.enableColorWithoutLight(e)}}},{key:"switchNewStyleMaterial",value:function(e){var t=this.models;for(var n in this.models)if(t.hasOwnProperty(n)){var i=t[n];i.isLoaded()&&!i.isEmptyScene()&&i.switchNewStyleMaterial(e)}}},{key:"changeAllMaterials",value:function(e){if(this.IBLMaterial!=e){var t=this.models;for(var n in this.models)if(t.hasOwnProperty(n)){var i=t[n];i.isEmptyScene()||i.changeAllMaterials(e)}this.IBLMaterial=e}}},{key:"setCrossOrigin",value:function(e){this.crossOrigin=e}},{key:"getMatrixWorldGlobal",value:function(){return this.scene.getMatrixWorldGlobal()}},{key:"hasModel",value:function(){var e=this.models;for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];if(n.isLoaded())return!0}return!1}},{key:"hasModelDataReady",value:function(){var e=this.models,t=!1;for(var n in e)if(e.hasOwnProperty(n)){t=!0;var i=e[n];if(!i.isDataReady())return!1}return!!t}},{key:"isLayerData",value:function(){var e=this.models;for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];if(n.isLayerData())return!0}return!1}},{key:"getModel",value:function(e){var t=this.models[e];return t&&t.isLoaded()?t:null}},{key:"getFirstModel",value:function(){var e=Object.keys(this.models)[0];return this.models[e]}},{key:"showOctreeBox",value:function(e){if(CLOUD.GlobalData.ShowOctant){var t=this.scene.getOrCreateObjectGroup(CLOUD.ObjectGroupType.OCTREENODE,{pickable:0,priority:2});if(t.visible=!0,0===t.children.length){var n=new THREE.Box3(e.min,e.max),i=new CLOUD.BBoxNode(n,16711680);t.add(i),i.updateMatrixWorld(!0),function e(n){for(var i=0,r=n.childOctants.length;i<r;i++){var a=n.childOctants[i],o=new THREE.Box3(a.min,a.max),s=255;s<<=5*a.depth;var l=new CLOUD.BBoxNode(o,s);t.add(l),l.updateMatrixWorld(!0),e(a)}}(e)}}else this.scene.removeObjectGroupByName(CLOUD.ObjectGroupType.OCTREENODE)}},{key:"setCategoriesToHighPriority",value:function(e,t){var n=e.length;if(!(n<1))for(var i=this.highPriorityCategories[t]={},r=0;r<n;++r)i[e[r]]=!0}},{key:"getCategoriesFromHighPriority",value:function(e){return this.highPriorityCategories[e]}},{key:"clearCategoriesFromHighPriority",value:function(e){this.highPriorityCategories[e]={}}},{key:"clearAllCategoriesFromHighPriority",value:function(){this.clearCategoriesFromHighPriority("inner"),this.clearCategoriesFromHighPriority("outer")}},{key:"calculateCameraModelRelation",value:function(e){var t=!1,n=this.models;for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];r&&r.isLoaded()&&!r.isEmptyScene()&&(r.calculateCameraModelRelation(e),t=t||r.containsCamera)}this.containsCamera=t}},{key:"getCameraNameList",value:function(){var e=this.models,t=[];for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];i.isEmptyScene()||(t=t.concat(i.getCameraNameList()))}return t}},{key:"getCamera",value:function(e){var t=this.models,n=null;for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];if(!r.isEmptyScene()&&(n=r.getCamera(e)))break}return n}},{key:"getNumOfElements",value:function(){var e=this.models,t=0;for(var n in this.models)if(e.hasOwnProperty(n)){var i=e[n];i.isEmptyScene()||(t+=i.getStatistics().numOfElements)}return t}},{key:"getNumOfRenderables",value:function(){var e=this.models,t=0;for(var n in this.models)if(e.hasOwnProperty(n)){var i=e[n];i.isEmptyScene()||(t+=i.getStatistics().renderableTotal)}return t}},{key:"getNumOfTriangles",value:function(){var e=this.models,t=0;for(var n in this.models)if(e.hasOwnProperty(n)){var i=e[n];i.isEmptyScene()||(t+=i.getStatistics().numOfTriangles)}return t}},{key:"getScene",value:function(){return this.scene}},{key:"getOctreeRoots",value:function(){var e=this.models,t={};for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];if(i.isLoaded()&&!i.isEmptyScene()){var r=i.getEncodedDatabagId();t[r]=[],i.getOctreeRoots(t[r])}}return t}},{key:"addMeshToOctantMap",value:function(e,t,n){var i=this.octantToObjectMap;i[e]||(i[e]={}),i[e].mesh||(i[e].mesh={}),i[e].mesh[t]||(i[e].mesh[t]=[]),i[e].mesh[t].push(n)}},{key:"addNodeInfoToOctantMap",value:function(e,t,n){var i=this.octantToObjectMap;i[e]||(i[e]={}),i[e].info||(i[e].info={}),i[e].info[t]||(i[e].info[t]=[]),i[e].info[t].push(n)}},{key:"removeNodeInfoFromOctantMap",value:function(e,t){var n=this.octantToObjectMap;if(n[e]&&n[e].info&&n[e].info[t.cellId])for(var i=n[e].info[t.cellId],r=i.length-1;r>=0;r--)if(t.nodeId===i[r].nodeId){i.splice(r);break}}},{key:"clearNodeInfosFromOctantMap",value:function(e){var t=this.octantToObjectMap;t[e]&&t[e].info&&(t[e]=null)}},{key:"removeAllFromOctantMap",value:function(e){var t=this.octantToObjectMap;t[e]&&delete t[e]}},{key:"clearMeshFromOctantMap",value:function(e){var t=this.octantToObjectMap;t[e]&&t[e].mesh&&delete t[e].mesh}},{key:"removeMeshFromOctantMap",value:function(e,t){var n=this.octantToObjectMap;if(n[e]&&n[e].mesh&&n[e].info){var i,r=n[e].info[t.cellId];for(i=r.length-1;i>=0;i--)if(t.nodeId===r[i].nodeId){r.splice(i);break}n[e].mesh[t.nodeId]&&delete n[e].mesh[t.nodeId]}}},{key:"getOctantMap",value:function(){return this.octantToObjectMap}},{key:"isFilterApplied",value:function(){return this.filterApplied}},{key:"setFilterApplied",value:function(e){this.filterApplied=e}},{key:"applyFilter",value:function(e){if(void 0===e)this.traverseValidModels(function(e){e.applyFilter()});else{var t=this.getModel(e);t&&t.applyFilter()}this.setFilterApplied(!0)}},{key:"applySelection",value:function(e){if(this.selectPriority=!0,void 0===e)this.traverseValidModels(function(e){e.applySelection()});else{var t=this.getModel(e);t&&t.applySelection()}}},{key:"clearSelection",value:function(e){if(this.selectPriority=!0,void 0===e)this.traverseValidModels(function(e){e.clearSelection()});else{var t=this.getModel(e);t&&t.clearSelection()}}},{key:"applyHover",value:function(e){if(CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass)if(void 0===e)this.traverseValidModels(function(e){e.applyHover()});else{var t=this.getModel(e);t&&t.applyHover()}}},{key:"clearHover",value:function(e){if(CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass)if(void 0===e)this.traverseValidModels(function(e){e.clearHover()});else{var t=this.getModel(e);t&&t.clearHover()}}},{key:"chooseRendering",value:function(e,t){if(!this.firstChooseRendering){if(this.firstChooseRendering=!0,t)return CLOUD.GlobalData.DynamicScheduling=!0,CLOUD.GlobalData.BatchMergeEnabled=!0,void(CLOUD.GlobalData.IncrementRender=!1);console.log("Maximum Memory (M):",e.maxMemorySize);switch(CLOUD.GlobalData.Renderer){case CLOUD.EnumRendererType.FULL:CLOUD.GlobalData.BatchMergeEnabled=!0,CLOUD.GlobalData.IncrementRender=!1;break;case CLOUD.EnumRendererType.INCREMENT:CLOUD.GlobalData.BatchMergeEnabled=!1,CLOUD.GlobalData.IncrementRender=!0;break;default:e.maxMemorySize<=CLOUD.GlobalData.MaxMemeorySizeToFullRender?(CLOUD.GlobalData.BatchMergeEnabled=!0,CLOUD.GlobalData.IncrementRender=!1):(CLOUD.GlobalData.BatchMergeEnabled=!1,CLOUD.GlobalData.IncrementRender=!0)}}}},{key:"isUserIdExist",value:function(e,t){var n,i=!1;if(void 0===t){for(var r in this.models)if(this.models.hasOwnProperty(r)&&(n=this.models[r],n.isUserIdExist(e))){i=!0;break}}else(n=this.getModel(t))&&n.isUserIdExist(e)&&(i=!0);return i}},{key:"getNodeInfosByUserId",value:function(e){var t,n=function(e,n){t&&0!==t.length||(t=e.getNodeInfosByUserId(n))};return this.filterHelper.executeId(e,n),t&&t.length>0?t:null}},{key:"getNodeInfos",value:function(){var e={};for(var t in this.models){var n=this.models[t].getAllNodeInfos();n&&(e[t]=n)}return e}},{key:"getMaterialByNodeId",value:function(e,t,n){var i=this.models[e];if(!i)return null;for(var r=i.getNodeInfosByUserId(t),a=-1,o=0,s=r.length;o<s;o++)if(r[o].nodeId===n){a=o;break}return-1!==a?i.getMaterialByMaterialId(r[a].materialId):null}},{key:"getNodeInfoByNodeId",value:function(e,t,n){var i=this.models[e];if(!i)return null;for(var r=i.getNodeInfosByUserId(t),a=-1,o=0,s=r.length;o<s;o++)if(r[o].nodeId===n){a=o;break}return-1!==a?r[a]:null}},{key:"getComponentInfoByUserId",value:function(e){var t=this.getNodeInfosByUserId(e);if(t&&t.length>0){for(var n=new THREE.Box3,i=[],r=0,a=t.length;r<a;r++)n.union(t[r].boundingBox),-1===i.indexOf(t[r].materialId)&&i.push(t[r].materialId);return{userId:e,state:0,materials:i,boundingBox:n,userData:t[0].userData}}return null}},{key:"getBoundingBoxByIds",value:function(e){var t=this.viewer,n=new THREE.Box3;for(var i in e)if(!this.isHiddenUserId(i)){var r=this.getComponentInfoByUserId(i);if(r)n.union(r.boundingBox);else{var a=CLOUD.ExtrudeBodyManager.getInstance(t),o=a.getNode(i);if(o){var s=o.geometry.boundingBox.clone();o.matrix&&s.applyMatrix4(o.matrix),n.union(s)}}}return n}},{key:"createMaterialOverrideSet",value:function(e,t){this.materialOverrideSet=new CLOUD.MaterialOverriderSet(e,t),CLOUD.GlobalData.EnableTextureMapping=!0}},{key:"getMaterialOverrideSet",value:function(){return this.materialOverrideSet}},{key:"getOverrideMaterialByNodeInfo",value:function(e){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByNodeInfo(e):null}},{key:"getOverrideMaterialByName",value:function(e){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByName(e):null}},{key:"loadOverrideMaterialsByDemand",value:function(e,t){if(this.materialOverrideSet){var n=this.getConditions();this.materialOverrideSet.loadByDemand(n,e,t)}else t&&t()}},{key:"getConditions",value:function(){var e={},t={},n={};for(var i in this.models){var r=this.models[i].getAllNodeInfos();if(r)for(var i in r)if(r.hasOwnProperty(i))for(var a=0,o=r[i].length;a<o;a++){var s=r[i][a].userData;t[r[i][a].userId]=!0,n[s.systemTypeId]=!0,e[s.familyId]=!0}}return{familyIds:e,elementIds:t,systemTypeIds:n}}},{key:"isHiddenUserId",value:function(e){var t=!1;for(var n in this.models)if(this.models.hasOwnProperty(n)){var n=this.models[n];if(n.isHiddenUserId(e)){t=!0;break}}return t}},{key:"updateMeshNodes",value:function(){if(CLOUD.GlobalData.BatchMergeEnabled)for(var e in this.models)if(this.models.hasOwnProperty(e)){var e=this.models[e];e.updateMeshNodes()}}},{key:"getMinDistanceObjects",value:function(e,t){var n=this,i={},r=this.filterHelper.distributeId(e),a=r.modelId,o=r.objectId,s=this.filterHelper.distributeId(t),l=s.modelId,u=s.objectId;if(a&&l&&a===l){var c=this.models[a];c.minDistanceObjects={},c.getMeshesByUserIds(o,u),c.minDistanceObjects[o].length>0&&c.minDistanceObjects[u].length>0&&(i[e]=c.minDistanceObjects[o],i[t]=c.minDistanceObjects[u])}else{if(a){var h=this.models[a];h.minDistanceObjects={},h.getMeshesByUserIds(o,o),h.minDistanceObjects[o].length>0&&(i[e]=h.minDistanceObjects[o])}if(l){var d=this.models[l];d.minDistanceObjects={},d.getMeshesByUserIds(u,u),d.minDistanceObjects[u].length>0&&(i[t]=d.minDistanceObjects[u])}if(!a||!l)for(var f in this.models)if(this.models.hasOwnProperty(f)){var c=this.models[f];if("ExtrudeBodyManager"===c.id||"ExternalComponent"===c.id)continue;c.minDistanceObjects={},c.getMeshesByUserIds(o,u),!i[e]&&c.minDistanceObjects[o].length>0&&(i[e]=c.minDistanceObjects[o]),!i[t]&&c.minDistanceObjects[u].length>0&&(i[t]=c.minDistanceObjects[u])}if(!i[e]||!i[t]){var p,m,g,v,y,E=function(){var r=function(e,t,n){var r={};r.mesh=e;var a=new THREE.Matrix4;n?a.multiplyMatrices(n,e.matrix):a=e.matrix,r.matrix=a;var o=e.geometry.boundingBox;o||(e.geometry.computeBoundingBox(),o=r.mesh.geometry.boundingBox);var s=o.clone().applyMatrix4(a);r.boundingBox=s,i[t]||(i[t]=[]),i[t].push(r)};if(!(p=n.scene.getObjectGroup("ExternalComponentManager")))return{v:void 0};for(m=p.children,g=0,v=m.length;g<v;g++)y=m[g],y.name!=e&&y.name!=t||(CLOUD.Utils.isGroupObject(y)?y.traverseVisible(function(e){CLOUD.Utils.isMeshObject(e)&&r(e,y.name,y.matrix)}):r(y,y.name))}();if("object"===(void 0===E?"undefined":_typeof(E)))return E.v}}return i[e]&&i[t]?i:null}},{key:"adjustVisibility",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t].adjustVisibility(e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t].changeVisibilityOfSelectedObjects(e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t].changeVisibilityOfNonSelectedObjects(e)}},{key:"adjustInstanceVisibility",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t].adjustInstanceVisibility(e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t].changeInstanceVisibilityOfSelectedObjects(e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t].changeInstanceVisibilityOfNonSelectedObjects(e)}},{key:"restoreVisibilityOfObjects",value:function(){if(CLOUD.GlobalData.BatchMergeEnabled)for(var e in this.models)this.models[e]&&this.models[e].restoreVisibilityOfObjects()}},{key:"getBlinkMaterials",value:function(){var e=[];for(var t in this.models)this.models[t]&&this.models[t].getBlinkMaterials&&(e=e.concat(this.models[t].getBlinkMaterials()));return e}},{key:"resetBlinkMaterial",value:function(){for(var e=this.getBlinkMaterials(),t=0,n=e.length;t<n;t++)e[t].resetBlinkUniformValue()}},{key:"updateBlinkMaterial",value:function(){var e=!1,t=this.blinkColor,n=0,i=CLOUD.EnumShaderColorState.BLINK,r=this.getBlinkMaterials(),a=this.blinkIntervalTime;if(null===this.blinkStartTime&&(e=!0,this.blinkStartTime=Date.now()),e){void 0===this.positiveSequence&&(this.positiveSequence=!0),n=0;for(var o=0,s=r.length;o<s;o++)r[o].updateBlinkUniformValue(i,t,n);return void(this.lastBlinkTime=Date.now())}var l=Date.now();if(l-this.blinkStartTime>a){this.positiveSequence=!this.positiveSequence,n=this.positiveSequence?0:1;for(var o=0,s=r.length;o<s;o++)r[o].updateBlinkUniformValue(i,t,n);return this.blinkStartTime=Date.now(),void(this.lastBlinkTime=Date.now())}if(!(l-this.lastBlinkTime<100)){var u=(l-this.blinkStartTime)/a;n=this.positiveSequence?u:1-u;for(var o=0,s=r.length;o<s;o++)r[o].updateBlinkUniformValue(i,t,n);this.lastBlinkTime=Date.now()}}},{key:"getBlinkColor",value:function(){return this.blinkColor}},{key:"setBlinkColor",value:function(e,t){if(e){var n=CLOUD.Utils.hexToRgb(e);this.blinkColor.fromArray([n.r,n.g,n.b,t||1])}else this.blinkColor.set(this.defaultBlinkColor.r,this.defaultBlinkColor.g,this.defaultBlinkColor.b,this.defaultBlinkAlpha)}},{key:"setBlinkIntervalTime",value:function(e){this.blinkIntervalTime<=0||(this.blinkIntervalTime=e)}},{key:"enableBlink",value:function(e){this.blinkEnabled=e,!1===e&&(this.blinkStartTime=null,this.resetBlinkMaterial()),this.applyBlink()}},{key:"getBlinkEnabled",value:function(){return!this.isBlinkPermited()&&this.blinkEnabled}},{key:"getBlinkComponentsIdMap",value:function(e){return this.isBlinkPermited()?null:this.sceneState.getBlinkComponentsIdMap(e)}},{key:"applyBlink",value:function(){if(!this.isBlinkPermited()){this.selectPriority=!1;for(var e in this.models){this.models[e].applyBlink()}}}},{key:"clearBlink",value:function(){if(!this.isBlinkPermited()){this.selectPriority=!1;for(var e in this.models){this.models[e].clearBlink()}}}},{key:"permitBlink",value:function(e){this.blinkPermited=e}},{key:"isBlinkPermited",value:function(){return this.blinkPermited}},{key:"isSelectPriority",value:function(){return this.selectPriority}},{key:"getSceneState",value:function(){return this.sceneState}},{key:"disposeBufferAfterVbo",value:function(){if(CLOUD.GlobalData.EnableDisposeBufferAfterVbo)for(var e in this.models){var t=this.models[e];t.disposeBufferAfterVbo()}}},{key:"getSourceObjectManager",value:function(){return this.sourceObjectManager||(this.sourceObjectManager=new CLOUD.SourceObjectManager),this.sourceObjectManager}},{key:"isHiddenSourceObjectUserId",value:function(e){return!!this.sourceObjectManager&&this.sourceObjectManager.isHidden(e)}},{key:"hasHiddenSourceObjectUserId",value:function(){return!!this.sourceObjectManager&&this.sourceObjectManager.hasHidden()}},{key:"traverseModels",value:function(e,t){for(var n in this.models){var i=this.models[n];if(t&&t(i))break;e&&e(i)}}},{key:"traverseLoadedModels",value:function(e){this.traverseValidModels(e)}},{key:"traverseValidModels",value:function(e){for(var t in this.models){var n=this.models[t];n&&n.isUseable()&&e(n)}}},{key:"dealStateChanged",value:function(){this.hasModelDataReady()&&(this.isRenderStateChanged()||this.filter.isStateChanged())&&(this.isRenderStateChanged()&&this.setRenderStateChanged(!1),this.filter.isStateChanged()&&(4==CLOUD.GlobalData.LightPreset&&this.viewer.updateShadowMap(),this.filter.disableStateChanged()),this.applyFilter())}},{key:"setRenderStateChanged",value:function(e){this._renderStateChanged=e}},{key:"isRenderStateChanged",value:function(){return this._renderStateChanged}},{key:"hasLoadOnDemandDirector",value:function(){return!!this.loadOnDemandDirector}},{key:"getLoadOnDemandDirector",value:function(){return this.loadOnDemandDirector||(this.loadOnDemandDirector=new CLOUD.LoadOnDemandDirector(this)),this.loadOnDemandDirector}},{key:"checkLayerDataLoading",value:function(){return!!(this.isLayerData()&&this.hasLoadOnDemandDirector()&&this.getLoadOnDemandDirector().isLoading())&&(this.filter.isStateChanged()&&this.filter.disableStateChanged(),!0)}},{key:"updateFilterManager",value:function(){var e=this.getNodeInfos(),t=this.getFilter();t.clearFilterManager(),t.initFilterManager(e),t.isStateChanged()&&t.disableStateChanged(),this.updateMeshNodes(),this.applyFilter()}},{key:"isDrawingBoardlineEnabled",value:function(){return!(!CLOUD.GlobalData.DrawingBoardlineEnabled||CLOUD.GlobalData.DrawingStyle!==CLOUD.DrawingStyle.BOARDLINE&&CLOUD.GlobalData.DrawingStyle!==CLOUD.DrawingStyle.SHADINGWITHLINE)}},{key:"isOnlyWireframe",value:function(){return CLOUD.GlobalData.DrawingStyle===CLOUD.DrawingStyle.BOARDLINE}},{key:"getExplosionTranslation",value:function(e){return this.explosionTranslation[e]||new THREE.Vector3}},{key:"getExplosionExtent",value:function(){return this.explosionExtent}},{key:"setExplosionExtent",value:function(e){var t=e-this.explosionExtent;if(0!=t){var n=new THREE.Matrix4,i=new THREE.Box3;for(var r in this.models){var a=this.models[r];if(a){var o=a.getBoundingBoxWorld();if(!o)continue;for(var s=o.getCenter(),l=this.models[r].getAllNodeInfos(),u=Object.keys(l),c=0,h=u.length;c<h;c++){for(var d=u[c],f=l[d],p=new THREE.Box3,m=0,g=f.length;m<g;m++)f[m].originBox||(f[m].originBox=f[m].boundingBox.clone()),p.union(f[m].originBox);var v=CLOUD.Utils.computeExplodeTranslation(s,p,t);this.explosionTranslation[d]=v,n.makeTranslation(v.x,v.y,v.z);for(var y=0,E=f.length;y<E;y++)f[y].boundingBox.applyMatrix4(n),f[y].matrix.multiplyMatrices(n,f[y].matrix),i.union(f[y].boundingBox)}0==e&&(i=o.clone())}}this.scene.setBoundingBoxWorld(i),4==CLOUD.GlobalData.LightPreset&&(this.scene.updateShadowLight(),this.scene.updateReceivingPlane(),this.viewer.updateShadowMap());for(var a in this.models)this.models[a]&&this.models[a].explode();this.explosionExtent=e,delete this.explosionTranslation,this.explosionTranslation={},this.dispatchEvent({type:CLOUD.EVENTS.ON_EXPLOSION,extent:e})}}},{key:"setFloorExplosion",value:function(e,t){if(void 0!=this.floorInfos){delete this.floorExplosionList,this.floorExplosionList=[];var n=!0,i={};if(t){for(var r=0,a=t.length;r<a;r++)i[t[r]]=!0;if(n=!1,0==t.length)return}for(var o={},s=this.floorInfos,l=s.length,u=e*this.totalHeight/(l-1),c=0,h=0;h<l;h++){var d=s[h].name,f=s[h].elevation+c*u,p=f-s[h].explodedHeight;o[d]=new THREE.Vector3(0,0,p),(n||i[s[h].id])&&(c++,this.floorExplosionList.push(s[h].id)),s[h].preExplodedHeight=s[h].explodedHeight,s[h].explodedHeight=f}var m=new THREE.Matrix4,g=new THREE.Box3;for(var v in this.models){var y=this.models[v];if(y&&y.hasTransforms())for(var E=this.models[v].getAllNodeInfos(),b=Object.keys(E),x=0,M=b.length;x<M;x++)for(var _=b[x],C=E[_],I=0,O=C.length;I<O;I++){if(0==I){var T=o[C[I].userData.levelName]||new THREE.Vector3;m.makeTranslation(T.x,T.y,T.z),this.explosionTranslation[_]=T}C[I].boundingBox.applyMatrix4(m),C[I].matrix.multiplyMatrices(m,C[I].matrix),g.union(C[I].boundingBox)}}this.scene.setBoundingBoxWorld(g),this.getFilter().needUpdateBoxAfterExplode();for(var y in this.models)this.models[y]&&this.models[y].explode();4==CLOUD.GlobalData.LightPreset&&(this.scene.updateShadowLight(),this.viewer.updateShadowMap()),this.floorExplosionExtent=e,delete this.explosionTranslation,this.explosionTranslation={},this.dispatchEvent({type:CLOUD.EVENTS.ON_FLOOR_EXPLOSION,translations:o,floorInfos:s})}}},{key:"getFloorInfos",value:function(){return this.floorInfos}},{key:"calculateClippingIds",value:function(){for(var e in this.models)this.models[e]&&this.models[e].calculateClippingIds()}}]),t}(THREE.EventDispatcher);CLOUD.ModelManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.modelManager=t,this.observerForSceneState=null,this.filterHelper=this.modelManager.getFilterHelper()}return _createClass(e,[{key:"destroy",value:function(){this.modelManager=null,this.observerForSceneState=null}},{key:"clear",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().clear()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clear()}}},{key:"setIsolateMaterial",value:function(e,t){if(void 0===t)this.modelManager.traverseValidModels(function(t){t.getFilter()&&t.getFilter().setIsolateMaterial(e)});else{var n=this.modelManager.getModel(t);n&&n.getFilter()&&n.getFilter().setIsolateMaterial(e)}}},{key:"resetIsolateMaterial",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().resetIsolateMaterial()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().resetIsolateMaterial()}}},{key:"setFrozonMaterial",value:function(e,t){if(void 0===t)this.modelManager.traverseValidModels(function(t){t.getFilter()&&t.getFilter().setFrozonMaterial(e)});else{var n=this.modelManager.getModel(t);n&&n.getFilter()&&n.getFilter().setFrozonMaterial(e)}}},{key:"getFrozonMaterial",value:function(e){var t,n=[];if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&(t=e.getFilter().getFrozonMaterial())&&n.push(t)});else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter().getFrozonMaterial())&&n.push(t)}return n[0]}},{key:"_getMaterialByName",value:function(e,t){var n,i=[];if(void 0===t)this.modelManager.traverseValidModels(function(t){t.getFilter()&&(n=t.getFilter()._getMaterialByName(e))&&i.push(n)});else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(n=r.getFilter()._getMaterialByName(e))&&i.push(n)}return i[0]}},{key:"_isolate",value:function(e,t,n){var i=e.getFilter();switch(n){case"hide":i.setIsolateConditions(t,CLOUD.EnumIsolateState.HIDDEN_OTHERS);break;case"translucent":i.setIsolateConditions(t,CLOUD.EnumIsolateState.TRANSLUCENT_OTHERS);break;default:console.log("no this isolate state : "+n)}}},{key:"isolate",value:function(e,t,n){var i=this,r=function(e,n){i._isolate(e,n,t)};this.filterHelper.executeConditions(e,r,n)}},{key:"setConditions",value:function(e,t,n){var i=function(t,n){t.getFilter().setConditions(e,n)};this.filterHelper.executeConditions(t,i,n)}},{key:"isHidden",value:function(e,t){var n=!1,i=function(e,t){n||(n=e.getFilter().getObjectInfoManager().isHidden(t))};return this.filterHelper.executeId(e,i,t),n}},{key:"isFrozen",value:function(e,t){var n=!1,i=function(e,t){n||(n=e.getFilter().getObjectInfoManager().isFrozen(t))};return this.filterHelper.executeId(e,i,t),n}},{key:"isIsolate",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter().isIsolate())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter().isIsolate())}return t}},{key:"isFiltering",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter().isFiltering())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter().isFiltering())}return t}},{key:"getMatchIds",value:function(e,t){var n=[],i=function(e,t){n=n.concat(e.getFilter().getMatchIds(t))};return this.filterHelper.executeConditions(e,i,t),n}},{key:"isMatchConditions",value:function(e,t,n){var i=!1,r=function(t,n){i=i||t.getFilter().getObjectInfoManager().isMatchConditions(e,n)};return this.filterHelper.executeConditions(t,r,n),i}},{key:"deactivateByIds",value:function(e,t){var n=function(e,t){e.getFilter().deactivateByIds(t)};this.filterHelper.executeIds(e,n,t)}},{key:"addToOverrideListByColor",value:function(e,t,n){var i=function(e,n){e.getFilter().addToOverrideListByColor(n,t)};this.filterHelper.executeIds(e,i,n)}},{key:"addToOverrideListByOpacity",value:function(e,t,n){var i=this,r=function(e,r){if(e&&e.getFilter()&&e._handler){for(var a={},o=[],s=0;s<r.length;s++){var l=!0,u=r[s],c=null,h=null,d=e.getFilter().getObjectInfoManager().getMaterial(u);if(d&&(c=d,c.name.indexOf("_opacity")<0&&(l=!1),c.map&&(h=c.map)),l&&t>.999)o.push(u);else{var f=e._handler.getGeometryBuffersByUserId(u);if(f&&f.length>0){h=null;for(var p=0;p<f.length;p++){var m=f[p],g=i.modelManager.getMaterialByNodeId(m.databagId,u,m.nodeId);if(g.map){h=g.map,c=g;break}g.dispose()}var m=f[f.length-1];c||(c=i.modelManager.getMaterialByNodeId(m.databagId,u,m.nodeId))}if(c){var v=c.color.getHex();c.dispose();var y=v+"";h&&(y+="_"+h.uuid),l&&(y+="_opacity"),a[y]?a[y].ids.push(u):(a[y]={color:{color:v,opacity:t},ids:[u]},l&&(a[y].color.setByOpacity=l),h&&(a[y].color.map=h)),h&&h.dispose(),h=null}}}for(var E in a){var b=a[E];e.getFilter().addToOverrideListByColor(b.ids,b.color)}o.length>0&&i.addToOverrideListByColor(o,null,n)}};if("conditions"===e.type){var a=e.param,o=function(e,t){var n=function(t,n){n&&r(e,t)};e.getFilter().getObjectInfoManager().matchConditions(t,n)};this.filterHelper.executeConditions(a,o,n)}else{var s=e.param,o=function(e,t){r(e,t)};this.filterHelper.executeIds(s,o,n)}}},{key:"addToOverrideListByMaterial",value:function(e,t,n){var i=function(e,n){e.getFilter().addToOverrideListByMaterial(n,t)};this.filterHelper.executeConditions(e,i,n)}},{key:"addToOverrideListByConditions",value:function(e,t,n){var i=function(e,n){e.getFilter().addToOverrideListByConditions(n,t)};this.filterHelper.executeConditions(e,i,n)}},{key:"addToOverrideListByMaterialAndId",value:function(e,t,n){var i=function(e,n){e.getFilter().addToOverrideListByMaterialAndId(n,t)};this.filterHelper.executeIds(e,i,n)}},{key:"clearAllOverrideList",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().clearAllOverrideList()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearAllOverrideList()}}},{key:"addToOverrideListForWireFrameByColor",value:function(e,t,n){var i=function(e,n){e.getFilter().addToOverrideListForWireFrameByColor(n,t)};this.filterHelper.executeIds(e,i,n)}},{key:"addToOverrideListForWireFrameByConditions",value:function(e,t,n){var i=function(e,n){e.getFilter().addToOverrideListForWireFrameByConditions(n,t)};this.filterHelper.executeConditions(e,i,n)}},{key:"addToIsolateList",value:function(e,t,n){var i=function(e,n){e.getFilter().addToIsolateList(n,t)};this.filterHelper.executeIds(e,i,n)}},{key:"setIsolateConditions",value:function(e,t,n){var i=function(e,n){e.getFilter().setIsolateConditions(n,t)};this.filterHelper.executeConditions(e,i,n)}},{key:"clearIsolation",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().clearIsolation()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearIsolation()}}},{key:"clearAllIsolateConditions",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().clearAllIsolateConditions()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearAllIsolateConditions()}}},{key:"showByIds",value:function(e,t){var n=function(e,t){e.getFilter().showByIds(t)};this.filterHelper.executeIds(e,n,t)}},{key:"showByConditions",value:function(e,t){var n=function(e,t){e.getFilter().showByConditions(t)};this.filterHelper.executeConditions(e,n,t)}},{key:"hideByIds",value:function(e,t){var n=function(e,t){e.getFilter().hideByIds(t)};this.filterHelper.executeIds(e,n,t)}},{key:"hideByConditions",value:function(e,t){var n=function(e,t){e.getFilter().hideByConditions(t)};this.filterHelper.executeConditions(e,n,t)}},{key:"hideOthersByConditions",
value:function(e,t){var n=function(e,t){e.getFilter().hideOthersByConditions(t)};this.filterHelper.executeConditions(e,n,t)}},{key:"showAll",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().showAll()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().showAll()}}},{key:"hideAll",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().hideAll()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().hideAll()}}},{key:"showScene",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().showScene()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().showScene()}}},{key:"clearInactivatedIdMap",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().clearInactivatedIdMap()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearInactivatedIdMap()}}},{key:"makeTranslucentByIds",value:function(e,t){var n=function(e,t){e.getFilter().makeTranslucentByIds(t)};this.filterHelper.executeIds(e,n,t)}},{key:"makeTranslucentByConditions",value:function(e,t){var n=function(e,t){e.getFilter().makeTranslucentByConditions(t)};this.filterHelper.executeConditions(e,n,t)}},{key:"makeTranslucentOthersByIds",value:function(e,t){var n=function(e,t){e.getFilter().makeTranslucentOthersByIds(t)};this.filterHelper.executeIds(e,n,t)}},{key:"opaqueByIds",value:function(e,t){var n=function(e,t){e.getFilter().opaqueByIds(t)};this.filterHelper.executeIds(e,n,t)}},{key:"opaqueByConditions",value:function(e,t){var n=function(e,t){e.getFilter().opaqueByConditions(t)};this.filterHelper.executeConditions(e,n,t)}},{key:"opaqueAll",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().opaqueAll()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().opaqueAll()}}},{key:"_hasVisibleFilter",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasVisibleFilter())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasVisibleFilter())}return t}},{key:"_hasPickableFilter",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasPickableFilter())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasPickableFilter())}return t}},{key:"_hasHiddenFileIdFilter",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasHiddenFileIdFilter())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasHiddenFileIdFilter())}return t}},{key:"_hasOverrideMaterialFilter",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasOverrideMaterialFilter())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasOverrideMaterialFilter())}return t}},{key:"_hasTransparentFilter",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasTransparentFilter())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasTransparentFilter())}return t}},{key:"_hasOverrideMaterialFilterForWireFrame",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasOverrideMaterialFilterForWireFrame())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasOverrideMaterialFilterForWireFrame())}return t}},{key:"_hasRenderWithBoardlineFilter",value:function(e){var t=!1;if(void 0===e)this.modelManager.traverseModels(function(e){e.getFilter()&&(t=e.getFilter()._hasRenderWithBoardlineFilter())},function(e){return t||!e.isUseable()});else{var n=this.modelManager.getModel(e);n&&n.getFilter()&&(t=n.getFilter()._hasRenderWithBoardlineFilter())}return t}},{key:"_isRenderWithBoardline",value:function(e,t){var n=!1;if(void 0===t)this.modelManager.traverseModels(function(t){t.getFilter()&&(n=t.getFilter()._isRenderWithBoardline(e))},function(e){return n||!e.isUseable()});else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&(n=i.getFilter()._isRenderWithBoardline(e))}return n}},{key:"_isVisible",value:function(e,t){var n=!0;if(void 0===t)this.modelManager.traverseModels(function(t){t.getFilter()&&(n=t.getFilter()._isVisible(e))},function(e){return!n||!e.isUseable()});else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&(n=i.getFilter()._isVisible(e))}return n}},{key:"_isPickable",value:function(e,t){var n=!0;if(void 0===t)this.modelManager.traverseModels(function(t){t.getFilter()&&(n=t.getFilter()._isPickable(e))},function(e){return!n||!e.isUseable()});else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&(n=i.getFilter()._isPickable(e))}return n}},{key:"initFilterManager",value:function(e,t){if(void 0===t)this.modelManager.traverseValidModels(function(t){if(t.getFilter()){var n={};n[t.id]=e[t.id],t.getFilter().initFilterManager(n)}});else{var n=this.modelManager.getModel(t);if(n&&n.getFilter()){var i={};i[t]=e[t],n.getFilter().initFilterManager(i)}}}},{key:"reinitFilterManager",value:function(e,t){if(void 0===t)this.modelManager.traverseValidModels(function(t){if(t.getFilter()){var n={};n[t.id]=e[t.id],t.getFilter().reinitFilterManager(n)}});else{var n=this.modelManager.getModel(t);if(n&&n.getFilter()){var i={};i[t]=e[t],n.getFilter().reinitFilterManager(i)}}}},{key:"clearFilterManager",value:function(e){if(void 0===e)this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().clearFilterManager()});else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearFilterManager()}}},{key:"isStateChanged",value:function(e){var t=!1,n=this.modelManager;if(void 0===e)n.traverseModels(function(e){e.getFilter()&&(t=e.getFilter().isStateChanged())},function(e){return t||!e.isUseable()});else{var i=n.getModel(e);i&&i.getFilter()&&(t=i.getFilter().isStateChanged())}return t}},{key:"disableStateChanged",value:function(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels(function(e){e.getFilter()&&e.getFilter().disableStateChanged()});else{var n=t.getModel(e);n&&n.getFilter()&&n.getFilter().disableStateChanged()}}},{key:"calculateVisibleComponentsBbox",value:function(){this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().getObjectInfoManager().calculateVisibleComponentsBbox()})}},{key:"getVisibleComponentsBbox",value:function(){var e,t=new THREE.Box3;return this.modelManager.traverseValidModels(function(n){n.getFilter()&&(e=n.getFilter().getVisibleComponentsBbox(),e.isEmpty()||t.union(e))}),t}},{key:"setObserverForSceneState",value:function(e){this.observerForSceneState=e}},{key:"getObserverForSceneState",value:function(){return this.observerForSceneState}},{key:"isComponentActive",value:function(e,t){var n=!1,i=function(e,t){n||(n=e.getFilter().isComponentActive(t))};return this.filterHelper.executeId(e,i,t),n}},{key:"needUpdateBoxAfterExplode",value:function(){var e=!1;return this.modelManager.traverseModels(function(t){t.getFilter()&&(e=t.getFilter().needUpdateBoxAfterExplode())},function(t){return e||!t.isUseable()}),e}},{key:"getVisibleComponentSet",value:function(e){var t={};return this.modelManager.traverseValidModels(function(n){if(n.getFilter()){var i=n.getFilter().getVisibleComponentSet(e);for(var r in i)t[r]=i[r]}}),t}},{key:"saveState",value:function(){var e={};return this.modelManager.traverseValidModels(function(t){t.getFilter()&&(e[t.id]=t.getFilter().saveState())}),JSON.stringify(e)}},{key:"loadState",value:function(e){var t=JSON.parse(e);t.version?this.modelManager.traverseValidModels(function(e){e.getFilter()&&e.getFilter().loadState(t)}):this.modelManager.traverseValidModels(function(e){e.getFilter()&&t[e.id]&&e.getFilter().loadState(t[e.id])})}},{key:"getObjectsMap",value:function(e){var t={},n=this.modelManager;if(void 0===e)n.traverseValidModels(function(e){if(e.getFilter()){var n=e.getFilter().getObjectInfoManager().getObjectsMap();for(var i in n)t[i]=n[i]}});else{var i=n.getModel(e);if(i&&i.getFilter()){var r=i.getFilter().getObjectInfoManager().getObjectsMap();for(var a in r)t[a]=r[a]}}return t}},{key:"deactivateAll",value:function(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels(function(e){e.getFilter()&&e.getFilter().deactivateAll()});else{var n=t.getModel(e);n&&n.getFilter()&&n.getFilter().deactivateAll()}}},{key:"activateAll",value:function(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels(function(e){e.getFilter()&&e.getFilter().activateAll()});else{var n=t.getModel(e);n&&n.getFilter()&&n.getFilter().activateAll()}}}]),e}();CLOUD.ModelView.FilterDirector=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.modelManager=t}return _createClass(e,[{key:"distributeIdsByModelId",value:function(e){for(var t={},n=this.modelManager.getModelIds(!0),i=[],r=function(e,n){e=e.toString(),t[e]||(t[e]=[]),"[object String]"===Object.prototype.toString.call(n)?t[e].push(n):"[object Array]"===Object.prototype.toString.call(n)&&(t[e]=t[e].concat(n))},a=0;a<e.length;a++){var o=this.distributeId(e[a]),s=o.modelId,l=o.objectId;s?r(s,l):i.push(l)}if(i.length>0)for(var u=0;u<n.length;u++)r(n[u],i);return t}},{key:"distributeId",value:function(e){if(!e)return{modelId:void 0,objectId:e};var t,n,i=/(.*?)\.(.*)/.exec(e.toString());if(i){t=i[1],n=i[2];this.modelManager.getModelIds(!0).indexOf(t)<0&&(t=void 0,n=e)}else n=e;return{modelId:t,objectId:n}}},{key:"distributeConditionsByModelId",value:function(e){for(var t={},n=this.modelManager.getModelIds(!0),i=[],r=function(e,i){e=e.toString(),n.indexOf(e)>=0&&(t[e]||(t[e]=[]),"[object Object]"===Object.prototype.toString.call(i)?t[e].push(i):"[object Array]"===Object.prototype.toString.call(i)&&(t[e]=t[e].concat(i)))},a=0;a<e.length;a++){var o=e[a];if(o.hasOwnProperty("modelId")){var s=o.modelId;delete o.modelId,r(s,o)}else i.push(o)}if(i.length>0)for(var l=0;l<n.length;l++)r(n[l],i);return t}},{key:"executeConditions",value:function(e,t,n){if(n){var i=this.modelManager.getModel(n);if(i&&i.getFilter())if(e&&0!==e.length){var r=this.distributeConditionsByModelId(e);r[n]&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,r[n])}else"[object Function]"===Object.prototype.toString.call(t)&&t(i,e)}else if(e&&0!==e.length){var r=this.distributeConditionsByModelId(e);for(var a in r){var i=this.modelManager.getModel(a),o=r[a];i&&i.getFilter()&&o&&o.length>0&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,o)}}else this.modelManager.traverseValidModels(function(n){n.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(n,e)})}},{key:"executeIds",value:function(e,t,n){if(n){var i=this.modelManager.getModel(n);if(i&&i.getFilter())if(e&&0!==e.length){var r=this.distributeIdsByModelId(e);r[n]&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,r[n])}else"[object Function]"===Object.prototype.toString.call(t)&&t(i,e)}else if(e&&0!==e.length){var r=this.distributeIdsByModelId(e);for(var a in r){var i=this.modelManager.getModel(a),o=r[a];i&&i.getFilter()&&o&&o.length>0&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,o)}}else this.modelManager.traverseValidModels(function(n){n.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(n,e)})}},{key:"executeId",value:function(e,t,n){var i=this.distributeId(e),r=i.modelId,a=i.objectId;if(n){if(!r||r.toString()===n.toString()){var o=this.modelManager.getModel(n);o&&o.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(o,a)}}else if(r){var o=this.modelManager.getModel(r);o&&o.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(o,a)}else this.modelManager.traverseValidModels(function(e){e.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(e,a)})}}]),e}();CLOUD.ModelView.FilterHelper=e}();var LoadTaskRunner=function(){function e(t){_classCallCheck(this,e),this.limit=t,this.store=[],this.active=0}return _createClass(e,[{key:"next",value:function(){this.store.length&&this.runTask.apply(this,_toConsumableArray(this.store.shift()))}},{key:"runTask",value:function(e,t,n,i){this.active++;var r=this;e.load(t,function(e){r.active--;var t={context:e,paras:n};i&&i(t),r.next()})}},{key:"push",value:function(e,t,n,i){this.active<this.limit?this.runTask(e,t,n,i):this.store.push([e,t,n,i])}}]),e}();CLOUD.LoadTaskRunner=LoadTaskRunner,function(){var e=function(){function e(){_classCallCheck(this,e),this.loader=new THREE.FileLoader}return _createClass(e,[{key:"destroy",value:function(){this.loader=null}},{key:"load",value:function(e,t,n){var i=new CLOUD.Loader.Url({serverUrl:e.parameters.serverUrl,databagId:e.parameters.databagId,lightmapDatabagId:e.parameters.lightmapDatabagId}),r=this,a=this.loader;a.setResponseType(""),a.load(i.projectUrl(),function(i){var a;try{a=JSON.parse(i)}catch(e){return n(e),void CLOUD.EventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_INVALID_SCENE})}var o=r.getModel(a,e);t&&t(o)},void 0,function(e){console.log("Config load error!"),n(e),CLOUD.EventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_INVALID_SCENE})})}},{key:"getModel",value:function(e,t){var n=e.metadata.asset?e.metadata.asset:"bmd",i=e.metadata.root?e.metadata.root:void 0;t.parameters.rootPath=i;var r=CLOUD.ModelFactory[n](t.viewer,t.manager,t.parameters,t.index,t.parseCfgFinish,t.debut);return r.config=e,r}}]),e}();CLOUD.ModelLoader=e}(),function(){CLOUD.ModelFactory={pointCloud:function(e,t,n,i,r,a){return new CLOUD.PointCloudModel(e,t,n,i,r,a)},"3dtiles":function(e,t,n,i,r,a){return new CLOUD.$3dTilesModel(e,t,n,i,r,a)},dem:function(e,t,n,i,r,a){return new CLOUD.DemModel(e,t,n,i,r,a)},bimtile:function(e,t,n,i,r,a){return new CLOUD.BimTilesModel(e,t,n,i,r,a)},bmd:function(e,t,n,i,r,a){return new CLOUD.Model(t,n,i,r,a)}}}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.frameNumber=0,this.newFrame=!1,this.time=void 0,this.camera=void 0,this.cullingVolume=void 0,this.pixelRatio=1,this.maximumScreenSpaceError=void 0,this.afterRender=[]}return _createClass(e,[{key:"destroy",value:function(){this.afterRender=null}}]),e}();CLOUD.FrameState=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.selected=0,this.visited=0,this.numberOfPendingRequests=0,this.numberOfTilesProcessing=0,this.numberOfTilesWithContentReady=0,this.numberOfTilesTotal=0,this.numberOfTilesLoadedTotal=0,this.numberOfTrianglesSelected=0,this.geometryByteLength=0,this.texturesByteLength=0}return _createClass(e,[{key:"clear",value:function(){this.selected=0,this.visited=0,this.numberOfTrianglesSelected=0}},{key:"_updateCount",value:function(e,t,n){var i=e.trianglesLength,r=e.geometryByteLength,a=e.texturesByteLength;n?(this.geometryByteLength+=t?-r:r,this.texturesByteLength+=t?-a:a):this.numberOfTrianglesSelected+=t?-i:i}},{key:"incrementSelectionCount",value:function(e){this._updateCount(e,!1,!1)}},{key:"incrementLoadCount",value:function(e){this._updateCount(e,!1,!0)}},{key:"decrementLoadCount",value:function(e){this._updateCount(e,!0,!0)}},{key:"copy",value:function(e){this.selected=e.selected,this.visited=e.visited,this.numberOfPendingRequests=e.numberOfPendingRequests,this.numberOfTilesProcessing=e.numberOfTilesProcessing,this.numberOfTilesWithContentReady=e.numberOfTilesWithContentReady,this.numberOfTilesTotal=e.numberOfTilesTotal,this.numberOfTrianglesSelected=e.numberOfTrianglesSelected,this.geometryByteLength=e.geometryByteLength,this.texturesByteLength=e.texturesByteLength}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),e}();CLOUD.Statistics=e}(),function(){CLOUD.TileContentState={UNLOADED:0,LOADING:1,PROCESSING:2,CONSTRUCTING:3,READY:4,FAILED:5}}(),function(){var e=function(){function e(){_classCallCheck(this,e),this._list=new CLOUD.DoublyLinkedList,this._sentinel=this._list.add(),this._trimTiles=!1}return _createClass(e,[{key:"destroy",value:function(){this._list=null,this._sentinel=null}},{key:"reset",value:function(){this._list.splice(this._list.tail,this._sentinel)}},{key:"touch",value:function(e){var t=e.cacheNode;t&&this._list.splice(this._sentinel,t)}},{key:"add",value:function(e){e.cacheNode||(e.cacheNode=this._list.add(e))}},{key:"unloadTile",value:function(e,t,n){var i=t.cacheNode;i&&(this._list.remove(i),t.cacheNode=void 0,n(e,t))}},{key:"unloadTiles",value:function(e,t){var n=this._trimTiles;this._trimTiles=!1;for(var i=this._list,r=1024*e.maximumMemoryUsage*1024,a=this._sentinel,o=i.head;o!==a&&(e.totalMemoryUsageInBytes>r||n);){var s=o.item;o=o.next,this.unloadTile(e,s,t)}}},{key:"trim",value:function(){this._trimTiles=!0}}]),e}();CLOUD.TilesCache=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this._maximumMemoryUsage=t.maximumMemoryUsage||512,this._destroyed=!1,this._root=void 0,this._cache=new CLOUD.TilesCache,this._statistics=new CLOUD.Statistics,this._processingTiles=[],this._selectedTiles=[],this._requestedTiles=[],this.tileLoadedEvent=new CLOUD.Event,this.tileUnloadEvent=new CLOUD.Event,this.tileFailedEvent=new CLOUD.Event}return _createClass(e,[{key:"destroy",value:function(){this._destroyed=!1,this._root=void 0,this._cache=void 0,this._statistics=void 0,this._processingTiles=void 0,this._selectedTiles=void 0,this._requestedTiles=void 0,this.tileLoadedEvent=void 0,this.tileUnloadEvent=void 0,this.tileFailedEvent=void 0}},{key:"isDestroyed",value:function(){return this._destroyed}},{key:"preUpdate",value:function(e){}},{key:"update",value:function(e){return!!this.ready&&(this.statistics.clear(),this.selectTiles(e),this.requestTiles(),this.updateTiles(e),!0)}},{key:"postUpdate",value:function(e){}},{key:"processTiles",value:function(e){}},{key:"selectTiles",value:function(e){}},{key:"requestTiles",value:function(){}},{key:"updateTiles",value:function(e){}},{key:"unloadTiles",value:function(){}},{key:"selectTile",value:function(e,t){}},{key:"requestTile",value:function(e,t){}},{key:"updateTile",value:function(e,t){}},{key:"touchTile",value:function(e,t){}},{key:"visitTile",value:function(e,t){}},{key:"cacheTile",value:function(e){}},{key:"onTileContentReady",value:function(e,t){}},{key:"onTileContentRequest",value:function(e,t){}},{key:"onTileContentFailure",value:function(e){}},{key:"root",set:function(e){this._root=e},get:function(){return this._root}},{key:"ready",get:function(){return!!this._root}},{key:"statistics",get:function(){return this._statistics}},{key:"maximumMemoryUsage",get:function(){return this._maximumMemoryUsage},set:function(e){this._maximumMemoryUsage=e}},{key:"totalMemoryUsageInBytes",get:function(){var e=this._statistics;return e.texturesByteLength+e.geometryByteLength}}]),e}();CLOUD.AbstractTileset=e}(),function(){var e=function(){function e(t,n){_classCallCheck(this,e),this._tileset=t,this._parent=n,this._destroyed=!1,this._contentUrl=void 0,this._content=void 0,this._contentType=void 0,this._contentState=CLOUD.TileContentState.UNLOADED,this._box=null,this._visible=!1,this._childrenTree=[]}return _createClass(e,[{key:"destroy",value:function(){this._destroyed=!1,this._tileset=void 0,this._parent=null,this._contentType=void 0,this._contentState=void 0,this._contentUrl=void 0,this._content=this._content&&this._content.destroy(),this._box=null,this._visible=void 0,this._childrenTree=void 0}},{key:"isDestroyed",value:function(){return this._destroyed}},{key:"update",value:function(e){}},{key:"process",value:function(e){}},{key:"requestContent",value:function(e){}},{key:"updateContent",value:function(e){}},{key:"unloadContent",value:function(){}},{key:"isContentVisible",value:function(e){return!0}},{key:"visible",get:function(){return this._visible},set:function(e){return this._visible=e}},{key:"childrenTree",get:function(){return this._childrenTree}},{key:"box",get:function(){return this._box},set:function(e){return this._box=e}},{key:"contentUrl",get:function(){return this._contentUrl},set:function(e){return this._contentUrl=e}},{key:"content",get:function(){return this._content},set:function(e){return this._content=e}},{key:"contentType",get:function(){return this._contentType},set:function(e){this._contentType=e}},{key:"contentState",get:function(){return this._contentState},set:function(e){this._contentState=e}},{key:"contentUnloaded",get:function(){return this._contentState===CLOUD.TileContentState.UNLOADED}},{key:"contentLoading",get:function(){return this._contentState===CLOUD.TileContentState.LOADING}},{key:"contentProcessing",get:function(){return this._contentState===CLOUD.TileContentState.PROCESSING}},{key:"contentCONSTRUCTING",get:function(){return this._contentState===CLOUD.TileContentState.CONSTRUCTING}},{key:"contentReady",get:function(){return this._contentState===CLOUD.TileContentState.READY}}]),e}();CLOUD.AbstractTile=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this._tile=t,this._ready=!1,this._destroyed=!1,this._geometryByteLength=0,this._texturesByteLength=0}return _createClass(e,[{key:"destroy",value:function(){this._destroyed=!0,this._tile=null}},{key:"isDestroyed",value:function(){return this._destroyed}},{key:"update",value:function(e){}},{key:"tile",get:function(){return this._tile}},{key:"ready",get:function(){return this._ready}},{key:"geometryByteLength",get:function(){return this._geometryByteLength}},{key:"texturesByteLength",get:function(){return this._texturesByteLength}}]),e}();CLOUD.AbstractTileContent=e}(),function(){function e(e,t){e.tileUnloadEvent.fireEvent(t),e._statistics.decrementLoadCount(t.content),--e._statistics.numberOfTilesWithContentReady,t.unloadContent()}function t(e,t){return function(){e._processingTiles.push(t),--e._statistics.numberOfPendingRequests,++e._statistics.numberOfTilesProcessing}}function n(e){for(var t=e._processingTiles,n=0,i=0,r=t.length;i<r;++i){var a=t[i];a.contentProcessing?n>0&&(t[i-n]=a):++n}t.length-=n}function i(e,t){return function(n){var i=t.contentIndex,r=n.message?n.message:n.toString();e.tileFailedEvent.numberOfListeners>0?e.tileFailedEvent.fireEvent({url:i,message:r}):console.log("Error: "+r)}}function r(e,t){return function(){e.cacheTile(t)}}var a=function(a){function o(e){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e))}return _inherits(o,a),_createClass(o,[{key:"destroy",value:function(){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"destroy",this).call(this)}},{key:"preUpdate",value:function(e){this.ready&&(this.processTiles(e),e.newFrame&&this._cache.reset())}},{key:"update",value:function(e,t){return!!this.ready&&(this._statistics.clear(),this._requestedTiles.length=0,this._selectedTiles.length=0,t&&t(),this.updateTiles(e),!0)}},{key:"postUpdate",value:function(t){this.ready&&(this.cancelRequestsWhenOutOfView(t),this._cache.unloadTiles(this,e))}},{key:"cancelRequestsWhenOutOfView",value:function(e){}},{key:"processTiles",value:function(e){n(this);for(var t=this._processingTiles,i=0,r=t.length;i<r;++i)t[i].process(this,e)}},{key:"selectTile",value:function(e,t){e.isContentVisible(t)&&this._selectedTiles.push(e)}},{key:"requestTiles",value:function(){for(var e=tileset._requestedTiles,t=0,n=e.length;t<n;++t)this.requestContent(e[t])}},{key:"requestTile",value:function(e,t){e._requestedFrame!==t.frameNumber&&e.contentUnloaded&&(e._requestedFrame=t.frameNumber,this._requestedTiles.push(e))}},{key:"updateTiles",value:function(e){for(var t,n=this._statistics,i=this._selectedTiles,r=0,a=i.length;r<a;++r)t=i[r],t.update(e),n.incrementSelectionCount(t.content),++n.selected}},{key:"updateTile",value:function(e,t){this.updateTileVisibility(e,t),this.updateMinimumMaximumPriority(e)}},{key:"updateTileVisibility",value:function(e,t){}},{key:"updateMinimumMaximumPriority",value:function(e){}},{key:"touchTile",value:function(e,t){e._touchedFrame!==t.frameNumber&&(this._cache.touch(e),e._touchedFrame=t.frameNumber)}},{key:"visitTile",value:function(e,t){++this._statistics.visited,e._visitedFrame=t.frameNumber}},{key:"cacheTile",value:function(e){--this._statistics.numberOfTilesProcessing,++this._statistics.numberOfTilesWithContentReady,++this._statistics.numberOfTilesLoadedTotal,this._statistics.incrementLoadCount(e.content),this._cache.add(e),this.tileLoadedEvent.fireEvent(e)}},{key:"onTileContentReady",value:function(e,t){e.contentReady||e.updateContent(t)}},{key:"onTileContentRequest",value:function(e,t){e.contentProcessing||this.requestContent(e,t)}},{key:"onTileContentFailure",value:function(e){}},{key:"requestContent",value:function(e,n){++this._statistics.numberOfPendingRequests,e.requestContent(n),e.contentProcessPromise.then(t(this,e)),e.contentReadyPromise.then(r(this,e)).catch(i(this,e))}}]),o}(CLOUD.AbstractTileset);CLOUD.Tileset=a}(),CLOUD.Loader=CLOUD.Loader||{},function(){var e=function(){function e(t){_classCallCheck(this,e),this.databagPath=t.serverUrl+""+t.databagId,this.lightmapPath=t.lightmapDatabagId?t.serverUrl+""+t.lightmapDatabagId:t.lightmapDatabagId}return _createClass(e,[{key:"projectUrl",value:function(){return this.databagPath+"/config.json"}},{key:"sceneUrl",value:function(e){return e=e||0,this.databagPath+"/scene/scene_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"sceneIdUrl",value:function(){return this.databagPath+"/scene/scene_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"userIdUrl",value:function(){return this.databagPath+"/scene/user_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"octreeUrl",value:function(e){return e=e||"o",this.databagPath+"/scene/octree_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"symbolUrl",value:function(){return this.databagPath+"/symbol/symbol"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"mpkUrl",value:function(e){return e=e||0,this.databagPath+"/mpk/mpk_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"bmpkUrl",value:function(e){return e=e||0,this.databagPath+"/bmpk/bmpk_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"bmpkIndexUrl",value:function(){return this.databagPath+"/bmpk/index"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"meshIdUrl",value:function(){return this.databagPath+"/mpk/mesh_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"materialUrl",value:function(){return this.databagPath+"/material/material"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"uv2Url",value:function(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.buf":this.databagPath+"/uv2/uvs1-export.buf"}},{key:"uv2MapItemUrl",value:function(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.json":this.databagPath+"/uv2/uvs1-export.json"}},{key:"lightmapTexUrl",value:function(e){return this.lightmapPath?this.lightmapPath+"/texture/"+e:this.databagPath+"/texture/"+e}},{key:"lightmapProjectUrl",value:function(){return this.lightmapPath?this.lightmapPath+"/config.json":this.lightmapPath}},{key:"materialIdUrl",value:function(){return this.databagPath+"/material/material_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"texturePkgOrgIndexUrl",value:function(){return this.databagPath+"/texture/pkg_org_index"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"texturePkgSmallIndexUrl",value:function(){return this.databagPath+"/texture/pkg_s_index"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"texturePkgIndexUrl",value:function(e){return e?this.databagPath+"/texture/pkg_index"+CLOUD.GlobalData.ZipResourcePostfix:this.databagPath+"/texture/pkg_index"+CLOUD.GlobalData.JsonResourcePostfix}},{key:"texturePkgFileName",value:function(e,t,n,i){var r=void 0;return r=e?"pkg_"+n:"pkg_"+i+"_"+n,t&&(r+=CLOUD.GlobalData.ZipResourcePostfix),r}},{key:"bmpkPkgIndexUrl",value:function(){return this.databagPath+"/bmpk/pkg_index"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"userDataUrl",value:function(){return this.databagPath+"/userdata/userdata"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"cameraUrl",value:function(){return this.databagPath+"/scene/camera"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"textureUrl",value:function(e){return this.databagPath+"/texture/"+e}},{key:"layerUrl",value:function(){return this.databagPath+"/scene/layer"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerKeyUrl",value:function(){return this.databagPath+"/scene/layer_key"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"lineUrl",value:function(){return this.databagPath+"/line/line"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerSceneUrl",value:function(e){return e=e||0,this.databagPath+"/layer/layer_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerSceneCell",value:function(){return this.databagPath+"/layer/layer_cell"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerOctree",value:function(){return this.databagPath+"/layer/layer_octree"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"borderLineUrl",value:function(e){return e=e||0,this.databagPath+"/outline/outline_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"mpkBorderLineUrl",value:function(e){return e=e||0,this.databagPath+"/outline/outline_mpk_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"terrainUrl",value:function(e,t,n){return this.databagPath+"/terrain/"+e+"/"+t+"/"+n+"/"+CLOUD.GlobalData.TerrainResourceFileName}},{key:"sceneStatisticsUrl",value:function(){return this.databagPath+"/sceneStatistics.json"}}]),e}();CLOUD.Loader.Url=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.defaultWireframeColor=CLOUD.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new THREE.MeshBasicMaterial(this.defaultWireframeColor),!1===CLOUD.GlobalData.TranslucentDepthDisabled&&(this.wireframeMaterial.transparent=!0),this.instanceWireframeMaterial=CLOUD.MaterialUtil.createInstanceMaterial(CLOUD.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),!1===CLOUD.GlobalData.TranslucentDepthDisabled&&(this.instanceWireframeMaterial.transparent=!0),this.wireframeGeometryMap={}}return _createClass(e,[{key:"destroy",value:function(){this.wireframeMaterial.dispose(),this.wireframeMaterial=null,this.instanceWireframeMaterial.destroy(),this.instanceWireframeMaterial=null,this.wireframeGeometryMap=null,this.defaultWireframeColor=null}},{key:"setWireframeColor",value:function(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}},{key:"getWireframeColor",value:function(){var e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}},{key:"restoreWireframeColor",value:function(){var e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}}]),e}();CLOUD.ModelView.WireframeManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.config=null,this.statistics={renderableCount:0,renderableTotal:CLOUD.GlobalData.maxObjectNumInPool,renderableTotalForPool:CLOUD.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,memoeryInfo:null},this.transformInfos={octreeTransformed:!0,boundingBox:null,position:new THREE.Vector3,rotation:new THREE.Quaternion,scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4},this.sceneStatistics=void 0}return _createClass(e,[{key:"destroy",value:function(){this.model=null,this.config=null,this.statistics=null,this.transformInfos=null,this.sceneStatistics=null}},{key:"load",value:function(e){var t=this,n=this.model,i=n.dataUrl,r=n.fileLoader;r.setResponseType(""),r.load(i.projectUrl(),function(i){var r;try{r=JSON.parse(i)}catch(e){return console.log("Config data exceptions!"),
void n.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_INVALID_SCENE})}return CLOUD.Utils.checkVersionMatch(CLOUD.Version,r.metadata.version)?0===r.metadata.scenes?(n.setEmptyScene(!0),void n.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_EMPTY_SCENE})):(0==r.metadata.gz?CLOUD.GlobalData.ZipResourcePostfix="":CLOUD.GlobalData.ZipResourcePostfix=".gz",n.setEmptyScene(!1),void t._loadDataForSceneStatistics(function(){t._parse(r),e&&e()})):void n.dispatchEvent({type:CLOUD.EVENTS.ON_VERSION_NO_MATCH,version:{engine:CLOUD.Version,data:r.metadata.version}})},void 0,function(){console.log("Config load error!"),n.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_INVALID_SCENE})})}},{key:"loadWithConfig",value:function(e,t){var n=this,i=this.model;return CLOUD.Utils.checkVersionMatch(CLOUD.Version,e.metadata.version)?0===e.metadata.scenes?(i.setEmptyScene(!0),void i.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_EMPTY_SCENE})):(0==e.metadata.gz?CLOUD.GlobalData.ZipResourcePostfix="":CLOUD.GlobalData.ZipResourcePostfix=".gz",i.setEmptyScene(!1),void n._loadDataForSceneStatistics(function(){n._parse(e),t&&t()})):void i.dispatchEvent({type:CLOUD.EVENTS.ON_VERSION_NO_MATCH,version:{engine:CLOUD.Version,data:e.metadata.version}})}},{key:"_loadDataForSceneStatistics",value:function(e){var t=this,n=this.model.fileLoader,i=this.model.dataUrl;n.setResponseType(""),n.load(i.sceneStatisticsUrl(),function(n){var i=JSON.parse(n);t.sceneStatistics=i.sceneStatistics,e&&e()},void 0,function(){e&&e()})}},{key:"_parse",value:function(e){this.config=e,this._setMetadata(e),this._toStatistics(e),this._setTransformInfos(e),this._chooseRendering(e),this._setHandler(e)}},{key:"_setMetadata",value:function(e){e.metadata.scenes=e.metadata.scenes?1:0,e.metadata.symbol=e.metadata.symbol?1:0,e.metadata.octree_o=e.metadata.octree_o?1:0,e.metadata.octree_i=e.metadata.octree_i?1:0,e.metadata.userdata=e.metadata.userdata?1:0,e.metadata.userId=1,e.metadata.camera=e.metadata.camera?1:0,e.metadata.material=e.metadata.material||0,e.metadata.material_json=e.metadata.material_json?1:0,e.metadata.lines=CLOUD.Compatibility.isLoadLinesEnabled(e.metadata.version)&&e.metadata.lines?1:0,e.metadata.outline_0=e.metadata.outline_0?1:0,e.metadata.outline_1=e.metadata.outline_1?1:0,e.metadata.outline_mpk=e.metadata.outline_mpk||0,e.metadata.mpk_shared_index=e.metadata.mpk_shared_index||e.metadata.outline_mpk}},{key:"_getDataProvider",value:function(e){if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.MERGED&&void 0!==e.bmpks&&e.bmpks>0)return console.log("data from: merged"),CLOUD.EnumDataProvider.MERGED;if(CLOUD.GlobalData.EnableLoadOnDemand&&e.layers){if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.LAYER_SCENE)return e.layers>1&&CLOUD.Compatibility.isLoadLayerSceneEnabled(e.version)?(console.log("data from: layer scene"),CLOUD.EnumDataProvider.LAYER_SCENE):(console.log("data from: layer"),CLOUD.EnumDataProvider.LAYER);if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.LAYER)return console.log("data from: layer"),CLOUD.EnumDataProvider.LAYER}if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.AUTO){if(CLOUD.GlobalData.EnableLoadOnDemand&&e.layers)return e.layers>1&&CLOUD.Compatibility.isLoadLayerSceneEnabled(e.version)?(console.log("data from: layer scene"),CLOUD.EnumDataProvider.LAYER_SCENE):(console.log("data from: layer"),CLOUD.EnumDataProvider.LAYER);if(CLOUD.GlobalData.BatchMergeEnabled&&CLOUD.Compatibility.isLoadBMpkEnabled(e.version)&&void 0!==e.bmpks&&e.bmpks>0)return console.log("data from: merged"),CLOUD.EnumDataProvider.MERGED}return console.log("data from: default"),CLOUD.EnumDataProvider.DEFAULT}},{key:"_chooseRendering",value:function(e){this.model.manager.chooseRendering(this.statistics.memoeryInfo)}},{key:"_setHandler",value:function(e){var t=!(!CLOUD.GlobalData.CanUseWireframeFromData||!e.metadata.outline_0&&!e.metadata.outline_1),n=this._getDataProvider(e.metadata),i=null,r=this.model;if(CLOUD.GlobalData.BatchMergeEnabled)switch(n){case CLOUD.EnumDataProvider.LAYER:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,i=new CLOUD.ModelView.LayerBatchedHandler(r,t);break;case CLOUD.EnumDataProvider.LAYER_SCENE:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,i=new CLOUD.ModelView.LayerSceneBatchedHandler(r,t);break;case CLOUD.EnumDataProvider.MERGED:CLOUD.GlobalData.EnableWorker?(i=new CLOUD.ModelView.WorkerDataBatchedHandler(r),console.log("strategy:","apply worker")):(i=new CLOUD.ModelView.DataBatchedHandler(r,t),console.log("strategy:","none"));break;default:CLOUD.GlobalData.EnableWorker?(i=new CLOUD.ModelView.WorkerBatchedHandler(r),console.log("strategy:","apply worker")):(i=new CLOUD.ModelView.BatchedHandler(r,t),console.log("strategy:","none"))}else if(CLOUD.GlobalData.OrganizeNodesByCameraView)switch(n){case CLOUD.EnumDataProvider.LAYER:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,i=new CLOUD.ModelView.LayerIncrementHandler(r);break;case CLOUD.EnumDataProvider.LAYER_SCENE:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,i=new CLOUD.ModelView.LayerSceneIncrementHandler(r);break;case CLOUD.EnumDataProvider.MERGED:i=new CLOUD.ModelView.DataBatchedHandler(r,t);break;default:i=new CLOUD.ModelView.IncrementHandler(r)}else switch(n){case CLOUD.EnumDataProvider.LAYER:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,i=new CLOUD.ModelView.FreeLayerIncrementHandler(r);break;case CLOUD.EnumDataProvider.LAYER_SCENE:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,i=new CLOUD.ModelView.FreeLayerSceneIncrementHandler(r);break;case CLOUD.EnumDataProvider.MERGED:i=new CLOUD.ModelView.DataBatchedHandler(r);break;default:e.metadata.mpk_batched?(console.log("use batched mpks"),i=new CLOUD.ModelView.IncrementBatchedHandler(r)):i=new CLOUD.ModelView.FreeIncrementHandler(r)}r._handler=i}},{key:"_setTransformInfos",value:function(e){if(0!==e.view.transform?this.transformInfos.octreeTransformed=!0:this.transformInfos.octreeTransformed=!1,this.transformInfos.boundingBox=CLOUD.Utils.box3FromArray(e.view.bbox),e.view.rotation){var t=new THREE.Euler;t.fromArray(e.view.rotation),this.transformInfos.rotation.setFromEuler(t,!1)}e.view.position&&this.transformInfos.position.fromArray(e.view.position),e.view.scale&&this.transformInfos.scale.fromArray(e.view.scale),this.transformInfos.transformMatrix.compose(this.transformInfos.position,this.transformInfos.rotation,this.transformInfos.scale)}},{key:"_toStatistics",value:function(e){e.count.texture_pixels&&e.count.texture_pixels>CLOUD.GlobalData.MaxTexturePixels&&(CLOUD.GlobalData.EnableTextureLoading=!1),void 0!==e.count&&(void 0!==e.count.mesh_face&&(this.statistics.numOfTriangles+=e.count.mesh_face),this.statistics.renderableTotal=0,this.statistics.renderableTotalForPool=0,void 0!==e.count.geom_box&&void 0!==e.count.geom_pipe&&void 0!==e.count.geom_tube&&void 0!==e.count.mesh?(this.statistics.renderableTotal+=e.count.geom_box,this.statistics.renderableTotal+=e.count.geom_pipe,this.statistics.renderableTotal+=e.count.geom_tube,this.statistics.renderableTotal+=e.count.mesh,this.statistics.renderableTotalForPool+=6*e.count.geom_box,this.statistics.renderableTotalForPool+=3*e.count.geom_pipe,this.statistics.renderableTotalForPool+=e.count.geom_tube,this.statistics.renderableTotalForPool+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom_box,this.statistics.numOfTriangles+=32*e.count.geom_pipe,this.statistics.numOfTriangles+=32*e.count.geom_tube):void 0!==e.count.geom&&void 0!==e.count.mesh&&(this.statistics.renderableTotal+=e.count.geom,this.statistics.renderableTotal+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom,this.statistics.numOfElements=this.statistics.renderableTotal,this.statistics.renderableTotalForPool=this.statistics.renderableTotal),void 0!==e.count.item&&(this.statistics.numOfElements=e.count.element||e.count.item)),this.sceneStatistics?this.statistics.memoeryInfo=this._computeMaximumMemoryUsage(e):this.statistics.memoeryInfo=this._computeApproximateMemoryUsage(e)}},{key:"_computeMaximumMemoryUsage",value:function(e){var t=this.sceneStatistics,n=t.vertexTotalCount,i=t.triangleTotalCount,r=0;r+=8*n,r+=3*i;var a=e.count.texture_pixels||0;return CLOUD.GlobalData.EnableTextureLoading&&(r+=4*a),r*=4,r*=1/1048576,r=Math.ceil(r),{maxMemorySize:r,triangleNumber:i}}},{key:"_computeApproximateMemoryUsage",value:function(e){var t=0,n=0,i=e.count.mesh_vertex||0,r=e.count.mesh_face||0,a=e.count.geom_box||0,o=e.count.geom_pipe||0,s=e.count.texture_pixels||0;n+=8*i,n+=3*r,n+=0,n+=0,t+=6*i,t+=3*r,t+=0,t+=0;var l=0;if(l+=r,a>0&&(l+=12*a),o>0&&(l+=124*o),l+=0,CLOUD.GlobalData.Instance){a>0&&(n+=192,n+=36,n+=24*a,t+=144,t+=36,t+=18*a),o>0&&(n+=1040,n+=372,n+=24*o,t+=780,t+=372,t+=18*o)}else a>0&&(n+=24*a*8,n+=12*a*3,t+=24*a*6,t+=12*a*3),o>0&&(n+=130*o*8,n+=124*o*3,t+=130*o*6,t+=124*o*3);return CLOUD.GlobalData.EnableTextureLoading&&(n+=4*s,t+=4*s),n*=4,t*=4,n*=1/1048576,t*=1/1048576,n=Math.ceil(n),t=Math.ceil(t),{maxMemorySize:n,minMemorySize:t,triangleNumber:l,instanceEnabled:CLOUD.GlobalData.Instance}}},{key:"getMemoryInfo",value:function(){return this.statistics.memoeryInfo}},{key:"getStatistics",value:function(){return this.statistics}},{key:"getConfig",value:function(){return this.config}},{key:"getTransforms",value:function(){return this.transformInfos}},{key:"setRenderableCount",value:function(e){this.statistics.renderableCount=e}}]),e}();CLOUD.ModelView.ConfigLoader=e}(),function(){var e=function(e){function t(e,n,i,r,a){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return o.filter=new CLOUD.FilterManager,o.filter.setObserverForSceneState(o.manager.getFilter().getObserverForSceneState()),o.debut=a,o.dataUrl=new CLOUD.Loader.Url(n),o.fileLoader=new THREE.FileLoader(new THREE.LoadingManager),o.configLoader=new CLOUD.ModelView.ConfigLoader(o),o.pool=e.getObjectPool(),o.firstOctreeTransform=!0,o.selectedMaterial=o.manager.sceneState.selectionMaterial,o.materialManager=new CLOUD.MaterialManager,o.wireframeManager=new CLOUD.ModelView.WireframeManager,o.cameraList=[],o.index=i,o.parseCfgFinish=r,o.progressPercentage={load:.4,collect:.5,merge:.1},o.progressFrequency=10,o._rootNodeGroupName=CLOUD.ObjectGroupType.MODEL+"|"+o.encodedDatabagId,o._rootNodeGroup=o.manager.scene.getOrCreateObjectGroup(o._rootNodeGroupName,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0}),o._handler=null,o.lightmap=void 0!=n.lightmapDatabagId,o.lightmapNum=0,o.enableLightmap=!1,o.lightmapIntensity=CLOUD.GlobalData.LightmapIntensity,o.minDistanceObjects={},o.prioritizedNodeCount=0,o.plugins=[],o}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.selectedMaterial=null,this.cameraList=null,this.occlusionCamera&&(this.occlusionCamera=null),this._handler&&(this._handler.destroy(),this._handler=null),this.wireframeManager.destroy(),this.wireframeManager=null,this.materialManager.disposeMaterials(this),this.materialManager.destroy(),this.materialManager=null,this.pool=null;for(var e=0,n=this.plugins.length;e<n;e++)this.plugins[e].destroy(),this.plugins[e]=null;this.plugins=null,this.configLoader.destroy(),this.configLoader=null,this._removeMeshNodeGroup(),this.removeAllFromOctantMap(),this.dataUrl=null,this.fileLoader=null,this.debut=null,this.parseCfgFinish=null,this.progressPercentage=null,this.minDistanceObjects=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"_getWireframeGroupName",value:function(){return CLOUD.ObjectGroupType.WIREFRAME+"|"+this.getEncodedDatabagId()}},{key:"load",value:function(e){var t=this;this.configLoader.loadWithConfig(this.config,function(){t.parseCfgFinish&&t.parseCfgFinish(),t.manager.updateScene(),t._getHandler().load(e)})}},{key:"setCrossOrigin",value:function(e){this.fileLoader.setCrossOrigin(e)}},{key:"prepare",value:function(e,t){var n=this._getHandler();n&&n.prepare(e,t)}},{key:"dispatchEvent",value:function(e){this.manager.dispatchEvent(e)}},{key:"setLoaded",value:function(e){this.loaded=e}},{key:"isLoaded",value:function(){return!!this._handler&&this.loaded}},{key:"isEmptyScene",value:function(){return this.emptyScene}},{key:"setEmptyScene",value:function(e){this.emptyScene=e}},{key:"isLayerData",value:function(){return!(!this._handler||"layer"!==this._handler.tag)}},{key:"isVisible",value:function(){return this.visible}},{key:"setVisible",value:function(e){this.visible=e,this._rootNodeGroup.visible!==e&&(this._rootNodeGroup.visible=e,this._rootNodeGroup.pickableType=e?CLOUD.PICKABLETYPE.Geometry:CLOUD.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0))}},{key:"calculateCameraModelRelation",value:function(e){this.containsCamera=this.getModelDescriptor().isOctreeOuter(e)}},{key:"addCamera",value:function(e){this.cameraList.push(e)}},{key:"getCameraNameList",value:function(){for(var e=[],t=this.cameraList.length-1;t>=0;t--)e.push(this.cameraList[t].name);return e}},{key:"getCamera",value:function(e){for(var t=this.cameraList.length-1;t>=0;t--)if(this.cameraList[t].name===e)return this.cameraList[t];return null}},{key:"updateOctreeNode",value:function(e){if(e||this.firstOctreeTransform){this.firstOctreeTransform&&(this.firstOctreeTransform=!1);var t=this.manager.scene.getMatrixGlobal();this.getModelDescriptor().updateOctreeNode(t)}}},{key:"isDataReady",value:function(){var e=this._handler;return!!e&&e.isDataReady()}},{key:"updateMeshNodes",value:function(){var e=this._getHandler();e&&e.updateNodes()}},{key:"_getHandler",value:function(){return this._handler}},{key:"getMeshesByUserIds",value:function(e,t){if(e&&t){this.minDistanceObjects[e]=[],this.minDistanceObjects[t]=[];var n=this._getHandler();n&&n.getMeshesByUserIds(e,t);for(var i=0,r=this.plugins.length;i<r;i++)this.plugins[i].getMeshesByUserIds([e,t])}}},{key:"applyFilter",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyFilter();var n=this._getHandler();n&&n.applyFilter()}},{key:"applySelection",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applySelection();var n=this._getHandler();if(n)return void n.applySelection()}},{key:"clearSelection",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearSelection();var n=this._getHandler();if(n)return void n.clearSelection()}},{key:"applyHover",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyHover();var n=this._getHandler();n&&n.applyHover()}},{key:"clearHover",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearHover();var n=this._getHandler();n&&n.clearHover()}},{key:"applyBlink",value:function(){var e=this._getHandler();e&&e.applyBlink()}},{key:"clearBlink",value:function(){var e=this._getHandler();e&&e.clearBlink()}},{key:"applyReplacement",value:function(){var e=this._getHandler();e&&e.applyReplacement()}},{key:"_removeMeshNodeGroup",value:function(){this._removeNodeGroup(CLOUD.ObjectGroupType.GEOMETRY),this._removeNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY),this._removeNodeGroup(CLOUD.ObjectGroupType.WIREFRAME),this._removeNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY),this._removeSceneGroup(),this._rootNodeGroup=null}},{key:"_getNodeGroup",value:function(e,t){for(var n=this._rootNodeGroup.children,i=0,r=n.length;i<r;i++)if(n[i].name==e)return n[i];var a=new CLOUD.ObjectGroup(e,t);return this._rootNodeGroup.add(a),a.globalSpace&&(a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0)),a}},{key:"_removeNodeGroup",value:function(e){this._rootNodeGroup.removeByName(e)}},{key:"_hasNodeGroup",value:function(e){return this._rootNodeGroup.hasChild(e)}},{key:"_removeSceneGroup",value:function(){this.manager.scene.removeObjectGroupByName(this._rootNodeGroupName),this.manager.scene.removeObjectGroupByName(this._getWireframeGroupName())}},{key:"removeAllFromOctantMap",value:function(){this.manager.removeAllFromOctantMap(this.getEncodedDatabagId())}},{key:"clearMeshFromOctantMap",value:function(){this.manager.clearMeshFromOctantMap(this.getEncodedDatabagId())}},{key:"getMaterialManager",value:function(){return this.materialManager}},{key:"clearWireframeElementCount",value:function(){this.wireframeElementCount=void 0}},{key:"getWireframeElementCount",value:function(){if(void 0!==this.wireframeElementCount)return this.wireframeElementCount;var e=this.getModelDescriptor().getAllNodeInfos(),t=this.getFilter(),n=0;for(var i in e){var r=e[i];t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(r[0])||(n+=r.length)}return this.wireframeElementCount=n,n}},{key:"isActivateWireframe",value:function(){return this.manager.isDrawingBoardlineEnabled()}},{key:"isOnlyWireframe",value:function(){return this.manager.isOnlyWireframe()}},{key:"getLoadedUserIdsObject",value:function(){return this._handler&&this._handler.getLoadedUserIdsObject?this._handler.getLoadedUserIdsObject():null}},{key:"clearNodeGroup",value:function(){var e=this._getNodeGroup(CLOUD.ObjectGroupType.GEOMETRY,{globalSpace:!0});e.clear(),e=this._getNodeGroup(CLOUD.ObjectGroupType.WIREFRAME,{globalSpace:!0}),e.clear(),e=this._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0}),e.clear(),e=this._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0}),e.clear(),(e=this.manager.scene.getObjectGroup(this._getWireframeGroupName()))&&e.clear()}},{key:"getWireframeMaterial",value:function(){return this.wireframeManager.wireframeMaterial}},{key:"getInstanceWireframeMaterial",value:function(){return this.wireframeManager.instanceWireframeMaterial}},{key:"getMaterialByMaterialId",value:function(e){return this.materialManager.materials[e]}},{key:"adjustProgressPercentage",value:function(e,t,n){this.progressPercentage.load=e,this.progressPercentage.collect=t,this.progressPercentage.merge=n}},{key:"setReplacedUserIdMap",value:function(e){CLOUD.Utils.isOwnEmptyObject(e)?this.replacedUserIdMap=null:this.replacedUserIdMap=e}},{key:"hasReplacedUserId",value:function(){return!CLOUD.Utils.isEmptyObject(this.replacedUserIdMap)}},{key:"isReplacedUserId",value:function(e){return this.replacedUserIdMap&&this.replacedUserIdMap[e]}},{key:"registerPlugin",value:function(e){this.plugins.push(e)}},{key:"disposeBufferAfterVbo",value:function(){var e=this._getHandler();e&&e.disposeBufferAfterVbo()}},{key:"isHiddenUserId",value:function(e){var t=this._getHandler();return!!t&&t.isHiddenNode(e)}},{key:"isHiddenSourceObjectUserId",value:function(e){return this.manager.isHiddenSourceObjectUserId(e)}},{key:"hasHiddenSourceObjectUserId",value:function(){return this.manager.hasHiddenSourceObjectUserId()}},{key:"getModelDescriptor",value:function(){return this._handler.loader.getDescriptor()}},{key:"getLoader",value:function(){return this._handler.loader}},{key:"getConfig",value:function(){return this.configLoader.getConfig()}},{key:"getTransforms",value:function(){return this.configLoader.getTransforms()}},{key:"getStatistics",value:function(){return this.configLoader.getStatistics()}},{key:"setRenderableCount",value:function(e){this.configLoader.setRenderableCount(e),this._handler&&this._handler.clearPriorityNodesSet&&this._handler.clearPriorityNodesSet(!0)}},{key:"getRenderableCount",value:function(){return this.configLoader.getStatistics().renderableCount}},{key:"getBoundingBoxWorld",value:function(){return this.configLoader.getTransforms().boundingBox}},{key:"explode",value:function(){var e=this._getHandler();e&&e.explode()}},{key:"calculateClippingIds",value:function(){var e=this._getHandler();e&&e.calculateClippingIds()}},{key:"getOctreeRoots",value:function(e){this.getModelDescriptor().getOctreeRoots(e)}},{key:"isUserIdExist",value:function(e){return this.getModelDescriptor().isUserIdExist(e)}},{key:"getNodeInfosByUserId",value:function(e){return this.getModelDescriptor().getNodeInfosByUserId(e)}},{key:"getAllNodeInfos",value:function(){return this.getModelDescriptor().getAllNodeInfos()}},{key:"updateMaterialsValue",value:function(e,t){this.materialManager.updateMaterialsValue(this,e,t)}},{key:"updateMaterials",value:function(){this.materialManager.updateMaterials(this)}},{key:"switchNewStyleMaterial",value:function(e){this.materialManager.switchNewStyleMaterial(this,e)}},{key:"changeAllMaterials",value:function(e){this.materialManager.changeAllMaterials(this,e)}},{key:"adjustVisibility",value:function(e){this._getHandler().adjustVisibility(e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){this._getHandler().changeVisibilityOfSelectedObjects(e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){this._getHandler().changeVisibilityOfNonSelectedObjects(e)}},{key:"adjustInstanceVisibility",value:function(e){this._getHandler().adjustInstanceVisibility(e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){this._getHandler().changeInstanceVisibilityOfSelectedObjects(e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){this._getHandler().changeInstanceVisibilityOfNonSelectedObjects(e)}},{key:"restoreVisibilityOfObjects",value:function(){this._getHandler().restoreVisibilityOfObjects()}},{key:"isUseable",value:function(){return this.isLoaded()&&this.isVisible()}},{key:"getFilter",value:function(){return this.filter}},{key:"getPickingMeshes",value:function(e,t,n,i){this._dealNonInstancedNodesForPicking(e,t,n,i),this._dealInstancedNodesForPicking(e,t,n,i),this._dealPluginNodesForPicking(e,t,n,i)}},{key:"_dealNonInstancedNodesForPicking",value:function(e,t,n,i){if(this._handler){var r=this._handler.defaultManager;if(r.hasNodeInfo(this)){var a=r.getMeshManager().getPickingNodeGenerator(),o=a.updatePickingMeshes(e.selectedMaterial,n,i);o&&t.meshes.push(o);var s=r.getWireFrameManager().getPickingNodeGenerator(),l=s.updatePickingMeshes(e.wireframeMaterial,n,i);l&&t.meshes.push(l)}}}},{key:"_dealInstancedNodesForPicking",value:function(e,t,n,i){if(this._handler){var r=this._handler.instancedManager;if(r.hasNodeInfo(this)){var a=r.getMeshManager().getPickingNodeGenerator(),o=a.updatePickingMeshes(e.instancedSelectedMaterial,n,i);o&&t.meshes.push(o);var s=r.getWireFrameManager().getPickingNodeGenerator(),l=s.updatePickingMeshes(e.instancedWireFrameMaterial,n,i);l&&t.meshes.push(l)}}}},{key:"_dealPluginNodesForPicking",value:function(e,t,n,i){if(this._handler)for(var r=this.plugins,a=0,o=r.length;a<o;a++){var s=r[a].getPickingNodeGenerator(),l=s.updatePickingMeshes(e.selectedMaterial,n,i);l&&t.meshes.push(l)}}},{key:"getBlinkMaterials",value:function(){var e=this._getHandler();return e?e.getBlinkMaterials():[]}},{key:"hasTransforms",value:function(){return!0}},{key:"enableColorWithoutLight",value:function(e){this.materialManager.enableColorWithoutLight(e)}}]),t}(CLOUD.BaseModel);e.EnumFilterState={CLIPPING:-2,HIDDEN:-1,NONE:0,SELECTED:1,BLINK:2,HOVER:3,TRANSPARENT:4,OVERRIDED:5},CLOUD.Model=e}(),CLOUD.Loader.IdReader=function(e){var t=new Uint32Array(e,0,2);this.size=t[0],this.count=t[1],this.cache={},this.idBuffer=e.slice(8),t=null},CLOUD.Loader.IdReader.prototype={constructor:CLOUD.Loader.IdReader,getSize:function(){return this.size},getCount:function(){return this.count},getString:function(e){if(void 0!==this.cache[e])return this.cache[e];if(e>=0&&e<this.count){var t=new Uint8Array(this.idBuffer,this.size*e,this.size),n=String.fromCharCode.apply(null,t),i=n.indexOf("\0");return this.cache[e]=-1!==i?n.substring(0,i):n,this.cache[e]}},getIndex:function(e){if(void 0==e)return-1;for(var t=0,n=this.count-1,i=e.length;t<=n;){var r=Math.floor((t+n)/2),a=new Uint8Array(this.idBuffer,this.size*r,i),o=String.fromCharCode.apply(null,a),s=o.indexOf("\0"),l=0;if(0==(l=-1!==s?e.localeCompare(o.substring(0,s)):e.localeCompare(o)))return r;l<0?n=r-1:l>0&&(t=r+1)}return-1}},CLOUD.Loader.UserDataReader=function(e){this.userData=JSON.parse(e),this.count=0;for(var t in this.userData)this.userData.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.userData},this.getUserData=function(e){if(e>=0&&e<this.count)return this.userData[e+""]}},CLOUD.Loader.OctNode=function(e,t){var n=new Uint32Array(e,t,5);this.cell_id=n[0],this.child_s=n[3],this.child_e=n[4];var i=new Float32Array(e,t+20,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5]))},CLOUD.Loader.OctreeReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.data=new Array(this.count);for(var n=0;n<this.count;++n)this.data[n]=new CLOUD.Loader.OctNode(e,4*(1+11*n))},CLOUD.Loader.OctreeReader.prototype={constructor:CLOUD.Loader.OctreeReader,getCount:function(){return this.count},getNode:function(e){if(e>=0&&e<this.count)return this.data[e]}},CLOUD.Loader.Material=function(e,t){var n=new Uint32Array(e,t,8);this.id=n[0],this.type=n[1],this.metal=n[2],this.color=n[3],this.emissive=n[4],this.specular=n[5],this.side=n[6],this.texture_n=n[7],this.texture_id=new Uint32Array(e,t+32,8);var i=new Float32Array(e,t+64,3);this.shininess=i[0],this.opacity=i[1],this.reflectivity=i[2],n=null,i=null},CLOUD.Loader.Texture=function(e,t){var n=new Uint32Array(e,t,4);this.id=n[0],this.type=n[1],this.repeat_u=n[2],this.repeat_v=n[3];var i=new Float32Array(e,t+16,5);this.angle=i[0],this.offset_u=i[1],this.offset_v=i[2],this.scale_u=i[3],this.scale_v=i[4];var r=new Uint8Array(e,t+36,8),a=String.fromCharCode.apply(null,r);this.file_name_ext=a.substring(0,a.indexOf("\0")),n=null,i=null,r=null},CLOUD.Loader.MaterialReader=function(e){var t=new Uint32Array(e,0,4);this.materialCount=t[0],this.materialOffset=t[1],this.textureCount=t[2],this.textureOffset=t[3],this.materialSize=76,this.textureSize=44,this.materialBuffer=e.slice(this.materialOffset,this.materialOffset+this.materialCount*this.materialSize),this.textureBuffer=e.slice(this.textureOffset,this.textureOffset+this.textureCount*this.textureSize),this.material_id=-1,this.texture_id=-1;var n=new ArrayBuffer(this.materialSize);this.material_cur=new CLOUD.Loader.Material(n,0),this.texture_cur=new CLOUD.Loader.Texture(n,0),t=null,n=null},CLOUD.Loader.MaterialReader.prototype={constructor:CLOUD.Loader.MaterialReader,getMaterial:function(e){if(e>=0&&e<this.materialCount)return new CLOUD.Loader.Material(this.materialBuffer,e*this.materialSize)},getTexture:function(e){if(e>=0&&e<this.textureCount)return new CLOUD.Loader.Texture(this.textureBuffer,e*this.textureSize)},getMaterialInfo:function(e){if(e==this.material_id)return this.material_cur;if(e>=0&&e<this.materialCount){var t=new Uint32Array(this.materialBuffer,e*this.materialSize,8);this.material_cur.id=t[0],this.material_cur.type=t[1],this.material_cur.metal=t[2],this.material_cur.color=t[3],this.material_cur.emissive=t[4],this.material_cur.specular=t[5],this.material_cur.side=t[6],this.material_cur.texture_n=t[7],this.material_cur.texture_id=new Uint32Array(this.materialBuffer,e*this.materialSize+32,8);var n=new Float32Array(this.materialBuffer,e*this.materialSize+64,3);return this.material_cur.shininess=n[0],this.material_cur.opacity=n[1],this.material_cur.reflectivity=n[2],t=null,n=null,this.material_id=e,this.material_cur}},getTextureInfo:function(e){if(e==this.texture_id)return this.texture_cur;if(e>=0&&e<this.textureCount){var t=new Uint32Array(this.textureBuffer,e*this.textureSize,4);this.texture_cur.id=t[0],this.texture_cur.type=t[1],this.texture_cur.repeat_u=t[2],this.texture_cur.repeat_v=t[3];var n=new Float32Array(this.textureBuffer,e*this.textureSize+16,5);this.texture_cur.angle=n[0],this.texture_cur.offset_u=n[1],this.texture_cur.offset_v=n[2],this.texture_cur.scale_u=n[3],this.texture_cur.scale_v=n[4];var i=new Uint8Array(this.textureBuffer,e*this.textureSize+36,8),r=String.fromCharCode.apply(null,i);return this.texture_cur.file_name_ext=r.substring(0,r.indexOf("\0")),t=null,n=null,i=null,this.texture_id=e,this.texture_cur}}},CLOUD.Loader.MaterialReaderJson=function(e){if(this.count=0,this.Data=JSON.parse(e),this.Data.hasOwnProperty("materials")&&(this.materials=this.Data.materials),this.Data.hasOwnProperty("metadata")&&(this.metadata=this.Data.metadata,this.metadata.hasOwnProperty("count")&&(this.count=this.metadata.count)),0===this.count)for(var t in this.materials)this.materials.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getMaterial=function(e){if(e>=0&&e<this.count)return this.materials[e+""]}},CLOUD.Loader.LayerKeyReader=function(e){this.LayerKey=JSON.parse(e),this.count=0;for(var t in this.LayerKey)this.LayerKey.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.LayerKey},this.getLayerKey=function(e){if(e>=0&&e<this.count)return this.LayerKey[e+""]}},CLOUD.Loader.LayerHeader=function(e){var t=new Uint32Array(e,0,4);this.layerCount=t[0],this.mpkBufferSize=t[1],this.layerOffset=t[2],this.mpkOffset=t[3];var n=new Float32Array(e,24,4);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),t=null,n=null},CLOUD.Loader.LayerData=function(e,t){var n=new Int32Array(e,t,3);this.layer_id=n[0],this.layer_mpk_index=n[1],this.layer_mpk_count=n[2];var i=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),n=null,i=null},CLOUD.Loader.LayerReader=function(e){this.header=new CLOUD.Loader.LayerHeader(e),this.DataSize=36,this.dataBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerCount*this.DataSize),this.mpkBuffer=e.slice(this.header.mpkOffset,this.header.mpkOffset+this.header.mpkBufferSize)},CLOUD.Loader.LayerReader.prototype={constructor:CLOUD.Loader.LayerReader,getLayerData:function(e){if(e>=0&&e<this.header.layerCount)return new CLOUD.Loader.LayerData(this.dataBuffer,e*this.DataSize)},getMpkList:function(e){var t=this.getLayerData(e);if(void 0!=t)return new Uint32Array(this.mpkBuffer,4*t.layer_mpk_index,t.layer_mpk_count)},getLayerCount:function(){return this.header.layerCount}},CLOUD.Loader.SymbolHeader=function(e){var t=new Uint32Array(e,0,9);this.blockId=t[0],this.symbolCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.symbolOffset=t[5],this.itemOffset=t[6],this.matrixOffset=t[7],this.geomOffset=t[8];var n=new Float32Array(e,36,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),t=null,n=null},CLOUD.Loader.Symbol=function(e,t){var n=new Int32Array(e,t,3);this.symbolId=n[0],this.itemIndex=n[1],this.itemCount=n[2];var i=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),n=null,i=null},CLOUD.Loader.SymbolReader=function(e){this.header=new CLOUD.Loader.SymbolHeader(e),this.symbolSize=36,this.itemSize=52,this.matrixSize=64,this.geomSize=32,this.maxSize=256,this.boxUvSize=36,this.pipeUvSize=18,this.symbolBuffer=e.slice(this.header.symbolOffset,this.header.symbolOffset+this.header.symbolCount*this.symbolSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.matr_cur_id=-1,this.pt_symb_min=new THREE.Vector3(0,0,0),this.pt_symb_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.symb_cur=new CLOUD.Loader.Symbol(t,0),this.item_cur=new CLOUD.Loader.Item(t,0),this.matr_cur=new CLOUD.Loader.Matrix(t,0),this.pipe_cur=new CLOUD.Loader.GeomPipe(t,0),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},CLOUD.Loader.SymbolReader.prototype={constructor:CLOUD.Loader.SymbolReader,getSymbol:function(e){
if(e>=0&&e<this.header.symbolCount)return new CLOUD.Loader.Symbol(this.symbolBuffer,e*this.symbolSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new CLOUD.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new CLOUD.Loader.Matrix(this.matrixBuffer,e*this.matrixSize)},getGeomPipe:function(e){if(e>=0&&index<this.header.geomBuffSize)return new CLOUD.Loader.GeomPipe(this.geomBuffer,e)},getSymbolInfo:function(e){if(e>=0&&e<this.header.symbolCount){var t=new Int32Array(this.symbolBuffer,e*this.symbolSize,3);this.symb_cur.symbolId=t[0],this.symb_cur.itemIndex=t[1],this.symb_cur.itemCount=t[2];var n=new Float32Array(this.symbolBuffer,e*this.symbolSize+12,6);return this.pt_symb_min.set(n[0],n[1],n[2]),this.pt_symb_max.set(n[3],n[4],n[5]),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.symb_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var n=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(n[0],n[1],n[2]),this.pt_item_max.set(n[3],n[4],n[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){var t=new Float32Array(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},CLOUD.Loader.MPKHeader=function(e){var t=new Uint32Array(e,0,6);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.bufferSize=t[4],this.bufferOffset=t[5],t=null},CLOUD.Loader.MeshData=function(e,t){var n=new Uint32Array(e,t,5);this.mesh_id=n[0],this.ptCount=n[1],this.idxCount=n[2],this.dataOffset=n[3],this.vertexFormat=n[4];var i=new Float32Array(e,t+20,4);this.baseScale=i[0],this.baseX=i[1],this.baseY=i[2],this.baseZ=i[3],n=null,i=null},CLOUD.Loader.MPKReader=function(e){this.header=new CLOUD.Loader.MPKHeader(e),this.meshSize=36,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.geomBuffer=e.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize),this.mesh_cur_id=-1;var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new CLOUD.Loader.MeshData(t,0)},CLOUD.Loader.MPKReader.prototype={constructor:CLOUD.Loader.MPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new CLOUD.Loader.MeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,5);this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.dataOffset=t[3],this.mesh_cur.vertexFormat=t[4];var n=new Float32Array(this.meshBuffer,e*this.meshSize+20,4);return this.mesh_cur.baseScale=n[0],this.mesh_cur.baseX=n[1],this.mesh_cur.baseY=n[2],this.mesh_cur.baseZ=n[3],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return 0==t.baseScale?new Float32Array(this.geomBuffer,t.dataOffset,3*t.ptCount):new Uint16Array(this.geomBuffer,t.dataOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var n=t.dataOffset;return 0==t.baseScale?n+=3*t.ptCount*4:(n+=3*t.ptCount*2,t.ptCount%2==1&&(n+=2)),CLOUD.Compatibility.use32MpkData?new Uint32Array(this.geomBuffer,n,t.idxCount):t.ptCount>65535?new Uint32Array(this.geomBuffer,n,t.idxCount):new Uint16Array(this.geomBuffer,n,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var n=t.dataOffset;return 0==t.baseScale?n+=3*t.ptCount*4:(n+=3*t.ptCount*2,t.ptCount%2==1&&(n+=2)),CLOUD.Compatibility.use32MpkData?n+=4*t.idxCount:t.ptCount>65535?n+=4*t.idxCount:(n+=2*t.idxCount,t.idxCount%2==1&&(n+=2)),new Float32Array(this.geomBuffer,n,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vertexFormat))return;var n=t.dataOffset;return 0==t.baseScale?n+=3*t.ptCount*4:(n+=3*t.ptCount*2,t.ptCount%2==1&&(n+=2)),CLOUD.Compatibility.use32MpkData?n+=4*t.idxCount:t.ptCount>65535?n+=4*t.idxCount:(n+=2*t.idxCount,t.idxCount%2==1&&(n+=2)),2==(2&this.header.vtFormat)&&(n+=3*t.ptCount*4),new Float32Array(this.geomBuffer,n,2*t.ptCount)}},getOffsetIndexInfo:function(e,t){if(!(e<0||e>=this.header.meshCount)){var n=this.getMeshInfo(e),i=void 0!==t?!t:4==(4&n.vFormat);return{meshId:n.mesh_id,positionStart:n.vOffset/4,positionCount:3*n.ptCount,indexStart:n.iOffset/4,indexCount:n.idxCount,uvStart:i?n.tOffset/4:0,uvCount:i?2*n.ptCount:0}}}},CLOUD.Loader.BMPKHeader=function(e){var t=new Uint32Array(e,0,12);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.ptBufferSize=t[4],this.ptBufferOffset=t[5],this.idxBufferSize=t[6],this.idxBufferOffset=t[7],this.norBufferSize=t[8],this.norBufferOffset=t[9],this.uvBufferSize=t[10],this.uvBufferOffset=t[11],t=null},CLOUD.Loader.BMeshData=function(e,t){var n=new Uint32Array(e,t,8);this.mesh_id=n[0],this.ptCount=n[1],this.idxCount=n[2],this.vFormat=n[3],this.vOffset=n[4],this.iOffset=n[5],this.nOffset=n[6],this.tOffset=n[7],n=null},CLOUD.Loader.BMPKReader=function(e){this.header=new CLOUD.Loader.BMPKHeader(e),this.meshSize=32,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.vBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.iBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),this.nBuffer=e.slice(this.header.norBufferOffset,this.header.norBufferOffset+this.header.norBufferSize),this.tBuffer=e.slice(this.header.uvBufferOffset,this.header.uvBufferOffset+this.header.uvBufferSize),this.mesh_cur_id=-1;var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new CLOUD.Loader.BMeshData(t,0)},CLOUD.Loader.BMPKReader.prototype={constructor:CLOUD.Loader.BMPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new CLOUD.Loader.BMeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,8);return this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.vFormat=t[3],this.mesh_cur.vOffset=t[4],this.mesh_cur.iOffset=t[5],this.mesh_cur.nOffset=t[6],this.mesh_cur.tOffset=t[7],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.vBuffer,t.vOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Uint32Array(this.iBuffer,t.iOffset,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.nBuffer,t.nOffset,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vFormat))return;return new Float32Array(this.tBuffer,t.tOffset,2*t.ptCount)}},getOffsetIndexInfo:function(e,t){if(!(e<0||e>=this.header.meshCount)){var n=this.getMeshInfo(e),i=void 0!==t?!t:4==(4&n.vFormat);return{meshId:n.mesh_id,positionStart:n.vOffset/4,positionCount:3*n.ptCount,indexStart:n.iOffset/4,indexCount:n.idxCount,uvStart:i?n.tOffset/4:0,uvCount:i?2*n.ptCount:0}}}},CLOUD.Loader.BMeshIdReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.cache={};for(var n=new Uint32Array(e,4,this.count),i=0;i<this.count;i+=2){var r=n[i];this.cache[r]=n[i+1]}t=null,n=null},CLOUD.Loader.BMeshIdReader.prototype={constructor:CLOUD.Loader.BMeshIdReader,getCount:function(){return this.count},getBMeshId:function(e){return this.cache[e]}},CLOUD.Loader.LineHeader=function(e){var t=new Uint32Array(e,0,7);this.blockId=t[0],this.lineCount=t[1],this.lineOffset=t[2],this.ptBufferSize=t[3],this.ptBufferOffset=t[4],this.idxBufferSize=t[5],this.idxBufferOffset=t[6],t=null},CLOUD.Loader.LineData=function(e,t){var n=new Uint32Array(e,t,6);this.line_id=n[0],this.lineType=n[1],this.ptCount=n[2],this.ptOffset=n[3],this.idxCount=n[4],this.idxOffset=n[5],n=null},CLOUD.Loader.LineReader=function(e){this.header=new CLOUD.Loader.LineHeader(e),this.lineSize=24,this.ptSize=12,this.lineBuffer=e.slice(this.header.lineOffset,this.header.lineOffset+this.header.lineCount*this.lineSize),this.ptBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.idxBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),this.line_cur_id=-1;var t=new ArrayBuffer(this.lineSize);this.line_cur=new CLOUD.Loader.LineData(t,0)},CLOUD.Loader.LineReader.prototype={constructor:CLOUD.Loader.LineReader,getLineData:function(e){if(e>=0&&e<this.header.lineCount)return new CLOUD.Loader.LineData(this.lineBuffer,e*this.lineSize)},getLineInfo:function(e){if(e==this.line_cur_id)return this.line_cur;if(e>=0&&e<this.header.lineCount){var t=new Uint32Array(this.lineBuffer,e*this.lineSize,6);return this.line_cur.line_id=t[0],this.line_cur.lineType=t[1],this.line_cur.ptCount=t[2],this.line_cur.ptOffset=t[3],this.line_cur.idxCount=t[4],this.line_cur.idxOffset=t[5],this.line_cur_id=e,this.line_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;return new Float32Array(this.ptBuffer,t.ptOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;var n=new Uint32Array(this.idxBuffer,t.idxOffset,t.idxCount),i=t.ptOffset/this.ptSize;return n.forEach(function(e,t,n){n[t]-=i}),n}}},CLOUD.Loader.CameraReader=function(e){this.cameras=JSON.parse(e)},CLOUD.Loader.CameraReader.prototype.parse=function(e,t){function n(e,n){n.uuid=e.uuid,void 0!==e.name&&(n.name=e.name);var i=new THREE.Matrix4;if(void 0!==e.matrix)i.fromArray(e.matrix);else{var r=new THREE.Vector3,a=new THREE.Quaternion,o=new THREE.Vector3;if(void 0!==e.position&&r.fromArray(e.position),void 0!==e.rotation){var s=new THREE.Vector3;s.fromArray(e.rotation);var l=new THREE.Euler(s[0]*Math.PI/180,s[1]*Math.PI/180,s[2]*Math.PI/180,"XYZ");a.setFromEuler(l)}void 0!==e.quaternion&&a.fromArray(e.quaternion,0),void 0!==e.scale&&n.scale.fromArray(e.scale),i.compose(r,a,o)}i.multiply(t),i.decompose(n.position,n.quaternion,n.scale)}var i,r,a=this.cameras;if(a.Orthographic){var o=a.Orthographic;for(var s in o)r=o[s],i=new CLOUD.Camera(CLOUD.CAMERATYPE.ORTHOGRAPHIC,r),n(r,i),e.addCamera(i)}if(a.Perspective){var l=a.Perspective;for(var s in l)r=l[s],i=new CLOUD.Camera(CLOUD.CAMERATYPE.PERSPECTIVE,r),void 0!==r.focus&&(i.focus=r.focus),void 0!==r.zoom&&(i.zoom=r.zoom),void 0!==r.filmGauge&&(i.filmGauge=r.filmGauge),void 0!==r.filmOffset&&(i.filmOffset=r.filmOffset),void 0!==r.view&&(i.view=Object.assign({},r.view)),n(r,i),e.addCamera(i)}},CLOUD.Loader.SceneHeader=function(e){var t=new Uint32Array(e,0,11);this.blockId=t[0],this.cellCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.layerBuffSize=t[5],this.cellOffset=t[6],this.itemOffset=t[7],this.matrixOffset=t[8],this.geomOffset=t[9],this.layerOffset=t[10];var n=new Float32Array(e,44,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),t=null,n=null},CLOUD.Loader.Cell=function(e,t){var n=new Int32Array(e,t,5);this.cellId=n[0],this.depth=n[1],this.itemIndex=n[2],this.itemCount=n[3],this.layerType=n[4],this.layerSize=new Int32Array(e,t+20,8),this.layerOffset=new Int32Array(e,t+52,8);var i=new Float32Array(e,t+84,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),n=null,i=null},CLOUD.Loader.Item=function(e,t){var n=new Int32Array(e,t,7);this.ItemId=n[0],this.originalId=n[1],this.materialId=n[2],this.userDataId=n[3],this.matrixId=n[4],this.type=n[5],this.toData=n[6];var i=new Float32Array(e,t+28,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),n=null,i=null},CLOUD.Loader.Matrix=function(e,t){var n=new Float32Array(e,t,16);this.matrix=(new THREE.Matrix4).fromArray(n),n=null},CLOUD.Loader.GeomPipe=function(e,t){var n=new Float32Array(e,t,8);this.startPt=new THREE.Vector3(n[0],n[1],n[2]),this.endPt=new THREE.Vector3(n[3],n[4],n[5]),this.radius=n[6],this.thickness=n[7],n=null},CLOUD.Loader.SceneReader=function(e){this.header=new CLOUD.Loader.SceneHeader(e),this.cellSize=108,this.itemSize=52,this.matrixSize=64,this.maxSize=1024,this.boxUvSize=36,this.pipeUvSize=18,this.cellBuffer=e.slice(this.header.cellOffset,this.header.cellOffset+this.header.cellCount*this.cellSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.layerBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerBuffSize),this.matr_cur_id=-1,this.pt_cell_min=new THREE.Vector3(0,0,0),this.pt_cell_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.cell_cur=new CLOUD.Loader.Cell(t,0),this.item_cur=new CLOUD.Loader.Item(t,0),this.matr_cur=new CLOUD.Loader.Matrix(t,0),this.pipe_cur=new CLOUD.Loader.GeomPipe(t,0),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},CLOUD.Loader.SceneReader.prototype={constructor:CLOUD.Loader.SceneReader,getCellMpks:function(e){if(e>=0&&e<this.header.cellCount){for(var t=[],n=this.getCellInfo(e),i=n.itemIndex;i<n.itemCount;++i){var r=this.getItemInfo(i);if(1===r.type){var a=this.getMpkID(r.toData);t.push(a)}}for(var o={},s=[],l=0;l<t.length;++l)o[t[l]]||(o[t[l]]=!0,s.push(t[l]));return s}},getCell:function(e){if(e>=0&&e<this.header.cellCount)return new CLOUD.Loader.Cell(this.cellBuffer,e*this.cellSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new CLOUD.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new CLOUD.Loader.Matrix(this.matrixBuffer,e*this.matrixSize)},getGeomPipe:function(e){if(e>=0&&e<this.header.geomBuffSize)return new CLOUD.Loader.GeomPipe(this.geomBuffer,e)},getCellInfo:function(e){if(e>=0&&e<this.header.cellCount){var t=new Int32Array(this.cellBuffer,e*this.cellSize,5);this.cell_cur.cellId=t[0],this.cell_cur.depth=t[1],this.cell_cur.itemIndex=t[2],this.cell_cur.itemCount=t[3],this.cell_cur.layerType=t[4],this.cell_cur.layerSize=new Int32Array(this.cellBuffer,e*this.cellSize+20,8),this.cell_cur.layerOffset=new Int32Array(this.cellBuffer,e*this.cellSize+52,8);var n=new Float32Array(this.cellBuffer,e*this.cellSize+84,6);return this.pt_cell_min.set(n[0],n[1],n[2]),this.pt_cell_max.set(n[3],n[4],n[5]),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.cell_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var n=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(n[0],n[1],n[2]),this.pt_item_max.set(n[3],n[4],n[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){var t=new Float32Array(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getLayerInfo:function(e,t){if(e>=0&&e+t<=this.header.layerBuffSize){new Uint32Array(this.layerBuffer,e,t);return this.data}},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},CLOUD.Loader.LayerIndex=function(e,t){var n=new Uint32Array(e,t,2);this.layer_id=n[0],this.item_index=n[1]},CLOUD.Loader.LayerIndexReader=function(e){var t=new Uint32Array(e,0,2);this.cell_count=t[0],this.data_count=t[1],this.headerSize=8,this.cellSize=108,this.dataSize=8;var n=this.cell_count*this.cellSize,i=this.data_count*this.dataSize;this.cellBuffer=e.slice(this.headerSize,this.headerSize+n),this.dataBuffer=e.slice(this.headerSize+n,this.headerSize+n+i)},CLOUD.Loader.LayerIndexReader.prototype={constructor:CLOUD.Loader.LayerIndexReader,getCell:function(e){if(e>=0&&e<this.cell_count)return new CLOUD.Loader.Cell(this.cellBuffer,e*this.cellSize)},getLayerIndex:function(e){if(e>=0&&e<this.data_count)return new CLOUD.Loader.LayerIndex(this.dataBuffer,e*this.dataSize)}},function(){var e=function(){function e(){_classCallCheck(this,e),this.geometries={}}return _createClass(e,[{key:"destroy",value:function(){this.disposeGeometries(),this.geometries=null}},{key:"disposeGeometries",value:function(){for(var e in this.geometries)this.disposeGeometry(e)}},{key:"disposeGeometry",value:function(e){var t=this.geometries[e];if(t){if(t instanceof Array)for(var n=0,i=t.length;n<i;n++)t[n].dispose();else t.dispose();delete this.geometries[e]}}},{key:"_hasGeometry",value:function(e){return!!this.geometries[e]}},{key:"_cacheGeometry",value:function(e,t){void 0===this.geometries[e]&&(this.geometries[e]=t)}},{key:"getGeometryById",value:function(e){return this.geometries[e]}},{key:"getGeometryByNodeInfo",value:function(e,t){return this._hasGeometry(t.geometryId)?this.getGeometryById(t.geometryId):this._createGeometryByNodeInfo(e,t)}},{key:"_createGeometryByNodeInfo",value:function(e,t){return this._createGeometry(t.type,t.geometryId,e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),e.lightmap)}},{key:"_createGeometry",value:function(e,t,n,i){if(this._hasGeometry(t))return this.getGeometryById(t);var r=i?this._createBufferGeometryWithLightmap(e,n):this._createBufferGeometry(e,n);return r?(this._cacheGeometry(t,r),r):null}},{key:"_createBufferGeometry",value:function(e,t){var n=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,i=null;switch(e){case n.MESH:case n.MESH_REF:if(!t)return null;i=new THREE.BufferGeometry,i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N?i.addAttribute("normal",new THREE.BufferAttribute(t.N,3)):i.computeVertexNormals(),t.UV&&i.addAttribute("uv",new THREE.BufferAttribute(t.UV,2));break;case n.TUBE:case n.PIPE:i=CLOUD.GeomUtil.UnitCylinderInstance;break;case n.BOX:i=CLOUD.GeomUtil.UnitBoxInstance;break;case n.BOX_M:i=CLOUD.GeomUtil.getUnitTextureBox();break;case n.PIPE_M:i=CLOUD.GeomUtil.getUnitTextureCylinder();break;case n.LINE:if(!t)return null;i=new THREE.BufferGeometry,i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3))}return i}},{key:"_createBufferGeometryWithLightmap",value:function(e,t){var n=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,i=null;switch(e){case n.MESH:case n.MESH_REF:if(!t)return null;i=new THREE.BufferGeometry,i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N?i.addAttribute("normal",new THREE.BufferAttribute(t.N,3)):i.computeVertexNormals(),t.UV&&i.addAttribute("uv",new THREE.BufferAttribute(t.UV,2));break;case n.PIPE:i=CLOUD.GeomUtil.getUnitLightmapPipe();break;case n.BOX:i=CLOUD.GeomUtil.getUnitLightmapBox();break;case n.BOX_M:i=CLOUD.GeomUtil.getUnitLightmapBoxM();break;case n.TUBE:case n.PIPE_M:i=CLOUD.GeomUtil.getUnitLightmapPipeM();break;case n.LINE:if(!t)return null;i=new THREE.BufferGeometry,i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3))}return i}},{key:"createBufferByBufferDataWithUV2",value:function(e,t,n){var i=this.createBufferByBufferData(t,n);if(!i)return null;if(!e.lightmap)return i;var r=[],a=i.index,o=e.getLoader().getUV2ById(t.itemIdUV2,a.length);o&&(t.lightmapIdx=o.lightmapIdx,t.materialId=t.materialId+"_"+t.lightmapIdx,r=o.uv2);for(var s=i.position,l=i.normal,u=i.uv,c=[],h=[],d=[],f=[],p=[],m=0,g=0;g<a.length;g++){var v=a[g];void 0==p[v]||r[2*p[v]]!=r[2*g]||r[2*p[v]+1]!=r[2*g+1]?(c.push(s[3*v]),c.push(s[3*v+1]),c.push(s[3*v+2]),l&&(h.push(l[3*v]),h.push(l[3*v+1]),h.push(l[3*v+2])),u&&(d.push(u[2*v]),d.push(u[2*v+1])),f.push(r[2*g]),f.push(r[2*g+1]),a[g]=m,m++,void 0==p[v]&&(p[v]=g)):a[g]=a[p[v]]}return s=null,l=null,u=null,r=null,p=null,i.uv2=f,i.position=c,i.normal=h,i.uv=d,i}},{key:"createBufferByBufferData",value:function(e,t){var n,i,r,a,o,s=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType;switch(e.type){case s.MESH:case s.MESH_REF:if(!t||!t.buffer)return null;if(t.isDataView?(i=Uint32Array.from(t.buffer.I),n=Float32Array.from(t.buffer.P),r=Float32Array.from(t.buffer.N),a=t.buffer.UV&&t.buffer.UV.length?Float32Array.from(t.buffer.UV):null):(i=new Uint32Array(t.buffer.I),n=new Float32Array(t.buffer.P),r=new Float32Array(t.buffer.N),a=t.buffer.UV&&t.buffer.UV.byteLength?new Float32Array(t.buffer.UV):null),t.indexInfo){i=i.slice(t.indexInfo.indexStart,t.indexInfo.indexStart+t.indexInfo.indexCount),n=n.slice(t.indexInfo.positionStart,t.indexInfo.positionStart+t.indexInfo.positionCount),r=r.slice(t.indexInfo.positionStart,t.indexInfo.positionStart+t.indexInfo.positionCount),a=a&&t.indexInfo.uvCount?a.slice(t.indexInfo.uvStart,t.indexInfo.uvStart+t.indexInfo.uvCount):null;var l=t.indexInfo.positionStart/3;i.forEach(function(e,t,n){n[t]-=l})}if(CLOUD.Utils.isMirror(e.matrix.elements))for(var u=0,c=i.length;u<c;u+=3){var h=i[u+1];i[u+1]=i[u+2],i[u+2]=h}break;case s.PIPE:o=CLOUD.GeomUtil.UnitCylinderInstance,i=Uint32Array.from(o.index.array),n=Float32Array.from(o.attributes.position.array),r=Float32Array.from(o.attributes.normal.array),o=null;break;case s.BOX:case s.TUBE:case s.BOX_M:case s.PIPE_M:o=e.type===s.BOX_M||e.type===s.BOX?CLOUD.GeomUtil.getBoxMBuffer(e.uvArrayBuffer):CLOUD.GeomUtil.getPipeMBuffer(e.uvArrayBuffer),i=Uint32Array.from(o.index),n=Float32Array.from(o.vertex),r=Float32Array.from(o.normal),o.uv&&(a=Float32Array.from(o.uv),delete o.uv),o=null;break;case s.LINE:if(!t||!t.buffer)return null;if(t.isDataView?(i=Uint32Array.from(t.buffer.I),n=Float32Array.from(t.buffer.P),r=null,a=null):(i=new Uint32Array(t.buffer.I),n=new Float32Array(t.buffer.P),r=null,a=null),t.indexInfo){i=i.slice(t.indexInfo.indexStart,t.indexInfo.indexStart+t.indexInfo.indexCount),n=n.slice(t.indexInfo.positionStart,t.indexInfo.positionStart+t.indexInfo.positionCount);var l=t.indexInfo.positionStart/3;i.forEach(function(e,t,n){n[t]-=l})}break;default:console.log("error data!")}var d=e.matrix;if(CLOUD.GeomUtil.applyMatrix4ToBuffer(d,n),r){var f=new THREE.Matrix3;f.getNormalMatrix(d),CLOUD.GeomUtil.applyMatrix3ToBuffer(f,r),CLOUD.GeomUtil.normalizeBuffer(r)}return e.uv=!!a,{index:i,position:n,normal:r,uv:a}}}]),e}();CLOUD.ModelView.MeshBaseManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.symbolReader=null,this.userIdReader=null,this.userDataReader=null,this.mapSceneReader={},this.lightmap=!1,this.mapNodeInfoByCategory={},this.mapNodeInfoByUserId={},this.mapNodeInfoByCellId={},this.mapNodeInfoByParameterizedDesc={},this.mapNodeInfoByGeometryId=null,this.referencedMeshCache={},this.cellCount=0,this.borderLines={},this.octreeRootNode={inner:null,outer:null,layer:null}}return _createClass(e,[{key:"destroy",value:function(){this.destroyReader(),this.mapNodeInfoByCategory=null,this.mapNodeInfoByUserId=null,this.mapNodeInfoByCellId=null,this.mapNodeInfoByParameterizedDesc=null,this.mapNodeInfoByGeometryId=null,this.referencedMeshCache=null,this.borderLines=null,this.octreeRootNode=null}},{key:"destroyReader",value:function(){this.userIdReader=null,this.userDataReader=null,this.symbolReader=null,this.mapSceneReader=null}},{key:"getSceneReaderMap",value:function(){return this.mapSceneReader}},{key:"isValidScene",value:function(){return!CLOUD.Utils.isEmptyObject(this.getSceneReaderMap())||(CLOUD.Logger.log("model load not started!"),!1)}},{key:"_classifyNodeInfo",value:function(e){this._cacheNodeInfoByCellId(e),this._cacheNodeInfoByUserId(e),this._cacheNodeInfoByCategory(e),this._cacheNodeInfoByParameterizedDesc(e)}},{key:"_cacheNodeInfoByCellId",value:function(e){void 0===this.mapNodeInfoByCellId[e.cellId]&&(this.mapNodeInfoByCellId[e.cellId]=[]),this.mapNodeInfoByCellId[e.cellId].push(e)}},{key:"_cacheNodeInfoByUserId",value:function(e){void 0===this.mapNodeInfoByUserId[e.userId]&&(this.mapNodeInfoByUserId[e.userId]=[]),this.mapNodeInfoByUserId[e.userId].push(e)}},{key:"_cacheNodeInfoByCategory",value:function(e){var t;t=e.instanceOrNot?CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED:CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD,void 0===this.mapNodeInfoByCategory[t]&&(this.mapNodeInfoByCategory[t]={}),void 0===this.mapNodeInfoByCategory[t][e.userId]&&(this.mapNodeInfoByCategory[t][e.userId]=[]),this.mapNodeInfoByCategory[t][e.userId].push(e)}},{key:"_cacheNodeInfoByParameterizedDesc",value:function(e){e.parameterizedDesc&&(void 0===this.mapNodeInfoByParameterizedDesc[e.type]&&(this.mapNodeInfoByParameterizedDesc[e.type]=[]),this.mapNodeInfoByParameterizedDesc[e.type].push(e))}},{key:"_clearNodeInfoCacheWithParameterizedDesc",value:function(){this.mapNodeInfoByParameterizedDesc={}}},{key:"_clearNodeInfoCacheWithCellId",value:function(){this.mapNodeInfoByCellId={}}},{key:"_clearNodeInfoCacheWithCategory",value:function(){this.mapNodeInfoByCategory={}}},{key:"_clearNodeInfoCacheWithUserId",value:function(){this.mapNodeInfoByUserId={}}},{key:"clearNodeInfoCache",value:function(){this._clearNodeInfoCacheWithCellId(),this._clearNodeInfoCacheWithUserId(),this._clearNodeInfoCacheWithCategory(),this._clearNodeInfoCacheWithParameterizedDesc()}},{key:"getNodeInfosByCellId",value:function(e){return this.mapNodeInfoByCellId[e]}},{key:"getNodeInfosWithCellId",value:function(){return this.mapNodeInfoByCellId}},{key:"getNodeInfosWithParameterizedDesc",value:function(){return this.mapNodeInfoByParameterizedDesc}},{key:"getAllNodeInfos",value:function(){return this.mapNodeInfoByUserId}},{key:"getNodeInfosByUserId",value:function(e){return this.mapNodeInfoByUserId[e]}},{key:"getStandardNodeInfos",value:function(){return this.mapNodeInfoByCategory[CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD]}},{key:"getInstancedNodeInfos",value:function(){return this.mapNodeInfoByCategory[CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED]}},{key:"getStandardUserIds",value:function(){return this.getStandardNodeInfos()?Object.keys(this.getStandardNodeInfos()):[]}},{key:"getInstancedUserIds",value:function(){return this.getInstancedNodeInfos()?Object.keys(this.getInstancedNodeInfos()):[]}},{key:"getStandardNodeInfosById",value:function(e){var t=this.getStandardNodeInfos();return t?t[e]:null}},{key:"getInstancedNodeInfosById",value:function(e){var t=this.getInstancedNodeInfos();return t?t[e]:null}},{key:"_getUserIdsByCategory",value:function(e,t){var n,i=[];if(n=t===CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED?this.getInstancedNodeInfos():this.getStandardNodeInfos())for(var r=0,a=e.length;r<a;r++)n[e[r]]&&i.push(e[r]);return i}},{key:"getInstancedUserIdsByCategory",value:function(e){return this._getUserIdsByCategory(e,CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED)}},{key:"getStandardUserIdsByCategory",value:function(e){return this._getUserIdsByCategory(e,CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD)}},{key:"_traverseNodeInfosByIds",value:function(e,t,n){for(var i=0,r=t.length;i<r;i++){var a=t[i];n(a,e[a])}}},{key:"traverseStandardNodeInfos",value:function(e,t){var n=this.getStandardNodeInfos();n&&(e=e||this.getStandardUserIds(),this._traverseNodeInfosByIds(n,e,t))}},{key:"traverseInstancedNodeInfos",value:function(e,t){var n=this.getInstancedNodeInfos();n&&(e=e||this.getInstancedUserIds(),this._traverseNodeInfosByIds(n,e,t))}},{key:"traverseNodeInfosByCell",value:function(e){for(var t=Object.keys(this.mapNodeInfoByCellId),n=0,i=t.length;n<i;n++)for(var r=t[n],a=this.mapNodeInfoByCellId[r],o=0,s=a.length;o<s;o++)e(r,a[o])}},{key:"clearReferencedMeshCache",value:function(){for(var e in this.referencedMeshCache)delete this.referencedMeshCache[e];this.referencedMeshCache=null}},{key:"cacheReferencedMeshBufferData",value:function(e,t){this.referencedMeshCache.bufferData||(this.referencedMeshCache.bufferData={}),this.referencedMeshCache.bufferData[e]=t}},{key:"getReferencedMeshBufferData",value:function(){return this.referencedMeshCache.bufferData}},{key:"getReferencedMeshBufferById",value:function(e){return this.referencedMeshCache&&this.referencedMeshCache.bufferData?this.referencedMeshCache.bufferData[e]:null}},{key:"cacheReferencedMeshMpkIds",value:function(e,t){this.referencedMeshCache.mpkIds||(this.referencedMeshCache.mpkIds={}),this.referencedMeshCache.mpkIds[e]||(this.referencedMeshCache.mpkIds[e]=[]),this.referencedMeshCache.mpkIds[e].push(t)}},{key:"clearReferencedMeshCacheByMpkIdxs",value:function(e,t){if(this.referencedMeshCache.mpkIds)for(var n=0,i=e.length;n<i;n++){var r=e[n],a=this.referencedMeshCache.mpkIds[r];if(a){for(var o=0,s=a.length;o<s;o++)t&&t(a[o]),delete this.referencedMeshCache[a[o]];delete this.referencedMeshCache.mpkIds[r]}}}},{key:"cacheBorderLine",value:function(e,t){var n=e?"shared":"unique";this.borderLines[n]||(this.borderLines[n]=[]),this.borderLines[n].push(t)}},{key:"getSharedBorderLineCache",value:function(){return this.borderLines.shared}},{key:"getUniqueBorderLineCache",value:function(){return this.borderLines.unique}},{key:"_isRegularShape",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.TUBE||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.PIPE||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.BOX||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.BOX_M||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.PIPE_M}},{key:"_isInstancedNode",value:function(e){
return!!CLOUD.GlobalData.Instance&&(e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF?!!CLOUD.GlobalData.SharedMeshInstanceEnable:!!e.parameterizedDesc)}},{key:"getCellCount",value:function(){return this.cellCount}},{key:"getOctreeRootNode",value:function(){return this.octreeRootNode}},{key:"isUseInnerAndOuterOctree",value:function(){return!0}},{key:"isOctreeOuter",value:function(e){var t=this.octreeRootNode.inner||this.octreeRootNode.outer;return!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}},{key:"getOctreeRoots",value:function(e){this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer),this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner)}},{key:"updateOctreeNodeBy",value:function(e,t){function n(e,t){r.copy(e.boundingBoxWorld),r.applyMatrix4(t),e.min.copy(r.min),e.max.copy(r.max),e.center=r.getCenter(),e.size=r.getSize().lengthSq()}function i(e,t){for(var r=0,a=e.childOctants.length;r<a;++r){var o=e.childOctants[r];n(o,t),i(o,t)}}var r=new THREE.Box3;n(e,t),i(e,t)}},{key:"updateOctreeNode",value:function(e){var t=this.getOctreeRootNode();t.outer&&this.updateOctreeNodeBy(t.outer,e),t.inner&&this.updateOctreeNodeBy(t.inner,e)}},{key:"removeFromSceneReaderMap",value:function(e){for(var t=0,n=e.length;t<n;t++)this.mapSceneReader[e[t]]&&delete this.mapSceneReader[e[t]]}},{key:"isUserIdExist",value:function(e){return!!this.getNodeInfosByUserId(e)}},{key:"addToNodeInfoMap",value:function(e){for(var t=0,n=e.length;t<n;t++)this._cacheNodeInfoByUserId(e[t])}},{key:"removeFromNodeInfoMap",value:function(e){for(var t=this.getAllNodeInfos(),n=0,i=e.length;n<i;n++){var r=e[n].userId;t[r]&&delete t[r]}}},{key:"cacheNodeInfosOnGeometryId",value:function(){var e=this.getStandardNodeInfos();this.mapNodeInfoByGeometryId={};for(var t in e)for(var n=e[t],i=0,r=n.length;i<r;i++)n[i].geometryId=this.convertGeometryId(n[i].geometryId),this.mapNodeInfoByGeometryId[n[i].geometryId]||(this.mapNodeInfoByGeometryId[n[i].geometryId]=[]),this.mapNodeInfoByGeometryId[n[i].geometryId].push(n[i])}},{key:"getNodeInfosOnGeometryId",value:function(){return this.mapNodeInfoByGeometryId?this.mapNodeInfoByGeometryId:(this.cacheNodeInfosOnGeometryId(),this.mapNodeInfoByGeometryId)}},{key:"clearNodeInfosWithGeometryId",value:function(){this.mapNodeInfoByGeometryId=null}},{key:"convertGeometryId",value:function(e){return e}}],[{key:"getMeshIdFromOctantMap",value:function(t){return t.single?t.nodeId:t.instanceOrNot?t.uv2Info?CLOUD.Utils.getCombinedKeyString([t.materialId,t.geometryId,t.uv2Info.byteOffset]):CLOUD.Utils.getCombinedKeyString([t.materialId,t.geometryId]):CLOUD.GlobalData.BatchMergeEnabled?CLOUD.Utils.getCombinedKeyString([t.materialId,t.uv?"1":"0",t.type===e.EnumNodeItemType.LINE?"lines":"meshes"]):t.nodeId}}]),e}();e.EnumNodeItemType={SYMBOL:0,MESH:1,TUBE:2,PIPE:3,BOX:4,BOX_M:5,PIPE_M:6,MESH_REF:7,LINE:8},e.NodeInfoCategory={INSTANCED:0,STANDARD:1},e.parameterizedNodeType={BOX:"box",BOX_M:"boxM",PIPE:"pipe",PIPE_M:"pipeM",TUBE:"tube"},CLOUD.ModelView.BaseDescriptor=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.handler=t,this.model=t.model,this.url=t.model.dataUrl,this.fileLoader=t.model.fileLoader,this.descriptor=null,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.loadTextureCount=0,this.maxLoadTextureCount=0,this.textruesLoaded=!1,this.dataLoaded=!1,this.mpkTaskManager=new CLOUD.TaskManager,this.textureManager=new CLOUD.TaskManager,this.enableCompressedTexture=!1,this.enableSmallTexture=!1,this.enablePkgTexture=!1,this.enableTexturePkgGz=!0,this.enableOrgTexture=!1,this.enableDdsTexture=!1,this.pkgTextureMap={},this.pkgTextureArrayBufferMap={},this.startCallback=null,this.progressCallback=null,this.finishCallback=null}return _createClass(e,[{key:"destroy",value:function(){this.mpkTaskManager=null,this.textureManager=null,this.url=null,this.fileLoader=null,this.descriptor&&(this.descriptor.destroy(),this.descriptor=null),this.model=null,this.handler=null,this.startCallback=null,this.progressCallback=null,this.finishCallback=null,this.pkgTextureMap=null,this.pkgTextureArrayBufferMap=null}},{key:"getDescriptor",value:function(){return this.descriptor}},{key:"setNotifyProgress",value:function(e){this.notifyProgress=e}},{key:"load",value:function(e,t,n){this.startCallback=e,this.progressCallback=t,this.finishCallback=n;var i=this.url.lightmapProjectUrl();if(i){var r=this;this._loadLightmapConfig(i,function(){r.loadData()})}else this.loadData()}},{key:"_loadFileByPromise",value:function(e,t){var n=this.model.fileLoader;return n.setResponseType(t),new Promise(function(t,i){n.load(e,function(e){"string"==typeof e&&t(JSON.parse(e)),void 0==e.metadata?i(e):t(e)})})}},{key:"_loadTexturePkgByIndex",value:function(e,t){var n=this,i=n.pkgTextureArrayBufferMap[e],r=n.url.textureUrl(i),a=n.model.fileLoader;a.setResponseType("arraybuffer"),a.load(r,function(e){n.pkgTextureArrayBufferMap[i]=e,t()})}},{key:"loadData",value:function(){var e=this,t=e.model,n=t.getConfig().metadata;CLOUD.GlobalData.CanUseCompressedTexture&&n.texture_dds&&(e.enableCompressedTexture=!0),CLOUD.GlobalData.CanUseSmallTexture&&n.texture_small&&(e.enableSmallTexture=!0),n.texture_pkg&&(e.enablePkgTexture=!0),n.texture_org&&(e.enableOrgTexture=!0),n.texture_dds&&(this.enableDdsTexture=!0),0==n.texture_pkg_gz&&(this.enableTexturePkgGz=!1),CLOUD.Compatibility.isUseMergeTexturePkg(n.version)?CLOUD.Compatibility.useMergeTexturePkg=!0:CLOUD.Compatibility.useMergeTexturePkg=!1,CLOUD.Compatibility.isUse32MpkData(n.version)?CLOUD.Compatibility.use32MpkData=!0:CLOUD.Compatibility.use32MpkData=!1;var i=this.getSceneTaskCount(n);e.maxLoadTaskCount=0,e.maxLoadTaskCount+=i,e.maxLoadTaskCount+=n.material,e.maxLoadTaskCount+=n.userId,e.maxLoadTaskCount+=n.userdata,e.maxLoadTaskCount+=n.camera,e.maxLoadTaskCount+=n.octree_o,e.maxLoadTaskCount+=n.octree_i,t.lightmap&&(e.maxLoadTaskCount+=2),e.startCallback&&e.startCallback();var r=this.url;if(n.material)if(e.enablePkgTexture){var a=[];e.pkgTextureMap={};var o=1==this.enableTexturePkgGz?"gzip":"json",s=".gz"==CLOUD.GlobalData.ZipResourcePostfix?"gzip":"json";CLOUD.Compatibility.useMergeTexturePkg?a.push(e._loadFileByPromise(r.texturePkgIndexUrl(e.enableTexturePkgGz),o)):(e.enableOrgTexture&&a.push(e._loadFileByPromise(r.texturePkgOrgIndexUrl(),s)),e.enableSmallTexture&&a.push(e._loadFileByPromise(r.texturePkgSmallIndexUrl(),s)));var l=Promise.all(a.map(function(e){return e.catch(function(e){return e})}));l.then(function(t){var n=0;for(var i in t)for(var r in t[i].textures){e.pkgTextureMap[r]=t[i].textures[r],void 0==e.pkgTextureMap[r].type&&(e.pkgTextureMap[r].type=t[i].metadata.type);var a=e.url.texturePkgFileName(CLOUD.Compatibility.useMergeTexturePkg,e.enableTexturePkgGz,t[i].textures[r].pkg,t[i].metadata.type);a in e.pkgTextureArrayBufferMap||(e.pkgTextureArrayBufferMap[n]=a,e.pkgTextureArrayBufferMap[a]={},e.textureManager.addTask(n),n++)}e.textureManager.processTasks(e._loadTexturePkgByIndex.bind(e),void 0,function(){var t=e.model,n=t.getConfig().metadata;e._loadMaterial(n.material_json)})}).catch(function(e){console.log("promise reject failed reason",e)})}else e._loadMaterial(n.material_json);n.userId&&e._loadUserId(),n.userdata&&e._loadUserData(),n.camera&&e._loadCamera(),(n.octree_o||n.octree_i)&&e._loadOctree(n.octree_o,n.octree_i),t.lightmap&&e._loadUV2(),i&&e.loadSceneAndMpks(n)}},{key:"loadSceneAndMpks",value:function(e){}},{key:"getSceneTaskCount",value:function(e){return 0}},{key:"_loadLightmapConfig",value:function(e,t){var n=this.model,i=this.descriptor;this.fileLoader.load(e,function(e){var r;try{r=JSON.parse(e)}catch(e){return void console.log("Lightmap config data exceptions!")}void 0!==r.count.lightmapNum&&r.count.lightmapNum>0&&(n.lightmapNum=r.count.lightmapNum,i.lightmap=!0,CLOUD.GlobalData.EnableLightmap=!0),t&&t()})}},{key:"_onTaskFinished",value:function(){var e=this.model;this.loadTaskCount++;var t=this.dealProgressSegment(e,this.loadTaskCount);if(this.notifyProgress){var n={total:this.maxLoadTaskCount,loaded:t};this.progressCallback&&this.progressCallback(n)}this.loadTaskCount>=this.maxLoadTaskCount&&(this.dataLoaded=!0,this.textruesLoaded&&this.finishCallback&&this.finishCallback())}},{key:"_onLoadTexture",value:function(){++this.loadTextureCount>=this.maxLoadTextureCount&&(this.textruesLoaded=!0,this.pkgTextureMap=null,this.pkgTextureArrayBufferMap=null,this.textureManager=null,this.dataLoaded&&this.finishCallback&&this.finishCallback())}},{key:"_loadScene",value:function(e){var t=this,n=this.model,i=this.url,r=this.fileLoader;r.setResponseType("arraybuffer"),r.load(i.sceneUrl(e),function(n){t._parseScene(n,e),t._onTaskFinished()},void 0,function(e){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_SCENE_ERROR,event:e}),t._onTaskFinished()})}},{key:"_parseScene",value:function(e,t){var n=new CLOUD.Loader.SceneReader(e);this.descriptor.mapSceneReader[t]=n,n=null}},{key:"_loadLine",value:function(){var e=this,t=this.model,n=this.url,i=this.fileLoader;i.setResponseType("arraybuffer"),i.load(n.lineUrl(),function(t){e._parseLine(t),e._onTaskFinished()},void 0,function(n){t.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:n}),e._onTaskFinished()})}},{key:"_parseLine",value:function(e){for(var t=new CLOUD.Loader.LineReader(e),n=0,i=t.header.lineCount;n<i;++n){var r=t.getPtBuffer(n),a=t.getIdxBuffer(n);if(void 0!=r&&void 0!=a){var o=t.getLineData(n);if(0===o.lineType){for(var s=[],l=1,u=a.length;l<u;l++)s.push(a[l-1]),s.push(a[l]);s.length&&(a=s)}this.descriptor.cacheReferencedMeshBufferData("line-"+o.line_id,{P:r,I:a})}else CLOUD.Logger.log("Error Geometry!")}t=null}},{key:"_loadMaterial",value:function(e){var t=this,n=this.model,i=this.url,r=this.fileLoader;e?r.setResponseType(""):r.setResponseType("arraybuffer"),r.load(i.materialUrl(),function(n){t._parseMaterial(n,e),t._onTaskFinished()},void 0,function(e){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t.textruesLoaded=!0,t._onTaskFinished()})}},{key:"_parseMaterial",value:function(e,t){t?this._parseMaterialJson(e):this._parseMaterialBinary(e)}},{key:"_parseMaterialBinary",value:function(e){var t,n=this.url,i=this.model.materialManager,r=i.materials,a=i.textures,o=new CLOUD.Loader.MaterialReader(e),s=o.materialCount,l=this,u=[];if(!(s<0)){var c=this.model.manager.scene;for(t=0;t<s;++t){var h={},d=o.getMaterial(t);void 0!==d.color&&(h.color=d.color),void 0!==d.opacity&&(h.opacity=d.opacity,d.opacity<1&&(h.transparent=!0)),void 0!==d.side&&d.side&&(h.side=THREE.DoubleSide),void 0!==d.emissive&&(h.emissive=d.emissive),void 0!==d.environment&&(h.envMapIntensity=d.environment),void 0!==d.roughness&&(h.roughness=d.roughness,h.originRoughness=d.roughness),void 0!==d.metalness&&(h.metalness=d.metalness,h.originMetalness=d.metalness);var f;if(CLOUD.GlobalData.IBL?(h.iblProbe=c.iblProbe,f=new ImageBasedLighting.IBLMaterial(h),f.type="IBL"):f=CLOUD.MaterialUtil.createStandardMaterial(h),f.name=t,r[t]=f,h=null,CLOUD.GlobalData.EnableTextureLoading){var p=d.texture_n,m=null;p>0&&(m=o.getTexture(d.texture_id[0])),m&&u.push({id:t,data:m})}}if(u.length>0){for(s=this.maxLoadTextureCount=u.length,t=0;t<s;t++)this._parseTexture(n,u[t],a);u=null}if(this.model.lightmap){var g=this.model.lightmapNum;for(this.maxLoadTextureCount+=g,t=0;t<g;t++){var v=this._loadTexture(n.textureUrl("lightmap-rgbm"+t+".png"),function(){l._onLoadTexture()},void 0,function(){l._onLoadTexture()});i.lightmaps[t]=v}}0==this.maxLoadTextureCount&&l._onLoadTexture(),o=null}}},{key:"_parseMaterialJson",value:function(e){var t,n=this.url,i=this.model.materialManager,r=i.materials,a=i.textures,o=new CLOUD.Loader.MaterialReaderJson(e),s=o.count,l=this,u=[];if(!(s<0)){var c=this.model.manager.scene;for(t=0;t<s;++t){var h={},d=o.getMaterial(t),f=d.parameters;if(void 0!==f.color&&(h.color=f.color),void 0!==f.opacity&&(h.opacity=f.opacity,f.opacity<1&&(h.transparent=!0)),void 0!==f.side&&"double"==f.side&&(h.side=THREE.DoubleSide),void 0!==f.emissive&&(h.emissive=f.emissive),void 0!==f.environment&&(h.envMapIntensity=f.environment),void 0!==f.roughness&&(h.roughness=f.roughness,h.originRoughness=f.roughness),void 0!==f.metalness&&(h.metalness=f.metalness,h.originMetalness=f.metalness),void 0!==f.refractionRatio&&(h.refractionRatio=f.refractionRatio),void 0!==f.imageFade&&(h.imageFade=f.imageFade),void 0!=d.fillPattern){h.fillMap=this._loadFillMap(d.fillPattern);var p=this.model.getModelManager().viewer.domElement;h.viewportSize=new THREE.Vector2(p.offsetWidth,p.offsetHeight)}var m;if(CLOUD.GlobalData.IBL?(h.iblProbe=c.iblProbe,m=new ImageBasedLighting.IBLMaterial(h),m.type="IBL"):(m=CLOUD.MaterialUtil.createStandardMaterial(h),m.refreshUniforms()),m.name=t,r[t]=m,h=null,CLOUD.GlobalData.EnableTextureLoading){var g=[],v=d.textures;for(var y in v){var E=v[y];"reliefMap"==y&&v.bumpMap||g.push({type:y,data:E})}g.length>0&&u.push({id:t,dataArray:g})}}if(u.length>0){for(s=u.length,t=0;t<s;t++){var g=u[t].dataArray;this.maxLoadTextureCount+=g.length}for(t=0;t<s;t++){for(var b=u[t].id,g=u[t].dataArray,x=[],M=0,_=g.length;M<_;M++)this._parseTextureJson(n,g[M],x);a[b]=x}u=null}if(this.model.lightmap){var C=this.model.lightmapNum;for(this.maxLoadTextureCount+=C,t=0;t<C;t++){var I=this._loadTexture(n.lightmapTexUrl("lightmap-rgbm"+t+".png"),function(){l._onLoadTexture()},void 0,function(){l._onLoadTexture()});i.lightmaps[t]=I}}0==this.maxLoadTextureCount&&l._onLoadTexture(),o=null}}},{key:"_loadTexture",value:function(e,t,n,i){var r,a=THREE.Loader.Handlers.get(e),o=this;return null!==a?r=a.load(e,t):(r=new THREE.Texture,a=new THREE.ImageLoader,a.setCrossOrigin("anonymous"),a.load(e,function(e){r.image=CLOUD.MaterialUtil.ensurePowerOfTwo(e),r.needsUpdate=!0,t&&t(r)},n,function(e){void 0!==i&&i(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})),r}},{key:"_loadFillMap",value:function(e){var t,n=[],i=CLOUD.FILLPATTERN[e];if(!i)return t;for(var r=0;r<1024;r++){var a=i[Math.floor(r/8)],o=Math.floor(Math.pow(2,r%8));a=Math.floor(a&o),0==a?(n.push(0),n.push(0),n.push(0)):(n.push(255),n.push(255),n.push(255))}return t=new THREE.DataTexture(new Uint8Array(n),32,32,THREE.RGBFormat,THREE.UnsignedByteType),t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.needsUpdate=!0,t}},{key:"_loadCompressedTexture",value:function(e,t,n,i){var r=this,e=e.substring(0,e.lastIndexOf("."))+".dds",a=e.lastIndexOf("/"),o=e.substring(a+1),s=new THREE.DDSLoader;if(r.enableDdsTexture&&o in r.pkgTextureMap){var l=r.url.texturePkgFileName(CLOUD.Compatibility.useMergeTexturePkg,r.enableTexturePkgGz,r.pkgTextureMap[o].pkg,r.pkgTextureMap[o].type),u=(r.url.textureUrl(l),r.pkgTextureMap[o].offset),c=r.pkgTextureMap[o].length,h=r.pkgTextureArrayBufferMap[l].slice(u,u+c);s.loadBuffer(h,t)}else s.load(e,t,n,function(e){void 0!==i&&i(e),r.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})}},{key:"creatTextureImage",value:function(e,t,n,i,r){(new TEST.CryptoResourceLoader).load(t,function(t){var a=new Blob([t],{type:"jpeg"}),o=new Image;o.onload=function(){e.image=CLOUD.MaterialUtil.ensurePowerOfTwo(o),e.needsUpdate=!0,i&&i(e)},o.onerror=function(e){r&&r(e),n.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})},o.src=URL.createObjectURL(a)})}},{key:"_loadTextureByCrypto",value:function(e,t,n,i){var r,a=THREE.Loader.Handlers.get(e),o=this,s=this;if(null!==a)r=a.load(e,t);else{r=new THREE.Texture;var l=e.lastIndexOf("/"),u=e.substring(l+1);if(s.enablePkgTexture&&u in s.pkgTextureMap){var a=s.model.fileLoader;a.setResponseType("arraybuffer");var c=s.url.texturePkgFileName(CLOUD.Compatibility.useMergeTexturePkg,s.enableTexturePkgGz,s.pkgTextureMap[u].pkg,s.pkgTextureMap[u].type),h=s.url.textureUrl(c),d=s.pkgTextureMap[u].offset,f=s.pkgTextureMap[u].length;if(c in s.pkgTextureArrayBufferMap){var p=s.pkgTextureArrayBufferMap[c].slice(d,d+f);s.creatTextureImage(r,p,o,t,i)}else a.load(h,function(e){s.pkgTextureArrayBufferMap[c]=e;var n=e.slice(d,d+f);s.creatTextureImage(r,n,o,t,i)},function(e){void 0!==i&&i(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})}else a=new TEST.CryptoResourceLoader,a.loadURL(e,function(e){var n=new Blob([e],{type:"jpeg"}),a=new Image;a.onload=function(){r.image=CLOUD.MaterialUtil.ensurePowerOfTwo(a),r.needsUpdate=!0,t&&t(r)},a.onerror=function(e){i&&i(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})},a.src=URL.createObjectURL(n)},function(e){void 0!==i&&i(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})}return r}},{key:"_parseTexture",value:function(e,t,n){var i=window.TEST||{},r=t.id,a=t.data,o=a.id+a.file_name_ext;this.enableCompressedTexture&&a.dds?this.textureLoader=this._loadCompressedTexture:this.textureLoader=i.CryptoResourceLoader?this._loadTextureByCrypto:this._loadTexture;var s=this;this.textureLoader(e.textureUrl(o),function(e){e.repeat.fromArray([a.scale_u,a.scale_v]),e.offset.fromArray([a.offset_u,a.offset_v]),e.setRotateAngle&&e.setRotateAngle(a.angle),a.repeat_u&&(e.wrapS=THREE.RepeatWrapping),a.repeat_v&&(e.wrapT=THREE.RepeatWrapping),e&&(n[r]=e),s._onLoadTexture()},void 0,function(){s._onLoadTexture()})}},{key:"_parseTextureJson",value:function(e,t,n){var i=window.TEST||{},r=t.type,a=t.data,o=e.textureUrl(a.sourceFile),s=this.enableSmallTexture&&a.texture_small;if(!s&&this.enableCompressedTexture&&a.dds)this.textureLoader=this._loadCompressedTexture;else if(this.textureLoader=i.CryptoResourceLoader?this._loadTextureByCrypto:this._loadTexture,s){var l=o.lastIndexOf(".");o=o.substring(0,l)+"_s"+o.substring(l)}var u=this;this.textureLoader(o,function(e){e.repeat.fromArray([a.scale[0],a.scale[1]]),e.offset.fromArray([a.offset[0],a.offset[1]]),e.setRotateAngle&&e.setRotateAngle(a.angle),a.repeatU&&(e.wrapS=THREE.RepeatWrapping),a.repeatV&&(e.wrapT=THREE.RepeatWrapping),e.texturetype=r,"reliefMap"==r&&(e.texturetype="bumpMap"),a.dataType&&"NormalMap"==a.dataType&&(e.texturetype="normalMap"),a.alpha&&(e.texturetype="alphaMap"),void 0!=a.depth&&(e.depth=a.depth),e&&n.push(e),u._onLoadTexture()},void 0,function(){u._onLoadTexture()})}},{key:"_loadUV2",value:function(){var e=this,t=this.url,n=this.fileLoader;n.setResponseType("arraybuffer"),n.load(t.uv2Url(),function(t){e.uv2Buffer=new Uint16Array(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()}),n.setResponseType(""),n.load(t.uv2MapItemUrl(),function(t){e.uv2MapItem=JSON.parse(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"getUV2ById",value:function(e,t){if(this.uv2MapItem&&t){var n=this.uv2MapItem[e];if(n){var i=n.uv1Scale,r=n.uv1Translation,a=n.uv1ByteOffset/2,o=2*t;if(this.uv2Buffer){for(var s=this.uv2Buffer,l=[],u=a;u<a+o;u+=2)l.push(i[0]*(s[u]/65535)+r[0]),l.push(i[1]*(s[u+1]/65535)+r[1]);return{lightmapIdx:n.lightmapIdx,uv2:l}}}}}},{key:"getInstanceUV2InfoById",value:function(e){if(this.uv2MapItem){var t=this.uv2MapItem[e];if(t){var n=t.uv1Scale,i=t.uv1Translation,r=[];return r.push(n[0]),r.push(n[1]),r.push(i[0]),r.push(i[1]),{lightmapIdx:t.lightmapIdx,byteOffset:t.uv1ByteOffset,offsetRepeat:r}}}}},{key:"getInstanceUV2ById",value:function(e,t){var n=e/2;if(this.uv2Buffer){return this.uv2Buffer.slice(n,n+t)}}},{key:"_loadSymbol",value:function(e){var t=this,n=this.url,i=this.fileLoader;i.setResponseType("arraybuffer"),i.load(n.symbolUrl(),function(n){t.parseSymbol(n),t._onTaskFinished(),e&&e()},void 0,function(n){t.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_SYMBOL_ERROR,event:n}),t._onTaskFinished(),e&&e()})}},{key:"parseSymbol",value:function(e){this.descriptor.symbolReader=new CLOUD.Loader.SymbolReader(e)}},{key:"_loadOctree",value:function(e,t){var n=null,i=this.model.configLoader.transformInfos.transformMatrix;this.model.configLoader.transformInfos.octreeTransformed&&(n=new THREE.Matrix4,n.getInverse(i)),e&&this._loadOctreeBy(n,!1),t&&this._loadOctreeBy(n,!0)}},{key:"_loadOctreeBy",value:function(e,t){var n,i=this,r=this.url,a=this.fileLoader;n=t?r.octreeUrl("i"):r.octreeUrl("o"),a.setResponseType("arraybuffer"),a.load(n,function(n){i._parseOctree(n,e,t),i._onTaskFinished()},void 0,function(e){i.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_OCTREEINNER_ERROR,event:e}),i._onTaskFinished()})}},{key:"_parseOctree",value:function(e,t,n){this.descriptor.octreeRootNode[n?"inner":"outer"]=this._getOctreeRootNode(e,t)}},{key:"_getOctreeRootNode",value:function(e,t){function n(e,n){t&&n.boundingBox.applyMatrix4(t),e.boundingBoxWorld=n.boundingBox.clone(),e.min=n.boundingBox.min,e.max=n.boundingBox.max,e.center=n.boundingBox.getCenter(),e.size=n.boundingBox.getSize().lengthSq(),e.childStart=n.child_s,e.childEnd=n.child_e}function i(e,t){e.octType=0,e.center.x<t.center.x&&(e.octType+=1),e.center.y<t.center.y&&(e.octType+=2),e.center.z<t.center.z&&(e.octType+=4)}function r(e,t){for(var a=e.childStart,o=e.childEnd,s=a;s<o;++s){var l=t.getNode(s),u=l.cell_id,c=new CLOUD.Loader.OctreeNode(u,e.depth);n(c,l),e.add(c),i(c,e),c.updateMaxDepth(),r(c,t)}}var a=null,o=new CLOUD.Loader.OctreeReader(e);if(o.getCount()>0){var s=o.getNode(0),l=s.cell_id;a=new CLOUD.Loader.OctreeNode(l,0),n(a,s),r(a,o)}return o=null,a}},{key:"_loadUserId",value:function(){var e=this,t=this.url,n=this.fileLoader;n.setResponseType("arraybuffer"),n.load(t.userIdUrl(),function(t){e._parseUserId(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()})}},{key:"_parseUserId",value:function(e){this.descriptor.userIdReader=new CLOUD.Loader.IdReader(e)}},{key:"_loadUserData",value:function(){var e=this,t=this.url,n=this.fileLoader;n.setResponseType(""),n.load(t.userDataUrl(),function(t){e._parseUserData(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_USERDATA_ERROR,event:t}),e._onTaskFinished()})}},{key:"_parseUserData",value:function(e){this.descriptor.userDataReader=new CLOUD.Loader.UserDataReader(e)}},{key:"_loadCamera",value:function(){var e=this,t=this.url,n=this.fileLoader;n.setResponseType(""),n.load(t.cameraUrl(),function(t){e._parseCamera(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_CAMERA_ERROR,event:t}),e._onTaskFinished()})}},{key:"_parseCamera",value:function(e){var t=this.model.configLoader.transformInfos.transformMatrix;new CLOUD.Loader.CameraReader(e).parse(this.model,t)}},{key:"_loadMpk",value:function(e,t){var n=this,i=this.fileLoader,r=this.url;i.setResponseType("arraybuffer"),i.load(r.mpkUrl(e),function(i){n._parseMpk(i,e),t(),n._onTaskFinished()},void 0,function(e){n.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),n._onTaskFinished()})}},{key:"_loadAllMpks",value:function(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this._loadMpk.bind(this))}},{key:"_parseMpk",value:function(e,t){for(var n=this.model.getConfig().metadata.mpk_batched?CLOUD.Loader.BMPKReader:CLOUD.Loader.MPKReader,i=new n(e),r=new THREE.Matrix4,a=0,o=i.header.meshCount;a<o;++a){var s=i.getPtBuffer(a),l=i.getIdxBuffer(a),u=i.getNormalBuffer(a),c=i.getMeshData(a),h=i.getUVBuffer(a);void 0!=s&&void 0!=l?(void 0!==c.baseScale&&0!==c.baseScale&&(s=new Float32Array(s),r.identity(),r.setPosition(new THREE.Vector3(c.baseX,c.baseY,c.baseZ)),r.scale(new THREE.Vector3(c.baseScale,c.baseScale,c.baseScale)),CLOUD.GeomUtil.applyMatrix4ToBuffer(r,s)),this.descriptor.cacheReferencedMeshBufferData(c.mesh_id,{P:s,I:l,N:u,UV:h}),this.descriptor.cacheReferencedMeshMpkIds(t,c.mesh_id)):CLOUD.Logger.log("Error Geometry!")}i=null}},{key:"_loadBorderline",value:function(e){var t=this,n=this.url,i=this.fileLoader,r=e?n.borderLineUrl(1):n.borderLineUrl(0);i.setResponseType("arraybuffer"),i.load(r,function(n){t._parseBorderLine(n,e),t._onTaskFinished()},void 0,function(e){t.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t._onTaskFinished()})}},{key:"_parseBorderLine",value:function(e,t){for(var n=new CLOUD.Loader.LineReader(e),i=[],r=0,a=n.header.lineCount;r<a;++r){var o=n.getLineData(r);i.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:n.ptBuffer,I:n.idxBuffer,IndexInfos:i}),n=null}},{key:"_isLoadMpkBorderlines",value:function(){var e=this.model.getConfig().metadata;return!(!CLOUD.GlobalData.BorderLineBatched||!e.outline_mpk)}},{key:"getAllBorderlineCount",value:function(){var e=this.model.getConfig().metadata;return this._isLoadMpkBorderlines()?e.outline_mpk:e.outline_0+e.outline_1}},{key:"_loadAllBorderlines",value:function(e){this._isLoadMpkBorderlines()?e.outline_mpk&&this._loadAllMpkBorderLines(e.outline_mpk):(e.outline_0&&this._loadBorderline(!1),e.outline_1&&this._loadBorderline(!0))}},{key:"delayLoadBorderlines",value:function(e){this._isLoadMpkBorderlines()?this._delayLoadMpkBorderlines(e):this._delayLoadTogetherBorderlines(e)}},{key:"_delayLoadMpkBorderlines",value:function(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_mpk,t.outline_mpk&&this._loadAllMpkBorderLines(t.outline_mpk)}},{key:"_delayLoadTogetherBorderlines",value:function(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_0+t.outline_1,t.outline_0&&this._loadBorderline(!1),t.outline_1&&this._loadBorderline(!0)}},{key:"_loadAllMpkBorderLines",value:function(e){this.mpkBorderLineTaskManager||(this.mpkBorderLineTaskManager=new CLOUD.TaskManager);for(var t=0;t<e;++t)this.mpkBorderLineTaskManager.addTask(t);this.mpkBorderLineTaskManager.processTasks(this._loadMpkBorderLine.bind(this))}},{key:"_loadMpkBorderLine",value:function(e,t){var n=this,i=this.fileLoader,r=this.url,a=this.model.getConfig().metadata,o=a.mpk_shared_index,s=e>=o;i.setResponseType("arraybuffer"),i.load(r.mpkBorderLineUrl(e),function(e){n._parseMpkBorderLine(e,s),t(),n._onTaskFinished()},void 0,function(e){n._onTaskFinished()})}},{key:"_parseMpkBorderLine",value:function(e,t){for(var n=new CLOUD.Loader.LineReader(e),i=[],r=0,a=n.header.lineCount;r<a;++r){var o=n.getLineData(r);i.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:n.ptBuffer,I:n.idxBuffer,IndexInfos:i}),n=null}},{key:"dealProgressSegment",value:function(e,t){return CLOUD.GlobalData.BatchMergeEnabled?t*e.progressPercentage.load:t}}]),e}();CLOUD.ModelView.BaseLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=null,n}return _inherits(t,e),_createClass(t,[{key:"loadSceneAndMpks",value:function(e){e.symbol&&this._loadSymbol(),this._loadScene(0),e.lines&&this._loadLine(),e.mpks&&this._loadAllMpks(e.mpks),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=e.scenes;return t+=e.symbol,t+=e.lines,t+=e.mpks,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.DefaultBaseLoader=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.defaultManager=null,this.instancedManager=null,this.loader=null,this.loaded=!1,this.dataReady=!1,this.borderlinesLoaded=!1,this.borderlinesGenerated=!1}return _createClass(e,[{key:"destroy",value:function(){this.model=null,this.defaultManager.destroy(),this.defaultManager=null,this.instancedManager.destroy(),this.instancedManager=null,this.loader&&(this.loader.destroy(),this.loader=null)}},{key:"load",value:function(e){var t=this,n=this.model;this.loader.setNotifyProgress(e),this.loader.load(function(){n.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START})},function(e){n.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:e})},function(){t.prepareData(function(){t.processLoadCompleted(function(){n.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE})})})})}},{key:"processLoadCompleted",value:function(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.updateOctreeNode();var n=t.getFilter(),i=t.manager.getNodeInfos();n.initFilterManager(i),requestAnimationFrame(function(){t.setLoaded(!0),e&&e(),t.updateMeshNodes(),t.applyFilter(),t.debut(t)})}},{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().parseItemData(function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepareWireframe",value:function(e,t){if(e.isActivateWireframe())if(CLOUD.GlobalData.BorderLineDelayLoaded&&this.loader.getAllBorderlineCount())if(this.borderlinesLoaded)this.borderlinesGenerated&&(this.defaultManager.asyncGenerateWireframe(e),this.instancedManager.generateWireframe(e));else{this.borderlinesLoaded=!0;var n=this;this.loader.delayLoadBorderlines(function(){n.instancedManager.generateWireframe(e),n.defaultManager.asyncGenerateWireframe(e,function(){n.borderlinesGenerated=!0,t&&t()})})}else this.defaultManager.generateWireframe(e),this.instancedManager.generateWireframe(e)}},{key:"prepare",value:function(e){}},{key:"needUpdate",value:function(){return!0}},{key:"updateNodes",value:function(){this.needUpdate()&&(this.defaultManager.updateNodes(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.updateNodes(this.model))}},{key:"isLoaded",value:function(){return this.loaded}},{key:"isDataReady",value:function(){return this.loaded}},{key:"isAllReady",value:function(){return!0}},{key:"isHidden",value:function(){var e=this.model;return!e.visible&&(e.manager.scene.removeObjectGroupByName(e._getWireframeGroupName()),!0)}},{key:"settleData",value:function(e){}},{key:"addNodeInfoToOctantMap",value:function(){}},{key:"applyFilter",value:function(){this.isLoaded()&&(this.defaultManager.applyFilter(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyFilter(this.model))}},{key:"applySelection",value:function(){this.isLoaded()&&(this.defaultManager.applySelection(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applySelection(this.model))}},{key:"clearSelection",value:function(){this.isLoaded()&&(this.defaultManager.clearSelection(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.clearSelection(this.model))}},{key:"applyHover",value:function(){this.isLoaded()&&(this.defaultManager.applyHover(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyHover(this.model))}},{key:"clearHover",value:function(){this.isLoaded()&&(this.defaultManager.clearHover(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.clearHover(this.model))}},{key:"applyBlink",value:function(){this.isLoaded()&&(this.defaultManager.applyBlink(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyBlink(this.model))}},{key:"clearBlink",value:function(){this.isLoaded()&&(this.defaultManager.clearBlink(this.model),
CLOUD.GlobalData.Instance&&this.instancedManager.clearBlink(this.model))}},{key:"applyReplacement",value:function(){this.isLoaded()&&(this.defaultManager.applyReplacement(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyReplacement(this.model))}},{key:"getMeshesByUserIds",value:function(e,t){this.isLoaded()&&(this.defaultManager.getMeshesByUserIds(this.model,e,t),CLOUD.GlobalData.Instance&&(this.instancedManager.getMeshesByUserId(this.model,e),this.instancedManager.getMeshesByUserId(this.model,t)))}},{key:"rebuildIndicesforLightmap",value:function(){this.defaultManager.rebuildIndices(this.model)}},{key:"adjustVisibility",value:function(e){this.defaultManager.adjustVisibility(this.model,e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){this.defaultManager.changeVisibilityOfSelectedObjects(this.model,e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){this.defaultManager.changeVisibilityOfNonSelectedObjects(this.model,e)}},{key:"adjustInstanceVisibility",value:function(e){this.instancedManager.adjustVisibility(this.model,e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){this.instancedManager.changeVisibilityOfSelectedObjects(this.model,e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){this.instancedManager.changeVisibilityOfNonSelectedObjects(this.model,e)}},{key:"restoreVisibilityOfObjects",value:function(){this.defaultManager.restoreVisibilityOfObjects(),this.instancedManager.restoreVisibilityOfObjects()}},{key:"getBlinkMaterials",value:function(){var e=[],t=this.model.materialManager.instanceMaterials;for(var n in t)for(var i=t[n],r=0,a=i.length;r<a;r++)e.push(i[r]);return e=e.concat(this.defaultManager.meshManager.getBlinkMaterials())}},{key:"disposeBufferAfterVbo",value:function(){this.isLoaded()&&(this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo())}},{key:"getGeometryBuffersByUserId",value:function(e){if(!this.isLoaded())return[];var t=[];return t=t.concat(this.defaultManager.getGeometryBuffersByUserId(this.model,e)),t=t.concat(this.instancedManager.getGeometryBuffersByUserId(this.model,e))}},{key:"explode",value:function(){this.isLoaded()&&(this.defaultManager.explode(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.explode(this.model))}},{key:"calculateClippingIds",value:function(){if(this.isLoaded()&&CLOUD.GlobalData.BatchMergeEnabled){var e=CLOUD.FillClipPlaneManager.getInstance(this.model.manager.scene),t=e.renderClipPlane;this.defaultManager.calculateClippingIds(t,e.capsIntersectPosition),CLOUD.GlobalData.Instance&&this.instancedManager.calculateClippingIds(t,e.capsIntersectPosition),e.addToCapsWireframe(this.model)}}},{key:"isHiddenNode",value:function(e){return this.defaultManager.isHiddenNode(e)||this.defaultManager.isHiddenNode(e)}}]),e}();CLOUD.ModelView.ModelBaseHandler=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),_createClass(t,[{key:"parseItemData",value:function(e){var t=this.getSceneReaderMap();for(var n in t)for(var i=t[n],r=0,a=i.header.cellCount;r<a;++r)for(var o=i.getCellInfo(r),s=o.itemIndex;s<o.itemCount;++s)this._readItemData(i,s,r);e&&e()}},{key:"asyncParseItemData",value:function(e){for(var t=this.getSceneReaderMap(),n=Object.keys(t),i=n.length,r=0,a=this,o=0;o<i;o++){var s=(n[o],t[n[o]]);CLOUD.Utils.asyncProcess(s,s.header.cellCount,100,function(e,t){a._parseItemDataBy(e,t)},function(){++r===i&&e&&e()})}}},{key:"_parseItemDataBy",value:function(e,t){for(var n=e.getCellInfo(t),i=n.itemIndex;i<n.itemCount;++i)this._readItemData(e,i,t)}},{key:"parseItemDataByCellId",value:function(e){var t=this.getSceneReaderMap();for(var n in t)this._parseItemDataBy(t[n],e)}},{key:"_readItemData",value:function(e,t,n){var i=e.getItemInfo(t);void 0!==i&&(i.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL?this._readSymbolInfo(e,n,i):this._readMeshInfo(e,n,i,null))}},{key:"_readSymbolInfo",value:function(e,t,n){var i=this.symbolReader;if(i){var r=i.header.symbolCount,a=n.toData,o=e.getMatrixInfo(n.matrixId).matrix.clone(),s={matrix:o,ItemId:n.ItemId,originalId:n.originalId,userDataId:n.userDataId,materialId:n.materialId};if(a>=0&&a<r)for(var l=i.getSymbolInfo(a),u=l.itemIndex;u<l.itemCount;++u){var c=i.getItemInfo(u);c.type!==CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL&&this._readMeshInfo(i,t,c,s)}o=null,s=null,i=null}}},{key:"_readMeshInfo",value:function(e,t,n,i){var r,a,o;null===i?(r=n.userDataId,a=n.originalId,o=n.materialId):(r=i.userDataId,a=i.originalId,o=i.materialId>-1?i.materialId:n.materialId);var s=null,l=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType;switch(n.type){case l.MESH:s=this._getMeshNodeAttr(e,n,i);break;case l.TUBE:s=this._getMeshNodeAttrOfTube(e,n,i);break;case l.PIPE:s=this._getMeshNodeAttrOfPipe(e,n,i);break;case l.BOX:s=this._getMeshNodeAttrOfBox(e,n,i);break;case l.BOX_M:s=this._getMeshNodeAttrOfBoxM(e,n,i);break;case l.PIPE_M:s=this._getMeshNodeAttrOfPipeM(e,n,i);break;case l.MESH_REF:s=this._getMeshNodeAttrOfMeshRef(e,n,i);break;case l.LINE:s=this._getLineNodeAttr(e,n,i)}if(s){if(s.userId=this.userIdReader?this.userIdReader.getString(a):a,s.userData=this.userDataReader?this.userDataReader.getUserData(r):null,s.name=s.userId,s.type=n.type,s.cellId=t,s.materialId=o,s.state=CLOUD.EnumObjectState.Visible,s.material=null,this.lightmap){var u=n.ItemId;i&&(u=i.ItemId+"_"+n.ItemId),s.itemIdUV2=u}s.parameterizedDesc=this._isRegularShape(s),s.instanceOrNot=this._isInstancedNode(s),this._classifyNodeInfo(s),s=null}}},{key:"_getMeshNodeAttrOfPipe",value:function(e,t,n){var i=e.getMatrixInfo(t.matrixId).matrix.clone();n&&i.multiplyMatrices(n.matrix,i);var r=t.boundingBox.clone();r.applyMatrix4(i);var a=e.getGeomPipeInfo(t.toData),o=a.startPt,s=a.endPt,l=new THREE.Vector3;l.subVectors(s,o);var u=l.length();l.normalize();var c=a.radius;c<=1&&(c=100);var h=new THREE.Vector3(0,1,0),d=new THREE.Vector3(c,u,c),f=(new THREE.Quaternion).setFromUnitVectors(h,l),p=o.clone().addScaledVector(l,.5*u),m=(new THREE.Matrix4).compose(p,f,d);return i.multiply(m),a=null,{nodeId:(n?n.ItemId+"_"+t.ItemId:t.ItemId)+"_pipe",geometryId:"pipe",boundingBox:r,matrix:i}}},{key:"_getMeshNodeAttrOfTube",value:function(e,t,n){var i=this._getMeshNodeAttrOfPipe(e,t,n);return i.nodeId+="_tube",i.geometryId="tube",i}},{key:"_getMeshNodeAttrOfBox",value:function(e,t,n){var i=e.getMatrixInfo(t.matrixId).matrix.clone();n&&i.multiplyMatrices(n.matrix,i);var r=t.boundingBox.clone();r.applyMatrix4(i);var a=t.boundingBox,o=a.getSize(),s=a.getCenter(),l=(new THREE.Matrix4).scale(new THREE.Vector3(o.x,o.y,o.z));return l.setPosition(s),i.multiply(l),{nodeId:(n?n.ItemId+"_"+t.ItemId:t.ItemId)+"_box",geometryId:"box",boundingBox:r,matrix:i}}},{key:"_getMeshNodeAttrOfBoxM",value:function(e,t,n){var i=e.getMatrixInfo(t.matrixId).matrix.clone();n&&i.multiplyMatrices(n.matrix,i);var r=t.boundingBox.clone();return r.applyMatrix4(i),{nodeId:(n?n.ItemId+"_"+t.ItemId:t.ItemId)+"_boxM",geometryId:"boxM",boundingBox:r,matrix:i,uvArrayBuffer:e.getGeomBoxUvInfo(t.toData)}}},{key:"_getMeshNodeAttrOfPipeM",value:function(e,t,n){var i=e.getMatrixInfo(t.matrixId).matrix.clone();n&&i.multiplyMatrices(n.matrix,i);var r=t.boundingBox.clone();return r.applyMatrix4(i),{nodeId:(n?n.ItemId+"_"+t.ItemId:t.ItemId)+"_pipeM",geometryId:"pipeM",boundingBox:r,matrix:i,uvArrayBuffer:e.getGeomPipeUvInfo(t.toData)}}},{key:"_getMeshNodeAttrOfMeshRef",value:function(e,t,n){var i=e.getMatrixInfo(t.matrixId).matrix.clone();n&&i.multiplyMatrices(n.matrix,i);var r=t.boundingBox.clone();return r.applyMatrix4(i),{nodeId:"refMesh|"+(n?n.ItemId+"_"+t.ItemId:t.ItemId),geometryId:t.toData,boundingBox:r,matrix:i}}},{key:"_getMeshNodeAttr",value:function(e,t,n){var i,r=t.boundingBox.clone();return-1!==t.matrixId?(i=e.getMatrixInfo(t.matrixId).matrix.clone(),n&&i.multiplyMatrices(n.matrix,i),r.applyMatrix4(i)):(i=new THREE.Matrix4,n&&r.applyMatrix4(n.matrix)),{nodeId:n?n.ItemId+"_"+t.ItemId:t.ItemId,geometryId:t.toData,boundingBox:r,matrix:i}}},{key:"_getLineNodeAttr",value:function(e,t,n){var i,r=t.boundingBox.clone();return-1!==t.matrixId?(i=e.getMatrixInfo(t.matrixId).matrix.clone(),n&&i.multiplyMatrices(n.matrix,i),r.applyMatrix4(i)):(i=new THREE.Matrix4,n&&r.applyMatrix4(n.matrix)),{nodeId:n?"line-"+n.ItemId+"-"+t.ItemId:"line-"+t.ItemId,geometryId:"line-"+t.toData,boundingBox:r,matrix:i}}}]),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.DefaultDescriptor=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.DefaultDescriptor,n}return _inherits(t,e),t}(CLOUD.ModelView.DefaultBaseLoader);CLOUD.ModelView.DefaultLoader=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=null,this.wireframeManager=null}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getInstanceGeometries",value:function(){return this.meshManager.instanceGeometryMap}},{key:"traverseInstanceGeometryMap",value:function(e){this.meshManager.traverseInstanceGeometryMap(e)}},{key:"getCachedInstanceData",value:function(){return this.meshManager.cachedInstance}},{key:"getBufferAttributesBy",value:function(e){return this.meshManager.getBufferAttributesBy(e)}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}},{key:"traverseNodeIdxMap",value:function(e,t){this.meshManager.traverseNodeIdxMap(e,t)}},{key:"getMeshesByUserId",value:function(e,t){this.meshManager.getMeshesByUserId(e,t)}},{key:"_updateInstanceMaterialByUserId",value:function(e,t,n,i){this.meshManager.updateInstanceStateByUserId(e,t,n,i)}},{key:"_updateInstanceMaterialForWireFrameByUserId",value:function(e,t,n,i){this.wireframeManager.updateInstanceWireframeByUserId(e,t,n,i)}},{key:"_updateInstanceMaterial",value:function(e){CLOUD.Logger.time("update instance material");var t=CLOUD.Model.EnumFilterState;this.clearSelectedObjectIds();for(var n in this.filteredIds){var i=this.filteredIds[n];if(i[t.HIDDEN])this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.HIDDEN),this._updateInstanceMaterialForWireFrameByUserId(e,n,CLOUD.EnumInstanceState.HIDDEN);else if(i[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(i[t.SELECTED]){CLOUD.GlobalData.PickingEffect?i[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.OVERRIDED,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.SELECTED);continue}if(i[t.BLINK]){i[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK);continue}}else{if(i[t.BLINK]){i[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK);continue}if(i[t.SELECTED]){CLOUD.GlobalData.PickingEffect?i[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.OVERRIDED,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.SELECTED);continue}}i[t.HOVER]?i[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.HOVER,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.HOVER):i[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.OVERRIDED,i[t.OVERRIDED])}}this._updateInstanceMaterialForWireFrame(e),CLOUD.Logger.timeEnd("update instance material")}},{key:"_updateInstanceMaterialForWireFrame",value:function(e){var t=this.mapFilteredUserIdsForWireFrame;if(t)for(var n=Object.keys(t),i=0,r=n.length;i<r;i++){var a=n[i];this.filteredIds&&this.filteredIds[a]&&this.filteredIds[a][CLOUD.Model.EnumFilterState.HIDDEN]||this._updateInstanceMaterialForWireFrameByUserId(e,a,CLOUD.EnumInstanceState.OVERRIDED,t[a])}}},{key:"_resetInstanceMaterial",value:function(){this.meshManager.resetInstanceMaterial(),this.wireframeManager.resetInstanceMaterial()}},{key:"_collectFilteredUserIds",value:function(e,t,n){var i=e.getFilter(),r=i._hasHiddenFileIdFilter(),a=i._hasVisibleFilter(),o=i._hasOverrideMaterialFilter(),s=i._hasTransparentFilter(),l=e.hasReplacedUserId(),u=e.hasHiddenSourceObjectUserId(),c=this.filteredIds={};if(r||a||o||s||l||u)for(var h=CLOUD.Model.EnumFilterState,d=0;d<t.length;++d){var f=t[d],p=n[f];if(p&&p.length){var m=p[0];if(r&&i._isHiddenFileId(m)||a&&!1===i._isVisible(m)||e.isReplacedUserId(f)||e.isHiddenSourceObjectUserId(f))c[f]||(c[f]={}),c[f][h.HIDDEN]=!0;else if(s&&i._isTransparent(m))c[f]||(c[f]={}),c[f][h.TRANSPARENT]=!0;else if(o&&i._hasOverrideMaterial(m)){var g=i._getOverrideMaterial(m),v=null!=g?g.name:"";""!==v&&(c[f]||(c[f]={}),c[f][h.OVERRIDED]=v)}else;}}}},{key:"_collectFilteredUserIdsForWireFrame",value:function(e,t,n){var i=e.getFilter(),r=i._hasOverrideMaterialFilterForWireFrame();if(this.mapFilteredUserIdsForWireFrame={},r)for(var a=CLOUD.Model.EnumFilterState,o=0;o<t.length;++o){var s=t[o];if(!(this.filteredIds&&this.filteredIds[s]&&this.filteredIds[s][a.HIDDEN])){var l=n[s];if(l&&l.length){var u=l[0];if(i._hasOverrideMaterialForWireFrame(u)){var c=i._getOverrideMaterialForWireFrame(u),h=null!=c?c.name:"";""!==h&&(this.mapFilteredUserIdsForWireFrame[s]=h)}}}}}},{key:"_collectSelectedUserIds",value:function(e,t){var n=this.filteredIds=this.filteredIds||{},i=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(n[a]||(n[a]={}),n[a][i.SELECTED]=!0,r[a]=!0);this.selectedUserIds=Object.keys(r)}},{key:"_clearSelectedState",value:function(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,n=this.selectedUserIds.length;t<n;t++){var i=this.selectedUserIds[t];this.filteredIds[i]&&(this.meshManager.clearInstanceStateByUserId(i),delete this.filteredIds[i][CLOUD.Model.EnumFilterState.SELECTED])}this.selectedUserIds=null}}},{key:"_collectHoveredUserIds",value:function(e,t){var n=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(n[e]||(n[e]={}),n[e][CLOUD.Model.EnumFilterState.HOVER]=!0,this.hoverdUserId=e)}},{key:"_clearHoveredState",value:function(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][CLOUD.Model.EnumFilterState.HOVER],this.hoverdUserId=void 0)}},{key:"_collectBlinkedUserIds",value:function(e,t){var n=this.filteredIds=this.filteredIds||{},i=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(n[a]||(n[a]={}),n[a][i.BLINK]=!0,r[a]=!0);this.blinkUserIds=Object.keys(r)}},{key:"_clearBlinkedState",value:function(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,n=this.blinkUserIds.length;t<n;t++){var i=this.blinkUserIds[t];this.filteredIds[i]&&(this.meshManager.clearInstanceStateByUserId(i),delete this.filteredIds[i][CLOUD.Model.EnumFilterState.BLINK])}this.blinkUserIds=null}}},{key:"applyFilter",value:function(e,t){if(this.hasNodeInfo(e)){this.updateNodes(e),this._resetInstanceMaterial();var n;n=t||e.getModelDescriptor().getInstancedUserIds();var i=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,n,i),this._collectFilteredUserIdsForWireFrame(e,n,i),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,i),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),i),this._collectHoveredUserIds(e.manager.sceneState.hoverId,i),this._updateInstanceMaterial(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getInstancedNodeInfos()}},{key:"updateNodes",value:function(e){this.hasNodeInfo(e)&&(this.meshManager.updateNodes(e),this.wireframeManager.updateNodes(e))}},{key:"generateWireframe",value:function(e,t){this.wireframeManager.generateWireframe(e,t)}},{key:"createMeshNodes",value:function(e,t){this.meshManager.createMeshNodes(e,t)}},{key:"clearCachedData",value:function(){this.meshManager.disposeGeometries()}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"clearSelectedObjectIds",value:function(){this.meshManager.clearSelectedObjectIds()}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"addAllInstanceNodeToScene",value:function(e){this.meshManager.addAllInstanceNodeToScene(e)}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.meshManager.explode(e)}},{key:"calculateClippingIds",value:function(e,t){this.meshManager.calculateClippingIds(e,t)}},{key:"isPickableNode",value:function(e){if(!this.filteredIds||!this.filteredIds[e])return!0;var t=this.filteredIds[e],n=CLOUD.Model.EnumFilterState;return!t[n.HIDDEN]&&!t[n.TRANSPARENT]}},{key:"isHiddenNode",value:function(e){return!!(this.filteredIds&&this.filteredIds[e]&&this.filteredIds[e][CLOUD.Model.EnumFilterState.HIDDEN])}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}}]),e}();CLOUD.ModelView.InstancedBaseManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.manager=e,n.instanceGeometryMap={},n.bufferAttributeMap={},n.instanceNodeMap={},n.nodeIdxMapFromUserId={},n.matrixInfoMapFromUserId={},n.cachedInstance={vState:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},muvCol2:{},uv2OffsetRepeat:{},uv2:{}},n.selectedMeshes=[],n.nonSelectedMeshes=[],n.selectedObjectIds=[],n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.cachedInstance=null,this.instanceNodeMap=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null)}},{key:"clearData",value:function(){this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache(),this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData()}},{key:"clearInstanceCache",value:function(){this.cachedInstance.vState={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.muvCol2={},this.cachedInstance.uv2OffsetRepeat={},this.cachedInstance.uv2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceNodeMap={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}},{key:"updateNodes",value:function(e){var t=this._getNodeGroup(e);e.isOnlyWireframe()?t.visible=!1:t.visible=!0}},{key:"createMeshNodes",value:function(e,t){this._createInstanceGeometries(e,t),this._makeInstanceNodes(e)}},{key:"_createInstanceGeometries",value:function(e,t){var n=this;e.getModelDescriptor().traverseInstancedNodeInfos(t,function(t,i){for(var r=0,a=i.length;r<a;r++){var o=i[r],s=n.getGeometryByNodeInfo(e,o),l=e.manager.getOverrideMaterialByNodeInfo(o);if(l&&(o.materialId=l.name),e.lightmap){var u=e.getLoader().getInstanceUV2InfoById(o.itemIdUV2);o.uv2Info=u,o.materialId=o.uv2Info?o.materialId+"_"+o.uv2Info.lightmapIdx:o.materialId}var c=n.getMeshIdByNodeInfo(o),h=n.cacheInstanceAttributeStateBy(e,c,s,o,l);n.cacheNodeIdxByUserId(o.userId,c,h),n.cacheMatrixInfoByUserId(o.userId,c,{matrix:o.matrix,boundingBox:o.boundingBox}),n.cacheInstanceGeometries(c,s,o.uv2Info,e)}})}},{key:"getBufferAttributesBy",value:function(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance,n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,1),i=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,1),r=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol3[e]),3,1),o=[],s=[],l=[];if(t.muvCol0[e])for(var u=0,c=t.muvCol0[e].length;u<c;u++)o.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][u]),2,1)),s.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][u]),2,1)),l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol2[e][u]),2,1));var h=new THREE.InstancedBufferAttribute(new Float32Array(t.uv2OffsetRepeat[e]),4,1);new THREE.BufferAttribute(t.uv2[e],2);return this.bufferAttributeMap[e]={attributeMcol0:n,attributeMcol1:i,attributeMcol2:r,attributeMcol3:a,attributeMuvCol0Array:o,attributeMuvCol1Array:s,attributeMuvCol2Array:l,attributeUv2OffsetRepeat:h},this.bufferAttributeMap[e]}},{key:"_addInstanceNodeToScene",value:function(e,t,n){this._getNodeGroup(e).add(n),n.updateMatrixWorld(!0),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t,new CLOUD.InstancedCapsuleObject(t,n))}},{key:"addAllInstanceNodeToScene",value:function(e){this.traverseInstanceNodeMap(null,function(t,n){for(var i=0,r=n.length;i<r;i++)e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t,new CLOUD.InstancedCapsuleObject(t,n[i]))})}},{key:"_makeInstanceNodeById",value:function(e,t,n){var i=this.cachedInstance,r=e.materialManager,a=this.getMaterialIdByMeshId(t),o=this.getBufferAttributesBy(t),s=r.getInstanceMaterialById(a,e);this.instanceNodeMap[t]||(this.instanceNodeMap[t]=[]);for(var l=this.instanceNodeMap[t],u=0,c=n.length;u<c;u++){n[u].addAttribute("mcol0",o.attributeMcol0),n[u].addAttribute("mcol1",o.attributeMcol1),n[u].addAttribute("mcol2",o.attributeMcol2),n[u].addAttribute("mcol3",o.attributeMcol3),e.lightmap&&n[u].addAttribute("uv2OffsetRepeat",o.attributeUv2OffsetRepeat),o.attributeMuvCol0Array.length>0&&(n[u].addAttribute("muvCol0",o.attributeMuvCol0Array[u]),n[u].addAttribute("muvCol1",o.attributeMuvCol1Array[u]),n[u].addAttribute("muvCol2",o.attributeMuvCol2Array[u])),n[u].addAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(i.vColor[t]),4,1)),n[u].addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),1,1)),n[u].addAttribute("vState2",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),1,1));var h=n[u].getAttribute("vState").array,d=n[u].getAttribute("vState2").array;h.fill(CLOUD.EnumInstanceState.NONE),d.fill(CLOUD.EnumInstanceState.HIDDEN);var f=n[u].index;n[u].addGroup(0,f.count,0),n[u].addGroup(0,f.count,1);var p=new CLOUD.MeshEx(n[u],s);p.alive=!0,p.databagId=e.databagId,p.frustumCulled=!1,l.push(p),this._addInstanceNodeToScene(e,t,p)}}},{key:"_makeInstanceNodes",value:function(e){var t=this;this.traverseInstanceGeometryMap(function(n,i){t._makeInstanceNodeById(e,n,i)})}},{key:"resetInstanceMaterial",value:function(){this.traverseInstanceGeometryMap(function(e,t){for(var n=0,i=t.length;n<i;++n)t[n].getAttribute("vState").array.fill(CLOUD.EnumInstanceState.NONE),t[n].getAttribute("vState").needsUpdate=!0,t[n].getAttribute("vState2").array.fill(CLOUD.EnumInstanceState.HIDDEN),t[n].getAttribute("vState2").needsUpdate=!0})}},{key:"clearInstanceStateByUserId",value:function(e){function t(e,t,n,i){for(var r=e.getAttribute("vState").array,a=e.getAttribute("vState2").array,o=0;o<t.length;++o){var s=t[o];r[s]=n,a[s]=i}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0}var n=this,i=CLOUD.EnumInstanceState.NONE,r=CLOUD.EnumInstanceState.HIDDEN;this.traverseNodeIdxMapByUserId(e,function(e,a){var o=n.getInstanceGeometries(e);if(o)for(var s=0,l=o.length;s<l;s++)t(o[s],a,i,r)})}},{key:"updateInstanceStateByUserId",value:function(e,t,n,i){function r(e,t,n,i,r){for(var a=e.getAttribute("vState").array,o=e.getAttribute("vState2").array,s=e.getAttribute("aColor"),l=s?s.array:null,u=0;u<t.length;++u){var c=t[u];a[c]=n,o[c]=i,null!==l&&null!==r&&(l[4*c]=r[0],l[4*c+1]=r[1],l[4*c+2]=r[2],l[4*c+3]=r[3])}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0,s&&(s.needsUpdate=!0)}var a=e.materialManager,o=this;this.traverseNodeIdxMapByUserId(t,function(s,l){var u=o.getInstanceGeometries(s);if(u){var c=o.getOriginalMaterialIdByMeshId(s),h=o.getUsableMaterialColorParamsBy(e,c,n,i),d=h.rgbaColor,f=n;n===CLOUD.EnumInstanceState.TRANSPARENT&&(f=CLOUD.EnumInstanceState.OVERRIDED),n===CLOUD.EnumInstanceState.SELECTED&&o.cacheSelectedObjectIds(t,s);var p,m,g=o.getMaterialIdByMeshId(s),v=a.getInstanceMaterialById(g,e)[0];v.transparent===h.transparent?(p=f,m=CLOUD.EnumInstanceState.HIDDEN):(p=CLOUD.EnumInstanceState.HIDDEN,m=f),f===CLOUD.EnumInstanceState.BLINK&&v.setBlinkColor(e.manager.getBlinkColor());for(var y=0,E=u.length;y<E;y++)r(u[y],l,p,m,d)}})}},{key:"getUsableMaterialColorParamsBy",value:function(e,t,n,i){var r,a,o=e.selectedMaterial,s=e.getFilter()._getMaterialByName("scene"),l=e.materialManager,u=e.manager.getOverrideMaterialByName(t),c=u||l.getMaterialById(t);switch(n){case CLOUD.EnumInstanceState.HOVER:i?(r=e.getFilter()._getMaterialByName(i),a=e.manager.sceneState.getHoverColorByMaterial(r)):a=e.manager.sceneState.getHoverColorByMaterial(c);break;case CLOUD.EnumInstanceState.SELECTED:a=CLOUD.MaterialUtil.getColorParamsByMaterial(o);break;case CLOUD.EnumInstanceState.TRANSPARENT:a=CLOUD.MaterialUtil.getColorParamsByMaterial(s);break;case CLOUD.EnumInstanceState.OVERRIDED:case CLOUD.EnumInstanceState.BLINK:i?(r=e.getFilter()._getMaterialByName(i),a=CLOUD.MaterialUtil.getColorParamsByMaterial(r)):a=CLOUD.MaterialUtil.getColorParamsByMaterial(c);break;default:a=CLOUD.MaterialUtil.getColorParamsByMaterial(c)}return a}},{key:"getInstanceNodesById",value:function(e){return this.instanceNodeMap[e]}},{key:"traverseInstanceNodeMap",value:function(e,t){var n=this.instanceNodeMap;e=e||Object.keys(this.instanceNodeMap);for(var i=0,r=e.length;i<r;i++){var a=e[i];t(a,n[a])}}},{key:"getInstanceGeometries",value:function(e){return this.instanceGeometryMap[e]}},{key:"cacheInstanceGeometries",value:function(e,t,n,i){if(!this.instanceGeometryMap[e]){var r=this.instanceGeometryMap[e]=[];t instanceof Array||(t=[t]);for(var a=n?n.byteOffset:0,o=0,s=t.length;o<s;++o)if(r[o]=new THREE.InstancedBufferGeometry,r[o].setIndex(t[o].index),r[o].addAttribute("position",t[o].attributes.position),r[o].addAttribute("normal",t[o].attributes.normal),r[o].addAttribute("uv",t[o].attributes.uv),n){var l=2*t[o].index.count,u=i.getLoader().getInstanceUV2ById(a,l);r[o].addAttribute("uv2",new THREE.Float32BufferAttribute(u,2)),a+=2*l}}}},{key:"traverseInstanceGeometryMap",value:function(e){var t=this.instanceGeometryMap;for(var n in t)e(n,t[n])}},{key:"disposeInstanceGeometries",value:function(){this.traverseInstanceGeometryMap(function(e,t){for(var n=0,i=t.length;n<i;n++)t[n].dispose()})}},{key:"cacheInstanceAttributeStateBy",value:function(e,t,n,i,r){var a=i.uv2Info?CLOUD.Utils.splitCombinedKeyString(i.materialId,"_")[0]:i.materialId,o=i.uvArrayBuffer;n instanceof Array||(n=[n]);var s=n.length,l=this.cachedInstance;if(!l.vState[t]){l.vState[t]=[],l.vColor[t]=[],l.mcol0[t]=[],l.mcol1[t]=[],l.mcol2[t]=[],l.mcol3[t]=[],l.muvCol0[t]=[],l.muvCol1[t]=[],l.muvCol2[t]=[];for(var u=0;u<s;++u)l.muvCol0[t][u]=[],l.muvCol1[t][u]=[],l.muvCol2[t][u]=[];i.uv2Info&&(l.uv2OffsetRepeat[t]=[])}var c=r||e.materialManager.getMaterialById(a);l.vColor[t].push(c.color.r,c.color.g,c.color.b,c.opacity),l.vState[t].push(0);var h=i.matrix.elements;if(l.mcol0[t].push(h[0],h[1],h[2]),l.mcol1[t].push(h[4],h[5],h[6]),l.mcol2[t].push(h[8],h[9],h[10]),l.mcol3[t].push(h[12],h[13],h[14]),i.uv2Info){var d=i.uv2Info.offsetRepeat;l.uv2OffsetRepeat[t].push(d[0],d[1],d[2],d[3])}if(o)for(var u=0;u<s;++u)l.muvCol0[t][u].push(o[6*u],o[6*u+1]),l.muvCol1[t][u].push(o[6*u+2],o[6*u+3]),l.muvCol2[t][u].push(o[6*u+4],o[6*u+5]);else for(var u=0;u<s;++u)l.muvCol0[t][u].push(1,0),l.muvCol1[t][u].push(0,1),l.muvCol2[t][u].push(0,0);return l.vState[t].length-1}},{key:"cacheNodeIdxByUserId",value:function(e,t,n){var i=this.nodeIdxMapFromUserId;i[e]||(i[e]={}),i[e][t]||(i[e][t]=[]),i[e][t].push(n)}},{key:"getNodeIdxMapByUserId",value:function(e){return this.nodeIdxMapFromUserId[e]}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){var n=this.nodeIdxMapFromUserId[e];for(var i in n)t(i,n[i])}},{key:"traverseNodeIdxMap",value:function(e,t){for(var n=Object.keys(this.nodeIdxMapFromUserId),i=0,r=n.length;i<r;i++){var a=n[i],o=this.nodeIdxMapFromUserId[a];if(!t||!t(a))for(var s in o)e(s,o[s])}}},{key:"cacheMatrixInfoByUserId",value:function(e,t,n){var i=this.matrixInfoMapFromUserId;i[e]||(i[e]={}),i[e][t]||(i[e][t]=[]),i[e][t].push(n)}},{key:"traverseMatrixInfoMapByUserId",value:function(e,t){var n=this.matrixInfoMapFromUserId[e];for(var i in n)t(i,n[i])}},{key:"getMeshesByUserId",value:function(e,t){var n=this;this.traverseMatrixInfoMapByUserId(t,function(i,r){for(var a=n.getInstanceNodesById(i),o=0,s=r.length;o<s;o++)for(var l=0,u=a.length;l<u;l++){var c={};if(c.matrix=r[o].matrix,c.mesh=a[l],1===u)c.boundingBox=r[o].boundingBox;else{var h=c.mesh.geometry.boundingBox;h?h=h.clone():(c.mesh.geometry.computeBoundingBox(),h=c.mesh.geometry.boundingBox.clone()),h.applyMatrix4(c.matrix),c.boundingBox=h}e.minDistanceObjects[t].push(c)}})}},{key:"_getNodeGroup",
value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0})}},{key:"_hasNodeGroup",value:function(e){return e._hasNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY)}},{key:"clearSelectedObjectIds",value:function(){this.selectedObjectIds.length=0}},{key:"cacheSelectedObjectIds",value:function(e,t){this.selectedObjectIds.push({uid:e,mgId:t})}},{key:"adjustVisibility",value:function(e,t){var n=this._getNodeGroup(e),i=n.visible;t&&!n.bVisible||(n.visible=t),n.bVisible=i}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){var n;if(t){n=this.selectedMeshes;for(var i=0,r=n.length;i<r;i++){var a=n[i].object,o=n[i].indices;if(o){if(o.length){for(var s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,u=0,c=o.length;u<c;u++)o[u].state?s[o[u].idx]=o[u].state:o[u].state2&&(l[o[u].idx]=o[u].state2);a.geometry.getAttribute("vState").needsUpdate=!0,a.geometry.getAttribute("vState2").needsUpdate=!0}}else a.visible=n[i].visibility}}else{this.selectedMeshes.length=0,n=this.selectedMeshes;for(var h={},i=0,r=this.selectedObjectIds.length;i<r;i++)h[this.selectedObjectIds[i].mgId]=!0;var d=Object.keys(h);this.traverseInstanceNodeMap(d,function(e,t){for(var i=0,r=t.length;i<r;i++){for(var a=t[i],o=[],s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,u=0,c=s.length;u<c;u++)s[u]===CLOUD.EnumInstanceState.SELECTED?(o.push({idx:u,state:s[u]}),s[u]=CLOUD.EnumInstanceState.HIDDEN):l[u]===CLOUD.EnumInstanceState.SELECTED&&(o.push({idx:u,state2:l[u]}),l[u]=CLOUD.EnumInstanceState.HIDDEN);o.length?(a.geometry.getAttribute("vState").needsUpdate=!0,a.geometry.getAttribute("vState2").needsUpdate=!0,n.push({object:a,indices:o})):(n.push({object:a,indices:null,visibility:a.visible}),a.visible=!1)}})}}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){var n;if(t){n=this.nonSelectedMeshes;for(var i=0,r=n.length;i<r;i++){var a=n[i].object,o=n[i].indices;if(o){if(o.length){for(var s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,u=0,c=o.length;u<c;u++)o[u].state?s[o[u].idx]=o[u].state:o[u].state2&&(l[o[u].idx]=o[u].state2);a.geometry.getAttribute("vState").needsUpdate=!0}}else a.visible=n[i].visibility}}else{this.nonSelectedMeshes.length=0,n=this.nonSelectedMeshes;for(var h={},i=0,r=this.selectedObjectIds.length;i<r;i++)h[this.selectedObjectIds[i].mgId]=!0;this.traverseInstanceNodeMap(null,function(e,t){if(h[e])for(var i=0,r=t.length;i<r;i++){for(var a=t[i],o=[],s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,u=0,c=s.length;u<c;u++)s[u]!==CLOUD.EnumInstanceState.SELECTED&&s[u]!==CLOUD.EnumInstanceState.HIDDEN?(o.push({idx:u,state:s[u]}),s[u]=CLOUD.EnumInstanceState.HIDDEN):l[u]!==CLOUD.EnumInstanceState.SELECTED&&l[u]!==CLOUD.EnumInstanceState.HIDDEN&&(o.push({idx:u,state2:l[u]}),l[u]=CLOUD.EnumInstanceState.HIDDEN);o.length?(a.geometry.getAttribute("vState").needsUpdate=!0,a.geometry.getAttribute("vState2").needsUpdate=!0,n.push({object:a,indices:o})):(n.push({object:a,indices:null,visibility:a.visible}),a.visible=!1)}else for(var i=0,r=t.length;i<r;i++){var a=t[i];n.push({object:a,indices:null,visibility:a.visible}),a.visible=!1}})}}},{key:"restoreVisibilityOfObjects",value:function(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}},{key:"getMeshIdByNodeInfo",value:function(e){return e.uv2Info?CLOUD.Utils.getCombinedKeyString([e.materialId,e.geometryId,e.uv2Info.byteOffset]):CLOUD.Utils.getCombinedKeyString([e.materialId,e.geometryId])}},{key:"getMaterialIdByMeshId",value:function(e){return CLOUD.Utils.splitCombinedKeyString(e)[0]}},{key:"getOriginalMaterialIdByMeshId",value:function(e){var t=CLOUD.Utils.splitCombinedKeyString(e);return CLOUD.Utils.splitCombinedKeyString(t[0],"_")[0]}},{key:"disposeBufferAfterVbo",value:function(){if(!this.bufferDestroyed){this.bufferDestroyed=!0;var e;CLOUD.GlobalData.PickingEffect?e=["muvCol0","muvCol1","muvCol2","uv2OffsetRepeat"]:(e=["muvCol0","muvCol1","muvCol2","uv2OffsetRepeat","mcol0","mcol1","mcol2","mcol3"],CLOUD.GlobalData.EnableExplosion&&e.pop()),this.traverseInstanceGeometryMap(function(t,n){for(var i=0,r=n.length;i<r;i++)CLOUD.GeomUtil.disposeBufferFromGeometry(n[i],e)})}}},{key:"getGeometryBuffersByUserId",value:function(e,t){var n=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!n)return[];for(var i=[],r=e.getDatabagId(),a=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,o=0,s=n.length;o<s;o++){var l,u=n[o];switch(u.type){case a.BOX_M:l=CLOUD.GeomUtil.getBoxBufferGeometryWithUvMatrices(u.uvArrayBuffer);break;case a.PIPE_M:l=CLOUD.GeomUtil.getPipeBufferGeometryWithUvMatrices(u.uvArrayBuffer);break;default:l=this.getGeometryByNodeInfo(e,u)}var c=this._isLines(u);if(l instanceof Array)for(var h=0,d=l.length;h<d;h++){var f=l[h].getAttribute("uv");i.push({isLines:c,databagId:r,nodeId:u.nodeId,position:l[h].getAttribute("position").array,index:l[h].getIndex().array,matrix:u.matrix,uv:f?f.array:null})}else{var f=l.getAttribute("uv");i.push({isLines:c,databagId:r,nodeId:u.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:u.matrix,uv:f?f.array:null})}}return i}},{key:"explode",value:function(e){function t(e,t,n){for(var i=e.getAttribute("mcol3").array,r=0;r<t.length;++r){var a=t[r];i[3*a]+=n.x,i[3*a+1]+=n.y,i[3*a+2]+=n.z}e.getAttribute("mcol3").needsUpdate=!0}var n=this;for(var i in n.nodeIdxMapFromUserId)n.traverseNodeIdxMapByUserId(i,function(r,a){var o=e.manager.getExplosionTranslation(i),s=n.getInstanceGeometries(r);s&&t(s[0],a,o)})}},{key:"_isLines",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingInstancedMeshGenerator(this)),this.pickingNodeGenerator}},{key:"calculateClippingIds",value:function(e,t){var n=this;for(var i in n.nodeIdxMapFromUserId)this.traverseMatrixInfoMapByUserId(i,function(i,r){for(var a=n.getInstanceNodesById(i),o=0,s=r.length;o<s;o++)for(var l=0,u=a.length;l<u;l++)a[l].intersectBoxWithClipPlane(e,r[o])&&a[l].getIntersectionPoints(e,r[o],t,!0)})}}]),t}(CLOUD.ModelView.MeshBaseManager);CLOUD.ModelView.InstancedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.generated=!1}return _createClass(e,[{key:"destroy",value:function(){this.disposeGeometries(),this.wireframeGeometryMap=null,this.noNeedWireframingIdMap=null,this.manager=null,this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null)}},{key:"clearData",value:function(){this.generated=!1,this.bufferDestroyed=!1,this.disposeGeometries(),this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData()}},{key:"disposeGeometries",value:function(){this._traverseWireframeGeometryMap(function(e,t){for(var n=0,i=t.length;n<i;n++)t[n].dispose()})}},{key:"updateNodes",value:function(e){var t;e.isActivateWireframe()?(t=this._getNodeGroup(e),t.updateMatrixWorld(!0),t.visible=!0):this._hasNodeGroup(e)&&(t=this._getNodeGroup(e),t.visible=!1)}},{key:"resetInstanceMaterial",value:function(){var e=CLOUD.EnumInstanceState.NONE;this._traverseWireframeGeometryMap(function(t,n){for(var i=0,r=n.length;i<r;++i){for(var a=n[i].getAttribute("vState").array,o=0,s=a.length;o<s;o++)a[o]=e;n[i].getAttribute("vState").needsUpdate=!0}}),this._updateNoWireframingState()}},{key:"updateInstanceWireframeByUserId",value:function(e,t,n,i){if(n===CLOUD.EnumInstanceState.HIDDEN||n===CLOUD.EnumInstanceState.NONE||n===CLOUD.EnumInstanceState.OVERRIDED){var r;if(i){var a=e.getFilter()._getMaterialByName(i),o=CLOUD.MaterialUtil.getColorParamsByMaterial(a);r=o.rgbaColor}var s=this;this.manager.traverseNodeIdxMapByUserId(t,function(e,t){s._setInstanceWireframeState(e,t,n,r)})}}},{key:"_updateNoWireframingState",value:function(){var e=this,t=CLOUD.EnumInstanceState.HIDDEN;this.manager.traverseNodeIdxMap(function(n,i){e._setInstanceWireframeState(n,i,t)},function(t){return e._isNeedWireframing(t)})}},{key:"_setInstanceWireframeState",value:function(e,t,n,i){var r=this._getWireframeGeometryById(e);if(r)for(var a=0,o=r.length;a<o;++a){var s=r[a].getAttribute("vState").array,l=null,u=null;i&&(l=r[a].getAttribute("aColor"),u=l?l.array:null);for(var c=0,h=t.length;c<h;++c){var d=t[c];s[d]=n,null!==u&&(u[4*d]=i[0],u[4*d+1]=i[1],u[4*d+2]=i[2],u[4*d+3]=i[3])}r[a].getAttribute("vState").needsUpdate=!0,l&&(l.needsUpdate=!0)}}},{key:"_generateInstanceWireframe",value:function(e){this._collectNoWireframingIds(e),this._createInstanceWireframeGeometries(),this._makeInstanceWireframe(e),this._updateNoWireframingState()}},{key:"generateWireframe",value:function(e){this.generated||(this._generateInstanceWireframe(e),this.generated=!0)}},{key:"_collectNoWireframingIds",value:function(e){var t=this,n=e.getFilter();e.getModelDescriptor().traverseInstancedNodeInfos(null,function(e,i){i&&n._hasRenderWithBoardlineFilter()&&!n._isRenderWithBoardline(i[0])&&(t.noNeedWireframingIdMap[e]=!0)})}},{key:"_createInstanceWireframeGeometries",value:function(){var e=this,t={};this.manager.traverseInstanceGeometryMap(function(n,i){for(var r=e._getWireframeBufferById(n,i,t),a=e.wireframeGeometryMap[n]=[],o=0,s=r.length;o<s;o++){var l=new THREE.InstancedBufferGeometry;l.setIndex(r[o].index),l.addAttribute("position",r[o].position),a.push(l)}}),t=null}},{key:"_makeInstanceWireframe",value:function(e){var t=this,n=this.manager,i=n.getCachedInstanceData(),r=this._getWireframeMaterial(e);this._traverseWireframeGeometryMap(function(a,o){for(var s=n.getBufferAttributesBy(a),l=0,u=o.length;l<u;l++){o[l].addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[a]),1,1)),o[l].addAttribute("mcol0",s.attributeMcol0),o[l].addAttribute("mcol1",s.attributeMcol1),o[l].addAttribute("mcol2",s.attributeMcol2),o[l].addAttribute("mcol3",s.attributeMcol3),t._setDefaultColorAttribute(e,o[l],i.vState[a].length);var c=new THREE.LineSegments(o[l],r);c.frustumCulled=!1,t._addWireframeNodeToScene(e,c)}})}},{key:"_setDefaultColorAttribute",value:function(e,t,n){for(var i=this._getWireframeMaterial(e),r=[],a=0;a<n;a++)r.push(i.color.r,i.color.g,i.color.b,i.opacity);t.addAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(r),4,1))}},{key:"_addWireframeNodeToScene",value:function(e,t){this._getNodeGroup(e).add(t),t.updateMatrixWorld(!0)}},{key:"_isNeedWireframing",value:function(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}},{key:"_getWireframeMaterial",value:function(e){return e.getInstanceWireframeMaterial()}},{key:"_getWireframeBufferById",value:function(e,t,n){var i=this.getGeometryIdByMeshId(e);if(n[i])return n[i];n[i]=[];for(var r=0,a=t.length;r<a;r++){var o=t[r];n[i].push({index:CLOUD.BuildEdge(o.attributes.position.array,o.index.array),position:o.attributes.position})}return n[i]}},{key:"_getWireframeGeometryById",value:function(e){return this.wireframeGeometryMap[e]}},{key:"_traverseWireframeGeometryMap",value:function(e){var t=this.wireframeGeometryMap;for(var n in t)e(n,t[n])}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0})}},{key:"_hasNodeGroup",value:function(e){return e._hasNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY)}},{key:"getGeometryIdByMeshId",value:function(e){return CLOUD.Utils.splitCombinedKeyString(e)[1]}},{key:"adjustVisibility",value:function(e,t){if(e.isActivateWireframe()){var n=this._getNodeGroup(e),i=n.visible;t&&!n.bVisible||(n.visible=t),n.bVisible=i}}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){if(this.generated&&!this.bufferDestroyed){this.bufferDestroyed=!0;var e=["mcol0","mcol1","mcol2","mcol3"];CLOUD.GlobalData.EnableExplosion&&e.pop(),this._traverseWireframeGeometryMap(function(t,n){for(var i=0,r=n.length;i<r;i++)CLOUD.GeomUtil.disposeBufferFromGeometry(n[i],e)})}}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingInstancedWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.InstancedWireframeManager=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.meshManager=new CLOUD.ModelView.InstancedMeshManager(e),e.wireframeManager=new CLOUD.ModelView.InstancedWireframeManager(e),e}return _inherits(t,e),t}(CLOUD.ModelView.InstancedBaseManager);CLOUD.ModelView.InstancedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="default",n.defaultManager=null,n.instancedManager=null,n.loader=null,n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var n=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(),!this.model.lightmap||this.model.enableLightmap==CLOUD.GlobalData.EnableLightmap&&this.model.lightmapIntensity==CLOUD.GlobalData.LightmapIntensity&&n==CLOUD.GlobalData.EnableTextureMapping||(this.model.enableLightmap=CLOUD.GlobalData.EnableLightmap,this.model.lightmapIntensity=CLOUD.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}},{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.loader.getDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"createMeshNodes",value:function(e){var t=this,n=this.model,i=this.loader.getDescriptor();this.instancedManager.createMeshNodes(n,i.getInstancedUserIds()),this.defaultManager.asyncCreateMeshNodes(n,i.getStandardUserIds(),function(){n.getMaterialManager()._updateTextureMapping(),t.clearCachedData(n),t.loaded=!0,e&&e()})}},{key:"clearCachedData",value:function(){this.loader.getDescriptor().destroyReader(),this.loader.getDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}]),t}(CLOUD.ModelView.ModelBaseHandler);CLOUD.ModelView.BatchedBaseHandler=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=null,this.wireframeManager=null}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}},{key:"updateNodes",value:function(e){this.meshManager.update(e),this.wireframeManager.update(e)}},{key:"generateWireframe",value:function(e,t){this.wireframeManager.generateWireframe(e,t)}},{key:"asyncGenerateWireframe",value:function(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}},{key:"rebuildIndices",value:function(e){this._rebuildIndices(e)}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}},{key:"createMeshNodes",value:function(e,t){this.meshManager.createMeshNodes(e,t)}},{key:"asyncCreateMeshNodes",value:function(e,t,n){this.meshManager.asyncCreateMeshNodes(e,t,n)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"getMeshNode",value:function(){return this.meshManager.getMeshNode()}},{key:"getPropertyValueByMaterialKey",value:function(e){return this.meshManager.getPropertyValueByMaterialKey(e)}},{key:"getFilteredUserIds",value:function(){return this.mapMaterialIdToUserIdsForFilter}},{key:"getSelectedUserIds",value:function(){return this.mapMaterialIdToUserIdsForSelection}},{key:"getHoveredUserIds",value:function(){return this.mapMaterialIdToUserIdsForHover}},{key:"getBlinkedUserIds",value:function(){return this.mapBlinkUserIds}},{key:"getHiddenUserIds",value:function(){return this.hiddenUserIdSetObject}},{key:"getTransparentUserIds",value:function(){return this.transparentUserIdSetObject}},{key:"applyFilter",value:function(e,t){if(this.hasNodeInfo(e)){var n;n=t||e.getModelDescriptor().getStandardUserIds();var i=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,n,i),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,i),this._collectHoveredUserIds(e.manager.sceneState.hoverId,i),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._rebuildIndices(e),this.updateNodes(e)}},{key:"_collectFilteredUserIds",value:function(e,t,n){var i=e.getFilter(),r=i._hasHiddenFileIdFilter(),a=i._hasVisibleFilter(),o=i._hasOverrideMaterialFilter(),s=i._hasTransparentFilter(),l=e.hasReplacedUserId(),u=e.hasHiddenSourceObjectUserId(),c=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.overrideUserIdSetObject={},this.transparentUserIdSetObject={},r||a||o||s||l||u)for(var h=0;h<t.length;++h){var d=t[h],f=n[d];if(f&&f.length)for(var p=0,m=f.length;p<m;p++){var g=f[p];if(r&&i._isHiddenFileId(g)||a&&!1===i._isVisible(g)||e.isReplacedUserId(d)||e.isHiddenSourceObjectUserId(d))void 0===c[g.materialId]&&(c[g.materialId]={}),void 0===c[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN]&&(c[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN]={}),c[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN][d]=!0,this.hiddenUserIdSetObject[d]=!0;else if(s&&i._isTransparent(g))void 0===c[g.materialId]&&(c[g.materialId]={}),void 0===c[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT]&&(c[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT]={}),c[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT][d]=!0,this.transparentUserIdSetObject[d]=!0;else if(o&&i._hasOverrideMaterial(g)){var v=i._getOverrideMaterial(g),y=null!=v?v.name:"";""!==y&&(void 0===c[g.materialId]&&(c[g.materialId]={}),void 0===c[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED]&&(c[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED]={}),c[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED][d]=y,this.overrideUserIdSetObject[d]=y)}else;}}}},{key:"_clearFilteredState",value:function(){this.mapMaterialIdToUserIdsForFilter=null}},{key:"_collectSelectedUserIds",value:function(e,t){var n=this.mapMaterialIdToUserIdsForSelection={};for(var i in e){var r=t[i];if(r&&r.length)for(var a=0,o=r.length;a<o;a++)void 0===n[r[a].materialId]&&(n[r[a].materialId]={}),void 0===n[r[a].materialId][i]&&(n[r[a].materialId][i]=!0)}}},{key:"_clearSelectedState",value:function(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}},{key:"_collectHoveredUserIds",value:function(e,t){var n=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var i=t[e],r=0,a=i.length;r<a;r++)void 0===n[i[r].materialId]&&(n[i[r].materialId]={}),void 0===n[i[r].materialId][e]&&(n[i[r].materialId][e]=!0)}},{key:"_clearHoveredState",value:function(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}},{key:"_collectBlinkedUserIds",value:function(e,t){var n=this.mapBlinkUserIds={};for(var i in e){var r=t[i];if(r&&r.length)for(var a=0,o=r.length;a<o;a++)void 0===n[r[a].materialId]&&(n[r[a].materialId]={}),void 0===n[r[a].materialId][i]&&(n[r[a].materialId][i]=!0)}}},{key:"_clearBlinkedState",value:function(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}},{key:"_rebuildIndices",value:function(e){this.meshManager.rebuildIndices(e),this.wireframeManager.rebuildIndices(e)}},{key:"clearCachedData",value:function(){this.meshManager.clearAllNodeBuffer()}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}},{key:"isPickableNode",value:function(e){var t=this.getHiddenUserIds();if(t&&t[e])return!1;var n=this.getTransparentUserIds();return!n||!n[e]}},{key:"isHiddenNode",value:function(e){var t=this.getHiddenUserIds();return!(!t||!t[e])}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}}]),e}();CLOUD.ModelView.BatchedBaseManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.BatchedDescriptor,n}return _inherits(t,e),t}(CLOUD.ModelView.DefaultBaseLoader);CLOUD.ModelView.BatchedLoader=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),t}(CLOUD.ModelView.DefaultDescriptor);CLOUD.ModelView.BatchedDescriptor=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.manager=e,n._maxIndiceseNum=0,n._materialList=[],n.mapMaterialIdToMergedNode={},n.selectedMeshes=[],n.nonSelectedMeshes=[],n.selectedObjectIds=[],n.blinkMaterials=[],n.mapDestroyedBufferKey={},n.mapClippingIds={},n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.mapMaterialIdToMergedNode=null,this.manager=null,this._materialList=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.blinkMaterials=null,this.mapDestroyedBufferKey=null,this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null)}},{key:"clearData",value:function(){this.bufferDestroyed=!1,this.clearAllNodeBuffer(),this._disposeMergedGeometries(),this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData()}},{key:"getMeshesByUserIds",value:function(e,t,n){for(var i in this.mapMaterialIdToMergedNode)for(var r=this.mapMaterialIdToMergedNode[i],a=0,o=r.length;a<o;a++){var s=r[a],l=s.indices;for(var u in l)if(u==t||u==n)for(var c=l[u],h=0,d=c.length;h<d;h++){var f={};f.mesh=s.mesh,f.indexInfo=c[h],f.boundingBox=c[h].boundingBox,e.minDistanceObjects[u].push(f)}}}},{key:"calculateClippingIds",value:function(e,t){this.mapClippingIds={};for(var n in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[n],r=0,a=i.length;r<a;r++){var o=i[r],s=o.mesh,l=o.indices;for(var u in l)for(var c=l[u],h=0,d=c.length;h<d;h++)"LineSegmentsEx"!=s.type&&s.intersectBoxWithClipPlane(e,c[h])&&(s.getIntersectionPoints(e,c[h],t),this.mapClippingIds[u]=!0)}}},{key:"rebuildIndices",value:function(e){this._materialList.length=0,this.clearSelectedObjectIds();var t=this.manager.getFilteredUserIds(),n=this.manager.getSelectedUserIds(),i=this.manager.getHoveredUserIds(),r=this.manager.getBlinkedUserIds(),a=this.mapClippingIds;for(var o in this.mapMaterialIdToMergedNode){var s,l,u,c,h=this.getPropertyValueByMaterialKey(o),d=h.materialId,f=null,p=null,m=null,g=null,v=null,y=null;n&&n[d]&&(g=n[d]),i&&i[d]&&(v=i[d]),r&&r[d]&&(y=r[d]),t&&t[d]&&(f=t[d][CLOUD.Model.EnumFilterState.HIDDEN],p=t[d][CLOUD.Model.EnumFilterState.OVERRIDED],m=t[d][CLOUD.Model.EnumFilterState.TRANSPARENT]);var E=this.mapMaterialIdToMergedNode[o];for(u=0,c=E.length;u<c;u++){var b=E[u],x=(b.mesh,b.indices),M=b.geometry;if(M.clearGroups(),M._visible=!0,g||f||p||v||m||a||y){var _=[];for(var C in x)if(x.hasOwnProperty(C)){if(f&&f[C])continue;var I=x[C];if(I&&I.length>0){if(I.sort(function(e,t){return e.indexStart-t.indexStart}),m&&m[C]){for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.TRANSPARENT});continue}if(e.manager.isSelectPriority()){if(g&&g[C]){if(this.cacheSelectedObjectIds(C,o,u),CLOUD.GlobalData.PickingEffect){if(p&&p[C]){var O="selected|"+p[C],T=this._materialList.indexOf(O);for(-1===T&&(this._materialList.push(O),T=this._materialList.length-1),s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+T});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.NONE});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.SELECTED});continue}if(y&&y[C]){if(p&&p[C]){var O="blink|"+p[C],T=this._materialList.indexOf(O);for(-1===T&&(this._materialList.push(O),T=this._materialList.length-1),s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+T});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.BLINK});continue}}else{if(y&&y[C]){if(p&&p[C]){var O="blink|"+p[C],T=this._materialList.indexOf(O);for(-1===T&&(this._materialList.push(O),T=this._materialList.length-1),s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+T});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.BLINK});continue}if(g&&g[C]){if(this.cacheSelectedObjectIds(C,o,u),CLOUD.GlobalData.PickingEffect){if(p&&p[C]){var O="selected|"+p[C],T=this._materialList.indexOf(O);for(-1===T&&(this._materialList.push(O),T=this._materialList.length-1),s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+T});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.NONE});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.SELECTED});continue}}if(v&&v[C]){if(p&&p[C]){var O="hover|"+p[C],T=this._materialList.indexOf(O);for(-1===T&&(this._materialList.push(O),T=this._materialList.length-1),s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+T});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.HOVER});continue}if(p&&p[C]){var O=p[C],T=this._materialList.indexOf(O);for(-1===T&&(this._materialList.push(O),T=this._materialList.length-1),s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+T});continue}if(a[C]){for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:CLOUD.Model.EnumFilterState.CLIPPING});continue}for(s=0,l=I.length;s<l;s++)_.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:0})}}if(_.length>0)for(s=0,l=_.length;s<l;s++){var L=_[s].indexStart,S=_[s].indexCount,D=_[s].state;if(0===s)M.addGroup(L,S,D);else{var w=_[s-1].indexStart,U=_[s-1].indexCount,R=_[s-1].state,A=w+U;D===R&&L===A?M.groups[M.groups.length-1].count+=S:M.addGroup(L,S,D)}}else M._visible=!1}}}}},{key:"update",value:function(e){var t,n,i,r,a=e.getFilter(),o=e.materialManager.materials,s=e.selectedMaterial,l=e.manager.sceneState;if(e.isOnlyWireframe())for(var u in this.mapMaterialIdToMergedNode){var c=this.mapMaterialIdToMergedNode[u];for(i=0,r=c.length;i<r;i++){var h=c[i].mesh;h&&(h.visible=!1)}}else{CLOUD.GlobalData.TranslucentDepthDisabled&&(s.transparent?s.depthWrite=!1:s.depthWrite=!0);var d=a._getMaterialByName("scene");CLOUD.GlobalData.TranslucentDepthDisabled&&(d.depthWrite=!1);var f=[];this.blinkMaterials.length=0;var p={};for(t=0,n=this._materialList.length;t<n;t++){var m,g=this._materialList[t],v=g.split("|");"hover"===v[0]?(m=a._getMaterialByName(v[1]),m=l.getHoverMaterial(m)):"blink"===v[0]?(m=a._getMaterialByName(v[1]),m=l.getBlinkMaterial(m),p[g]||this.blinkMaterials.push(m)):m=a._getMaterialByName(g),CLOUD.GlobalData.TranslucentDepthDisabled&&(m.transparent?m.depthWrite=!1:m.depthWrite=!0),f[t]=m}for(var u in this.mapMaterialIdToMergedNode){var y=this.getPropertyValueByMaterialKey(u),E=y.materialId,b=e.manager.getOverrideMaterialByName(E),x=b||o[E]||CLOUD.MaterialUtil.getDefaultStandardMaterial();CLOUD.GlobalData.TranslucentDepthDisabled&&(x.transparent?x.depthWrite=!1:x.depthWrite=!0);var M=l.getHoverMaterial(o[E]);CLOUD.GlobalData.TranslucentDepthDisabled&&(M.transparent?M.depthWrite=!1:M.depthWrite=!0);var c=this.mapMaterialIdToMergedNode[u];for(i=0,r=c.length;i<r;i++){var _=c[i],C=_.geometry;if(null!==C){var h=_.mesh;if(C._visible){if(C.groups.length>0){CLOUD.GeomUtil.limitGeometryBufferSize(C);var I=p[E];I||(I=p[E]=l.getBlinkMaterial(x),this.blinkMaterials.push(I));var O=[x,s,I,M,d];for(t=0,n=f.length;t<n;t++)f[t].side=x.side,O.push(f[t]);h.material=O}else CLOUD.GeomUtil.limitGeometryBufferSize(C),h.material=C.groups.length?[x]:x;h.visible=!0}else h.visible=!1}}x=null}}}},{key:"explode",value:function(e){for(var t in this.mapMaterialIdToMergedNode)for(var n=this.mapMaterialIdToMergedNode[t],i=0,r=n.length;i<r;i++){var a=n[i],o=a.geometry;if(null!==o){var s=a.indices;for(var l in s){var u=e.manager.getExplosionTranslation(l),c=s[l];if(c)for(var h=0,d=c.length;h<d;h++){
var f=c[h].positionStart,p=f+c[h].positionCount;!function(e,t,n,i){for(var r=e.getAttribute("position").array,a=t;a<n;a+=3)r[a]+=i.x,r[a+1]+=i.y,r[a+2]+=i.z;e.getAttribute("position").needsUpdate=!0}(o,f,p,u)}}}}}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.GEOMETRY,{globalSpace:!0})}},{key:"_hasNodeGroup",value:function(e){return e._hasNodeGroup(CLOUD.ObjectGroupType.GEOMETRY)}},{key:"_resetMaxIndicesNumberPerBathSegment",value:function(e){CLOUD.GlobalData.SegmentedBatchMergeEnable&&CLOUD.GlobalData.maxIndicesNumberPerBathSegment<this._maxIndiceseNum&&(console.log("adjust maxIndicesNumberPerBathSegment value from "+CLOUD.GlobalData.maxIndicesNumberPerBathSegment+" to "+this._maxIndiceseNum+"!"),CLOUD.GlobalData.maxIndicesNumberPerBathSegment=e)}},{key:"asyncCreateMeshNodes",value:function(e,t,n){var i=this;t&&t.length?this._asyncMergeData(e,t,function(){i._makeMeshNodes(e),n&&n()}):n&&n()}},{key:"_asyncMergeData",value:function(e,t,n){function i(d){var f=d;return function(){var d,p;for(p=f+c>u?u:f+c,d=f;d<p;d++){var m=t[d];if(a._collectMergedNodeInfosById(e,m,h,r),d===p-1)if(p!==u){var g={total:o,loaded:(d/u*l+s)*o};e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:g}),requestAnimationFrame(i(d+1))}else{var g={total:o,loaded:(l+s)*o};e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:g}),a._asyncMergeGeometry(r,e,n)}}}}var r={},a=this,o=e.getLoader().maxLoadTaskCount,s=e.progressPercentage.load,l=e.progressPercentage.collect,u=t.length,c=Math.ceil(u/e.progressFrequency),h=e.getModelDescriptor().getStandardNodeInfos();requestAnimationFrame(i(0))}},{key:"_asyncMergeGeometry",value:function(e,t,n){function i(a){var p=a;return function(){var a,m;for(m=p+d>h?h:p+d,a=p;a<m;a++)if(o._collectMergedGeometriesById(r[a],e,f),a===m-1)if(m!==r.length){var g={total:s,loaded:(a/h*c+l+u)*s};t.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:g}),requestAnimationFrame(i(a+1))}else n()}}var r=[];for(var a in e)r.push(a);if(0===r.length)return void n();this._resetMaxIndicesNumberPerBathSegment(this._maxIndiceseNum);var o=this,s=t.getLoader().maxLoadTaskCount,l=t.progressPercentage.load,u=t.progressPercentage.collect,c=t.progressPercentage.merge,h=r.length,d=Math.ceil(h/t.progressFrequency),f=this.mapMaterialIdToMergedNode;requestAnimationFrame(i(0))}},{key:"_collectMergedNodeInfosById",value:function(e,t,n,i){for(var r=n[t],a=0,o=r.length;a<o;a++){var s=r[a];this._createNodeBuffer(e,s);var l=this._getNodeBufferBy(s.nodeId);if(l){var u=l.index;u&&u.length>this._maxIndiceseNum&&(this._maxIndiceseNum=u.length);var c=this._getMaterialKeyByNodeInfo(s,e);void 0===i[c]&&(i[c]=[]),i[c].push(s)}}}},{key:"_collectMergedGeometriesById",value:function(e,t,n){var i=t[e],r=0,a=0,o=0,s=0,l=0,u=null;void 0===n[e]&&(n[e]=[]);var c=[],h=0;i.sort(function(e,t){return e.userId-t.userId});for(var d=0,f=i.length;d<f;d++){var p=i[d];u=this._getNodeBufferBy(p.nodeId),u?(a+=u.index.length,r+=u.position.length,u.normal&&(o+=u.normal.length),u.uv&&(s+=u.uv.length),u.uv2&&(l+=u.uv2.length),CLOUD.GlobalData.SegmentedBatchMergeEnable&&a>CLOUD.GlobalData.maxIndicesNumberPerBathSegment?(a-=u.index.length,r-=u.position.length,u.normal&&(o-=u.normal.length),u.uv&&(s-=u.uv.length),u.uv2&&(l-=u.uv2.length),c.push({start:h,end:d,arrayPositionLength:r,arrayIndexLength:a,arrayNormalLength:o,arrayUVLength:s,arrayUV2Length:l}),r=0,a=0,o=0,s=0,l=0,h=d,d-=1):d===f-1&&c.push({start:h,end:f,arrayPositionLength:r,arrayIndexLength:a,arrayNormalLength:o,arrayUVLength:s,arrayUV2Length:l}),u=null):d===f-1&&c.push({start:h,end:f,arrayPositionLength:r,arrayIndexLength:a,arrayNormalLength:o,arrayUVLength:s,arrayUV2Length:l})}for(var m=0,g=c.length;m<g;m++){for(var v=c[m],y=new THREE.BufferGeometry,E={},b=new Float32Array(v.arrayPositionLength),x=new Uint32Array(v.arrayIndexLength),M=new Float32Array(v.arrayNormalLength),_=new Float32Array(v.arrayUVLength),C=new Float32Array(v.arrayUV2Length),I=0,O=0,T=0,L=0,S=0,D=[],d=v.start,f=v.end;d<f;d++){var p=i[d];if(u=this._getNodeBufferBy(p.nodeId)){D.push(p.nodeId);var w=u.index,U=u.position,R=u.normal,A=u.uv,N=u.uv2;b.set(U,I);for(var P=Uint32Array.from(w),k=0,B=P.length;k<B;k++)P[k]+=I/3;x.set(P,O),void 0===E[p.userId]&&(E[p.userId]=[]),E[p.userId].push({userId:p.userId,nodeId:p.nodeId,positionStart:I,positionCount:U.length,indexStart:O,indexCount:w.length,lightmapIdx:p.lightmapIdx,boundingBox:p.boundingBox}),O+=w.length,I+=U.length,R&&(M.set(R,T),T+=R.length),A&&(_.set(A,L),L+=A.length),N&&(C.set(N,S),S+=N.length),w=null,U=null,R=null,A=null,N=null,u=null}}this.clearNodeBufferByNodeIds(D),y._visible=!0,y.setIndex(new THREE.BufferAttribute(x,1)),y.addAttribute("position",new THREE.BufferAttribute(b,3)),T>0&&y.addAttribute("normal",new THREE.BufferAttribute(M,3)),L>0&&y.addAttribute("uv",new THREE.BufferAttribute(_,2)),S>0&&y.addAttribute("uv2",new THREE.BufferAttribute(C,2)),n[e].push({geometry:y,indices:E})}}},{key:"clearAllNodeBuffer",value:function(){this.cachedNodeBuffer&&(this.cachedNodeBuffer=null)}},{key:"clearNodeBufferByNodeIds",value:function(e){if(this.cachedNodeBuffer)for(var t=0,n=e.length;t<n;t++)this.cachedNodeBuffer[e[t]]=null}},{key:"_getNodeBufferByNodeInfo",value:function(e,t){return this.cachedNodeBuffer||this._createNodeBuffer(e,t),this.cachedNodeBuffer[t.nodeId]}},{key:"_getNodeBufferBy",value:function(e){return this.cachedNodeBuffer?this.cachedNodeBuffer[e]:null}},{key:"_createNodeBufferByMpkBufferData",value:function(e,t,n){this.cachedNodeBuffer||(this.cachedNodeBuffer={}),this.cachedNodeBuffer[t.nodeId]||(this.cachedNodeBuffer[t.nodeId]=this.createBufferByBufferDataWithUV2(e,t,n))}},{key:"_createNodeBuffer",value:function(e,t){this._createNodeBufferByMpkBufferData(e,t,{buffer:e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),isDataView:!0})}},{key:"_createGeometries",value:function(e,t){var n=this,i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=e.getModelDescriptor().getReferencedMeshBufferData(),a=this._getClassifiedMeshes(i,r);this._dealDataMergedMeshs(e,a,r,i,function(){n._dealDataMergeableMeshs(e,a,r,i,t)})}},{key:"_getClassifiedMeshes",value:function(e,t){var n=[],i=[];for(var r in t){var a=t[r],o=a.IndexInfos,s=void 0;if(o){if(o.length<1)continue;for(var l=0,u=o.length;l<u;l++){var c=e[o[l].meshId];if(c&&c.length){s=o[l].meshId;break}}}else{var c=e[r];c&&c.length&&(s=r)}if(void 0!==s){var c=e[s];c&&c.length&&(c[0].type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE||!c[0].instanceOrNot&&c[0].type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF?n.push(r):i.push(r))}}if(!CLOUD.GlobalData.Instance)for(var r in e)i[r]||n[r]||n.push(r);return{mergeableIdxs:n,mergedIdxs:i}}},{key:"_collectMergeableMeshesByIdxId",value:function(e,t,n,i,r){n[t]&&n[t].IndexInfos?this._collectSharedMeshesByIdxId(e,t,n,i,r):this._collectLineOrIntanceMeshesByIdxId(e,t,n,i,r)}},{key:"_collectLineOrIntanceMeshesByIdxId",value:function(e,t,n,i,r){for(var a=i[t],o=e.getModelDescriptor().getReferencedMeshBufferById(t),s={buffer:o},l=0,u=a.length;l<u;l++){var c=a[l];this._createNodeBufferByMpkBufferData(e,c,s);var h=this._getMaterialKeyByNodeInfo(c);r[h]||(r[h]=[]),r[h].push(c)}}},{key:"_collectSharedMeshesByIdxId",value:function(e,t,n,i,r){for(var a=n[t],o=a.IndexInfos,s=0,l=o.length;s<l;s++){var u=i[o[s].meshId];if(u)for(var c=e.getModelDescriptor().getReferencedMeshBufferById(t),h={buffer:c,indexInfo:o[s]},d=0,f=u.length;d<f;d++){var p=u[d];this._createNodeBufferByMpkBufferData(e,p,h);var m=this._getMaterialKeyByNodeInfo(p);r[m]||(r[m]=[]),r[m].push(p)}}}},{key:"_mergeMergeableMeshes",value:function(e,t,n,i){function r(f){var p=f;return function(){var f,m;for(m=p+d>l?l:p+d,f=p;f<m;f++)o._collectMergedGeometriesById(a[f],t,n),f===m-1&&(m!==l?(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:s,loaded:(f/l*h+u+c)*s}}),requestAnimationFrame(r(f+1))):o._makeMeshNodes(e,i))}}var a=Object.keys(t);if(0===a.length)return void this._makeMeshNodes(e,i);var o=this,s=e.getLoader().maxLoadTaskCount,l=a.length,u=e.progressPercentage.load,c=e.progressPercentage.collect,h=e.progressPercentage.merge,d=Math.ceil(l/e.progressFrequency);requestAnimationFrame(r(0))}},{key:"_dealDataMergeableMeshs",value:function(e,t,n,i,r){function a(t){var v=t;return function(){var t,y;for(y=v+g>c?c:v+g,t=v;t<y;t++)o._collectMergeableMeshesByIdxId(e,d[t],n,i,l),t===y-1&&(y!==c?(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:f,loaded:((t+u)/h*m+p)*f}}),requestAnimationFrame(a(t+1))):(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:f,loaded:(m+p)*f}}),o._mergeMergeableMeshes(e,l,s,r)))}}if(0===t.mergeableIdxs.length)return void this._makeMeshNodes(e,r);var o=this,s=this.mapMaterialIdToMergedNode,l={},u=t.mergedIdxs.length,c=t.mergeableIdxs.length,h=u+c,d=t.mergeableIdxs,f=e.getLoader().maxLoadTaskCount,p=e.progressPercentage.load,m=e.progressPercentage.collect,g=Math.ceil(c/e.progressFrequency);requestAnimationFrame(a(0))}},{key:"_collectDataMergedMeshesByIdxId",value:function(e,t,n,i,r){var a=t[e],o=a.IndexInfos;if(o&&0!==o.length){var s=!1;a.UV&&(a.UV.byteLength||a.UV.length)&&(s=!0),r.lightmap&&(a=this.getAttributeForLightmapWithDataMerged(a,r,e));for(var l=void 0,u=-1,c=0,h=o.length;c<h;c++){var d=n[o[c].meshId];if(d&&0!==d.length){if(void 0!=a.lightmapIdx){var f=o[c];f.positionStart=3*(u+1),f.uvStart=2*(u+1);for(var p=f.indexStart,m=f.indexCount+f.indexStart;p<m;p++)u=u<a.I[p]?a.I[p]:u;var g=u+1;f.positionCount=3*g-f.positionStart,f.uvCount=2*g-f.uvStart}l=o[c].meshId;for(var v=0,y=d.length;v<y;v++)d[v].uv=s,void 0!=a.lightmapIdx&&(d[v].lightmapIdx=a.lightmapIdx,d[v].materialId=d[v].materialId+"_"+d[v].lightmapIdx)}}if(void 0!==l){var E=n[l][0],b={},x=this._getMaterialKeyByNodeInfo(E);void 0===i[x]&&(i[x]=[]);for(var p=0,m=o.length;p<m;p++)n[o[p].meshId]&&(E=n[o[p].meshId][0],void 0===b[E.userId]&&(b[E.userId]=[]),o[p].userId=E.userId,o[p].nodeId=E.nodeId,o[p].boundingBox=E.boundingBox,b[E.userId].push(o[p]));var M=new THREE.BufferGeometry;M._visible=!0,M.setIndex(new THREE.BufferAttribute(new Uint32Array(a.I),1)),M.addAttribute("position",new THREE.BufferAttribute(new Float32Array(a.P),3)),a.N&&(a.N.byteLength||a.N.length)&&M.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(a.N),3)),s&&M.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(a.UV),2)),a.UV2&&(M.addAttribute("uv2",new THREE.BufferAttribute(new Float32Array(a.UV2),2)),M.lightmapIdx=a.lightmapIdx),i[x].push({geometry:M,indices:b})}}}},{key:"getAttributeForLightmapWithDataMerged",value:function(e,t,n){var i=[],r=new Uint32Array(e.I),a=t.getLoader().getUV2ById("bmpk_"+n,r.length);if(!a)return e;var o=a.lightmapIdx;i=a.uv2;for(var s=new Float32Array(e.P),l=new Float32Array(e.N),u=new Float32Array(e.UV),c=[],h=[],d=[],f=[],p=[],m=0,g=0;g<r.length;g++){var v=r[g];void 0==p[v]||i[2*p[v]]!=i[2*g]||i[2*p[v]+1]!=i[2*g+1]?(c.push(s[3*v]),c.push(s[3*v+1]),c.push(s[3*v+2]),l.length>0&&(h.push(l[3*v]),h.push(l[3*v+1]),h.push(l[3*v+2])),u.length>0&&(d.push(u[2*v]),d.push(u[2*v+1])),f.push(i[2*g]),f.push(i[2*g+1]),r[g]=m,m++,void 0==p[v]&&(p[v]=g)):r[g]=r[p[v]]}return s=null,l=null,u=null,i=null,p=null,{I:r,UV2:f,P:c,N:h,UV:d,lightmapIdx:o}}},{key:"_dealDataMergedMeshs",value:function(e,t,n,i,r){function a(t){var m=t;return function(){var t,g;for(g=m+p>u?u:m+p,t=m;t<g;t++)o._collectDataMergedMeshesByIdxId(l[t],n,i,s,e),t===g-1&&(g!==u?(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:h,loaded:(t/c*f+d)*h}}),requestAnimationFrame(a(t+1))):(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:h,loaded:(t/c*f+d)*h}}),r&&r()))}}if(0===t.mergedIdxs.length)return void(r&&r());var o=this,s=this.mapMaterialIdToMergedNode,l=t.mergedIdxs,u=l.length,c=t.mergedIdxs.length+t.mergeableIdxs.length,h=e.getLoader().maxLoadTaskCount,d=e.progressPercentage.load,f=e.progressPercentage.collect,p=Math.ceil(u/e.progressFrequency);requestAnimationFrame(a(0))}},{key:"_makeMeshNodes",value:function(e,t){var n=e.manager,i=e.databagId,r=e.getEncodedDatabagId(),a=this._getNodeGroup(e),o=this.mapMaterialIdToMergedNode;for(var s in o){var l=this.getPropertyValueByMaterialKey(s),u=o[s];if(e.lightmap){var c=l.materialId;e.materialManager.updateLightmapMaterial(c)}for(var h=0,d=u.length;h<d;h++){var f=u[h].geometry,p=u[h].indices,m=null;if("lines"===l.type)m=new CLOUD.LineSegmentsEx(f),m.databagId=i;else{var g={databagId:i};m=new CLOUD.MeshEx(f),m.spawn(g)}m._indicesGroup=p,a.add(m),u[h].mesh=m,n.addMeshToOctantMap(r,s,new CLOUD.BatchedCapsuleObject(s,m)),p=null,m=null}}a.updateMatrixWorld(!0),e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:e.getLoader().maxLoadTaskCount,loaded:e.getLoader().maxLoadTaskCount}}),t&&t()}},{key:"createMeshNodes",value:function(e,t){if(!e.getModelDescriptor().getStandardNodeInfos())return void(t&&t());this._createGeometries(e,function(){t&&t()})}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"getMeshNode",value:function(){return this.mapMaterialIdToMergedNode}},{key:"_disposeMergedGeometries",value:function(){for(var e in this.mapMaterialIdToMergedNode){for(var t=this.mapMaterialIdToMergedNode[e],n=0,i=t.length;n<i;n++){t[n].geometry.dispose(),delete t[n].geometry,delete t[n].indices,t[n].mesh._indicesGroup=null,delete t[n].mesh}delete this.mapMaterialIdToMergedNode[e]}}},{key:"_getMaterialKeyByNodeInfo",value:function(e,t){var n=e.materialId;if(t){var i=t.manager.getOverrideMaterialByNodeInfo(e);i&&(n=i.name,e.materialId=n)}return CLOUD.Utils.getCombinedKeyString([e.materialId,e.uv?"1":"0",e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE?"lines":"meshes"])}},{key:"getPropertyValueByMaterialKey",value:function(e){var t=CLOUD.Utils.splitCombinedKeyString(e);return{materialId:t[0],uvProp:t[1],type:t[2]}}},{key:"clearSelectedObjectIds",value:function(){this.selectedObjectIds.length=0}},{key:"cacheSelectedObjectIds",value:function(e,t,n){this.selectedObjectIds.push({uid:e,mKey:t,idx:n})}},{key:"adjustVisibility",value:function(e,t){var n=this._getNodeGroup(e),i=n.visible;t&&!n.bVisible||(n.visible=t),n.bVisible=i}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){if(t)for(var n=0,i=this.selectedMeshes.length;n<i;n++)for(var r=this.selectedMeshes[n].object,a=this.selectedMeshes[n].indices,o=0,s=a.length;o<s;o++){var l=r.geometry.groups[a[o].idx];l.start=a[o].start,l.count=a[o].count}else{this.selectedMeshes.length=0;for(var u={},n=0,i=this.selectedObjectIds.length;n<i;n++)u[this.selectedObjectIds[n].mKey+"&"+this.selectedObjectIds[n].idx]=!0;for(var c=Object.keys(u),n=0,i=c.length;n<i;n++){for(var h=c[n].split("&"),d=h[0],f=h[1],p=this.mapMaterialIdToMergedNode[d][f],r=p.mesh,m=p.geometry,a=[],g=m.groups,o=0,s=g.length;o<s;o++){var l=g[o];l.materialIndex===CLOUD.Model.EnumFilterState.SELECTED&&(a.push({idx:o,start:l.start,count:l.count}),l.start=0,l.count=0)}a.length&&this.selectedMeshes.push({object:r,indices:a})}}}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){if(t)for(var n=0,i=this.nonSelectedMeshes.length;n<i;n++){var r=this.nonSelectedMeshes[n].object,a=this.nonSelectedMeshes[n].indices;if(a)for(var o=0,s=a.length;o<s;o++){var l=r.geometry.groups[a[o].idx];l.start=a[o].start,l.count=a[o].count}else r.visible=this.nonSelectedMeshes[n].visibility}else{this.nonSelectedMeshes.length=0;for(var u={},n=0,i=this.selectedObjectIds.length;n<i;n++){var c=this.selectedObjectIds[n];u[c.mKey]||(u[c.mKey]={}),u[c.mKey][c.idx]=!0}for(var h in this.mapMaterialIdToMergedNode){var d=this.mapMaterialIdToMergedNode[h];if(u[h])for(var o=0,s=d.length;o<s;o++){var r=d[o].mesh;if(u[h][o]){for(var a=[],f=r.geometry.groups,n=0,i=f.length;n<i;n++){var l=f[n];l.materialIndex!==CLOUD.Model.EnumFilterState.SELECTED&&(a.push({idx:n,start:l.start,count:l.count}),l.start=0,l.count=0)}a.length?this.nonSelectedMeshes.push({object:r,indices:a}):(this.nonSelectedMeshes.push({object:r,indices:null,visibility:r.visible}),r.visible=!1)}else this.nonSelectedMeshes.push({object:r,indices:null,visibility:r.visible}),r.visible=!1}else for(var n=0,i=d.length;n<i;n++){var r=d[n].mesh;this.nonSelectedMeshes.push({object:r,indices:null,visibility:r.visible}),r.visible=!1}}}}},{key:"restoreVisibilityOfObjects",value:function(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}},{key:"getBlinkMaterials",value:function(){return this.blinkMaterials}},{key:"disposeBufferAfterVbo",value:function(){if(!this.bufferDestroyed){var e=0;for(var t in this.mapMaterialIdToMergedNode)for(var n=this.mapMaterialIdToMergedNode[t],i=0,r=n.length;i<r;i++){var a=n[i],o=a.geometry;if(null!==o){e++;var s=t+"-"+i;this.mapDestroyedBufferKey[s]||a.mesh.visible&&(this.mapDestroyedBufferKey[s]=!0,CLOUD.GlobalData.EnableSplitComponent?CLOUD.GeomUtil.disposeBufferFromGeometry(o,["normal","uv2"]):CLOUD.GeomUtil.disposeBufferFromGeometry(o,["normal","uv","uv2"]))}}Object.keys(this.mapDestroyedBufferKey).length===e&&(this.mapDestroyedBufferKey={},this.bufferDestroyed=!0)}}},{key:"_traverseMeshNodeMap",value:function(e){for(var t in this.mapMaterialIdToMergedNode)for(var n=this.mapMaterialIdToMergedNode[t],i=0,r=n.length;i<r;i++)e&&e(t,n[i])}},{key:"getGeometryBuffersByUserId",value:function(e,t){var n=[],i=e.getDatabagId(),r=this;return this._traverseMeshNodeMap(function(e,a){var o=a.indices[t];if(o)for(var s=a.geometry,l=s.getIndex().array,u=s.getAttribute("position").array,c=s.getAttribute("uv"),h=c?c.array:null,d="lines"===r.getPropertyValueByMaterialKey(e).type,f=0,p=o.length;f<p;f++){var m=o[f],g=m.indexStart,v=m.indexStart+m.indexCount,y=l.slice(g,v),E=null;h&&(g=m.positionStart/3*2,v=g+m.positionCount/3*2,E=h.slice(g,v)),g=m.positionStart,v=m.positionStart+m.positionCount;var b=u.slice(g,v);g/=3,y.forEach(function(e,t,n){n[t]-=g}),n.push({isLines:d,databagId:i,nodeId:m.nodeId,position:b,index:y,uv:E})}}),n}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingBatchedMeshGenerator(this)),this.pickingNodeGenerator}}]),t}(CLOUD.ModelView.MeshBaseManager);CLOUD.ModelView.BatchedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.generated=!1,this.wireframeLineSegment=null,this.wireframeGeometryMap=null,this.userIdMapForNoWireFrame={}}return _createClass(e,[{key:"destroy",value:function(){this.clearData(),this.manager=null,this.userIdMapForNoWireFrame=null,this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null)}},{key:"clearData",value:function(){this.generated=!1,this.bufferDestroyed=!1,this.wireframeLineSegment&&(this.wireframeLineSegment._indicesGroup=null,this.wireframeLineSegment.geometry.dispose(),this.wireframeLineSegment=null),this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this.wireframeGeometryMap=null,this.userIdMapForNoWireFrame={}}},{key:"_createWireframeGeometry",value:function(e,t){if(this.wireframeGeometryMap||(this.wireframeGeometryMap={}),!this.wireframeGeometryMap[t.nodeId]){for(var n=e.attributes.position.array.slice(t.positionStart,t.positionStart+t.positionCount),i=e.getIndex().array.slice(t.indexStart,t.indexStart+t.indexCount),r=0,a=i.length;r<a;r++)i[r]-=t.positionStart/3;var o=CLOUD.BuildEdge(n,i),s=new THREE.BufferGeometry;s.setIndex(new THREE.Uint32BufferAttribute(o,1)),s.addAttribute("position",new THREE.BufferAttribute(Float32Array.from(n),3)),s._userId=t.userId,this.wireframeGeometryMap[t.nodeId]=s}}},{key:"_createWireframeGeometries",value:function(e){var t=e.getFilter(),n=e.getModelDescriptor().getStandardNodeInfos(),i=this.manager.getMeshNode();for(var r in i){if("meshes"===this.manager.getPropertyValueByMaterialKey(r).type)for(var a=i[r],o=0,s=a.length;o<s;o++){var l=a[o],u=l.geometry;if(null!==u){var c=l.indices;for(var h in c){(function(e){var i=n[e];return!(i&&t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(i[0]))})(h)||(this.userIdMapForNoWireFrame[h]=!0);for(var d=c[h],f=0,p=d.length;f<p;f++)this._createWireframeGeometry(u,d[f])}}}}return!0}},{key:"_makeWireframe",value:function(e){var t={},n=e.getWireframeMaterial();for(var i in this.wireframeGeometryMap){var r=this.wireframeGeometryMap[i],a=r._userId,o=new THREE.LineSegments(r,n);o.name=a,o.nodeId=a,t[a]||(t[a]=[]),t[a].push(o),o=null}var s=[];for(var a in t)for(var l=t[a],u=0,c=l.length;u<c;u++)s.push(l[u]);if(s.length>0){var h={},d=CLOUD.GeomUtil.mergeBufferGeometries(s,h);d&&(this.wireframeLineSegment=new THREE.LineSegments(d,e.getWireframeMaterial()),this.wireframeLineSegment._indicesGroup=h)}s=null;for(var a in t)delete t[a];t=null,this.wireframeGeometryMap=null}},{key:"generateWireframe",value:function(e,t){this.generated||(this._createWireframeGeometries(e),this._makeWireframe(e),this.generated=!0,t&&t())}},{key:"update",value:function(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegment){var t=this._getNodeGroup(e);t.clear(),t.add(this.wireframeLineSegment),t.updateMatrixWorld(!0)}}else e._hasNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)}},{key:"rebuildIndices",value:function(e){if(this.needDealWireframeLine(e)){this.wireframeLineSegment.visible=!0;var t=this.wireframeLineSegment._indicesGroup,n=this.wireframeLineSegment.geometry;n.clearGroups();var i=e.getWireframeMaterial();this.wireframeLineSegment.material=i;var r=this.manager.getFilteredUserIdsForWireFrame(),a=!(!r||!Object.keys(r).length);if(this._existHiddenUserId()||a){var o,s,l=[],u=[];for(var c in t)if(!this._isHiddenUserId(c)){var h=t[c];if(h&&h.length>0){if(r[c]){var d=r[c],f=l.indexOf(d);for(-1===f&&(l.push(d),f=l.length-1),o=0,s=h.length;o<s;o++)u.push({indexStart:h[o].indexStart,indexCount:h[o].indexCount,state:1+f});continue}for(o=0,s=h.length;o<s;o++)u.push({indexStart:h[o].indexStart,indexCount:h[o].indexCount,state:0})}}if(0===u.length)return void(this.wireframeLineSegment.visible=!1);for(u.sort(function(e,t){return e.indexStart-t.indexStart}),o=0,s=u.length;o<s;o++){var p=u[o].indexStart,m=u[o].indexCount,g=u[o].state;if(0===o)n.addGroup(p,m,g);else{var v=u[o-1].indexStart,y=u[o-1].indexCount,E=u[o-1].state,b=v+y;g===E&&p===b?n.groups[n.groups.length-1].count+=m:n.addGroup(p,m,g)}}var x=e.getFilter(),M=[i];for(o=0,s=l.length;o<s;o++){var _=x._getMaterialByName(l[o]);M.push(_)}this.wireframeLineSegment.material=M}}}},{key:"explode",value:function(e){if(this.wireframeLineSegment){var t=this.wireframeLineSegment._indicesGroup,n=this.wireframeLineSegment.geometry;for(var i in t){var r=t[i];if(r)for(var a=e.manager.getExplosionTranslation(i),o=0,s=r.length;o<s;o++){var l=r[o].indexStart,u=l+r[o].indexCount;!function(e,t,n,i){for(var r=e.getAttribute("position").array,a=e.getIndex().array,o={},s=t;s<n;s++){var l=a[s];o[l]||(r[3*l]+=i.x,r[3*l+1]+=i.y,r[3*l+2]+=i.z,o[l]=!0)}e.getAttribute("position").needsUpdate=!0,o=null}(n,l,u,a)}}}}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.WIREFRAME,{globalSpace:!0})}},{key:"needDealWireframeLine",value:function(e){return!(!e.isActivateWireframe()||!this.wireframeLineSegment)}},{key:"adjustVisibility",value:function(e,t){if(this.needDealWireframeLine(e)){var n=this._getNodeGroup(e),i=n.visible;t&&!n.bVisible||(n.visible=t),n.bVisible=i}}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&this.wireframeLineSegment.visible&&(this.bufferDestroyed=!0,CLOUD.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["normal","uv","uv2"]))}},{key:"_existHiddenUserId",value:function(){var e=this.manager.getHiddenUserIds();return!!(this.userIdMapForNoWireFrame&&Object.keys(this.userIdMapForNoWireFrame).length||e&&Object.keys(e).length)}},{key:"_isHiddenUserId",value:function(e){if(this.userIdMapForNoWireFrame[e])return!0;var t=this.manager.getHiddenUserIds();return!(!t||!t[e])}},{key:"getWireFrameLineSegments",value:function(){return this.wireframeLineSegment?[this.wireframeLineSegment]:null}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingBatchedWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.BatchedWireframeManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.meshManager=new CLOUD.ModelView.BatchedMeshManager(this),this.wireframeManager=t?new CLOUD.ModelView.DataBatchedWireframeManager(this):new CLOUD.ModelView.BatchedWireframeManager(this)}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}},{key:"updateNodes",value:function(e){this.meshManager.update(e),this.wireframeManager.update(e)}},{key:"generateWireframe",value:function(e,t){this.wireframeManager.generateWireframe(e,t)}},{key:"asyncGenerateWireframe",value:function(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}},{key:"rebuildIndices",value:function(e){this._rebuildIndices(e)}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}},{key:"createMeshNodes",value:function(e,t){this.meshManager.createMeshNodes(e,t)}},{key:"asyncCreateMeshNodes",value:function(e,t,n){this.meshManager.asyncCreateMeshNodes(e,t,n)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"getMeshNode",value:function(){return this.meshManager.getMeshNode()}},{key:"getPropertyValueByMaterialKey",value:function(e){return this.meshManager.getPropertyValueByMaterialKey(e)}},{key:"getFilteredUserIds",value:function(){return this.mapMaterialIdToUserIdsForFilter}},{key:"getSelectedUserIds",value:function(){return this.mapMaterialIdToUserIdsForSelection}},{key:"getHoveredUserIds",value:function(){return this.mapMaterialIdToUserIdsForHover}},{key:"getBlinkedUserIds",value:function(){return this.mapBlinkUserIds}},{key:"getHiddenUserIds",value:function(){return this.hiddenUserIdSetObject}},{key:"getTransparentUserIds",value:function(){return this.transparentUserIdSetObject}},{key:"applyFilter",value:function(e,t){if(this.hasNodeInfo(e)){var n;n=t||e.getModelDescriptor().getStandardUserIds();var i=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,n,i),this._collectFilteredUserIdsForWireFrame(e,n,i),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,i),this._collectHoveredUserIds(e.manager.sceneState.hoverId,i),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._rebuildIndices(e),this.updateNodes(e)}},{key:"_collectFilteredUserIds",value:function(e,t,n){var i=e.getFilter(),r=i._hasHiddenFileIdFilter(),a=i._hasVisibleFilter(),o=i._hasOverrideMaterialFilter(),s=i._hasTransparentFilter(),l=e.hasReplacedUserId(),u=e.hasHiddenSourceObjectUserId(),c=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.overrideUserIdSetObject={},this.transparentUserIdSetObject={},r||a||o||s||l||u)for(var h=0;h<t.length;++h){var d=t[h],f=n[d];if(f&&f.length)for(var p=0,m=f.length;p<m;p++){var g=f[p];if(r&&i._isHiddenFileId(g)||a&&!1===i._isVisible(g)||e.isReplacedUserId(d)||e.isHiddenSourceObjectUserId(d))void 0===c[g.materialId]&&(c[g.materialId]={}),void 0===c[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN]&&(c[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN]={}),c[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN][d]=!0,this.hiddenUserIdSetObject[d]=!0;else if(s&&i._isTransparent(g))void 0===c[g.materialId]&&(c[g.materialId]={}),void 0===c[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT]&&(c[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT]={}),c[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT][d]=!0,this.transparentUserIdSetObject[d]=!0;else if(o&&i._hasOverrideMaterial(g)){var v=i._getOverrideMaterial(g),y=null!=v?v.name:"";""!==y&&(void 0===c[g.materialId]&&(c[g.materialId]={}),void 0===c[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED]&&(c[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED]={}),c[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED][d]=y,this.overrideUserIdSetObject[d]=y)}else;}}}},{key:"_collectFilteredUserIdsForWireFrame",value:function(e,t,n){var i=e.getFilter(),r=i._hasOverrideMaterialFilterForWireFrame();if(this.mapFilteredUserIdsForWireFrame={},r)for(var a=0;a<t.length;++a){var o=t[a];if(!this.hiddenUserIdSetObject[o]){var s=n[o];if(s&&s.length)for(var l=0,u=s.length;l<u;l++){var c=s[l];if(i._hasOverrideMaterialForWireFrame(c)){var h=i._getOverrideMaterialForWireFrame(c),d=null!=h?h.name:"";""!==d&&(this.mapFilteredUserIdsForWireFrame[o]=d)}else;}}}}},{key:"_clearFilteredState",value:function(){this.mapMaterialIdToUserIdsForFilter=null}},{key:"_collectSelectedUserIds",value:function(e,t){var n=this.mapMaterialIdToUserIdsForSelection={};for(var i in e){var r=t[i];if(r&&r.length)for(var a=0,o=r.length;a<o;a++)void 0===n[r[a].materialId]&&(n[r[a].materialId]={}),void 0===n[r[a].materialId][i]&&(n[r[a].materialId][i]=!0)}}},{key:"_clearSelectedState",value:function(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}},{key:"_collectHoveredUserIds",value:function(e,t){var n=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var i=t[e],r=0,a=i.length;r<a;r++)void 0===n[i[r].materialId]&&(n[i[r].materialId]={}),void 0===n[i[r].materialId][e]&&(n[i[r].materialId][e]=!0)}},{key:"_clearHoveredState",value:function(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}},{key:"_collectBlinkedUserIds",value:function(e,t){var n=this.mapBlinkUserIds={};for(var i in e){var r=t[i];if(r&&r.length)for(var a=0,o=r.length;a<o;a++)void 0===n[r[a].materialId]&&(n[r[a].materialId]={}),void 0===n[r[a].materialId][i]&&(n[r[a].materialId][i]=!0)}}},{key:"calculateClippingIds",value:function(e,t){this.meshManager.calculateClippingIds(e,t)}},{key:"_clearBlinkedState",value:function(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}},{key:"_rebuildIndices",value:function(e){this.meshManager.rebuildIndices(e),
this.wireframeManager.rebuildIndices(e)}},{key:"clearCachedData",value:function(){this.meshManager.clearAllNodeBuffer()}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}},{key:"isPickableNode",value:function(e){var t=this.getHiddenUserIds();if(t&&t[e])return!1;var n=this.getTransparentUserIds();return!n||!n[e]}},{key:"isHiddenNode",value:function(e){var t=this.getHiddenUserIds();return!(!t||!t[e])}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}},{key:"getFilteredUserIdsForWireFrame",value:function(){return this.mapFilteredUserIdsForWireFrame}}]),e}();CLOUD.ModelView.BatchedManager=e}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.defaultManager=new CLOUD.ModelView.BatchedManager(n),i.instancedManager=new CLOUD.ModelView.InstancedManager,i.loader=new CLOUD.ModelView.BatchedLoader(i),i}return _inherits(t,e),t}(CLOUD.ModelView.BatchedBaseHandler);CLOUD.ModelView.BatchedHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=null,n.enableBmpkMerged=!1,n.bmpkPkgIndex=null,n}return _inherits(t,e),_createClass(t,[{key:"praseBmpkPkgIndex",value:function(e){var t=this,n=this.url,i=this.fileLoader;t.bmpkPkgIndex={},i.setResponseType("json"),i.load(n.bmpkPkgIndexUrl(),function(n){for(var i in n.bmpks){var r=n.bmpks[i],a=parseInt(i.substring(5,i.length));t.bmpkPkgIndex[a]={};for(var o in r)t.bmpkPkgIndex[a][o]=r[o]}t._loadAllMpks(e)})}},{key:"loadSceneAndMpks",value:function(e){var t=this;e.bmpk_merged&&(t.enableBmpkMerged=!0),t.url.mpkUrl=t.url.bmpkUrl,e.symbol?this._loadSymbol(function(){t._loadScene(0)}):t._loadScene(0),t._loadBMpkIndex(),e.lines&&t._loadLine(),e.bmpks&&(t.enableBmpkMerged?t.praseBmpkPkgIndex(e.bmpks):t._loadAllMpks(e.bmpks)),CLOUD.GlobalData.BorderLineDelayLoaded||t._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=2;return t+=e.symbol,t+=e.lines,t+=e.bmpks,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}},{key:"_loadBMpkIndex",value:function(){var e=this,t=this.url,n=this.fileLoader;n.setResponseType("arraybuffer"),n.load(t.bmpkIndexUrl(),function(t){e._paserBMeshId(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()})}},{key:"_paserBMeshId",value:function(e){this.descriptor.bmeshIdReader=new CLOUD.Loader.BMeshIdReader(e)}},{key:"_parseReferencedMeshBufferData",value:function(e,t,n,i,r,a){for(var o=[],s=this,l=void 0!==a?!a:void 0,u=t;u<n;++u){var c=e.getOffsetIndexInfo(u,l);c&&o.push(c)}var h=o.length,d=4*o[0].positionStart,f=4*(o[h-1].positionStart+o[h-1].positionCount),p=e.vBuffer.slice(d,f),m=4*o[0].indexStart,g=4*(o[h-1].indexStart+o[h-1].indexCount),v=e.iBuffer.slice(m,g);if(r){var y=new Uint32Array(v),E=o[0].positionStart/3;y.forEach(function(e,t,n){n[t]-=E}),v=y}var b,x=e.getMeshData(t).nOffset,M=e.getMeshData(n-1).nOffset+3*e.getMeshData(n-1).ptCount*4,_=e.nBuffer.slice(x,M);if(l)b=null;else if(r){var C=4*o[0].uvStart,I=4*(o[h-1].uvStart+o[h-1].uvCount);b=e.tBuffer.slice(C,I)}else b=e.tBuffer.slice();var O=o[0].positionStart,T=o[0].indexStart,L=o[0].uvStart;if(0!=O)for(var u=0;u<h;++u)o[u].positionStart-=O,o[u].indexStart-=T,o[u].uvStart-=L;s.descriptor.cacheReferencedMeshBufferData(i,{P:p,I:v,N:_,UV:b,IndexInfos:o})}},{key:"_parseMpk",value:function(e,t){var n=new CLOUD.Loader.BMPKReader(e),i=this;if(i.enableBmpkMerged){var r=65536*t;if(t in i.bmpkPkgIndex){var a=Object.keys(i.bmpkPkgIndex[t]).length;if(1===a)i._parseReferencedMeshBufferData(n,0,n.header.meshCount,r);else{for(var o,s=i.bmpkPkgIndex[t],l=0,u=1;u<=a-1;u++){var c=s[u].mesh_index,h=c,d=r+l;o=s[u-1].texture,i._parseReferencedMeshBufferData(n,l,h,d,!0,o),l=h}l=s[a-1].mesh_index,o=s[a-1].texture;var d=r+l;i._parseReferencedMeshBufferData(n,l,n.header.meshCount,d,!0,o)}}else i._parseReferencedMeshBufferData(n,0,n.header.meshCount,r)}else i._parseReferencedMeshBufferData(n,0,n.header.meshCount,t);n=null}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.DataBatchedBaseLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.DataBatchedDescriptor,n}return _inherits(t,e),t}(CLOUD.ModelView.DataBatchedBaseLoader);CLOUD.ModelView.DataBatchedLoader=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.bmeshIdReader=null,e}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.bmeshIdReader=null}},{key:"convertGeometryId",value:function(e){var t=this.bmeshIdReader.getBMeshId(e);return void 0===t&&(t=e),t}}]),t}(CLOUD.ModelView.DefaultDescriptor);CLOUD.ModelView.DataBatchedDescriptor=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.generated=!1,this.wireframeLineSegments=[],this.parameterizedShapeWireframeBufferMap={},this.userIdMapForNoWireFrame={},this.processedThresholdPerShared=1e3,this.splitSegmentEnabled=!0,this.splitCountPerSegment=1e4}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this.userIdMapForNoWireFrame=null;for(var e=0,t=this.wireframeLineSegments.length;e<t;e++)this.wireframeLineSegments[e]._indicesGroup=null,this.wireframeLineSegments[e].geometry.dispose(),this.wireframeLineSegments[e]=null;this.wireframeLineSegments=null,this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.parameterizedShapeWireframeBufferMap=null}},{key:"clearData",value:function(){this.generated=!1,this.userIdMapForNoWireFrame={};for(var e=0,t=this.wireframeLineSegments.length;e<t;e++)this.wireframeLineSegments[e]._indicesGroup=null,this.wireframeLineSegments[e].geometry.dispose(),this.wireframeLineSegments[e]=null;this.wireframeLineSegments=[],this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData()}},{key:"_needWireframing",value:function(e,t){var n=e.getFilter(),i=e.getModelDescriptor().getStandardNodeInfos();return!(!i||!i[t.userId])&&!(n._hasRenderWithBoardlineFilter()&&!n._isRenderWithBoardline(t))}},{key:"_getWireframeBufferByIdForParameterizedShape",value:function(e,t){var n=this.parameterizedShapeWireframeBufferMap;if(n[e])return n[e];n[e]=[];for(var i=0,r=t.length;i<r;i++){var a=t[i];n[e].push({index:CLOUD.BuildEdge(a.attributes.position.array,a.index.array),position:a.attributes.position.array})}return n[e]}},{key:"_dealWireframesForParameterizedShape",value:function(e){if(!CLOUD.GlobalData.Instance){for(var t=e.getModelDescriptor().getNodeInfosWithParameterizedDesc(),n={},i=e.getWireframeMaterial(),r=Object.keys(t),a=0,o=r.length;a<o;a++)for(var s=t[r[a]],l=0,u=s.length;l<u;l++){var c=s[l];this._needWireframing(e,c)||(this.userIdMapForNoWireFrame[c.userId]=!0);var h=this.manager.meshManager.getGeometryByNodeInfo(e,c);h instanceof Array||(h=[h]);for(var d=this._getWireframeBufferByIdForParameterizedShape(c.geometryId,h),f=0,p=d.length;f<p;f++){var m=d[f].index,g=d[f].position.slice();CLOUD.GeomUtil.applyMatrix4ToBuffer(c.matrix,g);var v=new THREE.BufferGeometry;v.setIndex(new THREE.Uint32BufferAttribute(m,1)),v.addAttribute("position",new THREE.BufferAttribute(g,3));var y=new THREE.LineSegments(v,i);y.name=c.userId,y.nodeId=c.userId,n[c.userId]||(n[c.userId]=[]),n[c.userId].push(y)}}var E=[];for(var b in n)for(var x=n[b],f=0,M=x.length;f<M;f++)E.push(x[f]);if(E.length>0){var _={},C=CLOUD.GeomUtil.mergeBufferGeometries(E,_);if(C){var I=new THREE.LineSegments(C,i);I._indicesGroup=_,this.wireframeLineSegments.push(I)}}}}},{key:"_dealSharedBorderLines",value:function(e){var t=e.getModelDescriptor().getSharedBorderLineCache();if(t){for(var n=e.getModelDescriptor().getNodeInfosOnGeometryId(),i={},r=e.getWireframeMaterial(),a=this.processedThresholdPerShared,o=0,s=t.length;o<s;o++)for(var l=t[o],u=l.IndexInfos,c=0,h=u.length;c<h;c++){var d=u[c],f=e.getModelDescriptor().convertGeometryId(d.meshId),p=n[f];if(p&&!(p.length>a))for(var m=new Uint32Array(l.I),g=new Float32Array(l.P),v=0,y=p.length;v<y;v++){var E=p[v];this._needWireframing(e,E)||(this.userIdMapForNoWireFrame[E.userId]=!0);var b=g.slice(d.positionStart,d.positionStart+d.positionCount),x=d.positionStart/3,M=m.slice(d.indexStart,d.indexStart+d.indexCount);M.forEach(function(e,t,n){n[t]-=x}),CLOUD.GeomUtil.applyMatrix4ToBuffer(E.matrix,b);var _=new THREE.BufferGeometry;_.setIndex(new THREE.Uint32BufferAttribute(M,1)),_.addAttribute("position",new THREE.BufferAttribute(b,3));var C=new THREE.LineSegments(_,r);C.name=E.userId,C.nodeId=E.userId,i[E.userId]||(i[E.userId]=[]),i[E.userId].push(C)}}var I=[];for(var O in i)for(var T=i[O],c=0,L=T.length;c<L;c++)I.push(T[c]);if(!(I.length<1))if(this.splitSegmentEnabled){for(var S=this.splitCountPerSegment,D=Math.floor(I.length/S),w=I.length%S,c=0;c<D;c++){var U=I.slice(c*S,(c+1)*S),R={},A=CLOUD.GeomUtil.mergeBufferGeometries(U,R);if(A){var N=new THREE.LineSegments(A,r);N._indicesGroup=R,this.wireframeLineSegments.push(N)}}if(w){var U=I.slice(D*S,D*S+w),R={},A=CLOUD.GeomUtil.mergeBufferGeometries(U,R);if(A){var N=new THREE.LineSegments(A,r);N._indicesGroup=R,this.wireframeLineSegments.push(N)}}}else{var R={},A=CLOUD.GeomUtil.mergeBufferGeometries(I,R);if(A){var N=new THREE.LineSegments(A,r);N._indicesGroup=R,this.wireframeLineSegments.push(N)}}}}},{key:"_dealUniqueBorderLines",value:function(e){var t=e.getModelDescriptor().getUniqueBorderLineCache();if(t)for(var n=e.getModelDescriptor().getNodeInfosOnGeometryId(),i={},r=0,a=t.length;r<a;r++){for(var o=t[r],s=o.IndexInfos,l=0,u=s.length;l<u;l++){var c=s[l],h=e.getModelDescriptor().convertGeometryId(c.meshId),d=n[h];if(d)for(var f=0,p=d.length;f<p;f++){var m=d[f];i[m.userId]||(i[m.userId]=[]);var g,v;this._needWireframing(e,m)||(this.userIdMapForNoWireFrame[m.userId]=!0),g=c.indexStart,v=c.indexCount,i[m.userId].push({nodeId:m.nodeId,indexStart:g,indexCount:v})}}var y=new THREE.BufferGeometry;y.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(o.I),1)),y.addAttribute("position",new THREE.BufferAttribute(new Float32Array(o.P),3));var E=new THREE.LineSegments(y,e.getWireframeMaterial());E._indicesGroup=i,this.wireframeLineSegments.push(E)}}},{key:"_createWireframeGeometries",value:function(e){this._dealWireframesForParameterizedShape(e),this._dealUniqueBorderLines(e),this._dealSharedBorderLines(e)}},{key:"generateWireframe",value:function(e,t){e.isActivateWireframe()&&(this.generated||(this._createWireframeGeometries(e),this.generated=!0))}},{key:"_asyncDealSharedBorderLines",value:function(e,t){var n=e.getModelDescriptor().getSharedBorderLineCache();if(!n)return void(t&&t());for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r={},a=e.getWireframeMaterial(),o=n.length,s=0,l=this,u=0;u<o;u++){var c=n[u];CLOUD.Utils.asyncProcess(c,c.IndexInfos.length,10,function(t,n){var o=t,s=o.IndexInfos[n],u=e.getModelDescriptor().convertGeometryId(s.meshId),c=i[u];if(c)for(var h=new Uint32Array(o.I),d=new Float32Array(o.P),f=0,p=c.length;f<p;f++){var m=c[f];l._needWireframing(e,m)||(l.userIdMapForNoWireFrame[m.userId]=!0);var g=d.slice(s.positionStart,s.positionStart+s.positionCount),v=s.positionStart/3,y=h.slice(s.indexStart,s.indexStart+s.indexCount);y.forEach(function(e,t,n){n[t]-=v}),CLOUD.GeomUtil.applyMatrix4ToBuffer(m.matrix,g);var E=new THREE.BufferGeometry;E.setIndex(new THREE.Uint32BufferAttribute(y,1)),E.addAttribute("position",new THREE.BufferAttribute(g,3));var b=new THREE.LineSegments(E,a);b.name=m.userId,b.nodeId=m.userId,r[m.userId]||(r[m.userId]=[]),r[m.userId].push(b)}},function(){if(++s===o){var e=[];for(var n in r)for(var i=r[n],u=0,c=i.length;u<c;u++)e.push(i[u]);if(e.length>0){var h={},d=CLOUD.GeomUtil.mergeBufferGeometries(e,h);if(d){var f=new THREE.LineSegments(d,a);f._indicesGroup=h,l.wireframeLineSegments.push(f)}}t&&t()}})}}},{key:"_asyncDealUniqueBorderLines",value:function(e,t){var n=e.getModelDescriptor().getUniqueBorderLineCache();if(!n)return void(t&&t());for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r={},a=this,o=0,s=n.length,l=0;l<s;l++){var u=n[l];CLOUD.Utils.asyncProcess(u,u.IndexInfos.length,10,function(t,n){var o=t,s=o.IndexInfos[n],l=e.getModelDescriptor().convertGeometryId(s.meshId),u=i[l];if(u)for(var c=0,h=u.length;c<h;c++){var d=u[c];r[d.userId]||(r[d.userId]=[]);var f,p;a._needWireframing(e,d)||(a.userIdMapForNoWireFrame[d.userId]=!0),f=s.indexStart,p=s.indexCount,r[d.userId].push({nodeId:d.nodeId,indexStart:f,indexCount:p})}},function(n){o++;var i=n,l=new THREE.BufferGeometry;l.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(i.I),1)),l.addAttribute("position",new THREE.BufferAttribute(new Float32Array(i.P),3));var u=new THREE.LineSegments(l,e.getWireframeMaterial());u._indicesGroup=r,a.wireframeLineSegments.push(u),o===s&&t&&t()})}}},{key:"_asyncCreateWireframeGeometries",value:function(e,t){var n=this;this._dealWireframesForParameterizedShape(e),this._asyncDealUniqueBorderLines(e,function(){n._asyncDealSharedBorderLines(e,function(){t&&t()})})}},{key:"asyncGenerateWireframe",value:function(e,t){e.isActivateWireframe()&&(this.generated||(this._asyncCreateWireframeGeometries(e,t),this.generated=!0))}},{key:"update",value:function(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegments.length){var t=this._getNodeGroup(e);t.clear();for(var n=0,i=this.wireframeLineSegments.length;n<i;n++)t.add(this.wireframeLineSegments[n]);t.updateMatrixWorld(!0)}}else e._hasNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)}},{key:"rebuildIndicesForLineSegment",value:function(e,t){t.visible=!0;var n=t._indicesGroup,i=t.geometry;i.clearGroups();var r=e.getWireframeMaterial();t.material=r;var a,o,s=this.manager.getFilteredUserIdsForWireFrame(),l=[],u=[];for(var c in n)if(!this._isHiddenUserId(c)){var h=n[c];if(h&&h.length>0){if(s&&s[c]){var d=s[c],f=l.indexOf(d);for(-1===f&&(l.push(d),f=l.length-1),a=0,o=h.length;a<o;a++)u.push({indexStart:h[a].indexStart,indexCount:h[a].indexCount,state:1+f});continue}for(a=0,o=h.length;a<o;a++)u.push({indexStart:h[a].indexStart,indexCount:h[a].indexCount,state:0})}}if(0===u.length)return void(t.visible=!1);for(u.sort(function(e,t){return e.indexStart-t.indexStart}),a=0,o=u.length;a<o;a++){var p=u[a].indexStart,m=u[a].indexCount,g=u[a].state;if(0===a)i.addGroup(p,m,g);else{var v=u[a-1].indexStart,y=u[a-1].indexCount,E=u[a-1].state,b=v+y;g===E&&p===b?i.groups[i.groups.length-1].count+=m:i.addGroup(p,m,g)}}var x=e.getFilter(),M=[r];for(a=0,o=l.length;a<o;a++){var _=x._getMaterialByName(l[a]);M.push(_)}t.material=M}},{key:"rebuildIndices",value:function(e){if(this.needDealWireframeLine(e))for(var t=0,n=this.wireframeLineSegments.length;t<n;t++)this.rebuildIndicesForLineSegment(e,this.wireframeLineSegments[t])}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.WIREFRAME,{globalSpace:!0})}},{key:"needDealWireframeLine",value:function(e){return!!(e.isActivateWireframe()&&this.wireframeLineSegments&&this.wireframeLineSegments.length)}},{key:"adjustVisibility",value:function(e,t){if(this.needDealWireframeLine(e)){var n=this._getNodeGroup(e),i=n.visible;t&&!n.bVisible||(n.visible=t),n.bVisible=i}}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&(this.bufferDestroyed=!0,CLOUD.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["position","normal","uv","uv2"]))}},{key:"explode",value:function(e){for(var t=0,n=this.wireframeLineSegments.length;t<n;t++){var i=this.wireframeLineSegments[t],r=i._indicesGroup,a=i.geometry;for(var o in r){var s=r[o];if(s)for(var l=e.manager.getExplosionTranslation(o),u=0,c=s.length;u<c;u++){var h=s[u].indexStart,d=h+s[u].indexCount;!function(e,t,n,i){for(var r=e.getAttribute("position").array,a=e.getIndex().array,o={},s=t;s<n;s++){var l=a[s];o[l]||(r[3*l]+=i.x,r[3*l+1]+=i.y,r[3*l+2]+=i.z,o[l]=!0)}e.getAttribute("position").needsUpdate=!0,o=null}(a,h,d,l)}}}}},{key:"_isHiddenUserId",value:function(e){if(this.userIdMapForNoWireFrame[e])return!0;var t=this.manager.getHiddenUserIds();return!(!t||!t[e])}},{key:"getWireFrameLineSegments",value:function(){return this.wireframeLineSegments}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingBatchedWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.DataBatchedWireframeManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="merge_data",n.defaultManager=null,n.instancedManager=null,n.loader=null,n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var n=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(),!this.model.lightmap||this.model.enableLightmap==CLOUD.GlobalData.EnableLightmap&&this.model.lightmapIntensity==CLOUD.GlobalData.LightmapIntensity&&n==CLOUD.GlobalData.EnableTextureMapping||(this.model.enableLightmap=CLOUD.GlobalData.EnableLightmap,this.model.lightmapIntensity=CLOUD.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}},{key:"settleData",value:function(e){this.model.getModelDescriptor().cacheNodeInfosOnGeometryId(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"createMeshNodes",value:function(e){var t=this,n=this.model;this.instancedManager.createMeshNodes(n),this.defaultManager.createMeshNodes(n,function(){n.getMaterialManager()._updateTextureMapping(),t.clearCachedData(n),t.loaded=!0,e&&e()})}},{key:"clearCachedData",value:function(e){e.getModelDescriptor().destroyReader(),e.getModelDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}]),t}(CLOUD.ModelView.ModelBaseHandler);CLOUD.ModelView.DataBatchedBaseHandler=e}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.defaultManager=new CLOUD.ModelView.BatchedManager(n),i.instancedManager=new CLOUD.ModelView.InstancedManager,i.loader=new CLOUD.ModelView.DataBatchedLoader(i),i}return _inherits(t,e),t}(CLOUD.ModelView.DataBatchedBaseHandler);CLOUD.ModelView.DataBatchedHandler=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.conditionsChanged=!0,this.nodeInfosWithLayerKey={},this.cachedLayerData={},this.cacheAttributes=null,this.cacheSpecialtysLevels={},this.mapLayerKeys={},this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.lastUsedLayerData=null,this.mapNeededConditions=null}return _createClass(e,[{key:"destroy",value:function(){this.cachedLayerData=null,this.nodeInfosWithLayerKey=null,this.cacheAttributes=null,this.cacheSpecialtysLevels=null,this.mapLayerKeys=null,this.lastUsedLayerData=null,this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.mapNeededConditions=null,this.lastLayerKeyMap=null,this.cachedLayerKeys=null}},{key:"clearData",value:function(){}},{key:"loadLayerDataByIdxs",value:function(e,t,n,i){}},{key:"dealLayerDataLoading",value:function(e,t,n,i,r){}},{key:"loadMpkOnDemand",value:function(e,t,n,i,r){var a=e?this.getAllLayerIdxData():this.getUsedLayerIdxData();this.dealLayerDataLoading(this.getLayerIdxInfoByLayerData(a),t,n,i,r)}},{key:"getUsedIdxsInfoFrom",value:function(e,t){var n,i={},r={},a={},o={};if(e&&e.length)for(var s=0,l=e.length;s<l;++s)n=e[s],i[n]=!0;if(t)if(CLOUD.Utils.isEmptyObject(i))a=t;else{for(n in t)i[n]&&(o[n]=!0);if(CLOUD.Utils.isEmptyObject(o))r=i,a=t;else{for(n in t)o[n]||(a[n]=!0);for(n in i)o[n]||(r[n]=!0)}}else CLOUD.Utils.isEmptyObject(i)||(r=i);return{objCurrUsedIdxs:i,addIdxs:Object.keys(r),removeIdxs:Object.keys(a)}}},{key:"getLayerIdxInfoByLayerData",value:function(e){var t,n;e?(t=e.layerIds,n=e.mpkIdxs):(t=null,n=null);var i=this.getUsedIdxsInfoFrom(t,this.lastUsedLayerIdsObject);this.lastUsedLayerIdsObject=i.objCurrUsedIdxs;var r=this.getUsedIdxsInfoFrom(n,this.lastUsedMpkIdxsObject);return this.lastUsedMpkIdxsObject=r.objCurrUsedIdxs,{layerScene:i,mpk:r}}},{key:"getUsedLayerIdxData",value:function(){if(!this.isConditionsChanged()&&this.lastUsedLayerData)return this.lastUsedLayerData;this.setConditionsChanged(!1);var e=this.getConditionsOnDemand();if(!e)return this.lastUsedLayerData=null,null;var t=this.getCachedLayerData(),n=[],i=[],r=[],a=[];for(var o in e)if(t[o]){for(var s=t[o].mpkIdxs,l=0,u=s.length;l<u;++l)r.push(s[l]);n.push(o),i.push(t[o].layerId),a.push(t[o].boundingBox)}return this.lastUsedLayerData={layerIds:i,layerKeys:n,boundingBoxes:a,mpkIdxs:r},this.lastUsedLayerData}},{key:"getAllLayerIdxData",value:function(){this.setConditionsChanged(!1);var e=this.getCachedLayerData();if(!e)return null;var t=[],n=[],i=[],r=[];for(var a in e){for(var o=e[a].mpkIdxs,s=0,l=o.length;s<l;++s)i.push(o[s]);t.push(a),n.push(e[a].layerId),r.push(e[a].boundingBox)}return{layerIds:n,layerKeys:t,boundingBoxes:r,mpkIdxs:i}}},{key:"getUserIdsOnDemand",value:function(){var e={},t=this.nodeInfosWithLayerKey,n=this.getConditionsOnDemand();if(n)for(var i in n){var r=t[i];if(r)for(var a=0,o=r.length;a<o;a++)e[r[a].userId]=!0}else for(var i in t){var r=t[i];if(r)for(var a=0,o=r.length;a<o;a++)e[r[a].userId]=!0}return e}},{key:"cacheLayerData",value:function(e,t){this.cachedLayerData[e]=t}},{key:"getCachedLayerData",value:function(){return this.cachedLayerData}},{key:"getCachedLayerKeys",value:function(){if(this.cachedLayerKeys)return this.cachedLayerKeys;this.cachedLayerKeys={};var e=this.getCachedLayerData();for(var t in e)e.hasOwnProperty(t)&&(this.cachedLayerKeys[t]=!0);return this.cachedLayerKeys}},{key:"clearNodeInfoCacheWithLayerKey",value:function(){this.nodeInfosWithLayerKey={}}},{key:"cacheNodeInfoByLayerKey",value:function(e,t){this.nodeInfosWithLayerKey[e]||(this.nodeInfosWithLayerKey[e]=[]),this.nodeInfosWithLayerKey[e].push(t)}},{key:"cacheNodeInfosWithLayerKey",value:function(){var e=this.model.getModelDescriptor().getAllNodeInfos();for(var t in e)for(var n=e[t],i=0,r=n.length;i<r;i++){var a=n[i],o=this.formatLayerIds(a.userData);this.cacheNodeInfoByLayerKey(o[0],a)}}},{key:"cacheLayerKeys",value:function(e){this.mapLayerKeys=e;var t={},n=this.getLayerKeyAttributes();for(var i in e){var r=e[i],a=r[n[0]],o=r[n[1]];t.hasOwnProperty(a)||(t[a]=[]),t.hasOwnProperty(o)||(t[o]=[]),t[a].push(o),t[o].push(a)}this.cacheSpecialtysLevels=t}},{key:"getLayerKeyAttributes",value:function(){if(this.cacheAttributes)return this.cacheAttributes;var e=[],t=Object.keys(this.mapLayerKeys),n=t[0],i=this.mapLayerKeys[n];for(var r in i)i.hasOwnProperty(r)&&e.push(r);return this.cacheAttributes=e,this.cacheAttributes}},{key:"formatLayerIds",value:function(e){var t=[];if(!e)return t.push("unknown"),t;var n=this.getLayerKeyAttributes(),i=e[n[0]],r=e[n[1]];if(e.hasOwnProperty(n[0])&&e.hasOwnProperty(n[1]))if(i instanceof Array&&r instanceof Array)for(var a=0;a<i.length;a++)for(var o=0;o<r.length;o++){var s=i[a]+"-"+r[o];t.push(s)}else if(i instanceof Array)for(var o=0;o<i.length;o++){var s=i[o]+"-"+r;t.push(s)}else if(r instanceof Array)for(var o=0;o<r.length;o++){var s=i+"-"+r[o];t.push(s)}else{var s=i+"-"+r;t.push(s)}else if(e.hasOwnProperty(n[0]))if(e.hasOwnProperty(n[1]))t.push("unknown"),console.warn("Object has no "+n[0]+" and "+n[1]);else if(i instanceof Array)for(var o=0;o<i.length;o++)for(var l=i[o],u=this.getLevelsOrSpecialtys(l),a=0;a<u.length;a++)s=l+"-"+u[a],t.push(s);else for(var l=i,u=this.getLevelsOrSpecialtys(l),a=0;a<u.length;a++)s=l+"-"+u[a],t.push(s);else if(r instanceof Array)for(var o=0;o<r.length;o++)for(var l=r[o],u=this.getLevelsOrSpecialtys(l),a=0;a<u.length;a++)s=u[a]+"-"+l,t.push(s);else for(var l=r,u=this.getLevelsOrSpecialtys(l),a=0;a<u.length;a++)s=u[a]+"-"+l,t.push(s);return t}},{key:"getLevelsOrSpecialtys",value:function(e){return this.cacheSpecialtysLevels.hasOwnProperty(e)?this.cacheSpecialtysLevels[e]:(console.warn("Attribute "+e+"has no according levels or specialtys."),[])}},{key:"getUnionBoundingBoxOnDemand",value:function(){var e=this.getBoundingBoxesOnDemand();if(e&&e.length>0){for(var t=new THREE.Box3,n=0,i=e.length;n<i;++n)t.union(e[n]);return t}return null}},{key:"getBoundingBoxesOnDemand",value:function(){var e=this.getUsedLayerIdxData();return e?e.boundingBoxes:null}},{key:"setConditionsOnDemandLoad",value:function(e){var t={};if(e&&e instanceof Array){t={};for(var n=0,i=e.length;n<i;n++)for(var r=e[n],a=this.formatLayerIds(r),o=0;o<a.length;o++)t.hasOwnProperty(a[o])||(t[a[o]]=!0)}else t=this.getCachedLayerKeys();var s=this._isLayerKeysChanged(t);return s&&(this.mapNeededConditions=t,this.setConditionsChanged(!0)),s}},{key:"_isLayerKeysChanged",value:function(e){var t=!1;if(void 0!==this.lastLayerKeyMap){var n=Object.keys(this.lastLayerKeyMap),i=Object.keys(e);if(n.length!==i.length)t=!0;else for(var r=0,a=i.length;r<a;r++){var o=i[r];if(void 0===this.lastLayerKeyMap[o]){t=!0;break}}}else t=!0;return t&&(this.lastLayerKeyMap=e),t}},{key:"setConditionsChanged",value:function(e){this.conditionsChanged=e}},{key:"getConditionsOnDemand",value:function(){return this.mapNeededConditions}},{key:"isConditionsChanged",value:function(){return this.conditionsChanged}}]),e}();CLOUD.ModelView.LayerBaseProvider=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n._loadingOnDemand=!1,n}return _inherits(t,e),_createClass(t,[{key:"loadMpkOnDemand",value:function(e,t,n){for(var i=0,r=e.length;i<r;++i)this.mpkTaskManager.addTask(e[i]);var a=this;this.mpkTaskManager.processTasks(this._loadMpk.bind(this),t,function(){a._loadingOnDemand=!1,n&&n()})}},{key:"resetProcessState",value:function(e){this.loadTaskCount=0,this.maxLoadTaskCount=e,this._loadingOnDemand=!0}},{key:"dealProgressSegment",value:function(e,t){return CLOUD.GlobalData.BatchMergeEnabled&&this._loadingOnDemand?t*e.progressPercentage.load:t}},{key:"_loadLayerKey",value:function(){var e=this,t=this.fileLoader,n=this.url,i=this.model,r=this.handler.getLayerProvider();t.setResponseType(""),t.load(n.layerKeyUrl(),function(t){var n=new CLOUD.Loader.LayerKeyReader(t),i=[],a=n.getData();r.cacheLayerKeys(a);for(var o=0,s=n.getCount();o<s;++o){var l=n.getLayerKey(o),u=r.formatLayerIds(l);i.push(u[0])}e._loadLayer(i)},void 0,function(t){i.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:t}),e._onTaskFinished()})}},{key:"_loadLayer",value:function(e){var t=this,n=this.fileLoader,i=this.url,r=this.model,a=this.handler.getLayerProvider();n.setResponseType("arraybuffer"),n.load(i.layerUrl(),function(n){for(var i=new CLOUD.Loader.LayerReader(n),r=0,o=i.getLayerCount();r<o;++r)if(void 0!==e[r]){for(var s=[],l=i.getLayerData(r),u=i.getMpkList(r),c=0,h=u.length;c<h;++c)s.push(u[c]);a.cacheLayerData(e[r],{layerId:l.layer_id,boundingBox:l.boundingBox,mpkIdxs:s})}t._onTaskFinished()},void 0,function(e){r.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),t._onTaskFinished()})}},{key:"delayLoadResources",value:function(e){var t=this.model.getConfig().metadata;if(0===t.lines)return void(e&&e());this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.maxLoadTaskCount+=t.lines,t.lines&&this._loadLine()}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.LayerBaseLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.layerDataLoaded=!1,n.loadedUserIdsObject=null,n.loadedUserIds=null,n.layerProvider=null,n.firstToLoad=!0,n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.loadedUserIdsObject=null,this.loadedUserIds=null,this.layerProvider.destroy(),this.layerProvider=null}},{key:"getLayerProvider",value:function(){return this.layerProvider}},{key:"load",value:function(e){var t=this,n=this.model;this.loader.setNotifyProgress(e),this.loader.load(function(){n.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START})},function(e){n.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:e})},function(){t.processLoadCompleted(function(){n.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE})})})}},{key:"unload",value:function(e,t){}},{key:"loadMpkOnDemand",value:function(e,t,n,i){var r=this,a=this.model,o=!e,s=function(e){a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_DEMAND_LOAD_PROGRESS,progress:e})};if(this.firstToLoad)this.loader.delayLoadResources(function(){r.firstToLoad=!1,r.loader.finishCallback=null,r.prepareData(function(){r.loader.progressCallback=s,r.getLayerProvider().setConditionsOnDemandLoad(e),r._loadMpkOnDemand(o,t,n,i)})});else{r.loader.progressCallback=s;r.getLayerProvider().setConditionsOnDemandLoad(e)?r._loadMpkOnDemand(o,t,n,i):(t&&t(),i&&i())}}},{key:"_loadMpkOnDemand",value:function(e,t,n,i){var r=this,a=this.model;this.layerDataLoaded=!1,t&&t(),a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_DEMAND_LOAD_START}),this.getLayerProvider().loadMpkOnDemand(e,function(e){r.dealData(e)},function(e,t){r.unload(e,t)},n,function(){r.layerDataLoaded=!0,a.manager.updateFilterManager(),console.log("load finish"),a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_DEMAND_LOAD_COMPLETE,data:{boundingBox:a.manager.getLoadOnDemandDirector().getBoundingBoxForUsedComponent()}}),i&&i()})}},{key:"processLoadCompleted",value:function(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.loaded=!0,t.updateOctreeNode(),requestAnimationFrame(function(){e&&e(),t.debut(t)})}},{key:"isAllReady",
value:function(){return!(!this.isLoaded()||this.isHidden()||!this.isLayerDataLoaded())}},{key:"applyFilter",value:function(){if(this.isLoaded()&&this.isLayerDataLoaded()){var e=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);if(e.length&&this.defaultManager.applyFilter(this.model,e),CLOUD.GlobalData.Instance){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.applyFilter(this.model,t)}}}},{key:"needUpdate",value:function(){return!!this.isLayerDataLoaded()}},{key:"clearData",value:function(){}},{key:"initData",value:function(e){}},{key:"dealMeshNodes",value:function(e){}},{key:"dealData",value:function(e){var t=this;this.clearData(),this.initData(function(){t.model.manager.loadOverrideMaterialsByDemand(function(){t.dealMeshNodes(e)},function(){t.dealMeshNodes(e)})})}},{key:"getLoadedUserIdsObject",value:function(){return this.loadedUserIdsObject}},{key:"isLayerDataLoaded",value:function(){return this.layerDataLoaded}},{key:"clearLoadedState",value:function(){this.layerDataLoaded=!1,this.loadedUserIdsObject=null,this.loadedUserIds=null}}]),t}(CLOUD.ModelView.ModelBaseHandler);CLOUD.ModelView.LayerBaseHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.layerProvider=new CLOUD.ModelView.LayerProvider(e),n}return _inherits(t,e),_createClass(t,[{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}},{key:"clearData",value:function(){this.model.clearNodeGroup(),this.model.clearMeshFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"initData",value:function(e){this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}},{key:"unload",value:function(e,t){var n=this;this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,function(e){n.defaultManager.disposeGeometry(e)})}}]),t}(CLOUD.ModelView.LayerBaseHandler);CLOUD.ModelView.LayerHandler=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"loadLayerDataByIdxs",value:function(e,t,n,i){this.model.getLoader().resetProcessState(t.length),this.model.getLoader().loadMpkOnDemand(t,function(e,t){n&&n(t-e,t)},i)}},{key:"dealLayerDataLoading",value:function(e,t,n,i,r){var a=e.mpk;if(0===a.addIdxs.length&&0===a.removeIdxs.length)return void(t&&t(r));var o=!1;a.removeIdxs.length>0&&(o=!0,n&&n(null,a.removeIdxs)),a.addIdxs.length>0?this.loadLayerDataByIdxs(null,a.addIdxs,i,function(){t&&t(r)}):o?t&&t(r):r&&r()}}]),t}(CLOUD.ModelView.LayerBaseProvider);CLOUD.ModelView.LayerProvider=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),t}(CLOUD.ModelView.DefaultDescriptor);CLOUD.ModelView.LayerDescriptor=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.LayerDescriptor,n}return _inherits(t,e),_createClass(t,[{key:"loadSceneAndMpks",value:function(e){e.symbol&&this._loadSymbol(),this._loadScene(0),this._loadLayerKey(),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=2;return t+=e.symbol,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}]),t}(CLOUD.ModelView.LayerBaseLoader);CLOUD.ModelView.LayerLoader=e}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="layer",i.defaultManager=new CLOUD.ModelView.BatchedManager(n),i.instancedManager=new CLOUD.ModelView.InstancedManager,i.loader=new CLOUD.ModelView.LayerLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var n=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);n.length?this.defaultManager.asyncCreateMeshNodes(this.model,n,e):e&&e()}}]),t}(CLOUD.ModelView.LayerHandler);CLOUD.ModelView.LayerBatchedHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.layerProvider=new CLOUD.ModelView.LayerSceneProvider(e),n}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){this.dataReady||(this.dataReady=!0,this.settleData(e))}},{key:"settleData",value:function(e){this.loaded=!0,e&&e()}},{key:"clearData",value:function(){this.model.clearNodeGroup(),this.model.removeAllFromOctantMap(),this.model.getModelDescriptor().clearNodeInfosWithGeometryId(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}},{key:"initData",value:function(e){this.model.getModelDescriptor().parseItemData(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.addNodeInfoToOctantMap(),this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"unload",value:function(e,t){var n=this;this.model.getModelDescriptor().removeFromSceneReaderMap(e),this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,function(e){n.defaultManager.disposeGeometry(e)})}}]),t}(CLOUD.ModelView.LayerBaseHandler);CLOUD.ModelView.LayerSceneHandler=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"clearData",value:function(){this.model.getModelDescriptor().clearNodeInfoCache(),this.clearNodeInfoCacheWithLayerKey()}},{key:"loadLayerDataByIdxs",value:function(e,t,n,i){var r=this.model.getLoader(),a=e.length,o=t.length;if(a&&o){var s=a+o;r.resetProcessState(s),r.loadLayerScenesOnDemand(e,function(e,t){n&&n(t-e,s)},function(){r.loadMpkOnDemand(t,function(e,t){n&&n(t-e+a,s)},i)})}else a?(r.resetProcessState(a),r.loadLayerScenesOnDemand(e,function(e,t){n&&n(t-e,t)},i)):o&&(r.resetProcessState(o),r.loadMpkOnDemand(t,function(e,t){n&&n(t-e,t)},i))}},{key:"dealLayerDataLoading",value:function(e,t,n,i,r){var a=e.mpk,o=e.layerScene;if(0===a.addIdxs.length&&0===a.removeIdxs.length&&0===o.addIdxs.length&&0===o.removeIdxs.length)return void(t&&t(r));var s=!1;(a.removeIdxs.length>0||o.removeIdxs.length>0)&&(s=!0,n&&n(o.removeIdxs,a.removeIdxs)),o.addIdxs.length>0||a.addIdxs.length>0?this.loadLayerDataByIdxs(o.addIdxs,a.addIdxs,i,function(){t&&t(r)}):s?t&&t(r):r&&r()}}]),t}(CLOUD.ModelView.LayerBaseProvider);CLOUD.ModelView.LayerSceneProvider=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),_createClass(t,[{key:"parseItemData",value:function(){var e=this.getSceneReaderMap();for(var t in e)for(var n=e[t],i=0,r=n.header.itemCount;i<r;++i)this._readItemData(n,i,this.getCellId(t,i));return!0}},{key:"parseItemDataByCellId",value:function(e){var t=this.getSceneReaderMap();for(var n in t){var i=t[n],r=this.getItemIdsBy(e,n);if(r)for(var a=0,o=r.length;a<o;++a){var s=r[a];this._readItemData(i,s,this.getCellId(n,s))}}return!0}},{key:"getLayerIdsByCellId",value:function(e){return this.cellIdMap&&this.cellIdMap[e]?Object.keys(this.cellIdMap[e]):null}},{key:"getItemIdsBy",value:function(e,t){return this.cellIdMap&&this.cellIdMap[e]?this.cellIdMap[e][t]:null}},{key:"cacheToCellIdMap",value:function(e,t,n){this.layerIdMap||(this.layerIdMap={}),this.layerIdMap[t]||(this.layerIdMap[t]={}),this.layerIdMap[t][n]=e,this.cellIdMap||(this.cellIdMap={}),this.cellIdMap[e]||(this.cellIdMap[e]={}),this.cellIdMap[e][t]||(this.cellIdMap[e][t]=[]),this.cellIdMap[e][t].push(n)}},{key:"getCellId",value:function(e,t){return this.layerIdMap&&this.layerIdMap[e]?this.layerIdMap[e][t]||0:0}},{key:"isOctreeOuter",value:function(e){var t=this.octreeRootNode.layer;return t||(t=this.octreeRootNode.inner||this.octreeRootNode.outer),!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}},{key:"isUseInnerAndOuterOctree",value:function(){return!this.octreeRootNode.layer}},{key:"getOctreeRoots",value:function(e){this.octreeRootNode.layer?e.push(this.octreeRootNode.layer):(this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner),this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer))}},{key:"updateOctreeNode",value:function(e){this.octreeRootNode.layer?this.updateOctreeNodeBy(this.octreeRootNode.layer,e):(this.octreeRootNode.inner&&this.updateOctreeNodeBy(this.octreeRootNode.inner,e),this.octreeRootNode.outer&&this.updateOctreeNodeBy(this.octreeRootNode.outer,e))}}]),t}(CLOUD.ModelView.DefaultDescriptor);CLOUD.ModelView.LayerSceneDescriptor=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.layerSceneTaskManager=new CLOUD.TaskManager,n.descriptor=new CLOUD.ModelView.LayerSceneDescriptor,n}return _inherits(t,e),_createClass(t,[{key:"loadLayerScenesOnDemand",value:function(e,t,n){for(var i=0,r=e.length;i<r;++i)this.layerSceneTaskManager.addTask(e[i]);this.layerSceneTaskManager.processTasks(this._loadLayerScene.bind(this),t,n)}},{key:"loadSceneAndMpks",value:function(e){e.symbol&&this._loadSymbol(),this._loadLayerCellIndex(),this._loadLayerOctree(),this._loadLayerKey(),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=3;return t+=e.symbol,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}},{key:"_loadLayerCellIndex",value:function(){var e=this,t=this.fileLoader,n=this.url,i=n.layerSceneCell();t.setResponseType("arraybuffer"),t.load(i,function(t){e._parseLayerCellIndex(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_parseLayerCellIndex",value:function(e){for(var t=new CLOUD.Loader.LayerIndexReader(e),n=this.descriptor,i=0,r=t.cell_count;i<r;i++)for(var a=t.getCell(i),o=a.itemIndex;o<a.itemCount;o++){var s=t.getLayerIndex(o);n.cacheToCellIdMap(a.cellId,s.layer_id,s.item_index)}}},{key:"_loadLayerOctree",value:function(){var e=this.fileLoader,t=this.url,n=this;e.setResponseType("arraybuffer"),e.load(t.layerOctree(),function(e){n._parseLayerOctree(e),n._onTaskFinished()},void 0,function(e){n._onTaskFinished()})}},{key:"_parseLayerOctree",value:function(e){this.descriptor.octreeRootNode.layer=this._getOctreeRootNode(e)}},{key:"_loadLayerScene",value:function(e,t){var n=this,i=this.model,r=this.fileLoader,a=this.url;r.setResponseType("arraybuffer"),r.load(a.layerSceneUrl(e),function(i){n._parseScene(i,e),t(),n._onTaskFinished()},void 0,function(e){i.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),n._onTaskFinished()})}}]),t}(CLOUD.ModelView.LayerBaseLoader);CLOUD.ModelView.LayerSceneLoader=e}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="layer",i.defaultManager=new CLOUD.ModelView.BatchedManager(n),i.instancedManager=new CLOUD.ModelView.InstancedManager,i.loader=new CLOUD.ModelView.LayerSceneLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var n=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);n.length?this.defaultManager.asyncCreateMeshNodes(this.model,n,e):e&&e()}}]),t}(CLOUD.ModelView.LayerSceneHandler);CLOUD.ModelView.LayerSceneBatchedHandler=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.requestCount=0,this.maxRequestCount=1e5,this.loading=!1,this.delayIntervalTime=300}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this.currentConditions=null,this.delayLoadTimer&&(clearTimeout(this.delayLoadTimer),this.delayLoadTimer=null)}},{key:"isValidModel",value:function(e){return!(e.isEmptyScene()||!e.isLayerData())}},{key:"loadMpkOnDemandByConditionsWithDelay",value:function(e,t,n,i){var r=this,a=this.delayIntervalTime;!function(){r.delayLoadTimer&&clearTimeout(r.delayLoadTimer),r.delayLoadTimer=setTimeout(function(){r.loadMpkOnDemandByConditions(e,t,n,i)},a)}()}},{key:"loadMpkOnDemandByConditions",value:function(e,t,n,i){function r(e){var o=e,s=a.currentConditions;return function(){a._loadMpkOnDemandByConditions(s,t,n,function(){o!==a.requestCount?requestAnimationFrame(r(a.requestCount)):(a.loading=!1,i&&i(s),s=null)})}}if(this.currentConditions=e,++this.requestCount,this.requestCount>this.maxRequestCount&&(this.requestCount=0),!this.loading){this.loading=!0;var a=this;requestAnimationFrame(r(this.requestCount))}}},{key:"_loadMpkOnDemandByConditions",value:function(e,t,n,i){var r=this;this.manager.traverseModels(function(a){r.isValidModel(a)&&a._getHandler().loadMpkOnDemand(e,t,n,i)})}},{key:"getBoundingBoxOnDemand",value:function(){var e=new THREE.Box3,t=this;return this.manager.traverseModels(function(n){if(t.isValidModel(n)){var i=n._getHandler().getLayerProvider().getUnionBoundingBoxOnDemand();i&&e.union(i)}}),e.isEmpty()?null:e}},{key:"isLoading",value:function(){return this.loading}},{key:"getBoundingBoxForUsedComponent",value:function(){var e=this.manager,t=new THREE.Box3;return e.traverseModels(function(n){var i=n.getLoadedUserIdsObject();i&&t.union(e.getBoundingBoxByIds(i))}),t.isEmpty()?null:t}}]),e}();CLOUD.LoadOnDemandDirector=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.nodeInfoMapOnSceneId={},e.symbolBufferData=null,e}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.nodeInfoMapOnSceneId=null,this.symbolBufferData=null}},{key:"updateNodeInfos",value:function(){for(var e=this.nodeInfoMapOnSceneId,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=e[t[n]],a=Object.keys(r),o=0,s=a.length;o<s;o++)for(var l=a[o],u=r[l],c=this.userIdReader?this.userIdReader.getString(l):l,h=this.userDataReader?this.userDataReader.getUserData(u[0].userDataId):null,d=0,f=u.length;d<f;d++){var p=u[d];p.userId=c,p.userData=h,p.name=p.userId,p.boundingBox=new THREE.Box3(new THREE.Vector3(p.boundingBox.min.x,p.boundingBox.min.y,p.boundingBox.min.z),new THREE.Vector3(p.boundingBox.max.x,p.boundingBox.max.y,p.boundingBox.max.z)),p.state=CLOUD.EnumObjectState.Visible,p.material=null,p.parameterizedDesc=this._isRegularShape(p),p.instanceOrNot=this._isInstancedNode(p),this._classifyNodeInfo(p)}}}]),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.WorkerBatchedDescriptor=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.WorkerBatchedDescriptor,n}return _inherits(t,e),_createClass(t,[{key:"parseSymbol",value:function(e){this.descriptor.symbolBufferData=e}},{key:"loadSceneAndMpks",value:function(e){var t=this;e.symbol?this._loadSymbol(function(){t._loadScene(0)}):t._loadScene(0),e.lines&&this._loadLine(),e.mpks&&this._loadAllMpks(e.mpks),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=e.scenes;return t+=e.symbol,t+=e.lines,t+=e.mpks,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}},{key:"_loadScene",value:function(e){var t=this,n=this.model,i=this.url,r=this.fileLoader;r.setResponseType("arraybuffer"),r.load(i.sceneUrl(e),function(n){t._parseScene(n,e)},void 0,function(e){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_SCENE_ERROR,event:e}),t._onTaskFinished()})}},{key:"_parseScene",value:function(e,t){var n=this,i=CLOUD.Workers.WorkerLib.getSceneParseWorker();i.addEventListener("message",function(e){var r=e.data;n.descriptor.nodeInfoMapOnSceneId[t]=JSON.parse(CLOUD.Utils.ab2str(r.nodeInfoMap)),n._onTaskFinished(),i.terminate()},!1);var r=this.descriptor.symbolBufferData?[e,this.descriptor.symbolBufferData]:[e];i.postMessage({sceneBufferData:e,symbolBufferData:this.descriptor.symbolBufferData},r)}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.WorkerBatchedLoader=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"_getUV2BufferData",value:function(e){var t=e.getLoader().uv2MapItem,n=e.getLoader().uv2Buffer;if(e.lightmap&&t&&n)return{uv2MapItem:t,uv2Buffer:n}}},{key:"_createGeometries",value:function(e,t){var n=this,i=this._classifyGeometryIdxIds(e),r=!0,a=0,o=i.generalGeometryIdxIds.length?1:0;o+=i.parameterizedGeometryIdxIds.length?1:0,o>0&&(r=!1),i.generalGeometryIdxIds.length&&this._dealGeneralGeometries(e,i.generalGeometryIdxIds,function(){++a===o&&n._makeMeshNodes(e,t)}),i.parameterizedGeometryIdxIds.length&&this._dealParameterizedGeometries(e,i.parameterizedGeometryIdxIds,function(){++a===o&&n._makeMeshNodes(e,t)}),r&&this._makeMeshNodes(e,t)}},{key:"_classifyGeometryIdxIds",value:function(e){for(var t=e.getModelDescriptor().getNodeInfosOnGeometryId(),n=[],i=[],r=Object.keys(t),a=0,o=r.length;a<o;a++){var s=r[a],l=t[s];l.length<1||(l[0].parameterizedDesc?n.push(s):i.push(s))}return{generalGeometryIdxIds:i,parameterizedGeometryIdxIds:n}}},{key:"_dealGeneralGeometries",value:function(e,t,n){for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=e.getModelDescriptor().getReferencedMeshBufferData(),a=this.mapMaterialIdToMergedNode,o=[],s=[],l=0,u=t.length;l<u;l++){var c=t[l],h=r[c];h&&(h.meshId=c,s.push(h),-1===o.indexOf(h.P.buffer)&&o.push(h.P.buffer),-1===o.indexOf(h.I.buffer)&&o.push(h.I.buffer),h.N&&-1===o.indexOf(h.N.buffer)&&o.push(h.N.buffer),h.UV&&-1===o.indexOf(h.UV.buffer)&&o.push(h.UV.buffer))}var d=CLOUD.Workers.WorkerLib.getMeshCreateWorker();d.addEventListener("message",function(e){for(var t=e.data,i=t.dataBuffers,r=Object.keys(i),o=0,s=r.length;o<s;o++)for(var l=r[o],u=i[l],c=0,h=u.length;c<h;c++){var f=u[c],p=f.bufferData,m=f.indices,g=new THREE.BufferGeometry;g._visible=!0,g.setIndex(new THREE.BufferAttribute(new Uint32Array(p.index),1)),g.addAttribute("position",new THREE.BufferAttribute(new Float32Array(p.position),3)),p.normal>0&&g.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(p.normal),3)),p.uv>0&&g.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(p.uv),2)),p.uv2>0&&g.addAttribute("uv2",new THREE.BufferAttribute(new Float32Array(p.uv2),2)),a[l]||(a[l]=[]),a[l].push({geometry:g,indices:m})}n&&n(),d.terminate()},!1);var f={type:"unique",segmentMergeEnabled:!!CLOUD.GlobalData.SegmentedBatchMergeEnable,maxIndicesNumberPerBathSegment:CLOUD.GlobalData.maxIndicesNumberPerBathSegment,nodeItemType:CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,nodeInfoMap:i,uv2BufferData:this._getUV2BufferData(e)},p=CLOUD.Utils.str2ab(JSON.stringify(f));o.push(p),d.postMessage({brief:p,dataBuffers:s},o)}},{key:"_dealParameterizedGeometries",value:function(e,t,n){for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=this.mapMaterialIdToMergedNode,a=[],o=[],s=0,l=t.length;s<l;s++)a.push({meshId:t[s]});var u=CLOUD.Workers.WorkerLib.getMeshCreateWorker();u.addEventListener("message",function(e){for(var t=e.data,i=t.dataBuffers,a=Object.keys(i),o=0,s=a.length;o<s;o++)for(var l=a[o],c=i[l],h=0,d=c.length;h<d;h++){var f=c[h],p=f.bufferData,m=f.indices,g=new THREE.BufferGeometry;g._visible=!0,g.setIndex(new THREE.BufferAttribute(new Uint32Array(p.index),1)),g.addAttribute("position",new THREE.BufferAttribute(new Float32Array(p.position),3)),p.normal>0&&g.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(p.normal),3)),p.uv>0&&g.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(p.uv),2)),r[l]||(r[l]=[]),r[l].push({geometry:g,indices:m})}n&&n(),u.terminate()},!1);var c={type:"parameterized",segmentMergeEnabled:!!CLOUD.GlobalData.SegmentedBatchMergeEnable,maxIndicesNumberPerBathSegment:CLOUD.GlobalData.maxIndicesNumberPerBathSegment,nodeItemType:CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,nodeInfoMap:i},h=CLOUD.Utils.str2ab(JSON.stringify(c));o.push(h),u.postMessage({brief:h,dataBuffers:a},o)}}]),t}(CLOUD.ModelView.BatchedMeshManager);CLOUD.ModelView.WorkerBatchedMeshManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.BatchedWireframeManager);CLOUD.ModelView.WorkerBatchedWireframeManager=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.meshManager=new CLOUD.ModelView.WorkerBatchedMeshManager(e),e.wireframeManager=new CLOUD.ModelView.WorkerBatchedWireframeManager(e),e}return _inherits(t,e),t}(CLOUD.ModelView.BatchedBaseManager);CLOUD.ModelView.WorkerBatchedManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.InstancedMeshManager);CLOUD.ModelView.WorkerBatchedInstancedMeshManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.InstancedWireframeManager);CLOUD.ModelView.WorkerBatchedInstancedWireframeManager=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.meshManager=new CLOUD.ModelView.WorkerBatchedInstancedMeshManager(e),e.wireframeManager=new CLOUD.ModelView.WorkerBatchedInstancedWireframeManager(e),e}return _inherits(t,e),t}(CLOUD.ModelView.InstancedBaseManager);CLOUD.ModelView.WorkerBatchedInstancedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="batched",n.defaultManager=new CLOUD.ModelView.WorkerBatchedManager,n.instancedManager=new CLOUD.ModelView.WorkerBatchedInstancedManager,n.loader=new CLOUD.ModelView.WorkerBatchedLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){this.dataReady||(this.dataReady=!0,this.settleData(e))}},{key:"settleData",value:function(e){this.loader.descriptor.updateNodeInfos(),this.model.getModelDescriptor().cacheNodeInfosOnGeometryId(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}},{key:"createMeshNodes",value:function(e){var t=this,n=this.model;this.defaultManager.createMeshNodes(n,function(){n.getMaterialManager()._updateTextureMapping(),t.clearCachedData(n),t.loaded=!0,e&&e()}),this.instancedManager.createMeshNodes(n)}}]),t}(CLOUD.ModelView.BatchedBaseHandler);CLOUD.ModelView.WorkerBatchedHandler=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.bmeshIdReader=null,e.nodeInfoMapOnSceneId={},e.symbolBufferData=null,e}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.bmeshIdReader=null,this.nodeInfoMapOnSceneId=null,this.symbolBufferData=null}},{key:"convertGeometryId",value:function(e){var t=this.bmeshIdReader.getBMeshId(e);return void 0===t&&(t=e),t}},{key:"updateNodeInfos",value:function(){for(var e=this.nodeInfoMapOnSceneId,t=Object.keys(e),n=0,i=t.length;n<i;n++)for(var r=e[t[n]],a=Object.keys(r),o=0,s=a.length;o<s;o++)for(var l=a[o],u=r[l],c=this.userIdReader?this.userIdReader.getString(l):l,h=this.userDataReader?this.userDataReader.getUserData(u[0].userDataId):null,d=0,f=u.length;d<f;d++){var p=u[d];p.userId=c,p.userData=h,p.name=p.userId,p.boundingBox=new THREE.Box3(new THREE.Vector3(p.boundingBox.min.x,p.boundingBox.min.y,p.boundingBox.min.z),new THREE.Vector3(p.boundingBox.max.x,p.boundingBox.max.y,p.boundingBox.max.z)),p.state=CLOUD.EnumObjectState.Visible,p.material=null,p.parameterizedDesc=this._isRegularShape(p),p.instanceOrNot=this._isInstancedNode(p),this._classifyNodeInfo(p)}}}]),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.WorkerDataBatchedDescriptor=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.WorkerDataBatchedDescriptor,n}return _inherits(t,e),_createClass(t,[{key:"parseSymbol",value:function(e){this.descriptor.symbolBufferData=e}},{key:"_loadScene",value:function(e){var t=this,n=this.model,i=this.url,r=this.fileLoader;r.setResponseType("arraybuffer"),r.load(i.sceneUrl(e),function(n){t._parseScene(n,e)},void 0,function(e){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_SCENE_ERROR,event:e}),t._onTaskFinished()})}},{key:"_parseScene",value:function(e,t){var n=this,i=CLOUD.Workers.WorkerLib.getSceneParseWorker();i.addEventListener("message",function(e){var r=e.data;n.descriptor.nodeInfoMapOnSceneId[t]=JSON.parse(CLOUD.Utils.ab2str(r.nodeInfoMap)),n._onTaskFinished(),i.terminate()},!1);var r=this.descriptor.symbolBufferData?[e,this.descriptor.symbolBufferData]:[e];i.postMessage({sceneBufferData:e,symbolBufferData:this.descriptor.symbolBufferData},r)}}]),t}(CLOUD.ModelView.DataBatchedBaseLoader);CLOUD.ModelView.WorkerDataBatchedLoader=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"_createGeometries",value:function(e,t){var n=this,i=this._classifyGeometryIdxIds(e),r=!0,a=0,o=i.sharedGeometryIdxIds.length?1:0;o+=i.lineGeometryIdxIds.length?1:0,o+=i.parameterizedGeometryIdxIds.length?1:0,o>0&&(r=!1),i.sharedGeometryIdxIds.length&&this._dealSharedGeometries(e,i.sharedGeometryIdxIds,function(){++a===o&&n._makeMeshNodes(e,t)}),i.lineGeometryIdxIds.length&&this._dealLineGeometries(e,i.lineGeometryIdxIds,function(){++a===o&&n._makeMeshNodes(e,t)}),i.parameterizedGeometryIdxIds.length&&this._dealParameterizedGeometries(e,i.parameterizedGeometryIdxIds,function(){++a===o&&n._makeMeshNodes(e,t)}),i.uniqueGeometryIdxIds.length&&this._dealUniqueGeometries(e,i.uniqueGeometryIdxIds),r&&this._makeMeshNodes(e,t)}},{key:"_classifyGeometryIdxIds",value:function(e){for(var t=e.getModelDescriptor().getNodeInfosOnGeometryId(),n=e.getModelDescriptor().getReferencedMeshBufferData(),i=Object.keys(n),r=[],a=[],o=[],s=[],l=0,u=i.length;l<u;l++){var c=i[l],h=n[c],d=h.IndexInfos;if(d){if(d.length<1)continue;var f=t[d[0].meshId];if(!f||f.length<1)continue;f[0].instanceOrNot||f[0].type!==CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF?r.push(c):a.push(c)}else{var f=t[c];f&&f.length&&o.push(c)}}if(!CLOUD.GlobalData.Instance)for(var p=Object.keys(t),m=0,g=p.length;m<g;m++){var v=p[m],f=t[v];f.length<1||f[0].parameterizedDesc&&s.push(v)}return{uniqueGeometryIdxIds:r,sharedGeometryIdxIds:a,lineGeometryIdxIds:o,parameterizedGeometryIdxIds:s}}},{key:"_dealUniqueGeometries",value:function(e,t){for(var n=e.getModelDescriptor().getNodeInfosOnGeometryId(),i=e.getModelDescriptor().getReferencedMeshBufferData(),r=this.mapMaterialIdToMergedNode,a=0,o=t.length;a<o;a++){var s=t[a],l=i[s],u=l.IndexInfos;e.lightmap&&(l=this.getAttributeForLightmapWithDataMerged(l,e,s));var c,h,d=!(!l.UV||!l.UV.byteLength&&!l.UV.length),f=void 0;for(c=0,h=u.length;c<h;c++){var p=n[u[c].meshId];if(p&&0!==p.length){e.lightmap&&(u[c].lightmapIdx=l.lightmapIdx,u[c].positionStart=3*u[c].indexStart,u[c].positionCount=3*u[c].indexCount),f=u[c].meshId;for(var m=0,g=p.length;m<g;m++)p[m].uv=d}}if(void 0!==f){var v=n[f][0],y={},E=this._getMaterialKeyByNodeInfo(v);for(void 0===r[E]&&(r[E]=[]),c=0,h=u.length;c<h;c++)n[u[c].meshId]&&(v=n[u[c].meshId][0],void 0===y[v.userId]&&(y[v.userId]=[]),u[c].userId=v.userId,u[c].nodeId=v.nodeId,u[c].boundingBox=v.boundingBox,y[v.userId].push(u[c]));var b=new THREE.BufferGeometry;b._visible=!0,b.setIndex(new THREE.BufferAttribute(new Uint32Array(l.I),1)),b.addAttribute("position",new THREE.BufferAttribute(new Float32Array(l.P),3)),l.N&&(l.N.byteLength||l.N.length)&&b.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(l.N),3)),d&&b.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(l.UV),2)),l.UV2&&(b.addAttribute("uv2",new THREE.BufferAttribute(new Float32Array(l.UV2),2)),b.lightmapIdx=l.lightmapIdx),r[E].push({geometry:b,indices:y})}}}},{key:"_getUV2BufferData",value:function(e){var t=e.getLoader().uv2MapItem,n=e.getLoader().uv2Buffer;if(e.lightmap&&t&&n)return{uv2MapItem:t,uv2Buffer:n}}},{key:"_dealSharedGeometries",value:function(e,t,n){for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=e.getModelDescriptor().getReferencedMeshBufferData(),a=this.mapMaterialIdToMergedNode,o=[],s=[],l=0,u=t.length;l<u;l++){var c=t[l],h=r[c];h&&(s.push(h),o.push(h.P),o.push(h.I),h.N&&o.push(h.N),h.UV&&o.push(h.UV))}var d=CLOUD.Workers.WorkerLib.getMeshCreateWorker();d.addEventListener("message",function(e){for(var t=e.data,i=t.dataBuffers,r=Object.keys(i),o=0,s=r.length;o<s;o++)for(var l=r[o],u=i[l],c=0,h=u.length;c<h;c++){var f=u[c],p=f.bufferData,m=f.indices,g=new THREE.BufferGeometry;g._visible=!0,g.setIndex(new THREE.BufferAttribute(new Uint32Array(p.index),1)),g.addAttribute("position",new THREE.BufferAttribute(new Float32Array(p.position),3)),p.normal>0&&g.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(p.normal),3)),p.uv>0&&g.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(p.uv),2)),
p.uv2>0&&g.addAttribute("uv2",new THREE.BufferAttribute(new Float32Array(p.uv2),2)),a[l]||(a[l]=[]),a[l].push({geometry:g,indices:m})}n&&n(),d.terminate()},!1);var f={type:"shared",segmentMergeEnabled:!!CLOUD.GlobalData.SegmentedBatchMergeEnable,maxIndicesNumberPerBathSegment:CLOUD.GlobalData.maxIndicesNumberPerBathSegment,nodeItemType:CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,nodeInfoMap:i,uv2BufferData:this._getUV2BufferData(e)},p=CLOUD.Utils.str2ab(JSON.stringify(f));o.push(p),d.postMessage({brief:p,dataBuffers:s},o)}},{key:"_dealLineGeometries",value:function(e,t,n){for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=e.getModelDescriptor().getReferencedMeshBufferData(),a=this.mapMaterialIdToMergedNode,o=[],s=[],l=0,u=t.length;l<u;l++){var c=t[l],h=r[c];h&&(h.meshId=c,s.push(h),-1===o.indexOf(h.P.buffer)&&o.push(h.P.buffer),-1===o.indexOf(h.I.buffer)&&o.push(h.I.buffer))}var d=CLOUD.Workers.WorkerLib.getMeshCreateWorker();d.addEventListener("message",function(e){for(var t=e.data,i=t.dataBuffers,r=Object.keys(i),o=0,s=r.length;o<s;o++)for(var l=r[o],u=i[l],c=0,h=u.length;c<h;c++){var f=u[c],p=f.bufferData,m=f.indices,g=new THREE.BufferGeometry;g._visible=!0,g.setIndex(new THREE.BufferAttribute(new Uint32Array(p.index),1)),g.addAttribute("position",new THREE.BufferAttribute(new Float32Array(p.position),3)),a[l]||(a[l]=[]),a[l].push({geometry:g,indices:m})}n&&n(),d.terminate()},!1);var f={type:"unique",segmentMergeEnabled:!!CLOUD.GlobalData.SegmentedBatchMergeEnable,maxIndicesNumberPerBathSegment:CLOUD.GlobalData.maxIndicesNumberPerBathSegment,nodeItemType:CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,nodeInfoMap:i,uv2BufferData:this._getUV2BufferData(e)},p=CLOUD.Utils.str2ab(JSON.stringify(f));o.push(p),d.postMessage({brief:p,dataBuffers:s},o)}},{key:"_dealParameterizedGeometries",value:function(e,t,n){for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=this.mapMaterialIdToMergedNode,a=[],o=0,s=t.length;o<s;o++)a.push({meshId:t[o]});var l=CLOUD.Workers.WorkerLib.getMeshCreateWorker();l.addEventListener("message",function(e){for(var t=e.data,i=t.dataBuffers,a=Object.keys(i),o=0,s=a.length;o<s;o++)for(var u=a[o],c=i[u],h=0,d=c.length;h<d;h++){var f=c[h],p=f.bufferData,m=f.indices,g=new THREE.BufferGeometry;g._visible=!0,g.setIndex(new THREE.BufferAttribute(new Uint32Array(p.index),1)),g.addAttribute("position",new THREE.BufferAttribute(new Float32Array(p.position),3)),p.normal>0&&g.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(p.normal),3)),p.uv>0&&g.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(p.uv),2)),r[u]||(r[u]=[]),r[u].push({geometry:g,indices:m})}n&&n(),l.terminate()},!1);var u={type:"parameterized",segmentMergeEnabled:!!CLOUD.GlobalData.SegmentedBatchMergeEnable,maxIndicesNumberPerBathSegment:CLOUD.GlobalData.maxIndicesNumberPerBathSegment,nodeItemType:CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,nodeInfoMap:i},c=CLOUD.Utils.str2ab(JSON.stringify(u));transferableObjects.push(c),l.postMessage({brief:c,dataBuffers:a})}}]),t}(CLOUD.ModelView.BatchedMeshManager);CLOUD.ModelView.WorkerDataBatchedMeshManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"_dealSharedBorderLines",value:function(e){var t=e.getModelDescriptor().getSharedBorderLineCache();if(t){console.time("T_createBorderLines");for(var n=this,i=[],r=0,a=t.length;r<a;r++){var o=t[r];i.push(o.P),i.push(o.I);for(var s=o.IndexInfos,l=0,u=s.length;l<u;l++)s[l].meshId=e.getModelDescriptor().convertGeometryId(s[l].meshId)}var c=e.getModelDescriptor().getNodeInfosOnGeometryId(),h=e.getWireframeMaterial(),d=CLOUD.Workers.WorkerLib.getBorderLineCreateWorker();d.addEventListener("message",function(e){var t=e.data,i=JSON.parse(t.groupIndices),r=t.bufferData.index,a=t.bufferData.position,o=new THREE.BufferGeometry;o.setIndex(new THREE.BufferAttribute(r.array,r.itemSize,r.normalized)),o.addAttribute("position",new THREE.BufferAttribute(a.array,a.itemSize,a.normalized));var s=new THREE.LineSegments(o,h);s._indicesGroup=i,n.wireframeLineSegments.push(s),console.timeEnd("T_createBorderLines"),d.terminate()},!1);var f=CLOUD.Utils.str2ab(JSON.stringify(c));i.push(f),d.postMessage({infos:f,bufferDataArray:t},i)}}}]),t}(CLOUD.ModelView.DataBatchedWireframeManager);CLOUD.ModelView.WorkerDataBatchedWireframeManager=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.meshManager=new CLOUD.ModelView.WorkerDataBatchedMeshManager(e),e.wireframeManager=new CLOUD.ModelView.WorkerDataBatchedWireframeManager(e),e}return _inherits(t,e),t}(CLOUD.ModelView.BatchedBaseManager);CLOUD.ModelView.WorkerDataBatchedManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.InstancedMeshManager);CLOUD.ModelView.WorkerDataBatchedInstancedMeshManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.InstancedWireframeManager);CLOUD.ModelView.WorkerDataBatchedInstancedWireframeManager=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.meshManager=new CLOUD.ModelView.WorkerDataBatchedInstancedMeshManager(e),e.wireframeManager=new CLOUD.ModelView.WorkerDataBatchedInstancedWireframeManager(e),e}return _inherits(t,e),t}(CLOUD.ModelView.InstancedBaseManager);CLOUD.ModelView.WorkerDataBatchedInstancedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="worker_merge_data",n.defaultManager=new CLOUD.ModelView.WorkerDataBatchedManager,n.instancedManager=new CLOUD.ModelView.WorkerDataBatchedInstancedManager,n.loader=new CLOUD.ModelView.WorkerDataBatchedLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){this.dataReady||(this.dataReady=!0,this.settleData(e))}},{key:"settleData",value:function(e){this.loader.descriptor.updateNodeInfos(),this.model.getModelDescriptor().cacheNodeInfosOnGeometryId(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}}]),t}(CLOUD.ModelView.DataBatchedBaseHandler);CLOUD.ModelView.WorkerDataBatchedHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.manager=e,n.occlusionVisibleOctant=[],n.usedNodeInfoMap={},n.lineNodes={},n.activeMeshMap={},n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.activeMeshMap=null,this.manager=null,this.occlusionVisibleOctant=null,this.usedNodeInfoMap=null,this.lineNodes=null}},{key:"disposeLineNodes",value:function(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this.usedNodeInfoMap={},this.occlusionVisibleOctant.length=0}},{key:"updateNode",value:function(e,t,n){var i,r=this,a=e.getFilter()._hasOverrideMaterialFilter(),o=e.selectedMaterial;i=0===n?r._getUsableMaterial(e,t,o,a):r._getUsableMaterial(e,t,null,a),r._isLineSegments(t)?r._dealLineSegments(e,t,i):r._dealMeshes(e,t,i),i=null}},{key:"cullNodes",value:function(e,t,n){var i=this._getUsedNodeInfosByOctantId(t),r=this;if(i||(this.manager.traverseNodeInfoMapByOctantId(t,function(t,n){r._isSatisfied(e,n)&&r._cacheToUsedNodeInfoMap(t,n)}),i=this._getUsedNodeInfosByOctantId(t)),!i)return n;for(var a=0,o=i.length;a<o&&(n=this.collectNodeInfo(e,i[a],n),!this.manager.isFull(e,n));a++);return n}},{key:"_getUsableMaterial",value:function(e,t,n,i){var r=t.materialId,a=t.userId,o=e.materialManager.materials,s=e.manager.sceneState,l=e.getFilter(),u=null,c=s.isSelected(a);1!=c||l._isPickable(t)||(c=!1),n?CLOUD.GlobalData.PickingEffect?u=l._getOverrideMaterial(t):(u=l._getOverrideMaterial(t))&&!c||(u=n):i&&(u=l._getOverrideMaterial(t));var h=e.manager.getOverrideMaterialByNodeInfo(t);return u=u||h||o[r]||CLOUD.MaterialUtil.getDefaultStandardMaterial(),CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass&&s.hoverId===a&&!1===c&&(u=s.getHoverMaterial(u)),u}},{key:"collectNodeInfo",value:function(e,t,n){var i=e.getFilter(),r=i._hasHiddenFileIdFilter(),a=i._hasOverrideMaterialFilter(),o=e.manager.sceneState.selectionSet,s=i._hasRenderPromotionFilter(),l=e.manager.getCategoriesFromHighPriority("inner");return e.isReplacedUserId(t.userId)||e.isHiddenSourceObjectUserId(t.userId)?n:r&&i._isHiddenFileId(t)||!1===i._isVisible(t)?n:o[t.userId]||a&&i._hasHighPriorityOverrideMaterial(t)?(this.manager.addToPriorityNodesSet(0,t),++n):s&&i._isRenderPromotion(t)||t.userData&&t.userData.categoryId&&l[t.userData.categoryId]?(this.manager.addToPriorityNodesSet(1,t),++n):(this.manager.isFull(e,n)||(this.manager.addToPriorityNodesSet(2,t),n++),n)}},{key:"getMeshesByUserIds",value:function(e,t,n){for(var i=e.pool._pool,r=t.toString(),a=n.toString(),o=0;o<i.length;o++){var s=i[o];if(s.name==r||s.name==a){var l={};l.mesh=s,l.matrix=s.matrix;var u=s.geometry.boundingBox;u||(s.geometry.computeBoundingBox(),u=l.mesh.geometry.boundingBox),l.boundingBox=u,e.minDistanceObjects[s.name].push(l)}}}},{key:"_getUsedGeometry",value:function(e,t){var n;if(!CLOUD.GlobalData.Instance&&t.uvArrayBuffer){var i=t.geometryId+"|"+t.nodeId,n=this.getGeometryById(i);if(n)return n;var r=this._createGeometryByNodeInfo(e,t);r instanceof Array||(r=[r]),n=[];for(var a=new THREE.Matrix3,o=new THREE.Vector3,s=t.uvArrayBuffer,l=0,u=r.length;l<u;l++){var c=new THREE.BufferGeometry;c.setIndex(r[l].index),c.addAttribute("position",r[l].attributes.position),c.addAttribute("normal",r[l].attributes.normal),a.set(s[6*l],s[6*l+2],s[6*l+4],s[6*l+1],s[6*l+3],s[6*l+5],0,0,1);for(var h=[],d=r[l].attributes.uv.array,f=0,p=d.length;f<p;f+=2)o.set(d[f],d[f+1],1),o.applyMatrix3(a),h.push(o.x),h.push(o.y);c.addAttribute("uv",new THREE.Float32BufferAttribute(h,2)),n.push(c)}this._cacheGeometry(i,n)}else n=this.getGeometryByNodeInfo(e,t);return n}},{key:"_dealMeshes",value:function(e,t,n){var i=this._getUsedGeometry(e,t);i instanceof Array||(i=[i]);for(var r=0,a=i.length;r<a;r++){var o=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:i[r],matrix:t.matrix,material:n,isMesh:!0,isLine:!1,isLineSegments:!1,renderOrder:n.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth});o&&(o.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,o),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new CLOUD.SingleCapsuleObject(t.nodeId,o)))}}},{key:"_dealLineSegments",value:function(e,t,n){var i=this.getGeometryByNodeInfo(e,t);if(i){var r=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:i,matrix:t.matrix,material:n,isMesh:!1,isLine:!0,isLineSegments:!0,renderOrder:n.transparent?0:CLOUD.GlobalData.MaximumDepth-t.octantDepth});r&&(r.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,r),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new CLOUD.SingleCapsuleObject(t.nodeId,r)))}}},{key:"_getUsedNodeInfosByOctantId",value:function(e){return this.usedNodeInfoMap[e]}},{key:"_cacheToUsedNodeInfoMap",value:function(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}},{key:"traverseUsedNodeInfoMap",value:function(e,t){for(var n=this.usedNodeInfoMap[e],i=0,r=n.length;i<r;i++)t(e,n[i])}},{key:"_isSatisfied",value:function(e,t){var n=e.getLoadedUserIdsObject();return!n||!!n[t.userId]}},{key:"_applyOcclusionTranslucent",value:function(e){if(CLOUD.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),n=e.manager.octantToObjectMap,i=this.occlusionVisibleOctant.length;if(i>0)for(var r=e.manager.getFrustumFromOcclusionCamera(),a=0;a<i;++a){var o=this.occlusionVisibleOctant[a].octantId,s=n[o];if(s&&s.length>0)for(var l=0,u=s.length;l<u;l+=2)for(var c=s[l];c<=s[l+1];c++){var h=t[c];CLOUD.CameraUtil.intersectObjectWithFrustum(h,r)&&this._overrideOcclusionMaterial(h)}}}}},{key:"_overrideOcclusionMaterial",value:function(e,t){var n=t.material;if(n&&!1===n.transparent){var i=e.manager.acquireMaterial(),r=i.material;n.color?r.color.copy(n.color):i.resetColor(),r.opacity=CLOUD.GlobalData.OcclusionOpacity,t.material=r,t.material.needsUpdate=!0}}},{key:"_isLineSegments",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"getGeometryBuffersByUserId",value:function(e,t){var n=e.getModelDescriptor().getStandardNodeInfosById(t);if(!n)return[];for(var i=[],r=e.getDatabagId(),a=0,o=n.length;a<o;a++){var s=n[a],l=this.getGeometryByNodeInfo(e,s);if(l){var u=this._isLines(s);if(l instanceof Array)for(var c=0,h=l.length;c<h;c++)i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}}return i}},{key:"_isLines",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"traverseActiveMeshMap",value:function(e,t){e=e||Object.keys(this.activeMeshMap);for(var n=0,i=e.length;n<i;n++){var r=e[n];if(this.activeMeshMap[r])for(var a=Object.keys(this.activeMeshMap[r]),o=0,s=a.length;o<s;o++){var l=a[o],u=this.activeMeshMap[r][l];t(r,l,u)}}}},{key:"getActiveMeshMapById",value:function(e){return this.activeMeshMap[e]}},{key:"_cacheActiveMesh",value:function(e,t,n){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(n)}},{key:"_clearActiveMeshMap",value:function(){this.activeMeshMap={}}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingMeshGenerator(this)),this.pickingNodeGenerator}}]),t}(CLOUD.ModelView.MeshBaseManager);CLOUD.ModelView.IncrementedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.usedNodeInfoMap={}}return _createClass(e,[{key:"destroy",value:function(){this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this._disposeGeometries(),this.wireframeGeometryMap=null,this.usedNodeInfoMap=null,this.manager=null}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._disposeGeometries(),this.wireframeGeometryMap={},this.usedNodeInfoMap={}}},{key:"cullNodes",value:function(e,t,n){var i=this,r=this._getUsedNodeInfosByOctantId(t);if(r||(this.manager.traverseNodeInfoMapByOctantId(t,function(t,n){i._isSatisfied(e,n)&&i._cacheToUsedNodeInfoMap(t,n)}),r=this._getUsedNodeInfosByOctantId(t)),!r)return n;for(var a=0,o=r.length;a<o&&(n=this._collectNodeInfo(e,r[a],n),!this.manager.isFull(e,n));a++);return n}},{key:"updateNode",value:function(e,t){for(var n=e.getFilter()._getOverrideWireFrameMaterial(t)||e.getWireframeMaterial(),i=this._getWireframeGeometryByNodeInfo(e,t),r=0,a=i.length;r<a;r++)e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,geometry:i[r],matrix:t.matrix,material:n,isMesh:!1,isLine:!0,isLineSegments:!0,pickable:!1,renderOrder:n.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth})}},{key:"_getUsedNodeInfosByOctantId",value:function(e){return this.usedNodeInfoMap[e]}},{key:"_cacheToUsedNodeInfoMap",value:function(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}},{key:"_collectNodeInfo",value:function(e,t,n){var i=e.getFilter(),r=i._hasHiddenFileIdFilter();return e.isReplacedUserId(t.userId)||e.isHiddenSourceObjectUserId(t.userId)?n:r&&i._isHiddenFileId(t)||!1===i._isVisible(t)?n:(this.manager.isFull(e,n)||(this.manager.addToPriorityNodesSet(2,{nodeInfo:t,wireframe:!0}),n++),n)}},{key:"_getWireframeGeometryByNodeInfo",value:function(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}},{key:"_getWireframeGeometryById",value:function(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var n,i,r=[];if(t instanceof Array)for(var a=0,o=t.length;a<o;a++)i=CLOUD.BuildEdge(t[a].attributes.position.array,t[a].index.array),n=new THREE.BufferGeometry,n.setIndex(new THREE.Uint32BufferAttribute(i,1)),n.addAttribute("position",t[a].attributes.position,3),r.push(n);else i=CLOUD.BuildEdge(t.attributes.position.array,t.index.array),n=new THREE.BufferGeometry,n.setIndex(new THREE.Uint32BufferAttribute(i,1)),n.addAttribute("position",t.attributes.position,3),r.push(n);return this.wireframeGeometryMap[e]=r,this.wireframeGeometryMap[e]}},{key:"_traverseWireframeGeometryMap",value:function(e){for(var t=Object.keys(this.wireframeGeometryMap),n=0,i=t.length;n<i;n++){var r=this.wireframeGeometryMap[t[n]];if(r)for(var a=0,o=r.length;a<o;a++)e(r[a])}}},{key:"_disposeGeometries",value:function(){this._traverseWireframeGeometryMap(function(e){e.dispose()})}},{key:"_isSatisfied",value:function(e,t){if(!this.manager.isNeedWireframing(t.userId))return!1;var n=e.getLoadedUserIdsObject();return!(n&&!n[t.userId])}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.IncrementedWireframeManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.manager=e,n.instanceGeometryMap={},n.bufferAttributeMap={},n.nodeIdxMapFromUserId={},n.matrixInfoMapFromUserId={},n.cachedInstance={vState:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},muvCol2:{}},n.selectedMeshes=[],n.nonSelectedMeshes=[],n.selectedObjectIds=[],n.mgIdMapFromOctantId={},n.activeMeshMap={},n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.activeMeshMap=null,this.cachedInstance=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.mgIdMapFromOctantId=null}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._clearActiveMeshMap(),this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache()}},{key:"clearInstanceCache",value:function(){this.cachedInstance.vState={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.muvCol2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}},{key:"getBufferAttributesBy",value:function(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance,n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,1),i=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,1),r=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol3[e]),3,1),o=[],s=[],l=[];if(t.muvCol0[e])for(var u=0,c=t.muvCol0[e].length;u<c;u++)o.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][u]),2,1)),s.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][u]),2,1)),l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol2[e][u]),2,1));return this.bufferAttributeMap[e]={attributeMcol0:n,attributeMcol1:i,attributeMcol2:r,attributeMcol3:a,attributeMuvCol0Array:o,attributeMuvCol1Array:s,attributeMuvCol2Array:l},this.bufferAttributeMap[e]}},{key:"resetInstanceMaterial",value:function(){var e=this;this.traverseInstanceGeometryMap(function(t,n){for(var i=0,r=n.length;i<r;++i)e._hasStateAttribute(n[i])&&(n[i].getAttribute("vState").array.fill(CLOUD.EnumInstanceState.NONE),n[i].getAttribute("vState").needsUpdate=!0,n[i].getAttribute("vState2").array.fill(CLOUD.EnumInstanceState.HIDDEN),n[i].getAttribute("vState2").needsUpdate=!0)})}},{key:"clearInstanceStateByUserId",value:function(e){function t(e,t,n,i){for(var r=e.getAttribute("vState").array,a=e.getAttribute("vState2").array,o=0;o<t.length;++o){var s=t[o];r[s]=n,a[s]=i}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0}var n=this,i=CLOUD.EnumInstanceState.NONE,r=CLOUD.EnumInstanceState.HIDDEN;this.traverseNodeIdxMapByUserId(e,function(e,a){var o=n.getInstanceGeometries(e);if(o)for(var s=0,l=o.length;s<l;s++)n._hasStateAttribute(o[s])&&t(o[s],a,i,r)})}},{key:"updateInstanceStateByUserId",value:function(e,t,n,i){function r(e,t,n,i,r){for(var a=e.getAttribute("vState").array,o=e.getAttribute("vState2").array,s=e.getAttribute("aColor"),l=s?s.array:null,u=0;u<t.length;++u){var c=t[u];a[c]=n,o[c]=i,null!==l&&null!==r&&(l[4*c]=r[0],l[4*c+1]=r[1],l[4*c+2]=r[2],l[4*c+3]=r[3])}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0,s&&(s.needsUpdate=!0)}var a=e.materialManager,o=this;this.traverseNodeIdxMapByUserId(t,function(s,l){var u=o.getInstanceGeometries(s);if(u){var c=o.manager.getMaterialIdByMeshId(s),h=o.getUsableMaterialColorParamsBy(e,c,n,i),d=h.rgbaColor,f=n;n===CLOUD.EnumInstanceState.TRANSPARENT&&(f=CLOUD.EnumInstanceState.OVERRIDED),n===CLOUD.EnumInstanceState.SELECTED&&o.cacheSelectedObjectIds(t,s);var p,m,g=a.getInstanceMaterialById(c,e)[0];g.transparent===h.transparent?(p=f,m=CLOUD.EnumInstanceState.HIDDEN):(p=CLOUD.EnumInstanceState.HIDDEN,m=f),f===CLOUD.EnumInstanceState.BLINK&&g.setBlinkColor(e.manager.getBlinkColor());for(var v=0,y=u.length;v<y;v++)o._hasStateAttribute(u[v])&&r(u[v],l,p,m,d)}})}},{key:"getUsableMaterialColorParamsBy",value:function(e,t,n,i){var r,a,o=e.selectedMaterial,s=e.getFilter()._getMaterialByName("scene"),l=e.materialManager,u=e.manager.getOverrideMaterialByName(t),c=u||l.getMaterialById(t);switch(n){case CLOUD.EnumInstanceState.HOVER:i?(r=e.getFilter()._getMaterialByName(i),a=e.manager.sceneState.getHoverColorByMaterial(r)):a=e.manager.sceneState.getHoverColorByMaterial(c);break;case CLOUD.EnumInstanceState.SELECTED:a=CLOUD.MaterialUtil.getColorParamsByMaterial(o);break;case CLOUD.EnumInstanceState.TRANSPARENT:a=CLOUD.MaterialUtil.getColorParamsByMaterial(s);break;case CLOUD.EnumInstanceState.OVERRIDED:case CLOUD.EnumInstanceState.BLINK:i?(r=e.getFilter()._getMaterialByName(i),a=CLOUD.MaterialUtil.getColorParamsByMaterial(r)):a=CLOUD.MaterialUtil.getColorParamsByMaterial(c);break;default:a=CLOUD.MaterialUtil.getColorParamsByMaterial(c)}return a}},{key:"getInstanceGeometries",value:function(e){return this.instanceGeometryMap[e]}},{key:"_cacheInstanceGeometries",value:function(e,t){if(!this.instanceGeometryMap[e]){t instanceof Array||(t=[t]);for(var n=this.instanceGeometryMap[e]=[],i=0,r=t.length;i<r;++i)n[i]=new THREE.InstancedBufferGeometry,n[i].setIndex(t[i].index),n[i].addAttribute("position",t[i].attributes.position),n[i].addAttribute("normal",t[i].attributes.normal),n[i].addAttribute("uv",t[i].attributes.uv)}}},{key:"traverseInstanceGeometryMap",value:function(e){var t=this.instanceGeometryMap;for(var n in t)e(n,t[n])}},{key:"traverseInstanceGeometryMapById",value:function(e,t){var n=this.instanceGeometryMap[e];if(n)for(var i=0,r=n.length;i<r;i++)t(n[i],e)}},{key:"disposeInstanceGeometries",value:function(){this.traverseInstanceGeometryMap(function(e,t){for(var n=0,i=t.length;n<i;n++)t[n].dispose()})}},{key:"cacheInstanceAttributeStateBy",value:function(e,t,n,i,r){var a=i.materialId,o=i.uvArrayBuffer;n instanceof Array||(n=[n]);var s=n.length,l=this.cachedInstance;if(!l.vState[t]){l.vState[t]=[],l.vColor[t]=[],l.mcol0[t]=[],l.mcol1[t]=[],l.mcol2[t]=[],l.mcol3[t]=[],l.muvCol0[t]=[],l.muvCol1[t]=[],l.muvCol2[t]=[];for(var u=0;u<s;++u)l.muvCol0[t][u]=[],l.muvCol1[t][u]=[],l.muvCol2[t][u]=[]}var c=r||e.materialManager.getMaterialById(a);l.vColor[t].push(c.color.r,c.color.g,c.color.b,c.opacity),l.vState[t].push(0);var h=i.matrix.elements;if(l.mcol0[t].push(h[0],h[1],h[2]),l.mcol1[t].push(h[4],h[5],h[6]),l.mcol2[t].push(h[8],h[9],h[10]),l.mcol3[t].push(h[12],h[13],h[14]),o)for(var u=0;u<s;++u)l.muvCol0[t][u].push(o[6*u],o[6*u+1]),l.muvCol1[t][u].push(o[6*u+2],o[6*u+3]),l.muvCol2[t][u].push(o[6*u+4],o[6*u+5]);else for(var u=0;u<s;++u)l.muvCol0[t][u].push(1,0),l.muvCol1[t][u].push(0,1),l.muvCol2[t][u].push(0,0);return l.vState[t].length-1}},{key:"_cacheNodeIdxByUserId",value:function(e,t,n){var i=this.nodeIdxMapFromUserId;i[e]||(i[e]={}),i[e][t]||(i[e][t]=[]),i[e][t].push(n)}},{key:"getNodeIdxMapByUserId",value:function(e){return this.nodeIdxMapFromUserId[e]}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){var n=this.nodeIdxMapFromUserId[e];for(var i in n)t(i,n[i])}},{key:"traverseNodeIdxMap",value:function(e,t){for(var n=Object.keys(this.nodeIdxMapFromUserId),i=0,r=n.length;i<r;i++){var a=n[i];if(!t||!t(a)){var o=this.nodeIdxMapFromUserId[a];for(var s in o)e(s,o[s])}}}},{key:"_cacheMatrixInfoByUserId",value:function(e,t,n){var i=this.matrixInfoMapFromUserId;i[e]||(i[e]={}),i[e][t]||(i[e][t]=[]),i[e][t].push(n)}},{key:"traverseMatrixInfoMapByUserId",value:function(e,t){var n=this.matrixInfoMapFromUserId[e];for(var i in n)t(i,n[i])}},{key:"getMeshesByUserId",value:function(e,t){var n=this;this.traverseMatrixInfoMapByUserId(t,function(i,r){for(var a=n.getInstanceNodesById(i),o=0,s=r.length;o<s;o++)for(var l=0,u=a.length;l<u;l++){var c={};if(c.matrix=r[o].matrix,c.mesh=a[l],1===u)c.boundingBox=r[o].boundingBox;else{var h=c.mesh.geometry.boundingBox;h?h=h.clone():(c.mesh.geometry.computeBoundingBox(),h=c.mesh.geometry.boundingBox.clone()),h.applyMatrix4(c.matrix),c.boundingBox=h}e.minDistanceObjects[t].push(c)}})}},{key:"clearSelectedObjectIds",value:function(){}},{key:"cacheSelectedObjectIds",value:function(e,t){}},{key:"adjustVisibility",value:function(e,t){}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"_cacheToMgIdMapFromOctantId",value:function(e,t,n){this.mgIdMapFromOctantId[e]||(this.mgIdMapFromOctantId[e]={}),this.mgIdMapFromOctantId[e][n]||(this.mgIdMapFromOctantId[e][n]={cellId:e,cellDepth:t,mgId:n})}},{key:"traverseMgIdMapByOctantId",value:function(e,t,n){if(this.mgIdMapFromOctantId[e])for(var i=this.mgIdMapFromOctantId[e],r=Object.keys(i),a=0,o=r.length;a<o;a++){var s=i[r[a]];if(n&&n(s.mgId))break;t(e,s)}}},{key:"_createGeometryById",value:function(e){if(this.geometryMap||(this.geometryMap={}),!this.geometryMap[e]){this.geometryMap[e]=!0;for(var t=this.cachedInstance,n=this.getBufferAttributesBy(e),i=this.getInstanceGeometries(e),r=0,a=i.length;r<a;r++){i[r].addAttribute("mcol0",n.attributeMcol0),i[r].addAttribute("mcol1",n.attributeMcol1),i[r].addAttribute("mcol2",n.attributeMcol2),i[r].addAttribute("mcol3",n.attributeMcol3),n.attributeMuvCol0Array.length>0&&(i[r].addAttribute("muvCol0",n.attributeMuvCol0Array[r]),i[r].addAttribute("muvCol1",n.attributeMuvCol1Array[r]),i[r].addAttribute("muvCol2",n.attributeMuvCol2Array[r])),i[r].addAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(t.vColor[e]),4,1)),i[r].addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),1,1)),i[r].addAttribute("vState2",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),1,1));var o=i[r].getAttribute("vState").array,s=i[r].getAttribute("vState2").array;o.fill(CLOUD.EnumInstanceState.NONE),s.fill(CLOUD.EnumInstanceState.HIDDEN);var l=i[r].index;i[r].addGroup(0,l.count,0),i[r].addGroup(0,l.count,1)}}}},{key:"cullNodes",value:function(e,t,n){var i=this;return this.traverseMgIdMapByOctantId(t,function(e,t){i.manager.addToPriorityNodesSet(2,t)},function(t){return n+=1,!!i.manager.isFull(e,n)&&(n-=1,!0)}),n}},{key:"updateNode",value:function(e,t){var n=this,i=this.manager.getMaterialIdByMeshId(t.mgId),r=e.materialManager.getInstanceMaterialById(i,e);this._createGeometryById(t.mgId),this.traverseInstanceGeometryMapById(t.mgId,function(i,a){var o=e.pool.get({databagId:e.databagId,meshId:a,geometry:i,material:r,isMesh:!0,isLine:!1,isLineSegments:!1,instanceOrNot:!0,renderOrder:r[0].transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth});o&&(n._cacheActiveMesh(t.mgId,o),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),a,new CLOUD.InstancedCapsuleObject(a,o)))})}},{key:"createInstanceNodeInfo",value:function(e,t,n){var i=this;this.octantIdMap||(this.octantIdMap={}),this.octantIdMap[t]||(this.octantIdMap[t]=!0,this.manager.traverseNodeInfoMapByOctantId(t,function(t,r){var a=i.getGeometryByNodeInfo(e,r),o=e.manager.getOverrideMaterialByNodeInfo(r);o&&(r.materialId=o.name);var s=i.manager.getMeshIdByNodeInfo(r),l=i.cacheInstanceAttributeStateBy(e,s,a,r,o);i._cacheNodeIdxByUserId(r.userId,s,l),i._cacheMatrixInfoByUserId(r.userId,s,{matrix:r.matrix,boundingBox:r.boundingBox}),i._cacheInstanceGeometries(s,a),i._cacheToMgIdMapFromOctantId(t,n,s)}))}},{key:"getCachedInstanceData",value:function(){return this.cachedInstance}},{key:"_hasStateAttribute",value:function(e){return!!e.attributes.vState}},{key:"getGeometryBuffersByUserId",value:function(e,t){var n=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!n)return[];for(var i=[],r=e.getDatabagId(),a=0,o=n.length;a<o;a++){var s=n[a],l=this.getGeometryByNodeInfo(e,s);if(l){var u=this._isLines(s);if(l instanceof Array)for(var c=0,h=l.length;c<h;c++)i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}}return i}},{key:"_isLines",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"traverseActiveMeshMap",value:function(e,t){e=e||Object.keys(this.activeMeshMap);for(var n=0,i=e.length;n<i;n++){var r=e[n];if(this.activeMeshMap[r]){t(r,this.activeMeshMap[r])}}}},{key:"getActiveMeshMapById",value:function(e){return this.activeMeshMap[e]}},{key:"_cacheActiveMesh",value:function(e,t){this.activeMeshMap[e]||(this.activeMeshMap[e]=[]),this.activeMeshMap[e].push(t)}},{key:"_clearActiveMeshMap",value:function(){this.activeMeshMap={}}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingIncrementInstancedMeshGenerator(this)),this.pickingNodeGenerator}}]),t}(CLOUD.ModelView.MeshBaseManager)
;CLOUD.ModelView.IncrementInstancedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.wireframeBufferMap={}}return _createClass(e,[{key:"destroy",value:function(){this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.disposeGeometries(),this.wireframeGeometryMap=null,this.wireframeBufferMap=null,this.manager=null}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this.disposeGeometries(),this.wireframeGeometryMap={},this.wireframeBufferMap={}}},{key:"disposeGeometries",value:function(){this._traverseWireframeGeometryMap(function(e){e.dispose()})}},{key:"cullNodes",value:function(e,t,n){var i=this;return this.manager.getMeshManager().traverseMgIdMapByOctantId(t,function(e,t){i.manager.addToPriorityNodesSet(2,{wireframe:!0,nodeInfo:t})},function(t){return n+=1,!!i.manager.isFull(e,n)&&(n-=1,!0)}),n}},{key:"updateNode",value:function(e,t){var n=e.getInstanceWireframeMaterial(),i=e.pool;this._createGeometryById(t.mgId),this._traverseWireframeGeometryMapById(t.mgId,function(r,a){i.get({databagId:e.databagId,meshId:a,geometry:r,material:n,isMesh:!1,isLine:!0,isLineSegments:!0,renderOrder:n.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth})})}},{key:"resetInstanceMaterial",value:function(){var e=CLOUD.EnumInstanceState.NONE,t=this;this._traverseWireframeGeometryMap(function(n){if(t._hasStateAttribute(n)){for(var i=n.getAttribute("vState").array,r=0,a=i.length;r<a;r++)i[r]=e;n.getAttribute("vState").needsUpdate=!0}}),this._updateNoWireframingState()}},{key:"updateInstanceWireframeByUserId",value:function(e,t){if(t===CLOUD.EnumInstanceState.HIDDEN||t===CLOUD.EnumInstanceState.NONE){var n=this;this.manager.traverseNodeIdxMapByUserId(e,function(e,i){n._setInstanceWireframeState(e,i,t)})}}},{key:"_getWireframeBufferById",value:function(e){var t=this.manager.getCombinedKeys(e).geometryId;if(this.wireframeBufferMap[t])return this.wireframeBufferMap[t];var n=this.manager.getMeshManager().getInstanceGeometries(e);if(!n)return[];for(var i=this.wireframeBufferMap[t]=[],r=0,a=n.length;r<a;r++){var o=n[r];i.push({index:CLOUD.BuildEdge(n[r].attributes.position.array,o.index.array),position:o.attributes.position})}return i}},{key:"_traverseWireframeGeometryMap",value:function(e){for(var t=Object.keys(this.wireframeGeometryMap),n=0,i=t.length;n<i;n++)this._traverseWireframeGeometryMapById(t[n],e)}},{key:"_traverseWireframeGeometryMapById",value:function(e,t){var n=this.wireframeGeometryMap[e];if(n)for(var i=0,r=n.length;i<r;i++)t(n[i],e)}},{key:"_createGeometryById",value:function(e){if(!this.wireframeGeometryMap[e])for(var t=this.wireframeGeometryMap[e]=[],n=this.manager.getMeshManager().getBufferAttributesBy(e),i=this.manager.getMeshManager().getCachedInstanceData(),r=this._getWireframeBufferById(e),a=0,o=r.length;a<o;a++){var s=new THREE.InstancedBufferGeometry;s.setIndex(r[a].index),s.addAttribute("position",r[a].position),s.addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[e]),1,1)),s.addAttribute("mcol0",n.attributeMcol0),s.addAttribute("mcol1",n.attributeMcol1),s.addAttribute("mcol2",n.attributeMcol2),s.addAttribute("mcol3",n.attributeMcol3),t.push(s)}}},{key:"_updateNoWireframingState",value:function(){var e=this,t=CLOUD.EnumInstanceState.HIDDEN;this.manager.traverseNodeIdxMap(function(n,i){e._setInstanceWireframeState(n,i,t)},function(t){return e.manager.isNeedWireframing(t)})}},{key:"_setInstanceWireframeState",value:function(e,t,n){var i=this;this._traverseWireframeGeometryMapById(e,function(e){if(i._hasStateAttribute(e)){for(var r=e.getAttribute("vState").array,a=0,o=t.length;a<o;++a)r[t[a]]=n;e.getAttribute("vState").needsUpdate=!0}})}},{key:"adjustVisibility",value:function(e,t){}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"_hasStateAttribute",value:function(e){return!!e.attributes.vState}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingIncrementInstancedWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.IncrementInstancedWireframeManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.ModelView.IncrementInstancedMeshManager(this),this.wireframeManager=new CLOUD.ModelView.IncrementInstancedWireframeManager(this),this.nodeInfoMapFromOctant={}}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null}},{key:"clearData",value:function(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"traverseInstanceGeometryMap",value:function(e){this.meshManager.traverseInstanceGeometryMap(e)}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}},{key:"traverseNodeIdxMap",value:function(e,t){this.meshManager.traverseNodeIdxMap(e,t)}},{key:"getMeshesByUserId",value:function(e,t){this.meshManager.getMeshesByUserId(e,t)}},{key:"_updateInstanceMaterialByUserId",value:function(e,t,n,i){this.meshManager.updateInstanceStateByUserId(e,t,n,i),this.wireframeManager.updateInstanceWireframeByUserId(t,n)}},{key:"_updateInstanceMaterial",value:function(e){CLOUD.Logger.time("update instance material");var t=CLOUD.Model.EnumFilterState;this.clearSelectedObjectIds();for(var n in this.filteredIds){var i=this.filteredIds[n];if(i[t.HIDDEN])this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.HIDDEN);else if(i[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(i[t.SELECTED]){CLOUD.GlobalData.PickingEffect?i[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.OVERRIDED,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.SELECTED);continue}if(i[t.BLINK]){i[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK);continue}}else{if(i[t.BLINK]){i[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.BLINK);continue}if(i[t.SELECTED]){CLOUD.GlobalData.PickingEffect?i[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.OVERRIDED,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.SELECTED);continue}}i[t.HOVER]?i[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.HOVER,i[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.HOVER):i[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,CLOUD.EnumInstanceState.OVERRIDED,i[t.OVERRIDED])}}CLOUD.Logger.timeEnd("update instance material")}},{key:"_resetInstanceMaterial",value:function(){this.meshManager.resetInstanceMaterial(),this.wireframeManager.resetInstanceMaterial()}},{key:"_collectFilteredUserIds",value:function(e,t,n){var i=e.getFilter(),r=i._hasHiddenFileIdFilter(),a=i._hasVisibleFilter(),o=i._hasOverrideMaterialFilter(),s=i._hasTransparentFilter(),l=e.hasReplacedUserId(),u=e.hasHiddenSourceObjectUserId(),c=this.filteredIds={};if(r||a||o||s||l||u)for(var h=CLOUD.Model.EnumFilterState,d=0;d<t.length;++d){var f=t[d],p=n[f];if(p&&p.length){var m=p[0];if(r&&i._isHiddenFileId(m)||a&&!1===i._isVisible(m)||e.isReplacedUserId(f)||e.isHiddenSourceObjectUserId(f))c[f]||(c[f]={}),c[f][h.HIDDEN]=!0;else if(s&&i._isTransparent(m))c[f]||(c[f]={}),c[f][h.TRANSPARENT]=!0;else if(o&&i._hasOverrideMaterial(m)){var g=i._getOverrideMaterial(m),v=null!=g?g.name:"";""!==v&&(c[f]||(c[f]={}),c[f][h.OVERRIDED]=v)}else;}}}},{key:"_collectSelectedUserIds",value:function(e,t){var n=this.filteredIds=this.filteredIds||{},i=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(n[a]||(n[a]={}),n[a][i.SELECTED]=!0,r[a]=!0);this.selectedUserIds=Object.keys(r)}},{key:"_clearSelectedState",value:function(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,n=this.selectedUserIds.length;t<n;t++){var i=this.selectedUserIds[t];this.filteredIds[i]&&(this.meshManager.clearInstanceStateByUserId(i),delete this.filteredIds[i][CLOUD.Model.EnumFilterState.SELECTED])}this.selectedUserIds=null}}},{key:"_collectHoveredUserIds",value:function(e,t){var n=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(n[e]||(n[e]={}),n[e][CLOUD.Model.EnumFilterState.HOVER]=!0,this.hoverdUserId=e)}},{key:"_clearHoveredState",value:function(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][CLOUD.Model.EnumFilterState.HOVER],this.hoverdUserId=void 0)}},{key:"_collectBlinkedUserIds",value:function(e,t){var n=this.filteredIds=this.filteredIds||{},i=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(n[a]||(n[a]={}),n[a][i.BLINK]=!0,r[a]=!0);this.blinkUserIds=Object.keys(r)}},{key:"_clearBlinkedState",value:function(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,n=this.blinkUserIds.length;t<n;t++){var i=this.blinkUserIds[t];this.filteredIds[i]&&(this.meshManager.clearInstanceStateByUserId(i),delete this.filteredIds[i][CLOUD.Model.EnumFilterState.BLINK])}this.blinkUserIds=null}}},{key:"applyFilter",value:function(e,t){if(this.hasNodeInfo(e)){this.updateNodes(e),this._resetInstanceMaterial();var n;n=t||e.getModelDescriptor().getInstancedUserIds();var i=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,n,i),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,i),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),i),this._collectHoveredUserIds(e.manager.sceneState.hoverId,i),this._updateInstanceMaterial(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"updateNode",value:function(e,t){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo):this.meshManager.updateNode(e,t)}},{key:"updateNodes",value:function(e){}},{key:"createMeshNodes",value:function(e,t,n){this.meshManager.createMeshNodes(e,t,n)}},{key:"clearCachedData",value:function(){this.meshManager.disposeGeometries()}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"clearSelectedObjectIds",value:function(){this.meshManager.clearSelectedObjectIds()}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"cullNodes",value:function(e,t,n,i,r){return this.hasOctantId(t)?(this.meshManager.createInstanceNodeInfo(e,t,n),0===i?this.meshManager.cullNodes(e,t,r):1===i?this.wireframeManager.cullNodes(e,t,r):r):r}},{key:"clearNodeInfoMap",value:function(){this.nodeInfoMapFromOctant={}}},{key:"cacheToNodeInfoMap",value:function(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}},{key:"traverseNodeInfoMapByOctantId",value:function(e,t){if(this.nodeInfoMapFromOctant[e])for(var n=0,i=this.nodeInfoMapFromOctant[e].length;n<i;n++)t(e,this.nodeInfoMapFromOctant[e][n])}},{key:"traverseNodeInfoMap",value:function(e){for(var t=Object.keys(this.nodeInfoMapFromOctant),n=0,i=t.length;n<i;n++)this.traverseNodeInfoMapByOctantId(t[n],e)}},{key:"traverseNodeInfoMapByIds",value:function(e,t){if(!e)return void this.traverseNodeInfoMap(t);for(var n=Object.keys(this.nodeInfoMapFromOctant),i=0,r=n.length;i<r;i++)for(var a=n[i],o=this.nodeInfoMapFromOctant[a],s=0,l=o.length;s<l;s++)e[o[s].userId]&&t(a,o[s])}},{key:"hasNodeInfo",value:function(){return!CLOUD.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}},{key:"hasOctantId",value:function(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}},{key:"addToPriorityNodesSet",value:function(e,t){this.handler.addToPriorityNodesSet(e,t)}},{key:"isFull",value:function(e,t){return this.handler.isFull(e,t)}},{key:"isNeedWireframing",value:function(e){return this.handler.isNeedWireframing(e)}},{key:"getMeshIdByNodeInfo",value:function(e){return CLOUD.Utils.getCombinedKeyString([e.materialId,e.geometryId,e.cellId])}},{key:"getMaterialIdByMeshId",value:function(e){return CLOUD.Utils.splitCombinedKeyString(e)[0]}},{key:"getCombinedKeys",value:function(e){var t=CLOUD.Utils.splitCombinedKeyString(e);return{materialId:t[0],geometryId:t[1],cellId:t[2]}}},{key:"getNodeInfoCountById",value:function(e){var t=this.meshManager.getCachedInstanceData();if(!t.vState[e])return 0;return t.muvCol0&&t.muvCol0[e]&&t.muvCol0[e].length?t.muvCol0[e].length*t.vState[e].length:t.vState[e].length}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"isPickableNode",value:function(e){if(!this.filteredIds||!this.filteredIds[e])return!0;var t=this.filteredIds[e],n=CLOUD.Model.EnumFilterState;return!t[n.HIDDEN]&&!t[n.TRANSPARENT]}},{key:"isHiddenNode",value:function(e){return!!(this.filteredIds&&this.filteredIds[e]&&this.filteredIds[e][CLOUD.Model.EnumFilterState.HIDDEN])}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}}]),e}();CLOUD.ModelView.IncrementInstancedManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.ModelView.IncrementedMeshManager(this),this.wireframeManager=new CLOUD.ModelView.IncrementedWireframeManager(this),this.nodeInfoMapFromOctant={},this.handler=null}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null,this.handler=null}},{key:"clearData",value:function(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"clearNodeInfoMap",value:function(){this.nodeInfoMapFromOctant={}}},{key:"cacheToNodeInfoMap",value:function(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}},{key:"traverseNodeInfoMapByOctantId",value:function(e,t){if(this.nodeInfoMapFromOctant[e])for(var n=0,i=this.nodeInfoMapFromOctant[e].length;n<i;n++)t(e,this.nodeInfoMapFromOctant[e][n])}},{key:"hasNodeInfo",value:function(){return!CLOUD.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}},{key:"hasOctantId",value:function(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}},{key:"cullNodes",value:function(e,t,n,i,r){return this.hasOctantId(t)?0===i?this.meshManager.cullNodes(e,t,r):1===i?this.wireframeManager.cullNodes(e,t,r):r:r}},{key:"updateNode",value:function(e,t,n){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo,n):this.meshManager.updateNode(e,t,n)}},{key:"updateNodes",value:function(e){}},{key:"applyFilter",value:function(e,t){}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"applyBlink",value:function(e){}},{key:"clearBlink",value:function(e){}},{key:"applyReplacement",value:function(e){}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getLoader",value:function(e){return e.loader}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"addToPriorityNodesSet",value:function(e,t){this.handler.addToPriorityNodesSet(e,t)}},{key:"isFull",value:function(e,t){return this.handler.isFull(e,t)}},{key:"isNeedWireframing",value:function(e){return this.handler.isNeedWireframing(e)}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"isPickableNode",value:function(e){return!0}},{key:"isHiddenNode",value:function(e){return!1}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}}]),e}();CLOUD.ModelView.IncrementedManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.defaultManager=new CLOUD.ModelView.IncrementedManager,this.instancedManager=new CLOUD.ModelView.IncrementInstancedManager,this.defaultManager.handler=this,this.instancedManager.handler=this,this.priorityNodesSet=[[],[],[]],this.octantManager=new CLOUD.OctantManager,this.noNeedWireframingIdMap={}}return _createClass(e,[{key:"destroy",value:function(){this.defaultManager.handler=null,this.instancedManager.handler=null,this.defaultManager=null,this.instancedManager=null,this.clearPriorityNodesSet(),this.priorityNodesSet=null,this.octantManager.destroy(),this.octantManager=null,this.noNeedWireframingIdMap=null}},{key:"clearData",value:function(){this.clearNoNeedWireframingIdMap(),this.defaultManager.clearData(),this.instancedManager.clearData()}},{key:"settleData",value:function(e,t){var n=this.octantManager.getAllOctants(e);n.length>0?this._parseItemDataByOctants(e,n,function(){t&&t()}):t&&t()}},{key:"cullNodes",value:function(e,t){this.clearPriorityNodesSet(),this._collectNoWireframingIds(e);var n=this.octantManager.getVisibleOctants(e,t,!0);if(n.length){var i=0;return e.isOnlyWireframe()?void this._cullNodesByVisibleOctant(e,n,1,i):e.isActivateWireframe()?(i=this._cullNodesByVisibleOctant(e,n,0,i),void this._cullNodesByVisibleOctant(e,n,1,i)):void this._cullNodesByVisibleOctant(e,n,0,i)}}},{key:"_cullNodesByVisibleOctant",value:function(e,t,n,i){for(var r=0,a=t.length;r<a;++r){var o=t[r].octantId,s=t[r].depth;if(i=this.defaultManager.cullNodes(e,o,s,n,i),i=this.instancedManager.cullNodes(e,o,s,n,i),this.isFull(e,i))break}return i}},{key:"updateNodes",value:function(e){var t=this;this.traversePriorityNodesSet(function(n,i){t._isInstanceNode(i)?t.instancedManager.updateNode(e,i):t.defaultManager.updateNode(e,i,n)}),CLOUD.GlobalData.DEBUG&&this.octantManager.showOctreeBox(e)}},{key:"_collectNoWireframingIds",value:function(e){if(!this.wireframingIdCollected){this.wireframingIdCollected=!0;var t=this,n=e.getFilter();e.getModelDescriptor().traverseNodeInfosByCell(function(e,i){(i.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE||n._hasRenderWithBoardlineFilter()&&!n._isRenderWithBoardline(i))&&(t.noNeedWireframingIdMap[i.userId]=!0)})}}},{key:"isNeedWireframing",value:function(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}},{key:"clearNoNeedWireframingIdMap",value:function(){this.wireframingIdCollected=!1,this.noNeedWireframingIdMap={}}},{key:"disposeBufferAfterVbo",value:function(){this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo()}},{key:"isFull",value:function(e,t){return!(t<e.getRenderableCount())}},{key:"clearPriorityNodesSet",value:function(){this.priorityNodesSet[0]=[],this.priorityNodesSet[1]=[],this.priorityNodesSet[2]=[]}},{key:"addToPriorityNodesSet",value:function(e,t){e=e<0||e>2?2:e,this.priorityNodesSet[e].push(t)}},{key:"traversePriorityNodesSet",value:function(e){for(var t=this.priorityNodesSet,n=0,i=t.length;n<i;++n)for(var r=t[n],a=0,o=Object.keys(r).length;a<o;++a)e(n,r[a])}},{key:"_parseItemDataByOctants",value:function(e,t,n){function i(o){var s=o;return function(){var o=t[s].octantId,l=t[s].depth;r._parseItemDataByOctantId(e,o,l),s<a-1?requestAnimationFrame(i(s+1)):n&&n()}}var r=this,a=t.length;requestAnimationFrame(i(0))}},{key:"_parseItemDataByOctantId",value:function(e,t,n){e.getModelDescriptor().parseItemDataByCellId(t);var i=e.getModelDescriptor().getNodeInfosByCellId(t);if(i)for(var r,a=0,o=i.length;a<o;a++)r=i[a],r.cellDepth=n,r.instanceOrNot?this.instancedManager.cacheToNodeInfoMap(t,r):this.defaultManager.cacheToNodeInfoMap(t,r),e.manager.addNodeInfoToOctantMap(e.getEncodedDatabagId(),t,r)}},{key:"_isInstanceNode",value:function(e){return!!(e.mgId||e.nodeInfo&&e.nodeInfo.mgId)}}]),e}();CLOUD.ModelView.IncrementCompositedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="default",n.compositedManager=new CLOUD.ModelView.IncrementCompositedManager,n.defaultManager=n.compositedManager.defaultManager,n.instancedManager=n.compositedManager.instancedManager,n.loader=new CLOUD.ModelView.DefaultLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.compositedManager.destroy(),this.compositedManager=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,function(){t.dataReady=!0,t.settleData(e)})}}},{key:"settleData",value:function(e){this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}},{key:"isAllReady",value:function(){return!(!this.isLoaded()||this.isHidden())}},{key:"prepare",value:function(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}},{key:"updateNodes",value:function(){}}]),t}(CLOUD.ModelView.ModelBaseHandler);CLOUD.ModelView.IncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.manager=e,n.nodePriority={high:[],medium:[],low:[]},n.visibleOctant=[],n.occlusionVisibleOctant=[],n.usedNodeInfosObject={},n.lineNodes={},n.blinkMaterials=[],n.activeMeshMap={},n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.activeMeshMap=null,this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}},{key:"disposeLineNodes",value:function(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}},{key:"update",value:function(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}},{key:"cullNodes",value:function(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var n=0;n=CLOUD.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,n)}},{key:"getPriorityNodes",value:function(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}},{key:"_cullNodesWithInnerAndOuterOctree",value:function(e,t){var n=0,i=0,r=e.getModelDescriptor().getOctreeRootNode(),a=r.inner,o=r.outer;if(this.manager.getContainsCamera(e)||!o)return this.visibleOctant.length=0,a&&this._frustumCull(e,t,a),o&&this._frustumCull(e,t,o),i=this.visibleOctant.length,i>0&&(this._sortVisibleOctant(t),n=this._logicCull(e,!0,!0,n,i)),n;o&&(this.visibleOctant.length=0,this._frustumCull(e,t,o),(i=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),n=this._logicCull(e,!0,!1,n,i)));var s=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||s._hasRenderPromotionFilter())&&a&&(this.visibleOctant.length=0,this._frustumCull(e,t,a),(i=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),n=this._logicCull(e,!0,!1,n,i))),n}},{key:"_cullNodesWithLayerOctree",value:function(e,t){var n=0;this.visibleOctant.length=0;var i=e.getModelDescriptor().getOctreeRootNode().layer;this._frustumCull(e,t,i);var r=this.visibleOctant.length;return r>0&&(this._sortVisibleOctant(t),n=this._logicCull(e,!0,!0,n,r)),n}},{key:"_cullNodesWithOctant",value:function(e,t){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}},{key:"_cullNodesWithFull",value:function(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}},{key:"_calcPrioritizedNodeCount",value:function(e,t){var n=t+this.nodePriority.high.length+this.nodePriority.medium.length;return n>this.manager.getRenderableCount(e)&&(n=this.manager.getRenderableCount(e)),n}},{key:"_updateMeshNodes",value:function(e){if(this._clearActiveMeshMap(),this._clearLineSegmentsNodeGroup(e),this.filter=e.getFilter(),e.isOnlyWireframe())return 0;var t=e.prioritizedNodeCount;if(0===t)return 0;var n=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],i=null;n[0].length>0&&(i=e.selectedMaterial);var r=e.getFilter()._hasOverrideMaterialFilter(),a={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,s=0,l=0,u=n.length;l<u;++l)for(var c=n[l],h=0,d=Object.keys(c).length;h<d&&!(o>t);++h){s++;var f,p=c[h];f=0===l?this._getUsableMaterial(e,p,i,r):this._getUsableMaterial(e,p,null,r);var m=!p.instanceOrNot;if(this._isLineSegments(p))this._dealLineSegments(e,p,m,f);else{var g=e.pool.counter;this._dealMeshes(e,p,m,f,a);var v=e.pool.counter-g;o+=v,t+=v-1}f=null}return i=null,n=null,s}},{key:"_getUsableMaterial",value:function(e,t,n,i){var r=t.materialId,a=t.userId,o=e.materialManager.materials,s=e.manager.sceneState,l=e.getFilter(),u=null,c=s.isSelected(a);1!=c||l._isPickable(t)||(c=!1),n?CLOUD.GlobalData.PickingEffect?u=l._getOverrideMaterial(t):(u=l._getOverrideMaterial(t))&&!c||(u=n):i&&(u=l._getOverrideMaterial(t));var h=e.manager.getOverrideMaterialByNodeInfo(t);return u=u||h||o[r]||CLOUD.MaterialUtil.getDefaultStandardMaterial(),CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass&&s.hoverId===a&&!1===c&&(u=s.getHoverMaterial(u)),u}},{key:"getMeshesByUserIds",value:function(e,t,n){for(var i=e.pool._pool,r=t.toString(),a=n.toString(),o=0;o<i.length;o++){var s=i[o];if(s.name==r||s.name==a){var l={};l.mesh=s,l.matrix=s.matrix;var u=s.geometry.boundingBox;u||(s.geometry.computeBoundingBox(),u=l.mesh.geometry.boundingBox),l.boundingBox=u,e.minDistanceObjects[s.name].push(l)}}}},{key:"explode",value:function(e){for(var t=e.pool._pool,n=0;n<t.length;n++){var i=t[n],r=e.manager.getExplosionTranslation(i.name);i.translateZ(r.z),i.updateMatrix(),i.updateMatrixWorld()}}},{key:"_getUsedGeometry",value:function(e,t){var n;if(!CLOUD.GlobalData.Instance&&t.uvArrayBuffer){var i=t.geometryId+"|"+t.nodeId,n=this.getGeometryById(i);if(n)return n;var r=this._createGeometryByNodeInfo(e,t);r instanceof Array||(r=[r]),n=[];for(var a=new THREE.Matrix3,o=new THREE.Vector3,s=t.uvArrayBuffer,l=0,u=r.length;l<u;l++){var c=new THREE.BufferGeometry;c.setIndex(r[l].index),c.addAttribute("position",r[l].attributes.position),c.addAttribute("normal",r[l].attributes.normal),a.set(s[6*l],s[6*l+2],s[6*l+4],s[6*l+1],s[6*l+3],s[6*l+5],0,0,1);for(var h=[],d=r[l].attributes.uv.array,f=0,p=d.length;f<p;f+=2)o.set(d[f],d[f+1],1),o.applyMatrix3(a),h.push(o.x),h.push(o.y);c.addAttribute("uv",new THREE.Float32BufferAttribute(h,2)),n.push(c)}this._cacheGeometry(i,n)}else n=this.getGeometryByNodeInfo(e,t);return n}},{key:"_dealMeshes",value:function(e,t,n,i,r){var a=this._getUsedGeometry(e,t),o=e.pool;a instanceof Array||(a=[a]);for(var s=0,l=a.length;s<l;s++){var u=o.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,userData:t.userData,geometry:a[s],matrix:t.matrix,material:i,renderOrder:i.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth,visible:n});u&&(u.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,u),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new CLOUD.SingleCapsuleObject(t.nodeId,u)))}}},{key:"_dealLineSegments",value:function(e,t,n,i){var r=this.getGeometryByNodeInfo(e,t);if(r){var a=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||(o=new CLOUD.LineSegmentsEx(r,i),o.databagId=e.databagId,o.name=t.userId,o.nodeId=t.nodeId,o.geometryId=t.geometryId,this.lineNodes[t.nodeId]=o),o.material=i,o.visible=n,a.add(o),o.updateMatrixWorld(!0),this._cacheActiveMesh(t.userId,t.nodeId,o)}}},{key:"_frustumCull",value:function(e,t,n){function i(e,t,n,r,a){var o,u;if(t&&e.depth<n&&(l.set(e.min,e.max),o=t.intersectsBox(l)),o){if(r){var c=l.applyMatrix4(s),h=c.getSize().length(),d=c.getCenter().z;d=d>1e-6?d:1e-6,e.priority=h/d,a.push(e)}else a.push(e);for(var f=0,p=e.childOctants.length;f<p;++f)u=e.childOctants[f],i(u,t,n,r,a)}}var r=e.manager,a=t.getFrustum(),o=CLOUD.GlobalData.OctantDepth,s=t.projScreenMatrix,l=new THREE.Box3;(CLOUD.GlobalData.DEBUG&&r.showOctreeBox(n),i(n,a,o,!0,this.visibleOctant),CLOUD.GlobalData.OcclusionTranslucentEnabled)&&i(n,this.manager.getFrustumFromOcclusionCamera(),o,!1,this.occlusionVisibleOctant);return!0}},{key:"_logicCull",value:function(e,t,n,i,r){
var a=e.manager,o=e.getFilter(),s=o._hasHiddenFileIdFilter(),l=o._hasOverrideMaterialFilter(),u=a.sceneState.selectionSet,c=o._hasRenderPromotionFilter(),h=this.nodePriority.high,d=this.nodePriority.medium,f=this.nodePriority.low,p=this.nodePriority.low.length,m=e.getModelDescriptor().getNodeInfosWithCellId(),g=a.getCategoriesFromHighPriority("outer");!0===n&&(g=a.getCategoriesFromHighPriority("inner"));for(var v,y=0,E=0;E<r;++E){var b,x=0;t?(b=this.visibleOctant[E].octantId,x=this.visibleOctant[E].depth):b=E;var M=m[b];if(M){var _=this._getUsedNodeInfosByCellId(b);if(!_){for(v=0,y=M.length;v<y;++v){var C=M[v];C.octantId=b,C.cellDepth=x,this._isSatisfied(e,C)&&this._cacheUsedNodeInfosByCellId(b,C)}_=this._getUsedNodeInfosByCellId(b)}if(_){var I=_.default;for(v=0,y=I.length;v<y;v++){var C=I[v];!function(t,n){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&!(s&&o._isHiddenFileId(t)||!1===o._isVisible(t))){if(u.hasOwnProperty(t.userId)||l&&o._hasHighPriorityOverrideMaterial(t))return void h.push(t);var r=!1;if(c&&o._isRenderPromotion(t)&&(r=!0),n){var a=t.userData,m=a?a.categoryId:void 0;m&&n[m]&&(r=!0)}if(r)return void d.push(t);i<p&&(f[i]=t,i++)}}(C,g)}}}}return CLOUD.Logger.timeEnd("collectNodeInfo"),i}},{key:"_clearUsedNodeInfosObject",value:function(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}},{key:"_getUsedNodeInfosByCellId",value:function(e){return this.usedNodeInfosObject[e]}},{key:"_cacheUsedNodeInfosByCellId",value:function(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}},{key:"_isSatisfied",value:function(e,t){var n=e.getLoadedUserIdsObject();return!n||!!n[t.userId]}},{key:"_logicCullWithFull",value:function(e,t){return this._logicCull(e,!1,!0,0,t)}},{key:"_sortVisibleOctant",value:function(e,t){var n=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var i=new CLOUD.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);n=i.getAncestorAndNeighbors()}this.visibleOctant.sort(function(e,t){if(null!=n){if(void 0!=n[e.octantId])return-1;if(void 0!=n[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0})}},{key:"_applyOcclusionTranslucent",value:function(e){if(CLOUD.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),n=e.manager.octantToObjectMap,i=this.occlusionVisibleOctant.length;if(i>0)for(var r=e.manager.getFrustumFromOcclusionCamera(),a=0;a<i;++a){var o=this.occlusionVisibleOctant[a].octantId,s=n[o];if(s&&s.length>0)for(var l=0,u=s.length;l<u;l+=2)for(var c=s[l];c<=s[l+1];c++){var h=t[c];CLOUD.CameraUtil.intersectObjectWithFrustum(h,r)&&this._overrideOcclusionMaterial(h)}}}}},{key:"_overrideOcclusionMaterial",value:function(e,t){var n=t.material;if(n&&!1===n.transparent){var i=e.manager.acquireMaterial(),r=i.material;n.color?r.color.copy(n.color):i.resetColor(),r.opacity=CLOUD.GlobalData.OcclusionOpacity,t.material=r,t.material.needsUpdate=!0}}},{key:"_clearNodePriorityData",value:function(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}},{key:"_adjustLowNodePriorityLength",value:function(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}},{key:"_clearLineSegmentsNodeGroup",value:function(e){this._getLineSegmentsNodeGroup(e).clear()}},{key:"_getLineSegmentsNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}},{key:"_isLineSegments",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"getBlinkMaterials",value:function(){return this.blinkMaterials}},{key:"getGeometryBuffersByUserId",value:function(e,t){var n=e.getModelDescriptor().getStandardNodeInfosById(t);if(!n)return[];for(var i=[],r=e.getDatabagId(),a=0,o=n.length;a<o;a++){var s=n[a],l=this.getGeometryByNodeInfo(e,s);if(l){var u=this._isLines(s);if(l instanceof Array)for(var c=0,h=l.length;c<h;c++){var d=l[c].getAttribute("uv");i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix,uv:d?d.array:null})}else{var d=l.getAttribute("uv");i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix,uv:d?d.array:null})}}}return i}},{key:"_isLines",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"traverseActiveMeshMap",value:function(e,t){e=e||Object.keys(this.activeMeshMap);for(var n=0,i=e.length;n<i;n++){var r=e[n];if(this.activeMeshMap[r])for(var a=Object.keys(this.activeMeshMap[r]),o=0,s=a.length;o<s;o++){var l=a[o],u=this.activeMeshMap[r][l];t(r,l,u)}}}},{key:"getActiveMeshMapById",value:function(e){return this.activeMeshMap[e]}},{key:"_cacheActiveMesh",value:function(e,t,n){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(n)}},{key:"_clearActiveMeshMap",value:function(){this.activeMeshMap={}}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingMeshGenerator(this)),this.pickingNodeGenerator}},{key:"isPickableNode",value:function(e){return!this.filter||this.filter._isPickable({name:e})}}]),t}(CLOUD.ModelView.MeshBaseManager);CLOUD.ModelView.FreeIncrementedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}return _createClass(e,[{key:"destroy",value:function(){this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.manager=null}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._clearWireframeLineMeshes(),this._disposeGeometries()}},{key:"update",value:function(e,t){if(0===t)return void this._clearWireframeGroupNode(e);this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e)}},{key:"_disposeGeometries",value:function(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}},{key:"_disposeGeometry",value:function(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var n=0,i=t.length;n<i;n++)t[n].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}},{key:"_clearWireframeLineMeshes",value:function(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}},{key:"_clearWireframeGroupNode",value:function(e){this._getWireWireframeGroupNode(e).clear()}},{key:"_removeWireframeGroupNode",value:function(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}},{key:"isActivateWireframe",value:function(e){return e.isActivateWireframe()}},{key:"_getWireWireframeGroupNode",value:function(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}},{key:"_getWireframeGeometryByNodeInfo",value:function(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}},{key:"_getWireframeGeometryById",value:function(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var n,i,r=[];if(t instanceof Array)for(var a=0,o=t.length;a<o;a++)i=CLOUD.BuildEdge(t[a].attributes.position.array,t[a].index.array),n=new THREE.BufferGeometry,n.setIndex(new THREE.Uint32BufferAttribute(i,1)),n.addAttribute("position",t[a].attributes.position,3),r.push(n);else i=CLOUD.BuildEdge(t.attributes.position.array,t.index.array),n=new THREE.BufferGeometry,n.setIndex(new THREE.Uint32BufferAttribute(i,1)),n.addAttribute("position",t.attributes.position,3),r.push(n);return this.wireframeGeometryMap[e]=r,this.wireframeGeometryMap[e]}},{key:"_makeWireframeLineMeshes",value:function(e,t,n){if(t.type!==CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE){var i=this.wireframeLineMeshes[t.nodeId];if(!i){i=this.wireframeLineMeshes[t.nodeId]=[];for(var r=this._getWireframeGeometryByNodeInfo(e,t),a=0,o=r.length;a<o;a++){var s=new THREE.LineSegments(r[a],this._getWireframeMaterial(e));s.name=t.nodeId+"_"+a,s.applyMatrix(t.matrix),i.push(s)}}if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&function(e,t){return(!CLOUD.GlobalData.Instance||"box"!=e.geometryId&&"boxM"!=e.geometryId)&&!(t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e))}(t,this._getFilter(e)))for(var l=this._getFilter(e)._getOverrideWireFrameMaterial(t)||this._getWireframeMaterial(e),u=0,c=i.length;u<c;u++)i[u].material=l,n.add(i[u])}}},{key:"_generateWireframeNodes",value:function(e,t){for(var n=this._getWireWireframeGroupNode(e),i=this.manager.getPriorityNodes(),r=0,a=0,o=i.length;a<o;++a)for(var s=i[a],l=0,u=Object.keys(s).length;l<u&&!(++r>t);++l){var c=s[l];this._makeWireframeLineMeshes(e,c,n)}}},{key:"_getWireframeGroupName",value:function(e){return e._getWireframeGroupName()}},{key:"_getWireframeMaterial",value:function(e){return e.getWireframeMaterial()}},{key:"_getFilter",value:function(e){return e.getFilter()}},{key:"explode",value:function(e){for(var t=new THREE.Matrix4,n=e.getModelDescriptor().getAllNodeInfos(),i=Object.keys(n),r=0,a=i.length;r<a;r++){var o=i[r],s=n[o],l=e.manager.getExplosionTranslation(o);t.makeTranslation(l.x,l.y,l.z);for(var u=0,c=s.length;u<c;u++){var h=this.wireframeLineMeshes[s[u].nodeId];if(h)for(var d=0;d<h.length;d++)h[d].applyMatrix(t)}}}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.FreeIncrementedWireframeManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.ModelView.FreeIncrementedMeshManager(this),this.wireframeManager=new CLOUD.ModelView.FreeIncrementedWireframeManager(this)}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"cullNodes",value:function(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"updateNodes",value:function(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}},{key:"applyFilter",value:function(e,t){}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"applyBlink",value:function(e){}},{key:"clearBlink",value:function(e){}},{key:"applyReplacement",value:function(e){}},{key:"getPriorityNodes",value:function(){return this.meshManager.getPriorityNodes()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getRenderableCount",value:function(e){return e.getRenderableCount()}},{key:"getLoader",value:function(e){return e.getLoader()}},{key:"getContainsCamera",value:function(e){return e.containsCamera}},{key:"getFilter",value:function(e){return e.getFilter()}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}},{key:"isHiddenNode",value:function(e){return!1}}]),e}();CLOUD.ModelView.FreeIncrementedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="default",n.defaultManager=new CLOUD.ModelView.FreeIncrementedManager,n.instancedManager=new CLOUD.ModelView.InstancedManager,n.loader=new CLOUD.ModelView.DefaultLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData(function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepare",value:function(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}},{key:"prepareWireframe",value:function(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}},{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"createMeshNodes",value:function(e){var t=this,n=this.model.getModelDescriptor().getInstancedUserIds();if(0===n.length)return t.loaded=!0,void(e&&e());CLOUD.Utils.asyncProcess(n,n.length,500,function(e,n){t.instancedManager.meshManager._createInstanceGeometries(t.model,[e[n]])},function(){t.instancedManager.meshManager._makeInstanceNodes(t.model),t.loaded=!0,e&&e()})}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelView.ModelBaseHandler);CLOUD.ModelView.FreeIncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="layer",n.defaultManager=new CLOUD.ModelView.FreeIncrementedManager,n.instancedManager=new CLOUD.ModelView.InstancedManager,n.loader=new CLOUD.ModelView.LayerLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}},{key:"prepareWireframe",value:function(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelView.LayerHandler);CLOUD.ModelView.FreeLayerIncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="layer",n.defaultManager=new CLOUD.ModelView.FreeIncrementedManager,n.instancedManager=new CLOUD.ModelView.InstancedManager,n.loader=new CLOUD.ModelView.LayerSceneLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}},{key:"prepareWireframe",value:function(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelView.LayerSceneHandler);CLOUD.ModelView.FreeLayerSceneIncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="layer",n.compositedManager=new CLOUD.ModelView.IncrementCompositedManager,n.defaultManager=n.compositedManager.defaultManager,n.instancedManager=n.compositedManager.instancedManager,n.loader=new CLOUD.ModelView.LayerLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.compositedManager.destroy(),this.compositedManager=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepare",value:function(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}},{key:"updateNodes",value:function(){}},{key:"addNodeInfoToOctantMap",value:function(){}},{key:"dealMeshNodes",value:function(e){e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelView.LayerHandler);CLOUD.ModelView.LayerIncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="layer",n.compositedManager=new CLOUD.ModelView.IncrementCompositedManager,n.defaultManager=n.compositedManager.defaultManager,n.instancedManager=n.compositedManager.instancedManager,n.loader=new CLOUD.ModelView.LayerSceneLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.compositedManager.destroy(),this.compositedManager=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"initData",value:function(e){var t=this;this.compositedManager.settleData(this.model,function(){t.getLayerProvider().cacheNodeInfosWithLayerKey(),t.addNodeInfoToOctantMap(),t.loadedUserIdsObject=t.getLayerProvider().getUserIdsOnDemand(),t.loadedUserIds=Object.keys(t.loadedUserIdsObject),e&&e()})}},{key:"prepare",value:function(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}},{key:"updateNodes",value:function(){}},{key:"addNodeInfoToOctantMap",value:function(){}},{key:"clearData",value:function(){this.model.removeAllFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.compositedManager.clearData(),this.clearLoadedState()}},{key:"dealMeshNodes",value:function(e){e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelView.LayerSceneHandler);CLOUD.ModelView.LayerSceneIncrementHandler=e}(),function(){var e=function(){function e(t,n,i){_classCallCheck(this,e),this.id=t,this.positionOffsetMap=n,this.geometry=i,this.object=new CLOUD.MeshEx(i)}return _createClass(e,[{key:"destroy",value:function(){this.positionOffsetMap=null,this.geometry.dispose(),this.geometry=null}},{key:"getPositionAndIndexOffset",value:function(e){return this.positionOffsetMap?this.positionOffsetMap[e]:null}}]),e}(),t=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.bufferDataObjectMap={},e.bufferDataObjectIdMap={},e.parameterizedBufferMap={},e.geometryIdMapOnBufferDataObjectId={},e.mpkIdMapOnCellId={},e}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.geometryIdMapOnbufferDataObjectId=void 0}},{key:"setToBufferDataObjectMap",value:function(e,t){if(!this.bufferDataObjectMap[e]){var n=null;if(t){var i=t.bufferData,r=t.positionOffsetMap;return n=new THREE.BufferGeometry,n.setIndex(new THREE.BufferAttribute(i.index,1)),n.addAttribute("position",new THREE.BufferAttribute(i.position,3)),i.normal?n.addAttribute("normal",new THREE.BufferAttribute(i.normal,3)):n.computeVertexNormals(),i.uv&&n.addAttribute("uv",new THREE.BufferAttribute(i.uv,2)),void(this.bufferDataObjectMap[e]=new CLOUD.ModelView.BatchedBufferDataObject(e,r,n))}var a=CLOUD.ModelView.BaseDescriptor.parameterizedNodeType;switch(e){case a.PIPE:n=CLOUD.GeomUtil.UnitCylinderInstance;break;case a.PIPE_M:n=CLOUD.GeomUtil.getUnitTextureCylinder();break;case a.BOX:n=CLOUD.GeomUtil.UnitBoxInstance;break;case a.BOX_M:n=CLOUD.GeomUtil.getUnitTextureBox()}n&&(n.clearGroups&&n.clearGroups(),this.bufferDataObjectMap[e]=new CLOUD.ModelView.BatchedBufferDataObject(e,void 0,n))}}},{key:"removeFromBufferDataObjectMap",value:function(e){var t=this.bufferDataObjectMap[e];t&&(t.destroy(),delete this.bufferDataObjectMap[e])}},{key:"getBufferDataObjectById",value:function(e){return this.bufferDataObjectMap[e]}},{key:"getBufferDataObjectByGeometryId",value:function(e){var t=this.getBufferDataObjectIdByGeometryId(e);return void 0!==t?this.getBufferDataObjectById(t):void 0}},{key:"setToBufferDataObjectIdMap",value:function(e,t){this.bufferDataObjectIdMap[e]=t}},{key:"_isParameterizedNodeType",value:function(e){var t=CLOUD.ModelView.BaseDescriptor.parameterizedNodeType;return e===t.TUBE||e===t.PIPE||e===t.PIPE_M||e===t.BOX||e===t.BOX_M}},{key:"getBufferDataObjectIdByGeometryId",value:function(e){var t=this.bufferDataObjectIdMap[e];if(void 0!==t)return t;if(this._isParameterizedNodeType(e)){var n=CLOUD.ModelView.BaseDescriptor.parameterizedNodeType;return t=e===n.TUBE?n.PIPE:e,this.setToBufferDataObjectMap(t),this.setToBufferDataObjectIdMap(e,t),this.setToGeometryIdMap(t,e),this.bufferDataObjectIdMap[e]}}},{key:"setToGeometryIdMap",value:function(e,t){this.geometryIdMapOnBufferDataObjectId[e]||(this.geometryIdMapOnBufferDataObjectId[e]={}),this.geometryIdMapOnBufferDataObjectId[e][t]=!0}},{key:"getGeometryIdsByBufferDataObjectId",value:function(e){return this.geometryIdMapOnBufferDataObjectId[e]}},{key:"_classifyNodeInfo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_classifyNodeInfo",this).call(this,e),this._cacheMpkIdsByCellId(e)}},{key:"_cacheMpkIdsByCellId",value:function(e){void 0===this.mpkIdMapOnCellId[e.cellId]&&(this.mpkIdMapOnCellId[e.cellId]={});var t=this.getBufferDataObjectIdByGeometryId(e.geometryId);void 0!==t&&(this.mpkIdMapOnCellId[e.cellId][t]=!0)}},{key:"getMpkIdsByCellId",value:function(){return this.mpkIdMapOnCellId[nodeInfo.cellId]}}]),t}(CLOUD.ModelView.DefaultDescriptor);CLOUD.ModelView.IncrementBatchedDescriptor=t,CLOUD.ModelView.BatchedBufferDataObject=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.descriptor=new CLOUD.ModelView.IncrementBatchedDescriptor,n}return _inherits(t,e),_createClass(t,[{key:"_parseMpkWithNoBatch",value:function(e,t){var n,i,r=new CLOUD.Loader.MPKReader(e),a=new THREE.Matrix4,o=[],s=0,l=0,u=[],c=0,h=0;for(n=0,i=r.header.meshCount;n<i;++n){var d=r.getPtBuffer(n),f=r.getIdxBuffer(n),p=r.getNormalBuffer(n);if(void 0!=d&&void 0!=f&&void 0!=p){var m=r.getMeshData(n),g=r.getUVBuffer(n);0!==m.baseScale&&(d=new Float32Array(d),a.identity(),a.setPosition(new THREE.Vector3(m.baseX,m.baseY,m.baseZ)),a.scale(new THREE.Vector3(m.baseScale,m.baseScale,m.baseScale)),CLOUD.GeomUtil.applyMatrix4ToBuffer(a,d)),f instanceof Uint16Array&&(f=Uint32Array.from(f)),g&&g.length?(u.push({meshId:m.mesh_id,position:d,index:f,normal:p,uv:g,positionOffset:c,indexOffset:h}),c+=d.length,h+=f.length):(o.push({meshId:m.mesh_id,position:d,index:f,normal:p,positionOffset:s,indexOffset:l}),s+=d.length,l+=f.length)}else CLOUD.Logger.log("Error Geometry!")}var v,y,E,b,x,M,_={},C={};if(u.length){for(y=new Uint32Array(h),v=new Float32Array(c),E=new Float32Array(c),b=new Float32Array(c),n=0,i=u.length;n<i;n++){var I=u[n],O=I.meshId,T=I.positionOffset,L=I.position.length,S=I.indexOffset,D=I.index.length;for(x=0,M=I.index.length;x<M;x++)I.index[x]+=T/3;v.set(I.position,T),y.set(I.index,S),E.set(I.normal,T),b.set(I.uv,2*T/3),_[O]={positionStart:T,positionCount:L,indexStart:S,indexCount:D,uvStart:2*T/3,uvCount:2*L/3},this.descriptor.setToGeometryIdMap(t,O),this.descriptor.setToBufferDataObjectIdMap(O,t)}C={index:new Uint32Array(y),position:new Float32Array(v),normal:new Float32Array(E),uv:new Float32Array(b)}}else{for(y=new Uint32Array(l),v=new Float32Array(s),E=new Float32Array(s),n=0,i=o.length;n<i;n++){var I=o[n],O=I.meshId,T=I.positionOffset,S=I.indexOffset,L=I.position.length,D=I.index.length;for(I.index instanceof Uint16Array&&(I.index=Uint32Array.from(I.index)),x=0,M=I.index.length;x<M;x++)I.index[x]+=T/3;v.set(I.position,T),y.set(I.index,S),E.set(I.normal,T),_[O]={positionStart:T,positionCount:L,indexStart:S,indexCount:D},this.descriptor.setToGeometryIdMap(t,O),this.descriptor.setToBufferDataObjectIdMap(O,t)}C={index:new Uint32Array(y),position:new Float32Array(v),normal:new Float32Array(E)}}this.descriptor.setToBufferDataObjectMap(t,{bufferData:C,positionOffsetMap:_}),r=null}},{key:"_parseMpk",value:function(e,t){var n,i,r,a,o=new CLOUD.Loader.BMPKReader(e),s={},l={};if(o.tBuffer.byteLength){for(n=0,i=o.header.meshCount;n<i;++n)r=o.getMeshData(n),a=r.mesh_id,s[a]={positionStart:r.vOffset/4,positionCount:3*r.ptCount,indexStart:r.iOffset/4,indexCount:r.idxCount,uvStart:r.tOffset/4,uvCount:2*r.ptCount},this.descriptor.setToGeometryIdMap(t,a),this.descriptor.setToBufferDataObjectIdMap(a,t);l={index:new Uint32Array(o.iBuffer),position:new Float32Array(o.vBuffer),normal:new Float32Array(o.nBuffer),uv:new Float32Array(o.tBuffer)}}else{for(n=0,i=o.header.meshCount;n<i;++n)r=o.getMeshData(n),a=r.mesh_id,s[a]={positionStart:r.vOffset/4,positionCount:3*r.ptCount,indexStart:r.iOffset/4,indexCount:r.idxCount},this.descriptor.setToGeometryIdMap(t,a),this.descriptor.setToBufferDataObjectIdMap(a,t);l={index:new Uint32Array(o.iBuffer),position:new Float32Array(o.vBuffer),normal:new Float32Array(o.nBuffer)}}this.descriptor.setToBufferDataObjectMap(t,{bufferData:l,positionOffsetMap:s}),o=null}}]),t}(CLOUD.ModelView.DefaultBaseLoader);CLOUD.ModelView.IncrementBatchedLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.manager=e,n.nodePriority={high:[],medium:[],low:[]},n.visibleOctant=[],n.occlusionVisibleOctant=[],n.usedNodeInfosObject={},n.lineNodes={},n.blinkMaterials=[],n.activeMeshMap={},n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.activeMeshMap=null,this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}},{key:"disposeLineNodes",value:function(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}},{key:"update",value:function(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}},{key:"cullNodes",value:function(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var n=0;n=CLOUD.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,n)}},{key:"getPriorityNodes",value:function(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}},{key:"_cullNodesWithInnerAndOuterOctree",value:function(e,t){var n=0,i=0,r=e.getModelDescriptor().getOctreeRootNode(),a=r.inner,o=r.outer;if(this.manager.getContainsCamera(e)||!o)return this.visibleOctant.length=0,a&&this._frustumCull(e,t,a),o&&this._frustumCull(e,t,o),i=this.visibleOctant.length,i>0&&(this._sortVisibleOctant(t),n=this._logicCull(e,!0,!0,n,i)),n;o&&(this.visibleOctant.length=0,this._frustumCull(e,t,o),(i=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),n=this._logicCull(e,!0,!1,n,i)));var s=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||s._hasRenderPromotionFilter())&&a&&(this.visibleOctant.length=0,this._frustumCull(e,t,a),(i=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),n=this._logicCull(e,!0,!1,n,i))),n}},{key:"_cullNodesWithLayerOctree",value:function(e,t){var n=0;this.visibleOctant.length=0;var i=e.getModelDescriptor().getOctreeRootNode().layer;this._frustumCull(e,t,i);var r=this.visibleOctant.length;return r>0&&(this._sortVisibleOctant(t),n=this._logicCull(e,!0,!0,n,r)),n}},{key:"_cullNodesWithOctant",value:function(e,t){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}},{key:"_cullNodesWithFull",value:function(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}},{key:"_calcPrioritizedNodeCount",value:function(e,t){var n=t+this.nodePriority.high.length+this.nodePriority.medium.length;return n>this.manager.getRenderableCount(e)&&(n=this.manager.getRenderableCount(e)),n}},{key:"_updateMeshNodes",value:function(e){if(this._clearActiveMeshMap(),this._clearLineSegmentsNodeGroup(e),e.isOnlyWireframe())return 0;var t=e.prioritizedNodeCount;if(0===t)return 0;var n=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],i=null;n[0].length>0&&(i=e.selectedMaterial);var r=e.getFilter()._hasOverrideMaterialFilter(),a={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,s=0,l=0,u=n.length;l<u;++l)for(var c=n[l],h=0,d=Object.keys(c).length;h<d&&!(o>t);++h){s++;var f,p=c[h];f=0===l?this._getUsableMaterial(e,p,i,r):this._getUsableMaterial(e,p,null,r);var m=!p.instanceOrNot;if(this._isLineSegments(p))this._dealLineSegments(e,p,m,f);else{var g=e.pool.counter;this._dealMeshes(e,p,m,f,a);var v=e.pool.counter-g;o+=v,t+=v-1}f=null}return i=null,n=null,s}},{key:"_getUsableMaterial",value:function(e,t,n,i){var r=t.materialId,a=t.userId,o=e.materialManager.materials,s=e.manager.sceneState,l=e.getFilter(),u=null,c=s.isSelected(a);1!=c||l._isPickable(t)||(c=!1),n?CLOUD.GlobalData.PickingEffect?u=l._getOverrideMaterial(t):(u=l._getOverrideMaterial(t))&&!c||(u=n):i&&(u=l._getOverrideMaterial(t));var h=e.manager.getOverrideMaterialByNodeInfo(t);return u=u||h||o[r]||CLOUD.MaterialUtil.getDefaultStandardMaterial(),
CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass&&s.hoverId===a&&!1===c&&(u=s.getHoverMaterial(u)),u}},{key:"getMeshesByUserIds",value:function(e,t,n){for(var i=e.pool._pool,r=t.toString(),a=n.toString(),o=0;o<i.length;o++){var s=i[o];if(s.name==r||s.name==a){var l={};l.mesh=s,l.matrix=s.matrix;var u=s.geometry.boundingBox;u||(s.geometry.computeBoundingBox(),u=l.mesh.geometry.boundingBox),l.boundingBox=u,e.minDistanceObjects[s.name].push(l)}}}},{key:"explode",value:function(e){for(var t=e.pool._pool,n=0;n<t.length;n++){var i=t[n],r=e.manager.getExplosionTranslation(i.name);i.translateZ(r.z),i.updateMatrix(),i.updateMatrixWorld()}}},{key:"getGeometryByNodeInfo",value:function(e,t){var n=!!e.getModelDescriptor()._isParameterizedNodeType(t.geometryId),i=n?t.geometryId+"|"+t.nodeId:t.nodeId;if(this._hasGeometry(i))return this.getGeometryById(i);if(this._isLines(t))return this._createGeometryForLineNodeByNodeInfo(e,t);var r=n?this._createGeometryForParameterizedNodeByNodeInfo(e,t):this._createGeometryByNodeInfo(e,t);return r?(this._cacheGeometry(i,r),r):null}},{key:"_createGeometryForParameterizedNodeByNodeInfo",value:function(e,t){if(t.instanceOrNot)return null;var n=e.getModelDescriptor(),i=n.getBufferDataObjectByGeometryId(t.geometryId);if(!i)return null;if(!t.uvArrayBuffer)return i.geometry;var r=[],a=i.geometry;a instanceof Array||(a=[a]);for(var o=new THREE.Matrix3,s=new THREE.Vector3,l=t.uvArrayBuffer,u=0,c=a.length;u<c;u++){var h=new THREE.BufferGeometry;h.setIndex(a[u].index),h.addAttribute("position",a[u].attributes.position),h.addAttribute("normal",a[u].attributes.normal),o.set(l[6*u],l[6*u+2],l[6*u+4],l[6*u+1],l[6*u+3],l[6*u+5],0,0,1);for(var d=[],f=a[u].attributes.uv.array,p=0,m=f.length;p<m;p+=2)s.set(f[p],f[p+1],1),s.applyMatrix3(o),d.push(s.x),d.push(s.y);h.addAttribute("uv",new THREE.Float32BufferAttribute(d,2)),r.push(h)}return r}},{key:"_createGeometryByNodeInfo",value:function(e,t){var n=t.geometryId,i=e.getModelDescriptor(),r=i.getBufferDataObjectByGeometryId(n);if(!r)return null;var a=new THREE.BufferGeometry;a.setIndex(r.geometry.getIndex()),a.addAttribute("position",r.geometry.getAttribute("position"));var o=r.geometry.getAttribute("normal");o&&a.addAttribute("normal",o);var s=r.geometry.getAttribute("uv");s&&a.addAttribute("uv",s);var l=r.getPositionAndIndexOffset(n);return a.setDrawRange(l.indexStart,l.indexCount),a._withDrawRange=!0,a._positionOffset=l,a}},{key:"_createGeometryForLineNodeByNodeInfo",value:function(e,t){return this._createGeometryByNodeInfo(e,t)}},{key:"_dealMeshes",value:function(e,t,n,i,r){var a=this.getGeometryByNodeInfo(e,t);if(a){a instanceof Array||(a=[a]);for(var o=e.pool,s=0,l=a.length;s<l;s++){var u=o.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,userData:t.userData,geometry:a[s],matrix:t.matrix,material:i,renderOrder:i.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth,visible:n});u&&(u.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,u),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new CLOUD.SingleCapsuleObjectWithDrawRange(t.nodeId,u)))}}}},{key:"_dealLineSegments",value:function(e,t,n,i){var r=this.getGeometryByNodeInfo(e,t);if(r){var a=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||(o=new CLOUD.LineSegmentsEx(r,i),o.databagId=e.databagId,o.name=t.userId,o.nodeId=t.nodeId,o.geometryId=t.geometryId,this.lineNodes[t.nodeId]=o),o.material=i,o.visible=n,a.add(o),o.updateMatrixWorld(!0),this._cacheActiveMesh(t.userId,t.nodeId,new CLOUD.SingleCapsuleObject(o))}}},{key:"_frustumCull",value:function(e,t,n){function i(e,t,n,r,a){var o,u;if(t&&e.depth<n&&(l.set(e.min,e.max),o=t.intersectsBox(l)),o){if(r){var c=l.applyMatrix4(s),h=c.getSize().length(),d=c.getCenter().z;d=d>1e-6?d:1e-6,e.priority=h/d,a.push(e)}else a.push(e);for(var f=0,p=e.childOctants.length;f<p;++f)u=e.childOctants[f],i(u,t,n,r,a)}}var r=e.manager,a=t.getFrustum(),o=CLOUD.GlobalData.OctantDepth,s=t.projScreenMatrix,l=new THREE.Box3;(CLOUD.GlobalData.DEBUG&&r.showOctreeBox(n),i(n,a,o,!0,this.visibleOctant),CLOUD.GlobalData.OcclusionTranslucentEnabled)&&i(n,this.manager.getFrustumFromOcclusionCamera(),o,!1,this.occlusionVisibleOctant);return!0}},{key:"_logicCull",value:function(e,t,n,i,r){var a=e.manager,o=e.getFilter(),s=o._hasHiddenFileIdFilter(),l=o._hasOverrideMaterialFilter(),u=a.sceneState.selectionSet,c=o._hasRenderPromotionFilter(),h=this.nodePriority.high,d=this.nodePriority.medium,f=this.nodePriority.low,p=this.nodePriority.low.length,m=e.getModelDescriptor().getNodeInfosWithCellId(),g=a.getCategoriesFromHighPriority("outer");!0===n&&(g=a.getCategoriesFromHighPriority("inner"));for(var v,y=0,E=0;E<r;++E){var b,x=0;t?(b=this.visibleOctant[E].octantId,x=this.visibleOctant[E].depth):b=E;var M=m[b];if(M){var _=this._getUsedNodeInfosByCellId(b);if(!_){for(v=0,y=M.length;v<y;++v){var C=M[v];C.octantId=b,C.cellDepth=x,this._isSatisfied(e,C)&&this._cacheUsedNodeInfosByCellId(b,C)}_=this._getUsedNodeInfosByCellId(b)}if(_){var I=_.default;for(v=0,y=I.length;v<y;v++){var C=I[v];!function(t,n){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&!(s&&o._isHiddenFileId(t)||!1===o._isVisible(t))){if(u.hasOwnProperty(t.userId)||l&&o._hasHighPriorityOverrideMaterial(t))return void h.push(t);var r=!1;if(c&&o._isRenderPromotion(t)&&(r=!0),n){var a=t.userData,m=a?a.categoryId:void 0;m&&n[m]&&(r=!0)}if(r)return void d.push(t);i<p&&(f[i]=t,i++)}}(C,g)}}}}return CLOUD.Logger.timeEnd("collectNodeInfo"),i}},{key:"_clearUsedNodeInfosObject",value:function(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}},{key:"_getUsedNodeInfosByCellId",value:function(e){return this.usedNodeInfosObject[e]}},{key:"_cacheUsedNodeInfosByCellId",value:function(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}},{key:"_isSatisfied",value:function(e,t){var n=e.getLoadedUserIdsObject();return!n||!!n[t.userId]}},{key:"_logicCullWithFull",value:function(e,t){return this._logicCull(e,!1,!0,0,t)}},{key:"_sortVisibleOctant",value:function(e,t){var n=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var i=new CLOUD.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);n=i.getAncestorAndNeighbors()}this.visibleOctant.sort(function(e,t){if(null!=n){if(void 0!=n[e.octantId])return-1;if(void 0!=n[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0})}},{key:"_applyOcclusionTranslucent",value:function(e){if(CLOUD.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),n=e.manager.octantToObjectMap,i=this.occlusionVisibleOctant.length;if(i>0)for(var r=e.manager.getFrustumFromOcclusionCamera(),a=0;a<i;++a){var o=this.occlusionVisibleOctant[a].octantId,s=n[o];if(s&&s.length>0)for(var l=0,u=s.length;l<u;l+=2)for(var c=s[l];c<=s[l+1];c++){var h=t[c];CLOUD.CameraUtil.intersectObjectWithFrustum(h,r)&&this._overrideOcclusionMaterial(h)}}}}},{key:"_overrideOcclusionMaterial",value:function(e,t){var n=t.material;if(n&&!1===n.transparent){var i=e.manager.acquireMaterial(),r=i.material;n.color?r.color.copy(n.color):i.resetColor(),r.opacity=CLOUD.GlobalData.OcclusionOpacity,t.material=r,t.material.needsUpdate=!0}}},{key:"_clearNodePriorityData",value:function(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}},{key:"_adjustLowNodePriorityLength",value:function(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}},{key:"_clearLineSegmentsNodeGroup",value:function(e){this._getLineSegmentsNodeGroup(e).clear()}},{key:"_getLineSegmentsNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}},{key:"_isLineSegments",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"getBlinkMaterials",value:function(){return this.blinkMaterials}},{key:"getGeometryBuffersByUserId",value:function(e,t){var n=e.getModelDescriptor().getStandardNodeInfosById(t);if(!n)return[];for(var i=[],r=e.getDatabagId(),a=0,o=n.length;a<o;a++){var s=n[a],l=this.getGeometryByNodeInfo(e,s);if(l){var u=this._isLines(s);if(l instanceof Array)for(var c=0,h=l.length;c<h;c++)i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else i.push({isLines:u,databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}}return i}},{key:"_isLines",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"traverseActiveMeshMap",value:function(e,t){e=e||Object.keys(this.activeMeshMap);for(var n=0,i=e.length;n<i;n++){var r=e[n];if(this.activeMeshMap[r])for(var a=Object.keys(this.activeMeshMap[r]),o=0,s=a.length;o<s;o++){var l=a[o],u=this.activeMeshMap[r][l];t(r,l,u)}}}},{key:"getActiveMeshMapById",value:function(e){return this.activeMeshMap[e]}},{key:"_cacheActiveMesh",value:function(e,t,n){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(n)}},{key:"_clearActiveMeshMap",value:function(){this.activeMeshMap={}}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingMeshGenerator(this)),this.pickingNodeGenerator}}]),t}(CLOUD.ModelView.MeshBaseManager);CLOUD.ModelView.IncrementBatchedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}return _createClass(e,[{key:"destroy",value:function(){this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.manager=null}},{key:"clearData",value:function(){this.pickingNodeGenerator&&this.pickingNodeGenerator.clearData(),this._clearWireframeLineMeshes(),this._disposeGeometries()}},{key:"update",value:function(e,t){if(0===t)return void this._clearWireframeGroupNode(e);this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e)}},{key:"_disposeGeometries",value:function(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}},{key:"_disposeGeometry",value:function(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var n=0,i=t.length;n<i;n++)t[n].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}},{key:"_clearWireframeLineMeshes",value:function(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}},{key:"_clearWireframeGroupNode",value:function(e){this._getWireWireframeGroupNode(e).clear()}},{key:"_removeWireframeGroupNode",value:function(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}},{key:"isActivateWireframe",value:function(e){return e.isActivateWireframe()}},{key:"_getWireWireframeGroupNode",value:function(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}},{key:"_getWireframeGeometryByNodeInfo",value:function(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}},{key:"_buildGeometryEdge",value:function(e){var t,n=e.attributes.position.array,i=e.index.array;if(e._withDrawRange){var r=e._positionOffset,a=i.slice(r.indexStart,r.indexStart+r.indexCount),o=n.slice(r.positionStart,r.positionStart+r.positionCount),s=r.positionStart/3;a.forEach(function(e,t,n){n[t]-=s}),t=CLOUD.BuildEdge(o,a),t.forEach(function(e,t,n){n[t]+=s})}else t=CLOUD.BuildEdge(n,i);return t}},{key:"_getWireframeGeometryById",value:function(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];Array.isArray(t)||(t=[t]);for(var n,i=[],r=0,a=t.length;r<a;r++){var o=t[r],s=this._buildGeometryEdge(o);n=new THREE.BufferGeometry,n.setIndex(new THREE.Uint32BufferAttribute(s,1)),n.addAttribute("position",o.getAttribute("position")),i.push(n)}return this.wireframeGeometryMap[e]=i,this.wireframeGeometryMap[e]}},{key:"_makeWireframeLineMeshes",value:function(e,t,n){if(t.type!==CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE){var i=this.wireframeLineMeshes[t.nodeId];if(!i){i=this.wireframeLineMeshes[t.nodeId]=[];for(var r=this._getWireframeGeometryByNodeInfo(e,t),a=0,o=r.length;a<o;a++){var s=new THREE.LineSegments(r[a],this._getWireframeMaterial(e));s.name=t.nodeId+"_"+a,s.applyMatrix(t.matrix),i.push(s)}}if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&function(e,t){return(!CLOUD.GlobalData.Instance||"box"!=e.geometryId&&"boxM"!=e.geometryId)&&!(t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e))}(t,this._getFilter(e)))for(var l=0,u=i.length;l<u;l++)n.add(i[l])}}},{key:"_generateWireframeNodes",value:function(e,t){for(var n=this._getWireWireframeGroupNode(e),i=this.manager.getPriorityNodes(),r=0,a=0,o=i.length;a<o;++a)for(var s=i[a],l=0,u=Object.keys(s).length;l<u&&!(++r>t);++l){var c=s[l];this._makeWireframeLineMeshes(e,c,n)}}},{key:"_getWireframeGroupName",value:function(e){return e._getWireframeGroupName()}},{key:"_getWireframeMaterial",value:function(e){return e.getWireframeMaterial()}},{key:"_getFilter",value:function(e){return e.getFilter()}},{key:"explode",value:function(e){for(var t=new THREE.Matrix4,n=e.getModelDescriptor().getAllNodeInfos(),i=Object.keys(n),r=0,a=i.length;r<a;r++){var o=i[r],s=n[o],l=e.manager.getExplosionTranslation(o);t.makeTranslation(l.x,l.y,l.z);for(var u=0,c=s.length;u<c;u++){var h=this.wireframeLineMeshes[s[u].nodeId];if(h)for(var d=0;d<h.length;d++)h[d].applyMatrix(t)}}}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingWireFrameGenerator(this)),this.pickingNodeGenerator}}]),e}();CLOUD.ModelView.IncrementBatchedWireFrameManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.ModelView.IncrementBatchedMeshManager(this),this.wireframeManager=new CLOUD.ModelView.IncrementBatchedWireFrameManager(this)}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"cullNodes",value:function(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"updateNodes",value:function(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}},{key:"applyFilter",value:function(e,t){}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"applyBlink",value:function(e){}},{key:"clearBlink",value:function(e){}},{key:"applyReplacement",value:function(e){}},{key:"getPriorityNodes",value:function(){return this.meshManager.getPriorityNodes()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getRenderableCount",value:function(e){return e.getRenderableCount()}},{key:"getLoader",value:function(e){return e.getLoader()}},{key:"getContainsCamera",value:function(e){return e.containsCamera}},{key:"getFilter",value:function(e){return e.getFilter()}},{key:"getMeshesByUserIds",value:function(e,t,n){this.meshManager.getMeshesByUserIds(e,t,n)}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getWireFrameManager",value:function(){return this.wireframeManager}},{key:"isHiddenNode",value:function(e){return!1}},{key:"isParameterizedNode",value:function(e){}}]),e}();CLOUD.ModelView.IncrementBatchedManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.InstancedMeshManager);CLOUD.ModelView.IncrementInstanceBatchedMeshManager=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),t}(CLOUD.ModelView.InstancedWireframeManager);CLOUD.ModelView.IncrementInstanceBatchedWireFrameManager=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.meshManager=new CLOUD.ModelView.IncrementInstanceBatchedMeshManager(e),e.wireframeManager=new CLOUD.ModelView.IncrementInstanceBatchedWireFrameManager(e),e}return _inherits(t,e),t}(CLOUD.ModelView.InstancedBaseManager);CLOUD.ModelView.IncrementInstanceBatchedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="default",n.defaultManager=new CLOUD.ModelView.IncrementBatchedManager,n.instancedManager=new CLOUD.ModelView.IncrementInstanceBatchedManager,n.loader=new CLOUD.ModelView.IncrementBatchedLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData(function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepare",value:function(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}},{key:"prepareWireframe",value:function(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}},{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(n,i){e.addNodeInfoToOctantMap(t,n,i)})}},{key:"createMeshNodes",value:function(e){var t=this,n=this.model.getModelDescriptor().getInstancedUserIds();if(0===n.length)return t.loaded=!0,void(e&&e());CLOUD.Utils.asyncProcess(n,n.length,500,function(e,n){t.instancedManager.meshManager._createInstanceGeometries(t.model,[e[n]])},function(){t.instancedManager.meshManager._makeInstanceNodes(t.model),t.loaded=!0,e&&e()})}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelView.ModelBaseHandler);CLOUD.ModelView.IncrementBatchedHandler=e}(),CLOUD.OctantNeighborUtil=function(e,t){this.camera=e,this.root=t,this.searchNeighborOfNeighbor=!1,this.containChildOfNeighbor=!1,this.containedOctants=[],this.father=function(e){return e++,e<this.containedOctants.length?this.containedOctants[e]:null},this.adjFace=function(e,t){return n[8*e+t]},this.adjEdge=function(e,t){return i[8*e+t]},this.adjVertex=function(e,t){return e==t},this.refelectFace=function(e,t){return r[8*e+t]},this.refelectEdge=function(e,t){return a[8*e+t]},this.refelectVertex=function(e,t){return this.OctType.MAXTYPEID-t},this.common_face_edge=function(e,t){return o[8*e+t]},this.common_face_vertex=function(e,t){return s[8*e+t]},this.common_edge=function(e,t){return l[8*e+t]},this.son=function(e,t){var n,i=e.childOctants.length;for(n=0;n<i;n++)if(e.childOctants[n].octType==t)return e.childOctants[n];return null},this.FaceType={L:0,R:1,D:2,U:3,B:4,F:5,UNKNOWN:6},this.EdgeType={LD:0,LU:1,LB:2,LF:3,RD:4,RU:5,RB:6,RF:7,DB:8,DF:9,UB:10,UF:11,UNKNOWN:12},this.OctType={RUF:0,LUF:1,RDF:2,LDF:3,RUB:4,LUB:5,RDB:6,LDB:7,MAXTYPEID:7};var n=[!1,!0,!1,!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!0,!0,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1],i=[!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1],r=[1,0,3,2,5,4,7,6,1,0,3,2,5,4,7,6,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3],a=[3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1],o=[6,0,2,6,6,0,2,6,3,6,6,0,3,6,6,0,6,0,6,0,4,6,4,6,5,6,5,6,6,0,6,0,1,6,6,2,1,6,6,2,6,3,1,6,6,3,1,6,1,6,1,6,6,4,6,4,6,5,6,5,1,6,1,6,6,6,2,2,4,4,6,6,5,5,6,6,6,6,2,2,3,3,6,6,6,6,4,4,6,6,5,5,3,3,6,6],s=[6,6,6,5,6,3,1,6,6,6,5,6,3,6,6,0,6,5,6,6,1,6,6,2,5,6,6,6,6,0,2,6,6,3,1,6,6,6,6,4,3,6,6,0,6,6,4,6,1,6,6,2,6,4,6,6,6,0,2,6,1,6,6,6],l=[12,11,7,12,5,12,12,12,11,12,12,3,12,1,12,12,7,12,12,9,12,12,4,12,12,3,9,12,12,12,12,0,5,12,12,12,12,10,6,12,12,1,12,12,10,12,12,2,12,12,4,12,6,12,12,8,12,12,12,0,12,2,8,12]},CLOUD.OctantNeighborUtil.prototype.findFaceNeighborImpl=function(e,t){var n={node:null,cont:!1},i=this.containedOctants,r=i[e];if(e>=i.length)return n;if(this.father(e)&&this.adjFace(t,r.octType)?n=this.findFaceNeighborImpl(e+1,t):(n.node=this.father(e),n.cont=!0),n.cont&&null!==n.node&&n.node.childOctants.length>0){var a=this.son(n.node,this.refelectFace(t,r.octType));return a?{node:a,cont:!0}:{node:n.node,cont:!1}}return n},CLOUD.OctantNeighborUtil.prototype.findFaceNeighbor=function(e,t){var n=this.findFaceNeighborImpl(e,t);return n.node&&!n.node.isRoot()?n.node:null},CLOUD.OctantNeighborUtil.prototype.findEdgeNeighborImpl=function(e,t){var n={node:null,cont:!1},i=this.containedOctants,r=i[e];if(e>=i.length)return n;if(this.father(e)&&(this.adjEdge(t,r.octType)?n=this.findEdgeNeighborImpl(e+1,t):this.common_face_edge(t,r.octType)!==this.FaceType.UNKNOWN?n=this.findFaceNeighborImpl(e+1,this.common_face_edge(t,r.octType)):(n.node=this.father(e),n.cont=!0)),n.cont&&null!==n.node&&n.node.childOctants.length>0){var a=this.son(n.node,this.refelectEdge(t,r.octType));return a?{node:a,cont:!0}:{node:n.node,cont:!1}}return n},CLOUD.OctantNeighborUtil.prototype.findEdgeNeighbor=function(e,t){var n=this.findEdgeNeighborImpl(e,t);return n.node&&!n.node.isRoot()?n.node:null},CLOUD.OctantNeighborUtil.prototype.findVertexNeighborImpl=function(e,t){var n={node:null,cont:!1},i=this.containedOctants,r=i[e];if(e>=i.length)return n;if(this.father(e)&&(this.adjVertex(t,r.octType)?n=this.findVertexNeighborImpl(e+1,t):this.common_edge(t,r.octType)!==this.EdgeType.UNKNOWN?n=this.findVertexNeighborImpl(e+1,this.common_edge(t,r.octType)):this.common_face_vertex(t,r.octType)!=this.FaceType.UNKNOWN?n=this.findVertexNeighborImpl(e+1,this.common_face_vertex(t,r.octType)):(n.node=this.father(e),n.cont=!0)),n.cont&&null!==n.node&&n.node.childOctants.length>0){var a=this.son(n.node,this.refelectVertex(t,r.octType));return a?{node:a,cont:!0}:{node:n.node,cont:!1}}return n},CLOUD.OctantNeighborUtil.prototype.findVertexNeighbor=function(e,t){var n=this.findVertexNeighborImpl(e,t);return n.node&&!n.node.isRoot()?n.node:null},CLOUD.OctantNeighborUtil.prototype.findContainNode=function(e){var t,n=this.camera,i=n.position;if(!(i.x<e.min.x||i.x>e.max.x||i.y<e.min.y||i.y>e.max.y||i.z<e.min.z||i.z>e.max.z)){if(0!=e.childOctants.length){var r,a;for(r=0,a=e.childOctants.length;r<a&&(t=e.childOctants[r],!this.findContainNode(t));++r);}return this.containedOctants.push(e),!0}return!1},CLOUD.OctantNeighborUtil.prototype.findNeighborNode=function(){var e,t=this.searchNeighborOfNeighbor,n=this.containChildOfNeighbor,i=this.camera,r=this.containedOctants,a=this.OctType,o=this.EdgeType,s=[];if(0==r.length)return s;var l,u,c,h,d,f,p,m,g=i.frustum,v=r[0];p=v.min,m=v.max;var y=i.target,E=i.position,b=new THREE.Vector3(y.x-E.x,y.y-E.y,y.z-E.z),x=new THREE.Ray(E,b),M=[],_=new THREE.Box3(p,m),C=x.intersectBox(_);if(C&&(C.y==p.y||C.y==m.y?C.x<=m.x&&C.x>=p.x&&C.z<=m.z&&C.z>=p.z&&(C.y==p.y?M.push(2):M.push(3)):C.z==p.z||C.z==m.z?C.x<=m.x&&C.x>=p.x&&C.y<=m.y&&C.y>=p.y&&(C.z==p.z?M.push(4):M.push(5)):C.x!=p.x&&C.x!=m.x||C.z<=m.z&&C.z>=p.z&&C.y<=m.y&&C.y>=p.y&&(C.x==p.x?M.push(0):M.push(1))),0==M.length)return s;h=m.x-p.x,d=m.y-p.y,f=m.z-p.z,d>h&&(h=d),f>h&&(h=f);var I=h,O=new THREE.Vector3;for(l=0;l<6;l++)if(l!=M[0]){switch(O.copy(v.center),l){case 0:O.x-=I;break;case 1:O.x+=I;break;case 2:O.y-=I;break;case 3:O.y+=I;break;case 4:O.z-=I;break;case 5:O.z+=I}var T=I/2,L=new THREE.Box3(new THREE.Vector3(O.x-T,O.y-T,O.z-T),new THREE.Vector3(O.x+T,O.y+T,O.z+T));g.intersectsBox(L)&&M.push(l)}if(M.length>1&&M.sort(),M.length>2){var S=0;for(l=0;l<M.length;l++)for(u=l+1;u<M.length;u++)for(c=u+1;c<M.length;c++){if(1==M[l]&&3==M[u]&&5==M[c])S=a.RUF;else if(0==M[l]&&3==M[u]&&5==M[c])S=a.LUF;else if(1==M[l]&&2==M[u]&&5==M[c])S=a.RDF;else if(0==M[l]&&2==M[u]&&5==M[c])S=a.LDF;else if(1==M[l]&&3==M[u]&&4==M[c])S=a.RUB;else if(0==M[l]&&3==M[u]&&4==M[c])S=a.LUB;else if(1==M[l]&&2==M[u]&&4==M[c])S=a.RDB;else{if(0!=M[l]||2!=M[u]||4!=M[c])continue;S=a.LDB}e=this.findVertexNeighbor(0,S),e&&(s.push(e),n&&this.getChildOfOctant(e,2,S,s),t&&(e=this.getNeighborOfSecondLevel(e,2,S))&&s.push(e))}}if(M.length>1){var D=0;for(l=0;l<M.length;l++)for(u=l+1;u<M.length;u++){if(0==M[l]&&2==M[u])D=o.LD;else if(0==M[l]&&3==M[u])D=o.LU;else if(0==M[l]&&4==M[u])D=o.LB;else if(0==M[l]&&5==M[u])D=o.LF;else if(1==M[l]&&2==M[u])D=o.RD;else if(1==M[l]&&3==M[u])D=o.RU;else if(1==M[l]&&4==M[u])D=o.RB;else if(1==M[l]&&5==M[u])D=o.RF;else if(2==M[l]&&4==M[u])D=o.DB;else if(2==M[l]&&5==M[u])D=o.DF;else if(3==M[l]&&4==M[u])D=o.UB;else{if(3!=M[l]||5!=M[u])continue;D=o.UF}e=this.findEdgeNeighbor(0,D),e&&(s.push(e),n&&this.getChildOfOctant(e,1,D,s),t&&(e=this.getNeighborOfSecondLevel(e,1,D))&&s.push(e))}}for(l=0;l<M.length;l++)(e=this.findFaceNeighbor(0,M[l]))&&(s.push(e),n&&this.getChildOfOctant(e,0,M[l],s),t&&(e=this.getNeighborOfSecondLevel(e,0,M[l]))&&s.push(e));return s.sort(function(e,t){return e.octantId<t.octantId?-1:1}),s},CLOUD.OctantNeighborUtil.prototype.getChildOfOctant=function(e,t,n,i){if(!(0==e.childOctants.length||e.depth<4)){var r=this.FaceType,a=[];switch(t){case 0:a.push(n%2==0?n+1:n-1);break;case 1:var o=this.EdgeType;switch(n){case o.LD:a.push(r.R),a.push(r.U);break;case o.LU:a.push(r.R),a.push(r.D);break;case o.LB:a.push(r.R),a.push(r.F);break;case o.LF:a.push(r.R),a.push(r.B);break;case o.RD:a.push(r.L),a.push(r.U);break;case o.RU:a.push(r.L),a.push(r.D);break;case o.RB:a.push(r.L),a.push(r.F);break;case o.RF:a.push(r.L),a.push(r.B);break;case o.DB:a.push(r.U),a.push(r.F);break;case o.DF:a.push(r.U),a.push(r.B);break;case o.UB:a.push(r.D),a.push(r.F);break;case o.UF:a.push(r.D),a.push(r.B)}break;case 2:var s=this.OctType;switch(n){case s.RUF:a.push(r.L),a.push(r.D),a.push(r.B);break;case s.LUF:a.push(r.R),a.push(r.D),a.push(r.B);break;case s.RDF:a.push(r.L),a.push(r.U),a.push(r.B);break;case s.LDF:a.push(r.R),a.push(r.U),a.push(r.B);break;case s.RUB:a.push(r.L),a.push(r.D),a.push(r.F);break;case s.LUB:a.push(r.R),a.push(r.D),a.push(r.F);break;case s.RDB:a.push(r.L),a.push(r.U),a.push(r.F);break;case s.LDB:a.push(r.R),a.push(r.U),a.push(r.F)}}for(var l=0;l<a.length;l++)this.getFaceChildOfOctant(e,a[l],i)}},CLOUD.OctantNeighborUtil.prototype.getFaceChildOfOctant=function(e,t,n){for(var i,r,a=0,o=e.childOctants.length;a<o;a++)if(i=e.childOctants[a],this.adjFace(t,i.octType))n.push(i),this.getFaceChildOfOctant(i,t,n);else{r=this.refelectFace(t,i.octType);for(var s=0;s<o&&e.childOctants[s].octType!=r;s++);s==o&&(n.push(i),this.getFaceChildOfOctant(i,t,n))}},CLOUD.OctantNeighborUtil.prototype.getNeighborOfSecondLevel=function(e,t,n){var i=[],r=[],a=[];a[0]=e,this.getAncestorNodes(this.root,a,0,i,r);var o=new CLOUD.OctantNeighborUtil(this.camera,this.root);o.containedOctants=r;var s=null;switch(t){case 0:s=o.findFaceNeighbor(0,n);break;case 1:s=o.findEdgeNeighbor(0,n);break;case 2:s=o.findVertexNeighbor(0,n)}return s},CLOUD.OctantNeighborUtil.prototype.getAncestorAndNeighbors=function(){this.searchNeighborOfNeighbor=!0,this.containChildOfNeighbor=!0;var e=this.containedOctants;this.findContainNode(this.root);var t=this.findNeighborNode(this.camera,e),n=[],i=[];this.getAncestorNodes(this.root,t,0,n,i);var r,a,o={};for(r=0,a=e.length;r<a;r++)o[e[r].octantId]=1;for(r=0,a=t.length;r<a;r++)o[t[r].octantId]=1;for(r=0,a=i.length;r<a;r++)o[i[r].octantId]=1;return o},CLOUD.OctantNeighborUtil.prototype.getAncestorNodes=function(e,t,n,i,r){var a,o,s;for(a=0,o=e.childOctants.length;a<o&&n<t.length;a++){if(s=e.childOctants[a],i.push(s),s.octantId==t[n].octantId){for(var l=i.length-1;l>=0;l--)r.push(i[l]);n++}else(a==o-1||e.childOctants[a+1].octantId>t[n].octantId)&&(n=this.getAncestorNodes(s,t,n,i,r));i.pop()}return n},CLOUD.OctantNeighborUtil.prototype.outputOctants=function(e,t){console.group(),console.log("Node that contains camera: %d",t.octantId);var n="",i=0;for(var r in e)n+=r,n+="  ",i%9==0&&(n+="\n"),i++;console.log("nodes: %s",n),console.groupEnd()},CLOUD.OctantNeighborUtil.prototype.outputOctree=function(e,t){console.group();var n,i="";for(n=0;n<e.depth;n++)i+="  ";console.log("%sNode id: %i, depth: %i, octType: %i, parent: %i",i,e.octantId,e.depth,e.octType,t),console.log("%s  size: %f, center: %f, %f, %f",i,e.size,e.center.x,e.center.y,e.center.z),console.log("%s  child number: %i",i,e.childOctants.length);var r="";for(n=0;n<e.childOctants.length;n++)r+=e.childOctants[n].octantId,r+="  ";for(console.log("%s  children: %i",i,r),n=0;n<e.childOctants.length;n++)this.outputOctree(e.childOctants[n],e.octantId);console.groupEnd()},CLOUD.Loader.OctreeNode=function(e,t){void 0===e&&alert("Invalid Octant Id"),this.octantId=e,this.childOctants=new Array,this.min=null,this.max=null,this.depth=t||0,this.center=null,this.size=-1,this.priority=-1,this.octType=-1},CLOUD.Loader.OctreeNode.prototype.isRoot=function(){return 0==this.depth},CLOUD.Loader.OctreeNode.prototype.add=function(e){e.depth=this.depth+1,this.childOctants.push(e)},CLOUD.Loader.OctreeNode.prototype.updateMaxDepth=function(){this.depth>CLOUD.GlobalData.MaximumDepth&&(CLOUD.GlobalData.MaximumDepth=this.depth)},function(){var e=function(){function e(){_classCallCheck(this,e),this.visibleOctantList=[]}return _createClass(e,[{key:"destroy",value:function(){this.visibleOctantList=null}},{key:"_getVisibleOctantsWithInnerAndOuterOctree",value:function(e,t,n){this.visibleOctantList.length=0;var i=e.getModelDescriptor().getOctreeRootNode(),r=i.inner,a=i.outer;if(!r&&!a)return[];var o=e.containsCamera,s=null;if(o)r&&(s=new CLOUD.OctantNeighborUtil(t,r).getAncestorAndNeighbors(),this._frustumCull(t,r,n,this.visibleOctantList)),a&&this._frustumCull(t,a,n,this.visibleOctantList),this._sortOctantList(this.visibleOctantList,s);else{var l=[],u=[];a&&(this._frustumCull(t,a,!0,l),this._sortOctantList(l,s)),r&&(s=new CLOUD.OctantNeighborUtil(t,r).getAncestorAndNeighbors(),this._frustumCull(t,r,n,u),this._sortOctantList(u,s));var c,h=l.length,d=u.length
;for(c=0;c<h;c++)this.visibleOctantList[c]=l[c];for(c=0;c<d;c++)this.visibleOctantList[h+c]=u[c]}return this.visibleOctantList}},{key:"_getVisibleOctantsWithLayerOctree",value:function(e,t,n){this.visibleOctantList.length=0;var i=e.getModelDescriptor().getOctreeRootNode().layer;return this._frustumCull(t,i,n,this.visibleOctantList),this._sortOctantList(this.visibleOctantList),this.visibleOctantList}},{key:"getVisibleOctants",value:function(e,t,n){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._getVisibleOctantsWithInnerAndOuterOctree(e,t,n):this._getVisibleOctantsWithLayerOctree(e,t,n)}},{key:"_sortOctantList",value:function(e,t){e.sort(function(e,n){if(null!=t){if(void 0!=t[e.octantId])return-1;if(void 0!=t[n.octantId])return 1}return e.priority>n.priority?-1:e.priority<n.priority?1:0})}},{key:"showOctreeBox",value:function(e){if(CLOUD.GlobalData.DEBUG){var t=e.getModelDescriptor().getOctreeRootNode();e.getModelDescriptor().isUseInnerAndOuterOctree()?(t.inner&&e.manager.showOctreeBox(t.inner),t.outer&&e.manager.showOctreeBox(t.outer)):t.layer&&e.manager.showOctreeBox(t.layer)}}},{key:"_frustumCull",value:function(e,t,n,i){function r(e,t,n,i,a){var o;if(t&&e.depth<n&&(l.set(e.min,e.max),o=t.intersectsBox(l)),o){if(i){var c=l.applyMatrix4(s),h=c.getSize().length(),d=c.getCenter().z;d=d>u?d:u,e.priority=h/d,a.push(e)}else a.push(e);for(var f=0,p=e.childOctants.length;f<p;++f){r(e.childOctants[f],t,n,i,a)}}}var a=e.getFrustum(),o=CLOUD.GlobalData.OctantDepth,s=e.projScreenMatrix,l=new THREE.Box3,u=1e-6;r(t,a,o,n,i)}},{key:"_traverseOctants",value:function(e,t){function n(e,t){t.push(e);for(var i=0,r=e.childOctants.length;i<r;++i){n(e.childOctants[i],t)}}n(e,t)}},{key:"getAllOctants",value:function(e){var t=[],n=e.getModelDescriptor().getOctreeRootNode();return e.getModelDescriptor().isUseInnerAndOuterOctree()?(n.inner&&this._traverseOctants(n.inner,t),n.outer&&this._traverseOctants(n.outer,t)):n.layer&&this._traverseOctants(n.layer,t),t}}]),e}();CLOUD.OctantManager=e}(),CLOUD.MaterialSelector=function(){var e=[{name:"scene",param:{name:"scene",color:8947848,opacity:.4,transparent:!0,side:THREE.DoubleSide}},{name:"darkRed",param:{name:"darkRed",color:10496040,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"lightBlue",param:{name:"lightBlue",color:1275840,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"black",param:{name:"black",color:0,opacity:.3,transparent:!0,side:THREE.DoubleSide}},{name:"add",param:{name:"add",color:65280,opacity:1,transparent:!0,side:THREE.DoubleSide}},{name:"delete",param:{name:"delete",color:16711680,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"beforeEdit",param:{name:"beforeEdit",color:16432389,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"afterEdit",param:{name:"afterEdit",color:16432389,opacity:1,transparent:!0,side:THREE.DoubleSide}}],t={};t.selection=CLOUD.MaterialUtil.createHighlightMaterial(),t.selection.name="selection";for(var n=0,i=e.length;n<i;++n){var r=e[n],a=r.name,o=r.param;t[a]=CLOUD.MaterialUtil.createStandardMaterial(o)}t.red=t.delete,t.green=t.add,t.yellow=t.beforeEdit,t.blue=t.selection;var s={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},l=CLOUD.MaterialUtil.createStandardMaterial(s);l.name="isolate";var u={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},c=CLOUD.MaterialUtil.createStandardMaterial(u);c.name="frozen";var h={color:15293,side:THREE.DoubleSide},d=CLOUD.MaterialUtil.createStandardMaterial(h);d.name="selected",this.getDefaultMaterialName=function(){return"lightBlue"},this.get=function(e){return t[e]},this.getAll=function(){return t},this.add=function(e){var n,i,r={};return e&&e.hasOwnProperty("uuid")?(n="override_"+e.uuid,delete e.uuid,i=t[n],i||(e.name=n,i=CLOUD.MaterialUtil.createStandardMaterial(e),t[n]=i),n):(e&&e.hasOwnProperty("color")&&(r.color=e.color,r.side=THREE.DoubleSide,e.hasOwnProperty("opacity")&&(r.opacity=e.opacity,r.transparent=1!=e.opacity),e.hasOwnProperty("map")&&(r.map=e.map,e.hasOwnProperty("bumpMap")&&(r.bumpMap=e.bumpMap))),n=this._getMaterialName(e),i=t[n],i||(r.name=n,i=CLOUD.MaterialUtil.createStandardMaterial(r),t[n]=i),n)},this.remove=function(e){var n,i;n=this._getMaterialName(e),(i=t[n])&&delete t[n]},this.has=function(e){return!!t[e]},this.getMaterialNameByColor=function(e){var n,i;return n=this._getMaterialName(e),i=t[n],i?n:this.add(e)},this.addOverrideMaterial=function(e){if(e){var n=e.name;t[n]||(t[n]=e)}},this.getMaterialParamsFromName=function(e){var t={},n=e.split("_");return"mat"==n[0]?(t.color=parseInt(n[1]),t.opacity=1):(t.color=parseInt(n[0]),t.opacity=parseFloat(n[1])),t},this._getMaterialName=function(e){var t;return e&&e.hasOwnProperty("color")?(t=e.hasOwnProperty("opacity")?e.color+"_"+e.opacity:"mat_"+e.color,e.hasOwnProperty("map")&&(t+="_"+e.map.uuid),e.hasOwnProperty("setByOpacity")&&(t+="_opacity")):t="mat_"+e,t},this.setFrozonMaterial=function(e){void 0!==e.color?c.color.setHex(e.color):c.color.setHex(u.color),void 0!==e.opacity?c.opacity=e.opacity:c.opacity=u.opacity,void 0!==e.transparent?c.transparent=e.transparent:c.transparent=u.transparent,void 0!==e.side?c.side=e.side:c.side=u.side,c.needsUpdate=!0},this.getFrozonMaterial=function(){return c},this.setSelectedMaterial=function(e){void 0!==e.color?d.color.setHex(e.color):d.color.setHex(h.color),void 0!==e.opacity?d.opacity=e.opacity:d.opacity=h.opacity,void 0!==e.transparent?d.transparent=e.transparent:d.transparent=h.transparent,void 0!==e.side?d.side=e.side:d.side=h.side,d.needsUpdate=!0},this.getSelectedMaterial=function(){return d},this.setIsolateMaterial=function(e){void 0!==e.color?l.color.setHex(e.color):l.color.setHex(s.color),void 0!==e.opacity?l.opacity=e.opacity:l.opacity=s.opacity,void 0!==e.transparent?l.transparent=e.transparent:l.transparent=s.transparent,void 0!==e.side?l.side=e.side:l.side=s.side,l.needsUpdate=!0},this.getIsolateMaterial=function(){return l},this.resetIsolateMaterial=function(){l.color.setHex(s.color),l.opacity=s.opacity,l.transparent=s.transparent,l.side=s.side,l.needsUpdate=!0}},CLOUD.EnumConditionType={HIDDEN_OTHERS:0,TRANSLUCENT_OTHERS:1,OVERRIDE:2,BORDERLINE:3},CLOUD.EnumIdBasedType={FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6},CLOUD.EnumUserType={HIDDEN_DATA:0,OVERRIDE_DATA:1},CLOUD.EnumIsolateState={HIDDEN:0,HIDDEN_OTHERS:1,TRANSLUCENT:2,TRANSLUCENT_OTHERS:3},CLOUD.EnumSceneState={DISABLED:0,TRANSLUCENT:1,HIDDEN:2},CLOUD.FilterManager=function(){this._filterImpl=new CLOUD.FilterManager2;var e=[],t=null,n=this._filterImpl.getMaterialSelector(),i=new CLOUD.ObjectInfoManager,r=new CLOUD.FilterManagerIO(n);this.destroy=function(){},this.observerForSceneState=null,this.setObserverForSceneState=function(e){this.observerForSceneState=e},this.setSceneStateHelper=function(e){},this.getFilterActionList=function(){return e},this.clearFilterActionList=function(){e=[]},this.initFilterManager=function(e){i.init(e)},this.reinitFilterManager=function(e){i.reinit(e)},this.clearFilterManager=function(){i.clearData()};var a=!1;this.isStateChanged=function(){return a},this.enableStateChanged=function(){a=!0},this.disableStateChanged=function(){a=!1},this.getIsolateFilterAction=function(){return t},this.setIsolateAction=function(e){t=e,t.apply()},this.getVisibleComponentsBbox=function(){return i.getVisibleComponentsBbox()},this.pushBack=function(n){var r=n.getClassName();"IsolateIdsFA"==r||"IsolateConditionFA"==r?t=n:e.push(n),a=!0,n.applyFilter(i)};var o=function(t){for(var n=0;n<e.length;){t==e[n].getClassName()?e.splice(n,1):n++}};this.showAll=function(){o("VisibleIdsFA"),o("VisibleConditionFA"),i.clearVisible(),i.calculateVisibleComponentsBbox(),this.enableStateChanged()},this.hideAll=function(){var e=new CLOUD.VisibleIdsFA(!1,!1);e.ids=[],this.pushBack(e)},this.getObjectInfoManager=function(){return i},this.getMatchIds=function(e){return i.getMatchIds(e)},this._isVisible=function(e){var t=e.name;return!i.isHidden(t)},this._isTransparent=function(e){var t=e.name;return i.isTransparent(t)},this._isPickable=function(e){var t=e.name;return this.isComponentActive(t)&&!i.isFrozen(t)},this._getOverrideMaterial=function(e){var t=e.name;return i.isFrozen(t)?this._filterImpl.getFrozonMaterial():i.getMaterial(t)},this._getMaterialName=function(e){return this._filterImpl._getMaterialName(e)},this._getMaterialByName=function(e){return this._filterImpl._getMaterialByName(e)},this._hasOverrideMaterial=function(e){var t=e.name;return i.hasOverrideMaterial(t)},this._hasHighPriorityOverrideMaterial=function(e){return this._filterImpl._hasHighPriorityOverrideMaterial(e)},this._isHiddenFileId=function(e){return this._filterImpl._isHiddenFileId(e)},this._isRenderPromotion=function(e){return this._filterImpl._isRenderPromotion(e)},this._isRenderWithBoardline=function(e){return this._filterImpl._isRenderWithBoardline(e)},this._hasHiddenFileIdFilter=function(){return this._filterImpl._hasHiddenFileIdFilter()},this._hasVisibleFilter=function(){return i.hasObjectHidden()},this._hasPickableFilter=function(){return i.hasObjectCantSelected()},this._hasTransparentFilter=function(){return i.hasObjectTransparent()},this._hasOverrideMaterialFilter=function(){return i.hasOverrideMaterial()},this._hasLowPriorityOverride=function(){return this._filterImpl._hasLowPriorityOverride()},this._hasRenderPromotionFilter=function(){return this._filterImpl._hasRenderPromotionFilter()},this._hasRenderWithBoardlineFilter=function(){return this._filterImpl._hasRenderWithBoardlineFilter()},this.saveState=function(){return r.saveState(this)},this.loadState=function(e){r.loadState(e,this)},this.clear=function(){i.resetAll(),a=!0},this.clearAll=function(){return this.enableStateChanged(),this._filterImpl.clearAll()},this.clearIsolate=function(){i.clearIsolates()},this.clearFrozenList=function(){return this.enableStateChanged(),this._filterImpl.clearFrozenList()},this.addToFrozenList=function(e){return this.enableStateChanged(),this._filterImpl.addToFrozenList(e)},this.removeFromFrozenList=function(e){return this.enableStateChanged(),this._filterImpl.removeFromFrozenList(e)},this.setFrozenList=function(e){return this.enableStateChanged(),this._filterImpl.setFrozenList(e)},this.setFrozenConditions=function(e){this.enableStateChanged(),this._filterImpl.setFrozenConditions(e)},this.getFrozenConditions=function(){return this._filterImpl.getFrozenConditions()},this.clearFrozenConditions=function(){this.enableStateChanged(),this._filterImpl.clearFrozenConditions()},this.clearFrozen=function(){this.enableStateChanged(),this.clearFrozenList(),this.clearFrozenConditions()},this.clearAllIdList=function(){return this.enableStateChanged(),this._filterImpl.clearAllIdList()},this.clearIdList=function(e){return this.enableStateChanged(),this._filterImpl.clearIdList(e)},this.addToIdList=function(e,t){return this.enableStateChanged(),this._filterImpl.addToIdList(e,t)},this.removeFromIdList=function(e,t){return this.enableStateChanged(),this._filterImpl.removeFromIdList(e,t)},this.setIdList=function(e,t){return this.enableStateChanged(),this._filterImpl.setIdList(e,t)},this.clearAllOverrideList=function(){o("OverrideIdsFA"),o("OverrideConditionFA"),i.clearMaterial(),this.enableStateChanged()},this.clearOverrideList=function(e){return this.enableStateChanged(),this._filterImpl.clearOverrideList(e)},this.addToOverrideList=function(e,t,n){return this.enableStateChanged(),this._filterImpl.addToOverrideList(e,t,n)},this.removeFromOverrideList=function(e,t){return this.enableStateChanged(),this._filterImpl.removeFromOverrideList(e,t)},this.setOverrideList=function(e,t,n){return this.enableStateChanged(),this._filterImpl.setOverrideList(e,t,n)},this.addToOverrideListByColor=function(e,t){var n=null;if(t){var i=this._filterImpl.getMaterialNameByColor(t);n=this._filterImpl.getMaterialByName(i)}var r=new CLOUD.OverrideIdsFA(!0,n);r.ids=e,this.pushBack(r)},this.addToOverrideListByConditions=function(e,t){var n=null;if(t){var i=this._filterImpl.getMaterialNameByColor(t);n=this._filterImpl.getMaterialByName(i)}var r=new CLOUD.OverrideConditionFA(!0,n);r.conditions=e,this.pushBack(r)},this.addToOverrideListByMaterial=function(e,t){this._filterImpl.addOverrideMaterial(t);var n=new CLOUD.OverrideConditionFA(!0,t);n.conditions=e,this.pushBack(n)},this.addToOverrideListByMaterialAndId=function(e,t){this._filterImpl.addOverrideMaterial(t);var n=new CLOUD.OverrideIdsFA(!0,t);n.ids=e,this.pushBack(n)},this.setOverrideListByColor=function(e,t,n){for(var r=0;r<t.length;r++){var a=this._filterImpl.getMaterialNameByColor(n),o=this._filterImpl.getMaterialByName(a);i.setMaterial(t[r],o)}},this.getVisibleComponentSet=function(e){for(var t={},n=Object.keys(e),i=0;i<n.length;i++)this._isVisible({name:n[i]})&&(t[n[i]]=!0);return t},this.clearAllUserList=function(){return this.enableStateChanged(),this._filterImpl.clearAllUserList()},this.clearUserListByType=function(e){return this.enableStateChanged(),this._filterImpl.clearUserListByType(e)},this.clearUserList=function(e,t){return this.enableStateChanged(),this._filterImpl.clearUserList(e,t)},this.addToUserList=function(e,t,n,i){return this.enableStateChanged(),this._filterImpl.addToUserList(e,t,n,i)},this.removeFromUserList=function(e,t,n){this.enableStateChanged(),this._filterImpl.removeFromUserList(e,t,n)},this.setUserList=function(e,t,n,i){this.enableStateChanged(),this._filterImpl.setUserList(e,t,n,i)},this.isIsolate=function(){var e=i.getObjectsMap();for(var t in e){if(e.hasOwnProperty(t))var n=e[t];for(var r in n){var a=i.isIsolateHide(r);if(a|=i.isIsolateTransparent(r))return!0}}return!1},this.isFiltering=function(){var e=this.filterActionList.length>0;return this.isIsolate()||e},this.getFrozonMaterial=function(){return this._filterImpl.getFrozonMaterial()},this.setIsolateMaterial=function(e){this.enableStateChanged(),this._filterImpl.setIsolateMaterial(e)},this.getIsolateMaterial=function(){return this._filterImpl.getIsolateMaterial()},this.resetIsolateMaterial=function(){this.enableStateChanged(),this._filterImpl.resetIsolateMaterial()},this.clearAllIsolateList=function(){i.clearIsolates()},this.clearIsolation=function(){i.clearIsolates(),t=null,a=!0},this.addToIsolateList=function(e,t){var n="HideOthers"==t,i=new CLOUD.IsolateIdsFA(n);i.ids=e,this.pushBack(i),this.clearFilterActionList()},this.removeFromIsolateList=function(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)},this.setIsolateList=function(e,t){var n=new CLOUD.IsolateIdsFA(t);n.ids=e,this.pushBack(n)},this.removeFromIsolateList=function(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)},this.setIsolateConditions=function(e,t){var n=t==CLOUD.EnumIsolateState.HIDDEN_OTHERS,i=new CLOUD.IsolateConditionFA(n);i.conditions=e,this.pushBack(i),this.clearFilterActionList()},this.getIsolateConditions=function(e){return this._filterImpl.getIsolateConditions(e)},this.clearIsolateConditions=function(e){this.enableStateChanged(),this._filterImpl.clearIsolateConditions(e)},this.clearAllIsolateConditions=function(){this.enableStateChanged(),this._filterImpl.clearAllIsolateConditions()},this.setConditions=function(e,t){if(0==e){i.hideAll();var n=new CLOUD.VisibleConditionFA(!0,!0);n.conditions=t,this.pushBack(n)}3==e&&this._filterImpl.setConditions(e,t)},this.getConditions=function(e){return this._filterImpl.getConditions(e)},this.clearConditions=function(e){this.enableStateChanged(),this._filterImpl.clearConditions(e)},this.clearAllConditions=function(){this.enableStateChanged(),this._filterImpl.clearAllConditions()},this.makeSceneTranslucent=function(){this.enableStateChanged(),this._filterImpl.makeSceneTranslucent()},this.cancelSceneTranslucent=function(){this.enableStateChanged(),this._filterImpl.cancelSceneTranslucent()},this.hideScene=function(){this.enableStateChanged(),this._filterImpl.hideScene()},this.showScene=function(){this.enableStateChanged(),this._filterImpl.showScene()},this.setSceneState=function(e){this.enableStateChanged(),this._filterImpl.setSceneState(e)},this.getSceneState=function(){return this._filterImpl.getSceneState()},this.cancelHidden=function(){this.enableStateChanged(),this._filterImpl.cancelHidden()},this.cancelTranslucent=function(){this.enableStateChanged(),this._filterImpl.cancelTranslucent()},this.hideByIds=function(e){var t=new CLOUD.VisibleIdsFA(!0,!1);t.ids=e,this.pushBack(t)},this.hideByConditions=function(e){var t=new CLOUD.VisibleConditionFA(!0,!1);t.conditions=e,this.pushBack(t)},this.hideOthersByConditions=function(e){var t=new CLOUD.VisibleConditionFA(!1,!1);t.conditions=e,this.pushBack(t)},this.showByIds=function(e){var t=new CLOUD.VisibleIdsFA(!0,!0);t.ids=e,this.pushBack(t)},this.showByConditions=function(e){var t=new CLOUD.VisibleConditionFA(!0,!0);t.conditions=e,this.pushBack(t)},this.makeTranslucentByIds=function(e){var t=new CLOUD.TransparentIdsFA(!0,!1);t.ids=e,this.pushBack(t)},this.makeTranslucentByConditions=function(e){var t=new CLOUD.TransparentConditionFA(!0,!1);t.conditions=e,this.pushBack(t)},this.opaqueByIds=function(e){var t=new CLOUD.TransparentIdsFA(!0,!0);t.ids=e,this.pushBack(t)},this.opaqueByConditions=function(e){var t=new CLOUD.TransparentConditionFA(!0,!0);t.conditions=e,this.pushBack(t)},this.setFrozonMaterial=function(e){this._filterImpl.setFrozonMaterial(e),this.enableStateChanged()},this.makeTranslucentOthersByIds=function(e){var t=new CLOUD.TransparentIdsFA(!1,!1);t.ids=e,this.pushBack(t)},this.opaqueAll=function(){o("TransparentIdsFA"),o("TransparentConditionFA"),i.clearTransparent(),this.enableStateChanged()},this.deactivateByIds=function(e){i.deactivateByIds(e),this.observerForSceneState&&this.observerForSceneState(e)},this.clearInactivatedIdMap=function(){i.clearInactivatedIdMap()},this.getInactivatedIdMap=function(){return i.getInactivatedIdMap()},this.deactivateAll=function(){i.deactivateAll()},this.activateAll=function(){i.activateAll()},this.isComponentActive=function(e){return i.isActive(e)},this.getFilterType=function(){return this._filterImpl.getFilterType()},this._hasOverrideMaterialForWireFrame=function(e){var t=e.name;return i.hasOverrideMaterialForWireFrame(t)},this._hasOverrideMaterialFilterForWireFrame=function(){return i.hasOverrideMaterialForWireFrame()},this._getOverrideMaterialForWireFrame=function(e){return i.getWireFrameMaterial(e.name)},this._getOverrideWireFrameMaterial=function(e){return i.getWireFrameMaterial(e.name)},this.addToOverrideListForWireFrameByColor=function(e,t){var n=null;if(t){var i=this._filterImpl.getMaterialNameByColor(t);n=this._filterImpl.getMaterialByName(i)}var r=new CLOUD.OverrideIdsForWireFrameFA(!0,n);r.ids=e,this.pushBack(r)},this.addToOverrideListForWireFrameByConditions=function(e,t){var n=null;if(t){var i=this._filterImpl.getMaterialNameByColor(t);n=this._filterImpl.getMaterialByName(i)}var r=new CLOUD.OverrideConditionForWireFrameFA(!0,n);r.conditions=e,this.pushBack(r)},this.needUpdateBoxAfterExplode=function(){this.getObjectInfoManager().needUpdateBoxAfterExplode()}},CLOUD.FilterManager2=function(){var e,t,n=CLOUD.EnumIdBasedType,i=CLOUD.EnumSceneState,r=CLOUD.FilterResultMode,a={IDFILTER_OFFSET:0,FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6,IDFILTER_ENDOFFSET:6,ISOLATEFILTER_OFFSET:7,ISOLATE_HIDDEN:7,ISOLATE_HIDDEN_OTHERS:8,ISOLATE_TRANSLUCENT:9,ISOLATE_TRANSLUCENT_OTHERS:10,ISOLATEFILTER_ENDOFFSET:10,USERFILTER_OFFSET:11,USER_HIDDEN:11,USER_OVERRIDE:12,USERFILTER_ENDOFFSET:12,CONDITIONFILTER_OFFSET:13,CONDITION_HIDDEN_OTHERS:13,CONDITION_TRANSLUCENT_OTHERS:14,CONDITION_OVERRIDE:15,CONDITION_BORDERLINE:16,CONDITIONFILTER_ENDOFFSET:16,ISOLATECONDITIONFILTER_OFFSET:17,ISOLATE_CONDITION_HIDDEN:17,ISOLATE_CONDITION_HIDDEN_OTHERS:18,ISOLATE_CONDITION_TRANSLUCENT:19,ISOLATE_CONDITION_TRANSLUCENT_OTHERS:20,ISOLATECONDITIONFILTER_ENDOFFSET:20,FROZENFILTER:21,FROZENCONDITIONFILTER:22,OVERRIDEFILTER:23,BASICFILTER_COUNT:23},o=new CLOUD.CompoundFilter(!0),s=new CLOUD.CompoundFilter(!0),l=new CLOUD.CompoundFilter(!1),u=new CLOUD.CompoundFilter(!0),c=new CLOUD.CompoundFilter(!1),h=new CLOUD.CompoundFilter(!1),d=new CLOUD.CompoundFilter(!1),f=[],p=i.DISABLED,m=new CLOUD.MaterialSelector;!function(){f[a.FILE_VISIBLE]=new CLOUD.FileIdFilter(a.FILE_VISIBLE,"FILE_VISIBLE"),f[a.FILE_HIDDEN]=new CLOUD.FileIdFilter(a.FILE_HIDDEN,"FILE_HIDDEN"),f[a.VISIBLE]=new CLOUD.GeneralIdFilter(a.VISIBLE,"VISIBLE"),f[a.HIDDEN]=new CLOUD.GeneralIdFilter(a.HIDDEN,"HIDDEN"),f[a.TRANSLUCENT]=new CLOUD.GeneralIdFilter(a.TRANSLUCENT,"TRANSLUCENT"),f[a.TRANSLUCENT_OTHERS]=new CLOUD.GeneralIdFilter(a.TRANSLUCENT_OTHERS,"TRANSLUCENT_OTHERS"),f[a.RENDER_PROMOTION]=new CLOUD.GeneralIdFilter(a.RENDER_PROMOTION,"RENDER_PROMOTION"),f[a.ISOLATE_HIDDEN]=new CLOUD.GeneralIdFilter(a.ISOLATE_HIDDEN,"ISOLATE_HIDDEN"),f[a.ISOLATE_HIDDEN_OTHERS]=new CLOUD.GeneralIdFilter(a.ISOLATE_HIDDEN_OTHERS,"ISOLATE_HIDDEN_OTHERS"),f[a.ISOLATE_TRANSLUCENT]=new CLOUD.GeneralIdFilter(a.ISOLATE_TRANSLUCENT,"ISOLATE_TRANSLUCENT"),f[a.ISOLATE_TRANSLUCENT_OTHERS]=new CLOUD.GeneralIdFilter(a.ISOLATE_TRANSLUCENT_OTHERS,"ISOLATE_TRANSLUCENT_OTHERS"),f[a.USER_HIDDEN]=new CLOUD.UserListFilter(a.USER_HIDDEN,"USER_HIDDEN"),f[a.USER_OVERRIDE]=new CLOUD.UserListFilter(a.USER_OVERRIDE,"USER_OVERRIDE"),f[a.CONDITION_HIDDEN_OTHERS]=new CLOUD.ConditionFilter(a.CONDITION_HIDDEN_OTHERS,"CONDITION_HIDDEN_OTHERS"),f[a.CONDITION_TRANSLUCENT_OTHERS]=new CLOUD.ConditionFilter(a.CONDITION_TRANSLUCENT_OTHERS,"CONDITION_TRANSLUCENT_OTHERS"),f[a.CONDITION_OVERRIDE]=new CLOUD.MultiConditionFilter(a.CONDITION_OVERRIDE,"CONDITION_OVERRIDE"),f[a.CONDITION_BORDERLINE]=new CLOUD.ConditionFilter(a.CONDITION_BORDERLINE,"CONDITION_BORDERLINE"),f[a.ISOLATE_CONDITION_HIDDEN]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_HIDDEN,"ISOLATE_CONDITION_HIDDEN"),f[a.ISOLATE_CONDITION_HIDDEN_OTHERS]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_HIDDEN_OTHERS,"ISOLATE_CONDITION_HIDDEN_OTHERS"),f[a.ISOLATE_CONDITION_TRANSLUCENT]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_TRANSLUCENT,"ISOLATE_CONDITION_TRANSLUCENT"),f[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS,"ISOLATE_CONDITION_TRANSLUCENT_OTHERS"),t=new CLOUD.GeneralIdFilter(a.FROZENFILTER,"FROZENFILTER"),f[a.FROZENCONDITIONFILTER]=new CLOUD.ConditionFilter(a.FROZENCONDITIONFILTER,"FROZENCONDITIONFILTER"),f[a.FROZENFILTER]=t,e=new CLOUD.OverrideListFilter(a.OVERRIDEFILTER,"OVERRIDEFILTER"),f[a.OVERRIDEFILTER]=e;var n,i={};i[a.HIDDEN]=r.MATCH_RETURN_FALSE,i[a.VISIBLE]=r.NOMATCH_RETURN_FALSE,i[a.USER_HIDDEN]=r.MATCH_RETURN_FALSE,i[a.CONDITION_HIDDEN_OTHERS]=r.NOMATCH_RETURN_FALSE,i[a.ISOLATE_HIDDEN]=r.MATCH_RETURN_FALSE,i[a.ISOLATE_HIDDEN_OTHERS]=r.NOMATCH_RETURN_FALSE,i[a.ISOLATE_CONDITION_HIDDEN_OTHERS]=r.NOMATCH_RETURN_FALSE,o.setFilterMode(i);for(n in i)f[n].registerToCompoundFilter(o);var p={};p[a.FROZENFILTER]=r.MATCH_RETURN_FALSE,p[a.FROZENCONDITIONFILTER]=r.MATCH_RETURN_FALSE,p[a.TRANSLUCENT]=r.MATCH_RETURN_FALSE,p[a.TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,p[a.CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,p[a.ISOLATE_TRANSLUCENT]=r.MATCH_RETURN_FALSE,p[a.ISOLATE_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,p[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,u.setFilterMode(p);for(n in p)f[n].registerToCompoundFilter(u);var m={};m[a.ISOLATE_TRANSLUCENT]=r.MATCH_RETURN_TRUE,m[a.ISOLATE_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.TRANSLUCENT]=r.MATCH_RETURN_TRUE,m[a.TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.OVERRIDEFILTER]=r.MATCH_RETURN_TRUE,m[a.USER_OVERRIDE]=r.MATCH_RETURN_TRUE,m[a.CONDITION_OVERRIDE]=r.MATCH_RETURN_TRUE,m[a.FROZENFILTER]=r.MATCH_RETURN_TRUE,m[a.FROZENCONDITIONFILTER]=r.MATCH_RETURN_TRUE;var g={};g[a.ISOLATE_TRANSLUCENT]=5,g[a.ISOLATE_TRANSLUCENT_OTHERS]=5,g[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=5,g[a.CONDITION_TRANSLUCENT_OTHERS]=5,g[a.TRANSLUCENT]=5,g[a.TRANSLUCENT_OTHERS]=5,g[a.OVERRIDEFILTER]=0,g[a.USER_OVERRIDE]=0,g[a.CONDITION_OVERRIDE]=0,g[a.FROZENFILTER]=3,g[a.FROZENCONDITIONFILTER]=3,s.setFilterMode(m),s.setFilterPriority(g);for(n in m)f[n].registerToCompoundFilter(s);var v={};v[a.OVERRIDEFILTER]=r.MATCH_RETURN_TRUE,v[a.USER_OVERRIDE]=r.MATCH_RETURN_TRUE,v[a.CONDITION_OVERRIDE]=r.MATCH_RETURN_TRUE,v[a.CONDITION_TRANSLUCENT_OTHERS]=r.MATCH_RETURN_TRUE,l.setFilterMode(v);for(n in v)f[n].registerToCompoundFilter(l);var y={};y[a.FILE_VISIBLE]=r.NOMATCH_RETURN_TRUE,y[a.FILE_HIDDEN]=r.MATCH_RETURN_TRUE,c.setFilterMode(y);for(n in y)f[n].registerToCompoundFilter(c);var E={};E[a.RENDER_PROMOTION]=r.MATCH_RETURN_TRUE,E[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.MATCH_RETURN_TRUE,h.setFilterMode(E);for(n in E)f[n].registerToCompoundFilter(h);var b={};b[a.CONDITION_BORDERLINE]=r.MATCH_RETURN_TRUE,d.setFilterMode(b);for(n in b)f[n].registerToCompoundFilter(d)}(),this.getMaterialSelector=function(){return m},this.getBasicFilterList=function(){return f},this.getFilterType=function(){return a},this.saveState=function(){for(var e,t={},n=0,i=f.length;n<i;n++)e=f[n],t[e.getName()]=e.getAll();return t.sceneState=this.getSceneState(),t.version="0.4",t},this.loadState=function(e){if(this.clearAll(),e.hasOwnProperty("version")){if("0.4"==e.version){for(var t={},n=0,i=f.length;n<i;n++)t[f[n].getName()]=n;for(var r in e)"sceneState"!==r&&"version"!==r&&(t.hasOwnProperty(r)?f[t[r]].setByData(e[r]):CLOUD.Logger.warn("Warning: Not supported filter '"+r+"'"))}}else for(var o in e)"sceneState"!==o&&(o<2?f[o].setByData(e[o]):o>2?o<a.BASICFILTER_COUNT+2&&f[o-1].setByData(e[o]):2==o&&CLOUD.Logger.warn("Warning: Old version filter data! The selection state is out of the filter, can not restore it."));this.setSceneState(e.sceneState)},this.clear=function(){for(var e=0,t=f.length;e<t;e++){var n=f[e].getType();n!==a.FROZENFILTER&&n!==a.CONDITION_BORDERLINE&&f[e].clearAll()}this.setSceneState(i.DISABLED)},this.clearAll=function(){for(var e=0,t=f.length;e<t;e++)f[e].clearAll();this.setSceneState(i.DISABLED)},this.clearIsolate=function(){this.clearAllIsolateList(),this.clearAllIsolateConditions()},this.clearFrozenList=function(){t.clearAll()},this.addToFrozenList=function(e){t.add(e)},this.removeFromFrozenList=function(e){t.remove(e)},this.setFrozenList=function(e){this.clearFrozenList(),this.addToFrozenList(e)},this.setFrozenConditions=function(e){f[a.FROZENCONDITIONFILTER].setByData(e)},this.getFrozenConditions=function(){return f[a.FROZENCONDITIONFILTER].getAll()},this.clearFrozenConditions=function(){f[a.FROZENCONDITIONFILTER].clear()},this.clearFrozen=function(){this.clearFrozenList(),this.clearFrozenConditions()},this.clearAllIdList=function(){var e;for(e=a.IDFILTER_OFFSET;e<=a.IDFILTER_ENDOFFSET;e++)f[e].clearAll()},this.clearIdList=function(e){var t=a.IDFILTER_OFFSET+e;t>=a.IDFILTER_OFFSET&&t<=a.IDFILTER_ENDOFFSET&&f[t].clear()},this.addToIdList=function(e,t){var n=a.IDFILTER_OFFSET+e;n>=a.IDFILTER_OFFSET&&n<=a.IDFILTER_ENDOFFSET&&f[n].add(t)},this.removeFromIdList=function(e,t){var n=a.IDFILTER_OFFSET+e;n>=a.IDFILTER_OFFSET&&n<=a.IDFILTER_ENDOFFSET&&f[n].remove(t)},this.setIdList=function(e,t){this.clearIdList(e),this.addToIdList(e,t)},this.clearAllOverrideList=function(){e.clearAll()},this.clearOverrideList=function(t){e.clear(t)},this.addToOverrideList=function(t,n,i){n&&n.length>0&&(m.has(i)||(i=m.getDefaultMaterialName()),e.add(t,n,i))},this.removeFromOverrideList=function(t,n){e.remove(t,n)},this.setOverrideList=function(e,t,n){this.clearOverrideList(e),this.addToOverrideList(e,t,n)},this.addToOverrideListByColor=function(t,n,i){var r=m.add(i);e.add(t,n,r)},this.setOverrideListByColor=function(e,t,n){this.clearOverrideList(e),this.addToOverrideListByColor(e,t,n)},this.clearAllUserList=function(){var e;for(e=a.USERFILTER_OFFSET;e<=a.USERFILTER_ENDOFFSET;e++)f[e].clearAll()},this.clearUserListByType=function(e){var t=a.USERFILTER_OFFSET+e;t>=a.USERFILTER_OFFSET&&t<=a.USERFILTER_ENDOFFSET&&f[t].clearAll()},this.clearUserList=function(e,t){var n=a.USERFILTER_OFFSET+e;n>=a.USERFILTER_OFFSET&&n<=a.USERFILTER_ENDOFFSET&&f[n].clear(t)},this.addToUserList=function(e,t,n,i){var r=a.USERFILTER_OFFSET+e;r>=a.USERFILTER_OFFSET&&r<=a.USERFILTER_ENDOFFSET&&f[r].add(t,n,i)},this.removeFromUserList=function(e,t,n){var i=a.USERFILTER_OFFSET+e;i>=a.USERFILTER_OFFSET&&i<=a.USERFILTER_ENDOFFSET&&f[i].remove(t,n)},this.setUserList=function(e,t,n,i){this.clearUserList(e,t),this.addToUserList(e,t,n,i)},this.isIsolate=function(){var e;for(e=a.ISOLATEFILTER_OFFSET;e<=a.ISOLATEFILTER_ENDOFFSET;e++)if(!f[e].isEmpty())return!0;return!1},this.isFiltering=function(){return!!this.isIsolate()||!(f[a.HIDDEN].isEmpty()&&f[a.VISIBLE].isEmpty()&&f[a.TRANSLUCENT].isEmpty()&&f[a.TRANSLUCENT_OTHERS].isEmpty()&&this.getSceneState()===i.DISABLED)},this.setFrozonMaterial=function(e){m.setFrozonMaterial(e)},this.getFrozonMaterial=function(){return m.getFrozonMaterial()},this.setSelectedMaterial=function(e){m.setSelectedMaterial(e)},this.getSelectedMaterial=function(){return m.getSelectedMaterial()},this.setIsolateMaterial=function(e){m.setIsolateMaterial(e)},this.getIsolateMaterial=function(){return m.getIsolateMaterial()},this.resetIsolateMaterial=function(){m.resetIsolateMaterial()},this.clearAllIsolateList=function(){var e;for(e=a.ISOLATEFILTER_OFFSET;e<=a.ISOLATEFILTER_ENDOFFSET;e++)f[e].clear()},this.clearIsolateList=function(e){var t=a.ISOLATEFILTER_OFFSET+e;t>=a.ISOLATEFILTER_OFFSET&&t<=a.ISOLATEFILTER_ENDOFFSET&&f[t].clear()},this.addToIsolateList=function(e,t){var n=a.ISOLATEFILTER_OFFSET+e;n>=a.ISOLATEFILTER_OFFSET&&n<=a.ISOLATEFILTER_ENDOFFSET&&f[n].add(t)},this.removeFromIsolateList=function(e,t){var n=a.ISOLATEFILTER_OFFSET+e;n>=a.ISOLATEFILTER_OFFSET&&n<=a.ISOLATEFILTER_ENDOFFSET&&f[n].remove(t)},this.setIsolateList=function(e,t){this.clearIsolateList(e),this.addToIsolateList(e,t)},this.setIsolateConditions=function(e,t){var n=a.ISOLATECONDITIONFILTER_OFFSET+t;n>=a.ISOLATECONDITIONFILTER_OFFSET&&n<=a.ISOLATECONDITIONFILTER_ENDOFFSET&&f[n].setByData(e)},this.getIsolateConditions=function(e){var t=null,n=a.ISOLATECONDITIONFILTER_OFFSET+e;return n>=a.ISOLATECONDITIONFILTER_OFFSET&&n<=a.ISOLATECONDITIONFILTER_ENDOFFSET&&(t=f[n].getAll()),t},this.clearIsolateConditions=function(e){var t=a.ISOLATECONDITIONFILTER_OFFSET+e;t>=a.ISOLATECONDITIONFILTER_OFFSET&&t<=a.ISOLATECONDITIONFILTER_ENDOFFSET&&f[t].clear()},this.clearAllIsolateConditions=function(){var e;for(e=a.ISOLATECONDITIONFILTER_OFFSET;e<=a.ISOLATECONDITIONFILTER_ENDOFFSET;e++)f[e].clearAll()},this.setConditions=function(e,t){var n=a.CONDITIONFILTER_OFFSET+e;n>=a.CONDITIONFILTER_OFFSET&&n<=a.CONDITIONFILTER_ENDOFFSET&&f[n].setByData(t)},this.getConditions=function(e){var t=null,n=a.CONDITIONFILTER_OFFSET+e;return n>=a.CONDITIONFILTER_OFFSET&&n<=a.CONDITIONFILTER_ENDOFFSET&&(t=f[n].get()),t},this.clearConditions=function(e){var t=a.CONDITIONFILTER_OFFSET+e;t>=a.CONDITIONFILTER_OFFSET&&t<=a.CONDITIONFILTER_ENDOFFSET&&f[t].clearAll()},this.clearAllConditions=function(){var e;for(e=a.CONDITIONFILTER_OFFSET;e<=a.CONDITIONFILTER_ENDOFFSET;e++)f[e].clear()},this.makeSceneTranslucent=function(){this.setSceneState(i.TRANSLUCENT)},this.cancelSceneTranslucent=function(){this.setSceneState(i.DISABLED)},this.hideScene=function(){this.setSceneState(i.HIDDEN)},this.showScene=function(){this.setSceneState(i.DISABLED)},this.setSceneState=function(e){p=e},this.getSceneState=function(){return p},this.cancelTranslucent=function(){this.clearIdList(n.TRANSLUCENT),this.clearIdList(n.TRANSLUCENT_OTHERS)},this._addIdsToFilter=function(e,t){var n=a.IDFILTER_OFFSET+e;n>=a.IDFILTER_OFFSET&&n<=a.IDFILTER_ENDOFFSET&&f[n].add(t)},this.hideByIds=function(e){this._addIdsToFilter(n.HIDDEN,e)},this.showByIds=function(e){this._addIdsToFilter(n.VISIBLE,e)},this.makeTranslucentByIds=function(e){this._addIdsToFilter(n.TRANSLUCENT,e)},this.makeTranslucentOthersByIds=function(e){
this._addIdsToFilter(n.TRANSLUCENT_OTHERS,e)},this._isVisible=function(e){return this.getSceneState()!==i.HIDDEN&&o.apply(e)},this._isSelectable=function(e){return this.getSceneState()!==i.TRANSLUCENT&&u.apply(e,this.getSceneState())},this.getMaterialNameByColor=function(e){return m.getMaterialNameByColor(e)},this.addOverrideMaterial=function(e){m.addOverrideMaterial(e)},this.getMaterialByName=function(e){return m.get(e)},this._getOverrideMaterial=function(e){if(this.getSceneState()===i.TRANSLUCENT)return m.get("scene");var t=s.getApplyFilterId(e),n=null,r="";switch(t){case a.ISOLATE_TRANSLUCENT:case a.ISOLATE_TRANSLUCENT_OTHERS:case a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:n=this.getIsolateMaterial();break;case a.CONDITION_TRANSLUCENT_OTHERS:case a.TRANSLUCENT:case a.TRANSLUCENT_OTHERS:n=m.get("scene");break;case a.FROZENFILTER:case a.FROZENCONDITIONFILTER:break;case a.OVERRIDEFILTER:case a.USER_OVERRIDE:case a.CONDITION_OVERRIDE:var o=f[t].getMatchItem(e);r=o.hasOwnProperty("color")?m.getMaterialNameByColor(o.color):o.material?o.material:o}return n||""===r||(m.has(r)||(r=m.getDefaultMaterialName()),n=m.get(r)),n},this._getMaterialName=function(e){if(this.getSceneState()===i.TRANSLUCENT)return"scene";var t=s.getApplyFilterId(e),n=null,r="";switch(t){case a.ISOLATE_TRANSLUCENT:case a.ISOLATE_TRANSLUCENT_OTHERS:case a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:n=this.getIsolateMaterial(),r=n.name;break;case a.CONDITION_TRANSLUCENT_OTHERS:case a.TRANSLUCENT:case a.TRANSLUCENT_OTHERS:r="scene";break;case a.FROZENFILTER:case a.FROZENCONDITIONFILTER:break;case a.OVERRIDEFILTER:case a.USER_OVERRIDE:case a.CONDITION_OVERRIDE:var o=f[t].getMatchItem(e);r=o.hasOwnProperty("color")?m.getMaterialNameByColor(o.color):o.material?o.material:o}return r},this._getMaterialByName=function(e){return"isolate"==e?m.getIsolateMaterial():"frozen"==e||"scene"==e?m.getFrozonMaterial():"selected"==e?m.getSelectedMaterial():m.get(e)},this._hasHighPriorityOverrideMaterial=function(e){return this.getSceneState()===i.TRANSLUCENT||l.apply(e)},this._hasOverrideMaterial=function(e){return this.getSceneState()===i.TRANSLUCENT||l.apply(e)||s.apply(e)},this._isHiddenFileId=function(e){return c.apply(e)},this._hasHiddenFileIdFilter=function(){return!c.isEmpty()},this._hasVisibleFilter=function(){return this.getSceneState()===i.HIDDEN||!o.isEmpty()},this._hasSelectableFilter=function(){return this.getSceneState()===i.TRANSLUCENT||!u.isEmpty()},this._hasOverrideMaterialFilter=function(){return this.getSceneState()===i.TRANSLUCENT||!s.isEmpty()},this._hasLowPriorityOverride=function(){return s.hasFilterNotIn(l)},this._isRenderPromotion=function(e){return h.apply(e)},this._hasRenderPromotionFilter=function(){return!h.isEmpty()},this._isRenderWithBoardline=function(e){return d.apply(e)},this._hasRenderWithBoardlineFilter=function(){return!d.isEmpty()}},CLOUD.BasicFilter=function(e,t){this._type=e,this._name=t,this._enabled=!1,this._items={},this._relatedCompoundFilterList=[]},CLOUD.BasicFilter.prototype.getType=function(){return this._type},CLOUD.BasicFilter.prototype.getName=function(){return this._name},CLOUD.BasicFilter.prototype.get=function(){return this._items},CLOUD.BasicFilter.prototype.getAll=function(){return this._items},CLOUD.BasicFilter.prototype.clearAll=function(){var e=this;e._items={},e._enabled&&(e._enabled=!1,e.enableStateChanged())},CLOUD.BasicFilter.prototype.clear=function(){this.clearAll()},CLOUD.BasicFilter.prototype.isEmpty=function(){return!this._enabled},CLOUD.BasicFilter.prototype.forceEnable=function(){this._enabled||(this._enabled=!0,this.enableStateChanged())},CLOUD.BasicFilter.prototype.setByData=function(e){var t=this;!function(e){if(null==e)return!0;if("object"!==(void 0===e?"undefined":_typeof(e)))return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(e)?(t._items=e,t._enabled||(t._enabled=!0,t.enableStateChanged())):(t._items={},t._enabled&&(t._enabled=!1,t.enableStateChanged()))},CLOUD.BasicFilter.prototype.match=function(e){return!1},CLOUD.BasicFilter.prototype.registerToCompoundFilter=function(e){this._relatedCompoundFilterList.push(e)},CLOUD.BasicFilter.prototype.enableStateChanged=function(){for(var e=this,t=0,n=e._relatedCompoundFilterList.length;t<n;t++)e._enabled?e._relatedCompoundFilterList[t].addBaseFilter(e):e._relatedCompoundFilterList[t].removeBaseFilter(e)},CLOUD.BasicIdFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.BasicIdFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.BasicIdFilter.prototype.constructor=CLOUD.BasicIdFilter,CLOUD.BasicIdFilter.prototype.add=function(e){var t=this,n=t._items;if(e&&e.length>0){for(var i=0,r=e.length;i<r;++i)n[e[i]]=!0;t._enabled||(t._enabled=!0,t.enableStateChanged())}},CLOUD.BasicIdFilter.prototype.remove=function(e){var t=this,n=t._items;if(e&&e.length>0){for(var i=0,r=e.length;i<r;++i){var a=e[i];n.hasOwnProperty(a)&&delete n[a]}0===n.length&&t._enabled&&(t._enabled=!1,t.enableStateChanged())}},CLOUD.ListFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.ListFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.ListFilter.prototype.constructor=CLOUD.ListFilter,CLOUD.ListFilter.prototype.remove=function(e,t){var n=this,i=n._items[e];if(i&&t&&t.length>0){for(var r=0,a=t.length;r<a;++r){var o=t[r];i.hasOwnProperty(o)&&delete i[o]}CLOUD.Utils.isEmptyObject(n._items)&&n._enabled&&(n._enabled=!1,n.enableStateChanged())}},CLOUD.ListFilter.prototype.add=function(e,t,n){var i=this,r=i._items,a=r[e];if(t&&t.length>0){void 0===n&&(n=!0),a||(a=r[e]={});for(var o=0,s=t.length;o<s;++o)a[t[o]]=n;i._enabled||(i._enabled=!0,i.enableStateChanged())}},CLOUD.ListFilter.prototype.clear=function(e){var t=this,n=t._items;n.hasOwnProperty(e)&&(delete n[e],CLOUD.Utils.isEmptyObject(n)&&t._enabled&&(t._enabled=!1,t.enableStateChanged()))},CLOUD.UserListFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.UserListFilter.prototype=Object.create(CLOUD.ListFilter.prototype),CLOUD.UserListFilter.prototype.constructor=CLOUD.UserListFilter;CLOUD.UserListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},CLOUD.UserListFilter.prototype.getMatchItem=function(e){var t=this._items,n=e.userData;if(n)for(var i in t){var r=t[i],a=n[i];if(a&&void 0!==r[a])return r[a]}return null},CLOUD.OverrideListFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.OverrideListFilter.prototype=Object.create(CLOUD.ListFilter.prototype),CLOUD.OverrideListFilter.prototype.constructor=CLOUD.OverrideListFilter,CLOUD.OverrideListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},CLOUD.OverrideListFilter.prototype.getMatchItem=function(e){var t=this._items,n=e.name;for(var i in t){var r=t[i];if(r[n])return r[n]}return null},CLOUD.ConditionFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.ConditionFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.ConditionFilter.prototype.constructor=CLOUD.ConditionFilter,CLOUD.ConditionFilter.prototype.match=function(e){var t=e.userData;return!!t&&function(e,t){for(var n,i=0,r=e.length;i<r;++i){n=!0;var a=e[i];for(var o in a){if(!(a[o]instanceof Array)&&t[o]!=a[o]){n=!1;break}if(a[o]instanceof Array&&-1==a[o].indexOf(t[o])){n=!1;break}}if(n)return!0}return!1}(this._items,t)},CLOUD.MultiConditionFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.MultiConditionFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.MultiConditionFilter.prototype.constructor=CLOUD.MultiConditionFilter,CLOUD.MultiConditionFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},CLOUD.MultiConditionFilter.prototype.getMatchItem=function(e){var t,n=this._items,i=e.userData;if(i)for(var r=n.length,a=0;a<r;++a){var o=n[a],s=o.condition;t=!0;for(var l in s)if(s[l]!=i[l]){t=!1;break}if(t)return o}return null},CLOUD.FileIdFilter=function(e,t){CLOUD.BasicIdFilter.call(this,e,t)},CLOUD.FileIdFilter.prototype=Object.create(CLOUD.BasicIdFilter.prototype),CLOUD.FileIdFilter.prototype.constructor=CLOUD.FileIdFilter,CLOUD.FileIdFilter.prototype.match=function(e){var t=e.name;if(t){var n=t.indexOf(".");if(-1!==n){var i=t.substring(0,n);return!!this._items[i]}}var r=e.userData;if(r){var i=r.sceneId;if(i)return!!this._items[i]}return!1},CLOUD.GeneralIdFilter=function(e,t){CLOUD.BasicIdFilter.call(this,e,t)},CLOUD.GeneralIdFilter.prototype=Object.create(CLOUD.BasicIdFilter.prototype),CLOUD.GeneralIdFilter.prototype.constructor=CLOUD.GeneralIdFilter,CLOUD.GeneralIdFilter.prototype.match=function(e){return!!this._items[e.name]},CLOUD.FilterResultMode={MATCH_RETURN_TRUE:0,MATCH_RETURN_FALSE:1,NOMATCH_RETURN_TRUE:2,NOMATCH_RETURN_FALSE:3},CLOUD.CompoundFilter=function(e){this._activeFilterList=[],this._filterResultModes={},this._defaultRetValue=e,this._filterPriority=null},CLOUD.CompoundFilter.prototype.setFilterMode=function(e){this._filterResultModes=e},CLOUD.CompoundFilter.prototype.setFilterPriority=function(e){this._filterPriority=e},CLOUD.CompoundFilter.prototype.addBaseFilter=function(e){var t=this._activeFilterList,n=t.indexOf(e);if(null===this._filterPriority)-1===n?t.push(e):n!==t.length-1&&(t.splice(n,1),t.push(e));else if(0===t.length)t.push(e);else{-1!==n&&n!==t.length-1&&t.splice(n,1);for(var i=this._filterPriority[e.getType()],r=0,a=t.length;r<a;r++)if(this._filterPriority[t[r].getType()]>i){t.splice(r,0,e);break}r===a&&t.push(e)}},CLOUD.CompoundFilter.prototype.removeBaseFilter=function(e){var t=this._activeFilterList.indexOf(e);-1!==t&&this._activeFilterList.splice(t,1)},CLOUD.CompoundFilter.prototype.isEmpty=function(){return 0===this._activeFilterList.length},CLOUD.CompoundFilter.prototype.hasFilterNotIn=function(e){for(var t=this._activeFilterList,n=t.length-1;n>=0;n--){var i=t[n];if(void 0===e._filterResultModes[i.getType()])return!0}return!1},CLOUD.CompoundFilter.prototype.apply=function(e){for(var t,n=this,i=CLOUD.FilterResultMode,r=n._activeFilterList.length-1;r>=0;r--)switch(t=n._activeFilterList[r],n._filterResultModes[t.getType()]){case i.MATCH_RETURN_TRUE:if(t.match(e))return!0;break;case i.MATCH_RETURN_FALSE:if(t.match(e))return!1;break;case i.NOMATCH_RETURN_TRUE:if(!t.match(e))return!0;break;case i.NOMATCH_RETURN_FALSE:if(!t.match(e))return!1}return n._defaultRetValue},CLOUD.CompoundFilter.prototype.getApplyFilterId=function(e){for(var t,n=this,i=CLOUD.FilterResultMode,r=n._activeFilterList.length-1;r>=0;r--)switch(t=n._activeFilterList[r],n._filterResultModes[t.getType()]){case i.MATCH_RETURN_TRUE:case i.MATCH_RETURN_FALSE:if(t.match(e))return t.getType();break;case i.NOMATCH_RETURN_TRUE:case i.NOMATCH_RETURN_FALSE:if(!t.match(e))return t.getType()}return-1},CLOUD.FilterAction=function(){this.className="FilterAction"},CLOUD.FilterAction.prototype.getClassName=function(){return this.className},CLOUD.FilterAction.prototype.applyFilter=function(e){},CLOUD.IdsFilterAction=function(){CLOUD.FilterAction.call(this),this.className="IdsFilterAction",this.ids=[]},CLOUD.IdsFilterAction.prototype=Object.create(CLOUD.FilterAction.prototype),CLOUD.IdsFilterAction.prototype.arrayToMap=function(e){for(var t={},n=0;n<e.length;n++){var i=e[n];t[i]=i}return t},CLOUD.IdsFilterAction.prototype.constructor=CLOUD.IdsFilterAction,CLOUD.VisibleIdsFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="VisibleIdsFA",this.flag=e,this.isVisible=t},CLOUD.IdsFilterAction.prototype.setIds=function(e){this.ids=e},CLOUD.VisibleIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.VisibleIdsFA.prototype.constructor=CLOUD.VisibleIdsFA,CLOUD.VisibleIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.setVisible(this.ids,this.isVisible,this.flag),e.calculateVisibleComponentsBbox()):console.warn("Ids should be type of array.")},CLOUD.OverrideIdsFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="OverrideIdsFA",this.flag=e,this.material=t},CLOUD.OverrideIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.OverrideIdsFA.prototype.constructor=CLOUD.OverrideIdsFA,CLOUD.OverrideIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},CLOUD.OverrideIdsForWireFrameFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="OverrideIdsForWireFrameFA",this.flag=e,this.material=t},CLOUD.OverrideIdsForWireFrameFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.OverrideIdsForWireFrameFA.prototype.constructor=CLOUD.OverrideIdsForWireFrameFA,CLOUD.OverrideIdsForWireFrameFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setWireFrameMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},CLOUD.IsolateIdsFA=function(e){CLOUD.IdsFilterAction.call(this),this.className="IsolateIdsFA",this.isolateHide=e},CLOUD.IsolateIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.IsolateIdsFA.prototype.constructor=CLOUD.IsolateIdsFA,CLOUD.IsolateIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.clearIsolates(),this.isolateHide?(e.setIsolateHide(this.ids,!0,!1),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(this.ids,!0,!1)):console.warn("Ids should be type of array.")},CLOUD.TransparentIdsFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="TransparentIdsFA",this.flag=e,this.isOpaque=t},CLOUD.TransparentIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.TransparentIdsFA.prototype.constructor=CLOUD.TransparentIdsFA,CLOUD.TransparentIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setTransparent(this.ids,!this.isOpaque,this.flag):console.warn("Ids should be type of array.")},CLOUD.ConditionFilterAction=function(){CLOUD.FilterAction.call(this),this.className="ConditionFilterAction",this.conditions=null},CLOUD.ConditionFilterAction.prototype=Object.create(CLOUD.FilterAction.prototype),CLOUD.ConditionFilterAction.prototype.constructor=CLOUD.ConditionFilterAction,CLOUD.VisibleConditionFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="VisibleConditionFA",this.flag=e,this.isVisible=t},CLOUD.VisibleConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.VisibleConditionFA.prototype.constructor=CLOUD.VisibleConditionFA,CLOUD.VisibleConditionFA.prototype.applyFilter=function(e){var t=this,n=function(n,i){t.flag==i&&(e.setVisible(n,t.isVisible),n=null)};this.conditions instanceof Array?(e.matchConditions(this.conditions,n),e.calculateVisibleComponentsBbox()):console.warn("Conditions should be type of array.")},CLOUD.OverrideConditionFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="OverrideConditionFA",this.flag=e,this.material=t},CLOUD.OverrideConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.OverrideConditionFA.prototype.constructor=CLOUD.OverrideConditionFA,CLOUD.OverrideConditionFA.prototype.applyFilter=function(e,t){var n=this,i=function(t,i){n.flag==i&&(e.setMaterial(t,n.material),t=null)};this.conditions instanceof Array?e.matchConditions(this.conditions,i):console.warn("Conditions should be type of array.")},CLOUD.OverrideConditionForWireFrameFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="OverrideConditionForWireFrameFA",this.flag=e,this.material=t},CLOUD.OverrideConditionForWireFrameFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.OverrideConditionForWireFrameFA.prototype.constructor=CLOUD.OverrideConditionForWireFrameFA,CLOUD.OverrideConditionForWireFrameFA.prototype.applyFilter=function(e,t){var n=this,i=function(t,i){n.flag==i&&(e.setWireFrameMaterial(t,n.material),t=null)};this.conditions instanceof Array?e.matchConditions(this.conditions,i):console.warn("Conditions should be type of array.")},CLOUD.TransparentConditionFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="TransparentConditionFA",this.flag=e,this.isOpaque=t},CLOUD.TransparentConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.TransparentConditionFA.prototype.constructor=CLOUD.TransparentConditionFA,CLOUD.TransparentConditionFA.prototype.applyFilter=function(e){var t=this,n=function(n,i){t.flag==i&&(e.setTransparent(n,!t.isOpaque),n=null)};this.conditions instanceof Array?e.matchConditions(this.conditions,n):console.warn("Conditions should be type of array.")},CLOUD.IsolateConditionFA=function(e){CLOUD.ConditionFilterAction.call(this),this.className="IsolateConditionFA",this.isolateHide=e},CLOUD.IsolateConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.IsolateConditionFA.prototype.constructor=CLOUD.IsolateConditionFA,CLOUD.IsolateConditionFA.prototype.applyFilter=function(e){e.clearIsolates();var t=this.isolateHide,n=function(n,i){if(1==i)return void(n=null);t?(e.setIsolateHide(n,!i),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(n,!i),n=null};this.conditions instanceof Array?e.matchConditions(this.conditions,n):console.warn("Conditions should be type of array.")},CLOUD.EnumObjectState={Visible:1,HideByIsolate:2,Transparent:4,TransparentByIsolate:8},CLOUD.ObjectInfo={userData:null,state:CLOUD.EnumObjectState.Visible,material:null},CLOUD.ObjectInfoDict=function(){var e={},t={};this.init=function(n){e=n;for(var i in e)t.hasOwnProperty(i)||(t[i]=Object.keys(e[i]))},this.reinit=function(n){e=n;for(var i in e)t[i]=Object.keys(n[i])},this.clear=function(){e={},t={}},this.getObjectsMap=function(){return e},this.getObjectIds=function(e){return t.hasOwnProperty(e)?t[e]:[]}},CLOUD.ObjectInfoManager=function(){var e=new CLOUD.ObjectInfoDict,t=!1,n=!1,i=!1,r=!1,a=!1,o=!1,s=new THREE.Box3,l=!1;this.inactivatedIdMap={},this.inactivatedIds=[],this.bIsInactivateAll=!1,this.init=function(t){e.init(t)},this.reinit=function(t){e.reinit(t)},this.clearData=function(){e.clear()},this.getObjectsMap=function(){return e.getObjectsMap()},this.calculateVisibleComponentsBbox=function(){s.makeEmpty();var t=e.getObjectsMap();for(var n in t)for(var i=t[n],r=e.getObjectIds(n),a=0,o=r.length;a<o;a++){var u=r[a];if(!this.isHidden(u)){var c=i[u][0].boundingBox;c&&!c.isEmpty()?(s.expandByPoint(c.min),s.expandByPoint(c.max)):console.warn("Object has no boundingBox, id is "+u)}}l=!1},this.getVisibleComponentsBbox=function(){return(l||s.isEmpty())&&this.calculateVisibleComponentsBbox(),s},this.needUpdateBoxAfterExplode=function(){l=!0},this.arrayToMap=function(e){for(var t={},n=0;n<e.length;n++){var i=e[n];t[i]=i}return t},this.isMatchConditions=function(e,t){for(var n=!0,i=0,r=t.length;i<r;i++){var a=t[i];for(var o in a){if(!(a[o]instanceof Array)&&e[o]!=a[o]){n=!1;break}if(a[o]instanceof Array&&-1==a[o].indexOf(e[o])){n=!1;break}}if(1==n)break;i<t.length-1&&(n=!0)}return n},this.matchConditions=function(t,n){var i=e.getObjectsMap();for(var r in i){for(var a=[],o=[],s=i[r],l=e.getObjectIds(r),u=0,c=l.length;u<c;u++){var h=l[u],d=s[h][0].userData||{};d.elementId=s[h][0].userId;this.isMatchConditions(d,t)?a.push(h):o.push(h)}n&&n(a,!0),n&&n(o,!1)}},this.getMatchIds=function(t){var n=e.getObjectsMap(),i=[];for(var r in n)for(var a=n[r],o=e.getObjectIds(r),s=0,l=o.length;s<l;s++){var u=o[s],c=a[u][0].userData||{};c.elementId=a[u][0].userId;var h=this.isMatchConditions(c,t);1==h&&i.push(u)}return i},this.setVisible=function(t,n,r){var a=function(e){n?e.state=e.state|CLOUD.EnumObjectState.Visible:(i=!0,e.state=e.state&~CLOUD.EnumObjectState.Visible)},o=e.getObjectsMap();for(var s in o){var l=o[s];if(void 0==r||!0===r)for(var u=0,c=t.length;u<c;u++){var h=t[u];if(l.hasOwnProperty(h)){var d=l[h][0];a(d)}}else{for(var f=this.arrayToMap(t),p=e.getObjectIds(s),m=0,g=p.length;m<g;m++){var h=p[m];f.hasOwnProperty(h)||(d=l[h][0],a(d))}f=null}}},this.isVisible=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){return r[t][0].state&CLOUD.EnumObjectState.Visible>0}}},this.clearVisible=function(){var t=e.getObjectsMap();i=!1;for(var n in t)for(var r=t[n],a=e.getObjectIds(n),o=0,s=a.length;o<s;o++){var l=a[o],u=r[l][0];u.state=u.state|CLOUD.EnumObjectState.Visible}},this.hideAll=function(){var t=e.getObjectsMap();i=!0;for(var n in t)for(var r=t[n],a=e.getObjectIds(n),o=0,s=a.length;o<s;o++){var l=a[o],u=r[l][0];u.state=u.state&~CLOUD.EnumObjectState.Visible}},this.setTransparent=function(n,i,r){var o=function(e){i?(e.state=e.state|CLOUD.EnumObjectState.Transparent,t=!0,a=!0):e.state=e.state&~CLOUD.EnumObjectState.Transparent},s=e.getObjectsMap();for(var l in s){var u=s[l];if(void 0==r||!0===r)for(var c=0,h=n.length;c<h;c++){var d=n[c];if(this.isActive(d)&&u.hasOwnProperty(d)){var f=u[d][0];o(f)}}else{for(var p=this.arrayToMap(n),m=e.getObjectIds(l),g=0,v=m.length;g<v;g++){var d=m[g];this.isActive(d)&&!p.hasOwnProperty(d)&&(f=u[d][0],o(f))}p=null}}},this.isTransparent=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){var a=r[t][0],o=(a.state&CLOUD.EnumObjectState.Transparent)>0;return o=o||(a.state&CLOUD.EnumObjectState.TransparentByIsolate)>0}}},this.clearTransparent=function(){var t=e.getObjectsMap();a=!1;for(var n in t)for(var i=t[n],r=e.getObjectIds(n),o=0,s=r.length;o<s;o++){var l=r[o];if(this.isActive(l)){var u=i[l][0];u.state=u.state&~CLOUD.EnumObjectState.Transparent}}},this.setMaterial=function(n,i,r){var a=e.getObjectsMap();for(var o in a){var s=a[o];if(void 0==r||!0===r)for(var l=0,u=n.length;l<u;l++){var c=n[l];if(this.isActive(c)&&s.hasOwnProperty(c)){var h=s[c][0];h.material=i,t=!0}}else{for(var d=this.arrayToMap(n),f=e.getObjectIds(o),p=0,m=f.length;p<m;p++){var c=f[p];this.isActive(c)&&!d.hasOwnProperty(c)&&(h=s[c][0],h.material=i,t=!0)}d=null}}},this.getMaterial=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){return r[t][0].material}}},this.clearMaterial=function(){var t=e.getObjectsMap();for(var n in t){var i=t[n];for(var r in i)this.isActive(r)&&(i[r][0].material=null)}},this.setWireFrameMaterial=function(t,i,r){var a=e.getObjectsMap();for(var o in a){var s=a[o];if(void 0==r||!0===r)for(var l=0,u=t.length;l<u;l++){var c=t[l];if(s.hasOwnProperty(c)){var h=s[c][0];h.wireFrameMaterial=i,n=!0}}else{for(var d=this.arrayToMap(t),f=e.getObjectIds(o),p=0,m=f.length;p<m;p++){var c=f[p];d.hasOwnProperty(c)||(h=s[c][0],h.wireFrameMaterial=i,n=!0)}d=null}}},this.getWireFrameMaterial=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){return r[t][0].wireFrameMaterial}}},this.clearWireFrameMaterial=function(){var t=e.getObjectsMap();for(var n in t){var i=t[n];for(var r in i)i[r][0].wireFrameMaterial=null}},this.setIsolateHide=function(t,n,i){var a=function(e){n?(r=!0,e.state=e.state|CLOUD.EnumObjectState.HideByIsolate):e.state=e.state&~CLOUD.EnumObjectState.HideByIsolate},o=e.getObjectsMap();for(var s in o){var l=o[s];if(void 0==i||!0===i)for(var u=0,c=t.length;u<c;u++){var h=t[u];if(l.hasOwnProperty(h)){var d=l[h][0];a(d)}}else{for(var f=this.arrayToMap(t),p=e.getObjectIds(s),m=0,g=p.length;m<g;m++){var h=p[m];f.hasOwnProperty(h)||(d=l[h][0],a(d))}f=null}}},this.isIsolateHide=function(t){var n=e.getObjectsMap();for(var i in n){return(n[i][t][0].state&CLOUD.EnumObjectState.HideByIsolate)>0}},this.setIsolateTransparent=function(n,i,r){var a=function(e){i?(e.state=e.state|CLOUD.EnumObjectState.TransparentByIsolate,t=!0,o=!0):e.state=e.state&~CLOUD.EnumObjectState.TransparentByIsolate},s=e.getObjectsMap();for(var l in s){var u=s[l];if(void 0==r||!0===r)for(var c=0,h=n.length;c<h;c++){var d=n[c];if(this.isActive(d)&&u.hasOwnProperty(d)){var f=u[d][0];a(f)}}else{for(var p=this.arrayToMap(n),m=e.getObjectIds(l),g=0,v=m.length;g<v;g++){var d=m[g];this.isActive(d)&&!p.hasOwnProperty(d)&&(f=u[d][0],a(f))}p=null}}},this.isIsolateTransparent=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){return(r[t][0].state&CLOUD.EnumObjectState.TransparentByIsolate)>0}}},this.clearIsolateHide=function(){var t=e.getObjectsMap();r=!1;for(var n in t){var i=e.getObjectIds(n);i.length>0&&this.setIsolateHide(i,!1)}},this.clearIsolates=function(){var t=e.getObjectsMap();o=!1,r=!1;for(var n in t){var i=e.getObjectIds(n);i.length>0&&(this.setIsolateHide(i,!1),this.setIsolateTransparent(i,!1))}},this.clearTransparentByIsolate=function(){var t=e.getObjectsMap();o=!1;for(var n in t)for(var i=t[n],r=e.getObjectIds(n),a=0,s=r.length;a<s;a++){var l=r[a];if(this.isActive(l)){var u=i[l][0];u.state=u.state&~CLOUD.EnumObjectState.TransparentByIsolate}}},this.isHidden=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){var a=r[t][0],o=0==(a.state&CLOUD.EnumObjectState.Visible);return o=o||(a.state&CLOUD.EnumObjectState.HideByIsolate)>0}}},this.isFrozen=function(t){var n=e.getObjectsMap();for(var i in n){var r=n[i];if(r.hasOwnProperty(t)){var a=r[t][0],o=(a.state&CLOUD.EnumObjectState.Transparent)>0;return o=o||(a.state&CLOUD.EnumObjectState.TransparentByIsolate)>0}}},this.resetAll=function(){var n=e.getObjectsMap();for(var s in n)for(var l=n[s],u=e.getObjectIds(s),c=0,h=u.length;c<h;c++){var d=u[c];l[d][0].state|=CLOUD.EnumObjectState.Visible,this.isActive(d)&&(l[d][0].material=null)}t=!1,i=r=!1,a=o=!1},this.hasOverrideMaterial=function(n){var i=e.getObjectsMap();if(void 0==n)return t;for(var r in i){var a=i[r];if(a.hasOwnProperty(n)){return null!=a[n][0].material||this.isTransparent(n)}}},this.hasOverrideMaterialForWireFrame=function(t){var i=e.getObjectsMap();if(void 0==t)return n;for(var r in i){var a=i[r];if(a.hasOwnProperty(t)){return null!=a[t][0].wireFrameMaterial}}},this.hasObjectInactivated=function(){return this.inactivatedIds.length>0},this.hasObjectHidden=function(){return i||r},this.hasObjectCantSelected=function(){return this.hasObjectHidden()||this.hasObjectTransparent()||this.hasObjectInactivated()},this.hasObjectTransparent=function(){if(this.hasObjectInactivated()){var e=!1,t=!0,n=!1,i=void 0;try{for(var r,s=this.inactivatedIds[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){var l=r.value;if(this.isTransparent(l)){e=!0;break}}}catch(e){n=!0,i=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw i}}return e}return a||o},this.deactivateByIds=function(e){var t=!0,n=!1,i=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value;this.inactivatedIdMap[o]=!0}}catch(e){n=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(n)throw i}}this.inactivatedIds=Object.keys(this.inactivatedIdMap)},this.clearInactivatedIdMap=function(){this.inactivatedIdMap={},this.inactivatedIds=[]},this.isActive=function(e){return 0==this.bIsInactivateAll&&!(1==this.inactivatedIdMap[e])},this.deactivateAll=function(){this.bIsInactivateAll=!0},this.activateAll=function(){this.bIsInactivateAll=!1},this.getInactivatedIdMap=function(){return this.inactivatedIdMap}},CLOUD.FilterManagerIO=function(e){this.materialSelector=e;var t=function(e){var t=[];for(var n in e)1==e[n]&&t.push(n);return t};this.saveState=function(e){return{isolateAction:e.getIsolateFilterAction(),actions:e.getFilterActionList(),sceneState:e.getSceneState(),version:"1.0"}},this.createAction=function(e){var t=e.className,n=null;switch(t){case"IsolateIdsFA":n=new CLOUD.IsolateIdsFA(e.isolateHide),n.ids=e.ids;break;case"VisibleIdsFA":n=new CLOUD.VisibleIdsFA(e.flag,e.isVisible),n.ids=e.ids;break;case"OverrideIdsFA":case"OverrideIdsForWireFrameFA":var i=e.material;if(i){var r={opacity:i.opacity,color:i.color},a=this.materialSelector.getMaterialNameByColor(r);i=this.materialSelector.get(a)}n="OverrideIdsFA"===t?new CLOUD.OverrideIdsFA(e.flag,i):new CLOUD.OverrideIdsForWireFrameFA(e.flag,i),n.ids=e.ids;break;case"TransparentIdsFA":n=new CLOUD.TransparentIdsFA(e.flag,e.isOpaque),n.ids=e.ids;break;case"VisibleConditionFA":n=new CLOUD.VisibleConditionFA(e.flag,e.isVisible),n.conditions=e.conditions;break;case"OverrideConditionFA":case"OverrideConditionForWireFrameFA":var i=e.material;if(i){var r={opacity:i.opacity,color:i.color},a=this.materialSelector.getMaterialNameByColor(r);i=this.materialSelector.get(a)}n="OverrideConditionFA"===t?new CLOUD.OverrideConditionFA(e.flag,i):new CLOUD.OverrideConditionForWireFrameFA(e.flag,i),n.conditions=e.conditions;break;case"TransparentConditionFA":n=new CLOUD.TransparentConditionFA(e.flag,e.isOpaque),n.conditions=e.conditions;break;case"IsolateConditionFA":n=new CLOUD.IsolateConditionFA(e.isolateHide),n.conditions=e.conditions;break;default:CLOUD.Logger.warn("Warning: Not supported filterAction '"+t+"'")}return n},this.createActionByOldFilter=function(e,n){var i=[];switch(e){case"CONDITION_OVERRIDE":for(var r=[],a=0;a<n.length;a++){var o=n[a];r.push(o.condition)}var s=o.color,l=this.materialSelector.add(s),u=this.materialSelector.get(l),c=new CLOUD.OverrideConditionFA(!0,u);c.conditions=r,i.push(c);break;case"CONDITION_TRANSLUCENT_OTHERS":var c=new CLOUD.TransparentConditionFA(!1,!1);c.conditions=n,i.push(c);break;case"ISOLATE_CONDITION_HIDEEN_OTHERS":var c=new CLOUD.IsolateConditionFA(!0);c.conditions=n,i.push(c);break;case"ISOLATE_CONDITION_TRANSLUCENT_OTHERS":var c=new CLOUD.IsolateConditionFA(!1);c.conditions=n,i.push(c);break;case"ISOLATE_HIDDEN_OTHERS":var c=new CLOUD.IsolateIdsFA(!0);c.ids=t(n),i.push(c);break;case"ISOLATE_TRANSLUCENT_OTHERS":var c=new CLOUD.IsolateIdsFA(!1);c.ids=t(n),i.push(c);break;case"OVERRIDEFILTER":for(var h in n)if(n.hasOwnProperty(h)){var d=[],f=n[h];for(var p in f)d.push(p);var s=this.materialSelector.getMaterialParamsFromName(f[p]),l=this.materialSelector.add(s),u=this.materialSelector.get(l),c=new CLOUD.OverrideIdsFA(!0,u);c.ids=d,i.push(c)}break;case"TRANSLUCENT":var c=new CLOUD.TransparentIdsFA(!0,!1);c.ids=t(n),i.push(c);break;case"TRANSLUCTANT_OTHERS":var c=new CLOUD.TransparentIdsFA(!1,!1);c.ids=t(n),i.push(c);break;case"VISIBLE":var c=new CLOUD.VisibleIdsFA(!0,!0);c.ids=t(n),i.push(c);break;default:CLOUD.Logger.warn("Warning: Not supported filter '"+e+"'")}return i},this.loadState=function(e,t){t.clearFilterActionList(),t.getObjectInfoManager().resetAll();var n=e;if(n.hasOwnProperty("version"))if("1.0"==n.version){var i=n.isolateAction;if(i){var r=this.createAction(i);t.pushBack(r)}for(var a=n.actions,o=0;o<a.length;o++){var r=this.createAction(a[o]);t.pushBack(r)}}else if("0.4"==n.version){for(var s={},l=t._filterImpl.getBasicFilterList(),o=0,u=l.length;o<u;o++)s[l[o].getName()]=o;for(var c in n)if("sceneState"!==c&&"version"!==c&&s.hasOwnProperty(c)){if("{}"==JSON.stringify(n[c])||"[]"==JSON.stringify(n[c]))continue;for(var h=this.createActionByOldFilter(c,n[c]),o=0;o<h.length;o++)t.pushBack(h[o])}}t.setSceneState(n.sceneState)}},CLOUD.Workers=CLOUD.Workers||{},CLOUD.Workers.WorkerChunk=CLOUD.Workers.WorkerChunk||{},CLOUD.Workers.WorkerLib=CLOUD.Workers.WorkerLib||{},function(){CLOUD.Workers.WorkerChunk.NamespaceChunk="\n        var CLOUD = {};\n        CLOUD.Utils = {};        \n        CLOUD.Math = {};\n        CLOUD.GeomUtil = {};\n        CLOUD.Reader = {};\n    "}(),function(){
CLOUD.Workers.WorkerChunk.MathChunk="\n\n        (function(){\n\n            var _Math = {\n\n                DEG2RAD: Math.PI / 180,\n                RAD2DEG: 180 / Math.PI,\n\n                generateUUID: function () {\n\n                    // http://www.broofa.com/Tools/Math.uuid.htm\n\n                    var chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');\n                    var uuid = new Array(36);\n                    var rnd = 0,\n                        r;\n\n                    return function generateUUID() {\n\n                        for (var i = 0; i < 36; i++) {\n\n                            if (i === 8 || i === 13 || i === 18 || i === 23) {\n\n                                uuid[i] = '-';\n\n                            } else if (i === 14) {\n\n                                uuid[i] = '4';\n\n                            } else {\n\n                                if (rnd <= 0x02) rnd = 0x2000000 + (Math.random() * 0x1000000) | 0;\n                                r = rnd & 0xf;\n                                rnd = rnd >> 4;\n                                uuid[i] = chars[(i === 19) ? (r & 0x3) | 0x8 : r];\n\n                            }\n\n                        }\n\n                        return uuid.join('');\n\n                    };\n\n                }(),\n\n                clamp: function (value, min, max) {\n\n                    return Math.max(min, Math.min(max, value));\n\n                },\n\n                // compute euclidian modulo of m % n\n                // https://en.wikipedia.org/wiki/Modulo_operation\n\n                euclideanModulo: function (n, m) {\n\n                    return ((n % m) + m) % m;\n\n                },\n\n                // Linear mapping from range <a1, a2> to range <b1, b2>\n\n                mapLinear: function (x, a1, a2, b1, b2) {\n\n                    return b1 + (x - a1) * (b2 - b1) / (a2 - a1);\n\n                },\n\n                // https://en.wikipedia.org/wiki/Linear_interpolation\n\n                lerp: function (x, y, t) {\n\n                    return (1 - t) * x + t * y;\n\n                },\n\n                // http://en.wikipedia.org/wiki/Smoothstep\n\n                smoothstep: function (x, min, max) {\n\n                    if (x <= min) return 0;\n                    if (x >= max) return 1;\n\n                    x = (x - min) / (max - min);\n\n                    return x * x * (3 - 2 * x);\n\n                },\n\n                smootherstep: function (x, min, max) {\n\n                    if (x <= min) return 0;\n                    if (x >= max) return 1;\n\n                    x = (x - min) / (max - min);\n\n                    return x * x * x * (x * (x * 6 - 15) + 10);\n\n                },\n\n                // Random integer from <low, high> interval\n\n                randInt: function (low, high) {\n\n                    return low + Math.floor(Math.random() * (high - low + 1));\n\n                },\n\n                // Random float from <low, high> interval\n\n                randFloat: function (low, high) {\n\n                    return low + Math.random() * (high - low);\n\n                },\n\n                // Random float from <-range/2, range/2> interval\n\n                randFloatSpread: function (range) {\n\n                    return range * (0.5 - Math.random());\n\n                },\n\n                degToRad: function (degrees) {\n\n                    return degrees * _Math.DEG2RAD;\n\n                },\n\n                radToDeg: function (radians) {\n\n                    return radians * _Math.RAD2DEG;\n\n                },\n\n                isPowerOfTwo: function (value) {\n\n                    return (value & (value - 1)) === 0 && value !== 0;\n\n                },\n\n                nearestPowerOfTwo: function (value) {\n\n                    return Math.pow(2, Math.round(Math.log(value) / Math.LN2));\n\n                },\n\n                nextPowerOfTwo: function (value) {\n\n                    value--;\n                    value |= value >> 1;\n                    value |= value >> 2;\n                    value |= value >> 4;\n                    value |= value >> 8;\n                    value |= value >> 16;\n                    value++;\n\n                    return value;\n\n                }\n\n            };\n\n            function Vector3(x, y, z) {\n\n                this.x = x || 0;\n                this.y = y || 0;\n                this.z = z || 0;\n\n            }\n\n            Object.assign(Vector3.prototype, {\n\n                isVector3: true,\n\n                set: function (x, y, z) {\n\n                    this.x = x;\n                    this.y = y;\n                    this.z = z;\n\n                    return this;\n\n                },\n\n                setScalar: function (scalar) {\n\n                    this.x = scalar;\n                    this.y = scalar;\n                    this.z = scalar;\n\n                    return this;\n\n                },\n\n                setX: function (x) {\n\n                    this.x = x;\n\n                    return this;\n\n                },\n\n                setY: function (y) {\n\n                    this.y = y;\n\n                    return this;\n\n                },\n\n                setZ: function (z) {\n\n                    this.z = z;\n\n                    return this;\n\n                },\n\n                setComponent: function (index, value) {\n\n                    switch (index) {\n\n                        case 0:\n                            this.x = value;\n                            break;\n                        case 1:\n                            this.y = value;\n                            break;\n                        case 2:\n                            this.z = value;\n                            break;\n                        default:\n                            throw new Error('index is out of range: ' + index);\n\n                    }\n\n                    return this;\n\n                },\n\n                getComponent: function (index) {\n\n                    switch (index) {\n\n                        case 0:\n                            return this.x;\n                        case 1:\n                            return this.y;\n                        case 2:\n                            return this.z;\n                        default:\n                            throw new Error('index is out of range: ' + index);\n\n                    }\n\n                },\n\n                clone: function () {\n\n                    return new this.constructor(this.x, this.y, this.z);\n\n                },\n\n                copy: function (v) {\n\n                    this.x = v.x;\n                    this.y = v.y;\n                    this.z = v.z;\n\n                    return this;\n\n                },\n\n                add: function (v, w) {\n\n                    if (w !== undefined) {\n\n                        console.warn('THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead.');\n                        return this.addVectors(v, w);\n\n                    }\n\n                    this.x += v.x;\n                    this.y += v.y;\n                    this.z += v.z;\n\n                    return this;\n\n                },\n\n                addScalar: function (s) {\n\n                    this.x += s;\n                    this.y += s;\n                    this.z += s;\n\n                    return this;\n\n                },\n\n                addVectors: function (a, b) {\n\n                    this.x = a.x + b.x;\n                    this.y = a.y + b.y;\n                    this.z = a.z + b.z;\n\n                    return this;\n\n                },\n\n                addScaledVector: function (v, s) {\n\n                    this.x += v.x * s;\n                    this.y += v.y * s;\n                    this.z += v.z * s;\n\n                    return this;\n\n                },\n\n                sub: function (v, w) {\n\n                    if (w !== undefined) {\n\n                        console.warn('THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead.');\n                        return this.subVectors(v, w);\n\n                    }\n\n                    this.x -= v.x;\n                    this.y -= v.y;\n                    this.z -= v.z;\n\n                    return this;\n\n                },\n\n                subScalar: function (s) {\n\n                    this.x -= s;\n                    this.y -= s;\n                    this.z -= s;\n\n                    return this;\n\n                },\n\n                subVectors: function (a, b) {\n\n                    this.x = a.x - b.x;\n                    this.y = a.y - b.y;\n                    this.z = a.z - b.z;\n\n                    return this;\n\n                },\n\n                multiply: function (v, w) {\n\n                    if (w !== undefined) {\n\n                        console.warn('THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead.');\n                        return this.multiplyVectors(v, w);\n\n                    }\n\n                    this.x *= v.x;\n                    this.y *= v.y;\n                    this.z *= v.z;\n\n                    return this;\n\n                },\n\n                multiplyScalar: function (scalar) {\n\n                    this.x *= scalar;\n                    this.y *= scalar;\n                    this.z *= scalar;\n\n                    return this;\n\n                },\n\n                multiplyVectors: function (a, b) {\n\n                    this.x = a.x * b.x;\n                    this.y = a.y * b.y;\n                    this.z = a.z * b.z;\n\n                    return this;\n\n                },\n\n                applyEuler: function () {\n\n                    var quaternion = new Quaternion();\n\n                    return function applyEuler(euler) {\n\n                        if ((euler && euler.isEuler) === false) {\n\n                            console.error('THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order.');\n\n                        }\n\n                        return this.applyQuaternion(quaternion.setFromEuler(euler));\n\n                    };\n\n                }(),\n\n                applyAxisAngle: function () {\n\n                    var quaternion = new Quaternion();\n\n                    return function applyAxisAngle(axis, angle) {\n\n                        return this.applyQuaternion(quaternion.setFromAxisAngle(axis, angle));\n\n                    };\n\n                }(),\n\n                applyMatrix3: function (m) {\n\n                    var x = this.x,\n                        y = this.y,\n                        z = this.z;\n                    var e = m.elements;\n\n                    this.x = e[0] * x + e[3] * y + e[6] * z;\n                    this.y = e[1] * x + e[4] * y + e[7] * z;\n                    this.z = e[2] * x + e[5] * y + e[8] * z;\n\n                    return this;\n\n                },\n\n                applyMatrix4: function (m) {\n\n                    var x = this.x,\n                        y = this.y,\n                        z = this.z;\n                    var e = m.elements;\n\n                    this.x = e[0] * x + e[4] * y + e[8] * z + e[12];\n                    this.y = e[1] * x + e[5] * y + e[9] * z + e[13];\n                    this.z = e[2] * x + e[6] * y + e[10] * z + e[14];\n                    var w = e[3] * x + e[7] * y + e[11] * z + e[15];\n\n                    return this.divideScalar(w);\n\n                },\n\n                applyQuaternion: function (q) {\n\n                    var x = this.x,\n                        y = this.y,\n                        z = this.z;\n                    var qx = q.x,\n                        qy = q.y,\n                        qz = q.z,\n                        qw = q.w;\n\n                    // calculate quat * vector\n\n                    var ix = qw * x + qy * z - qz * y;\n                    var iy = qw * y + qz * x - qx * z;\n                    var iz = qw * z + qx * y - qy * x;\n                    var iw = -qx * x - qy * y - qz * z;\n\n                    // calculate result * inverse quat\n\n                    this.x = ix * qw + iw * -qx + iy * -qz - iz * -qy;\n                    this.y = iy * qw + iw * -qy + iz * -qx - ix * -qz;\n                    this.z = iz * qw + iw * -qz + ix * -qy - iy * -qx;\n\n                    return this;\n\n                },\n\n                project: function () {\n\n                    var matrix = new Matrix4();\n\n                    return function project(camera) {\n\n                        matrix.multiplyMatrices(camera.projectionMatrix, matrix.getInverse(camera.matrixWorld));\n                        return this.applyMatrix4(matrix);\n\n                    };\n\n                }(),\n\n                unproject: function () {\n\n                    var matrix = new Matrix4();\n\n                    return function unproject(camera) {\n\n                        matrix.multiplyMatrices(camera.matrixWorld, matrix.getInverse(camera.projectionMatrix));\n                        return this.applyMatrix4(matrix);\n\n                    };\n\n                }(),\n\n                transformDirection: function (m) {\n\n                    // input: THREE.Matrix4 affine matrix\n                    // vector interpreted as a direction\n\n                    var x = this.x,\n                        y = this.y,\n                        z = this.z;\n                    var e = m.elements;\n\n                    this.x = e[0] * x + e[4] * y + e[8] * z;\n                    this.y = e[1] * x + e[5] * y + e[9] * z;\n                    this.z = e[2] * x + e[6] * y + e[10] * z;\n\n                    return this.normalize();\n\n                },\n\n                divide: function (v) {\n\n                    this.x /= v.x;\n                    this.y /= v.y;\n                    this.z /= v.z;\n\n                    return this;\n\n                },\n\n                divideScalar: function (scalar) {\n\n                    return this.multiplyScalar(1 / scalar);\n\n                },\n\n                min: function (v) {\n\n                    this.x = Math.min(this.x, v.x);\n                    this.y = Math.min(this.y, v.y);\n                    this.z = Math.min(this.z, v.z);\n\n                    return this;\n\n                },\n\n                max: function (v) {\n\n                    this.x = Math.max(this.x, v.x);\n                    this.y = Math.max(this.y, v.y);\n                    this.z = Math.max(this.z, v.z);\n\n                    return this;\n\n                },\n\n                clamp: function (min, max) {\n\n                    // This function assumes min < max, if this assumption isn't true it will not operate correctly\n\n                    this.x = Math.max(min.x, Math.min(max.x, this.x));\n                    this.y = Math.max(min.y, Math.min(max.y, this.y));\n                    this.z = Math.max(min.z, Math.min(max.z, this.z));\n\n                    return this;\n\n                },\n\n                clampScalar: function () {\n\n                    var min = new Vector3();\n                    var max = new Vector3();\n\n                    return function clampScalar(minVal, maxVal) {\n\n                        min.set(minVal, minVal, minVal);\n                        max.set(maxVal, maxVal, maxVal);\n\n                        return this.clamp(min, max);\n\n                    };\n\n                }(),\n\n                clampLength: function (min, max) {\n\n                    var length = this.length();\n\n                    return this.multiplyScalar(Math.max(min, Math.min(max, length)) / length);\n\n                },\n\n                floor: function () {\n\n                    this.x = Math.floor(this.x);\n                    this.y = Math.floor(this.y);\n                    this.z = Math.floor(this.z);\n\n                    return this;\n\n                },\n\n                ceil: function () {\n\n                    this.x = Math.ceil(this.x);\n                    this.y = Math.ceil(this.y);\n                    this.z = Math.ceil(this.z);\n\n                    return this;\n\n                },\n\n                round: function () {\n\n                    this.x = Math.round(this.x);\n                    this.y = Math.round(this.y);\n                    this.z = Math.round(this.z);\n\n                    return this;\n\n                },\n\n                roundToZero: function () {\n\n                    this.x = (this.x < 0) ? Math.ceil(this.x) : Math.floor(this.x);\n                    this.y = (this.y < 0) ? Math.ceil(this.y) : Math.floor(this.y);\n                    this.z = (this.z < 0) ? Math.ceil(this.z) : Math.floor(this.z);\n\n                    return this;\n\n                },\n\n                negate: function () {\n\n                    this.x = -this.x;\n                    this.y = -this.y;\n                    this.z = -this.z;\n\n                    return this;\n\n                },\n\n                dot: function (v) {\n\n                    return this.x * v.x + this.y * v.y + this.z * v.z;\n\n                },\n\n                // TODO lengthSquared?\n\n                lengthSq: function () {\n\n                    return this.x * this.x + this.y * this.y + this.z * this.z;\n\n                },\n\n                length: function () {\n\n                    return Math.sqrt(this.x * this.x + this.y * this.y + this.z * this.z);\n\n                },\n\n                lengthManhattan: function () {\n\n                    return Math.abs(this.x) + Math.abs(this.y) + Math.abs(this.z);\n\n                },\n\n                normalize: function () {\n\n                    return this.divideScalar(this.length());\n\n                },\n\n                setLength: function (length) {\n\n                    return this.multiplyScalar(length / this.length());\n\n                },\n\n                lerp: function (v, alpha) {\n\n                    this.x += (v.x - this.x) * alpha;\n                    this.y += (v.y - this.y) * alpha;\n                    this.z += (v.z - this.z) * alpha;\n\n                    return this;\n\n                },\n\n                lerpVectors: function (v1, v2, alpha) {\n\n                    return this.subVectors(v2, v1).multiplyScalar(alpha).add(v1);\n\n                },\n\n                cross: function (v, w) {\n\n                    if (w !== undefined) {\n\n                        console.warn('THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead.');\n                        return this.crossVectors(v, w);\n\n                    }\n\n                    var x = this.x,\n                        y = this.y,\n                        z = this.z;\n\n                    this.x = y * v.z - z * v.y;\n                    this.y = z * v.x - x * v.z;\n                    this.z = x * v.y - y * v.x;\n\n                    return this;\n\n                },\n\n                crossVectors: function (a, b) {\n\n                    var ax = a.x,\n                        ay = a.y,\n                        az = a.z;\n                    var bx = b.x,\n                        by = b.y,\n                        bz = b.z;\n\n                    this.x = ay * bz - az * by;\n                    this.y = az * bx - ax * bz;\n                    this.z = ax * by - ay * bx;\n\n                    return this;\n\n                },\n\n                projectOnVector: function (vector) {\n\n                    var scalar = vector.dot(this) / vector.lengthSq();\n\n                    return this.copy(vector).multiplyScalar(scalar);\n\n                },\n\n                projectOnPlane: function () {\n\n                    var v1 = new Vector3();\n\n                    return function projectOnPlane(planeNormal) {\n\n                        v1.copy(this).projectOnVector(planeNormal);\n\n                        return this.sub(v1);\n\n                    };\n\n                }(),\n\n                reflect: function () {\n\n                    // reflect incident vector off plane orthogonal to normal\n                    // normal is assumed to have unit length\n\n                    var v1 = new Vector3();\n\n                    return function reflect(normal) {\n\n                        return this.sub(v1.copy(normal).multiplyScalar(2 * this.dot(normal)));\n\n                    };\n\n                }(),\n\n                angleTo: function (v) {\n\n                    var theta = this.dot(v) / (Math.sqrt(this.lengthSq() * v.lengthSq()));\n\n                    // clamp, to handle numerical problems\n\n                    return Math.acos(_Math.clamp(theta, -1, 1));\n\n                },\n\n                distanceTo: function (v) {\n\n                    return Math.sqrt(this.distanceToSquared(v));\n\n                },\n\n                distanceToSquared: function (v) {\n\n                    var dx = this.x - v.x,\n                        dy = this.y - v.y,\n                        dz = this.z - v.z;\n\n                    return dx * dx + dy * dy + dz * dz;\n\n                },\n\n                distanceToManhattan: function (v) {\n\n                    return Math.abs(this.x - v.x) + Math.abs(this.y - v.y) + Math.abs(this.z - v.z);\n\n                },\n\n                setFromSpherical: function (s) {\n\n                    var sinPhiRadius = Math.sin(s.phi) * s.radius;\n\n                    this.x = sinPhiRadius * Math.sin(s.theta);\n                    this.y = Math.cos(s.phi) * s.radius;\n                    this.z = sinPhiRadius * Math.cos(s.theta);\n\n                    return this;\n\n                },\n\n                setFromCylindrical: function (c) {\n\n                    this.x = c.radius * Math.sin(c.theta);\n                    this.y = c.y;\n                    this.z = c.radius * Math.cos(c.theta);\n\n                    return this;\n\n                },\n\n                setFromMatrixPosition: function (m) {\n\n                    return this.setFromMatrixColumn(m, 3);\n\n                },\n\n                setFromMatrixScale: function (m) {\n\n                    var sx = this.setFromMatrixColumn(m, 0).length();\n                    var sy = this.setFromMatrixColumn(m, 1).length();\n                    var sz = this.setFromMatrixColumn(m, 2).length();\n\n                    this.x = sx;\n                    this.y = sy;\n                    this.z = sz;\n\n                    return this;\n\n                },\n\n                setFromMatrixColumn: function (m, index) {\n\n\n                    return this.fromArray(m.elements, index * 4);\n\n                },\n\n                equals: function (v) {\n\n                    return ((v.x === this.x) && (v.y === this.y) && (v.z === this.z));\n\n                },\n\n                fromArray: function (array, offset) {\n\n                    if (offset === undefined) offset = 0;\n\n                    this.x = array[offset];\n                    this.y = array[offset + 1];\n                    this.z = array[offset + 2];\n\n                    return this;\n\n                },\n\n                toArray: function (array, offset) {\n\n                    if (array === undefined) array = [];\n                    if (offset === undefined) offset = 0;\n\n                    array[offset] = this.x;\n                    array[offset + 1] = this.y;\n                    array[offset + 2] = this.z;\n\n                    return array;\n\n                },\n\n                fromBufferAttribute: function (attribute, index, offset) {\n\n                    if (offset !== undefined) {\n\n                        console.warn('THREE.Vector3: offset has been removed from .fromBufferAttribute().');\n\n                    }\n\n                    this.x = attribute.getX(index);\n                    this.y = attribute.getY(index);\n                    this.z = attribute.getZ(index);\n\n                    return this;\n\n                }\n\n            });\n\n            function Vector4(x, y, z, w) {\n\n                this.x = x || 0;\n                this.y = y || 0;\n                this.z = z || 0;\n                this.w = (w !== undefined) ? w : 1;\n\n            }\n\n            Object.assign(Vector4.prototype, {\n\n                isVector4: true,\n\n                set: function (x, y, z, w) {\n\n                    this.x = x;\n                    this.y = y;\n                    this.z = z;\n                    this.w = w;\n\n                    return this;\n\n                },\n\n                setScalar: function (scalar) {\n\n                    this.x = scalar;\n                    this.y = scalar;\n                    this.z = scalar;\n                    this.w = scalar;\n\n                    return this;\n\n                },\n\n                setX: function (x) {\n\n                    this.x = x;\n\n                    return this;\n\n                },\n\n                setY: function (y) {\n\n                    this.y = y;\n\n                    return this;\n\n                },\n\n                setZ: function (z) {\n\n                    this.z = z;\n\n                    return this;\n\n                },\n\n                setW: function (w) {\n\n                    this.w = w;\n\n                    return this;\n\n                },\n\n                setComponent: function (index, value) {\n\n                    switch (index) {\n\n                        case 0:\n                            this.x = value;\n                            break;\n                        case 1:\n                            this.y = value;\n                            break;\n                        case 2:\n                            this.z = value;\n                            break;\n                        case 3:\n                            this.w = value;\n                            break;\n                        default:\n                            throw new Error('index is out of range: ' + index);\n\n                    }\n\n                    return this;\n\n                },\n\n                getComponent: function (index) {\n\n                    switch (index) {\n\n                        case 0:\n                            return this.x;\n                        case 1:\n                            return this.y;\n                        case 2:\n                            return this.z;\n                        case 3:\n                            return this.w;\n                        default:\n                            throw new Error('index is out of range: ' + index);\n\n                    }\n\n                },\n\n                clone: function () {\n\n                    return new this.constructor(this.x, this.y, this.z, this.w);\n\n                },\n\n                copy: function (v) {\n\n                    this.x = v.x;\n                    this.y = v.y;\n                    this.z = v.z;\n                    this.w = (v.w !== undefined) ? v.w : 1;\n\n                    return this;\n\n                },\n\n                add: function (v, w) {\n\n                    if (w !== undefined) {\n\n                        console.warn('THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead.');\n                        return this.addVectors(v, w);\n\n                    }\n\n                    this.x += v.x;\n                    this.y += v.y;\n                    this.z += v.z;\n                    this.w += v.w;\n\n                    return this;\n\n                },\n\n                addScalar: function (s) {\n\n                    this.x += s;\n                    this.y += s;\n                    this.z += s;\n                    this.w += s;\n\n                    return this;\n\n                },\n\n                addVectors: function (a, b) {\n\n                    this.x = a.x + b.x;\n                    this.y = a.y + b.y;\n                    this.z = a.z + b.z;\n                    this.w = a.w + b.w;\n\n                    return this;\n\n                },\n\n                addScaledVector: function (v, s) {\n\n                    this.x += v.x * s;\n                    this.y += v.y * s;\n                    this.z += v.z * s;\n                    this.w += v.w * s;\n\n                    return this;\n\n                },\n\n                sub: function (v, w) {\n\n                    if (w !== undefined) {\n\n                        console.warn('THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead.');\n                        return this.subVectors(v, w);\n\n                    }\n\n                    this.x -= v.x;\n                    this.y -= v.y;\n                    this.z -= v.z;\n                    this.w -= v.w;\n\n                    return this;\n\n                },\n\n                subScalar: function (s) {\n\n                    this.x -= s;\n                    this.y -= s;\n                    this.z -= s;\n                    this.w -= s;\n\n                    return this;\n\n                },\n\n                subVectors: function (a, b) {\n\n                    this.x = a.x - b.x;\n                    this.y = a.y - b.y;\n                    this.z = a.z - b.z;\n                    this.w = a.w - b.w;\n\n                    return this;\n\n                },\n\n                multiplyScalar: function (scalar) {\n\n                    this.x *= scalar;\n                    this.y *= scalar;\n                    this.z *= scalar;\n                    this.w *= scalar;\n\n                    return this;\n\n                },\n\n                applyMatrix4: function (m) {\n\n                    var x = this.x,\n                        y = this.y,\n                        z = this.z,\n                        w = this.w;\n                    var e = m.elements;\n\n                    this.x = e[0] * x + e[4] * y + e[8] * z + e[12] * w;\n                    this.y = e[1] * x + e[5] * y + e[9] * z + e[13] * w;\n                    this.z = e[2] * x + e[6] * y + e[10] * z + e[14] * w;\n                    this.w = e[3] * x + e[7] * y + e[11] * z + e[15] * w;\n\n                    return this;\n\n                },\n\n                divideScalar: function (scalar) {\n\n                    return this.multiplyScalar(1 / scalar);\n\n                },\n\n                setAxisAngleFromQuaternion: function (q) {\n\n                    // http://www.euclideanspace.com/maths/geometry/rotations/conversions/quaternionToAngle/index.htm\n\n                    // q is assumed to be normalized\n\n                    this.w = 2 * Math.acos(q.w);\n\n                    var s = Math.sqrt(1 - q.w * q.w);\n\n                    if (s < 0.0001) {\n\n                        this.x = 1;\n                        this.y = 0;\n                        this.z = 0;\n\n                    } else {\n\n                        this.x = q.x / s;\n                        this.y = q.y / s;\n                        this.z = q.z / s;\n\n                    }\n\n                    return this;\n\n                },\n\n                setAxisAngleFromRotationMatrix: function (m) {\n\n                    // http://www.euclideanspace.com/maths/geometry/rotations/conversions/matrixToAngle/index.htm\n\n                    // assumes the upper 3x3 of m is a pure rotation matrix (i.e, unscaled)\n\n                    var angle, x, y, z, // variables for result\n                        epsilon = 0.01, // margin to allow for rounding errors\n                        epsilon2 = 0.1, // margin to distinguish between 0 and 180 degrees\n\n                        te = m.elements,\n\n                        m11 = te[0],\n                        m12 = te[4],\n                        m13 = te[8],\n                        m21 = te[1],\n                        m22 = te[5],\n                        m23 = te[9],\n                        m31 = te[2],\n                        m32 = te[6],\n                        m33 = te[10];\n\n                    if ((Math.abs(m12 - m21) < epsilon) &&\n                        (Math.abs(m13 - m31) < epsilon) &&\n                        (Math.abs(m23 - m32) < epsilon)) {\n\n                        // singularity found\n                        // first check for identity matrix which must have +1 for all terms\n                        // in leading diagonal and zero in other terms\n\n                        if ((Math.abs(m12 + m21) < epsilon2) &&\n                            (Math.abs(m13 + m31) < epsilon2) &&\n                            (Math.abs(m23 + m32) < epsilon2) &&\n                            (Math.abs(m11 + m22 + m33 - 3) < epsilon2)) {\n\n                            // this singularity is identity matrix so angle = 0\n\n                            this.set(1, 0, 0, 0);\n\n                            return this; // zero angle, arbitrary axis\n\n                        }\n\n                        // otherwise this singularity is angle = 180\n\n                        angle = Math.PI;\n\n                        var xx = (m11 + 1) / 2;\n                        var yy = (m22 + 1) / 2;\n                        var zz = (m33 + 1) / 2;\n                        var xy = (m12 + m21) / 4;\n                        var xz = (m13 + m31) / 4;\n                        var yz = (m23 + m32) / 4;\n\n                        if ((xx > yy) && (xx > zz)) {\n\n                            // m11 is the largest diagonal term\n\n                            if (xx < epsilon) {\n\n                                x = 0;\n                                y = 0.707106781;\n                                z = 0.707106781;\n\n                            } else {\n\n                                x = Math.sqrt(xx);\n                                y = xy / x;\n                                z = xz / x;\n\n                            }\n\n                        } else if (yy > zz) {\n\n                            // m22 is the largest diagonal term\n\n                            if (yy < epsilon) {\n\n                                x = 0.707106781;\n                                y = 0;\n                                z = 0.707106781;\n\n                            } else {\n\n                                y = Math.sqrt(yy);\n                                x = xy / y;\n                                z = yz / y;\n\n                            }\n\n                        } else {\n\n                            // m33 is the largest diagonal term so base result on this\n\n                            if (zz < epsilon) {\n\n                                x = 0.707106781;\n                                y = 0.707106781;\n                                z = 0;\n\n                            } else {\n\n                                z = Math.sqrt(zz);\n                                x = xz / z;\n                                y = yz / z;\n\n                            }\n\n                        }\n\n                        this.set(x, y, z, angle);\n\n                        return this; // return 180 deg rotation\n\n                    }\n\n                    // as we have reached here there are no singularities so we can handle normally\n\n                    var s = Math.sqrt((m32 - m23) * (m32 - m23) +\n                        (m13 - m31) * (m13 - m31) +\n                        (m21 - m12) * (m21 - m12)); // used to normalize\n\n                    if (Math.abs(s) < 0.001) s = 1;\n\n                    // prevent divide by zero, should not happen if matrix is orthogonal and should be\n                    // caught by singularity test above, but I've left it in just in case\n\n                    this.x = (m32 - m23) / s;\n                    this.y = (m13 - m31) / s;\n                    this.z = (m21 - m12) / s;\n                    this.w = Math.acos((m11 + m22 + m33 - 1) / 2);\n\n                    return this;\n\n                },\n\n                min: function (v) {\n\n                    this.x = Math.min(this.x, v.x);\n                    this.y = Math.min(this.y, v.y);\n                    this.z = Math.min(this.z, v.z);\n                    this.w = Math.min(this.w, v.w);\n\n                    return this;\n\n                },\n\n                max: function (v) {\n\n                    this.x = Math.max(this.x, v.x);\n                    this.y = Math.max(this.y, v.y);\n                    this.z = Math.max(this.z, v.z);\n                    this.w = Math.max(this.w, v.w);\n\n                    return this;\n\n                },\n\n                clamp: function (min, max) {\n\n                    // This function assumes min < max, if this assumption isn't true it will not operate correctly\n\n                    this.x = Math.max(min.x, Math.min(max.x, this.x));\n                    this.y = Math.max(min.y, Math.min(max.y, this.y));\n                    this.z = Math.max(min.z, Math.min(max.z, this.z));\n                    this.w = Math.max(min.w, Math.min(max.w, this.w));\n\n                    return this;\n\n                },\n\n                clampScalar: function () {\n\n                    var min = new Vector4();\n                    var max = new Vector4();\n\n                    return function clampScalar(minVal, maxVal) {\n\n                        min.set(minVal, minVal, minVal, minVal);\n                        max.set(maxVal, maxVal, maxVal, maxVal);\n\n                        return this.clamp(min, max);\n\n                    };\n\n                }(),\n\n                floor: function () {\n\n                    this.x = Math.floor(this.x);\n                    this.y = Math.floor(this.y);\n                    this.z = Math.floor(this.z);\n                    this.w = Math.floor(this.w);\n\n                    return this;\n\n                },\n\n                ceil: function () {\n\n                    this.x = Math.ceil(this.x);\n                    this.y = Math.ceil(this.y);\n                    this.z = Math.ceil(this.z);\n                    this.w = Math.ceil(this.w);\n\n                    return this;\n\n                },\n\n                round: function () {\n\n                    this.x = Math.round(this.x);\n                    this.y = Math.round(this.y);\n                    this.z = Math.round(this.z);\n                    this.w = Math.round(this.w);\n\n                    return this;\n\n                },\n\n                roundToZero: function () {\n\n                    this.x = (this.x < 0) ? Math.ceil(this.x) : Math.floor(this.x);\n                    this.y = (this.y < 0) ? Math.ceil(this.y) : Math.floor(this.y);\n                    this.z = (this.z < 0) ? Math.ceil(this.z) : Math.floor(this.z);\n                    this.w = (this.w < 0) ? Math.ceil(this.w) : Math.floor(this.w);\n\n                    return this;\n\n                },\n\n                negate: function () {\n\n                    this.x = -this.x;\n                    this.y = -this.y;\n                    this.z = -this.z;\n                    this.w = -this.w;\n\n                    return this;\n\n                },\n\n                dot: function (v) {\n\n                    return this.x * v.x + this.y * v.y + this.z * v.z + this.w * v.w;\n\n                },\n\n                lengthSq: function () {\n\n                    return this.x * this.x + this.y * this.y + this.z * this.z + this.w * this.w;\n\n                },\n\n                length: function () {\n\n                    return Math.sqrt(this.x * this.x + this.y * this.y + this.z * this.z + this.w * this.w);\n\n                },\n\n                lengthManhattan: function () {\n\n                    return Math.abs(this.x) + Math.abs(this.y) + Math.abs(this.z) + Math.abs(this.w);\n\n                },\n\n                normalize: function () {\n\n                    return this.divideScalar(this.length());\n\n                },\n\n                setLength: function (length) {\n\n                    return this.multiplyScalar(length / this.length());\n\n                },\n\n                lerp: function (v, alpha) {\n\n                    this.x += (v.x - this.x) * alpha;\n                    this.y += (v.y - this.y) * alpha;\n                    this.z += (v.z - this.z) * alpha;\n                    this.w += (v.w - this.w) * alpha;\n\n                    return this;\n\n                },\n\n                lerpVectors: function (v1, v2, alpha) {\n\n                    return this.subVectors(v2, v1).multiplyScalar(alpha).add(v1);\n\n                },\n\n                equals: function (v) {\n\n                    return ((v.x === this.x) && (v.y === this.y) && (v.z === this.z) && (v.w === this.w));\n\n                },\n\n                fromArray: function (array, offset) {\n\n                    if (offset === undefined) offset = 0;\n\n                    this.x = array[offset];\n                    this.y = array[offset + 1];\n                    this.z = array[offset + 2];\n                    this.w = array[offset + 3];\n\n                    return this;\n\n                },\n\n                toArray: function (array, offset) {\n\n                    if (array === undefined) array = [];\n                    if (offset === undefined) offset = 0;\n\n                    array[offset] = this.x;\n                    array[offset + 1] = this.y;\n                    array[offset + 2] = this.z;\n                    array[offset + 3] = this.w;\n\n                    return array;\n\n                },\n\n                fromBufferAttribute: function (attribute, index, offset) {\n\n                    if (offset !== undefined) {\n\n                        console.warn('THREE.Vector4: offset has been removed from .fromBufferAttribute().');\n\n                    }\n\n                    this.x = attribute.getX(index);\n                    this.y = attribute.getY(index);\n                    this.z = attribute.getZ(index);\n                    this.w = attribute.getW(index);\n\n                    return this;\n\n                }\n\n            });\n\n            function Quaternion(x, y, z, w) {\n\n                this._x = x || 0;\n                this._y = y || 0;\n                this._z = z || 0;\n                this._w = (w !== undefined) ? w : 1;\n\n            }\n\n            Object.assign(Quaternion, {\n\n                slerp: function (qa, qb, qm, t) {\n\n                    return qm.copy(qa).slerp(qb, t);\n\n                },\n\n                slerpFlat: function (dst, dstOffset, src0, srcOffset0, src1, srcOffset1, t) {\n\n                    // fuzz-free, array-based Quaternion SLERP operation\n\n                    var x0 = src0[srcOffset0 + 0],\n                        y0 = src0[srcOffset0 + 1],\n                        z0 = src0[srcOffset0 + 2],\n                        w0 = src0[srcOffset0 + 3],\n\n                        x1 = src1[srcOffset1 + 0],\n                        y1 = src1[srcOffset1 + 1],\n                        z1 = src1[srcOffset1 + 2],\n                        w1 = src1[srcOffset1 + 3];\n\n                    if (w0 !== w1 || x0 !== x1 || y0 !== y1 || z0 !== z1) {\n\n                        var s = 1 - t,\n\n                            cos = x0 * x1 + y0 * y1 + z0 * z1 + w0 * w1,\n\n                            dir = (cos >= 0 ? 1 : -1),\n                            sqrSin = 1 - cos * cos;\n\n                        // Skip the Slerp for tiny steps to avoid numeric problems:\n                        if (sqrSin > Number.EPSILON) {\n\n                            var sin = Math.sqrt(sqrSin),\n                                len = Math.atan2(sin, cos * dir);\n\n                            s = Math.sin(s * len) / sin;\n                            t = Math.sin(t * len) / sin;\n\n                        }\n\n                        var tDir = t * dir;\n\n                        x0 = x0 * s + x1 * tDir;\n                        y0 = y0 * s + y1 * tDir;\n                        z0 = z0 * s + z1 * tDir;\n                        w0 = w0 * s + w1 * tDir;\n\n                        // Normalize in case we just did a lerp:\n                        if (s === 1 - t) {\n\n                            var f = 1 / Math.sqrt(x0 * x0 + y0 * y0 + z0 * z0 + w0 * w0);\n\n                            x0 *= f;\n                            y0 *= f;\n                            z0 *= f;\n                            w0 *= f;\n\n                        }\n\n                    }\n\n                    dst[dstOffset] = x0;\n                    dst[dstOffset + 1] = y0;\n                    dst[dstOffset + 2] = z0;\n                    dst[dstOffset + 3] = w0;\n\n                }\n\n            });\n\n            Object.defineProperties(Quaternion.prototype, {\n\n                x: {\n\n                    get: function () {\n\n                        return this._x;\n\n                    },\n\n                    set: function (value) {\n\n                        this._x = value;\n                        this.onChangeCallback();\n\n                    }\n\n                },\n\n                y: {\n\n                    get: function () {\n\n                        return this._y;\n\n                    },\n\n                    set: function (value) {\n\n                        this._y = value;\n                        this.onChangeCallback();\n\n                    }\n\n                },\n\n                z: {\n\n                    get: function () {\n\n                        return this._z;\n\n                    },\n\n                    set: function (value) {\n\n                        this._z = value;\n                        this.onChangeCallback();\n\n                    }\n\n                },\n\n                w: {\n\n                    get: function () {\n\n                        return this._w;\n\n                    },\n\n                    set: function (value) {\n\n                        this._w = value;\n                        this.onChangeCallback();\n\n                    }\n\n                }\n\n            });\n\n            Object.assign(Quaternion.prototype, {\n\n                set: function (x, y, z, w) {\n\n                    this._x = x;\n                    this._y = y;\n                    this._z = z;\n                    this._w = w;\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                clone: function () {\n\n                    return new this.constructor(this._x, this._y, this._z, this._w);\n\n                },\n\n                copy: function (quaternion) {\n\n                    this._x = quaternion.x;\n                    this._y = quaternion.y;\n                    this._z = quaternion.z;\n                    this._w = quaternion.w;\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                setFromEuler: function (euler, update) {\n\n                    if ((euler && euler.isEuler) === false) {\n\n                        throw new Error('THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.');\n\n                    }\n\n                    var x = euler._x,\n                        y = euler._y,\n                        z = euler._z,\n                        order = euler.order;\n\n                    // http://www.mathworks.com/matlabcentral/fileexchange/\n                    // \t20696-function-to-convert-between-dcm-euler-angles-quaternions-and-euler-vectors/\n                    //\tcontent/SpinCalc.m\n\n                    var cos = Math.cos;\n                    var sin = Math.sin;\n\n                    var c1 = cos(x / 2);\n                    var c2 = cos(y / 2);\n                    var c3 = cos(z / 2);\n\n                    var s1 = sin(x / 2);\n                    var s2 = sin(y / 2);\n                    var s3 = sin(z / 2);\n\n                    if (order === 'XYZ') {\n\n                        this._x = s1 * c2 * c3 + c1 * s2 * s3;\n                        this._y = c1 * s2 * c3 - s1 * c2 * s3;\n                        this._z = c1 * c2 * s3 + s1 * s2 * c3;\n                        this._w = c1 * c2 * c3 - s1 * s2 * s3;\n\n                    } else if (order === 'YXZ') {\n\n                        this._x = s1 * c2 * c3 + c1 * s2 * s3;\n                        this._y = c1 * s2 * c3 - s1 * c2 * s3;\n                        this._z = c1 * c2 * s3 - s1 * s2 * c3;\n                        this._w = c1 * c2 * c3 + s1 * s2 * s3;\n\n                    } else if (order === 'ZXY') {\n\n                        this._x = s1 * c2 * c3 - c1 * s2 * s3;\n                        this._y = c1 * s2 * c3 + s1 * c2 * s3;\n                        this._z = c1 * c2 * s3 + s1 * s2 * c3;\n                        this._w = c1 * c2 * c3 - s1 * s2 * s3;\n\n                    } else if (order === 'ZYX') {\n\n                        this._x = s1 * c2 * c3 - c1 * s2 * s3;\n                        this._y = c1 * s2 * c3 + s1 * c2 * s3;\n                        this._z = c1 * c2 * s3 - s1 * s2 * c3;\n                        this._w = c1 * c2 * c3 + s1 * s2 * s3;\n\n                    } else if (order === 'YZX') {\n\n                        this._x = s1 * c2 * c3 + c1 * s2 * s3;\n                        this._y = c1 * s2 * c3 + s1 * c2 * s3;\n                        this._z = c1 * c2 * s3 - s1 * s2 * c3;\n                        this._w = c1 * c2 * c3 - s1 * s2 * s3;\n\n                    } else if (order === 'XZY') {\n\n                        this._x = s1 * c2 * c3 - c1 * s2 * s3;\n                        this._y = c1 * s2 * c3 - s1 * c2 * s3;\n                        this._z = c1 * c2 * s3 + s1 * s2 * c3;\n                        this._w = c1 * c2 * c3 + s1 * s2 * s3;\n\n                    }\n\n                    if (update !== false) this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                setFromAxisAngle: function (axis, angle) {\n\n                    // http://www.euclideanspace.com/maths/geometry/rotations/conversions/angleToQuaternion/index.htm\n\n                    // assumes axis is normalized\n\n                    var halfAngle = angle / 2,\n                        s = Math.sin(halfAngle);\n\n                    this._x = axis.x * s;\n                    this._y = axis.y * s;\n                    this._z = axis.z * s;\n                    this._w = Math.cos(halfAngle);\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                setFromRotationMatrix: function (m) {\n\n                    // http://www.euclideanspace.com/maths/geometry/rotations/conversions/matrixToQuaternion/index.htm\n\n                    // assumes the upper 3x3 of m is a pure rotation matrix (i.e, unscaled)\n\n                    var te = m.elements,\n\n                        m11 = te[0],\n                        m12 = te[4],\n                        m13 = te[8],\n                        m21 = te[1],\n                        m22 = te[5],\n                        m23 = te[9],\n                        m31 = te[2],\n                        m32 = te[6],\n                        m33 = te[10],\n\n                        trace = m11 + m22 + m33,\n                        s;\n\n                    if (trace > 0) {\n\n                        s = 0.5 / Math.sqrt(trace + 1.0);\n\n                        this._w = 0.25 / s;\n                        this._x = (m32 - m23) * s;\n                        this._y = (m13 - m31) * s;\n                        this._z = (m21 - m12) * s;\n\n                    } else if (m11 > m22 && m11 > m33) {\n\n                        s = 2.0 * Math.sqrt(1.0 + m11 - m22 - m33);\n\n                        this._w = (m32 - m23) / s;\n                        this._x = 0.25 * s;\n                        this._y = (m12 + m21) / s;\n                        this._z = (m13 + m31) / s;\n\n                    } else if (m22 > m33) {\n\n                        s = 2.0 * Math.sqrt(1.0 + m22 - m11 - m33);\n\n                        this._w = (m13 - m31) / s;\n                        this._x = (m12 + m21) / s;\n                        this._y = 0.25 * s;\n                        this._z = (m23 + m32) / s;\n\n                    } else {\n\n                        s = 2.0 * Math.sqrt(1.0 + m33 - m11 - m22);\n\n                        this._w = (m21 - m12) / s;\n                        this._x = (m13 + m31) / s;\n                        this._y = (m23 + m32) / s;\n                        this._z = 0.25 * s;\n\n                    }\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                setFromUnitVectors: function () {\n\n                    // assumes direction vectors vFrom and vTo are normalized\n\n                    var v1 = new Vector3();\n                    var r;\n\n                    var EPS = 0.000001;\n\n                    return function setFromUnitVectors(vFrom, vTo) {\n\n                        if (v1 === undefined) v1 = new Vector3();\n\n                        r = vFrom.dot(vTo) + 1;\n\n                        if (r < EPS) {\n\n                            r = 0;\n\n                            if (Math.abs(vFrom.x) > Math.abs(vFrom.z)) {\n\n                                v1.set(-vFrom.y, vFrom.x, 0);\n\n                            } else {\n\n                                v1.set(0, -vFrom.z, vFrom.y);\n\n                            }\n\n                        } else {\n\n                            v1.crossVectors(vFrom, vTo);\n\n                        }\n\n                        this._x = v1.x;\n                        this._y = v1.y;\n                        this._z = v1.z;\n                        this._w = r;\n\n                        return this.normalize();\n\n                    };\n\n                }(),\n\n                inverse: function () {\n\n                    return this.conjugate().normalize();\n\n                },\n\n                conjugate: function () {\n\n                    this._x *= -1;\n                    this._y *= -1;\n                    this._z *= -1;\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                dot: function (v) {\n\n                    return this._x * v._x + this._y * v._y + this._z * v._z + this._w * v._w;\n\n                },\n\n                lengthSq: function () {\n\n                    return this._x * this._x + this._y * this._y + this._z * this._z + this._w * this._w;\n\n                },\n\n                length: function () {\n\n                    return Math.sqrt(this._x * this._x + this._y * this._y + this._z * this._z + this._w * this._w);\n\n                },\n\n                normalize: function () {\n\n                    var l = this.length();\n\n                    if (l === 0) {\n\n                        this._x = 0;\n                        this._y = 0;\n                        this._z = 0;\n                        this._w = 1;\n\n                    } else {\n\n                        l = 1 / l;\n\n                        this._x = this._x * l;\n                        this._y = this._y * l;\n                        this._z = this._z * l;\n                        this._w = this._w * l;\n\n                    }\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                multiply: function (q, p) {\n\n                    if (p !== undefined) {\n\n                        console.warn('THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead.');\n                        return this.multiplyQuaternions(q, p);\n\n                    }\n\n                    return this.multiplyQuaternions(this, q);\n\n                },\n\n                premultiply: function (q) {\n\n                    return this.multiplyQuaternions(q, this);\n\n                },\n\n                multiplyQuaternions: function (a, b) {\n\n                    // from http://www.euclideanspace.com/maths/algebra/realNormedAlgebra/quaternions/code/index.htm\n\n                    var qax = a._x,\n                        qay = a._y,\n                        qaz = a._z,\n                        qaw = a._w;\n                    var qbx = b._x,\n                        qby = b._y,\n                        qbz = b._z,\n                        qbw = b._w;\n\n                    this._x = qax * qbw + qaw * qbx + qay * qbz - qaz * qby;\n                    this._y = qay * qbw + qaw * qby + qaz * qbx - qax * qbz;\n                    this._z = qaz * qbw + qaw * qbz + qax * qby - qay * qbx;\n                    this._w = qaw * qbw - qax * qbx - qay * qby - qaz * qbz;\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                slerp: function (qb, t) {\n\n                    if (t === 0) return this;\n                    if (t === 1) return this.copy(qb);\n\n                    var x = this._x,\n                        y = this._y,\n                        z = this._z,\n                        w = this._w;\n\n                    // http://www.euclideanspace.com/maths/algebra/realNormedAlgebra/quaternions/slerp/\n\n                    var cosHalfTheta = w * qb._w + x * qb._x + y * qb._y + z * qb._z;\n\n                    if (cosHalfTheta < 0) {\n\n                        this._w = -qb._w;\n                        this._x = -qb._x;\n                        this._y = -qb._y;\n                        this._z = -qb._z;\n\n                        cosHalfTheta = -cosHalfTheta;\n\n                    } else {\n\n                        this.copy(qb);\n\n                    }\n\n                    if (cosHalfTheta >= 1.0) {\n\n                        this._w = w;\n                        this._x = x;\n                        this._y = y;\n                        this._z = z;\n\n                        return this;\n\n                    }\n\n                    var sinHalfTheta = Math.sqrt(1.0 - cosHalfTheta * cosHalfTheta);\n\n                    if (Math.abs(sinHalfTheta) < 0.001) {\n\n                        this._w = 0.5 * (w + this._w);\n                        this._x = 0.5 * (x + this._x);\n                        this._y = 0.5 * (y + this._y);\n                        this._z = 0.5 * (z + this._z);\n\n                        return this;\n\n                    }\n\n                    var halfTheta = Math.atan2(sinHalfTheta, cosHalfTheta);\n                    var ratioA = Math.sin((1 - t) * halfTheta) / sinHalfTheta,\n                        ratioB = Math.sin(t * halfTheta) / sinHalfTheta;\n\n                    this._w = (w * ratioA + this._w * ratioB);\n                    this._x = (x * ratioA + this._x * ratioB);\n                    this._y = (y * ratioA + this._y * ratioB);\n                    this._z = (z * ratioA + this._z * ratioB);\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                equals: function (quaternion) {\n\n                    return (quaternion._x === this._x) && (quaternion._y === this._y) && (quaternion._z === this._z) && (quaternion._w === this._w);\n\n                },\n\n                fromArray: function (array, offset) {\n\n                    if (offset === undefined) offset = 0;\n\n                    this._x = array[offset];\n                    this._y = array[offset + 1];\n                    this._z = array[offset + 2];\n                    this._w = array[offset + 3];\n\n                    this.onChangeCallback();\n\n                    return this;\n\n                },\n\n                toArray: function (array, offset) {\n\n                    if (array === undefined) array = [];\n                    if (offset === undefined) offset = 0;\n\n                    array[offset] = this._x;\n                    array[offset + 1] = this._y;\n                    array[offset + 2] = this._z;\n                    array[offset + 3] = this._w;\n\n                    return array;\n\n                },\n\n                onChange: function (callback) {\n\n                    this.onChangeCallback = callback;\n\n                    return this;\n\n                },\n\n                onChangeCallback: function () {}\n\n            });\n\n            function Matrix4() {\n\n                this.elements = [\n\n                    1, 0, 0, 0,\n                    0, 1, 0, 0,\n                    0, 0, 1, 0,\n                    0, 0, 0, 1\n\n                ];\n\n                if (arguments.length > 0) {\n\n                    console.error('THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.');\n\n                }\n\n            }\n\n            Object.assign(Matrix4.prototype, {\n\n                isMatrix4: true,\n\n                set: function (n11, n12, n13, n14, n21, n22, n23, n24, n31, n32, n33, n34, n41, n42, n43, n44) {\n\n                    var te = this.elements;\n\n                    te[0] = n11;\n                    te[4] = n12;\n                    te[8] = n13;\n                    te[12] = n14;\n                    te[1] = n21;\n                    te[5] = n22;\n                    te[9] = n23;\n                    te[13] = n24;\n                    te[2] = n31;\n                    te[6] = n32;\n                    te[10] = n33;\n                    te[14] = n34;\n                    te[3] = n41;\n                    te[7] = n42;\n                    te[11] = n43;\n                    te[15] = n44;\n\n                    return this;\n\n                },\n\n                identity: function () {\n\n                    this.set(\n\n                        1, 0, 0, 0,\n                        0, 1, 0, 0,\n                        0, 0, 1, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                clone: function () {\n\n                    return new Matrix4().fromArray(this.elements);\n\n                },\n\n                copy: function (m) {\n\n                    var te = this.elements;\n                    var me = m.elements;\n\n                    te[0] = me[0];\n                    te[1] = me[1];\n                    te[2] = me[2];\n                    te[3] = me[3];\n                    te[4] = me[4];\n                    te[5] = me[5];\n                    te[6] = me[6];\n                    te[7] = me[7];\n                    te[8] = me[8];\n                    te[9] = me[9];\n                    te[10] = me[10];\n                    te[11] = me[11];\n                    te[12] = me[12];\n                    te[13] = me[13];\n                    te[14] = me[14];\n                    te[15] = me[15];\n\n                    return this;\n\n                },\n\n                copyPosition: function (m) {\n\n                    var te = this.elements,\n                        me = m.elements;\n\n                    te[12] = me[12];\n                    te[13] = me[13];\n                    te[14] = me[14];\n\n                    return this;\n\n                },\n\n                extractBasis: function (xAxis, yAxis, zAxis) {\n\n                    xAxis.setFromMatrixColumn(this, 0);\n                    yAxis.setFromMatrixColumn(this, 1);\n                    zAxis.setFromMatrixColumn(this, 2);\n\n                    return this;\n\n                },\n\n                makeBasis: function (xAxis, yAxis, zAxis) {\n\n                    this.set(\n                        xAxis.x, yAxis.x, zAxis.x, 0,\n                        xAxis.y, yAxis.y, zAxis.y, 0,\n                        xAxis.z, yAxis.z, zAxis.z, 0,\n                        0, 0, 0, 1\n                    );\n\n                    return this;\n\n                },\n\n                extractRotation: function () {\n\n                    var v1 = new Vector3();\n\n                    return function extractRotation(m) {\n\n                        var te = this.elements;\n                        var me = m.elements;\n\n                        var scaleX = 1 / v1.setFromMatrixColumn(m, 0).length();\n                        var scaleY = 1 / v1.setFromMatrixColumn(m, 1).length();\n                        var scaleZ = 1 / v1.setFromMatrixColumn(m, 2).length();\n\n                        te[0] = me[0] * scaleX;\n                        te[1] = me[1] * scaleX;\n                        te[2] = me[2] * scaleX;\n\n                        te[4] = me[4] * scaleY;\n                        te[5] = me[5] * scaleY;\n                        te[6] = me[6] * scaleY;\n\n                        te[8] = me[8] * scaleZ;\n                        te[9] = me[9] * scaleZ;\n                        te[10] = me[10] * scaleZ;\n\n                        return this;\n\n                    };\n\n                }(),\n\n                makeRotationFromEuler: function (euler) {\n\n                    if ((euler && euler.isEuler) === false) {\n\n                        console.error('THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.');\n\n                    }\n\n                    var te = this.elements;\n\n                    var x = euler.x,\n                        y = euler.y,\n                        z = euler.z;\n                    var a = Math.cos(x),\n                        b = Math.sin(x);\n                    var c = Math.cos(y),\n                        d = Math.sin(y);\n                    var e = Math.cos(z),\n                        f = Math.sin(z);\n\n                    if (euler.order === 'XYZ') {\n\n                        var ae = a * e,\n                            af = a * f,\n                            be = b * e,\n                            bf = b * f;\n\n                        te[0] = c * e;\n                        te[4] = -c * f;\n                        te[8] = d;\n\n                        te[1] = af + be * d;\n                        te[5] = ae - bf * d;\n                        te[9] = -b * c;\n\n                        te[2] = bf - ae * d;\n                        te[6] = be + af * d;\n                        te[10] = a * c;\n\n                    } else if (euler.order === 'YXZ') {\n\n                        var ce = c * e,\n                            cf = c * f,\n                            de = d * e,\n                            df = d * f;\n\n                        te[0] = ce + df * b;\n                        te[4] = de * b - cf;\n                        te[8] = a * d;\n\n                        te[1] = a * f;\n                        te[5] = a * e;\n                        te[9] = -b;\n\n                        te[2] = cf * b - de;\n                        te[6] = df + ce * b;\n                        te[10] = a * c;\n\n                    } else if (euler.order === 'ZXY') {\n\n                        var ce = c * e,\n                            cf = c * f,\n                            de = d * e,\n                            df = d * f;\n\n                        te[0] = ce - df * b;\n                        te[4] = -a * f;\n                        te[8] = de + cf * b;\n\n                        te[1] = cf + de * b;\n                        te[5] = a * e;\n                        te[9] = df - ce * b;\n\n                        te[2] = -a * d;\n                        te[6] = b;\n                        te[10] = a * c;\n\n                    } else if (euler.order === 'ZYX') {\n\n                        var ae = a * e,\n                            af = a * f,\n                            be = b * e,\n                            bf = b * f;\n\n                        te[0] = c * e;\n                        te[4] = be * d - af;\n                        te[8] = ae * d + bf;\n\n                        te[1] = c * f;\n                        te[5] = bf * d + ae;\n                        te[9] = af * d - be;\n\n                        te[2] = -d;\n                        te[6] = b * c;\n                        te[10] = a * c;\n\n                    } else if (euler.order === 'YZX') {\n\n                        var ac = a * c,\n                            ad = a * d,\n                            bc = b * c,\n                            bd = b * d;\n\n                        te[0] = c * e;\n                        te[4] = bd - ac * f;\n                        te[8] = bc * f + ad;\n\n                        te[1] = f;\n                        te[5] = a * e;\n                        te[9] = -b * e;\n\n                        te[2] = -d * e;\n                        te[6] = ad * f + bc;\n                        te[10] = ac - bd * f;\n\n                    } else if (euler.order === 'XZY') {\n\n                        var ac = a * c,\n                            ad = a * d,\n                            bc = b * c,\n                            bd = b * d;\n\n                        te[0] = c * e;\n                        te[4] = -f;\n                        te[8] = d * e;\n\n                        te[1] = ac * f + bd;\n                        te[5] = a * e;\n                        te[9] = ad * f - bc;\n\n                        te[2] = bc * f - ad;\n                        te[6] = b * e;\n                        te[10] = bd * f + ac;\n\n                    }\n\n                    // last column\n                    te[3] = 0;\n                    te[7] = 0;\n                    te[11] = 0;\n\n                    // bottom row\n                    te[12] = 0;\n                    te[13] = 0;\n                    te[14] = 0;\n                    te[15] = 1;\n\n                    return this;\n\n                },\n\n                makeRotationFromQuaternion: function (q) {\n\n                    var te = this.elements;\n\n                    var x = q._x,\n                        y = q._y,\n                        z = q._z,\n                        w = q._w;\n                    var x2 = x + x,\n                        y2 = y + y,\n                        z2 = z + z;\n                    var xx = x * x2,\n                        xy = x * y2,\n                        xz = x * z2;\n                    var yy = y * y2,\n                        yz = y * z2,\n                        zz = z * z2;\n                    var wx = w * x2,\n                        wy = w * y2,\n                        wz = w * z2;\n\n                    te[0] = 1 - (yy + zz);\n                    te[4] = xy - wz;\n                    te[8] = xz + wy;\n\n                    te[1] = xy + wz;\n                    te[5] = 1 - (xx + zz);\n                    te[9] = yz - wx;\n\n                    te[2] = xz - wy;\n                    te[6] = yz + wx;\n                    te[10] = 1 - (xx + yy);\n\n                    // last column\n                    te[3] = 0;\n                    te[7] = 0;\n                    te[11] = 0;\n\n                    // bottom row\n                    te[12] = 0;\n                    te[13] = 0;\n                    te[14] = 0;\n                    te[15] = 1;\n\n                    return this;\n\n                },\n\n                lookAt: function () {\n\n                    var x = new Vector3();\n                    var y = new Vector3();\n                    var z = new Vector3();\n\n                    return function lookAt(eye, target, up) {\n\n                        var te = this.elements;\n\n                        z.subVectors(eye, target);\n\n                        if (z.lengthSq() === 0) {\n\n                            // eye and target are in the same position\n\n                            z.z = 1;\n\n                        }\n\n                        z.normalize();\n                        x.crossVectors(up, z);\n\n                        if (x.lengthSq() === 0) {\n\n                            // eye and target are in the same vertical\n\n                            z.z += 0.0001;\n                            x.crossVectors(up, z);\n\n                        }\n\n                        x.normalize();\n                        y.crossVectors(z, x);\n\n                        te[0] = x.x;\n                        te[4] = y.x;\n                        te[8] = z.x;\n                        te[1] = x.y;\n                        te[5] = y.y;\n                        te[9] = z.y;\n                        te[2] = x.z;\n                        te[6] = y.z;\n                        te[10] = z.z;\n\n                        return this;\n\n                    };\n\n                }(),\n\n                multiply: function (m, n) {\n\n                    if (n !== undefined) {\n\n                        console.warn('THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead.');\n                        return this.multiplyMatrices(m, n);\n\n                    }\n\n                    return this.multiplyMatrices(this, m);\n\n                },\n\n                premultiply: function (m) {\n\n                    return this.multiplyMatrices(m, this);\n\n                },\n\n                multiplyMatrices: function (a, b) {\n\n                    var ae = a.elements;\n                    var be = b.elements;\n                    var te = this.elements;\n\n                    var a11 = ae[0],\n                        a12 = ae[4],\n                        a13 = ae[8],\n                        a14 = ae[12];\n                    var a21 = ae[1],\n                        a22 = ae[5],\n                        a23 = ae[9],\n                        a24 = ae[13];\n                    var a31 = ae[2],\n                        a32 = ae[6],\n                        a33 = ae[10],\n                        a34 = ae[14];\n                    var a41 = ae[3],\n                        a42 = ae[7],\n                        a43 = ae[11],\n                        a44 = ae[15];\n\n                    var b11 = be[0],\n                        b12 = be[4],\n                        b13 = be[8],\n                        b14 = be[12];\n                    var b21 = be[1],\n                        b22 = be[5],\n                        b23 = be[9],\n                        b24 = be[13];\n                    var b31 = be[2],\n                        b32 = be[6],\n                        b33 = be[10],\n                        b34 = be[14];\n                    var b41 = be[3],\n                        b42 = be[7],\n                        b43 = be[11],\n                        b44 = be[15];\n\n                    te[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;\n                    te[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;\n                    te[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;\n                    te[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;\n\n                    te[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;\n                    te[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;\n                    te[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;\n                    te[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;\n\n                    te[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;\n                    te[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;\n                    te[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;\n                    te[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;\n\n                    te[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;\n                    te[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;\n                    te[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;\n                    te[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;\n\n                    return this;\n\n                },\n\n                multiplyScalar: function (s) {\n\n                    var te = this.elements;\n\n                    te[0] *= s;\n                    te[4] *= s;\n                    te[8] *= s;\n                    te[12] *= s;\n                    te[1] *= s;\n                    te[5] *= s;\n                    te[9] *= s;\n                    te[13] *= s;\n                    te[2] *= s;\n                    te[6] *= s;\n                    te[10] *= s;\n                    te[14] *= s;\n                    te[3] *= s;\n                    te[7] *= s;\n                    te[11] *= s;\n                    te[15] *= s;\n\n                    return this;\n\n                },\n\n                applyToBufferAttribute: function () {\n\n                    var v1 = new Vector3();\n\n                    return function applyToBufferAttribute(attribute) {\n\n                        for (var i = 0, l = attribute.count; i < l; i++) {\n\n                            v1.x = attribute.getX(i);\n                            v1.y = attribute.getY(i);\n                            v1.z = attribute.getZ(i);\n\n                            v1.applyMatrix4(this);\n\n                            attribute.setXYZ(i, v1.x, v1.y, v1.z);\n\n                        }\n\n                        return attribute;\n\n                    };\n\n                }(),\n\n                determinant: function () {\n\n                    var te = this.elements;\n\n                    var n11 = te[0],\n                        n12 = te[4],\n                        n13 = te[8],\n                        n14 = te[12];\n                    var n21 = te[1],\n                        n22 = te[5],\n                        n23 = te[9],\n                        n24 = te[13];\n                    var n31 = te[2],\n                        n32 = te[6],\n                        n33 = te[10],\n                        n34 = te[14];\n                    var n41 = te[3],\n                        n42 = te[7],\n                        n43 = te[11],\n                        n44 = te[15];\n\n                    //TODO: make this more efficient\n                    //( based on http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm )\n\n                    return (\n                        n41 * (\n                            +n14 * n23 * n32 -\n                            n13 * n24 * n32 -\n                            n14 * n22 * n33 +\n                            n12 * n24 * n33 +\n                            n13 * n22 * n34 -\n                            n12 * n23 * n34\n                        ) +\n                        n42 * (\n                            +n11 * n23 * n34 -\n                            n11 * n24 * n33 +\n                            n14 * n21 * n33 -\n                            n13 * n21 * n34 +\n                            n13 * n24 * n31 -\n                            n14 * n23 * n31\n                        ) +\n                        n43 * (\n                            +n11 * n24 * n32 -\n                            n11 * n22 * n34 -\n                            n14 * n21 * n32 +\n                            n12 * n21 * n34 +\n                            n14 * n22 * n31 -\n                            n12 * n24 * n31\n                        ) +\n                        n44 * (\n                            -n13 * n22 * n31 -\n                            n11 * n23 * n32 +\n                            n11 * n22 * n33 +\n                            n13 * n21 * n32 -\n                            n12 * n21 * n33 +\n                            n12 * n23 * n31\n                        )\n\n                    );\n\n                },\n\n                transpose: function () {\n\n                    var te = this.elements;\n                    var tmp;\n\n                    tmp = te[1];\n                    te[1] = te[4];\n                    te[4] = tmp;\n                    tmp = te[2];\n                    te[2] = te[8];\n                    te[8] = tmp;\n                    tmp = te[6];\n                    te[6] = te[9];\n                    te[9] = tmp;\n\n                    tmp = te[3];\n                    te[3] = te[12];\n                    te[12] = tmp;\n                    tmp = te[7];\n                    te[7] = te[13];\n                    te[13] = tmp;\n                    tmp = te[11];\n                    te[11] = te[14];\n                    te[14] = tmp;\n\n                    return this;\n\n                },\n\n                setPosition: function (v) {\n\n                    var te = this.elements;\n\n                    te[12] = v.x;\n                    te[13] = v.y;\n                    te[14] = v.z;\n\n                    return this;\n\n                },\n\n                getInverse: function (m, throwOnDegenerate) {\n\n                    // based on http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm\n                    var te = this.elements,\n                        me = m.elements,\n\n                        n11 = me[0],\n                        n21 = me[1],\n                        n31 = me[2],\n                        n41 = me[3],\n                        n12 = me[4],\n                        n22 = me[5],\n                        n32 = me[6],\n                        n42 = me[7],\n                        n13 = me[8],\n                        n23 = me[9],\n                        n33 = me[10],\n                        n43 = me[11],\n                        n14 = me[12],\n                        n24 = me[13],\n                        n34 = me[14],\n                        n44 = me[15],\n\n                        t11 = n23 * n34 * n42 - n24 * n33 * n42 + n24 * n32 * n43 - n22 * n34 * n43 - n23 * n32 * n44 + n22 * n33 * n44,\n                        t12 = n14 * n33 * n42 - n13 * n34 * n42 - n14 * n32 * n43 + n12 * n34 * n43 + n13 * n32 * n44 - n12 * n33 * n44,\n                        t13 = n13 * n24 * n42 - n14 * n23 * n42 + n14 * n22 * n43 - n12 * n24 * n43 - n13 * n22 * n44 + n12 * n23 * n44,\n                        t14 = n14 * n23 * n32 - n13 * n24 * n32 - n14 * n22 * n33 + n12 * n24 * n33 + n13 * n22 * n34 - n12 * n23 * n34;\n\n                    var det = n11 * t11 + n21 * t12 + n31 * t13 + n41 * t14;\n\n                    if (det === 0) {\n\n                        var msg = \"THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0\";\n\n                        if (throwOnDegenerate === true) {\n\n                            throw new Error(msg);\n\n                        } else {\n\n                            console.warn(msg);\n\n                        }\n\n                        return this.identity();\n\n                    }\n\n                    var detInv = 1 / det;\n\n                    te[0] = t11 * detInv;\n                    te[1] = (n24 * n33 * n41 - n23 * n34 * n41 - n24 * n31 * n43 + n21 * n34 * n43 + n23 * n31 * n44 - n21 * n33 * n44) * detInv;\n                    te[2] = (n22 * n34 * n41 - n24 * n32 * n41 + n24 * n31 * n42 - n21 * n34 * n42 - n22 * n31 * n44 + n21 * n32 * n44) * detInv;\n                    te[3] = (n23 * n32 * n41 - n22 * n33 * n41 - n23 * n31 * n42 + n21 * n33 * n42 + n22 * n31 * n43 - n21 * n32 * n43) * detInv;\n\n                    te[4] = t12 * detInv;\n                    te[5] = (n13 * n34 * n41 - n14 * n33 * n41 + n14 * n31 * n43 - n11 * n34 * n43 - n13 * n31 * n44 + n11 * n33 * n44) * detInv;\n                    te[6] = (n14 * n32 * n41 - n12 * n34 * n41 - n14 * n31 * n42 + n11 * n34 * n42 + n12 * n31 * n44 - n11 * n32 * n44) * detInv;\n                    te[7] = (n12 * n33 * n41 - n13 * n32 * n41 + n13 * n31 * n42 - n11 * n33 * n42 - n12 * n31 * n43 + n11 * n32 * n43) * detInv;\n\n                    te[8] = t13 * detInv;\n                    te[9] = (n14 * n23 * n41 - n13 * n24 * n41 - n14 * n21 * n43 + n11 * n24 * n43 + n13 * n21 * n44 - n11 * n23 * n44) * detInv;\n                    te[10] = (n12 * n24 * n41 - n14 * n22 * n41 + n14 * n21 * n42 - n11 * n24 * n42 - n12 * n21 * n44 + n11 * n22 * n44) * detInv;\n                    te[11] = (n13 * n22 * n41 - n12 * n23 * n41 - n13 * n21 * n42 + n11 * n23 * n42 + n12 * n21 * n43 - n11 * n22 * n43) * detInv;\n\n                    te[12] = t14 * detInv;\n                    te[13] = (n13 * n24 * n31 - n14 * n23 * n31 + n14 * n21 * n33 - n11 * n24 * n33 - n13 * n21 * n34 + n11 * n23 * n34) * detInv;\n                    te[14] = (n14 * n22 * n31 - n12 * n24 * n31 - n14 * n21 * n32 + n11 * n24 * n32 + n12 * n21 * n34 - n11 * n22 * n34) * detInv;\n                    te[15] = (n12 * n23 * n31 - n13 * n22 * n31 + n13 * n21 * n32 - n11 * n23 * n32 - n12 * n21 * n33 + n11 * n22 * n33) * detInv;\n\n                    return this;\n\n                },\n\n                scale: function (v) {\n\n                    var te = this.elements;\n                    var x = v.x,\n                        y = v.y,\n                        z = v.z;\n\n                    te[0] *= x;\n                    te[4] *= y;\n                    te[8] *= z;\n                    te[1] *= x;\n                    te[5] *= y;\n                    te[9] *= z;\n                    te[2] *= x;\n                    te[6] *= y;\n                    te[10] *= z;\n                    te[3] *= x;\n                    te[7] *= y;\n                    te[11] *= z;\n\n                    return this;\n\n                },\n\n                getMaxScaleOnAxis: function () {\n\n                    var te = this.elements;\n\n                    var scaleXSq = te[0] * te[0] + te[1] * te[1] + te[2] * te[2];\n                    var scaleYSq = te[4] * te[4] + te[5] * te[5] + te[6] * te[6];\n                    var scaleZSq = te[8] * te[8] + te[9] * te[9] + te[10] * te[10];\n\n                    return Math.sqrt(Math.max(scaleXSq, scaleYSq, scaleZSq));\n\n                },\n\n                makeTranslation: function (x, y, z) {\n\n                    this.set(\n\n                        1, 0, 0, x,\n                        0, 1, 0, y,\n                        0, 0, 1, z,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                makeRotationX: function (theta) {\n\n                    var c = Math.cos(theta),\n                        s = Math.sin(theta);\n\n                    this.set(\n\n                        1, 0, 0, 0,\n                        0, c, -s, 0,\n                        0, s, c, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                makeRotationY: function (theta) {\n\n                    var c = Math.cos(theta),\n                        s = Math.sin(theta);\n\n                    this.set(\n\n                        c, 0, s, 0,\n                        0, 1, 0, 0,\n                        -s, 0, c, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                makeRotationZ: function (theta) {\n\n                    var c = Math.cos(theta),\n                        s = Math.sin(theta);\n\n                    this.set(\n\n                        c, -s, 0, 0,\n                        s, c, 0, 0,\n                        0, 0, 1, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                makeRotationAxis: function (axis, angle) {\n\n                    // Based on http://www.gamedev.net/reference/articles/article1199.asp\n\n                    var c = Math.cos(angle);\n                    var s = Math.sin(angle);\n                    var t = 1 - c;\n                    var x = axis.x,\n                        y = axis.y,\n                        z = axis.z;\n                    var tx = t * x,\n                        ty = t * y;\n\n                    this.set(\n\n                        tx * x + c, tx * y - s * z, tx * z + s * y, 0,\n                        tx * y + s * z, ty * y + c, ty * z - s * x, 0,\n                        tx * z - s * y, ty * z + s * x, t * z * z + c, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                makeScale: function (x, y, z) {\n\n                    this.set(\n\n                        x, 0, 0, 0,\n                        0, y, 0, 0,\n                        0, 0, z, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                makeShear: function (x, y, z) {\n\n                    this.set(\n\n                        1, y, z, 0,\n                        x, 1, z, 0,\n                        x, y, 1, 0,\n                        0, 0, 0, 1\n\n                    );\n\n                    return this;\n\n                },\n\n                compose: function (position, quaternion, scale) {\n\n                    this.makeRotationFromQuaternion(quaternion);\n                    this.scale(scale);\n                    this.setPosition(position);\n\n                    return this;\n\n                },\n\n                decompose: function () {\n\n                    var vector = new Vector3();\n                    var matrix = new Matrix4();\n\n                    return function decompose(position, quaternion, scale) {\n\n                        var te = this.elements;\n\n                        var sx = vector.set(te[0], te[1], te[2]).length();\n                        var sy = vector.set(te[4], te[5], te[6]).length();\n                        var sz = vector.set(te[8], te[9], te[10]).length();\n\n                        // if determine is negative, we need to invert one scale\n                        var det = this.determinant();\n                        if (det < 0) sx = -sx;\n\n                        position.x = te[12];\n                        position.y = te[13];\n                        position.z = te[14];\n\n                        // scale the rotation part\n                        matrix.copy(this);\n\n                        var invSX = 1 / sx;\n                        var invSY = 1 / sy;\n                        var invSZ = 1 / sz;\n\n                        matrix.elements[0] *= invSX;\n                        matrix.elements[1] *= invSX;\n                        matrix.elements[2] *= invSX;\n\n                        matrix.elements[4] *= invSY;\n                        matrix.elements[5] *= invSY;\n                        matrix.elements[6] *= invSY;\n\n                        matrix.elements[8] *= invSZ;\n                        matrix.elements[9] *= invSZ;\n                        matrix.elements[10] *= invSZ;\n\n                        quaternion.setFromRotationMatrix(matrix);\n\n                        scale.x = sx;\n                        scale.y = sy;\n                        scale.z = sz;\n\n                        return this;\n\n                    };\n\n                }(),\n\n                makePerspective: function (left, right, top, bottom, near, far) {\n\n                    if (far === undefined) {\n\n                        console.warn('THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.');\n\n                    }\n\n                    var te = this.elements;\n                    var x = 2 * near / (right - left);\n                    var y = 2 * near / (top - bottom);\n\n                    var a = (right + left) / (right - left);\n                    var b = (top + bottom) / (top - bottom);\n                    var c = -(far + near) / (far - near);\n                    var d = -2 * far * near / (far - near);\n\n                    te[0] = x;\n                    te[4] = 0;\n                    te[8] = a;\n                    te[12] = 0;\n                    te[1] = 0;\n                    te[5] = y;\n                    te[9] = b;\n                    te[13] = 0;\n                    te[2] = 0;\n                    te[6] = 0;\n                    te[10] = c;\n                    te[14] = d;\n                    te[3] = 0;\n                    te[7] = 0;\n                    te[11] = -1;\n                    te[15] = 0;\n\n                    return this;\n\n                },\n\n                makeOrthographic: function (left, right, top, bottom, near, far) {\n\n                    var te = this.elements;\n                    var w = 1.0 / (right - left);\n                    var h = 1.0 / (top - bottom);\n                    var p = 1.0 / (far - near);\n\n                    var x = (right + left) * w;\n                    var y = (top + bottom) * h;\n                    var z = (far + near) * p;\n\n                    te[0] = 2 * w;\n                    te[4] = 0;\n                    te[8] = 0;\n                    te[12] = -x;\n                    te[1] = 0;\n                    te[5] = 2 * h;\n                    te[9] = 0;\n                    te[13] = -y;\n                    te[2] = 0;\n                    te[6] = 0;\n                    te[10] = -2 * p;\n                    te[14] = -z;\n                    te[3] = 0;\n                    te[7] = 0;\n                    te[11] = 0;\n                    te[15] = 1;\n\n                    return this;\n\n                },\n\n                equals: function (matrix) {\n\n                    var te = this.elements;\n                    var me = matrix.elements;\n\n                    for (var i = 0; i < 16; i++) {\n\n                        if (te[i] !== me[i]) return false;\n\n                    }\n\n                    return true;\n\n                },\n\n                fromArray: function (array, offset) {\n\n                    if (offset === undefined) offset = 0;\n\n                    for (var i = 0; i < 16; i++) {\n\n                        this.elements[i] = array[i + offset];\n\n                    }\n\n                    return this;\n\n                },\n\n                toArray: function (array, offset) {\n\n                    if (array === undefined) array = [];\n                    if (offset === undefined) offset = 0;\n\n                    var te = this.elements;\n\n                    array[offset] = te[0];\n                    array[offset + 1] = te[1];\n                    array[offset + 2] = te[2];\n                    array[offset + 3] = te[3];\n\n                    array[offset + 4] = te[4];\n                    array[offset + 5] = te[5];\n                    array[offset + 6] = te[6];\n                    array[offset + 7] = te[7];\n\n                    array[offset + 8] = te[8];\n                    array[offset + 9] = te[9];\n                    array[offset + 10] = te[10];\n                    array[offset + 11] = te[11];\n\n                    array[offset + 12] = te[12];\n                    array[offset + 13] = te[13];\n                    array[offset + 14] = te[14];\n                    array[offset + 15] = te[15];\n\n                    return array;\n\n                }\n\n            });\n\n            function Matrix3() {\n\n                this.elements = [\n            \n                    1, 0, 0,\n                    0, 1, 0,\n                    0, 0, 1\n            \n                ];\n            \n                if ( arguments.length > 0 ) {\n            \n                    console.error( 'THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.' );\n            \n                }\n            \n            }\n            \n            Object.assign( Matrix3.prototype, {\n            \n                isMatrix3: true,\n            \n                set: function ( n11, n12, n13, n21, n22, n23, n31, n32, n33 ) {\n            \n                    var te = this.elements;\n            \n                    te[ 0 ] = n11; te[ 1 ] = n21; te[ 2 ] = n31;\n                    te[ 3 ] = n12; te[ 4 ] = n22; te[ 5 ] = n32;\n                    te[ 6 ] = n13; te[ 7 ] = n23; te[ 8 ] = n33;\n            \n                    return this;\n            \n                },\n            \n                identity: function () {\n            \n                    this.set(\n            \n                        1, 0, 0,\n                        0, 1, 0,\n                        0, 0, 1\n            \n                    );\n            \n                    return this;\n            \n                },\n            \n                clone: function () {\n            \n                    return new this.constructor().fromArray( this.elements );\n            \n                },\n            \n                copy: function ( m ) {\n            \n                    var te = this.elements;\n                    var me = m.elements;\n            \n                    te[ 0 ] = me[ 0 ]; te[ 1 ] = me[ 1 ]; te[ 2 ] = me[ 2 ];\n                    te[ 3 ] = me[ 3 ]; te[ 4 ] = me[ 4 ]; te[ 5 ] = me[ 5 ];\n                    te[ 6 ] = me[ 6 ]; te[ 7 ] = me[ 7 ]; te[ 8 ] = me[ 8 ];\n            \n                    return this;\n            \n                },\n            \n                setFromMatrix4: function ( m ) {\n            \n                    var me = m.elements;\n            \n                    this.set(\n            \n                        me[ 0 ], me[ 4 ], me[  8 ],\n                        me[ 1 ], me[ 5 ], me[  9 ],\n                        me[ 2 ], me[ 6 ], me[ 10 ]\n            \n                    );\n            \n                    return this;\n            \n                },\n            \n                applyToBufferAttribute: function () {\n            \n                    var v1 = new Vector3();\n            \n                    return function applyToBufferAttribute( attribute ) {\n            \n                        for ( var i = 0, l = attribute.count; i < l; i ++ ) {\n            \n                            v1.x = attribute.getX( i );\n                            v1.y = attribute.getY( i );\n                            v1.z = attribute.getZ( i );\n            \n                            v1.applyMatrix3( this );\n            \n                            attribute.setXYZ( i, v1.x, v1.y, v1.z );\n            \n                        }\n            \n                        return attribute;\n            \n                    };\n            \n                }(),\n            \n                multiply: function ( m ) {\n            \n                    return this.multiplyMatrices( this, m );\n            \n                },\n            \n                premultiply: function ( m ) {\n            \n                    return this.multiplyMatrices( m, this );\n            \n                },\n            \n                multiplyMatrices: function ( a, b ) {\n            \n                    var ae = a.elements;\n                    var be = b.elements;\n                    var te = this.elements;\n            \n                    var a11 = ae[ 0 ], a12 = ae[ 3 ], a13 = ae[ 6 ];\n                    var a21 = ae[ 1 ], a22 = ae[ 4 ], a23 = ae[ 7 ];\n                    var a31 = ae[ 2 ], a32 = ae[ 5 ], a33 = ae[ 8 ];\n            \n                    var b11 = be[ 0 ], b12 = be[ 3 ], b13 = be[ 6 ];\n                    var b21 = be[ 1 ], b22 = be[ 4 ], b23 = be[ 7 ];\n                    var b31 = be[ 2 ], b32 = be[ 5 ], b33 = be[ 8 ];\n            \n                    te[ 0 ] = a11 * b11 + a12 * b21 + a13 * b31;\n                    te[ 3 ] = a11 * b12 + a12 * b22 + a13 * b32;\n                    te[ 6 ] = a11 * b13 + a12 * b23 + a13 * b33;\n            \n                    te[ 1 ] = a21 * b11 + a22 * b21 + a23 * b31;\n                    te[ 4 ] = a21 * b12 + a22 * b22 + a23 * b32;\n                    te[ 7 ] = a21 * b13 + a22 * b23 + a23 * b33;\n            \n                    te[ 2 ] = a31 * b11 + a32 * b21 + a33 * b31;\n                    te[ 5 ] = a31 * b12 + a32 * b22 + a33 * b32;\n                    te[ 8 ] = a31 * b13 + a32 * b23 + a33 * b33;\n            \n                    return this;\n            \n                },\n            \n                multiplyScalar: function ( s ) {\n            \n                    var te = this.elements;\n            \n                    te[ 0 ] *= s; te[ 3 ] *= s; te[ 6 ] *= s;\n                    te[ 1 ] *= s; te[ 4 ] *= s; te[ 7 ] *= s;\n                    te[ 2 ] *= s; te[ 5 ] *= s; te[ 8 ] *= s;\n            \n                    return this;\n            \n                },\n            \n                determinant: function () {\n            \n                    var te = this.elements;\n            \n                    var a = te[ 0 ], b = te[ 1 ], c = te[ 2 ],\n                        d = te[ 3 ], e = te[ 4 ], f = te[ 5 ],\n                        g = te[ 6 ], h = te[ 7 ], i = te[ 8 ];\n            \n                    return a * e * i - a * f * h - b * d * i + b * f * g + c * d * h - c * e * g;\n            \n                },\n            \n                getInverse: function ( matrix, throwOnDegenerate ) {\n            \n                    if ( matrix && matrix.isMatrix4 ) {\n            \n                        console.error( \"THREE.Matrix3.getInverse no longer takes a Matrix4 argument.\" );\n            \n                    }\n            \n                    var me = matrix.elements,\n                        te = this.elements,\n            \n                        n11 = me[ 0 ], n21 = me[ 1 ], n31 = me[ 2 ],\n                        n12 = me[ 3 ], n22 = me[ 4 ], n32 = me[ 5 ],\n                        n13 = me[ 6 ], n23 = me[ 7 ], n33 = me[ 8 ],\n            \n                        t11 = n33 * n22 - n32 * n23,\n                        t12 = n32 * n13 - n33 * n12,\n                        t13 = n23 * n12 - n22 * n13,\n            \n                        det = n11 * t11 + n21 * t12 + n31 * t13;\n            \n                    if ( det === 0 ) {\n            \n                        var msg = \"THREE.Matrix3.getInverse(): can't invert matrix, determinant is 0\";\n            \n                        if ( throwOnDegenerate === true ) {\n            \n                            throw new Error( msg );\n            \n                        } else {\n            \n                            console.warn( msg );\n            \n                        }\n            \n                        return this.identity();\n            \n                    }\n            \n                    var detInv = 1 / det;\n            \n                    te[ 0 ] = t11 * detInv;\n                    te[ 1 ] = ( n31 * n23 - n33 * n21 ) * detInv;\n                    te[ 2 ] = ( n32 * n21 - n31 * n22 ) * detInv;\n            \n                    te[ 3 ] = t12 * detInv;\n                    te[ 4 ] = ( n33 * n11 - n31 * n13 ) * detInv;\n                    te[ 5 ] = ( n31 * n12 - n32 * n11 ) * detInv;\n            \n                    te[ 6 ] = t13 * detInv;\n                    te[ 7 ] = ( n21 * n13 - n23 * n11 ) * detInv;\n                    te[ 8 ] = ( n22 * n11 - n21 * n12 ) * detInv;\n            \n                    return this;\n            \n                },\n            \n                transpose: function () {\n            \n                    var tmp, m = this.elements;\n            \n                    tmp = m[ 1 ]; m[ 1 ] = m[ 3 ]; m[ 3 ] = tmp;\n                    tmp = m[ 2 ]; m[ 2 ] = m[ 6 ]; m[ 6 ] = tmp;\n                    tmp = m[ 5 ]; m[ 5 ] = m[ 7 ]; m[ 7 ] = tmp;\n            \n                    return this;\n            \n                },\n            \n                getNormalMatrix: function ( matrix4 ) {\n            \n                    return this.setFromMatrix4( matrix4 ).getInverse( this ).transpose();\n            \n                },\n            \n                transposeIntoArray: function ( r ) {\n            \n                    var m = this.elements;\n            \n                    r[ 0 ] = m[ 0 ];\n                    r[ 1 ] = m[ 3 ];\n                    r[ 2 ] = m[ 6 ];\n                    r[ 3 ] = m[ 1 ];\n                    r[ 4 ] = m[ 4 ];\n                    r[ 5 ] = m[ 7 ];\n                    r[ 6 ] = m[ 2 ];\n                    r[ 7 ] = m[ 5 ];\n                    r[ 8 ] = m[ 8 ];\n            \n                    return this;\n            \n                },\n            \n                equals: function ( matrix ) {\n            \n                    var te = this.elements;\n                    var me = matrix.elements;\n            \n                    for ( var i = 0; i < 9; i ++ ) {\n            \n                        if ( te[ i ] !== me[ i ] ) return false;\n            \n                    }\n            \n                    return true;\n            \n                },\n            \n                fromArray: function ( array, offset ) {\n            \n                    if ( offset === undefined ) offset = 0;\n            \n                    for ( var i = 0; i < 9; i ++ ) {\n            \n                        this.elements[ i ] = array[ i + offset ];\n            \n                    }\n            \n                    return this;\n            \n                },\n            \n                toArray: function ( array, offset ) {\n            \n                    if ( array === undefined ) array = [];\n                    if ( offset === undefined ) offset = 0;\n            \n                    var te = this.elements;\n            \n                    array[ offset ] = te[ 0 ];\n                    array[ offset + 1 ] = te[ 1 ];\n                    array[ offset + 2 ] = te[ 2 ];\n            \n                    array[ offset + 3 ] = te[ 3 ];\n                    array[ offset + 4 ] = te[ 4 ];\n                    array[ offset + 5 ] = te[ 5 ];\n            \n                    array[ offset + 6 ] = te[ 6 ];\n                    array[ offset + 7 ] = te[ 7 ];\n                    array[ offset + 8 ] = te[ 8 ];\n            \n                    return array;\n            \n                }\n            \n            } );\n\n            /**\n             * @author bhouston / http://clara.io\n             * @author WestLangley / http://github.com/WestLangley\n             */\n\n            function Box3(min, max) {\n\n                this.min = (min !== undefined) ? min : new Vector3(+Infinity, +Infinity, +Infinity);\n                this.max = (max !== undefined) ? max : new Vector3(-Infinity, -Infinity, -Infinity);\n\n            }\n\n            Object.assign(Box3.prototype, {\n\n                isBox3: true,\n\n                set: function (min, max) {\n\n                    this.min.copy(min);\n                    this.max.copy(max);\n\n                    return this;\n\n                },\n\n                setFromArray: function (array) {\n\n                    var minX = +Infinity;\n                    var minY = +Infinity;\n                    var minZ = +Infinity;\n\n                    var maxX = -Infinity;\n                    var maxY = -Infinity;\n                    var maxZ = -Infinity;\n\n                    for (var i = 0, l = array.length; i < l; i += 3) {\n\n                        var x = array[i];\n                        var y = array[i + 1];\n                        var z = array[i + 2];\n\n                        if (x < minX) minX = x;\n                        if (y < minY) minY = y;\n                        if (z < minZ) minZ = z;\n\n                        if (x > maxX) maxX = x;\n                        if (y > maxY) maxY = y;\n                        if (z > maxZ) maxZ = z;\n\n                    }\n\n                    this.min.set(minX, minY, minZ);\n                    this.max.set(maxX, maxY, maxZ);\n\n                    return this;\n\n                },\n\n                setFromBufferAttribute: function (attribute) {\n\n                    var minX = +Infinity;\n                    var minY = +Infinity;\n                    var minZ = +Infinity;\n\n                    var maxX = -Infinity;\n                    var maxY = -Infinity;\n                    var maxZ = -Infinity;\n\n                    for (var i = 0, l = attribute.count; i < l; i++) {\n\n                        var x = attribute.getX(i);\n                        var y = attribute.getY(i);\n                        var z = attribute.getZ(i);\n\n                        if (x < minX) minX = x;\n                        if (y < minY) minY = y;\n                        if (z < minZ) minZ = z;\n\n                        if (x > maxX) maxX = x;\n                        if (y > maxY) maxY = y;\n                        if (z > maxZ) maxZ = z;\n\n                    }\n\n                    this.min.set(minX, minY, minZ);\n                    this.max.set(maxX, maxY, maxZ);\n\n                    return this;\n\n                },\n\n                setFromPoints: function (points) {\n\n                    this.makeEmpty();\n\n                    for (var i = 0, il = points.length; i < il; i++) {\n\n                        this.expandByPoint(points[i]);\n\n                    }\n\n                    return this;\n\n                },\n\n                setFromCenterAndSize: function () {\n\n                    var v1 = new Vector3();\n\n                    return function setFromCenterAndSize(center, size) {\n\n                        var halfSize = v1.copy(size).multiplyScalar(0.5);\n\n                        this.min.copy(center).sub(halfSize);\n                        this.max.copy(center).add(halfSize);\n\n                        return this;\n\n                    };\n\n                }(),\n\n                setFromObject: function (object) {\n\n                    this.makeEmpty();\n\n                    return this.expandByObject(object);\n\n                },\n\n                clone: function () {\n\n                    return new this.constructor().copy(this);\n\n                },\n\n                copy: function (box) {\n\n                    this.min.copy(box.min);\n                    this.max.copy(box.max);\n\n                    return this;\n\n                },\n\n                makeEmpty: function () {\n\n                    this.min.x = this.min.y = this.min.z = +Infinity;\n                    this.max.x = this.max.y = this.max.z = -Infinity;\n\n                    return this;\n\n                },\n\n                isEmpty: function () {\n\n                    // this is a more robust check for empty than ( volume <= 0 ) because volume can get positive with two negative axes\n\n                    return (this.max.x < this.min.x) || (this.max.y < this.min.y) || (this.max.z < this.min.z);\n\n                },\n\n                getCenter: function (optionalTarget) {\n\n                    var result = optionalTarget || new Vector3();\n                    return this.isEmpty() ? result.set(0, 0, 0) : result.addVectors(this.min, this.max).multiplyScalar(0.5);\n\n                },\n\n                getSize: function (optionalTarget) {\n\n                    var result = optionalTarget || new Vector3();\n                    return this.isEmpty() ? result.set(0, 0, 0) : result.subVectors(this.max, this.min);\n\n                },\n\n                expandByPoint: function (point) {\n\n                    this.min.min(point);\n                    this.max.max(point);\n\n                    return this;\n\n                },\n\n                expandByVector: function (vector) {\n\n                    this.min.sub(vector);\n                    this.max.add(vector);\n\n                    return this;\n\n                },\n\n                expandByScalar: function (scalar) {\n\n                    this.min.addScalar(-scalar);\n                    this.max.addScalar(scalar);\n\n                    return this;\n\n                },\n\n                expandByObject: function () {\n\n                    // Computes the world-axis-aligned bounding box of an object (including its children),\n                    // accounting for both the object's, and children's, world transforms\n\n                    var v1 = new Vector3();\n\n                    return function expandByObject(object) {\n\n                        var scope = this;\n\n                        object.updateMatrixWorld(true);\n\n                        object.traverse(function (node) {\n\n                            var i, l;\n\n                            var geometry = node.geometry;\n\n                            if (geometry !== undefined) {\n\n                                if (geometry.isGeometry) {\n\n                                    var vertices = geometry.vertices;\n\n                                    for (i = 0, l = vertices.length; i < l; i++) {\n\n                                        v1.copy(vertices[i]);\n                                        v1.applyMatrix4(node.matrixWorld);\n\n                                        scope.expandByPoint(v1);\n\n                                    }\n\n                                } else if (geometry.isBufferGeometry) {\n\n                                    var attribute = geometry.attributes.position;\n\n                                    if (attribute !== undefined) {\n\n                                        for (i = 0, l = attribute.count; i < l; i++) {\n\n                                            v1.fromBufferAttribute(attribute, i).applyMatrix4(node.matrixWorld);\n\n                                            scope.expandByPoint(v1);\n\n                                        }\n\n                                    }\n\n                                }\n\n                            }\n\n                        });\n\n                        return this;\n\n                    };\n\n                }(),\n\n                containsPoint: function (point) {\n\n                    return point.x < this.min.x || point.x > this.max.x ||\n                        point.y < this.min.y || point.y > this.max.y ||\n                        point.z < this.min.z || point.z > this.max.z ? false : true;\n\n                },\n\n                containsBox: function (box) {\n\n                    return this.min.x <= box.min.x && box.max.x <= this.max.x &&\n                        this.min.y <= box.min.y && box.max.y <= this.max.y &&\n                        this.min.z <= box.min.z && box.max.z <= this.max.z;\n\n                },\n\n                getParameter: function (point, optionalTarget) {\n\n                    // This can potentially have a divide by zero if the box\n                    // has a size dimension of 0.\n\n                    var result = optionalTarget || new Vector3();\n\n                    return result.set(\n                        (point.x - this.min.x) / (this.max.x - this.min.x),\n                        (point.y - this.min.y) / (this.max.y - this.min.y),\n                        (point.z - this.min.z) / (this.max.z - this.min.z)\n                    );\n\n                },\n\n                intersectsBox: function (box) {\n\n                    // using 6 splitting planes to rule out intersections.\n                    return box.max.x < this.min.x || box.min.x > this.max.x ||\n                        box.max.y < this.min.y || box.min.y > this.max.y ||\n                        box.max.z < this.min.z || box.min.z > this.max.z ? false : true;\n\n                },\n\n                intersectsSphere: (function () {\n\n                    var closestPoint = new Vector3();\n\n                    return function intersectsSphere(sphere) {\n\n                        // Find the point on the AABB closest to the sphere center.\n                        this.clampPoint(sphere.center, closestPoint);\n\n                        // If that point is inside the sphere, the AABB and sphere intersect.\n                        return closestPoint.distanceToSquared(sphere.center) <= (sphere.radius * sphere.radius);\n\n                    };\n\n                })(),\n\n                intersectsPlane: function (plane) {\n\n                    // We compute the minimum and maximum dot product values. If those values\n                    // are on the same side (back or front) of the plane, then there is no intersection.\n\n                    var min, max;\n\n                    if (plane.normal.x > 0) {\n\n                        min = plane.normal.x * this.min.x;\n                        max = plane.normal.x * this.max.x;\n\n                    } else {\n\n                        min = plane.normal.x * this.max.x;\n                        max = plane.normal.x * this.min.x;\n\n                    }\n\n                    if (plane.normal.y > 0) {\n\n                        min += plane.normal.y * this.min.y;\n                        max += plane.normal.y * this.max.y;\n\n                    } else {\n\n                        min += plane.normal.y * this.max.y;\n                        max += plane.normal.y * this.min.y;\n\n                    }\n\n                    if (plane.normal.z > 0) {\n\n                        min += plane.normal.z * this.min.z;\n                        max += plane.normal.z * this.max.z;\n\n                    } else {\n\n                        min += plane.normal.z * this.max.z;\n                        max += plane.normal.z * this.min.z;\n\n                    }\n\n                    return (min <= plane.constant && max >= plane.constant);\n\n                },\n\n                clampPoint: function (point, optionalTarget) {\n\n                    var result = optionalTarget || new Vector3();\n                    return result.copy(point).clamp(this.min, this.max);\n\n                },\n\n                distanceToPoint: function () {\n\n                    var v1 = new Vector3();\n\n                    return function distanceToPoint(point) {\n\n                        var clampedPoint = v1.copy(point).clamp(this.min, this.max);\n                        return clampedPoint.sub(point).length();\n\n                    };\n\n                }(),\n\n                getBoundingSphere: function () {\n\n                    var v1 = new Vector3();\n\n                    return function getBoundingSphere(optionalTarget) {\n\n                        var result = optionalTarget || new Sphere();\n\n                        this.getCenter(result.center);\n\n                        result.radius = this.getSize(v1).length() * 0.5;\n\n                        return result;\n\n                    };\n\n                }(),\n\n                intersect: function (box) {\n\n                    this.min.max(box.min);\n                    this.max.min(box.max);\n\n                    // ensure that if there is no overlap, the result is fully empty, not slightly empty with non-inf/+inf values that will cause subsequence intersects to erroneously return valid values.\n                    if (this.isEmpty()) this.makeEmpty();\n\n                    return this;\n\n                },\n\n                union: function (box) {\n\n                    this.min.min(box.min);\n                    this.max.max(box.max);\n\n                    return this;\n\n                },\n\n                applyMatrix4: function () {\n\n                    var points = [\n                        new Vector3(),\n                        new Vector3(),\n                        new Vector3(),\n                        new Vector3(),\n                        new Vector3(),\n                        new Vector3(),\n                        new Vector3(),\n                        new Vector3()\n                    ];\n\n                    return function applyMatrix4(matrix) {\n\n                        // transform of empty box is an empty box.\n                        if (this.isEmpty()) return this;\n\n                        // NOTE: I am using a binary pattern to specify all 2^3 combinations below\n                        points[0].set(this.min.x, this.min.y, this.min.z).applyMatrix4(matrix); // 000\n                        points[1].set(this.min.x, this.min.y, this.max.z).applyMatrix4(matrix); // 001\n                        points[2].set(this.min.x, this.max.y, this.min.z).applyMatrix4(matrix); // 010\n                        points[3].set(this.min.x, this.max.y, this.max.z).applyMatrix4(matrix); // 011\n                        points[4].set(this.max.x, this.min.y, this.min.z).applyMatrix4(matrix); // 100\n                        points[5].set(this.max.x, this.min.y, this.max.z).applyMatrix4(matrix); // 101\n                        points[6].set(this.max.x, this.max.y, this.min.z).applyMatrix4(matrix); // 110\n                        points[7].set(this.max.x, this.max.y, this.max.z).applyMatrix4(matrix); // 111\n\n                        this.setFromPoints(points);\n\n                        return this;\n\n                    };\n\n                }(),\n\n                translate: function (offset) {\n\n                    this.min.add(offset);\n                    this.max.add(offset);\n\n                    return this;\n\n                },\n\n                equals: function (box) {\n\n                    return box.min.equals(this.min) && box.max.equals(this.max);\n\n                }\n\n            });\n            \n            CLOUD.Math.Quaternion = Quaternion;\n            CLOUD.Math.Vector3 = Vector3;\n            CLOUD.Math.Vector4 = Vector4;\n            CLOUD.Math.Matrix4 = Matrix4;\n            CLOUD.Math.Matrix3 = Matrix3;\n            CLOUD.Math.Box3 = Box3;\n\n        })();\n    \n    "
}(),function(){CLOUD.Workers.WorkerChunk.UtilsChunk="\n\n        (function(){\n\n            function applyMatrix3ToBuffer() {\n\n                var v1 = new CLOUD.Math.Vector3();\n\n                return function applyMatrix3ToBuffer( matrix, array ) {\n\n                    for ( var i = 0, len = array.length; i < len; i += 3 ) {\n\n                        v1.x = array[i + 0];\n                        v1.y = array[i + 1];\n                        v1.z = array[i + 2];\n\n                        v1.applyMatrix3( matrix );\n\n                        array[ i + 0 ] = v1.x;\n                        array[ i + 1 ] = v1.y;\n                        array[ i + 2 ] = v1.z;\n\n                    }\n\n                    return array;\n\n                };\n            }\n\n            function applyMatrix4ToBuffer () {\n\n                var v1 = new CLOUD.Math.Vector3();\n\n                return function applyMatrix4ToBuffer( matrix, array ) {\n\n                    for ( var i = 0, len = array.length; i < len; i += 3 ) {\n\n                        v1.x = array[i + 0];\n                        v1.y = array[i + 1];\n                        v1.z = array[i + 2];\n\n                        v1.applyMatrix4( matrix );\n\n                        array[ i + 0 ] = v1.x;\n                        array[ i + 1 ] = v1.y;\n                        array[ i + 2 ] = v1.z;\n\n                    }\n\n                    return array;\n\n                };\n            }\n\n            function normalizeBuffer(array) {\n                var x, y, z, n;\n\n                for ( var i = 0, il = array.length; i < il; i += 3 ) {\n\n                    x = array[i];\n                    y = array[i + 1];\n                    z = array[i + 2];\n\n                    n = 1.0 / Math.sqrt( x * x + y * y + z * z );\n\n                    array[ i + 0 ] = x * n;\n                    array[ i + 1 ] = y * n;\n                    array[ i + 2 ] = z * n;\n\n                }\n            }\n\n            function isMirror(matrixArray) {\n\n                var vx = new CLOUD.Math.Vector3(matrixArray[0], matrixArray[1], matrixArray[2]);\n                var vy = new CLOUD.Math.Vector3(matrixArray[4], matrixArray[5], matrixArray[6]);\n                var vz = new CLOUD.Math.Vector3(matrixArray[8], matrixArray[9], matrixArray[10]);\n\n                var vc = new CLOUD.Math.Vector3().crossVectors(vx, vy);\n                var d = vc.dot(vz);\n\n                if (d < 0.0) {\n                    return true;\n                }\n\n                return false;\n            }\n\n            function mergeBufferAttributes(attributes) {\n\n                var TypedArray;\n                var itemSize;\n                var normalized;\n                var arrayLength = 0;\n            \n                for (var i = 0; i < attributes.length; ++i) {\n            \n                    var attribute = attributes[i];\n            \n                    if (TypedArray === undefined) {\n                        TypedArray = attribute.array.constructor;\n                    }\n                    if (TypedArray !== attribute.array.constructor) {\n                        return null;\n                    }\n            \n                    if (itemSize === undefined) {\n                        itemSize = attribute.itemSize;\n                    }\n                    if (itemSize !== attribute.itemSize) {\n                        return null;\n                    }\n            \n                    if (normalized === undefined) {\n                        normalized = attribute.normalized;\n                    }\n                    if (normalized !== attribute.normalized) {\n                        return null;\n                    }\n            \n                    arrayLength += attribute.array.length;\n            \n                }\n            \n                var array = new TypedArray(arrayLength);\n                var offset = 0;\n            \n                for (var j = 0; j < attributes.length; ++j) {\n            \n                    array.set(attributes[j].array, offset);\n            \n                    offset += attributes[j].array.length;\n            \n                }\n            \n                return {\n                    array: array,\n                    itemSize: itemSize,\n                    normalized: normalized\n                };\n            \n            }\n            \n            function mergeBuffers(buffers, indicesGroup) {\n            \n                var positionList = [];\n                var indexList = [];\n                var indexOffset = 0;\n                var indexTotal = 0; //\n            \n                for (var i = 0; i < buffers.length; ++i) {\n            \n                    positionList.push(buffers[i].position);\n            \n                    var index = buffers[i].index;\n            \n                    if (indexOffset > 0) {\n            \n                        index = {\n                            array: index.array,\n                            itemSize: index.itemSize,\n                            count: index.count,\n                            normalized: index.normalized\n                        };\n            \n                        for (var j = 0; j < index.count; ++j) {\n            \n                            index.array[j * index.itemSize] += indexOffset;\n            \n                        }\n            \n                    }\n            \n                    indexList.push(index);\n                    indexOffset += buffers[i].position.count;\n            \n                    if (indicesGroup[buffers[i].name] === void 0) {\n                        indicesGroup[buffers[i].name] = [];\n                    }\n            \n                    indicesGroup[buffers[i].name].push({\n                        nodeId: buffers[i].nodeId,\n                        indexStart: indexTotal,\n                        indexCount: index.count\n                    });\n                    indexTotal += index.count;\n                }\n            \n                var newIndex = mergeBufferAttributes(indexList);\n                var newPosition = mergeBufferAttributes(positionList);\n            \n                return {\n                    index: newIndex,\n                    position: newPosition\n                };\n            \n            }\n\n            function getCombinedKeyString(keyArray, separator) {\n                separator = separator || '&';\n                return keyArray.join(separator);\n            }\n\n            function splitCombinedKeyString(keySting, separator){\n                separator = separator || '&';\n                return keySting.split(separator);\n            }\n\n            // ArrayBuffer转为字符串，参数为ArrayBuffer对象\n            function ab2str(buf) {\n                return new TextDecoder().decode(new Uint8Array(buf));\n            }\n\n            // 字符串转为ArrayBuffer对象，参数为字符串\n            function str2ab(str){\n                return new TextEncoder().encode(str).buffer;\n            }\n\n            CLOUD.Utils.applyMatrix3ToBuffer = applyMatrix3ToBuffer();\n            CLOUD.Utils.applyMatrix4ToBuffer = applyMatrix4ToBuffer();\n            CLOUD.Utils.normalizeBuffer = normalizeBuffer;\n            CLOUD.Utils.mergeBuffers = mergeBuffers;\n            CLOUD.Utils.isMirror = isMirror;\n            CLOUD.Utils.getCombinedKeyString = getCombinedKeyString;\n            CLOUD.Utils.splitCombinedKeyString = splitCombinedKeyString;\n            CLOUD.Utils.ab2str = ab2str;\n            CLOUD.Utils.str2ab = str2ab;\n\n        })();\n    \n    "}(),function(){CLOUD.Workers.WorkerChunk.GeomUtilChunk="\n\n        function getBoxData(idx) {\n\n            // left side\n            var vertexArray = [\n                [-0.5, -0.5, -0.5,\n                    -0.5, -0.5, 0.5,\n                    -0.5, 0.5, -0.5,\n                    -0.5, 0.5, 0.5\n                ],\n\n                // down side\n                [-0.5, -0.5, -0.5,\n                    -0.5, -0.5, 0.5,\n                    0.5, -0.5, -0.5,\n                    0.5, -0.5, 0.5\n                ],\n\n                // back side\n                [-0.5, -0.5, -0.5,\n                    -0.5, 0.5, -0.5,\n                    0.5, -0.5, -0.5,\n                    0.5, 0.5, -0.5\n                ],\n\n                // front side\n                [-0.5, -0.5, 0.5,\n                    -0.5, 0.5, 0.5,\n                    0.5, -0.5, 0.5,\n                    0.5, 0.5, 0.5\n                ],\n\n                // up side\n                [-0.5, 0.5, -0.5,\n                    -0.5, 0.5, 0.5,\n                    0.5, 0.5, -0.5,\n                    0.5, 0.5, 0.5\n                ],\n\n                // right side\n                [0.5, -0.5, -0.5,\n                    0.5, -0.5, 0.5,\n                    0.5, 0.5, -0.5,\n                    0.5, 0.5, 0.5\n                ]\n            ];\n\n            var indexArray = [\n                // left\n                [0, 1, 2, 3, 2, 1],\n                // down\n                [2, 1, 0, 1, 2, 3],\n                // back\n                [0, 1, 2, 3, 2, 1],\n                // front\n                [2, 1, 0, 1, 2, 3],\n                // up\n                [0, 1, 2, 3, 2, 1],\n                // right\n                [2, 1, 0, 1, 2, 3]\n            ];\n\n            var normalArray = [\n                [],\n                [],\n                [],\n                [],\n                [],\n                []\n            ];\n            for (var j = 0; j < 4; ++j) {\n                normalArray[0].push(-1.0, 0.0, 0.0);\n            }\n            for (var j = 0; j < 4; ++j) {\n                normalArray[1].push(0.0, -1.0, 0.0);\n            }\n            for (var j = 0; j < 4; ++j) {\n                normalArray[2].push(0.0, 0.0, -1.0);\n            }\n            for (var j = 0; j < 4; ++j) {\n                normalArray[3].push(0.0, 0.0, 1.0);\n            }\n            for (var j = 0; j < 4; ++j) {\n                normalArray[4].push(0.0, 1.0, 0.0);\n            }\n            for (var j = 0; j < 4; ++j) {\n                normalArray[5].push(1.0, 0.0, 0.0);\n            }\n\n            var uvArray = [\n                [],\n                [],\n                [],\n                [],\n                [],\n                []\n            ];\n            uvArray[0] = uvArray[2] = uvArray[4] = [-0.5, -0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5];\n            //改变贴图上下的方向\n            uvArray[1] = uvArray[3] = uvArray[5] = [-0.5, -0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5];\n\n            return {\n                vertex: vertexArray[idx],\n                normal: normalArray[idx],\n                uv: uvArray[idx],\n                index: indexArray[idx]\n            };\n\n        }\n\n        function getPipeData(num_edges) {\n\n            if (num_edges === undefined || num_edges < 8)\n                num_edges = 8;\n\n            if (num_edges > 256)\n                num_edges = 256;\n\n            var PI = 3.14159265357;\n            var PIPE_SIZE = 1.0;\n            var PIPE_SIZE_HALF = PIPE_SIZE / 2.0;\n\n            var num_vertices = num_edges * 4 + 2;\n            var num_indices = (num_edges * 4 - 4) * 3;\n            var num_circle = num_edges + 1;\n\n            var step_len = 1.0 / num_edges;\n            var step_angle = PI * 2.0 / num_edges;\n            var i, n;\n\n            // ini circle buffer\n            var circleArray = [];\n            for (i = 0; i < num_edges; ++i) {\n                circleArray.push(PIPE_SIZE_HALF * Math.cos(i * step_angle));\n                circleArray.push(PIPE_SIZE_HALF * Math.sin(i * step_angle));\n            }\n            circleArray.push(PIPE_SIZE_HALF);\n            circleArray.push(0.0);\n\n            // add vertices\n            var vertexArray = [];\n            n = num_circle * 2;\n            for (i = 0; i < n; i += 2) {\n                vertexArray.push(circleArray[i]);\n                vertexArray.push(circleArray[i + 1]);\n                vertexArray.push(PIPE_SIZE_HALF);\n            }\n            for (i = 0; i < n; i += 2) {\n                vertexArray.push(circleArray[i]);\n                vertexArray.push(circleArray[i + 1]);\n                vertexArray.push(-PIPE_SIZE_HALF);\n            }\n\n            n = num_edges * 2;\n            for (i = 0; i < n; i += 2) {\n                vertexArray.push(circleArray[i]);\n                vertexArray.push(circleArray[i + 1]);\n                vertexArray.push(PIPE_SIZE_HALF);\n            }\n            for (i = n; i > 0; i -= 2) {\n                vertexArray.push(circleArray[i]);\n                vertexArray.push(circleArray[i + 1]);\n                vertexArray.push(-PIPE_SIZE_HALF);\n            }\n\n            // add indices\n            var indexArray = [];\n            var len_edges = num_edges + 1;\n            for (i = 0; i < num_edges; ++i) {\n                indexArray.push(i);\n                indexArray.push(i + len_edges);\n                indexArray.push(i + 1);\n\n                indexArray.push(i + 1);\n                indexArray.push(i + len_edges);\n                indexArray.push(i + len_edges + 1);\n            }\n\n            var idx_s = num_circle * 2;\n            for (i = 1; i < num_edges - 1; ++i) {\n                indexArray.push(idx_s);\n                indexArray.push(idx_s + i);\n                indexArray.push(idx_s + i + 1);\n            }\n\n            idx_s = idx_s + num_edges;\n            for (i = 1; i < num_edges - 1; ++i) {\n                indexArray.push(idx_s);\n                indexArray.push(idx_s + i);\n                indexArray.push(idx_s + i + 1);\n            }\n\n            // add uv\n            var uvArray = [];\n            for (i = num_edges; i >= 0; --i) {\n                uvArray.push(i * step_len - PIPE_SIZE_HALF);\n                uvArray.push(-PIPE_SIZE_HALF);\n            }\n            for (i = num_edges; i >= 0; --i) {\n                uvArray.push(i * step_len - PIPE_SIZE_HALF);\n                uvArray.push(PIPE_SIZE_HALF);\n            }\n\n            n = num_edges * 2;\n            for (i = 0; i < n; i += 2) {\n                uvArray.push(circleArray[i]);\n                uvArray.push(circleArray[i + 1]);\n            }\n            for (i = n; i > 0; i -= 2) {\n                uvArray.push(circleArray[i]);\n                uvArray.push(circleArray[i + 1]);\n            }\n\n            // add normals\n            n = num_vertices * 3;\n            var normalArray = [];\n            for (i = 0; i < n; ++i) {\n                normalArray.push(0.0);\n            }\n\n            var vA, vB, vC;\n            var pA = new CLOUD.Math.Vector3(),\n                pB = new CLOUD.Math.Vector3(),\n                pC = new CLOUD.Math.Vector3();\n            var cb = new CLOUD.Math.Vector3(),\n                ab = new CLOUD.Math.Vector3();\n            for (i = 0; i < num_indices; i += 3) {\n                vA = indexArray[i] * 3;\n                vB = indexArray[i + 1] * 3;\n                vC = indexArray[i + 2] * 3;\n\n                pA.fromArray(vertexArray, vA);\n                pB.fromArray(vertexArray, vB);\n                pC.fromArray(vertexArray, vC);\n\n                cb.subVectors(pC, pB);\n                ab.subVectors(pA, pB);\n                cb.cross(ab);\n\n                normalArray[vA] += cb.x;\n                normalArray[vA + 1] += cb.y;\n                normalArray[vA + 2] += cb.z;\n\n                normalArray[vB] += cb.x;\n                normalArray[vB + 1] += cb.y;\n                normalArray[vB + 2] += cb.z;\n\n                normalArray[vC] += cb.x;\n                normalArray[vC + 1] += cb.y;\n                normalArray[vC + 2] += cb.z;\n            }\n\n            var vector = new CLOUD.Math.Vector3();\n            n = num_vertices * 3;\n            for (i = 0; i < n; i += 3) {\n                vector.fromArray(normalArray, i);\n                vector.normalize();\n                normalArray[i] = vector.x;\n                normalArray[i + 1] = vector.y;\n                normalArray[i + 2] = vector.z;\n            }\n\n            return {\n                vertex: vertexArray,\n                normal: normalArray,\n                uv: uvArray,\n                index: indexArray,\n                edges: num_edges\n            };\n        }    \n\n        function getBoxMBuffer() {\n\n            var j, jLen;\n            var vertex = [];\n            var normal = [];\n            var index = [];\n            var indexOffset = 0;\n\n            for (var i = 0; i < 6; ++i) {\n                var boxData = getBoxData(i);\n                for (j = 0, jLen = boxData.vertex.length; j < jLen; j++) {\n                    vertex.push(boxData.vertex[j]);\n                }\n\n                for (j = 0, jLen = boxData.index.length; j < jLen; j++) {\n                    index.push(boxData.index[j] + indexOffset);\n                }\n                indexOffset += boxData.vertex.length / 3;\n\n                for (j = 0, jLen = boxData.normal.length; j < jLen; j++) {\n                    normal.push(boxData.normal[j]);\n                }\n            }\n\n            return function getBoxMBuffer(uvMatricesArrayBuffer) {\n\n                var uv = null;\n\n                if (uvMatricesArrayBuffer) {\n                    var uvMatrix = new CLOUD.Math.Matrix3();\n                    var uvTmp = new CLOUD.Math.Vector3();\n                    uv = [];\n                    for (var i = 0; i < 6; ++i) {\n                        var data = getBoxData(i);\n                        uvMatrix.set(uvMatricesArrayBuffer[i * 6], uvMatricesArrayBuffer[i * 6 + 2], uvMatricesArrayBuffer[i * 6 + 4],\n                            uvMatricesArrayBuffer[i * 6 + 1], uvMatricesArrayBuffer[i * 6 + 3], uvMatricesArrayBuffer[i * 6 + 5],\n                            0, 0, 1.0);\n                        for (var j = 0, jLen = data.uv.length; j < jLen; j += 2) {\n                            uvTmp.set(data.uv[j], data.uv[j + 1], 1.0);\n                            uvTmp.applyMatrix3(uvMatrix);\n                            uv.push(uvTmp.x);\n                            uv.push(uvTmp.y);\n                        }\n                    }\n                }\n\n                return {\n                    vertex: vertex,\n                    normal: normal,\n                    uv: uv,\n                    index: index\n                };\n            }\n        }\n\n        function getPipeMBuffer() {\n\n            var data2 = getPipeData(32);\n            var edges = data2.edges;\n            var vertex = data2.vertex;\n            var normal = data2.normal;\n            var index = data2.index;\n\n            return function getPipeMBuffer(uvMatricesArrayBuffer) {\n\n                var uv = null;\n                var hasUV = (uvMatricesArrayBuffer && uvMatricesArrayBuffer.length === 18) ? true : false;\n\n                if (hasUV) {\n                    uv = [];\n                    var matrices = [];\n                    for (var i = 0, len = uvMatricesArrayBuffer.length / 6; i < len; i++) {\n                        var uvMatrix = new CLOUD.Math.Matrix3();\n                        uvMatrix.set(\n                            uvMatricesArrayBuffer[i * 6], uvMatricesArrayBuffer[i * 6 + 2], uvMatricesArrayBuffer[i * 6 + 4],\n                            uvMatricesArrayBuffer[i * 6 + 1], uvMatricesArrayBuffer[i * 6 + 3], uvMatricesArrayBuffer[i * 6 + 5],\n                            0, 0, 1.0);\n                        matrices.push(uvMatrix);\n                    }\n\n                    // Remark：这里又有一次调用???\n                    var data = getPipeData(32); \n                    var uvNum1 = (edges + 1) * 4; //edges = 8时为36\n                    var uvNum2 = uvNum1 + edges * 2; //edges = 8时为52\n                    var uvTmp = new CLOUD.Math.Vector3();\n                    for (var j = 0, jLen = data.uv.length; j < jLen; j += 2) {\n                        uvTmp.set(data.uv[j], data.uv[j + 1], 1.0);\n                        if (j < uvNum1) {\n                            uvTmp.applyMatrix3(matrices[0]);\n                        } else if (j < uvNum2) {\n                            uvTmp.applyMatrix3(matrices[1]);\n                        } else {\n                            uvTmp.applyMatrix3(matrices[2]);\n                        }\n                        uv.push(uvTmp.x);\n                        uv.push(uvTmp.y);\n                    }\n                }\n\n                return {\n                    vertex: vertex,\n                    normal: normal,\n                    uv: uv,\n                    index: index\n                };\n            }\n        }\n\n        CLOUD.GeomUtil.getBoxMBuffer = getBoxMBuffer();\n        CLOUD.GeomUtil.getPipeMBuffer = getPipeMBuffer();\n    \n    "}(),function(){
CLOUD.Workers.WorkerChunk.SceneReaderChunk="\n\n        (function () {\n\n            /**\n             * @author muwj 2016/12/15\n             */\n\n            function SceneHeader(buffer) {\n\n                var header = new Uint32Array(buffer, 0, 11);\n\n                this.blockId = header[0];\n                this.cellCount = header[1];\n                this.itemCount = header[2];\n                this.matrixCount = header[3];\n                this.geomBuffSize = header[4];\n                this.layerBuffSize = header[5];\n                this.cellOffset = header[6];\n                this.itemOffset = header[7];\n                this.matrixOffset = header[8];\n                this.geomOffset = header[9];\n                this.layerOffset = header[10];\n\n                var bbox = new Float32Array(buffer, 4 * 11, 6);\n                this.boundingBox = new CLOUD.Math.Box3(\n                    new CLOUD.Math.Vector3(bbox[0], bbox[1], bbox[2]),\n                    new CLOUD.Math.Vector3(bbox[3], bbox[4], bbox[5]));\n\n                header = null;\n                bbox = null;\n            }\n\n            function Cell(buffer, offset) {\n\n                var cell_i = new Int32Array(buffer, offset, 5);\n\n                this.cellId = cell_i[0];\n                this.depth = cell_i[1];\n                this.itemIndex = cell_i[2];\n                this.itemCount = cell_i[3];\n\n                this.layerType = cell_i[4];\n                this.layerSize = new Int32Array(buffer, offset + 5 * 4, 8);\n                this.layerOffset = new Int32Array(buffer, offset + (5 + 8) * 4, 8);\n\n                var bbox = new Float32Array(buffer, offset + (5 + 8 + 8) * 4, 6);\n                this.boundingBox = new CLOUD.Math.Box3(\n                    new CLOUD.Math.Vector3(bbox[0], bbox[1], bbox[2]),\n                    new CLOUD.Math.Vector3(bbox[3], bbox[4], bbox[5]));\n\n                cell_i = null;\n                bbox = null;\n            }\n\n            function Item(buffer, offset) {\n\n                var item_i = new Int32Array(buffer, offset, 7);\n\n                this.ItemId = item_i[0];\n                this.originalId = item_i[1];\n                this.materialId = item_i[2];\n                this.userDataId = item_i[3];\n                this.matrixId = item_i[4];\n                this.type = item_i[5];\n                this.toData = item_i[6];\n\n                var bbox = new Float32Array(buffer, offset + 4 * 7, 6);\n                this.boundingBox = new CLOUD.Math.Box3(\n                    new CLOUD.Math.Vector3(bbox[0], bbox[1], bbox[2]),\n                    new CLOUD.Math.Vector3(bbox[3], bbox[4], bbox[5]));\n\n                item_i = null;\n                bbox = null;\n            }\n\n            function Matrix(buffer, offset) {\n\n                var matrixData = new Float32Array(buffer, offset, 4 * 4);\n                this.matrix = new CLOUD.Math.Matrix4().fromArray(matrixData);\n                matrixData = null;\n            }\n\n            function GeomPipe(buffer, offset) {\n\n                var geomData = new Float32Array(buffer, offset, 8);\n\n                this.startPt = new CLOUD.Math.Vector3(geomData[0], geomData[1], geomData[2]);\n                this.endPt = new CLOUD.Math.Vector3(geomData[3], geomData[4], geomData[5]);\n                this.radius = geomData[6];\n                this.thickness = geomData[7];\n\n                geomData = null;\n            }\n\n            function SceneReader(buffer) {\n\n                this.header = new SceneHeader(buffer);\n\n                this.cellSize = 4 * (5 + 8 + 8 + 6);\n                this.itemSize = 4 * 13;\n                this.matrixSize = 4 * 16;\n                this.maxSize = 4 * 256;\n                this.boxUvSize = 36;\n                this.pipeUvSize = 18;\n\n                this.cellBuffer = buffer.slice(this.header.cellOffset, this.header.cellOffset + this.header.cellCount * this.cellSize);\n                this.itemBuffer = buffer.slice(this.header.itemOffset, this.header.itemOffset + this.header.itemCount * this.itemSize);\n                this.matrixBuffer = buffer.slice(this.header.matrixOffset, this.header.matrixOffset + this.header.matrixCount * this.matrixSize);\n                this.geomBuffer = buffer.slice(this.header.geomOffset, this.header.geomOffset + this.header.geomBuffSize);\n                this.layerBuffer = buffer.slice(this.header.layerOffset, this.header.layerOffset + this.header.layerBuffSize);\n\n                // for data reading\n                this.matr_cur_id = -1;\n                this.pt_cell_min = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n                this.pt_cell_max = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n                this.pt_item_min = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n                this.pt_item_max = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n\n                var tmp_buffer = new ArrayBuffer(this.maxSize);\n                this.cell_cur = new Cell(tmp_buffer, 0);\n                this.item_cur = new Item(tmp_buffer, 0);\n                this.matr_cur = new Matrix(tmp_buffer, 0);\n                this.pipe_cur = new GeomPipe(tmp_buffer, 0);\n\n                this.cell_cur.boundingBox.set(this.pt_cell_min, this.pt_cell_max);\n                this.item_cur.boundingBox.set(this.pt_item_min, this.pt_item_max);\n            }\n\n            SceneReader.prototype = {\n\n                constructor: SceneReader,\n\n                getCellMpks: function (index) {\n\n                    if (index >= 0 && index < this.header.cellCount) {\n                        var src = [];\n                        var cell = this.getCellInfo(index);\n                        for (var i = cell.itemIndex; i < cell.itemCount; ++i) {\n                            var item = this.getItemInfo(i);\n                            if (item.type === 1) { // mesh\n\n                                var blockId = this.getMpkID(item.toData);\n                                src.push(blockId);\n                            }\n                        }\n\n                        var key = {};\n                        var dist = [];\n                        for (var j = 0; j < src.length; ++j) {\n                            if (!key[src[j]]) {\n                                key[src[j]] = true;\n                                dist.push(src[j]);\n                            }\n                        }\n                        return dist;\n                    }\n                },\n\n                getCell: function (index) {\n\n                    if (index >= 0 && index < this.header.cellCount) {\n                        return new Cell(this.cellBuffer, index * this.cellSize);\n                    }\n                },\n\n                getItem: function (index) {\n\n                    if (index >= 0 && index < this.header.itemCount) {\n                        return new Item(this.itemBuffer, index * this.itemSize);\n                    }\n                },\n\n                getMatrix: function (index) {\n\n                    if (index >= 0 && index < this.header.matrixCount) {\n                        return new Matrix(this.matrixBuffer, index * this.matrixSize);\n                    }\n                },\n\n                getGeomPipe: function (offset) {\n\n                    if (offset >= 0 && offset < this.header.geomBuffSize) {\n                        return new GeomPipe(this.geomBuffer, offset);\n                    }\n                },\n\n                getCellInfo: function (index) {\n\n                    if (index >= 0 && index < this.header.cellCount) {\n\n                        var data_i = new Int32Array(this.cellBuffer, index * this.cellSize, 5);\n                        this.cell_cur.cellId = data_i[0];\n                        this.cell_cur.depth = data_i[1];\n                        this.cell_cur.itemIndex = data_i[2];\n                        this.cell_cur.itemCount = data_i[3];\n\n                        this.cell_cur.layerType = data_i[4];\n                        this.cell_cur.layerSize = new Int32Array(this.cellBuffer, index * this.cellSize + 5 * 4, 8);\n                        this.cell_cur.layerOffset = new Int32Array(this.cellBuffer, index * this.cellSize + (5 + 8) * 4, 8);\n\n                        var data_f = new Float32Array(this.cellBuffer, index * this.cellSize + (5 + 8 + 8) * 4, 6);\n                        this.pt_cell_min.set(data_f[0], data_f[1], data_f[2]);\n                        this.pt_cell_max.set(data_f[3], data_f[4], data_f[5]);\n                        this.cell_cur.boundingBox.set(this.pt_cell_min, this.pt_cell_max);\n\n                        return this.cell_cur;\n                    }\n                },\n\n                getItemInfo: function (index) {\n\n                    if (index >= 0 && index < this.header.itemCount) {\n\n                        var data_i = new Int32Array(this.itemBuffer, index * this.itemSize, 7);\n                        this.item_cur.ItemId = data_i[0];\n                        this.item_cur.originalId = data_i[1];\n                        this.item_cur.materialId = data_i[2];\n                        this.item_cur.userDataId = data_i[3];\n                        this.item_cur.matrixId = data_i[4];\n                        this.item_cur.type = data_i[5];\n                        this.item_cur.toData = data_i[6];\n\n                        var data_f = new Float32Array(this.itemBuffer, index * this.itemSize + 4 * 7, 6);\n                        this.pt_item_min.set(data_f[0], data_f[1], data_f[2]);\n                        this.pt_item_max.set(data_f[3], data_f[4], data_f[5]);\n                        this.item_cur.boundingBox.set(this.pt_item_min, this.pt_item_max);\n\n                        return this.item_cur;\n                    }\n                },\n\n                getMatrixInfo: function (index) {\n\n                    if (index == this.matr_cur_id) {\n                        return this.matr_cur;\n                    }\n\n                    if (index >= 0 && index < this.header.matrixCount) {\n\n                        var data = new Float32Array(this.matrixBuffer, index * this.matrixSize, 4 * 4);\n                        this.matr_cur.matrix.fromArray(data);\n\n                        this.matr_cur_id = index;\n                        return this.matr_cur;\n                    }\n                },\n\n                getGeomPipeInfo: function (offset) {\n\n                    if (offset >= 0 && offset < this.header.geomBuffSize) {\n\n                        var data = new Float32Array(this.geomBuffer, offset, 8);\n                        this.pipe_cur.startPt.set(data[0], data[1], data[2]);\n                        this.pipe_cur.endPt.set(data[3], data[4], data[5]);\n                        this.pipe_cur.radius = data[6];\n                        this.pipe_cur.thickness = data[7];\n\n                        return this.pipe_cur;\n                    }\n                },\n\n                getGeomBoxUvInfo: function (offset) {\n\n                    if (offset >= 0 && (offset + this.boxUvSize * 4) <= this.header.geomBuffSize) {\n\n                        return new Float32Array(this.geomBuffer, offset, this.boxUvSize);\n                    }\n                },\n\n                getGeomPipeUvInfo: function (offset) {\n\n                    if (offset >= 0 && (offset + this.pipeUvSize * 4) <= this.header.geomBuffSize) {\n\n                        return new Float32Array(this.geomBuffer, offset, this.pipeUvSize);\n                    }\n                },\n\n                getLayerInfo: function (offset, size) {\n\n                    if (offset >= 0 && (offset + size) <= this.header.layerBuffSize) {\n\n                        var data = new Uint32Array(this.layerBuffer, offset, size);\n                        return this.data;\n                    }\n                },\n\n                getMpkID: function (mesh_id) {\n\n                    return parseInt(mesh_id / 65536);\n                },\n\n                getMeshIndex: function (mesh_id) {\n\n                    return parseInt(mesh_id % 65536);\n                }\n            };\n\n            CLOUD.Reader.SceneHeader = SceneHeader;\n            CLOUD.Reader.Cell = Cell;\n            CLOUD.Reader.Item = Item;\n            CLOUD.Reader.Matrix = Matrix;\n            CLOUD.Reader.GeomPipe = GeomPipe;\n            CLOUD.Reader.SceneReader = SceneReader;\n            // 模型数据项类型\n            CLOUD.Reader.EnumNodeItemType = {\n                SYMBOL: 0,\n                MESH: 1,\n                TUBE: 2,\n                PIPE: 3,\n                BOX: 4,\n                BOX_M: 5,\n                PIPE_M: 6,\n                MESH_REF: 7,\n                LINE: 8\n            };\n\n        })();\n\n    "}(),function(){CLOUD.Workers.WorkerChunk.SymbolReaderChunk="\n\n        /**\n         * @author muwj 2016/12/29\n         */\n\n        CLOUD.Reader.SymbolHeader = function (buffer) {\n\n            var header = new Uint32Array(buffer, 0, 9);\n\n            this.blockId = header[0];\n            this.symbolCount = header[1];\n            this.itemCount = header[2];\n            this.matrixCount = header[3];\n            this.geomBuffSize = header[4];\n            this.symbolOffset = header[5];\n            this.itemOffset = header[6];\n            this.matrixOffset = header[7];\n            this.geomOffset = header[8];\n\n            var bbox = new Float32Array(buffer, 4 * 9, 6);\n            this.boundingBox = new CLOUD.Math.Box3(\n                new CLOUD.Math.Vector3(bbox[0], bbox[1], bbox[2]),\n                new CLOUD.Math.Vector3(bbox[3], bbox[4], bbox[5]));\n\n            header = null;\n            bbox = null;\n        };\n\n        CLOUD.Reader.Symbol = function (buffer, offset) {\n\n            var item_i = new Int32Array(buffer, offset, 3);\n\n            this.symbolId = item_i[0];\n            this.itemIndex = item_i[1];\n            this.itemCount = item_i[2];\n\n            var bbox = new Float32Array(buffer, offset + 4 * 3, 6);\n            this.boundingBox = new CLOUD.Math.Box3(\n                new CLOUD.Math.Vector3(bbox[0], bbox[1], bbox[2]),\n                new CLOUD.Math.Vector3(bbox[3], bbox[4], bbox[5]));\n\n            item_i = null;\n            bbox = null;\n        };\n\n        CLOUD.Reader.SymbolReader = function (buffer) {\n\n            this.header = new CLOUD.Reader.SymbolHeader(buffer);\n\n            this.symbolSize = 4 * 9;\n            this.itemSize = 4 * 13;\n            this.matrixSize = 4 * 16;\n            this.geomSize = 4 * 8;\n            this.maxSize = 4 * 64;\n            this.boxUvSize = 36;\n            this.pipeUvSize = 18;\n\n            this.symbolBuffer = buffer.slice(this.header.symbolOffset, this.header.symbolOffset + this.header.symbolCount * this.symbolSize);\n            this.itemBuffer = buffer.slice(this.header.itemOffset, this.header.itemOffset + this.header.itemCount * this.itemSize);\n            this.matrixBuffer = buffer.slice(this.header.matrixOffset, this.header.matrixOffset + this.header.matrixCount * this.matrixSize);\n            this.geomBuffer = buffer.slice(this.header.geomOffset, this.header.geomOffset + this.header.geomBuffSize);\n\n            // for data reading\n            this.matr_cur_id = -1;\n\n            this.pt_symb_min = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n            this.pt_symb_max = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n            this.pt_item_min = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n            this.pt_item_max = new CLOUD.Math.Vector3(0.0, 0.0, 0.0);\n\n            var tmp_buffer = new ArrayBuffer(this.maxSize);\n            this.symb_cur = new CLOUD.Reader.Symbol(tmp_buffer, 0);\n            this.item_cur = new CLOUD.Reader.Item(tmp_buffer, 0);\n            this.matr_cur = new CLOUD.Reader.Matrix(tmp_buffer, 0);\n            this.pipe_cur = new CLOUD.Reader.GeomPipe(tmp_buffer, 0);\n\n            this.symb_cur.boundingBox.set(this.pt_symb_min, this.pt_symb_max);\n            this.item_cur.boundingBox.set(this.pt_item_min, this.pt_item_max);\n        };\n\n        CLOUD.Reader.SymbolReader.prototype = {\n\n            constructor: CLOUD.Reader.SymbolReader,\n\n            getSymbol: function (index) {\n\n                if (index >= 0 && index < this.header.symbolCount) {\n                    return new CLOUD.Reader.Symbol(this.symbolBuffer, index * this.symbolSize);\n                }\n            },\n\n            getItem: function (index) {\n\n                if (index >= 0 && index < this.header.itemCount) {\n                    return new CLOUD.Reader.Item(this.itemBuffer, index * this.itemSize);\n                }\n            },\n\n            getMatrix: function (index) {\n\n                if (index >= 0 && index < this.header.matrixCount) {\n                    return new CLOUD.Math.Matrix(this.matrixBuffer, index * this.matrixSize);\n                }\n            },\n\n            getGeomPipe: function (offset) {\n\n                if (offset >= 0 && index < this.header.geomBuffSize) {\n                    return new CLOUD.Reader.GeomPipe(this.geomBuffer, offset);\n                }\n            },\n\n            getSymbolInfo: function (index) {\n\n                if (index >= 0 && index < this.header.symbolCount) {\n\n                    var item_i = new Int32Array(this.symbolBuffer, index * this.symbolSize, 3);\n                    this.symb_cur.symbolId = item_i[0];\n                    this.symb_cur.itemIndex = item_i[1];\n                    this.symb_cur.itemCount = item_i[2];\n\n                    var data_f = new Float32Array(this.symbolBuffer, index * this.symbolSize + 4 * 3, 6);\n                    this.pt_symb_min.set(data_f[0], data_f[1], data_f[2]);\n                    this.pt_symb_max.set(data_f[3], data_f[4], data_f[5]);\n                    this.symb_cur.boundingBox.set(this.pt_symb_min, this.pt_symb_max);\n\n                    return this.symb_cur;\n                }\n            },\n\n            getItemInfo: function (index) {\n\n                if (index >= 0 && index < this.header.itemCount) {\n\n                    var data_i = new Int32Array(this.itemBuffer, index * this.itemSize, 7);\n                    this.item_cur.ItemId = data_i[0];\n                    this.item_cur.originalId = data_i[1];\n                    this.item_cur.materialId = data_i[2];\n                    this.item_cur.userDataId = data_i[3];\n                    this.item_cur.matrixId = data_i[4];\n                    this.item_cur.type = data_i[5];\n                    this.item_cur.toData = data_i[6];\n\n                    var data_f = new Float32Array(this.itemBuffer, index * this.itemSize + 4 * 7, 6);\n                    this.pt_item_min.set(data_f[0], data_f[1], data_f[2]);\n                    this.pt_item_max.set(data_f[3], data_f[4], data_f[5]);\n                    this.item_cur.boundingBox.set(this.pt_item_min, this.pt_item_max);\n\n                    return this.item_cur;\n                }\n            },\n\n            getMatrixInfo: function (index) {\n\n                if (index == this.matr_cur_id) {\n                    return this.matr_cur;\n                }\n\n                if (index >= 0 && index < this.header.matrixCount) {\n\n                    var data = new Float32Array(this.matrixBuffer, index * this.matrixSize, 4 * 4);\n                    this.matr_cur.matrix.fromArray(data);\n\n                    this.matr_cur_id = index;\n                    return this.matr_cur;\n                }\n            },\n\n            getGeomPipeInfo: function (offset) {\n\n                if (offset >= 0 && offset < this.header.geomBuffSize) {\n\n                    var data = new Float32Array(this.geomBuffer, offset, 8);\n\n                    this.pipe_cur.startPt.set(data[0], data[1], data[2]);\n                    this.pipe_cur.endPt.set(data[3], data[4], data[5]);\n                    this.pipe_cur.radius = data[6];\n                    this.pipe_cur.thickness = data[7];\n\n                    return this.pipe_cur;\n                }\n            },\n\n            getGeomBoxUvInfo: function (offset) {\n\n                if (offset >= 0 && (offset + this.boxUvSize * 4) <= this.header.geomBuffSize) {\n\n                    return new Float32Array(this.geomBuffer, offset, this.boxUvSize);\n                }\n            },\n\n            getGeomPipeUvInfo: function (offset) {\n\n                if (offset >= 0 && (offset + this.pipeUvSize * 4) <= this.header.geomBuffSize) {\n\n                    return new Float32Array(this.geomBuffer, offset, this.pipeUvSize);\n                }\n            },\n\n            getMpkID: function (mesh_id) {\n\n                return parseInt(mesh_id / 65536);\n            },\n\n            getMeshIndex: function (mesh_id) {\n\n            }\n        };\n    \n    "}(),function(){
CLOUD.Workers.WorkerChunk.SceneParseChunk="\n\n        function parseItemData(sceneReader, symbolReader) {\n\n            var nodeMap = {};\n\n            for (var i = 0, iLen = sceneReader.header.cellCount; i < iLen; ++i) {\n\n                var cell = sceneReader.getCellInfo(i);\n\n                for (var j = cell.itemIndex; j < cell.itemCount; ++j) {\n\n                    readItemData(sceneReader, symbolReader, j, i, nodeMap);\n\n                }\n            }\n\n            return nodeMap;\n\n        }\n\n        /**\n         * 读取mesh信息或symbol信息\n         *\n         * @param {Object} sceneReader - 场景reader\n         * @param {Number} idx - 项目索引\n         * @param {Number} cellId - 空间cell id\n         */\n        function readItemData(sceneReader, symbolReader, idx, cellId, nodeMap) {\n\n            var item = sceneReader.getItemInfo(idx);\n\n            if (item === void 0) {\n                return;\n            }\n\n            if (item.type === CLOUD.Reader.EnumNodeItemType.SYMBOL) {\n                readSymbolInfo(sceneReader, symbolReader, cellId, item, nodeMap);\n            } else {\n                readMeshInfo(sceneReader, cellId, item, null, nodeMap);\n            }\n\n        }\n\n        /**\n         * 读取symbol信息\n         *\n         * @param {Object} sceneReader - 场景reader\n         * @param {Number} cellId - 空间cell id\n         * @param {Object} item - ItemInfo\n         */\n        function readSymbolInfo(sceneReader, symbolReader, cellId, item, nodeMap) {\n\n            // var symbolReader = this.symbolReader;\n            if (!symbolReader) {\n                return;\n            }\n\n            var symbolCount = symbolReader.header.symbolCount;\n            var id = item.toData;\n\n            if (id < 0 || id > symbolCount) {\n                return;\n            }\n\n            var matrixParent = sceneReader.getMatrixInfo(item.matrixId).matrix.clone();\n            var itemParent = {\n                matrix: matrixParent,\n                ItemId: item.ItemId,\n                originalId: item.originalId,\n                userDataId: item.userDataId,\n                materialId: item.materialId\n            };\n\n            var symbolCurrent = symbolReader.getSymbolInfo(id);\n\n            for (var i = symbolCurrent.itemIndex; i < symbolCurrent.itemCount; ++i) {\n\n                var symbolItem = symbolReader.getItemInfo(i);\n\n                if (symbolItem.type === CLOUD.Reader.EnumNodeItemType.SYMBOL) {\n                    continue;\n                }\n\n                readMeshInfo(symbolReader, cellId, symbolItem, itemParent, nodeMap);\n            }\n\n            matrixParent = null;\n            itemParent = null;\n        }\n\n        /**\n         * 读取mesh信息\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Number} cellId - 空间cell id\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function readMeshInfo(reader, cellId, item, itemParent, nodeMap) {\n\n            var userDataId;\n            var originalId;\n            var mtlId;\n\n            if (itemParent === null) {\n                userDataId = item.userDataId;\n                originalId = item.originalId;\n                mtlId = item.materialId;\n            } else { // itemParent存在, 表示读取symbol数据\n                userDataId = itemParent.userDataId;\n                originalId = itemParent.originalId;\n                // BIMFACEDM-2599\n                // symbol instance's material id: exist(>=0) or non-exist(-1)\n                // if symbol instance get own material, all child element of symbol use instance'\n                // material, else use child's own material\n                mtlId = (itemParent.materialId > -1) ? itemParent.materialId : item.materialId;\n            }\n\n            var nodeInfo = null;\n            var nodeItemType = CLOUD.Reader.EnumNodeItemType;\n            switch (item.type) {\n                case nodeItemType.MESH:\n                    nodeInfo = getMeshNodeAttr(reader, item, itemParent);\n                    break;\n                case nodeItemType.TUBE:\n                    nodeInfo = getMeshNodeAttrOfTube(reader, item, itemParent);\n                    break;\n                case nodeItemType.PIPE:\n                    nodeInfo = getMeshNodeAttrOfPipe(reader, item, itemParent);\n                    break;\n                case nodeItemType.BOX:\n                    nodeInfo = getMeshNodeAttrOfBox(reader, item, itemParent);\n                    break;\n                case nodeItemType.BOX_M:\n                    nodeInfo = getMeshNodeAttrOfBoxM(reader, item, itemParent);\n                    break;\n                case nodeItemType.PIPE_M:\n                    nodeInfo = getMeshNodeAttrOfPipeM(reader, item, itemParent);\n                    break;\n                case nodeItemType.MESH_REF:\n                    nodeInfo = getMeshNodeAttrOfMeshRef(reader, item, itemParent);\n                    break;\n                case nodeItemType.LINE:\n                    nodeInfo = getLineNodeAttr(reader, item, itemParent);\n                    break;\n                default:\n                    break;\n            }\n\n            if (!nodeInfo) {\n                return;\n            }\n\n            nodeInfo.userId = originalId;\n            nodeInfo.userDataId = userDataId;\n            nodeInfo.type = item.type;\n            nodeInfo.cellId = cellId;\n            nodeInfo.materialId = mtlId;\n            nodeInfo.itemIdUV2 = itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId;\n\n            if (!nodeMap[nodeInfo.userId]) {\n                nodeMap[nodeInfo.userId] = [];\n            }\n\n            nodeMap[nodeInfo.userId].push(nodeInfo);\n\n        }\n\n        /**\n         * 获得 pipe node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttrOfPipe(sceneOrSymbolReader, item, itemParent) {\n\n            var matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n            if (itemParent) {\n                matrix.multiplyMatrices(itemParent.matrix, matrix);\n            }\n\n            var boundingBox = item.boundingBox.clone();\n            boundingBox.applyMatrix4(matrix);\n\n            var geomAttr = sceneOrSymbolReader.getGeomPipeInfo(item.toData);\n            var startPt = geomAttr.startPt;\n            var endPt = geomAttr.endPt;\n\n            var dir = new CLOUD.Math.Vector3();\n            dir.subVectors(endPt, startPt);\n\n            var len = dir.length();\n            dir.normalize();\n\n            var radius = geomAttr.radius;\n            if (radius <= 1) {\n                radius = 100;\n            }\n\n            var unitY = new CLOUD.Math.Vector3(0, 1, 0);\n            var scale = new CLOUD.Math.Vector3(radius, len, radius);\n            var quaternion = new CLOUD.Math.Quaternion().setFromUnitVectors(unitY, dir);\n            var position = startPt.clone().addScaledVector(dir, len * 0.5);\n            var matrixTmp = new CLOUD.Math.Matrix4().compose(position, quaternion, scale);\n            matrix.multiply(matrixTmp);\n\n            geomAttr = null;\n\n            return {\n                nodeId: (itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId) + '_pipe',\n                geometryId: 'pipe',\n                boundingBox: boundingBox,\n                matrix: matrix\n            };\n        }\n\n        /**\n         * 获得 tube node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttrOfTube(sceneOrSymbolReader, item, itemParent) {\n\n            var nodeInfo = getMeshNodeAttrOfPipe(sceneOrSymbolReader, item, itemParent);\n            nodeInfo.nodeId += \"_tube\";\n            nodeInfo.geometryId = \"tube\";\n\n            return nodeInfo;\n        }\n\n        /**\n         * 获得 box node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttrOfBox(sceneOrSymbolReader, item, itemParent) {\n\n            var matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n            if (itemParent) {\n                matrix.multiplyMatrices(itemParent.matrix, matrix);\n            }\n\n            var boundingBox = item.boundingBox.clone();\n            boundingBox.applyMatrix4(matrix);\n\n            var bBox = item.boundingBox;\n            var boxSize = bBox.getSize();\n            var boxCenter = bBox.getCenter();\n\n            var matrixTmp = new CLOUD.Math.Matrix4().scale(new CLOUD.Math.Vector3(boxSize.x, boxSize.y, boxSize.z));\n            matrixTmp.setPosition(boxCenter);\n            matrix.multiply(matrixTmp);\n\n            return {\n                nodeId: (itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId) + '_box',\n                geometryId: 'box',\n                boundingBox: boundingBox,\n                matrix: matrix\n            };\n        }\n\n        /**\n         * 获得 boxM node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttrOfBoxM(sceneOrSymbolReader, item, itemParent) {\n\n            var matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n            if (itemParent) {\n                matrix.multiplyMatrices(itemParent.matrix, matrix);\n            }\n\n            var boundingBox = item.boundingBox.clone();\n            boundingBox.applyMatrix4(matrix);\n\n            return {\n                nodeId: (itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId) + '_boxM',\n                geometryId: 'boxM',\n                boundingBox: boundingBox,\n                matrix: matrix,\n                uvArrayBuffer: sceneOrSymbolReader.getGeomBoxUvInfo(item.toData)\n            };\n        }\n\n        /**\n         * 获得 pipeM node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttrOfPipeM(sceneOrSymbolReader, item, itemParent) {\n\n            var matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n            if (itemParent) {\n                matrix.multiplyMatrices(itemParent.matrix, matrix);\n            }\n\n            var boundingBox = item.boundingBox.clone();\n            boundingBox.applyMatrix4(matrix);\n\n            return {\n                nodeId: (itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId) + '_pipeM',\n                geometryId: 'pipeM',\n                boundingBox: boundingBox,\n                matrix: matrix,\n                uvArrayBuffer: sceneOrSymbolReader.getGeomPipeUvInfo(item.toData)\n            };\n        }\n\n        /**\n         * 获得共享的 mesh node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttrOfMeshRef(sceneOrSymbolReader, item, itemParent) {\n\n            var matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n            if (itemParent) {\n                matrix.multiplyMatrices(itemParent.matrix, matrix);\n            }\n\n            var boundingBox = item.boundingBox.clone();\n            boundingBox.applyMatrix4(matrix);\n\n            return {\n                nodeId: \"refMesh|\" + (itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId),\n                geometryId: item.toData,\n                boundingBox: boundingBox,\n                matrix: matrix\n            };\n        }\n\n        /**\n         * 获得 mesh node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getMeshNodeAttr(sceneOrSymbolReader, item, itemParent) {\n\n            var boundingBox = item.boundingBox.clone();\n            var matrix;\n\n            if (item.matrixId !== -1) {\n\n                matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n                if (itemParent) {\n                    matrix.multiplyMatrices(itemParent.matrix, matrix);\n                }\n                boundingBox.applyMatrix4(matrix);\n\n            } else {\n\n                matrix = new CLOUD.Math.Matrix4();\n                if (itemParent) {\n                    boundingBox.applyMatrix4(itemParent.matrix);\n                }\n\n            }\n\n            return {\n                nodeId: itemParent ? itemParent.ItemId + \"_\" + item.ItemId : item.ItemId,\n                geometryId: item.toData,\n                boundingBox: boundingBox,\n                matrix: matrix\n            };\n        }\n\n        /**\n         * 获得 line node info\n         *\n         * @param {Object} reader - scene reader | symbol reader\n         * @param {Object} item - item info\n         * @param {Object} itemParent - parent item info\n         */\n        function getLineNodeAttr(sceneOrSymbolReader, item, itemParent) {\n\n            var boundingBox = item.boundingBox.clone();\n            var matrix;\n\n            if (item.matrixId !== -1) {\n\n                matrix = sceneOrSymbolReader.getMatrixInfo(item.matrixId).matrix.clone();\n                if (itemParent) {\n                    matrix.multiplyMatrices(itemParent.matrix, matrix);\n                }\n                boundingBox.applyMatrix4(matrix);\n\n            } else {\n\n                matrix = new CLOUD.Math.Matrix4();\n                if (itemParent) {\n                    boundingBox.applyMatrix4(itemParent.matrix);\n                }\n\n            }\n\n            return {\n                nodeId: itemParent ? 'line-' + itemParent.ItemId + \"-\" + item.ItemId : 'line-' + item.ItemId,\n                geometryId: 'line-' + item.toData,\n                boundingBox: boundingBox,\n                matrix: matrix\n            };\n        }\n\n        function isParameterized(nodeInfo) {\n\n            return (nodeInfo.type === CLOUD.Reader.EnumNodeItemType.TUBE ||\n                nodeInfo.type === CLOUD.Reader.EnumNodeItemType.PIPE ||\n                nodeInfo.type === CLOUD.Reader.EnumNodeItemType.BOX ||\n                nodeInfo.type === CLOUD.Reader.EnumNodeItemType.BOX_M ||\n                nodeInfo.type === CLOUD.Reader.EnumNodeItemType.PIPE_M);\n\n        }\n\n        function parseScene(parameters) {\n            \n            var sceneBufferData = parameters.sceneBufferData;\n            var symbolBufferData = parameters.symbolBufferData;\n            var sceneReader = new CLOUD.Reader.SceneReader(sceneBufferData);\n            var symbolReader = symbolBufferData ? new CLOUD.Reader.SymbolReader(symbolBufferData) : null;\n            var nodeInfoMap = parseItemData(sceneReader, symbolReader);\n\n            return {\n                nodeInfoMap: CLOUD.Utils.str2ab(JSON.stringify(nodeInfoMap))\n            };\n\n        }\n\n        self.addEventListener('message', function (event) {\n\n            var data = event.data;\n\n            //console.time('T_parseScene_worker');\n            var result = parseScene(data);\n            //console.timeEnd('T_parseScene_worker');\n\n            self.postMessage(result, [result.nodeInfoMap]);\n            self.close();\n\n        }, false);\n\n    "}(),function(){
CLOUD.Workers.WorkerChunk.MeshCreateChunk="\n\n        function mergeBuffersBy(materialKey, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId, brief, mergedBufferMap) {\n\n            var nodeInfos = nodeInfoMapOnMaterial[materialKey];\n            var segmentMergeEnabled = brief.segmentMergeEnabled;\n            var maxIndicesNumberPerBathSegment = brief.maxIndicesNumberPerBathSegment;\n            var arrayPositionLength = 0;\n            var arrayIndexLength = 0;\n            var arrayNormalLength = 0;\n            var arrayUVLength = 0;\n            var arrayUV2Length = 0;\n            var nodeBuffer = null;\n            var sections = [];\n            var start = 0;\n\n            for (var i = 0, len = nodeInfos.length; i < len; i++) {\n                var nodeInfo = nodeInfos[i];\n                nodeBuffer = nodeBufferMapOnNodeId[nodeInfo.nodeId];\n                if (!nodeBuffer) {\n                    // 最后一个\n                    if (i === len - 1) {\n                        sections.push({\n                            start: start,\n                            end: len,\n                            arrayPositionLength: arrayPositionLength,\n                            arrayIndexLength: arrayIndexLength,\n                            arrayNormalLength: arrayNormalLength,\n                            arrayUVLength: arrayUVLength,\n                            arrayUV2Length: arrayUV2Length\n                        });\n                    }\n                    continue;\n                }\n\n                arrayIndexLength += nodeBuffer.index.length;\n                arrayPositionLength += nodeBuffer.position.length;\n                if (nodeBuffer.normal) {\n                    arrayNormalLength += nodeBuffer.normal.length;\n                }\n                if (nodeBuffer.uv) {\n                    arrayUVLength += nodeBuffer.uv.length;\n                }\n                if (nodeBuffer.uv2) {\n                    arrayUV2Length += nodeBuffer.uv2.length;\n                }\n\n                if (segmentMergeEnabled) {\n\n                    if (arrayIndexLength > maxIndicesNumberPerBathSegment) {\n\n                        arrayIndexLength -= nodeBuffer.index.length;\n                        arrayPositionLength -= nodeBuffer.position.length;\n                        if (nodeBuffer.normal) {\n                            arrayNormalLength -= nodeBuffer.normal.length;\n                        }\n                        if (nodeBuffer.uv) {\n                            arrayUVLength -= nodeBuffer.uv.length;\n                        }\n                        if (nodeBuffer.uv2) {\n                            arrayUV2Length -= nodeBuffer.uv2.length;\n                        }\n\n                        sections.push({\n                            start: start,\n                            end: i,\n                            arrayPositionLength: arrayPositionLength,\n                            arrayIndexLength: arrayIndexLength,\n                            arrayNormalLength: arrayNormalLength,\n                            arrayUVLength: arrayUVLength,\n                            arrayUV2Length: arrayUV2Length\n                        });\n\n                        arrayPositionLength = 0;\n                        arrayIndexLength = 0;\n                        arrayNormalLength = 0;\n                        arrayUVLength = 0;\n                        arrayUV2Length = 0;\n                        start = i;\n                        i -= 1; //上一个\n                    } else {\n                        if (i === len - 1) {\n                            sections.push({\n                                start: start,\n                                end: len,\n                                arrayPositionLength: arrayPositionLength,\n                                arrayIndexLength: arrayIndexLength,\n                                arrayNormalLength: arrayNormalLength,\n                                arrayUVLength: arrayUVLength,\n                                arrayUV2Length: arrayUV2Length\n                            });\n                        }\n                    }\n                } else {\n                    if (i === len - 1) {\n                        sections.push({\n                            start: start,\n                            end: len,\n                            arrayPositionLength: arrayPositionLength,\n                            arrayIndexLength: arrayIndexLength,\n                            arrayNormalLength: arrayNormalLength,\n                            arrayUVLength: arrayUVLength,\n                            arrayUV2Length: arrayUV2Length\n                        });\n                    }\n                }\n\n                nodeBuffer = null;\n            }\n\n            for (var k = 0, kLen = sections.length; k < kLen; k++) {\n                var section = sections[k];\n                var indicesGroup = {};\n\n                var arrayPosition = new Float32Array(section.arrayPositionLength);\n                var arrayIndex = new Uint32Array(section.arrayIndexLength);\n                var arrayNormal = new Float32Array(section.arrayNormalLength);\n                var arrayUV = new Float32Array(section.arrayUVLength);\n                var arrayUV2 = new Float32Array(section.arrayUV2Length);\n                var offsetPosition = 0;\n                var offsetIndex = 0;\n                var offsetNormal = 0;\n                var offsetUV = 0;\n                var offsetUV2 = 0;\n\n                var nodeIdArray = [];\n\n                for (var i = section.start, len = section.end; i < len; i++) {\n                    var nodeInfo = nodeInfos[i];\n                    nodeBuffer = nodeBufferMapOnNodeId[nodeInfo.nodeId];\n                    if (!nodeBuffer) {\n                        continue;\n                    }\n\n                    nodeIdArray.push(nodeInfo.nodeId);\n\n                    var index = nodeBuffer.index;\n                    var position = nodeBuffer.position;\n                    var normal = nodeBuffer.normal;\n                    var uv = nodeBuffer.uv;\n                    var uv2 = nodeBuffer.uv2;\n\n                    arrayPosition.set(position, offsetPosition);\n                    var indexTmp = Uint32Array.from(index);\n                    for (var j = 0, jLen = indexTmp.length; j < jLen; j++) {\n                        indexTmp[j] += offsetPosition / 3;\n                    }\n                    arrayIndex.set(indexTmp, offsetIndex);\n\n                    // 建立索引表\n                    if (indicesGroup[nodeInfo.userId] === void 0) {\n                        indicesGroup[nodeInfo.userId] = [];\n                    }\n                    indicesGroup[nodeInfo.userId].push({\n                        userId: nodeInfo.userId,\n                        nodeId: nodeInfo.nodeId,\n                        positionStart: offsetPosition,\n                        positionCount: position.length,\n                        indexStart: offsetIndex,\n                        indexCount: index.length,\n                        lightmapIdx: nodeInfo.lightmapIdx,\n                        boundingBox: nodeInfo.boundingBox\n                    });\n\n                    offsetIndex += index.length;\n                    offsetPosition += position.length;\n\n                    if (normal) {\n                        arrayNormal.set(normal, offsetNormal);\n                        offsetNormal += normal.length;\n                    }\n\n                    if (uv) {\n                        arrayUV.set(uv, offsetUV);\n                        offsetUV += uv.length;\n                    }\n\n                    if (uv2) {\n                        arrayUV2.set(uv2, offsetUV2);\n                        offsetUV2 += uv2.length;\n                    }\n\n                    index = null;\n                    position = null;\n                    normal = null;\n                    uv = null;\n                    uv2 = null;\n                    nodeBuffer = null;\n\n                }\n\n                if (mergedBufferMap[materialKey] === void 0) {\n                    mergedBufferMap[materialKey] = [];\n                }\n\n                mergedBufferMap[materialKey].push({\n                    bufferData: {\n                        index: arrayIndex.buffer,\n                        position: arrayPosition.buffer,\n                        normal: offsetNormal > 0 ? arrayNormal.buffer : undefined,\n                        uv: offsetUV > 0 ? arrayUV.buffer : undefined,\n                        uv2: offsetUV2 > 0 ? arrayUV2.buffer : undefined\n                    },\n                    indices: indicesGroup\n                });\n            }\n        }\n\n        function createNodeBuffer(nodeInfo, nodeItemType, bufferDataObject) {\n\n            var buffer = bufferDataObject ? bufferDataObject.buffer : undefined;\n            var indexInfo = bufferDataObject ? bufferDataObject.indexInfo : undefined;\n            var position, index, normal, uv;\n\n            switch (nodeInfo.type) {\n                case nodeItemType.LINE:\n                case nodeItemType.MESH:\n                case nodeItemType.MESH_REF:\n\n                    if (!buffer) {\n                        return null;\n                    }\n\n                    index = new Uint32Array(buffer.I);\n                    position = new Float32Array(buffer.P);\n                    normal = buffer.N && buffer.N.byteLength ? new Float32Array(buffer.N) : null;\n                    uv = buffer.UV && buffer.UV.byteLength ? new Float32Array(buffer.UV) : null;\n\n                    if (indexInfo) {\n\n                        index = index.slice(indexInfo.indexStart,\n                            indexInfo.indexStart + indexInfo.indexCount);\n                        position = position.slice(indexInfo.positionStart,\n                            indexInfo.positionStart + indexInfo.positionCount);\n                        normal = normal ? normal.slice(indexInfo.positionStart,\n                            indexInfo.positionStart + indexInfo.positionCount) : null;\n                        uv = uv ? uv.slice(indexInfo.uvStart,\n                            indexInfo.uvStart + indexInfo.uvCount) : null;\n\n                        var startPositon = indexInfo.positionStart / 3;\n                        index.forEach(function (element, index, array) {\n                            array[index] -= startPositon;\n                        });\n\n                    } else {\n\n                        index = index.slice(0);\n                        position = position.slice(0);\n                        normal = normal ? normal.slice(0) : null;\n                        uv = uv ? uv.slice(0) : null;\n\n                    }\n\n                    // 是否镜像\n                    if (CLOUD.Utils.isMirror(nodeInfo.matrix.elements)) {\n\n                        for (var i = 0, iLen = index.length; i < iLen; i += 3) {\n                            var tmp = index[i + 1];\n                            index[i + 1] = index[i + 2];\n                            index[i + 2] = tmp;\n                        }\n\n                    }\n\n                    break;\n                case nodeItemType.BOX:\n                case nodeItemType.BOX_M:\n                case nodeItemType.PIPE:\n                case nodeItemType.TUBE:\n                case nodeItemType.PIPE_M:\n\n                    var dataM = (nodeInfo.type === nodeItemType.BOX_M ||\n                            nodeInfo.type === nodeItemType.BOX) ?\n                        CLOUD.GeomUtil.getBoxMBuffer(nodeInfo.uvArrayBuffer) :\n                        CLOUD.GeomUtil.getPipeMBuffer(nodeInfo.uvArrayBuffer);\n\n                    index = Uint32Array.from(dataM.index);\n                    position = Float32Array.from(dataM.vertex);\n                    normal = Float32Array.from(dataM.normal);\n\n                    if (dataM.uv) {\n                        uv = Float32Array.from(dataM.uv);\n                        delete dataM.uv;\n                    } else {\n                        uv = null;\n                    }          \n\n                    break;\n\n                default:\n                    console.log(\"error data!\");\n                    break;\n            }\n\n            var matrix = nodeInfo.matrix;\n\n            // 变换顶点坐标\n            CLOUD.Utils.applyMatrix4ToBuffer(matrix, position);\n\n            // 变换法线\n            if (normal) {\n                var normalMatrix = new CLOUD.Math.Matrix3();\n                normalMatrix.getNormalMatrix(matrix);\n                CLOUD.Utils.applyMatrix3ToBuffer(normalMatrix, normal);\n                CLOUD.Utils.normalizeBuffer(normal);\n            }\n\n            return {\n                index: index,\n                position: position,\n                normal: normal,\n                uv: uv\n            };\n        }\n\n        /**\n         *\n         * @param {string} itemId -itemId有两种：\"scene\"+itemId; \"symbol\"+itemId\n         * @param {number} indexNum -item的index数量，即uv的数量\n         */\n        function getUV2ById(uv2BufferData, itemId, indexNum){\n\n            if (!uv2BufferData || !indexNum){\n                return null;\n            }\n\n            var uv2MapItem = uv2BufferData.uv2MapItem[itemId];\n            if (!uv2MapItem) {\n                return null;\n            }\n\n            var scale = uv2MapItem.uv1Scale;\n            var translation = uv2MapItem.uv1Translation;\n\n            var offset = uv2MapItem.uv1ByteOffset / 2;\n            var length = indexNum * 2;\n\n            var uv2Array = uv2BufferData.uv2Buffer.slice(offset, offset + length);\n            var uv2 = [];//与index对应的uv2\n            for (var i = 0; i < length; i += 2) {\n                uv2.push((scale[0] * (uv2Array[i] / 65535.0) + translation[0]));\n                uv2.push((scale[1] * (uv2Array[i + 1] / 65535.0) + translation[1]));\n            }\n\n            return {\n                lightmapIdx: uv2MapItem.lightmapIdx, \n                uv2: uv2\n            };\n\n        }\n\n        function createNodeBufferWithUV2(nodeInfo, nodeItemType, bufferDataObject){\n\n            var nodeBuffer = createNodeBuffer(nodeInfo, nodeItemType, bufferDataObject);\n            \n            if (!bufferDataObject || !bufferDataObject.uv2BufferData) {\n                return nodeBuffer;\n            }\n\n            //数据中存在lightmap就需要展开psition等属性\n            var uv2 = [];\n            var index = nodeBuffer.index;\n            var uv2Info = getUV2ById(bufferDataObject.uv2BufferData, nodeInfo.itemIdUV2, index.length);\n\n            if (uv2Info) {\n                nodeInfo.lightmapIdx = uv2Info.lightmapIdx;\n                uv2 = uv2Info.uv2;\n            }\n\n            //不同三角面片的同一个点可能对应不同的uv2，需要展开\n            var position2 = nodeBuffer.position;\n            var normal2 = nodeBuffer.normal;\n            var uvv = nodeBuffer.uv;\n\n            var position = [];\n            var normal = [];\n            var uv = [];\n\n            for (var i = 0; i < index.length; i++) {\n\n                var idx = index[i];\n\n                position.push(position2[idx * 3]);\n                position.push(position2[idx * 3 + 1]);\n                position.push(position2[idx * 3 + 2]);\n\n                if(normal2)\n                {\n                    normal.push(normal2[idx * 3]);\n                    normal.push(normal2[idx * 3 + 1]);\n                    normal.push(normal2[idx * 3 + 2]);\n                }\n\n\n                if (uvv) {\n                    uv.push(uvv[idx * 2]);\n                    uv.push(uvv[idx * 2 + 1]);\n                }\n\n                index[i] = i;\n            }\n\n            position2 = null;\n            normal2 = null;\n            uvv = null;\n\n            nodeBuffer.uv2 = uv2;\n            nodeBuffer.position = position;\n            nodeBuffer.normal = normal;\n            nodeBuffer.uv = uv;\n\n            return nodeBuffer;\n        }\n\n        function getMaterialKeyByNodeInfo(nodeInfo, nodeItemType) {\n\n            return CLOUD.Utils.getCombinedKeyString([\n                nodeInfo.materialId,\n                nodeInfo.uv ? '1' : '0',\n                nodeInfo.type === nodeItemType.LINE ? 'lines' : 'meshes'\n            ]);\n\n        }\n\n        function getPropertyValueByMaterialKey(key) {\n\n            var splitArr = CLOUD.Utils.splitCombinedKeyString(key);\n\n            return {\n                materialId: splitArr[0],\n                uvProp: splitArr[1],\n                type: splitArr[2],\n            }\n        }\n\n        function collectNodeInfos(dataBuffers, brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId) {\n\n            var i, iLen;\n\n            if (brief.type === 'shared') {\n\n                for (i = 0, iLen = dataBuffers.length; i < iLen; i++) {\n                    collectNodeInfosFromSharedGeometries(dataBuffers[i], brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId);\n                }\n\n            }\n\n            if (brief.type === 'unique') {\n\n                for (i = 0, iLen = dataBuffers.length; i < iLen; i++) {\n                    collectNodeInfosFromUniqueGeometries(dataBuffers[i], brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId);\n                }\n\n            }\n\n            if (brief.type === 'parameterized') {\n\n                for (i = 0, iLen = dataBuffers.length; i < iLen; i++) {\n                    collectNodeInfosFromParameterizedGeometries(dataBuffers[i], brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId);\n                }\n\n            }\n\n        }\n\n        function collectNodeInfosFromParameterizedGeometries(bufferData, brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId) {\n\n            var meshId = bufferData.meshId;\n            var nodeItemType = brief.nodeItemType;\n            var nodeInfoMap = brief.nodeInfoMap;\n            var nodeInfos = nodeInfoMap[meshId];\n\n            if (!nodeInfos) {\n                return;\n            }\n\n            for (var i = 0, iLen = nodeInfos.length; i < iLen; i++) {\n\n                var nodeInfo = nodeInfos[i];\n                var nodeBuffer = createNodeBuffer(nodeInfo, nodeItemType);\n\n                // 缓存buffer用于合并\n                nodeBufferMapOnNodeId[nodeInfo.nodeId] = nodeBuffer;\n                // 是否存在uv\n                nodeInfo.uv = nodeBuffer.uv ? true : false;\n\n                // 根据materialId&uv&type编码\n                var materialKey = getMaterialKeyByNodeInfo(nodeInfo, nodeItemType);\n\n                if (!nodeInfoMapOnMaterial[materialKey]) {\n                    nodeInfoMapOnMaterial[materialKey] = [];\n                }\n\n                nodeInfoMapOnMaterial[materialKey].push(nodeInfo);\n            }\n\n        }\n\n        function collectNodeInfosFromUniqueGeometries(bufferData, brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId) {\n\n            var meshId = bufferData.meshId;\n            var nodeItemType = brief.nodeItemType;\n            var nodeInfoMap = brief.nodeInfoMap;\n            var nodeInfos = nodeInfoMap[meshId];            \n            var uv2BufferData = brief.uv2BufferData;\n\n            if (!nodeInfos) {\n                return;\n            }\n\n            for (var i = 0, iLen = nodeInfos.length; i < iLen; i++) {\n\n                var nodeInfo = nodeInfos[i];\n                var nodeBuffer = createNodeBufferWithUV2(nodeInfo, nodeItemType, {\n                    buffer: bufferData,\n                    uv2BufferData: uv2BufferData\n                });\n\n                // 缓存buffer用于合并\n                nodeBufferMapOnNodeId[nodeInfo.nodeId] = nodeBuffer;\n                // 是否存在uv\n                nodeInfo.uv = nodeBuffer.uv ? true : false;\n\n                // 根据materialId&uv&type编码\n                var materialKey = getMaterialKeyByNodeInfo(nodeInfo, nodeItemType);\n\n                if (!nodeInfoMapOnMaterial[materialKey]) {\n                    nodeInfoMapOnMaterial[materialKey] = [];\n                }\n\n                nodeInfoMapOnMaterial[materialKey].push(nodeInfo);\n            }\n\n        }\n\n        function collectNodeInfosFromSharedGeometries(bufferData, brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId) {\n\n            var indexInfos = bufferData.IndexInfos;\n            var nodeItemType = brief.nodeItemType;\n            var nodeInfoMap = brief.nodeInfoMap;            \n            var uv2BufferData = brief.uv2BufferData;\n\n            for (var i = 0, iLen = indexInfos.length; i < iLen; i++) {\n\n                var indexInfo = indexInfos[i];\n                var nodeInfos = nodeInfoMap[indexInfo.meshId];\n\n                if (!nodeInfos) {\n                    continue;\n                }\n\n                for (var k = 0, kLen = nodeInfos.length; k < kLen; k++) {\n\n                    var nodeInfo = nodeInfos[k];\n                    var nodeBuffer = createNodeBufferWithUV2(nodeInfo, nodeItemType, {\n                        buffer: bufferData,\n                        indexInfo: indexInfo,\n                        uv2BufferData: uv2BufferData\n                    });\n\n                    // 缓存buffer用于合并\n                    nodeBufferMapOnNodeId[nodeInfo.nodeId] = nodeBuffer;\n\n                    // 是否存在uv\n                    nodeInfo.uv = nodeBuffer.uv ? true : false;\n\n                    // 根据materialId&uv&type编码\n                    var materialKey = getMaterialKeyByNodeInfo(nodeInfo, nodeItemType);\n\n                    if (!nodeInfoMapOnMaterial[materialKey]) {\n                        nodeInfoMapOnMaterial[materialKey] = [];\n                    }\n\n                    nodeInfoMapOnMaterial[materialKey].push(nodeInfo);\n                }\n\n            }\n\n        }\n\n        function createMeshes(parameters) {\n\n            // var brief = {\n            //     type,\n            //     segmentEnabled,\n            //     maxIndicesNumberPerBathSegment,\n            //     nodeItemType,\n            //     nodeInfoMap\n            // };\n            var brief = JSON.parse(CLOUD.Utils.ab2str(parameters.brief));\n            var dataBuffers = parameters.dataBuffers;\n            var nodeInfoMapOnMaterial = {};\n            var nodeBufferMapOnNodeId = {};\n            var mergedBufferMap = {};\n\n            // 收集nodeInfos\n            collectNodeInfos(dataBuffers, brief, nodeInfoMapOnMaterial, nodeBufferMapOnNodeId);\n           \n            // 合并buffers\n            var materialKeys = Object.keys(nodeInfoMapOnMaterial);\n\n            for (var i = 0, iLen = materialKeys.length; i < iLen; i++) {\n                mergeBuffersBy(materialKeys[i], nodeInfoMapOnMaterial, nodeBufferMapOnNodeId, brief, mergedBufferMap);\n            }\n\n            var transferableObjects = [];\n\n            for (var j = 0, jLen = materialKeys.length; j < jLen; j++) {\n\n                var mergedBuffers = mergedBufferMap[materialKeys[j]];\n\n                for (var k = 0, kLen = mergedBuffers.length; k < kLen; k++) {\n\n                    var bufferData = mergedBuffers[k].bufferData;\n\n                    transferableObjects.push(bufferData.index);\n                    transferableObjects.push(bufferData.position);\n\n                    if (bufferData.normal) {\n                        transferableObjects.push(bufferData.normal);\n                    }\n\n                    if (bufferData.uv) {\n                        transferableObjects.push(bufferData.uv);\n                    }\n\n                    if (bufferData.uv2) {\n                        transferableObjects.push(bufferData.uv2);\n                    }\n                }\n\n            }\n\n            return {\n                data: {dataBuffers: mergedBufferMap},\n                transferableObjects: transferableObjects\n            };\n        }\n\n        self.addEventListener('message', function (event) {\n\n            var data = event.data;\n\n            console.time('T_worker_createMeshes');\n\n            var result = createMeshes(data);\n\n            console.timeEnd('T_worker_createMeshes');\n\n            self.postMessage(result.data, result.transferableObjects);\n\n            self.close();\n\n        }, false);\n    "}(),function(){CLOUD.Workers.WorkerChunk.BorderLineCreateChunk="\n\n        function createBorderLines(parameters) {\n            \n            var nodeInfosObject = JSON.parse(CLOUD.Utils.ab2str(parameters.infos));\n            var bufferDataArray = parameters.bufferDataArray;\n            var i, iLen;\n            var j, jLen;\n        \n            var userIdMap = {};\n        \n            for (var k = 0, kLen = bufferDataArray.length; k < kLen; k++) {\n        \n                var bufferData = bufferDataArray[k];\n                var indexInfos = bufferData.IndexInfos;\n        \n                var arrIndex = new Uint32Array(bufferData.I);\n                var arrPosition = new Float32Array(bufferData.P);\n        \n                // 按 userId 收集边框线\n                for (i = 0, iLen = indexInfos.length; i < iLen; i++) {\n        \n                    var indexInfo = indexInfos[i];\n                    var geometryId = indexInfo.meshId;\n                    var nodeInfos = nodeInfosObject[geometryId];\n                    if (!nodeInfos) {\n                        continue;\n                    }            \n        \n                    for (j = 0, jLen = nodeInfos.length; j < jLen; j++) {\n        \n                        var nodeInfo = nodeInfos[j];\n                        var newPosition = arrPosition.slice(indexInfo.positionStart, indexInfo.positionStart + indexInfo.positionCount);\n                        var startPositon = indexInfo.positionStart / 3;\n                        var newIndex = arrIndex.slice(indexInfo.indexStart, indexInfo.indexStart + indexInfo.indexCount);\n                        newIndex.forEach(function (element, index, array) {\n                            array[index] -= startPositon;\n                        });\n        \n                        CLOUD.Utils.applyMatrix4ToBuffer(nodeInfo.matrix, newPosition);\n        \n                        var lineMesh = {\n                            name: nodeInfo.userId,\n                            nodeId: nodeInfo.userId,\n                            index: {\n                                array: newIndex,\n                                itemSize: 1,\n                                count: newIndex.length,\n                                normalized: false\n                            },\n                            position: {\n                                array: newPosition,\n                                itemSize: 3,\n                                count: newPosition.length / 3,\n                                normalized: false\n                            }\n                        };\n        \n                        if (!userIdMap[nodeInfo.userId]) {\n                            userIdMap[nodeInfo.userId] = [];\n                        }\n        \n                        userIdMap[nodeInfo.userId].push(lineMesh);\n                    }\n                }\n        \n            }\n        \n            // 按 userId 顺序收集边框线\n            var lineSegments = [];\n            var userIds = Object.keys(userIdMap);\n        \n            for (j = 0, jLen = userIds.length; j < jLen; j++) {\n        \n                var wireFrames = userIdMap[userIds[j]];\n        \n                for (i = 0, iLen = wireFrames.length; i < iLen; i++) {\n                    lineSegments.push(wireFrames[i]);\n                }\n        \n            }\n        \n            // 合并边框线\n            if (lineSegments.length === 0) {\n                return {\n                    data:{\n                        success: false\n                    }                    \n                };\n            }\n        \n            var groupIndices = {};\n            var newBuffer = CLOUD.Utils.mergeBuffers(lineSegments, groupIndices);\n            var transferableObjects = [newBuffer.index.array.buffer, newBuffer.position.array.buffer];\n        \n            return {\n                data: {\n                    success: true,                   \n                    groupIndices: JSON.stringify(groupIndices),\n                    bufferData: newBuffer,\n                },                \n                transferableObjects: transferableObjects\n            };\n        }\n        \n        self.addEventListener('message', function (event) {\n        \n            var data = event.data;\n            var result = createBorderLines(data);\n        \n            if (result.data.success) {\n                self.postMessage(result.data, result.transferableObjects);\n            } else {\n                self.postMessage(result.data);\n            }\n        \n            self.close();\n        \n        }, false);\n    \n    "}(),function(){CLOUD.Workers.WorkerLib.getBorderLineCreateWorker=function(){var e=CLOUD.Workers.WorkerChunk.NamespaceChunk;e+=CLOUD.Workers.WorkerChunk.MathChunk,e+=CLOUD.Workers.WorkerChunk.UtilsChunk,e+=CLOUD.Workers.WorkerChunk.BorderLineCreateChunk;var e=window.URL.createObjectURL(new Blob([e]));return function(){return new Worker(e)}}(),CLOUD.Workers.WorkerLib.getMeshCreateWorker=function(){var e=CLOUD.Workers.WorkerChunk.NamespaceChunk;e+=CLOUD.Workers.WorkerChunk.MathChunk,e+=CLOUD.Workers.WorkerChunk.UtilsChunk,e+=CLOUD.Workers.WorkerChunk.GeomUtilChunk,e+=CLOUD.Workers.WorkerChunk.MeshCreateChunk;var t=window.URL.createObjectURL(new Blob([e]));return function(){return new Worker(t)}}(),CLOUD.Workers.WorkerLib.getSceneParseWorker=function(){var e=CLOUD.Workers.WorkerChunk.NamespaceChunk;e+=CLOUD.Workers.WorkerChunk.MathChunk,e+=CLOUD.Workers.WorkerChunk.UtilsChunk,e+=CLOUD.Workers.WorkerChunk.SceneReaderChunk,e+=CLOUD.Workers.WorkerChunk.SymbolReaderChunk,e+=CLOUD.Workers.WorkerChunk.SceneParseChunk;var t=window.URL.createObjectURL(new Blob([e]));return function(){return new Worker(t)}}()}(),function(){var e=function(e){function t(e,n,i,r,a,o){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n,i));return s.viewer=e,s.unitScale=1,s.pntLoader=new CLOUD.PntLoader(5,s.unitScale),s.index=r,s.parseCfgFinish=a,s.debut=o,s.url=i.serverUrl+""+i.databagId+"/tileset.json",s}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.pntLoader=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null}},{key:"load",value:function(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START}),this.pntLoader.loadPntTotalJson(this.url,function(e){var n=new THREE.Vector3(e[0],e[1],e[2]),i=new THREE.Vector3(e[3],e[4],e[5]),r=new THREE.Vector3(e[6],e[7],e[8]),a=new THREE.Vector3(e[9],e[10],e[11]),o=i.clone().add(r).add(a);t.getTransforms().boundingBox=new THREE.Box3(n.clone().sub(o),n.clone().add(o)),t.manager.updateScene()}).then(function(e){var n=t.viewer.getScene().getMatrixGlobal().clone(),i=new THREE.Matrix4;i=i.getInverse(n);var r=t.viewer.getScene(),a=(new THREE.Matrix4).makeScale(t.unitScale,t.unitScale,t.unitScale),o=!0,s=!1,l=void 0;try{for(var u,c=e[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var h=u.value;h.matrix.copy(n).multiply(a),h.matrixAutoUpdate=!1,h.updateMatrixWorld(!0),r.children[0].add(h)}}catch(e){s=!0,l=e}finally{try{!o&&c.return&&c.return()}finally{if(s)throw l}}t.viewer.addRenderCallback(function(){var e=t.viewer.domElement.offsetHeight;t.pntLoader.updatePreSse(t.viewer.camera,e),t.pntLoader.ProcessTileIndexs(t.viewer.camera,i)}),t.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE}),t.debut(t)})}}]),t}(CLOUD.BaseModel);CLOUD.PointCloudModel=e}(),function(){var e=function(e){function t(e,n,i,r,a,o){
_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n,i));return s.viewer=e,s.unitScale=1,s.tilesLoader=new CLOUD.$3dTileLoader(s.unitScale),s.index=r,s.parseCfgFinish=a,s.debut=o,s.url=i.serverUrl+""+i.databagId+"/tileset.json",s.renderFunction=null,s}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.tilesLoader.destroy(),this.tilesLoader=null,this.parseCfgFinish=null,this.debut=null,this.viewer.removeRenderCallback(this.renderFunction),this.renderFunction=null}},{key:"load",value:function(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START}),this.tilesLoader.loadRootTileSetJson(this.url,function(e){var n=(new THREE.Matrix4).makeScale(t.unitScale,t.unitScale,t.unitScale);t.getTransforms().boundingBox=e.sceneBox,t.getTransforms().boundingBox.applyMatrix4(n),t.manager.updateScene();var i=t.viewer.getScene().getMatrixGlobal().clone();t.viewer.getScene();t.tilesLoader.addBimTilesGroup(t.getModelManager().getScene().getOrCreateObjectGroup(CLOUD.GlobalData.TdTileGroupName,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0}),i,n),t.renderFunction=function(){var n=new THREE.Matrix4;n=n.getInverse(i);var r=t.viewer.domElement.offsetHeight;t.tilesLoader.tdTileReader.updateCameraPosition(t.viewer.camera,t.unitScale,n),t.tilesLoader.tdTileReader.updatePreSse(t.viewer.camera,r),t.tilesLoader.tdTileReader.updateFrameState(),t.tilesLoader.tdTileReader.parse3dTile(e.schema.rootNode,void 0,!0)},t.viewer.addRenderCallback(t.renderFunction),t.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE}),t.debut(t)})}},{key:"hasTransforms",value:function(){return!0}}]),t}(CLOUD.BaseModel);CLOUD.$3dTilesModel=e}(),CLOUD.Tile=CLOUD.Tile||{};var DemUrl=function(){function e(t){_classCallCheck(this,e),this.terrainPath=t}return _createClass(e,[{key:"terrainUrl",value:function(e,t,n){return this.terrainPath+e+"/"+t+"/"+n+"/"+CLOUD.GlobalData.TerrainResourceFileName}}]),e}();CLOUD.Tile.DemUrl=DemUrl,function(){var e=function(e){function t(e,n,i,r,a,o){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n,i));return s.viewer=e,s.parseCfgFinish=a,s.debut=o,s.dataUrl=new CLOUD.Loader.Url(i),s.tileManager=null,s.loadTileConfig=i.loadConfig,s}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.tileManager.destroy(),this.parseCfgFinish=null,this.debut=null,this.viewer=null}},{key:"load",value:function(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START});var n=new THREE.FileLoader;n.setResponseType("json"),n.load(this.dataUrl.projectUrl(),function(e){var n=e.metadata.longitude,i=e.metadata.latitude,r=e.metadata.zoom;CLOUD.GlobalData.ConstraintZoom=!0;t.viewer.cameraControl.setMaximalRangeofCamera(100),t.viewer.lockAxisZ("Z",[.1,Math.PI/2.01]),t.loadTile(t.viewer,t.loadTileConfig,n,i,r),t.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE}),t.debut(t)})}},{key:"loadTile",value:function(e,t,n,i,r){e.getScene().geometryGroup.boundingBox||(this.getTransforms().boundingBox=new THREE.Box3(new THREE.Vector3(-CLOUD.GlobalData.SceneSize,-CLOUD.GlobalData.SceneSize,-CLOUD.GlobalData.SceneSize),new THREE.Vector3(CLOUD.GlobalData.SceneSize,CLOUD.GlobalData.SceneSize,CLOUD.GlobalData.SceneSize)),this.manager.updateScene());var a=e.getScene().getMatrixGlobal().clone(),o=new THREE.Matrix4;o=o.getInverse(a);var s={};t&&t.modelAltitude?s.modelAltitude=t.modelAltitude:(console.log("modelAltitude not in loadConfig,default 0"),s.modelAltitude=0),t&&t.modelRotationZ?s.modelRotationZ=t.modelRotationZ:(console.log("modelRotationZ not in loadConfig, default 0"),s.modelRotationZ=0),t&&t.basePoint?s.basePoint=t.basePoint:(console.log("basePoint not in loadConfig, default (0,0)"),s.basePoint=new THREE.Vector3(0,0,0)),t&&t.modelPosition?s.modelPosition=t.modelPosition:(console.log("modelPosition not in loadConfig, use position in config.json default"),s.modelPosition=[(n[0]+n[1])/2,(i[0]+i[1])/2]),s.useTerrain=t&&t.useTerrain,s.terrainPath=t.terrainPath,s.opacity=t.opacity,s.useUnitMeter=t&&t.useUnitMeter,s.useUnitMeter&&(CLOUD.Tile.TileMath.unitScale=1),s.dataUrl=this.dataUrl;var l=14;r&&r[1]&&(l=r[1]),s.MaxZoomPrecision=l,this.tileManager=new CLOUD.Tile.TilePlaneManager(e,s),this.tileManager.addRenderCallback(),e.getScene().children[0].add(this.tileManager.tileGroup)}}]),t}(CLOUD.BaseModel);CLOUD.DemModel=e}();var TextureLayer=function(){function e(t,n,i){_classCallCheck(this,e),this._url=i,this._priority=0,this.layerName=void 0===n?CLOUD.ObjectGroupType.ROADNETWORK:n,this.tileGroup=t.getScene().getOrCreateObjectGroup(this.layerName,{pickableType:CLOUD.PICKABLETYPE.Map,globalSpace:!0}),this.materialMap={},this.meshNodeMap={},this.loadStateMap={},this._opacity=1}return _createClass(e,[{key:"destroy",value:function(){this.url=void 0,this.priority=void 0,this.opacity=void 0,this.disposeMaterial(),this.disposeMeshNode(),this.loadStateMap=null,this.tileGroup.clear(),this.tileGroup=null}},{key:"contentLoaded",value:function(e,t,n){return this.loadStateMap[e]&&this.loadStateMap[e][t]&&this.loadStateMap[e][t][n]===CLOUD.Tile.DemTilesUtil.LOAD_STATE.LOADED}},{key:"contentUnLoad",value:function(e,t,n){return void 0===this.loadStateMap[e]?(this.loadStateMap[e]={},this.loadStateMap[e][t]={},this.loadStateMap[e][t][n]=CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):void 0===this.loadStateMap[e][t]?(this.loadStateMap[e][t]={},this.loadStateMap[e][t][n]=CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):void 0===this.loadStateMap[e][t][n]?(this.loadStateMap[e][t][n]=CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):this.loadStateMap[e][t][n]===CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED}},{key:"contentUnLoading",value:function(e,t,n){return this.loadStateMap[e][t][n]===CLOUD.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING}},{key:"setContentUnLoad",value:function(e,t,n){this.loadStateMap[e][t][n]=CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED}},{key:"setContentLoaded",value:function(e,t,n){this.loadStateMap[e][t][n]=CLOUD.Tile.DemTilesUtil.LOAD_STATE.LOADED}},{key:"setContentLoading",value:function(e,t,n){this.loadStateMap[e][t][n]=CLOUD.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING}},{key:"disposeMeshNode",value:function(){for(var e in this.meshNodeMap)for(var t in this.meshNodeMap[e])for(var n in this.meshNodeMap[e][t])this.meshNodeMap[e][t][n]&&this.meshNodeMap[e][t][n].parent.remove(this.meshNodeMap[e][t][n]);this.materialMap=null}},{key:"disposeMaterial",value:function(){for(var e in this.materialMap)for(var t in this.materialMap[e])for(var n in this.materialMap[e][t])this.materialMap[e][t][n]&&this.materialMap[e][t][n].dispose();this.materialMap=null}},{key:"show",value:function(){this.tileGroup?this.tileGroup.visible=!0:console.warn("The tile doesn't exist.")}},{key:"hide",value:function(){this.tileGroup?this.tileGroup.visible=!1:console.warn("The tile doesn't exist.")}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity=e}},{key:"url",get:function(){return this._url},set:function(e){this._url=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),e}();CLOUD.Tile.TextureLayer=TextureLayer,function(){var e=function e(){_classCallCheck(this,e)};e.LOAD_STATE={UNLOADED:0,GEO_LOADING:1,GEO_LOADED:2,MAT_PARSING:3,LOADED:4,FAILED:5},CLOUD.Tile.DemTilesUtil=e,CLOUD.Tile.DemTilesUtil.TWO_ACCURACY=.01,CLOUD.Tile.DemTilesUtil.InvalidTerrainValue=-32768,e.getMapUrl=function(e,t,n,i){var r={"{x}":n.toString(),"{y}":i.toString(),"{z}":t.toString()},a=new RegExp(Object.keys(r).join("|"),"gi");return e=e.replace(a,function(e){return r[e]})}}();var DemTile=function(){function e(t,n,i){_classCallCheck(this,e),this.zoom=t,this.x=n,this.y=i,this.longLatBox=CLOUD.Tile.TileMath.tile2boundingBox(n,i,t),this.box=null,this.meshNode=null,this.meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,this.skirt=null,this.geometry=null,this.skirtGeometry=null,this.texture=null,this.material=null}return _createClass(e,[{key:"destroy",value:function(){this.zoom=null,this.x=null,this.y=null,this.longLatBox=null,this.box=null,this.geometryLoadState=null,this.skirt&&this.skirt.parent.remove(this.skirt),this.meshNode&&(this.meshNode.parent.remove(this.meshNode),this.material.dispose(),this.texture.dispose()),this.geometry&&this.geometry.dispose(),this.skirtGeometry&&this.skirtGeometry.dispose(),this.meshNode=null,this.skirt=null,this.geometry=null,this.skirtGeometry=null,this.texture=null,this.material=null}}]),e}();CLOUD.Tile.DemTile=DemTile,CLOUD.Tile=CLOUD.Tile||{};var TileMath=function e(){_classCallCheck(this,e)};TileMath.earthRadius=6371e3,TileMath.mercatorPerimeter=20037508.3427892,TileMath.unitScale=1e3,TileMath.earthHighestAltitude=8865.43*TileMath.unitScale*2,TileMath.isLongitude=function(e){return e>=-180&&e<=180},TileMath.isLatitude=function(e){return e>=-85.0511&&e<=85.0511},TileMath.long2tile=function(e,t){return Math.floor((e+180)/360*Math.pow(2,t))},TileMath.lat2tile=function(e,t){return Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))},TileMath.tile2long=function(e,t){return e/Math.pow(2,t)*360-180},TileMath.tile2lat=function(e,t){var n=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},TileMath.tile2boundingBox=function(e,t,n){return{north:this.tile2lat(t,n),south:this.tile2lat(t+1,n),west:this.tile2long(e,n),east:this.tile2long(e+1,n)}},TileMath.getMercatorPerimeterByLat=function(e){return TileMath.mercatorPerimeter*Math.cos(e*Math.PI/180)},TileMath.lonLat2Mercator=function(e,t,n){var i=new THREE.Vector2,r=e*n/180,a=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return a=a*n/180,i.x=r*TileMath.unitScale,i.y=a*TileMath.unitScale,i},TileMath.mercator2lonLat=function(e,t){var n=new THREE.Vector2,i=e.x/(TileMath.unitScale*t)*180,r=e.y/(TileMath.unitScale*t)*180;return r=180/Math.PI*(2*Math.atan(Math.exp(r*Math.PI/180))-Math.PI/2),n.x=i,n.y=r,n},TileMath.toRadians=function(e){return e*Math.PI/180},TileMath.fromDegrees=function(e,t,n){n=void 0==n?0:n,e=this.toRadians(e),t=this.toRadians(t);var i=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Vector3(TileMath.earthRadius*TileMath.earthRadius,TileMath.earthRadius*TileMath.earthRadius,TileMath.earthRadius*TileMath.earthRadius),o=Math.cos(t);i.x=o*Math.cos(e),i.y=o*Math.sin(e),i.z=Math.sin(t),i.normalize(),r.multiplyVectors(a,i);var s=Math.sqrt(i.dot(r));return r.divideScalar(s),i.multiplyScalar(n),r.add(i)},TileMath.createHeightArray=function(e,t){for(var n=new Array(t+1),i=0;i<n.length;i++)n[i]=new Array(t+1);for(var r=e.length,a=t/(r-1),i=0;i<r-1;++i)for(var o=0;o<r-1;++o)for(var s=[e[i][o],e[i][o+1],e[i+1][o],e[i+1][o+1]],l=this.sampleSquare(s,a),u=i*a;u<=(i+1)*a;++u)for(var c=o*a;c<=(o+1)*a;++c)n[u][c]=l[u-i*a][c-o*a];return n},TileMath.sampleSquare=function(e,t){for(var n=new Array(t+1),i=0;i<n.length;i++)n[i]=new Array(t+1);for(var i=0;i<=t;++i)n[0][i]=(t-i)/t*e[0]+(1-(t-i)/t)*e[1],n[t][i]=(t-i)/t*e[2]+(1-(t-i)/t)*e[3],n[i][0]=(t-i)/t*e[0]+(1-(t-i)/t)*e[2],n[i][t]=(t-i)/t*e[1]+(1-(t-i)/t)*e[3];for(var i=1;i<t;++i)for(var r=1;r<t;++r)n[i][r]=n[i][0]+(n[i][t]-n[i][0])/t*r;return n},TileMath.generateHeight=function(e,t){for(var n=e*t,i=new Uint8Array(n),r=this.improvedNoise(),a=1,o=100*Math.random(),s=0;s<4;s++){for(var l=0;l<n;l++){var u=l%e,c=~~(l/e);i[l]+=Math.abs(r.noise(u/a,c/a,o)*a*1.75)}a*=5}return i},TileMath.improvedNoise=function(){function e(e){return e*e*e*(e*(6*e-15)+10)}function t(e,t,n){return t+e*(n-t)}function n(e,t,n,i){var r=15&e,a=r<8?t:n,o=r<4?n:12==r||14==r?t:i;return(0==(1&r)?a:-a)+(0==(2&r)?o:-o)}for(var i=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],r=0;r<256;r++)i[256+r]=i[r];return{noise:function(r,a,o){var s=Math.floor(r),l=Math.floor(a),u=Math.floor(o),c=255&s,h=255&l,d=255&u;r-=s,a-=l,o-=u;var f=r-1,p=a-1,m=o-1,g=e(r),v=e(a),y=e(o),E=i[c]+h,b=i[E]+d,x=i[E+1]+d,M=i[c+1]+h,_=i[M]+d,C=i[M+1]+d;return t(y,t(v,t(g,n(i[b],r,a,o),n(i[_],f,a,o)),t(g,n(i[x],r,p,o),n(i[C],f,p,o))),t(v,t(g,n(i[b+1],r,a,m),n(i[_+1],f,a,o-1)),t(g,n(i[x+1],r,p,m),n(i[C+1],f,p,m))))}}},CLOUD.Tile.TileMath=TileMath;var TerrainScheduler=function(){function e(t,n){_classCallCheck(this,e),this.limit=t,this.bufferSize=n,this.store=[],this.active=0,this.taskInfo={},this.terrainLoader=new THREE.FileLoader,this.terrainLoader.setResponseType("arraybuffer"),this.terrainLoader.crossOrigin=!0}return _createClass(e,[{key:"destroy",value:function(){this.limit=null,this.store=null,this.active=null,this.taskInfo=null,this.bufferSize=null,this.terrainLoader=null}},{key:"clear",value:function(){this.taskInfo={}}},{key:"next",value:function(){if(this.store.length){var e=this.store.shift(),t=e[0],n=e[1],i=e[2];this.taskInfo[t].added?this.taskInfo[t].data?"failure"==scope.taskInfo[t].data?i():n(this.taskInfo[t].data):(this.taskInfo[t].successCallbackList.push(n),this.taskInfo[t].failureCallbackList.push(i)):this.runTask(t)}}},{key:"runTask",value:function(e){var t=this;t.active++,t.taskInfo[e].added=!0,t.terrainLoader.load(e,function(n){t.active--,t.taskInfo[e].data=n;for(var i=0,r=t.taskInfo[e].successCallbackList.length;i<r;++i)t.taskInfo[e].successCallbackList[i](n);t.next()},void 0,function(n){t.active--,t.taskInfo[e].data="failure";for(var i=0,r=t.taskInfo[e].failureCallbackList.length;i<r;++i)t.taskInfo[e].failureCallbackList[i]();t.next()})}},{key:"push",value:function(e,t,n){if(this.taskInfo[e])return void(this.taskInfo[e].data?t(this.taskInfo[e].data):(this.taskInfo[e].successCallbackList.push(t),this.taskInfo[e].failureCallbackList.push(n)));this.taskInfo[e]={},this.taskInfo[e].successCallbackList=[t],this.taskInfo[e].failureCallbackList=[n],this.active<this.limit?this.runTask(e):this.store.push([e,t,n])}}]),e}();CLOUD.Tile.TerrainScheduler=TerrainScheduler;var TileBuilder=function(){function e(){_classCallCheck(this,e),this.indexMap={},this.uvMap={}}return _createClass(e,[{key:"destroy",value:function(){this.indexMap=null,this.uvMap=null}},{key:"getIndexBySeg",value:function(e){if(this.indexMap[e])return this.indexMap[e];for(var t=[],n=[],i=0,r=0;r<=e;r++){for(var a=[],o=0;o<=e;o++)a.push(i),i++;n.push(a)}for(var r=0;r<e;r++)for(var o=0;o<e;o++){var s=n[r][o+1],l=n[r][o],u=n[r+1][o],c=n[r+1][o+1];this.bufferize(c,l,s,t),this.bufferize(c,u,l,t)}return this.indexMap[e]=t,t}},{key:"bufferize",value:function(e,t,n,i){i.push(e),i.push(t),i.push(n)}},{key:"computeBuffer",value:function(){}},{key:"createSkirt",value:function(e,t,n,i,r,a){e=e.concat(t.reverse());for(var o=[],s=(new THREE.Vector3).fromArray(r.position).distanceTo((new THREE.Vector3).fromArray(r.position,3)),l=0;l<e.length;l++){var u=e[l],c=3*n,h=3*u;r.position[c+0]=r.position[h+0]-r.normal[h+0]*s,r.position[c+1]=r.position[h+1]-r.normal[h+1]*s,r.position[c+2]=r.position[h+2]-r.normal[h+2]*s,r.normal[c+0]=r.normal[h+0],r.normal[c+1]=r.normal[h+1],r.normal[c+2]=r.normal[h+2],r.uvs[2*n+0]=r.uvs[2*u+0],r.uvs[2*n+1]=r.uvs[2*u+1];var d=(l+1)%e.length,f=u,p=n,m=0===d?i:n+1,g=e[d];this.bufferize(f,p,m,o),this.bufferize(f,m,g,o),n++}return a=a.concat(o)}},{key:"createSkirt2",value:function(e,t,n,i,r,a){e=e.concat(t.reverse());var o=[],s=(new THREE.Vector3).fromArray(r.position).distanceTo((new THREE.Vector3).fromArray(r.position,3)),l={index:null,position:null,normal:null,uvs:[],center:null},u=e.length/4,c=4*u*2;l.position=new Float32Array(3*c),l.normal=new Float32Array(3*c),l.uvs=new Float32Array(3*c);for(var h=0;h<e.length;h++){var d=e[h],f=6*h,p=4*h,m=3*d;l.position[f+0]=r.position[m+0],l.position[f+1]=r.position[m+1],l.position[f+2]=r.position[m+2],l.position[f+3]=r.position[m+0]-r.normal[m+0]*s,l.position[f+4]=r.position[m+1]-r.normal[m+1]*s,l.position[f+5]=r.position[m+2]-r.normal[m+2]*s,l.normal[f+0]=r.normal[m+0],l.normal[f+1]=r.normal[m+1],l.normal[f+2]=r.normal[m+2],l.normal[f+3]=r.normal[m+0],l.normal[f+4]=r.normal[m+1],l.normal[f+5]=r.normal[m+2],l.uvs[p+0]=r.uvs[2*d+0],l.uvs[p+1]=r.uvs[2*d+1],l.uvs[p+2]=r.uvs[2*d+0],l.uvs[p+3]=r.uvs[2*d+1];var g=(h+1)%e.length,v=2*h,y=2*h+1,E=0===g?1:2*h+3,b=0===g?0:2*h+2;this.bufferize(v,y,E,o),this.bufferize(v,E,b,o)}l.index=o;var x=new THREE.BufferGeometry;return x.setIndex(l.index),x.addAttribute("position",new THREE.BufferAttribute(l.position,3)),x.addAttribute("uv",new THREE.BufferAttribute(l.uvs,2)),x.addAttribute("normal",new THREE.Float32BufferAttribute(l.normal,3)),x.computeVertexNormals(),x}}]),e}();CLOUD.Tile.TileBuilder=TileBuilder;var PlaneTileBuilder=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){}},{key:"computePlaneGeometry",value:function(e,t,n,i,r){var a={index:null,position:null,normal:null,uvs:[],center:null};n=void 0==n?16:n;var o=(n+1)*(n+1);a.position=new Float32Array(3*o),a.normal=new Float32Array(3*o),a.uvs=new Float32Array(3*o);for(var s=[],l=[],u=0,c=e/2,h=t/2,d=e/n,f=t/n,p=0;p<=n;++p){for(var m=[],g=p*f-h,v=0;v<=n;++v){var y=v*d-c;a.position[3*u]=y,a.position[3*u+1]=g,a.position[3*u+2]=i[n-p][v]*CLOUD.Tile.TileMath.unitScale*CLOUD.GlobalData.TerrainScale,a.normal[3*u]=0,a.normal[3*u+1]=0,a.normal[3*u+2]=1,a.uvs[2*u]=v/n,a.uvs[2*u+1]=p/n,r||0!==p&&p!==n&&(v===n?s.push(u):0===v&&l.push(u)),m.push(u),u++}0===p?s=s.concat(m):p===n&&(s=s.concat(m.slice().reverse()))}var E=this.getIndexBySeg(n),b=u,x=null;r||(x=this.createSkirt2(s,l,u,b,a,E)),a.index=E;var M=new THREE.BufferGeometry;return M.setIndex(a.index),M.addAttribute("position",new THREE.BufferAttribute(a.position,3)),M.addAttribute("uv",new THREE.BufferAttribute(a.uvs,2)),M.addAttribute("normal",new THREE.Float32BufferAttribute(a.normal,3)),M.computeVertexNormals(),[M,x]}},{key:"computeSideNormal",value:function(e,t,n,i){for(var r=t.length,a=0;a<r;++a){var o=t[a],s=i[a],l=e.attributes.normal.array[3*o],u=n.attributes.normal.array[3*s],c=(l+u)/2;e.attributes.normal.array[3*o]=c,n.attributes.normal.array[3*s]=c;var h=e.attributes.normal.array[3*o+1],d=n.attributes.normal.array[3*s+1],f=(h+d)/2;e.attributes.normal.array[3*o+1]=f,n.attributes.normal.array[3*s+1]=f;var p=e.attributes.normal.array[3*o+2],m=n.attributes.normal.array[3*s+2],g=(p+m)/2;e.attributes.normal.array[3*o+2]=g,n.attributes.normal.array[3*s+2]=g}}},{key:"computeNearNormal",value:function(e,t,n,i){for(var r=0,a=1,o=new Array(n+1),s=0;s<=n;++s)o[s]=r+a*s;r=0,a=n+1;for(var l=new Array(n+1),s=0;s<=n;++s)l[s]=r+a*s;r=n,a=n+1;for(var u=new Array(n+1),s=0;s<=n;++s)u[s]=r+a*s;r=n*(n+1),a=1;for(var c=new Array(n+1),s=0;s<=n;++s)c[s]=r+a*s;"left"===i&&this.computeSideNormal(e,l,t,u),"right"===i&&this.computeSideNormal(e,u,t,l),"top"===i&&this.computeSideNormal(e,o,t,c),"bottom"===i&&this.computeSideNormal(e,c,t,o)}}]),t}(CLOUD.Tile.TileBuilder);CLOUD.Tile.PlaneTileBuilder=PlaneTileBuilder;var GlobeTileBuilder=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){}},{key:"computeBuffer",value:function(e,t,n,i,r){var a={index:null,position:null,normal:null,uvs:[],center:null};i=void 0==i?16:i;var o=CLOUD.Tile.TileMath.tile2boundingBox(e,t,n),s=(o.east+o.west)/2,l=(o.north+o.south)/2,u=CLOUD.Tile.TileMath.fromDegrees(s,l),c=(o.east-o.west)/i,h=(o.north-o.south)/i;a.center=u;var d=(i+1)*(i+1)+(r?0:4*i);a.position=new Float32Array(3*d),a.normal=new Float32Array(3*d),a.uvs=new Float32Array(3*d);for(var f,p,m,g=[],v=[],y=0,E=1/i,b=0;b<=i;++b){var x=[];p=o.south+h*b;for(var M=0;M<=i;++M){f=o.west+c*M,m=CLOUD.Tile.TileMath.fromDegrees(f,p),a.position[3*y]=(m.x-u.x)*CLOUD.Tile.TileMath.unitScale,a.position[3*y+1]=(m.y-u.y)*CLOUD.Tile.TileMath.unitScale,a.position[3*y+2]=(m.z-u.z)*CLOUD.Tile.TileMath.unitScale;var _=m.clone().normalize();a.normal[3*y]=_.x,a.normal[3*y+1]=_.y,a.normal[3*y+2]=_.z;var C=b*E,I=M*E;a.uvs[2*y]=I,a.uvs[2*y+1]=C,r||0!==b&&b!==i&&(M===i?g.push(y):0===M&&v.push(y)),x.push(y),y++}0===b?g=g.concat(x):b===i&&(g=g.concat(x.slice().reverse()))}var O=this.getIndexBySeg(i),T=y;return r||(O=this.createSkirt(g,v,y,T,a,O)),a.index=O,a}}]),t}(CLOUD.Tile.TileBuilder);CLOUD.Tile.GlobeTileBuilder=GlobeTileBuilder;var TileTextureManager=function(){function e(t,n){return _classCallCheck(this,e),this.viewer=t,!this.viewer||!this.viewer instanceof CLOUD.Viewer?void console.log("ERROR::viewer must not be empty or viewer2d."):!n.startPosition||n.startPosition<2?void console.log("ERROR::startPosition must not be empty or less than 2 in length."):!n.endPosition||n.endPosition<2?void console.log("ERROR::endPosition must not be empty or less than 2 in length."):CLOUD.Tile.TileMath.isLongitude(n.startPosition[0])&&CLOUD.Tile.TileMath.isLongitude(n.endPosition[0])&&CLOUD.Tile.TileMath.isLatitude(n.startPosition[1])&&CLOUD.Tile.TileMath.isLatitude(n.startPosition[1])?n.startPosition[0]>n.endPosition[0]||n.startPosition[1]>n.endPosition[1]?void console.log("ERROR::range definition error."):Math.abs(n.startPosition[0]-n.endPosition[0])>.2||Math.abs(n.startPosition[1]-n.endPosition[1])>.2?void console.log(" Longitude or latitude range is too big."):(CLOUD.GlobalData.EnableGisMap=!0,CLOUD.GlobalData.ConstraintZoom=!1,this.westEdge=n.startPosition[0],this.eastEdge=n.endPosition[0],this.northEdge=n.endPosition[1],this.southEdge=n.startPosition[1],this.mapCount=0,this.externalObjectId="tilePlane",this.geometry=null,this.tileMaterials=new Array,!n.modelPosition||n.modelPosition<2?void console.log("ERROR::model position must not be empty or less than 2 in length."):CLOUD.Tile.TileMath.isLongitude(n.modelPosition[0])&&CLOUD.Tile.TileMath.isLatitude(n.modelPosition[1])?(this.modelLongitude=n.modelPosition[0],this.modelLatitude=n.modelPosition[1],this.modelLongitude<this.westEdge||this.modelLongitude>this.eastEdge||this.modelLatitude<this.southEdge||this.modelLatitude>this.northEdge?void console.log("ERROR::the input position must in range"):(this.zoom=n.zoom,this.zoom<0||this.zoom>18?void console.log("ERROR::the input zoom is invalid"):(this.height=0,void(this.externalComponentManager=new CLOUD.ExternalComponentManager(t))))):void console.log("ERROR::number exceeds normal latitude and longitude range.")):void console.log("ERROR::number exceeds normal latitude and longitude range.")}return _createClass(e,[{key:"destroy",value:function(){this.viewer=null,this.westEdge=null,this.eastEdge=null,this.northEdge=null,this.southEdge=null,this.mapCount=null,this.externalObjectId=null,this.geometry=null,this.tileMaterials=null,this.modelLongitude=null,this.modelLatitude=null,this.zoom=null,this.height=null,this.externalComponentManager=null,this.tileLength=null,this.topTile=null,this.leftTile=null,this.bottomTile=null,this.rightTile=null,this.planeWidth=null,this.planeHeight=null,this.mapCount=null,this.geometry=null,this.tilesMesh=null,this.tileArray[xIndex]=null}},{key:"loadMapsByZoom",value:function(e,t){this.zoom=e,this.tileLength=CLOUD.Tile.TileMath.mercatorPerimeter/Math.pow(2,this.zoom)*CLOUD.Tile.TileMath.unitScale*2,this.tileArray=new Array,this.topTile=CLOUD.Tile.TileMath.lat2tile(this.northEdge,this.zoom),this.leftTile=CLOUD.Tile.TileMath.long2tile(this.westEdge,this.zoom),this.bottomTile=CLOUD.Tile.TileMath.lat2tile(this.southEdge,this.zoom),this.rightTile=CLOUD.Tile.TileMath.long2tile(this.eastEdge,this.zoom),this.planeWidth=this.rightTile-this.leftTile+1,this.planeHeight=this.bottomTile-this.topTile+1,this.mapCount=this.planeWidth*this.planeHeight,this.geometry=new THREE.PlaneGeometry(this.tileLength*this.planeWidth,this.tileLength*this.planeHeight,this.planeWidth,this.planeHeight),this.tilesMesh=null;for(var n=this,i=0,r=n.leftTile;r<=n.rightTile;++r){var a,o;!function(e){var r=e-n.leftTile;n.tileArray[r]=new Array;for(var s=n.topTile;s<=n.bottomTile;++s){(function(s){var l=s-n.topTile;if(n.tileArray[r][l]={},n.tileArray[r][l].x=r*n.tileLength,n.tileArray[r][l].y=-l*n.tileLength,n.tileArray[r][l].center=new THREE.Vector3((r+.5)*n.tileLength,-(l+.5)*n.tileLength,n.height),n.tileArray[r][l].bound=CLOUD.Tile.TileMath.tile2boundingBox(e,s,n.zoom),e>n.rightTile||s>n.bottomTile)return"continue";a="https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x="+e+"&y="+s+"&z="+n.zoom,o=new THREE.TextureLoader,o.crossOrigin=!0,o.load(a,function(e){var a=new THREE.MeshBasicMaterial({map:e,transparent:!0,side:THREE.DoubleSide}),o=r+l*(n.rightTile-n.leftTile+1);n.geometry.faces[2*o].materialIndex=o,n.geometry.faces[2*o+1].materialIndex=o,n.geometry.faceVertexUvs[0][2*o]=[new THREE.Vector2(0,1),new THREE.Vector2(0,0),new THREE.Vector2(1,1)],n.geometry.faceVertexUvs[0][2*o+1]=[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)],n.tileMaterials[o]=a,++i>=n.mapCount&&n.onTextureLoaded(t)})})(s)}}(r)}}},{key:"onTextureLoaded",value:function(e){this.tilesMesh=new THREE.Mesh(this.geometry,this.tileMaterials);var t=this.externalComponentManager.objectIds;null!=t&&-1!=t.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.tilesMesh),this.positionX=0,this.positionY=0;for(var n=0,i=this.tileArray.length;n<i;n++)for(var r=0,a=this.tileArray[n].length;r<a;r++)if(this.tileArray[n][r].bound.west<=this.modelLongitude&&this.modelLongitude<this.tileArray[n][r].bound.east&&this.tileArray[n][r].bound.south<=this.modelLatitude&&this.modelLatitude<this.tileArray[n][r].bound.north){var o=(this.modelLongitude-this.tileArray[n][r].bound.west)/(this.tileArray[n][r].bound.east-this.tileArray[n][r].bound.west),s=(this.modelLatitude-this.tileArray[n][r].bound.south)/(this.tileArray[n][r].bound.north-this.tileArray[n][r].bound.south);this.positionX=-(n+o)*this.tileLength+this.planeWidth/2*this.tileLength,this.positionY=-(a-r-1+s)*this.tileLength+this.planeHeight/2*this.tileLength;break}var l=new THREE.Quaternion,u=this.viewer.getScene().getBoundingBoxWorld(),c=u.getCenter();this.externalComponentManager.setTransform(this.externalObjectId,new THREE.Vector3(this.positionX+c.x,this.positionY+c.y,u.min.z),new THREE.Vector3(1,1,1),l),this.viewer.render(),e&&e()}}]),e}();CLOUD.Tile.TileTextureManager=TileTextureManager;var TileDemandManager=function(){function e(t,n){if(_classCallCheck(this,e),this.viewer=t,!this.viewer||!this.viewer instanceof CLOUD.Viewer)return void console.log("ERROR::viewer must not be empty or viewer2d.");if(!n.modelPosition||n.modelPosition<2)return void console.log("ERROR::model position must not be empty or less than 2 in length.");if(!CLOUD.Tile.TileMath.isLongitude(n.modelPosition[0])||!CLOUD.Tile.TileMath.isLatitude(n.modelPosition[1]))return void console.log("ERROR::number exceeds normal latitude and longitude range.");if(this.zoom=n.zoom?n.zoom:17,this.zoom<1||this.zoom>18)return void console.log("ERROR::the input zoom is invalid");this.zoom<11&&console.warn("Tile resolution may be too low"),CLOUD.GlobalData.EnableGisMap=!0,CLOUD.GlobalData.ConstraintZoom=!1,this.modelLongitude=n.modelPosition[0],this.modelLatitude=n.modelPosition[1],this.tileArray={},this.tileArray[this.zoom]={},this.externalObjectId="tileDemandPlane",this.tileLimit=n.tileLimit?n.tileLimit:40,this.modelOffset=n.modelOffset,this.allGroup=new THREE.Group,this.groupArray={},this.groupArray[this.zoom]=new THREE.Group,this.allGroup.add(this.groupArray[this.zoom]),this.externalComponentManager=new CLOUD.ExternalComponentManager(t);var i=this.externalComponentManager.objectIds;null!=i&&-1!=i.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.allGroup),this.globalMatrix=this.viewer.modelManager.getMatrixWorldGlobal(),this.globalMatrixInverse=(new THREE.Matrix4).getInverse(this.globalMatrix),this.loader=new THREE.TextureLoader,this.loader.crossOrigin=!0,this.modelBox=this.viewer.getScene().getBoundingBoxWorld();var r=this;this.loader.load("https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=0&y=0&z=0",function(e){r.groupArray[0]=new THREE.Group;var t=new THREE.SphereGeometry(CLOUD.Tile.TileMath.earthRadius,200,200);t.translate(5517447847.510659,3185499999.9999995,0);var n=new THREE.MeshLambertMaterial({map:e,overdraw:.5}),i=new THREE.Mesh(t,n);r.groupArray[0].add(i)});var r=this;this.viewer.registerEventListener(CLOUD.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,function(e){var t=r.viewer.rendererManager.renderer.domElement.height,n=r.viewer.camera.position.clone(),i=n.applyMatrix4(r.globalMatrixInverse),a=r.calculateZoom(i,t);if(a!=r.zoom){if(r.allGroup.remove(r.groupArray[r.zoom]),0==a)return r.allGroup.add(r.groupArray[0]),r.allGroup.updateMatrixWorld(!0),void(r.zoom=a);void 0==r.groupArray[a]&&(r.groupArray[a]=new THREE.Group),r.allGroup.add(r.groupArray[a])}0!=a&&(r.zoom=a,r.updateZoom(a))})}return _createClass(e,[{key:"destroy",value:function(){this.viewer=null,this.zoom=null,this.modelLongitude=null,this.modelLatitude=null,this.tileArray=null,this.externalObjectId=null,this.modelOffset=null,this.tileLimit=null,this.allGroup=null,this.groupArray=null,this.tileMaterials=null,this.globalMatrix=null,this.globalMatrixInverse=null,this.loader=null,this.modelBox=null,this.tileLength=null,this.modelTileX=null,this.modelTileY=null,this.offset=null,this.inGeometry=null,this.tileBox=null,this.externalComponentManager=null}},{key:"calculateZoom",value:function(e,t){return this.zoom}},{key:"updateZoom",value:function(e){void 0==this.tileArray[e]&&(this.tileArray[e]={}),this.tileLength=CLOUD.Tile.TileMath.mercatorPerimeter/Math.pow(2,e)*CLOUD.Tile.TileMath.unitScale*2,this.modelTileX=CLOUD.Tile.TileMath.long2tile(this.modelLongitude,e),this.modelTileY=CLOUD.Tile.TileMath.lat2tile(this.modelLatitude,e);var t=CLOUD.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,e),n=(this.modelLongitude-t.west)/(t.east-t.west),i=(this.modelLatitude-t.north)/(t.north-t.south),r=this.modelBox.getCenter(),a=-n*this.tileLength+.5*this.tileLength+r.x,o=-i*this.tileLength-.5*this.tileLength+r.y;this.offset=new THREE.Vector3(a,o,this.modelBox.min.z-this.modelOffset*CLOUD.Tile.TileMath.unitScale);var s=new THREE.Quaternion;this.externalComponentManager.setTransform(this.externalObjectId,this.offset,new THREE.Vector3(1,1,1),s),this.inGeometry=new THREE.PlaneBufferGeometry(this.tileLength,this.tileLength),this.inGeometry.computeBoundingBox(),this.tileBox=this.inGeometry.boundingBox,this.addTile(this.modelTileX,this.modelTileY,new THREE.Vector3(0),e),this.updateGroup(e)}},{key:"addTile",value:function(e,t,n,i,r){var a=this;return a.tileArray[i][e]&&a.tileArray[i][e][t]?(a.tileArray[i][e][t].visible=!0,void a.allGroup.updateMatrixWorld(!0)):new Promise(function(o,s){
var l="https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x="+e+"&y="+t+"&z="+i;a.loader.load(l,function(s){s.wrapS=THREE.ClampToEdgeWrapping,s.wrapT=THREE.ClampToEdgeWrapping;var l=new THREE.MeshBasicMaterial({map:s,transparent:!0,side:THREE.DoubleSide}),u=a.inGeometry.clone();u.translate(n.x,n.y,n.z);var c=new THREE.Mesh(u,l);void 0==a.tileArray[i][e]&&(a.tileArray[i][e]={}),a.tileArray[i][e][t]||(a.tileArray[i][e][t]=c,c.name=i+"-"+e+"-"+t,a.groupArray[i].add(c),a.allGroup.updateMatrixWorld(!0)),o(r)})})}},{key:"updateGroup",value:function(e){var t=this,n=t.viewer.camera;n.updateMatrix(),n.updateMatrixWorld(),this.frustum=new THREE.Frustum,this.frustum.setFromMatrix((new THREE.Matrix4).multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse));for(var i=t.modelTileX,r=t.modelTileY,a=2;a<t.tileLimit;){for(var o=1;o<a;o++)i+=1,t.addNode(i,r,e);for(var o=1;o<a;o++)r+=1,t.addNode(i,r,e);a++;for(var o=1;o<a;o++)i-=1,t.addNode(i,r,e);for(var o=1;o<a;o++)r-=1,t.addNode(i,r,e);a++}}},{key:"addNode",value:function(e,t,n){if(!(e>=Math.pow(2,n)||e<0||t>=Math.pow(2,n)||t<0)){var i=this,r=(e-i.modelTileX)*i.tileLength,a=-(t-i.modelTileY)*i.tileLength,o=new THREE.Vector3(r+i.offset.x,a+i.offset.y,i.offset.z);this.tileBox=this.inGeometry.boundingBox;var s=this.tileBox.clone();if(s.translate(o),s.applyMatrix4(i.globalMatrix),!i.frustum.intersectsBox(s))return void(void 0!=i.tileArray[n][e]&&void 0!=i.tileArray[n][e][t]&&(i.tileArray[n][e][t].visible=!1));var l=new THREE.Vector3(r,a,0);i.addTile(e,t,l,n,void 0)}}}]),e}();CLOUD.Tile.TileDemandManager=TileDemandManager;var TileManager=function(){function e(t,n){return _classCallCheck(this,e),this.viewer=t,!this.viewer||!this.viewer instanceof CLOUD.Viewer?void console.log("ERROR::viewer must not be empty or viewer2d."):!n.modelPosition||n.modelPosition<2?void console.log("ERROR::model position must not be empty or less than 2 in length."):CLOUD.Tile.TileMath.isLongitude(n.modelPosition[0])&&CLOUD.Tile.TileMath.isLatitude(n.modelPosition[1])?(CLOUD.GlobalData.EnableGisMap=!0,this.modelLongitude=n.modelPosition[0],this.modelLatitude=n.modelPosition[1],this.tileAroundNum=8,this.maxZoom=18,n.useUnitMeter&&this.maxZoom--,this.modelTileX=CLOUD.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=CLOUD.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.globalLayer={},this.tileGroup=t.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.TILEGROUP,{pickableType:CLOUD.PICKABLETYPE.Map,globalSpace:!0}),this.loader=new THREE.TextureLoader,this.loader.crossOrigin=!0,this.globalMatrix=this.viewer.modelManager.getMatrixWorldGlobal(),this.globalMatrixInverse=(new THREE.Matrix4).getInverse(this.globalMatrix),this.frustum=new THREE.Frustum,this.earthMatrix=this.tileGroup.matrixWorld,this.useTerrain=n.useTerrain,this.basePoint=n.basePoint,this.modelRotationZ=n.modelRotationZ,this.modelAltitude=n.modelAltitude,this.renderFunction=null,this.tileOpacity=n.opacity,this.materialMap={},this.disableSkirt=!1,this.mapUrl="https://mt3.google.cn/vt/lyrs=s&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}",void(this.layerList=[])):void console.log("ERROR::number exceeds normal latitude and longitude range.")}return _createClass(e,[{key:"destroy",value:function(){this.clearTiles(),this.modelLongitude=null,this.modelLatitude=null,this.tileAroundNum=null,this.maxZoom=null,this.modelTileX=null,this.modelTileY=null,this.globalLayer=null,this.tileGroup.clear(),this.tileGroup=null,this.loader=null,this.globalMatrix=null,this.globalMatrixInverse=null,this.frustum=null,this.earthMatrix=null,this.useTerrain=null,this.modelRotationZ=null,this.basePoint=null,this.modelAltitude=null;var e=this;e.viewer.removeRenderCallback(e.renderFunction),e.renderFunction=null,this.tileOpacity=null,this.materialMap=null,this.disableSkirt=null,this.mapUrl=null,this.layerList=null}},{key:"addExternalObject",value:function(){var e=this.externalComponentManager.objectIds;null!=e&&-1!=e.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.tileGroup)}},{key:"addRenderCallback",value:function(){var e=this;this.renderFunction=function(){e.updateEarth(),e.tileGroup.updateMatrixWorld(!0);for(var t=e.layerList.length,n=0;n<t;++n){e.layerList[n].tileGroup.updateMatrixWorld(!0)}},e.viewer.addRenderCallback(e.renderFunction),e.viewer.render()}},{key:"updateEarthMatrix",value:function(){}},{key:"show",value:function(){this.tileGroup?this.tileGroup.visible=!0:console.warn("The tile doesn't exist.")}},{key:"hide",value:function(){this.tileGroup?this.tileGroup.visible=!1:console.warn("The tile doesn't exist.")}},{key:"getModelRotationZ",value:function(){return this.modelRotationZ}},{key:"setModelRotationZ",value:function(e){this.modelRotationZ=e,this.updateEarthMatrix()}},{key:"getBasePoint",value:function(){return this.basePoint}},{key:"getModelPosition",value:function(){return[this.modelLongitude,this.modelLatitude]}},{key:"setModelPosition",value:function(e){this.clearTiles(),this.modelLongitude=e[0],this.modelLatitude=e[1],this.modelTileX=CLOUD.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=CLOUD.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateEarthMatrix()}},{key:"getModelAltitude",value:function(){return this.modelAltitude}},{key:"setModelAltitude",value:function(e){this.modelAltitude=e,this.updateEarthMatrix()}},{key:"setModelRotationZ",value:function(e){this.modelRotationZ=e,this.updateEarthMatrix()}},{key:"getOpacity",value:function(){return this.tileOpacity}},{key:"setOpacity",value:function(e){this.tileOpacity=e;for(var t in this.materialMap)this.materialMap[t].opacity=this.tileOpacity;1-this.tileOpacity>CLOUD.Tile.DemTilesUtil.TWO_ACCURACY?this.hideSkirt():this.showSkirt()}},{key:"clearTiles",value:function(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var n in this.globalLayer[e][t])this.globalLayer[e][t][n]&&this.globalLayer[e][t][n].destroy();this.globalLayer={},this.tileGroup.clear()}},{key:"hideSkirt",value:function(){this.disableSkirt=!0;for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var n in this.globalLayer[e][t])this.globalLayer[e][t][n]&&this.globalLayer[e][t][n].skirt&&(this.globalLayer[e][t][n].skirt.visible=!1)}},{key:"showSkirt",value:function(){this.disableSkirt=!1;for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var n in this.globalLayer[e][t])this.globalLayer[e][t][n]&&this.globalLayer[e][t][n].skirt&&(this.globalLayer[e][t][n].skirt.visible=!0)}},{key:"hideAllNodes",value:function(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var n in this.globalLayer[e][t])this.globalLayer[e][t][n]&&this.globalLayer[e][t][n].meshNode&&(this.globalLayer[e][t][n].meshNode.visible=!1)}},{key:"updateEarth",value:function(){var e=this.viewer.camera;e.updateMatrix(),e.updateMatrixWorld(),this.frustum.setFromMatrix((new THREE.Matrix4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.modelTileX=CLOUD.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=CLOUD.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom);for(var t=this.modelTileX-this.modelTileX%4,n=this.modelTileY-this.modelTileY%4,i=this.tileAroundNum,r=this.maxZoom,t=this.modelTileX-this.modelTileX%i,n=this.modelTileY-this.modelTileY%i,a=t;a<t+i;++a)for(var o=n;o<n+i;++o)this.addNode(a,o,r);this.updateTile(t,n,r,i)}},{key:"updateTile",value:function(e,t,n,i){var r=e/2,a=t/2,r=Math.floor(r-i/4),a=Math.floor(a-i/4);r%2==1&&r--,a%2==1&&a--;var n=n-1;if(!(n<0)){for(var o=r;o<r+i;++o)for(var s=a;s<a+i;++s)o>=e/2&&o<e/2+i/2&&s>=t/2&&s<t/2+i/2||o>=Math.pow(2,n)||o<0||s>=Math.pow(2,n)||s<0||this.addNode(o,s,n);this.updateTile(r,a,n,i)}}},{key:"addNode",value:function(e,t,n){if(!(e>=Math.pow(2,n)||e<0||t>=Math.pow(2,n)||t<0)){var i=this;if(void 0==i.globalLayer[n]&&(i.globalLayer[n]={}),void 0==i.globalLayer[n][e]&&(i.globalLayer[n][e]={}),void 0==i.globalLayer[n][e][t]&&(i.globalLayer[n][e][t]=new CLOUD.Tile.DemTile(n,e,t)),i.globalLayer[n][e][t].meshLoadState==CLOUD.Tile.DemTilesUtil.LOAD_STATE.UNLOADED)i.globalLayer[n][e][t].meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,i.createTileGeometry(e,t,n,!0,function(){i.createTileGeometryFinished(e,t,n)});else if(i.globalLayer[n][e][t].meshLoadState==CLOUD.Tile.DemTilesUtil.LOAD_STATE.LOADED||i.globalLayer[n][e][t].meshLoadState==CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED){i.globalLayer[n][e][t].geometry.computeBoundingBox();var r=i.globalLayer[n][e][t].geometry.boundingBox.clone();r.applyMatrix4(i.earthMatrix),i.globalLayer[n][e][t].box=r,i.createTileGeometryFinished(e,t,n)}}}},{key:"createTileGeometryFinished",value:function(e,t,n){if(this.frustum.intersectsBox(this.globalLayer[n][e][t].box)){this.globalLayer[n][e][t].meshLoadState===CLOUD.Tile.DemTilesUtil.LOAD_STATE.LOADED&&(this.globalLayer[n][e][t].meshNode.visible=!0),this.globalLayer[n][e][t].meshLoadState===CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,n);for(var i=this.layerList.length,r=0;r<i;++r){var a=this.layerList[r];a.contentUnLoad(n,e,t)&&this.globalLayer[n][e][t].meshLoadState>=CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(a,e,t,n),a.contentLoaded(n,e,t)&&(a.meshNodeMap[n][e][t].visible=!0)}}else{this.globalLayer[n][e][t].meshLoadState==CLOUD.Tile.DemTilesUtil.LOAD_STATE.LOADED&&(this.globalLayer[n][e][t].meshNode.visible=!1);for(var i=this.layerList.length,r=0;r<i;++r){var a=this.layerList[r];a.contentLoaded(n,e,t)&&(a.meshNodeMap[n][e][t].visible=!1)}}}},{key:"createTileGeometry",value:function(e,t,n){}},{key:"createLayerMaterial",value:function(e,t,n,i){var r=this;e.setContentLoading(i,t,n);var a=CLOUD.Tile.DemTilesUtil.getMapUrl(e.url,i,t,n);r.loader.load(a,function(a){var o=new THREE.MeshBasicMaterial({map:a,transparent:!0,side:THREE.FrontSide}),s=i+"-"+t+"-"+n;o.opacity=e.opacity,void 0==e.materialMap[i]&&(e.materialMap[i]={}),void 0==e.materialMap[i][t]&&(e.materialMap[i][t]={}),e.materialMap[i][t][n]=o;var l=new THREE.Mesh(r.globalLayer[i][t][n].geometry,o);void 0==e.meshNodeMap[i]&&(e.meshNodeMap[i]={}),void 0==e.meshNodeMap[i][t]&&(e.meshNodeMap[i][t]={}),e.meshNodeMap[i][t][n]=l,l.name=s,l.translateZ(e.priority),e.tileGroup.add(l),e.tileGroup.updateMatrixWorld(!0),e.setContentLoaded(i,t,n),r.viewer.render()})}},{key:"createMaterial",value:function(e,t,n){var i=this;return i.globalLayer[n][e][t].meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING,new Promise(function(r,a){var o=CLOUD.Tile.DemTilesUtil.getMapUrl(i.mapUrl,n,e,t);i.loader.load(o,function(a){var o=new THREE.MeshBasicMaterial({map:a,transparent:!0,side:THREE.FrontSide}),s=n+"-"+e+"-"+t;if(o.opacity=i.tileOpacity,i.materialMap[s]=o,i.globalLayer[n][e][t].texture=a,i.globalLayer[n][e][t].material=o,i.globalLayer[n][e][t].meshNode=new THREE.Mesh(i.globalLayer[n][e][t].geometry,i.materialMap[s]),i.globalLayer[n][e][t].meshNode.name=s,i.tileGroup.add(i.globalLayer[n][e][t].meshNode),i.globalLayer[n][e][t].skirtGeometry){var l="Skirt-"+n+"-"+e+"-"+t;i.globalLayer[n][e][t].skirt=new THREE.Mesh(i.globalLayer[n][e][t].skirtGeometry,i.materialMap[s]),i.globalLayer[n][e][t].skirt.name=l,i.tileGroup.add(i.globalLayer[n][e][t].skirt)}(i.tileOpacity<1||i.disableSkirt)&&i.globalLayer[n][e][t].skirt&&(i.globalLayer[n][e][t].skirt.visible=!1),i.globalLayer[n][e][t].meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.LOADED,i.viewer.render(),r(i.globalLayer[n][e][t])})})}}]),e}();CLOUD.Tile.TileManager=TileManager;var TilePlaneManager=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return i.mercatorPerimeter=CLOUD.Tile.TileMath.mercatorPerimeter,i.updateEarthMatrix(),i.tileGroup.name=CLOUD.GlobalData.TilePlaneGroupName,i.seg=16,i.terrainScheduler=new CLOUD.Tile.TerrainScheduler(6,(i.seg+1)*(i.seg+1)*2),i.EnviNum=4,i.modelTileAttitude=null,i.tileBuilder=new CLOUD.Tile.PlaneTileBuilder,n.MaxZoomPrecision&&(i.MaxZoomPrecision=n.MaxZoomPrecision,i.MaxZoomPrecision+4<18&&(i.maxZoom=i.MaxZoomPrecision+4)),n.terrainPath?i.dataUrl=new CLOUD.Tile.DemUrl(n.terrainPath):i.dataUrl=n.dataUrl,i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.terrainScheduler.destroy(),this.terrainScheduler=null,this.offset=null,this.mercatorPerimeter=null,this.terrainLoader=null,this.MaxZoomPrecision=null,this.tileBuilder=null,this.dataUrl=null,this.EnviNum=null,this.modelTileAttitude=null}},{key:"updateEarthMatrix",value:function(){this.mercatorPerimeter=CLOUD.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=CLOUD.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=CLOUD.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom);var e=CLOUD.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),n=(this.modelLatitude-e.north)/(e.north-e.south),i=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*CLOUD.Tile.TileMath.unitScale*2,r=-t*i+.5*i-.5*i,a=-n*i-.5*i+.5*i,o=(new THREE.Matrix4).makeTranslation(r+this.basePoint.x*CLOUD.Tile.TileMath.unitScale/1e3,a+this.basePoint.y*CLOUD.Tile.TileMath.unitScale/1e3,-this.modelAltitude*CLOUD.Tile.TileMath.unitScale),s=(new THREE.Matrix4).makeTranslation(r,a,0),l=(new THREE.Matrix4).makeRotationZ(-this.modelRotationZ),u=(new THREE.Matrix4).makeTranslation(-r,-a,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix(s),this.tileGroup.applyMatrix(l),this.tileGroup.applyMatrix(u),this.tileGroup.applyMatrix(o),this.tileGroup.applyMatrix(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var c=this.layerList.length,h=0;h<c;++h){var d=this.layerList[h];d.tileGroup.matrix.identity(),d.tileGroup.applyMatrix(s),d.tileGroup.applyMatrix(l),d.tileGroup.applyMatrix(u),d.tileGroup.applyMatrix(o),d.tileGroup.applyMatrix(this.globalMatrix),d.tileGroup.matrixAutoUpdate=!1,d.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}},{key:"createTerrainGeometry",value:function(e,t,n,i,r,a,o,s,l,u){var c=this,h=l;if(e>c.MaxZoomPrecision){for(var d=t*(r/i),f=n*(r/i),p=r/i,m=new Array(p+1),g=0;g<m.length;g++){m[g]=new Array(p+1);for(var v=0;v<=p;++v)m[g][v]=l[f+g][d+v]}h=CLOUD.Tile.TileMath.createHeightArray(m,r)}var y=c.tileBuilder.computePlaneGeometry(a,a,r,h,!1),E=y[0];return u&&(c.globalLayer[e][o-1]&&c.globalLayer[e][o-1][s]&&c.globalLayer[e][o-1][s].geometry&&c.tileBuilder.computeNearNormal(E,c.globalLayer[e][o-1][s].geometry,r,"left"),c.globalLayer[e][o+1]&&c.globalLayer[e][o+1][s]&&c.globalLayer[e][o+1][s].geometry&&c.tileBuilder.computeNearNormal(E,c.globalLayer[e][o+1][s].geometry,r,"right"),c.globalLayer[e][o]&&c.globalLayer[e][o][s-1]&&c.globalLayer[e][o][s-1].geometry&&c.tileBuilder.computeNearNormal(E,c.globalLayer[e][o][s-1].geometry,r,"bottom"),c.globalLayer[e][o]&&c.globalLayer[e][o][s+1]&&c.globalLayer[e][o][s+1].geometry&&c.tileBuilder.computeNearNormal(E,c.globalLayer[e][o][s+1].geometry,r,"top")),y}},{key:"translateGeometry",value:function(e,t,n,i,r,a){var o=this;null==r&&(r=0);var s=o.mercatorPerimeter/Math.pow(2,o.maxZoom)*CLOUD.Tile.TileMath.unitScale*2,l=(n*Math.pow(2,o.maxZoom-t)-o.modelTileX)*s+Math.pow(2,o.maxZoom-t)/2*s,u=-(i*Math.pow(2,o.maxZoom-t)-o.modelTileY)*s-Math.pow(2,o.maxZoom-t)/2*s;e.translate(l,u,r),o.globalLayer[t][n][i].geometry=e,e.computeBoundingBox();var c=e.boundingBox.clone();c.applyMatrix4(o.earthMatrix),o.globalLayer[t][n][i].box=c,o.globalLayer[t][n][i].meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,a&&a()}},{key:"translateGeometryWithSkirt",value:function(e,t,n,i,r,a){var o=e[0],s=e[1],l=this;null==r&&(r=0);var u=l.mercatorPerimeter/Math.pow(2,l.maxZoom)*CLOUD.Tile.TileMath.unitScale*2,c=(n*Math.pow(2,l.maxZoom-t)-l.modelTileX)*u+Math.pow(2,l.maxZoom-t)/2*u,h=-(i*Math.pow(2,l.maxZoom-t)-l.modelTileY)*u-Math.pow(2,l.maxZoom-t)/2*u;o.translate(c,h,r),s.translate(c,h,r),l.globalLayer[t][n][i].geometry=o,l.globalLayer[t][n][i].skirtGeometry=s,o.computeBoundingBox();var d=o.boundingBox.clone();d.applyMatrix4(l.earthMatrix),l.globalLayer[t][n][i].box=d,l.globalLayer[t][n][i].meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,a&&a()}},{key:"createTileGeometry",value:function(e,t,n,i,r){var a=this,o=a.mercatorPerimeter/Math.pow(2,n)*CLOUD.Tile.TileMath.unitScale*2,s=this.seg;if(a.useTerrain&&n>=a.MaxZoomPrecision-a.EnviNum){var l=Math.pow(2,n-a.MaxZoomPrecision),u=parseInt(e/l),c=parseInt(t/l),h=e%l,d=t%l,f=a.dataUrl.terrainUrl(n,e,t);return n>a.MaxZoomPrecision&&(f=a.dataUrl.terrainUrl(a.MaxZoomPrecision,u,c)),void a.terrainScheduler.push(f,function(u){for(var c=Array.prototype.slice.call(new Int16Array(u)),f=new Array(s+1),p=0;p<f.length;p++){f[p]=new Array(s+1);for(var m=0;m<s+1;m++)c[p*(s+1)+m]!==CLOUD.Tile.DemTilesUtil.InvalidTerrainValue?f[p][m]=c[p*(s+1)+m]:f[p][m]=0}if(a.modelTileX==e&&a.modelTileY==t){for(var g=c[0],v=c.length,p=0;p<v;p++)c[p]<g&&(g=c[p]);a.modelTileAttitude=g}var y=a.createTerrainGeometry(n,h,d,l,s,o,e,t,f,i);a.translateGeometryWithSkirt(y,n,e,t,null,r)},function(){var i=new THREE.PlaneBufferGeometry(o,o,s);a.translateGeometry(i,n,e,t,null,r)})}var p=new THREE.PlaneBufferGeometry(o,o,s);a.translateGeometry(p,n,e,t,null,r)}},{key:"worldPositionToLngLat",value:function(e){return this.mercator2lonLat(e)}},{key:"lngLatToWorldPosition",value:function(e,t){var n=this.lonLat2Mercator(e[0],e[1]);return this.useTerrain?this.getTileIntersectPoint(e,n,t):t&&t(n),n}},{key:"_lngLatToWorldPosition2",value:function(e){var t=this.lonLat2Mercator(e[0],e[1]);return this.useTerrain?this.getTerrainHeight(t):t}},{key:"getTerrainHeight",value:function(e){var t=e.applyMatrix4(this.globalMatrix),n=new CLOUD.Raycaster(new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(0,-1,0)),i=[];if(this.raycast(this.tileGroup,n,i),i.length>0){var r=i[0].point.clone();return r.applyMatrix4(this.globalMatrixInverse),r}if(n=new CLOUD.Raycaster(new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(0,1,0)),i=[],this.raycast(this.tileGroup,n,i),i.length>0){var r=i[0].point.clone();return r.applyMatrix4(this.globalMatrixInverse),r}}},{key:"raycast",value:function(e,t,n){for(var i=0,r=e.children.length;i<r;i++){var a=e.children[i];if(CLOUD.Utils.isGroupObject(a))this.raycast(a,t,n);else{if(-1!=a.name.indexOf("Skirt"))continue;a.raycast(t,n)}}}},{key:"lonLat2Mercator",value:function(e,t){var n=new THREE.Vector3,i=TileMath.lonLat2Mercator(e,t,this.mercatorPerimeter),r=TileMath.lonLat2Mercator(this.modelLongitude,this.modelLatitude,this.mercatorPerimeter),a=r.sub(new THREE.Vector2(this.basePoint.x,this.basePoint.y));return n.x=i.x-a.x,n.y=i.y-a.y,n.z=-this.modelAltitude*CLOUD.Tile.TileMath.unitScale,n}},{key:"mercator2lonLat",value:function(e){var t=TileMath.lonLat2Mercator(this.modelLongitude,this.modelLatitude,this.mercatorPerimeter),n=t.sub(new THREE.Vector2(this.basePoint.x,this.basePoint.y));return TileMath.mercator2lonLat(new THREE.Vector2(e.x+n.x,e.y+n.y),this.mercatorPerimeter)}},{key:"getTileIntersectPoint",value:function(e,t,n){for(var i=this,r=e[0],a=e[1],o=!1,s=this.maxZoom;s>=3;s--){var l,u;!function(e){l=i.globalLayer[e];for(var s in l)!function(s){for(var c in l[s]){if("break"===function(c){var h=l[s][c].longLatBox;if(u=i,r<=h.east&&r>=h.west&&a<=h.north&&a>=h.south&&(o=!0,u.globalLayer[e][s][c].meshLoadState=CLOUD.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,u.createTileGeometry(s,c,e,!0,function(){u.createMaterial(s,c,e).then(function(e){t.z=CLOUD.Tile.TileMath.earthHighestAltitude;var i=t.clone().applyMatrix4(u.globalMatrix),r=new CLOUD.Raycaster(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(0,-1,0)),a=[];e.meshNode.raycast(r,a);var o=void 0;a.length>0&&(o=a[0].point.clone(),o.applyMatrix4(u.globalMatrixInverse)),void 0==o&&(t.z=-u.modelAltitude*CLOUD.Tile.TileMath.unitScale,o=t),n&&n(o)})})),o)return"break"}(c))break}}(s)}(s)}0==o&&n&&n(t)}},{key:"_getOnlineTerrainHeight2",value:function(e,t){var n=CLOUD.Tile.TileMath.long2tile(e,this.maxZoom),i=CLOUD.Tile.TileMath.lat2tile(t,this.maxZoom),r=Math.pow(2,this.maxZoom-this.MaxZoomPrecision),a=parseInt(n/r),o=parseInt(i/r),s=n%r,l=i%r,u=new THREE.FileLoader;u.setResponseType("arraybuffer");var c=this.dataUrl.terrainUrl(this.MaxZoomPrecision,a,o),h=this;u.load(c,function(r){for(var a=Array.prototype.slice.call(new Uint16Array(r)),o=new Array(17),u=0;u<o.length;u++){o[u]=new Array(17);for(var c=0;c<17;c++)o[u][c]=a[17*u+c]}var d=o[l][s],f=o[l][s+1],p=o[l+1][s],m=o[l+1][s+1],g=CLOUD.Tile.TileMath.tile2boundingBox(n,i,h.maxZoom),v=d+(p-d)*(g.north-t)/(g.north-g.south),y=f+(m-f)*(g.north-t)/(g.north-g.south),E=v+(y-v)*(e-g.west)/(g.east-g.west);console.log(E)})}}]),t}(TileManager);CLOUD.Tile.TilePlaneManager=TilePlaneManager;var TileGlobalManager=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return i.tileGroup.name=CLOUD.GlobalData.TileGlobalGroupName,i.tileBuilder=new CLOUD.Tile.GlobeTileBuilder,i.updateEarthMatrix(),i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.offset=null,this.tileBuilder=null}},{key:"updateEarthMatrix",value:function(){this.earthPos=CLOUD.Tile.TileMath.fromDegrees(this.modelLongitude,this.modelLatitude),this.offset=new THREE.Vector3(this.basePoint.x,this.basePoint.y,-CLOUD.Tile.TileMath.earthRadius*CLOUD.Tile.TileMath.unitScale-this.modelAltitude*CLOUD.Tile.TileMath.unitScale);var e=this.earthPos.clone().normalize(),t=(new THREE.Quaternion).setFromUnitVectors(e,new THREE.Vector3(0,0,1)),n=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,0,1),THREE.Math.degToRad(270-this.modelLongitude)-this.modelRotationZ);t.premultiply(n);var i=(new THREE.Matrix4).makeRotationFromQuaternion(t),r=(new THREE.Matrix4).makeTranslation(this.offset.x,this.offset.y,this.offset.z);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix(i),this.tileGroup.applyMatrix(r),this.tileGroup.applyMatrix(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0),this.viewer.render()}},{key:"createTileGeometry",value:function(e,t,n){var i=this.tileBuilder.computeBuffer(e,t,n,void 0,!1),r=new THREE.BufferGeometry;r.setIndex(i.index),r.addAttribute("position",new THREE.BufferAttribute(i.position,3)),r.addAttribute("uv",new THREE.BufferAttribute(i.uvs,2)),r.translate(i.center.x*CLOUD.Tile.TileMath.unitScale,i.center.y*CLOUD.Tile.TileMath.unitScale,i.center.z*CLOUD.Tile.TileMath.unitScale),this.globalLayer[n][e][t].geometry=r,r.computeBoundingBox();var a=r.boundingBox;a.applyMatrix4(this.earthMatrix),this.globalLayer[n][e][t].box=a,this.createTileGeometryFinished(e,t,n)}}]),t}(CLOUD.Tile.TileManager);CLOUD.Tile.TileGlobalManager=TileGlobalManager,function(){var e=function(e){function t(e,n,i,r,a,o){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n,i));return s.viewer=e,s.parseCfgFinish=a,s.debut=o,s.dataUrl=new CLOUD.Loader.Url(i),s.loadTileConfig=i.loadConfig,s.url=i.serverUrl+""+i.databagId,i.rootPath?s.url+="/"+i.rootPath:s.url+="/bimtiles.json",s.bimTilesLoader=null,s.unitScale=1,s.renderFunction=null,s._tileset=new CLOUD.Tileset({maximumMemoryUsage:i.maximumMemoryUsage}),s}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.bimTilesLoader.destroy(),this.parseCfgFinish=null,this.debut=null,this.dataUrl=null,this.loadTileConfig=null,this.url=null,this.unitScale=null,this.viewer.removeRenderCallback(this.renderFunction),this.renderFunction=null,this._tileset=this._tileset&&this._tileset.destroy()}},{key:"load",value:function(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START}),this.bimTilesLoader=new CLOUD.BimTilesLoader(this.unitScale);var t=this;this.bimTilesLoader.loadBimTilesJson(this.url,function(e){var n=(new THREE.Matrix4).makeScale(t.unitScale,t.unitScale,t.unitScale);t.getTransforms().boundingBox=e.sceneBox.clone(),t.getTransforms().boundingBox.applyMatrix4(n),t.manager.updateScene();var i=t.viewer.getScene().getMatrixGlobal().clone();t.bimTilesLoader.addBimTilesGroup(t.getModelManager().getScene().getOrCreateObjectGroup(CLOUD.GlobalData.BimTilesGroupName,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0}),i,n),t.rootNode=e.schema.rootNode;var r=new THREE.Matrix4,a=t.viewer.domElement.offsetHeight;r=r.getInverse(i),t.viewer.setStandardView(CLOUD.EnumStandardView.ISO),t.bimTilesLoader.bimTileReader.updateCameraPosition(t.viewer.camera,t.unitScale,r),t.bimTilesLoader.bimTileReader.updatePreSse(t.viewer.camera,a);var o={};t.bimTilesLoader.bimTileReader.updateFrameState(o);var s=e.firstMeshNode.computeNodeSSE(o);t.bimTilesLoader.updateSseThreshold(s*CLOUD.BimTilesUtil.GEOMETRIC_ERROR_COEFFICIENT),t.renderFunction=function(n){var r=new THREE.Matrix4;r=r.getInverse(i);var a=t.viewer.domElement.offsetHeight;t.bimTilesLoader.bimTileReader.updateCameraPosition(t.viewer.camera,t.unitScale,r),t.bimTilesLoader.bimTileReader.updatePreSse(t.viewer.camera,a),t.bimTilesLoader.bimTileReader.updateFrameState(n),t.bimTilesLoader.bimTileReader.parseBimTile(e.schema.rootNode,void 0,n,function(e){t._tileset.selectTile(e,n),t._tileset.requestTile(e,n),t._tileset.touchTile(e,n)}),t.bimTilesLoader.loadModel(function(e,n){t._tileset.onTileContentRequest(e,n)},function(e){t._tileset.onTileContentReady(e,n)}),t.bimTilesLoader.bimTilesGroup.updateMatrixWorld(!0)},t.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE}),t.debut(t)})}},{key:"hasTransforms",value:function(){return!0}},{key:"preUpdate",value:function(e){this._tileset.preUpdate(e)}},{key:"update",value:function(e){var t=this;this._tileset.update(e,function(){t.renderFunction&&t.renderFunction(e)})}},{key:"postUpdate",value:function(e){this._tileset.postUpdate(e)}},{key:"rootNode",set:function(e){this._tileset.root=e},get:function(){return this._tileset.root}}]),t}(CLOUD.BaseModel);CLOUD.BimTilesModel=e}(),function(){var e=function e(){_classCallCheck(this,e)};e.getBox=function(e){var t=new THREE.Box3;return 6===e.length&&t.setFromArray(e),t},e.getDracoLibUrl=function(){return CLOUD.GlobalData.DracoLibUrl?CLOUD.GlobalData.DracoLibUrl:"undefined"==typeof bimfaceStaticHost?(CLOUD.GlobalData.DracoLibUrl="../../lib/draco/",CLOUD.GlobalData.DracoLibUrl):(CLOUD.GlobalData.DracoLibUrl=bimfaceStaticHost+"/draco/",CLOUD.GlobalData.DracoLibUrl)},e.max_uncompressed_blob_size=8388608,e.BIMTILE_DATA_NULL="NULL",e.BIMTILE_DATA_TILE="BIMTILE",e.BIMTILE_DATA_MESH="MESH",e.BIMTILE_DATA_POINT="POINT",e.BIMTILE_DATA_LINE="LINE",e.BIMTILE_DATA_DEM="DEM",e.BIMTILE_DATA_INDEX="INDEX",e.BIMTILE_DATA_USERDATA="USERDATA",e.BIMTILE_DATA_MATERIAL="MATERIAL",e.TWO_ACCURACY=.01,e.SIX_ACCURACY=1e-7,e.GEOMETRIC_ERROR_COEFFICIENT=.25,e.Minimum_Setting_SSEHold=.001,CLOUD.BimTilesUtil=e}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));i._tile=e,i._pointsLength=0,i._trianglesLength=0,i._geometryByteLength=n?n.length:0,i._texturesByteLength=0,i._meshes=new THREE.Group,i._meshes.name=i._tile.contentIndex,i._ready=!1;var r=i;return i._readyResolveFn=void 0,i._readyPromise=new Promise(function(e,t){r._readyResolveFn=function(t){e(t)}}),i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this._tile=null,this._readyResolveFn=null,this._readyPromise=null,this.disposeGeometry(this._meshes),this._meshes.children.length=0}},{key:"disposeGeometry",value:function(){for(var e=this._meshes.children,t=e.length,n=0;n<t;++n)e[n].geometry.dispose()}},{key:"update",value:function(e){var t=this;e.afterRender.push(function(){t._ready=!0,t._readyResolveFn(t)})}},{key:"isDestroyed",value:function(){return!1}},{key:"meshes",get:function(){return this._meshes}},{key:"meshesVisible",get:function(){return this._meshes.visible},set:function(e){this._meshes.visible=e}},{key:"tile",get:function(){return this._tile}},{key:"pointsLength",get:function(){return this._pointsLength}},{key:"trianglesLength",get:function(){return this._trianglesLength}},{key:"readyPromise",get:function(){return this._readyPromise}}]),t}(CLOUD.AbstractTileContent);CLOUD.BimTileContent=e}(),function(){CLOUD.ParseBimTileStrategies={BIMTILE:function(e,t,n,i,r){t.contentUnloaded&&(t.contentState=CLOUD.TileContentState.LOADING,e.taskRunner.push(e.jsonLoader,n,t,function(a){e.loadSchema(n,a.context,t);var o=e.schemaMap[n];t.contentIndex=n,t.contentState=CLOUD.TileContentState.READY,e.parseBimTile(o.rootNode,t,i,r)}))},MESH:function(e,t,n,i,r){if(!0===e.isFirstMesh&&(e.isFirstMesh=!1),t.contentUnloaded){t.contentState=CLOUD.TileContentState.LOADING;var a={node:t,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH};e.taskRunner.push(e.arrayBufferLoader,n,a,function(i){e.praseBlock(i.context,i.paras.node,i.paras.type,function(){t.contentIndex=n,t.contentState=CLOUD.TileContentState.PROCESSING})})}},POINT:function(e,t,n,i,r){if(t.contentUnloaded){t.contentState=CLOUD.TileContentState.LOADING;var a={node:t,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_POINT};e.taskRunner.push(e.arrayBufferLoader,n,a,function(i){e.praseBlock(i.context,i.paras.node,i.paras.type,function(){t.contentIndex=n,t.contentState=CLOUD.TileContentState.PROCESSING})})}},NULL:function(e,t,n,i,r){}}}(),function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return i.currentFolder=e,i.refineReplace=void 0,i.geometricError=0,i.contentIndex=-1,i.buffer=null,i.bufferType=null,n?(n.childrenTree.push(i),i.depth=n.depth+1):i.depth=0,i.replaceVisible=!1,i.sse=0,i.loadedCount=0,i._contentProcessPromise=void 0,i._contentReadyPromise=void 0,i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.refineReplace=void 0,this.geometricError=void 0,this.contentIndex=void 0,this.currentFolder=void 0,this.buffer=null,this.bufferType=void 0,this.visible=void 0,this.depth=void 0,this.replaceVisible=void 0,this.sse=void 0,this.loadedCount=void 0,this._contentProcessPromise=void 0,this._contentReadyPromise=void 0}},{key:"computeMeshNodeCount",value:function(){this.loadedCount=0;for(var e in this.buffer){var t=this.getBuffer(e);if(t.type==proto.BlockHeader.BlockType.BT_MESH){var n=t.content;if(n){var i=n.getScenesList(),r=!0,a=!1,o=void 0;try{for(var s,l=i[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value,c=u.getNodesList(),h=n.getNodesList(),d=!0,f=!1,p=void 0;try{for(var m,g=c[Symbol.iterator]();!(d=(m=g.next()).done);d=!0){var v=m.value,y=h[v];this.loadedCount+=y.getPrimitivesList().length}}catch(e){f=!0,p=e}finally{try{!d&&g.return&&g.return()}finally{if(f)throw p}}}}catch(e){a=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(a)throw o}}}}}}},{key:"computePointNodeCount",value:function(){this.loadedCount=0;for(var e in this.buffer){var t=this.getBuffer(e);if(t.type==proto.BlockHeader.BlockType.BT_POINT){var n=t.content;if(n){var i=n.getPointsList();this.loadedCount=i.length}}}}},{key:"getFileName",value:function(){return this.currentFolder+this.contentUrl}},{key:"getBuffer",value:function(e){return this.buffer[e]}},{key:"bimTilesCulling",value:function(e){var t=this.box.clone(),n=(new THREE.Matrix4).makeScale(e.unitScale,e.unitScale,e.unitScale);return t.applyMatrix4(n),t.applyMatrix4(e.globalMatrix),!!e.frustum.intersectsBox(t)}},{key:"updateVisibility",value:function(e){return this.replaceVisible?(this.visible=!0,this.isContentMeshesReady()&&(this._content.meshesVisible=!0),
this.replaceVisible=!1,!0):this.bimTilesCulling(e)&&this.passGeometryError(e)?(this.visible=!0,this.isContentMeshesReady()&&(this._content.meshesVisible=!0),!0):(this.visible=!1,this.isContentMeshesReady()&&(this._content.meshesVisible=!1),this.disableChildNode(),!1)}},{key:"parseSubMeshNodeVisible",value:function(e){for(var t=this.childrenTree,n=t.length,i=0;i<n;++i){if(t[i].isContentMeshesReady()&&(t[i].content.meshesVisible=e),t[i].replaceVisible=e,t[i].contentTypeMesh||t[i].contentTypePoint)return;t[i].parseSubMeshNodeVisible(e)}}},{key:"praseMeshNode",value:function(e,t){for(var n=this.childrenTree,i=n.length,r=0;r<i;++r)this.computeNodeSSE(e),n[r].contentTypeMesh||n[r].contentTypePoint?t.push(n[r]):n[r].praseMeshNode(e,t)}},{key:"anyChildrenVisible",value:function(e){this.replaceVisible=!1;var t=!1,n=this.childrenTree.length,i=[];this.praseMeshNode(e,i);var r=i.length;if(0==r||n>r)return!1;for(var a=0;a<r;++a){var o=i[a];if(!o.contentReady)return!1;t=t||o.visible&&o.sse>e.sseThreshold}return t}},{key:"passGeometryError",value:function(e){return this.computeNodeSSE(e),this.sse>e.sseThreshold}},{key:"computeNodeSSE",value:function(e){var t=this.box.clone();return this.distance=t.distanceToPoint(e.cameraPositionWc),this.geometricError-0<CLOUD.BimTilesUtil.TWO_ACCURACY&&(this.geometricError=CLOUD.BimTilesUtil.TWO_ACCURACY),this.sse=e.cameraPreSSE*(this.geometricError/this.distance),this.sse}},{key:"disableChildNode",value:function(){this.visible=!1,this.isContentMeshesReady()&&(this._content.meshesVisible=!1);for(var e=this.childrenTree,t=0,n=e.length;t<n;++t)e[t].disableChildNode()}},{key:"isContentMeshesReady",value:function(){return this._content&&this._content.meshes}},{key:"requestContent",value:function(e){var t=this;this._content=new CLOUD.BimTileContent(this,e),this._contentProcessPromise=new Promise(function(e,n){e(t._content)}),this._contentReadyPromise=new Promise(function(e,n){t._contentReadyResolveFn=function(t){e(t)}}),this._content.readyPromise.then(function(e){t._contentReadyResolveFn(e)})}},{key:"update",value:function(e){this.contentReady&&this._content.update(e)}},{key:"updateContent",value:function(e){this._content.update(e)}},{key:"process",value:function(e){}},{key:"unloadContent",value:function(){this._content=this._content&&this._content.destroy(),this.contentState=CLOUD.TileContentState.UNLOADED}},{key:"isContentVisible",value:function(e){return this.contentReady&&this.visible&&this._content&&this._content.meshes&&this._content.meshesVisible}},{key:"contentProcessPromise",get:function(){if(this._contentProcessPromise)return this._contentProcessPromise}},{key:"contentReadyPromise",get:function(){if(this._contentReadyPromise)return this._contentReadyPromise}},{key:"contentTypeTile",get:function(){return this.contentType===CLOUD.BimTilesUtil.BIMTILE_DATA_TILE}},{key:"contentTypeMesh",get:function(){return this.contentType===CLOUD.BimTilesUtil.BIMTILE_DATA_MESH}},{key:"contentTypePoint",get:function(){return this.contentType===CLOUD.BimTilesUtil.BIMTILE_DATA_POINT}},{key:"contentTypeLine",get:function(){return this.contentType===CLOUD.BimTilesUtil.BIMTILE_DATA_LINE}}]),t}(CLOUD.AbstractTile);CLOUD.BimTileNode=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.loadMeshControl=new CLOUD.LoadMeshControl(5),this.textureLoader=new THREE.TextureLoader,this.textureLoader.crossOrigin=!0,this.dracoLoader=new THREE.DRACOLoader,this.dracoLoader.setDecoderPath(CLOUD.BimTilesUtil.getDracoLibUrl())}return _createClass(e,[{key:"destroy",value:function(){this.loadMeshControl=null,this.textureLoader=null,this.dracoLoader=null}},{key:"loadMeshBlob",value:function(e,t,n,i,r){if(t){var a={};a.meshBlob=t;var o=t.getScenesList();if(0!==o.length){var s=t.getBlobHeader(),l=s.getBufferBlockId(),u=e.bimTileReader.getBuffer(n,l,proto.BlockHeader.BlockType.BT_BUFFER);if(u){var c=u.getBuffer();i&&i(n,c),a.buffer=u,a.bufferData=c;var h=!0,d=!1,f=void 0;try{for(var p,m=o[Symbol.iterator]();!(h=(p=m.next()).done);h=!0){var g=p.value,v=g.getNodesList(),y=!0,E=!1,b=void 0;try{for(var x,M=v[Symbol.iterator]();!(y=(x=M.next()).done);y=!0){var _=x.value,C=t.getNodesList()[_];this.loadNode(e,a,C,n,void 0,i,r)}}catch(e){E=!0,b=e}finally{try{!y&&M.return&&M.return()}finally{if(E)throw b}}}}catch(e){d=!0,f=e}finally{try{!h&&m.return&&m.return()}finally{if(d)throw f}}}}}}},{key:"loadNode",value:function(e,t,n,i,r,a,o){var s=new THREE.Matrix4,l=t.meshBlob;16==n.getMatrixList().length&&s.fromArray(n.getMatrixList());var u=void 0;void 0==r?n.getChildrenList().length>0?(r=new THREE.Group,r.applyMatrix(s),i.content.meshes.add(r),u=r):u={needsMatrix:s}:(r.applyMatrix(s),u=r);for(var c=n.getPrimitivesList(),h=c.length,d=0;d<h;d++){var f=c[d],p=l.getPrimitivesList()[f];p.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES&&(p.getAccArchive()>=0?this.loadMeshControl.push(this.loadMeshNodeDraco,[this,e,t,p,i,u,a,o],function(){}):this.loadMeshControl.push(this.loadMeshNode,[this,e,t,p,i,u,a,o],function(){})),p.getMode(),proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES,p.getMode(),proto.bimtile_pbf.Primitive.PrimitiveMode.PM_POINTS}var m=n.getChildrenList();if(m.length>0){var g=new THREE.Group;r.add(g);var v=!0,y=!1,E=void 0;try{for(var b,x=m[Symbol.iterator]();!(v=(b=x.next()).done);v=!0){var M=b.value,_=l.getNodesList()[M];this.loadNode(e,t,_,i,g,a,o)}}catch(e){y=!0,E=e}finally{try{!v&&x.return&&x.return()}finally{if(y)throw E}}}return!0}},{key:"getMeshBuffer",value:function(e,t,n){var i=n.meshBlob,r=i.getBlobHeader(),a=r.getBufferBlockId(),o=r.getMaterialBlockId(),s=r.getUserdataBlockId(),l=e.bimTileReader.getBuffer(t,a,proto.BlockHeader.BlockType.BT_BUFFER),u=e.bimTileReader.getBuffer(t,o,proto.BlockHeader.BlockType.BT_MATERIAL),c=e.bimTileReader.getBuffer(t,s,proto.BlockHeader.BlockType.BT_USERDATA);n.buffer=l,n.material=u,n.userdata=c,l&&(n.bufferData=l.getBuffer())}},{key:"createMeshNode",value:function(e,t,n,i,r,a,o){var s=new THREE.Mesh(r,a);i.needsMatrix?(s.applyMatrix(i.needsMatrix),n.content.meshes.add(s)):i.add(s),e.renderableCount++,--n.loadedCount<=0&&(e.bimTilesGroup.add(n.content.meshes),o&&o(n),n.contentState=CLOUD.TileContentState.READY,this.deleteNodeBuffer(t,n))}},{key:"loadMeshNode",value:function(e,t,n,i,r,a,o,s,l){if(!((i.getAccVertices()<0||i.getAccIndices()<0)&&i.getAccArchive()<0)&&(e.getMeshBuffer(t,r,n),n.buffer)){var u=new THREE.BufferGeometry,c=n.meshBlob,h=n.bufferData;if(i.getAccNormals()>0){var d=c.getBufferaccsList()[i.getAccNormals()],f=d.getByteOffset(),p=d.getByteLength(),m=(d.getCount(),h.slice(f,f+p).buffer),g=new Float32Array(m);u.addAttribute("normal",new THREE.BufferAttribute(g,3))}var v=c.getBufferaccsList()[i.getAccVertices()],y=v.getByteOffset(),E=v.getByteLength(),b=(v.getCount(),h.slice(y,y+E).buffer),x=new Float32Array(b);u.addAttribute("position",new THREE.BufferAttribute(x,3));var M=c.getBufferaccsList()[i.getAccIndices()],_=M.getByteOffset(),C=M.getByteLength(),I=(M.getCount(),h.slice(_,_+C).buffer),O=new Uint32Array(I);u.setIndex(new THREE.BufferAttribute(O,1)),n.material&&i.getMaterialId()>=0&&e.getMaterial(e,t,n,i,u,function(i){e.createMeshNode(t,n,r,a,u,i,s),l&&l()})}}},{key:"loadMeshNodeDraco",value:function(e,t,n,i,r,a,o,s,l){if(!((i.getAccVertices()<0||i.getAccIndices()<0)&&i.getAccArchive()<0)&&(e.getMeshBuffer(t,r,n),n.buffer)){var u=n.meshBlob,c=n.bufferData,h=n.material,d=u.getBufferaccsList()[i.getAccArchive()],f=d.getByteOffset(),p=d.getByteLength(),m=(d.getCount(),c.slice(f,f+p).buffer);e.dracoLoader.decodeDracoFile(m,function(o){h&&i.getMaterialId()>=0&&e.getDracoMaterial(e,t,n,i,function(i){e.createMeshNode(t,n,r,a,o,i,s),l&&l()})})}}},{key:"deleteNodeBuffer",value:function(e,t){e.material=null,e.bufferData=null,e.userdata=null,e.buffer=null,e.meshBlob=null;var n=t.buffer;for(var i in n)n[i].content=null}},{key:"getMaterial",value:function(e,t,n,i,r,a){var o=n.material,s=o.getMaterialsList(),l=s[i.getMaterialId()],u=n.meshBlob,c=n.bufferData,h=l.getColor(),d=l.getOpacity(),f=l.getMetalness(),p=l.getRoughness();if(d<CLOUD.BimTilesUtil.SIX_ACCURACY&&(d=1),l.getTexturesList().length>0&&i.getAccTexcoords()>=0){var m=o.getTexturesList()[l.getTexturesList()[0]];if(m.getImage()>=0){var g=u.getBufferaccsList()[i.getAccTexcoords()],v=g.getByteOffset(),y=g.getByteLength(),E=(g.getCount(),c.slice(v,v+y).buffer);r.addAttribute("uv",new THREE.BufferAttribute(E,2));var b=o.getImagesList()[m.getImage()],x=t.rootUrl+b.getUrl();e.textureLoader.load(x,function(e){var t=m.getAngle();Math.abs(t)>CLOUD.BimTilesUtil.TWO_ACCURACY&&e.setRotateAngle(t),e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.image=CLOUD.MaterialUtil.ensurePowerOfTwo(e.image);var n=new CLOUD.CloudStandardMaterial({map:e,transparent:!(d>1-CLOUD.BimTilesUtil.TWO_ACCURACY),opacity:d,color:h,roughness:p,metalness:f});a&&a(n)})}}else{var M=new CLOUD.CloudStandardMaterial({color:h,transparent:!(d>1-CLOUD.BimTilesUtil.TWO_ACCURACY),opacity:d,roughness:p,metalness:f});M.name=i.getMaterialId(),a&&a(M)}}},{key:"creatTextureImage",value:function(e,t,n){var i=new Blob([e],{type:"image/jpeg"}),r=window.URL||window.webkitURL,a=r.createObjectURL(i);this.textureLoader.load(a,function(e){e.flipY=!1,e.format=THREE.RGBAFormat,e.type=THREE.UnsignedByteType,e.magFilter=THREE.LinearFilter,e.minFilter=THREE.NearestMipMapLinearFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,t&&t(e)})}},{key:"getDracoMaterial",value:function(e,t,n,i,r){var a=n.material,o=a.getMaterialsList(),s=o[i.getMaterialId()],l=n.bufferData,u=s.getColor(),c=s.getOpacity(),h=s.getMetalness(),d=s.getRoughness();if(c<CLOUD.BimTilesUtil.SIX_ACCURACY&&(c=1),s.getTexturesList().length>0){var f=a.getTexturesList()[s.getTexturesList()[0]];if(f.getImage()>=0){var p=a.getImagesList()[f.getImage()],m=t.rootUrl+p.getUrl();if(p.getUrl())e.textureLoader.load(m,function(e){var t=f.getAngle();Math.abs(t)>CLOUD.BimTilesUtil.TWO_ACCURACY&&e.setRotateAngle(t),e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.image=CLOUD.MaterialUtil.ensurePowerOfTwo(e.image);var n=new CLOUD.CloudStandardMaterial({map:e,transparent:!(c>1-CLOUD.BimTilesUtil.TWO_ACCURACY),opacity:c,color:u,roughness:d,metalness:h});r&&r(n)});else if(p.getBufferId()>=0){var g=p.getByteOffset(),v=p.getByteLength(),y=(p.getWidth(),p.getHeight(),p.getDimension(),l.slice(g,g+v).buffer);e.creatTextureImage(y,function(e){e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.image=CLOUD.MaterialUtil.ensurePowerOfTwo(e.image);var t=new CLOUD.CloudStandardMaterial({map:e,transparent:!(c>1-CLOUD.BimTilesUtil.TWO_ACCURACY),opacity:c,color:u,roughness:d,metalness:h});r&&r(t)})}}}else{var E=new CLOUD.CloudStandardMaterial({color:u,transparent:!(c>1-CLOUD.BimTilesUtil.TWO_ACCURACY),opacity:c,roughness:d,metalness:h});E.name=i.getMaterialId(),r&&r(E)}}}]),e}();CLOUD.BimTileMeshParser=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.loadMeshControl=new CLOUD.LoadMeshControl(5),this.dracoLoader=new THREE.DRACOLoader,this.dracoLoader.setDecoderPath(CLOUD.BimTilesUtil.getDracoLibUrl()),this.pointAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Uint8Array",uv:"Float32Array"},this.pointSize=.5}return _createClass(e,[{key:"destroy",value:function(){this.loadMeshControl=null,this.dracoLoader=null,this.pointAttributeTypes=null}},{key:"loadPointBlob",value:function(e,t,n,i,r){if(t){var a={};a.pointBlob=t;if(0!==t.getPointsList().length){var o=t.getBlobHeader();(o.getTranslationList().length>0||o.getMatrixList().length>0)&&console.log("Translation"),a.blobHeader=o;var s=o.getBufferBlockId(),l=e.bimTileReader.getBuffer(n,s,proto.BlockHeader.BlockType.BT_BUFFER);if(a.bufferBlob=l,l){var u=l.getBuffer();i&&i(n,u),a.bufferData=u;var c=l.getBlobHeader(),h=c.getBufferTypeList(),d=c.getBufferSizeList(),f=c.getBufferOffsetList(),p=f.length;n.loadedCount=p;for(var m=0;m<p;++m){var g=f[m],v=d[m],y=u.slice(g,g+v).buffer;h[m]===proto.BufferBlobHeader.BufferType.BT_UNKNOW&&this.loadMeshControl.push(this.loadDracoPoint,[this,e,a,y,n,r],function(){})}}}}}},{key:"loadDracoPoint",value:function(e,t,n,i,r,a,o){e.dracoLoader.decodeDracoFile(i,function(i){i.attributes.color.normalized=!0,e.createMeshNode(t,n,r,i,a),o&&o()},void 0,e.pointAttributeTypes)}},{key:"createMeshNode",value:function(e,t,n,i,r){var a=new THREE.PointsMaterial({size:this.pointSize,vertexColors:THREE.VertexColors}),o=new THREE.Points(i,a);o.name=n.getFileName(),n.content.meshes.add(o),--n.loadedCount<=0&&(e.bimTilesGroup.add(n.content.meshes),r&&r(n),n.contentState=CLOUD.TileContentState.READY,this.deleteNodeBuffer(t,n))}},{key:"deleteNodeBuffer",value:function(e,t){e.bufferData=null,e.bufferBlob=null,e.blobHeader=null,e.pointBlob=null;var n=t.buffer;for(var i in n)n[i].content=null}}]),e}();CLOUD.BimTilePointParser=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.rootNode=null,this.folderName=null,this.fileName=null,this.layerKey=null,this.layerValue=null,this.globalIndexUrl=null,this.globalMaterialUrl=null,this.globalUserDataUrl=null}return _createClass(e,[{key:"destroy",value:function(){this.rootNode=null,this.folderName=null,this.fileName=null,this.layerKey=null,this.layerValue=null,this.globalIndexUrl=null,this.globalMaterialUrl=null,this.globalUserDataUrl=null}},{key:"getFIleName",value:function(){return this.currentFolder+this.content_url}},{key:"load",value:function(e,t,n){this.folderName=e.slice(0,e.lastIndexOf("/")+1),this.fileName=e.slice(e.lastIndexOf("/")+1,e.length);var i=t.properties;if(i){this.layerKey=i.layerKey,this.layerValue=i.layerValue;var r=i.globalIndex,a=i.globalMaterial,o=i.globalUserdata;r&&(this.globalIndexUrl=this.folderName+r.content.url),a&&(this.globalMaterialUrl=this.folderName+a.content.url),o&&(this.globalUserDataUrl=this.folderName+o.content.url)}var s=t.root;s&&(this.rootNode=new CLOUD.BimTileNode(this.folderName,n),this.loadNode(s,this.rootNode))}},{key:"loadNode",value:function(e,t){e.boundingVolume&&(t.box=CLOUD.BimTilesUtil.getBox(e.boundingVolume)),e.refine?("replace"!==e.refine&&"add"!==e.refine||console.warn("lowercase-refine",'This tile uses a lowercase refine "'+e.refine+'". Instead use "'+e.refine.toUpperCase()+'".'),t.refineReplace="REPLACE"===e.refine.toUpperCase()):t.parent?t.refineReplace=t.parent.refineReplace:t.refineReplace=!0,t.geometricError=e.geometricError,t.contentIndex=null,t.contentType=CLOUD.BimTilesUtil.BIMTILE_DATA_NULL;var n=e.content;if(n&&(t.contentUrl=n.uri||n.url,t.contentType=n.type),e.children){var i=!0,r=!1,a=void 0;try{for(var o,s=e.children[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=new CLOUD.BimTileNode(this.folderName,t);this.loadNode(l,u)}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}}}}]),e}();CLOUD.BimTileSchema=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.bimTileRootUrl=-1,this.globalIndexId=-1,this.globalMaterialId=-1,this.globalUserdataId=-1,this.schemaMap={},this.globalIndexBuffer=void 0,this.globalMaterialBuffer=void 0,this.globalUserdataBuffer=void 0,this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json"),this.arrayBufferLoader=new THREE.FileLoader,this.arrayBufferLoader.setResponseType("arraybuffer"),this.taskRunner=new CLOUD.LoadTaskRunner(4),this.globalMatrix=null,this.globalInverseMatrix=null,this.frustum=new THREE.Frustum,this.unitScale=1,this.maxGeometryError=0,this.cameraPreSSE=0,this.isFirstMesh=!0}return _createClass(e,[{key:"destroy",value:function(){this.releaseAllData(),this.bimTileRootUrl=null,this.globalIndexId=null,this.globalMaterialId=null,this.globalUserdataId=null,this.arrayBufferLoader=null,this.globalMatrix=null,this.globalInverseMatrix=null,this.frustum=null,this.unitScale=null,this.maxGeometryError=null,this.cameraPreSSE=null}},{key:"releaseAllData",value:function(){this.bimTileRootUrl=void 0,this.globalIndexId=-1,this.globalMaterialId=-1,this.globalUserdataId=-1,this.schemaMap={},this.globalIndexBuffer=void 0,this.globalMaterialBuffer=void 0,this.globalUserdataBuffer=void 0,this.globalInverseMatrix=null}},{key:"getRootSchema",value:function(){return this.schemaMap[this.bimTileRootUrl]}},{key:"getSchema",value:function(e){return this.schemaMap[e]}},{key:"getBuffer",value:function(e,t,n){return-1===t&&n===proto.BlockHeader.BlockType.BT_INDEX?this.globalIndexBuffer:-1===t&&n===proto.BlockHeader.BlockType.BT_MATERIAL?this.globalMaterialBuffer:-1===t&&n===proto.BlockHeader.BlockType.BT_USERDATA?this.globalUserdataBuffer:e.getBuffer(t).content}},{key:"loadBimTile",value:function(e,t){var n=this;this.releaseAllData(),n.taskRunner.push(n.jsonLoader,e,void 0,function(i){n.loadSchema(e,i.context);var r=n.schemaMap[e],a={};a.schema=r,a.isFirst=!0,n.bimTileRootUrl=e;var o=r.rootNode,s=o.box;o.depth=0,a.sceneBox=s;var l=0;r.globalIndexUrl&&(l++,n.loadBlock(r.globalIndexUrl,r.rootNode,proto.bimtile_pbf.BlockHeader.BlockType.BT_INDEX,function(){--l<=0&&n.parseBimTileRootMesh(r.rootNode,void 0,a,t)})),r.globalMaterialUrl&&(l++,n.loadBlock(r.globalMaterialUrl,r.rootNode,proto.bimtile_pbf.BlockHeader.BlockType.BT_MATERIAL,function(){--l<=0&&n.parseBimTileRootMesh(r.rootNode,void 0,a,t)})),r.globalUserDataUrl&&(l++,n.loadBlock(r.globalUserDataUrl,r.rootNode,proto.bimtile_pbf.BlockHeader.BlockType.BT_USERDATA,function(){--l<=0&&n.parseBimTileRootMesh(r.rootNode,void 0,a,t)})),l<=0&&n.parseBimTileRootMesh(r.rootNode,void 0,a,t)})}},{key:"loadSchema",value:function(e,t,n){var i=this.schemaMap[e];i||(i=new CLOUD.BimTileSchema,i.load(e,t,n),this.schemaMap[e]=i)}},{key:"praseBlock",value:function(e,t,n,i){var r=this,a=!0,o=0,s=[];t.bufferType=n;var l=0,u=e.byteLength;for(t.buffer={};l<u;){var c=e.slice(l,l+4),h=new Uint32Array(c)[0];l+=4;var d=new Uint8Array(e,l,h);l+=h;var f=proto.bimtile_pbf.BlockHeader.deserializeBinary(d);if(a&&f.getDataType()!=n)return void console.log("check blob type failed");h=f.getDataSize(),h>CLOUD.BimTilesUtil.max_uncompressed_blob_size&&console.log("blob-size is bigger then allowed");var p=new Uint8Array(e,l,h);if(l+=h,f.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.log("uncompress data into buffer");var m=f.getDataType(),g={};switch(m){case proto.BlockHeader.BlockType.BT_INDEX:var v=proto.bimtile_pbf.IndexBlob.deserializeBinary(p);g.type=m,g.content=v,t.buffer[o]=g;break;case proto.BlockHeader.BlockType.BT_MATERIAL:var y=proto.bimtile_pbf.MaterialBlob.deserializeBinary(p);g.type=m,g.content=y,t.buffer[o]=g;break;case proto.BlockHeader.BlockType.BT_USERDATA:var E=proto.bimtile_pbf.UserdataBlob.deserializeBinary(p);g.type=m,g.content=E,t.buffer[o]=g;break;case proto.BlockHeader.BlockType.BT_BUFFER:var b=proto.bimtile_pbf.BufferBlob.deserializeBinary(p);g.type=m,g.content=b,t.buffer[o]=g;break;case proto.BlockHeader.BlockType.BT_MESH:var x=proto.bimtile_pbf.MeshBlob.deserializeBinary(p);g.type=m,g.content=x,t.buffer[o]=g;break;case proto.BlockHeader.BlockType.BT_POINT:var M=proto.bimtile_pbf.PointBlob.deserializeBinary(p);g.type=m,g.content=M,t.buffer[o]=g;break;default:return void console.log("Parse unknow block faild! ")}a&&(a=!1),s[o]=o,o++}n===proto.BlockHeader.BlockType.BT_INDEX&&(this.globalIndexBuffer=t.buffer[0].content),n===proto.BlockHeader.BlockType.BT_MATERIAL&&(this.globalMaterialBuffer=t.buffer[0].content),n===proto.BlockHeader.BlockType.BT_USERDATA&&(this.globalUserdataBuffer=t.buffer[0].content);for(var _=0;_<o;++_){var g=t.buffer[_];if(g.type==proto.BlockHeader.BlockType.BT_MESH){var C=g.content,I=C.getBlobHeader(),O=I.getBufferBlockId();void 0!=s[O]&&I.setBufferBlockId(s[O]);var T=I.getMaterialBlockId();I.setMaterialBlockId(r.globalMaterialId),void 0!=s[T]&&I.setMaterialBlockId(s[T]);var L=I.getUserdataBlockId();I.setUserdataBlockId(r.globalUserdataId),void 0!=s[L]&&I.setUserdataBlockId(s[L])}}i&&i()}},{key:"loadBlock",value:function(e,t,n,i){var r=this;r.arrayBufferLoader.load(e,function(e){r.praseBlock(e,t,n,i)})}},{key:"parseBimTileRootMesh",value:function(e,t,n,i){var r=this;if(e&&n.isFirst){var a=e.getFileName();if(e.contentTypeTile&&e.contentUnloaded){e.contentState=CLOUD.TileContentState.LOADING;var o={};r.taskRunner.push(r.jsonLoader,a,o,function(t){r.loadSchema(a,t.context,e);var o=r.schemaMap[a];e.contentState=CLOUD.TileContentState.READY,e.contentIndex=a,r.parseBimTileRootMesh(o.rootNode,e,n,i)})}if(e.contentTypeMesh||e.contentTypePoint)return n.firstMeshNode=e,n.isFirst&&i(n),void(n.isFirst=!1);var s=r.getMaxGeoErrNode(e.childrenTree);r.parseBimTileRootMesh(s,e,n,i)}}},{key:"getMaxGeoErrNode",value:function(e){var t=null,n=0,i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;l.geometricError>n&&(n=l.geometricError,t=l)}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}return t}},{key:"updateFrameState",value:function(e){e.unitScale=this.unitScale,e.sseThreshold=this.sseThreshold,e.frustum=this.frustum,e.cameraPositionWc=this.cameraPositionWc,e.cameraPreSSE=this.cameraPreSSE,e.globalMatrix=this.globalMatrix}},{key:"parseBimTile",value:function(e,t,n,i){var r=this;if(e&&e.updateVisibility(n)){e.isContentMeshesReady()&&e.refineReplace&&e.anyChildrenVisible(n)&&(e.parseSubMeshNodeVisible(!0),e.content.meshesVisible=!1),i&&i(e);var a=e.getFileName();CLOUD.ParseBimTileStrategies[e.contentType](r,e,a,n,i);for(var o=0,s=e.childrenTree.length;o<s;++o)r.parseBimTile(e.childrenTree[o],e,n,i)}}},{key:"updatePreSse",value:function(e,t){e.updateMatrix(),e.updateMatrixWorld(),this.frustum.setFromMatrix((new THREE.Matrix4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse));var n=e.fov,i=THREE.Math.degToRad(n),r=t/(2*Math.tan(.5*i));this.cameraPreSSE=r}},{key:"updateCameraPosition",value:function(e,t,n){this.cameraPositionWc=e.position.clone(),this.cameraPositionWc.multiplyScalar(1/t),this.cameraPositionWc.applyMatrix4(n)}}]),e}();CLOUD.BimTileReader=e}();var BimTilesLoader=function(){function e(t){_classCallCheck(this,e),this.rootUrl=void 0,this.tileSceneBox=null,this.bimTileSchema=null,this.bimTileReader=null,this.renderableCount=0,this.unitScale=t,this.globalMatrix=null,this.globalInverseMatrix=null,this.bimTileMeshParser=new CLOUD.BimTileMeshParser,this.bimTilePointParser=new CLOUD.BimTilePointParser}return _createClass(e,[{key:"destroy",value:function(){this.bimTileReader.destroy(),this.bimTileMeshParser.destroy(),this.bimTileMeshParser=null,this.bimTilePointParser.destroy(),this.bimTilePointParser=null,this.bimTilesGroup.clear(),this.rootUrl=null,this.tileSceneBox=null,this.bimTileSchema=null,this.renderableCount=null,this.unitScale=null,this.globalMatrix=null,this.globalInverseMatrix=null}},{key:"loadBimTilesJson",value:function(e,t){this.rootJson=e,this.rootUrl=e.slice(0,e.lastIndexOf("/")+1),this.bimTileReader=new CLOUD.BimTileReader,this.bimTileReader.loadBimTile(e,function(e){t(e)})}},{key:"addBimTilesGroup",value:function(e,t,n){this.bimTilesGroup=e,this.updateBimTilesGroupMatrix(t,n)}},{key:"updateBimTilesGroupMatrix",value:function(e,t){this.bimTilesGroup.matrix.copy(e).multiply(t),this.bimTilesGroup.matrixAutoUpdate=!1,this.bimTilesGroup.updateMatrixWorld(!0),this.updateGlobalMatrix(e)}},{key:"updateGlobalMatrix",value:function(e){this.globalMatrix=e,this.globalInverseMatrix=new THREE.Matrix4,this.globalInverseMatrix=this.globalInverseMatrix.getInverse(e),this.bimTileReader.globalMatrix=e,this.bimTileReader.globalInverseMatrix=this.globalInverseMatrix,this.bimTileReader.unitScale=this.unitScale}},{key:"updateSseThreshold",value:function(e){this.bimTileReader.sseThreshold=e}},{key:"loadModel",value:function(e,t){if(this.bimTileReader){var n=this.bimTileReader.getSchema(this.bimTileReader.bimTileRootUrl);void 0!=n&&this.loadBimTile(n.rootNode,0,e,t)}}},{key:"loadBimTile",value:function(e,t,n,i){if(e){if(t++,e.contentTypeMesh&&!0===e.visible&&e.contentProcessing){e.contentState=CLOUD.TileContentState.CONSTRUCTING,e.computeMeshNodeCount();for(var r in e.buffer){var a=e.getBuffer(r);if(a.type==proto.BlockHeader.BlockType.BT_MESH){var o=a.content;o&&this.bimTileMeshParser.loadMeshBlob(this,o,e,n,i)}}}if(e.contentTypePoint&&!0===e.visible&&e.contentProcessing){e.contentState=CLOUD.TileContentState.CONSTRUCTING,e.computePointNodeCount();for(var s in e.buffer){var a=e.getBuffer(s);if(a.type==proto.BlockHeader.BlockType.BT_POINT){var l=a.content;l&&this.bimTilePointParser.loadPointBlob(this,l,e,n,i)}}}for(var u=0,c=e.childrenTree.length;u<c;++u)this.loadBimTile(e.childrenTree[u],t,n,i)}}},{key:"statisticsMeshInformation",value:function(){var e={meshCount:0,visibleCount:0};e.visibleCount=0;var t=this.bimTilesGroup.children;e.meshCount=t.length;for(var n=0,i=t.length;n<i;n++){var r=t[n];CLOUD.Utils.isGroupObject(r)&&r.visible&&e.visibleCount++}return e}}]),e}();CLOUD.BimTilesLoader=BimTilesLoader;var LoadMeshControl=function(){function e(t){_classCallCheck(this,e),this.limit=t,this.store=[],this.active=0}return _createClass(e,[{key:"next",value:function(){this.store.length&&this.runTask.apply(this,_toConsumableArray(this.store.shift()))}},{key:"runTask",value:function(e,t,n){this.active++;var i=this;new Promise(function(r,a){e.apply(void 0,_toConsumableArray(t).concat([function(e){i.active--,n&&n(e),i.next()}]))})}},{key:"push",value:function(e,t,n){this.active<this.limit?this.runTask(e,t,n):this.store.push([e,t,n])}}]),e}();CLOUD.LoadMeshControl=LoadMeshControl;var AxisGridManager=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,CLOUD.ObjectGroupType.AXISGRIDMANAGER,{priority:20}));return e.globalSpace=!0,e.materialMap={},e.meshUuidMap={},e.floorHeightMap={},e.gridLineColor="#333333",e.gridBubbleColor="#333333",e.bEnableHover=!0,e.mapAxisTypes={GRIDLINE:1,GRIDBUBBLE:2},e.translateMatrix=new THREE.Matrix4,e.bHasTranslation=!1,e.mapTranslateDelta={},e.mapLinkFloorId={},e.mapFileIdGridjson={},e.mapIntersectAxisLines={},e}return _inherits(t,e),_createClass(t,[{key:"getAxisGridState",value:function(){var e={},t=this.meshUuidMap,n=[];for(var i in t)if(t.hasOwnProperty(i)){var r=[];for(var a in t[i])if(t[i].hasOwnProperty(a)&&0!==Object.keys(t[i][a]).length){var o={};o.id=a,o.height=this.floorHeightMap[i][a].height,r.push(o)}n.push({fileId:i,floorInfos:r})}var s={};return e.hasOwnProperty("default")?s.fileInfos={fileId:"",floorInfos:e.default}:s.fileInfos=n,s.gridLineColor=this.gridLineColor,s.gridBubbleColor=this.gridBubbleColor,s}},{key:"addMeshUuidInMap",value:function(e,t,n,i){var r=this.meshUuidMap;r.hasOwnProperty(e)||(r[e]={}),r[e].hasOwnProperty(t)||(r[e][t]={}),r[e][t].hasOwnProperty(n)||(r[e][t][n]={}),r[e][t][n][i]=!0}},{key:"addFloorHeightInMap",value:function(e,t,n){var i=this.floorHeightMap;i.hasOwnProperty(e)||(i[e]={}),i[e].hasOwnProperty(t)||(i[e][t]={});var r=e+"_"+t;i[e][t]={height:n,translation:this.mapTranslateDelta[r]}}},{key:"removeFloorHeightInMap",value:function(e,t){var n=this.floorHeightMap;n.hasOwnProperty(e)&&n[e].hasOwnProperty(t)&&delete n[e][t]}},{key:"addLinesNode",value:function(e,t,n,i,r,a){var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute(e,3));var s=new THREE.Line(o,t);s.renderOrder=100,s.name=a,this.add(s),this.addMeshUuidInMap(n,i,r,s.uuid),this.updateMatrixWorld(!0)}},{key:"addTrianglesNode",value:function(e,t,n,i,r,a){var o=new THREE.BufferGeometry;o.setIndex(e.indexArray),o.addAttribute("position",new THREE.Float32BufferAttribute(e.vertexArray,3)),o.addAttribute("normal",new THREE.Float32BufferAttribute(e.normalArray,3));var s=new THREE.Mesh(o,t);s.renderOrder=110,s.name=a,this.add(s),this.addMeshUuidInMap(n,i,r,s.uuid),this.updateMatrixWorld(!0)}},{key:"createMaterial",value:function(e,t){return this.materialMap.hasOwnProperty(e)||(this.materialMap[e]={}),this.materialMap[e][t.color]?this.materialMap[e][t.color]:("string"!=typeof t.color&&(t.color="#"+t.color.getHEX()),this.materialMap[e][t.color]=CLOUD.MaterialUtil.createStandardMaterial(t),this.materialMap[e][t.color])}},{key:"loadAxisGridsByHeight",value:function(e,t,n,i,r){var a=this,o=new THREE.FileLoader;this.axisGridHeight=n,void 0!=n&&this.addFloorHeightInMap(t,i,n),o.load(e,function(o){var s=JSON.parse(o);a.gridsJson=s;var l=s.grids.length,u=l;if(l&&l>0){var c=t+"_"+i;a.mapFileIdGridjson[t]=s;for(var h=0;h<l;h++){var d=a.mapLinkFloorId[c]||i;if(-1==d.toString().indexOf("_")){var f=s.grids[h].floors;if(void 0!=f&&-1==f.indexOf(d.toString())){a.floorHeightMap[t][i].hideAxisGridIndex||(a.floorHeightMap[t][i].hideAxisGridIndex=[]),a.floorHeightMap[t][i].hideAxisGridIndex.push(h),u--,0==u&&r&&r();continue}}a.loadAxisGrid(e,t,h,n,i,function(){0==--u&&r&&r()})}}})}},{key:"unloadAxisGridsByFloor",value:function(e,t){var n=this.children,i=this.meshUuidMap;if(i.hasOwnProperty(e)&&i[e].hasOwnProperty(t)){for(var r in i[e][t]){for(var a=i[e][t][r],o=0;o<n.length;){a[n[o].uuid]?n.splice(o,1):o++}delete i[e][t][r]}this.removeFloorHeightInMap(e,t)}}},{key:"loadAxisGrid",value:function(e,t,n,i,r,a){var o=this,s=e.split("/");void 0==i&&(r=s[s.length-1].split(".")[0]);var l=0,u=o.gridsJson;if(n&&n>=0){if(!(n<u.grids.length))return void console.log("Input grid index is invalid.");l=n}for(var c=u.grids[l].gridLines,h=0;h<c.length;++h){var d=c[h].type;if("Circle"==d){var f=u.radius,p=c[h].circleCenter,m=new THREE.CircleGeometry(f,180),g=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,opacity:.5}),v=new THREE.Mesh(m,g),y=o.translate(t,r,[p[0],p[1],i]);v.position.set(y.x,y.y,y.z-.5),v.renderOrder=90,o.addMeshUuidInMap(t,r,l,v.uuid),o.add(v)}var E=c[h].lines,b=c[h].color||o.gridLineColor,x=o.mapAxisTypes.GRIDLINE;"Circle"==d&&(b=o.gridBubbleColor,"string"!=typeof b&&(b="#"+b.getHEX()),x=o.mapAxisTypes.GRIDBUBBLE);var g=o.createMaterial(x,{color:b,side:THREE.DoubleSide}),M=o.prepareLinesBuffer(t,r,E,i);o.addLinesNode(M,g,t,r,l,x)}for(var _=u.grids[l].texts,C=0;C<_.length;++C){var I=_[C],O=I.color||o.gridBubbleColor;"string"!=typeof O&&(O="#"+O.getHEX());var x=o.mapAxisTypes.GRIDBUBBLE,g=o.createMaterial(x,{color:O,side:THREE.DoubleSide}),T=o.prepareTrianglesBuffer(t,r,I.indexs,I.vertexs,i);o.addTrianglesNode(T,g,t,r,l,x)}a&&a()}},{key:"prepareLinesBuffer",value:function(e,t,n,i){for(var r=[],a=0;a<n.length;++a){var o=n[a];i&&!isNaN(i)&&(o[2]=i,o[5]=i);var s=this.translate(e,t,[o[0],o[1],o[2]]);r.push(s.x,s.y,s.z),s=this.translate(e,t,[o[3],o[4],o[5]]),r.push(s.x,s.y,s.z)}return r}},{key:"prepareTrianglesBuffer",value:function(e,t,n,i,r){for(var a=[],o=[],s=0;s<i.length;++s){var l=i[s];if(void 0==l||void 0==l[0]||void 0==l[1]||void 0==l[2]){console.log("Contains invalid vertex.");break}r&&!isNaN(r)&&(l[2]=r);var u=this.translate(e,t,l);a.push(u.x,u.y,u.z),o.push(0,0,1,0,0,1,0,0,1)}return{indexArray:n,vertexArray:a,normalArray:o}}},{key:"unloadAxisGrid",value:function(e,t,n){var i=this.children,r=this.meshUuidMap;if(r.hasOwnProperty(e)&&r[e].hasOwnProperty(t)&&r[e][t].hasOwnProperty(n)){for(var a=r[e][t][n],o=0;o<i.length;){a[i[o].uuid]?i.splice(o,1):o++}delete r[e][t][n]}}},{key:"unloadAllAxisGrids",value:function(){var e=this.meshUuidMap;for(var t in e)if(e.hasOwnProperty(t))for(var n in e[t])if(e[t].hasOwnProperty(n)){for(var i in e[t][n])e[t][n].hasOwnProperty(i)&&this.unloadAxisGrid(t,n,i);this.removeFloorHeightInMap(t,n)}}},{key:"enableDepthTest",value:function(e){for(var t=this.children,n=0;n<t.length;n++)t[n].material.depthTest=e}},{key:"formatHidedAxisGridIndex",value:function(e,t,n){e||(e="default");var i=this.floorHeightMap[e]={},r=0,a=!0,o=!1,s=void 0;try{for(var l,u=t.grids[Symbol.iterator]();!(a=(l=u.next()).done);a=!0){var c=l.value,h=c.floors,d=!0,f=!1,p=void 0;try{for(var m,g=n[Symbol.iterator]();!(d=(m=g.next()).done);d=!0){var v=m.value;0==i.hasOwnProperty(v)&&(i[v]={});var y=i[v];-1==h.indexOf(v)&&(0==y.hasOwnProperty("hideAxisGridIndex")&&(y.hideAxisGridIndex=[]),y.hideAxisGridIndex.push(r))}}catch(e){f=!0,p=e}finally{try{!d&&g.return&&g.return()}finally{if(f)throw p}}r++}}catch(e){o=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{
if(o)throw s}}}},{key:"getHidedAxisGridIndex",value:function(e,t){e||(e="default");var n=this.floorHeightMap[e][t];return n.hasOwnProperty("hideAxisGridIndex")?n.hideAxisGridIndex:[]}},{key:"prepareGridLines",value:function(e,t,n){void 0==t&&(t=[0,0,0]),this.verticalLines=[],this.horizontalLines=[];for(var i=e.grids,r=0;r<i.length;r++)if(!(n&&n.indexOf(r)>=0)){var a=i[r].gridLines[0].lines[0],o=[0,0,0,0,0,0];o.name=i[r].name,o[0]=a[0]+t[0],o[1]=a[1]+t[1],o[3]=a[3]+t[0],o[4]=a[4]+t[1],a[0]==a[3]?this.horizontalLines.push(o):this.verticalLines.push(o)}}},{key:"getNearestIntersection",value:function(e,t){var n={dist:Number.MAX_SAFE_INTEGER,intersect:null};e=new THREE.Vector3(e.x,e.y,e.z);var i=!0,r=!1,a=void 0;try{for(var o,s=this.intersections[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=l.clone();u.z=t;var c=u.distanceTo(e);c<n.dist&&(n.dist=c,n.intersect=l)}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}return n}},{key:"getIntersectLines",value:function(e){return this.mapIntersectAxisLines[e]}},{key:"destroy",value:function(){this.mapIntersectAxisLines=null,this.horizontalLines=null,this.verticalLines=null,this.intersections=null,this.floorHeightMap=null,this.mapTranslateDelta=null,this.mapLinkFloorId=null,this.mapFileIdGridjson=null}},{key:"calculateIntersections",value:function(e){void 0==e&&(e=[0,0,0]),this.intersections=[];for(var t,n,i,r,a=this.horizontalLines.length,o=this.verticalLines.length,s=0;s<a;s++){var l=this.horizontalLines[s];t=new THREE.Vector2(l[0],l[1]),n=new THREE.Vector2(l[3],l[4]);for(var u=0;u<o;u++){var c=this.verticalLines[u];if(i=new THREE.Vector2(c[0],c[1]),r=new THREE.Vector2(c[3],c[4]),i.y<=Math.max(t.y,n.y)&&i.y>=Math.min(t.y,n.y)&&t.x<=Math.max(i.x,r.x)&&t.x>=Math.min(i.x,r.x)){var h=new THREE.Vector3(t.x+e[0],i.y+e[1],this.axisGridHeight);h.name=l.name+c.name,this.mapIntersectAxisLines.hasOwnProperty(h.name)||(this.mapIntersectAxisLines[h.name]=[]),l[0]+=e[0],l[1]+=e[1],l[3]+=e[0],l[4]+=e[1],this.mapIntersectAxisLines[h.name].push(l),c[0]+=e[0],c[1]+=e[1],c[3]+=e[0],c[4]+=e[1],this.mapIntersectAxisLines[h.name].push(c),this.intersections.push(h)}}}}},{key:"getAxisGridHeight",value:function(){return this.axisGridHeight}},{key:"getAxisGridPlane",value:function(e){var t=new THREE.Plane;return t.setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,e)),t}},{key:"getAxisGridPlanes",value:function(){var e=[],t=this.floorHeightMap;for(var n in t)if(t.hasOwnProperty(n))for(var i in t[n])if(t[n].hasOwnProperty(i)){var r=t[n][i].height,a=t[n][i].translation||[0,0,0];e.push(this.getAxisGridPlane(r+a[2]))}return e}},{key:"snapOnFloors",value:function(e){var t=this.floorHeightMap,n=this.mapFileIdGridjson;if(0==Object.keys(n).length)return[];var i=0,r=[];for(var a in t)if(t.hasOwnProperty(a))for(var o in t[a])if(t[a].hasOwnProperty(o))if(null!=e[i]){var s=t[a][o].height,l=t[a][o].translation||[0,0,0];this.axisGridHeight=s+l[2];var u=t[a][o].hasOwnProperty("hideAxisGridIndex")?t[a][o].hideAxisGridIndex:null;this.prepareGridLines(n[a],l,u),r.push(this.snaping(e[i++],l))}else i++;return r}},{key:"snaping",value:function(e,t){this.calculateIntersections(t);for(var n={toIntersection:1/0,toGridLine:1/0},i={toIntersection:new THREE.Vector3,toGridLine:new THREE.Vector3},r=0;r<this.intersections.length;r++){var a=this.intersections[r].clone();a.name=this.intersections[r].name;var o=a.distanceTo(e);o<n.toIntersection&&(n.toIntersection=o,i.toIntersection=a)}for(var s=null,l=0,u=0;u<this.horizontalLines.length;u++){var c=this.horizontalLines[u];e.y>Math.max(c[1],c[4])||e.y<Math.min(c[1],c[4])||(l=Math.abs(c[0]-e.x))<n.toGridLine&&(n.toGridLine=l,s=c,i.toGridLine=new THREE.Vector3(c[0],e.y,this.axisGridHeight))}for(var h=0;h<this.verticalLines.length;h++){var d=this.verticalLines[h];e.x>Math.max(d[0],d[3])||e.x<Math.min(d[0],d[3])||(l=Math.abs(d[1]-e.y))<n.toGridLine&&(n.toGridLine=l,s=d,i.toGridLine=new THREE.Vector3(e.x,d[1],this.axisGridHeight))}var f={};return f.intersectLines=this.mapIntersectAxisLines[i.toIntersection.name],f.gridLine=s,{point:e,height:this.axisGridHeight,snapLines:f,nearestPoint:i,minDistance:n}}},{key:"setGridBubblesColor",value:function(e){this.gridBubbleColor=e;for(var t=this.children,n=0;n<t.length;n++)t[n].name==this.mapAxisTypes.GRIDBUBBLE&&(t[n].material.color=new THREE.Color(e.red/255,e.green/255,e.blue/255),t[n].material.opacity=e.alpha)}},{key:"getGridBubblesColor",value:function(){return this.gridBubbleColor}},{key:"setGridLinesColor",value:function(e){this.gridLineColor=e;for(var t=this.children,n=0;n<t.length;n++)t[n].name==this.mapAxisTypes.GRIDLINE&&(t[n].material.color=new THREE.Color(e.red/255,e.green/255,e.blue/255),t[n].material.alpha=e.alpha)}},{key:"getGridLinesColor",value:function(){return this.gridLineColor}},{key:"getElements",value:function(){return this.children}},{key:"setIsEnableHover",value:function(e){this.bEnableHover=e}},{key:"getIsEnableHover",value:function(){return this.bEnableHover}},{key:"setTranslation",value:function(e,t,n,i,r){var a=e+"_"+t;this.mapTranslateDelta[a]=[n,i,r]}},{key:"translate",value:function(e,t,n){var i=e+"_"+t,r=this.mapTranslateDelta[i],a=new THREE.Vector3(n[0],n[1],n[2]);return r&&(this.translateMatrix.makeTranslation(r[0],r[1],r[2]),a.applyMatrix4(this.translateMatrix)),a}},{key:"setLinkFloorId",value:function(e,t,n){var i=e+"_"+t;this.mapLinkFloorId[i]=n}},{key:"getIntersectPoints",value:function(e,t){var n=[],i=new THREE.Matrix4;i.getInverse(t);var r=this.getAxisGridPlanes(),a=!0,o=!1,s=void 0;try{for(var l,u=r[Symbol.iterator]();!(a=(l=u.next()).done);a=!0){var c=l.value;c.applyMatrix4(t);var h=e.ray.intersectPlane(c);h&&h.applyMatrix4(i),n.push(h)}}catch(e){o=!0,s=e}finally{try{!a&&u.return&&u.return()}finally{if(o)throw s}}return n}},{key:"getAxisGridsIntersection",value:function(e,t,n){n||"[object Array]"!==Object.prototype.toString.call(t)||(n=t,t=e,e="default");var i=this.computeIntersection(e,n),r=this.floorHeightMap[e],a=r[t].height,o={};for(var s in i)for(var l=i[s],u=0;u<l.intersects.length;u++){var c=l.intersects[u];c.intersectPoint.z=a;var h={intersection:c.intersectPoint,axisGrids:c.axisGrids};o[c.name]=h}return Object.values(o)}},{key:"computeIntersection",value:function(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default"),t=t.map(function(e){return e.toString()});for(var n=this.mapFileIdGridjson[e].grids,i=n.filter(function(e){return t.indexOf(e.name)>=0}),r={},a=0;a<i.length-1;a++){var o,s=i[a];r[s.name]?o=r[s.name].lineSegments:(o=this.getGridLineSegments(s),r[s.name]={lineSegments:o,intersects:[]});for(var l=a+1;l<i.length;l++){var u,c=i[l];r[c.name]?u=r[c.name].lineSegments:(u=this.getGridLineSegments(c),r[c.name]={lineSegments:u,intersects:[]});for(var h=0,d=0;d<o.length;d++)for(var f=o[d],p=0;p<u.length;p++){var m=u[p],g=this.computeSegmentsIntersect(f[0],f[1],m[0],m[1]);g&&(r[s.name].intersects.push({name:s.name+"_"+c.name+"_"+h,axisGrids:[s.name,c.name],intersectPoint:g,segmentNum:d}),r[c.name].intersects.push({name:s.name+"_"+c.name+"_"+h,axisGrids:[s.name,c.name],intersectPoint:g,segmentNum:p}),h++)}}}return r}},{key:"getPartitionDataByAxisGrids",value:function(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default");var n=this.computeIntersection(e,t),i={},r=0;for(d in n){var a=n[d];a.intersects.sort(function(e,t){if(e.segmentNum!==t.segmentNum)return e.segmentNum-t.segmentNum;var n=a.lineSegments[e.segmentNum][0],i=e.intersectPoint,r=t.intersectPoint;return(i.x-n.x)*(i.x-n.x)+(i.y-n.y)*(i.y-n.y)-((r.x-n.x)*(r.x-n.x)+(r.y-n.y)*(r.y-n.y))});for(var o=1;o<a.intersects.length;o++){var s={origin:a.intersects[o].name,target:a.intersects[o-1].name,id:r++,linePoints:[a.intersects[o].intersectPoint]};if(s.axis=d,a.intersects[o].segmentNum>a.intersects[o-1].segmentNum)for(var l=a.intersects[o].segmentNum;l>a.intersects[o-1].segmentNum;l--)s.linePoints.push(a.lineSegments[l][0]);else if(a.intersects[o].segmentNum<a.intersects[o-1].segmentNum)for(var l=a.intersects[o].segmentNum;l<a.intersects[o-1].segmentNum;l++)s.linePoints.push(a.lineSegments[l][1]);s.linePoints.push(a.intersects[o-1].intersectPoint),i[a.intersects[o].name]||(i[a.intersects[o].name]={subLines:[],name:a.intersects[o].name}),i[a.intersects[o].name].subLines.push(s),i[a.intersects[o-1].name]||(i[a.intersects[o-1].name]={subLines:[],name:a.intersects[o-1].name});for(var u={origin:s.target,target:s.origin,id:s.id,axis:s.axis,linePoints:[]},c=s.linePoints.length-1;c>=0;c--)u.linePoints.push(s.linePoints[c]);i[a.intersects[o-1].name].subLines.push(u)}}var h=[];for(var d in i)for(var f=i[d],p=f.subLines,o=0;o<p.length;o++){var s=p[o],m=[{intersect:f,subLine:s}];!function e(t){var n=t[t.length-1].subLine;if(!n.used){for(var r,a=n.linePoints,o=a[a.length-1],s=a[a.length-2],l=new THREE.Vector2(s.x-o.x,s.y-o.y),u=i[n.target],c=2*Math.PI,d=0;d<u.subLines.length;d++){var f=u.subLines[d];if(f.id!==n.id){var p=f.linePoints,m=p[0],g=p[1],v=new THREE.Vector2(g.x-m.x,g.y-m.y),y=v.angle()-l.angle();y<0&&(y+=2*Math.PI),y>=0&&y<c&&(c=y,r=f)}}if(r)if(t.push({intersect:u,subLine:r,angle:c}),r.target===t[0].subLine.target){var E=0;t.forEach(function(e){e.subLine.used=!0,E+=e.angle||0}),E-(t.length-1)*Math.PI<.001&&h.push(t)}else e(t)}}(m)}return h}},{key:"getPartitionByAxisGrids",value:function(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default");var n,i=this.getPartitionDataByAxisGrids(e,t);if(1===i.length){var r=i[0].slice(1,i[0].length);n=[],n.push(r[0].subLine.linePoints[0]),r.forEach(function(e){var t=e.subLine.linePoints.slice(1,e.subLine.linePoints.length);n=n.concat(t)})}else if(i.length>1)for(var a=0;a<i.length;a++){var o=new Set,r=i[a].slice(1,i[a].length),s=[];if(s.push(r[0].subLine.linePoints[0]),r.forEach(function(e){o.add(e.subLine.axis);var t=e.subLine.linePoints.slice(1,e.subLine.linePoints.length);s=s.concat(t)}),o.size===t.length){n=s;break}}return n}},{key:"getGridLineSegments",value:function(e){var t=e.gridLines.filter(function(e){return"Line"===e.type||"Curved"===e.type}),n=_slicedToArray(t,1),i=n[0];i||(i=e.gridLines[0]);for(var r=i.lines,a=[],o=0;o<r.length;o++)for(var s=r[o],l=0;l<s.length-5;l+=3){var u=[],c={x:s[l],y:s[l+1]},h={x:s[l+3],y:s[l+4]};u.push(c),u.push(h),a.push(u)}return a}},{key:"computeSegmentsIntersect",value:function(e,t,n,i){var r=(e.x-n.x)*(t.y-n.y)-(e.y-n.y)*(t.x-n.x),a=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x);if(r*a>0)return!1;var o=(n.x-e.x)*(i.y-e.y)-(n.y-e.y)*(i.x-e.x);if(o*((n.x-t.x)*(i.y-t.y)-(n.y-t.y)*(i.x-t.x))>0)return!1;var s=o/(a-r),l=s*(t.x-e.x),u=s*(t.y-e.y);return{x:e.x+l,y:e.y+u}}}]),t}(CLOUD.ObjectGroup);AxisGridManager.getInstance=function(e){return null==e.axisGridManager&&(e.axisGridManager=new CLOUD.AxisGridManager,e.objectGroups.add(e.axisGridManager),e.axisGridManager.matrix.copy(e.geometryGroup.matrix),e.axisGridManager.matrixAutoUpdate=!1,e.axisGridManager.updateMatrixWorld(!0)),e.axisGridManager},AxisGridManager.destroy=function(e){e.axisGridManager=null},CLOUD.AxisGridManager=AxisGridManager;var CustomPlaneManager=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,CLOUD.ObjectGroupType.CUSTOMPLANE,{priority:20}));return e.globalSpace=!0,e}return _inherits(t,e),_createClass(t,[{key:"addPlane",value:function(e,t,n,i){var r=new THREE.Vector3;r.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),r.multiplyScalar(.5);var a=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(a,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(r),o.renderOrder=10,this.add(o),o.updateMatrixWorld(!0);var s=new THREE.TextureLoader;s.setCrossOrigin("anonymous"),s.load(n,function(e){o.material.map=e,o.material.needsUpdate=!0,i&&i(o)})}},{key:"removePlane",value:function(e){e&&this.remove(e)}},{key:"showPlane",value:function(e){e&&(e.visible=!0)}},{key:"hidePlane",value:function(e){e&&(e.visible=!1)}},{key:"setPlaneOpacity",value:function(e,t){e&&(e.material.opacity=t)}}]),t}(CLOUD.ObjectGroup);CustomPlaneManager.getInstance=function(e){return null==e.customPlaneManager&&(e.customPlaneManager=new CLOUD.CustomPlaneManager,e.objectGroups.add(e.customPlaneManager),e.customPlaneManager.matrix.copy(e.geometryGroup.matrix),e.customPlaneManager.matrixAutoUpdate=!1,e.customPlaneManager.updateMatrixWorld(!0)),e.customPlaneManager},CustomPlaneManager.destroy=function(e){e.customPlaneManager=null},CLOUD.CustomPlaneManager=CustomPlaneManager,CLOUD.Marker3D=function(e){function t(e){for(var t=0,n=e.length,r=function(){++t>=n&&(c.update(),i.render())},a=0;a<n;++a){var o=e[a];void 0===l[o]?l[o]=u.load(o,function(e){e.image=CLOUD.MaterialUtil.ensureQuadrate(e.image),r()},void 0,function(){r()}):r()}}function n(){for(var e in l)l.hasOwnProperty(e)&&delete l[e]}var i=e,r=i.getScene(),a=null,o=!1,s={},l={},u=new THREE.TextureLoader;u.setCrossOrigin("anonymous");var c=this,h={};this.add=function(e){var n,i,r=[];if(e&&e instanceof Array)for(n=0,i=e.length;n<i;++n){var a,o=e[n],l={id:o.id?o.id:THREE.Math.generateUUID(),position:{x:o.position.x,y:o.position.y,z:o.position.z},size:o.size?o.size:32,iconUrl:o.iconUrl?o.iconUrl:null,tooltip:o.tooltip};l.iconUrl?(a=l.iconUrl,r.push(l.iconUrl)):a="16777215",void 0===s[a]&&(s[a]=[]),void 0==h[l.id]&&(h[l.id]=!0),s[a].push(l)}t(r)},this.remove=function(e){if(e){var t=e.iconUrl?e.iconUrl:"16777215";if(void 0!==s[t]){for(var n=!1,i=s[t],r=0,a=i.length;r<a;++r)if(i[r].id===e.id){i.splice(r,1),n=!0;break}n&&this.update()}}},this.removeById=function(e){var t=!1;for(var n in s)if(s.hasOwnProperty(n))for(var i=s[n],r=0,a=i.length;r<a;++r)if(i[r].id===e){i.splice(r,1),t=!0;break}t&&this.update()},this.getItemById=function(e){for(var t in s)if(s.hasOwnProperty(t))for(var n=s[t],i=0,r=n.length;i<r;++i){var a=n[i];if(a.id===e)return{id:a.id,position:{x:a.position.x,y:a.position.y,z:a.position.z},size:a.size,iconUrl:a.iconUrl,tooltip:a.tooltip}}return null},this.getItems=function(){var e=[];for(var t in s)if(s.hasOwnProperty(t))for(var n=s[t],i=0,r=n.length;i<r;++i){var a=n[i];e.push({id:a.id,position:{x:a.position.x,y:a.position.y,z:a.position.z},size:a.size,iconUrl:a.iconUrl,tooltip:a.tooltip})}return e.length>0?e:null},this.clear=function(){a&&a.clear(),n();for(var e in s)s.hasOwnProperty(e)&&delete s[e];this.update()},this.activate=function(){this.clear()},this.deactivate=function(){this.clear(),a&&(r.removeObjectGroup(a),a=null)},this.show=function(){a&&(a.visible=!0),o=!1;for(var e in h)h.hasOwnProperty(e)&&(h[e]=!0);this.update()},this.showByIds=function(e){if(a&&(a.visible=!0),o=!1,e&&e instanceof Array){for(var t=0,n=e.length;t<n;t++)h[e[t]]=!0;this.update()}},this.hide=function(){a&&(a.visible=!1),o=!0;for(var e in h)h.hasOwnProperty(e)&&(h[e]=!1);this.update()},this.hideByIds=function(e){if(e&&e instanceof Array){for(var t=0,n=e.length;t<n;t++)h[e[t]]=!1;this.update()}},this.load=function(e){this.clear(),this.add(e),this.update()},this.update=function(){if(!o){a||(a=r.getOrCreateObjectGroup(CLOUD.ObjectGroupType.MARKER3D,{pickableType:CLOUD.PICKABLETYPE.Marker3d,hoverEnabled:!0,priority:2,globalSpace:!0})),a.clear();for(var e in s)if(s.hasOwnProperty(e)){var t=s[e],n=t.length;if(n<1)continue;for(var i=l[e],u=new Float32Array(3*n),c=new Float32Array(n),d=new THREE.Vector3,f=0,p=[],m=0;m<n;++m){var g=t[m];g.isHideByClustering||h[g.id]&&(d.set(g.position.x,g.position.y,g.position.z),d.toArray(u,3*m),c[m]=g.size,p.push(g.id),f<g.size&&(f=g.size))}var v=new THREE.BufferGeometry;v.addAttribute("position",new THREE.BufferAttribute(u,3)),v.addAttribute("attrSize",new THREE.BufferAttribute(c,1));var y=new THREE.PointsMaterial({size:f,sizeAttenuation:!1,positionOffset:!0,sizeAttribute:!0,map:i,depthTest:!0,alphaTest:.001,transparent:!0});y.color.setHex(16777215);var E=new CLOUD.PointsEx(v,y);E.name=e,E.size=f,E.pointIds=p,1==CLOUD.GlobalData.IncrementRender?E.renderOrder=100:E.renderOrder=-1,a.add(E),E.matrixAutoUpdate=!1,E.updateMatrixWorld(!0)}a.updateMatrixWorld(!0)}}},CLOUD.ClipPlanesTool=function(e){CLOUD.EditTool.call(this,CLOUD.EditToolMode.CLIP_BY_BOX),this.viewer=e,this.scene=e.getScene(),this.enablePick=!1,this.cameraControl=e.cameraControl,this.startPt=new THREE.Vector2,this.onClipBox=!1,this.mapLockedBoxFaces={},this.mapBoxFaceIndex={0:"Right",1:"Left",2:"Top",3:"Bottom",4:"Front",5:"Back"};for(var t=[],n=0;n<6;++n)t.push(new THREE.Plane);var i=CLOUD.ClipPlaneManager.getInstance(this.scene);i.updateClippingParams=function(n){if(0==n.iClipPlane.value)e.getRenderer().clippingPlanes=Object.freeze([]);else{for(var i=0,r=n.iClipPlane.value;i<r;++i){var a=n.vClipPlane.value[i],o=t[i];o.setComponents(-a.x,-a.y,-a.z,-a.w),o.normalize()}e.getRenderer().clippingPlanes=t,this.calculateClipBoundingBox(t),e.updateShadowMap()}},i.init(),this.selectIndex=null,this.planeDistance=0,this.offsetSpeed=.02,this.toggle=function(e,t){i.enable(e,t)},this.visible=function(e){i.visible=e},this.rotatable=function(e){i.rotatable=e},this.store=function(){return i.store()},this.restore=function(e){i.restore(e)},this.reset=function(){i.reset()},this.pointToScreen=function(e){var t=this.cameraControl.camera,n=new THREE.Matrix4;n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var i=new THREE.Vector4(e.x,e.y,e.z,1);i.applyMatrix4(n);var r=new THREE.Vector2;r.x=(i.x/i.w+1)/2,r.y=1-(i.y/i.w+1)/2;var a=this.cameraControl.getContainerDimensions();return r.x=r.x*a.width+a.left,r.y=r.y*a.height+a.top,r},this.getPlaneDistanceInScreen=function(){if(null==this.selectIndex)return null;if(this.selectIndex<2){var e=i.center.clone(),t=i.center.clone();e.x-=i.cubeSize.x,t.x+=i.cubeSize.x;var n=this.pointToScreen(e),r=this.pointToScreen(t);return n.x-r.x}var a=i.center.clone(),o=i.center.clone();o.y-=i.cubeSize.y,a.y+=i.cubeSize.y;var s=this.pointToScreen(o),l=this.pointToScreen(a);return s.y-l.y},this.getPickPoint=function(e,t){var n=this.cameraControl.camera,i=this.cameraControl.getContainerDimensions(),r=e-i.left,a=t-i.top,o=r/i.width*2-1,s=(i.height-a)/i.height*2-1,l=new CLOUD.Raycaster;return l.setFromCamera(new THREE.Vector2(o,s),n),l.ray.intersectPlane(this.plane)},this.getSelectIndex=function(){return i.selectIndex},this._isVisible=function(){return i.visible},this.isRotate=function(){return i.rotatable},this.offset=function(e){var t=Math.floor(this.selectIndex/2);this.selectIndex<=3?i.offset(this.selectIndex,-e*i.cubeSize.getComponent(t)*2):this.selectIndex%2==1?i.offset(this.selectIndex,-e*i.cubeSize.getComponent(t)*2):i.offset(this.selectIndex,e*i.cubeSize.getComponent(t)*2)},this.setSectionBox=function(e,t){var n=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));n.applyMatrix4(this.scene.getMatrixGlobal()),i.setSectionBox(n.min,n.max)},this.calculateOffsetByBox=function(e,t){var n=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));n.applyMatrix4(this.scene.getMatrixGlobal()),n.setFromCenterAndSize(n.getCenter(),n.getSize().multiplyScalar(this.scene.getExpandScalar())),i.calculateOffsetByBox(n.min,n.max)},this.moveSectionPlane=function(e,t){i.moveSectionPlane(e,t)},this.rotateSectionBox=function(e,t){i.rotateSectionBox(e,t)},this.rotate=function(e,t){2==this.selectIndex||3==this.selectIndex?i.rotX(t/180*Math.PI*.1):i.rotY(e/180*Math.PI*.1)},this.update=function(e){i.update(e)},this.cancelHighLight=function(){i.cancelHighLight()},this.highLight=function(){i.highLight()},this.lockBoxFaces=function(e){var t=!0,n=!1,i=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value;this.mapLockedBoxFaces[o]=!0}}catch(e){n=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(n)throw i}}},this.unlockBox=function(){this.mapLockedBoxFaces={}},this.setProcess=function(e,t){this.mapLockedBoxFaces[e]||i.setProcess(e,t)},this.getProcess=function(e){return i.getProcess(e)}},CLOUD.ClipPlanesTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.ClipPlanesTool.prototype.constructor=CLOUD.ClipPlanesTool,CLOUD.ClipPlanesTool.prototype.destroy=function(){this.cameraControl=null,this.intersectPoint=null,this.selectIndex=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null},CLOUD.ClipPlanesTool.prototype.onExit=function(){this.toggle(!1,!1)},CLOUD.ClipPlanesTool.prototype.processMouseDown=function(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY),n=CLOUD.ClipPlaneManager.getInstance(this.scene),i=n.hitTest(t),r=this.cameraControl.getIntersectContext(new THREE.Vector2(e.clientX,e.clientY)),a=this.cameraControl.intersector.intersect(r,null,!0);if(null!=a&&a.distance<=i.distance)return CLOUD.EditTool.prototype.processMouseDown(this,e);if(this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex)return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.enablePick=!0,this.clipStartPoint=t.ray.at(i.distance,this.clipStartPoint),!0}return CLOUD.EditTool.prototype.processMouseDown(this,e)},CLOUD.ClipPlanesTool.prototype.processHover=function(e){if(!this.enablePick){var t=!1,n=this.cameraControl.getRaycaster(e.clientX,e.clientY),i=CLOUD.ClipPlaneManager.getInstance(this.scene),r=this.getSelectIndex();null!==r&&this.cancelHighLight();i.hitTest(n);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),!this.onClipBox){this.onClipBox=!0;var a=this.cameraControl.viewer.modelManager;a.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}t=!0}else if(this.onClipBox){this.onClipBox=!1;var a=this.cameraControl.viewer.modelManager;a.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}return this.selectIndex!==r&&(this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0)),t}return CLOUD.EditTool.prototype.processHover(this,e)},CLOUD.ClipPlanesTool.prototype.processMouseUp=function(e){if(e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY),n=CLOUD.ClipPlaneManager.getInstance(this.scene);null!==this.getSelectIndex()&&(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0));n.hitTest(t);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!this.onClipBox){this.onClipBox=!0;var i=this.cameraControl.viewer.modelManager;i.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}}else if(this.onClipBox){this.onClipBox=!1;var i=this.cameraControl.viewer.modelManager;i.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}if(this.enablePick)return this.planeDistance=0,this.enablePick=!1,!0}return CLOUD.EditTool.prototype.processMouseUp(this,e)},CLOUD.ClipPlanesTool.prototype.processMouseMove=function(e){if(this.enablePick){if(this.isRotate())this.rotate(e.clientX-this.startPt.x,e.clientY-this.startPt.y),this.startPt.set(e.clientX,e.clientY);else{var t=this.mapBoxFaceIndex[this.selectIndex];if(this.mapLockedBoxFaces[t])return!0;if(!(e.clientX==this.startPt.x&&e.clientY==this.startPt.y)){var n=CLOUD.ClipPlaneManager.getInstance(this.scene),i=n.clipplanes[this.selectIndex],r=this.cameraControl.movePlane(i,e,this.startPt,!0,this.clipStartPoint);null!=r&&n.offset(this.selectIndex,r),this.startPt.set(e.clientX,e.clientY)}this.cameraControl.viewer.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_MOUSE_MOVE,draggedFaceName:t})}return this.cameraControl.update(!0),!0}return CLOUD.EditTool.prototype.processMouseMove(this,e)},CLOUD.ClipPlanesTool.prototype.processTouchstart=function(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.enablePick)return CLOUD.EditTool.prototype.processTouchstart(this,e);var t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);return CLOUD.ClipPlaneManager.getInstance(this.scene).hitTest(t),this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.update(),!0):void 0},CLOUD.ClipPlanesTool.prototype.processTouchmove=function(e){if(null!=this.selectIndex){if(this.isRotate())this.rotate(e.touches[0].clientX-this.startPt.x,e.touches[0].clientY-this.startPt.y),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY);else{var t=0;t=this.selectIndex<2?e.touches[0].clientX-this.startPt.x:e.touches[0].clientY-this.startPt.y,this.offset(t/this.planeDistance),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY)}return this.cameraControl.update(!0),this.update(),!0}return CLOUD.EditTool.prototype.processTouchmove(this,e)},CLOUD.ClipPlanesTool.prototype.processTouchend=function(e){return this.selectIndex=null,this.planeDistance=0,this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),this.update(),CLOUD.EditTool.prototype.processTouchend(this,e)},CLOUD.FillClipPlaneTool=function(e){CLOUD.EditTool.call(this,CLOUD.EditToolMode.CLIP_FILL),this.viewer=e,this.scene=e.getScene(),this.enablePick=!1,this.rotX=!0,this.onClipPlane=!1,this.cameraControl=e.cameraControl,this.startPt=new THREE.Vector2,this.modelManager=this.cameraControl.viewer.modelManager;var t=[new THREE.Plane],n=CLOUD.FillClipPlaneManager.getInstance(this.scene);n.updateClippingParams=function(n){if(0==n.iClipPlane.value)e.getRenderer().clippingPlanes=Object.freeze([]);else{var i=n.vClipPlane.value[0],r=t[0];r.setComponents(-i.x,-i.y,-i.z,-i.w),r.normalize(),e.getRenderer().clippingPlanes=t,this.renderClipPlane=new THREE.Plane,this.renderClipPlane.setComponents(i.x,i.y,i.z,-i.w),this.renderClipPlane.normalize(),this.calculateFillClipBoundingBox(r.coplanarPoint()),e.updateShadowMap()}},n.calculateClippingIds=function(){e.modelManager.calculateClippingIds()},n.init(),this.planeDistance=0,this.offsetSpeed=.02,this.toggle=function(e,t){n.enable(e,t),n.update()},this.visible=function(e){n.visible=e,n.update()},this.rotatable=function(e){n.rotatable=e,n.update()},this.hit=function(){return n.hit},this.pointToScreen=function(e){var t=this.cameraControl.camera,n=new THREE.Matrix4;n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var i=new THREE.Vector4(e.x,e.y,e.z,1);i.applyMatrix4(n);var r=new THREE.Vector2;r.x=(i.x/i.w+1)/2,r.y=1-(i.y/i.w+1)/2;var a=this.cameraControl.getContainerDimensions();return r.x=r.x*a.width+a.left,r.y=r.y*a.height+a.top,r},this.getPlaneDistanceInScreen=function(){if(null==this.selectIndex)return null;if(this.selectIndex<2){var e=clipPlanes.center.clone(),t=clipPlanes.center.clone();e.x-=clipPlanes.cubeSize.x,t.x+=clipPlanes.cubeSize.x;var n=this.pointToScreen(e),i=this.pointToScreen(t);return n.x-i.x}var r=clipPlanes.center.clone(),a=clipPlanes.center.clone();a.y-=clipPlanes.cubeSize.y,r.y+=clipPlanes.cubeSize.y;var o=this.pointToScreen(a),s=this.pointToScreen(r);return o.y-s.y},this.getPickPoint=function(e,t){var n=this.cameraControl.camera,i=this.cameraControl.getContainerDimensions(),r=e-i.left,a=t-i.top,o=r/i.width*2-1,s=(i.height-a)/i.height*2-1,l=new CLOUD.Raycaster;return l.setFromCamera(new THREE.Vector2(o,s),n),l.ray.intersectPlane(this.plane)},this._isVisible=function(){return n.visible},this.isRotate=function(){return n.rotatable},this.offset=function(e){n.offset(e)},this.setOffset=function(e){n.setOffset(e)},this.rotate=function(e,t){this.rotX?n.rotX(t/180*Math.PI*.1):n.rotY(e/180*Math.PI*.1)},this.rotateAngleOffset=function(e,t){n.rotateAngleOffset(e,t)},this.setRotateAngle=function(e,t){n.setRotateAngle(e,t)},this.getRotateAngle=function(){return n.getRotateAngle()},this.changeNormal=function(e){n.changeNormal(e)},this.update=function(e){n.update(e)},this.cancelHighLight=function(){n.cancelHighLight()},this.highLight=function(){n.highLight()},this.store=function(){return n.store()},this.restore=function(e){n.restore(e)},this.setProcess=function(e){n.setProcess(e)},this.getProcess=function(){return n.getProcess()}},CLOUD.FillClipPlaneTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.FillClipPlaneTool.prototype.constructor=CLOUD.FillClipPlaneTool,CLOUD.FillClipPlaneTool.prototype.destroy=function(){this.cameraControl=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null},CLOUD.FillClipPlaneTool.prototype.onExit=function(){this.toggle(!1,!1)},CLOUD.FillClipPlaneTool.prototype.processMouseDown=function(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY);if(CLOUD.FillClipPlaneManager.getInstance(this.scene).hitTest(t),this.hit())return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!1}return CLOUD.EditTool.prototype.processMouseDown(this,e)},CLOUD.FillClipPlaneTool.prototype.processMouseUp=function(e){this.planeDistance=0;var t=!1;if(this.enablePick&&e.button===THREE.MOUSE.LEFT)if(this.startPt.x==e.clientX&&this.startPt.y==e.clientY)this.pickHelper.click(e);else{var n=e.shiftKey||e.ctrlKey||e.altKey;if(n){this.endPt.set(e.clientX,e.clientY);var i=CLOUD.OPSELECTIONTYPE.Clear;e.ctrlKey?i=CLOUD.OPSELECTIONTYPE.Add:e.altKey&&(i=CLOUD.OPSELECTIONTYPE.Remove);var r=this;this.scene.pickByRect(this.frustum,i,function(){r.pickHelper.notifySelectionChanged(null,0,e)}),this.cameraControl.updateView(!0),t=!0}}var a=this.cameraControl.getRaycaster(e.clientX,e.clientY);return CLOUD.FillClipPlaneManager.getInstance(this.scene).hitTest(a),this.hit()?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane||(this.onClipPlane=!0,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane&&(this.onClipPlane=!1,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}))),this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_TOOL_END}),t},CLOUD.FillClipPlaneTool.prototype.processMouseMove=function(e){return this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_MOUSE_MOVE,event:e}),CLOUD.EditTool.prototype.processMouseMove(this,e)},CLOUD.FillClipPlaneTool.prototype.processTouchstart=function(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),!this.enablePick){var t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);CLOUD.FillClipPlaneManager.getInstance(this.scene).hitTest(t)}return this.hit()?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!0):CLOUD.EditTool.prototype.processTouchstart(this,e)},CLOUD.FillClipPlaneTool.prototype.processTouchmove=function(e){if(this.hit()){if(this.isRotate())this.rotate(e.touches[0].clientX-this.startPt.x,e.touches[0].clientY-this.startPt.y),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY);else{var t=0;t=e.touches[0].clientX-this.startPt.x,this.offset(1*t),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY)}return this.cameraControl.update(!0),!0}return CLOUD.EditTool.prototype.processTouchmove(this,e)},CLOUD.FillClipPlaneTool.prototype.processTouchend=function(e){return this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),CLOUD.EditTool.prototype.processTouchmove(this,e)},CLOUD.FillClipPlaneTool.prototype.processHover=function(e){if(!this.enablePick){var t=!1,n=this.cameraControl.getRaycaster(e.clientX,e.clientY)
;return CLOUD.FillClipPlaneManager.getInstance(this.scene).hitTest(n),this.hit()?(this.onClipPlane||(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!0,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):this.onClipPlane?(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!1,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e})):this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}),t}return CLOUD.EditTool.prototype.processHover(this,e)},CLOUD.ClipPlanes=function(e,t){CLOUD.ObjectGroup.call(this,CLOUD.ObjectGroupType.CLIPPLANE,{priority:20});var n=[];n.push("clipPlane_right"),n.push("clipPlane_left"),n.push("clipPlane_top"),n.push("clipPlane_bottom"),n.push("clipPlane_front"),n.push("clipPlane_back"),this.cubeSize=e.clone(),this.center=t.clone(),this.visible=!1,this.rotatable=!1,this.selectIndex=null,this.planeOffset=new Array(6),this.planeRotate=[0,0,0],this.observer=null,this.uniforms={iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:new Array(new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4)}},this.clipplanes=null,this.calculation=!0,this.boundingBox=new THREE.Box3,this.calculateClipBoundingBox=function(e){this.boundingBox.makeEmpty();for(var t=0;t<e.length;t++){var n=e[t].coplanarPoint();0!=n.x&&(n.x>this.boundingBox.max.x?this.boundingBox.max.x=n.x:n.x<this.boundingBox.min.x&&(this.boundingBox.min.x=n.x)),0!=n.y&&(n.y>this.boundingBox.max.y?this.boundingBox.max.y=n.y:n.y<this.boundingBox.min.y&&(this.boundingBox.min.y=n.y)),0!=n.z&&(n.z>this.boundingBox.max.z?this.boundingBox.max.z=n.z:n.z<this.boundingBox.min.z&&(this.boundingBox.min.z=n.z))}},this.getClipBoundingBox=function(){return this.boundingBox},this.isVisible=function(){return this.visible},this.getPlaneNormal=function(e){var t=new THREE.Vector4,n=Math.floor(e/2),i=e%2;return t.setComponent(n,Math.pow(-1,i)),t.w=.5*-this.cubeSize.getComponent(n),this.planeOffset[e]=0,t},this.planeMaterial=new CLOUD.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.planeHighLightMatrial=new CLOUD.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.initPlaneModel=function(e){var t=Math.floor(e/2),i=e%2,r=0==t?this.cubeSize.z:this.cubeSize.x,a=1==t?this.cubeSize.z:this.cubeSize.y,o=new THREE.PlaneGeometry(r,a),s=new THREE.Mesh(o,this.planeMaterial);s.name=n[e],s.customTag=!0,s.position.setComponent(t,Math.pow(-1,i)*this.cubeSize.getComponent(t)*.5),0==t?s.rotation.y=Math.pow(-1,i)*Math.PI*.5:1==t&&(s.rotation.x=Math.pow(-1,i)*Math.PI*.5),s.renderOrder=90,this.add(s)},this.initCapsBox=function(){var e=new THREE.BoxBufferGeometry(this.cubeSize.x,this.cubeSize.y,this.cubeSize.z);e.groups=null;var t=new CLOUD.PhongLightingMaterial({color:16776960,side:THREE.DoubleSide}),n=new THREE.Mesh(e,t);return n.matrixWorld=this.matrixWorld,n.matrix=this.matrix,n},this.initWireframes=function(){var e=[.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z],t=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],n=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,3,7,1,5,2,6],i=new THREE.BufferGeometry,r=new CLOUD.PhongLightingMaterial({color:1170103,lights:!0});i.setIndex(n),i.addAttribute("position",new THREE.Float32BufferAttribute(e,3)),i.addAttribute("color",new THREE.Float32BufferAttribute(t,3)),i.computeBoundingSphere();var a=new THREE.LineSegments(i,r);a.name="Wireframes",a.customTag=!0,this.add(a)},this.updateClippingParams=function(e){},this.enable=function(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?6:0,this.updateClippingParams(this.uniforms)},this.isEnabled=function(){return 0!==this.uniforms.iClipPlane.value};var i=function(e,t,n,i,r,a,o,s,l,u,c,h){this.enable=e,this.visible=t,this.rotatable=n,this.calculation=i,this.planeOffset=r.slice(0),this.planeRotate=a.slice(0),this.position=o,this.scale=s,this.quaternion=l,this.cubeSize=u,this.center=c,this.boundingBox=h};this.store=function(){return new i(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.calculation,this.planeOffset,this.planeRotate,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.boundingBox.clone())},this.restore=function(e){this.calculation=!0,this.calculationPlanes(e.cubeSize,e.center),this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.calculation=e.calculation;for(var t=0;t<6;++t)this.planeOffset[t]=e.planeOffset[t];for(var t=0;t<3;++t)this.planeRotate[t]=e.planeRotate[t];this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.update()},this.reset=function(){this.calculation=!0;for(var e=0;e<6;++e)this.planeOffset[e]=0;for(var e=0;e<3;++e)this.planeRotate[e]=0;this.position.copy(this.center),this.scale.copy(new THREE.Vector3(1,1,1)),this.quaternion.copy(new THREE.Quaternion),this.update()},this.calculationPlanes=function(e,t){if(this.calculation){this.cubeSize.copy(e),this.center.copy(t);for(var n=this.children.length,i=n-1;i>=0;--i)this.remove(this.children[i]);for(var i=0;i<6;++i)this.uniforms.vClipPlane.value[i]=this.getPlaneNormal(i),this.initPlaneModel(i);this.initWireframes(),this.clipplanes=this.uniforms.vClipPlane.value.slice(0),this.reset()}},this.update=function(){this.updateMatrixWorld();var e=new THREE.Matrix4;e.getInverse(this.matrix),e.transpose();for(var t=0;t<6;++t)this.uniforms.vClipPlane.value[t]=this.clipplanes[t].clone().applyMatrix4(e);this.updateClippingParams(this.uniforms),this.observer&&this.observer()},this.offset=function(e,t){this.calculation=!1;var n=Math.floor(e/2),i=this.cubeSize.getComponent(n);i*=.5,e%2==0&&this.planeOffset[e]+t>0&&(t=-this.planeOffset[e]),e%2==1&&this.planeOffset[e]+t<0&&(t=-this.planeOffset[e]),this.planeOffset[e]+=t;for(var r=new THREE.Vector3,a=0;a<6;++a){var o=this.clipplanes[a].clone(),s=this.planeOffset[a],l=new THREE.Vector3(o.x*s,o.y*s,o.z*s);r.add(l)}var u=1+r.getComponent(n)/this.cubeSize.getComponent(n);if((u=0==u?1e-5:u)>0){this.scale.setComponent(n,u);var c=this.uniforms.vClipPlane.value[e].clone(),h=new THREE.Vector3(c.x,c.y,c.z);h.normalize();var l=t,d=new THREE.Vector3(h.x*l,h.y*l,h.z*l);e%2==1?this.position.sub(d.multiplyScalar(.5)):this.position.add(d.multiplyScalar(.5)),this.update()}else this.planeOffset[e]-=t};var r=new THREE.Quaternion,a=new THREE.Vector3(1,0,0);this.rotX=function(e){this.calculation=!1,r.setFromAxisAngle(a,e),this.quaternion.multiply(r),this.update()};var o=new THREE.Vector3(0,1,0);this.rotY=function(e){this.calculation=!1,r.setFromAxisAngle(o,e),this.quaternion.multiply(r),this.update()},this.setSectionBox=function(e,t){this.calculation=!0;var n=new THREE.Vector3(t.x-e.x,t.y-e.y,t.z-e.z),i=new THREE.Vector3(.5*(e.x+t.x),.5*(e.y+t.y),.5*(e.z+t.z));this.calculationPlanes(n,i)},this.calculateOffsetByBox=function(e,t){var n=t.x-this.center.x-.5*this.cubeSize.x;n<this.planeOffset[0]?(this.moveSectionPlane("Left",this.center.x-.5*this.cubeSize.x-e.x),this.moveSectionPlane("Right",n)):(this.moveSectionPlane("Right",n),this.moveSectionPlane("Left",this.center.x-.5*this.cubeSize.x-e.x));var i=t.y-this.center.y-.5*this.cubeSize.y;i<this.planeOffset[2]?(this.moveSectionPlane("Bottom",this.center.y-.5*this.cubeSize.y-e.y),this.moveSectionPlane("Top",i)):(this.moveSectionPlane("Top",i),this.moveSectionPlane("Bottom",this.center.y-.5*this.cubeSize.y-e.y));var r=t.z-this.center.z-.5*this.cubeSize.z;r<this.planeOffset[4]?(this.moveSectionPlane("Back",this.center.z-.5*this.cubeSize.z-e.z),this.moveSectionPlane("Front",r)):(this.moveSectionPlane("Front",r),this.moveSectionPlane("Back",this.center.z-.5*this.cubeSize.z-e.z))},this.getPlaneIndexByName=function(e){var t=-1;return"Right"==e?t=0:"Left"==e?t=1:"Top"==e?t=2:"Bottom"==e?t=3:"Front"==e?t=4:"Back"==e&&(t=5),t},this.moveSectionPlane=function(e,t){var n=this.getPlaneIndexByName(e);if(-1!=n){n%2!=0&&(t=-t);var i=t-this.planeOffset[n];this.offset(n,i)}},this.setProcess=function(e,t){var n=this.getPlaneIndexByName(e),i=0;if(n<2?i=this.cubeSize.x:n<4?i=this.cubeSize.y:n<6&&(i=this.cubeSize.z),t>1?t=1:t<0&&(t=0),-1!=n){n%2!=1&&(t=-t);var r=t*i-this.planeOffset[n];this.offset(n,r)}},this.getProcess=function(e){var t=this.getPlaneIndexByName(e);-1==t&&console.log("faceName is illegal");var n=0;t<2?n=this.cubeSize.x:t<4?n=this.cubeSize.y:t<6&&(n=this.cubeSize.z);var i=1;t%2!=1&&(i=-1);var r=i*this.planeOffset[t]/n;return r>1?r=1:r<0&&(r=0),r};var s=new THREE.Vector3(0,0,1);this.rotateSectionBox=function(e,t){"x"==e?this.planeRotate[0]=t:"y"==e?this.planeRotate[1]=t:"z"==e&&(this.planeRotate[2]=t),this.calculation=!0;var n=new THREE.Quaternion;n.setFromAxisAngle(a,this.planeRotate[0]);var i=new THREE.Quaternion;i.setFromAxisAngle(o,this.planeRotate[1]);var r=new THREE.Quaternion;r.setFromAxisAngle(s,this.planeRotate[2]);var l=new THREE.Quaternion;l.multiply(n),l.multiply(i),l.multiply(r),this.quaternion.copy(l),this.update()},this.highLight=function(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeHighLightMatrial)},this.cancelHighLight=function(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeMaterial,this.selectIndex=null)}},CLOUD.ClipPlanes.prototype=Object.create(CLOUD.ObjectGroup.prototype),CLOUD.ClipPlanes.prototype.constructor=CLOUD.ClipPlanes,CLOUD.ClipPlanes.prototype.init=function(){this.calculationPlanes(this.cubeSize,this.center)},CLOUD.ClipPlanes.prototype.hitTest=function(e){var t=null,n=null;if(this.raycast(e),null!=this.selectIndex){var i=e.ray,r=new THREE.Plane,a=this.uniforms.vClipPlane.value[this.selectIndex];r.setComponents(a.x,a.y,a.z,a.w),t=i.distanceToPlane(r),n=i.direction.dot(r.normal)<0}return{sign:n,distance:t}},CLOUD.ClipPlanes.prototype.raycast=function(e){if(this.visible){var t=[],n=null;this.selectIndex=null;for(var i=0;i<6;i++)if(this.children[i].raycast(e,t),t.length>0){var r=t.pop();(!n||r.distance<n.distance)&&(n=r,this.selectIndex=i),t=[]}}},CLOUD.FillClipPlane=function(e,t){CLOUD.ObjectGroup.call(this,CLOUD.ObjectGroupType.FILLCLIPPLANE,{priority:20}),this.cubeSize=e.clone(),this.originBoundingBox=(new THREE.Box3).setFromCenterAndSize(t,e),this.boundingBox=this.originBoundingBox.clone(),this.center=t.clone(),this.length=Math.max(this.cubeSize.x,Math.max(this.cubeSize.y,this.cubeSize.z)),this.planeOffset=0,this.normalIndex=3,this.visible=!1,this.rotatable=!1,this.hit=!1,this.clipplane=new THREE.Vector4,this.observer=null,this.renderClipPlane=new THREE.Plane,this.angleA=0,this.angleB=0,this.capsIntersectPosition=[],this.uniforms={iClipPlane:{value:0},vClipPlane:{value:new Array(new THREE.Vector4)}},this.planeMaterial=new CLOUD.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.planeHighLightMatrial=new CLOUD.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.initPlaneModel=function(){for(var e=this.children.length,t=e-1;t>=0;--t)this.remove(this.children[t]);this.planeOffset=0;var n=this.length,i=new THREE.PlaneGeometry(n,n),r=new THREE.Mesh(i,this.planeMaterial);r.name="fillClipPlane",r.customTag=!0,r.renderOrder=90,this.position.copy(this.center),this.clipplane.set(0,0,1,0),this.planeMesh=r,this.add(r)},this.initWireframes=function(){var e=.5*this.length,t=[-e,e,0,e,e,0,-e,-e,0,e,-e,0],n=[0,1,1,3,3,2,2,0],i=new THREE.BufferGeometry,r=new CLOUD.PhongLightingMaterial({color:1170103,lights:!0});i.setIndex(n),i.addAttribute("position",new THREE.Float32BufferAttribute(t,3));var a=new THREE.LineSegments(i,r);a.name="Wireframes",a.customTag=!0,this.wireframeMesh=a,this.add(a)},this.getCoordinate=function(){var e=.5*this.length,t=new THREE.Vector3(-e,e,0);t.applyMatrix4(this.matrix);var n=new THREE.Vector3(e,e,0);n.applyMatrix4(this.matrix);var i=new THREE.Vector3(-e,-e,0);return i.applyMatrix4(this.matrix),{axisX:t.clone().sub(n).normalize(),axisY:t.clone().sub(i).normalize()}},this.initCapsPlane=function(){if(this.capPlane)return this.capPlane;var e=this.length,t=new THREE.PlaneGeometry(e,e),n=new CLOUD.PhongLightingMaterial({color:6380315,side:THREE.DoubleSide}),i=new THREE.Mesh(t,n),r=this.planeMesh;i.matrixWorld=r.matrixWorld,i.matrix=this.matrix;for(var a=.5*this.length,o=[],s=a-5;s>-a;s-=5)o.push(s,a,0),o.push(a,s,0);for(var s=5-a;s<a;s+=5)o.push(-a,s,0),o.push(s,-a,0);var l=new THREE.LineMaterial({color:2236962});l.linewidth=1,l.resolution.set(window.innerWidth,window.innerHeight),l.depthTest=!1;var u=new THREE.LineSegmentsGeometry;u.setPositions(o);var c=new THREE.LineSegments2(u,l);return c.matrix=this.matrix,c.matrixWorld=r.matrixWorld,this.capPlane={planeMesh:i,lineMesh:c},this.capPlane},this.addToCapsWireframe=function(e){if(this.capsWireframe)this.capsWireframe.geometry.setPositions(this.capsIntersectPosition),this.capsWireframe.geometry.maxInstancedCount=void 0;else{var t=new THREE.LineSegmentsGeometry;t.setPositions(this.capsIntersectPosition),this.capsWireframe=new THREE.LineSegments2(t,new THREE.LineMaterial({color:2236962,linewidth:1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight)}));e.manager.scene.getOrCreateObjectGroup(CLOUD.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0}).add(this.capsWireframe),this.capsWireframe.updateMatrixWorld(!0)}},this.clearCapsWireframe=function(){this.capsIntersectPosition.length=0,this.capsIntersectPosition=[],this.capsWireframe&&this.capsWireframe.geometry.removeAttribute("instanceStart"),this.capsWireframe&&this.capsWireframe.geometry.removeAttribute("instanceEnd")},this.calculateClippingIds=function(){},this.updateClippingParams=function(e){},this.getFillClipBoundingBox=function(){return this.boundingBox},this.calculateFillClipBoundingBox=function(e){this.boundingBox=this.originBoundingBox.clone(),0!=this.clipplane.x?1==this.clipplane.x?this.boundingBox.max.x=e.x:this.boundingBox.min.x=e.x:0!=this.clipplane.y?1==this.clipplane.y?this.boundingBox.max.y=e.y:this.boundingBox.min.y=e.y:0!=this.clipplane.z&&(1==this.clipplane.z?this.boundingBox.max.z=e.z:this.boundingBox.min.z=e.z)},this.enable=function(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?1:0,this.update()},this.isEnabled=function(){return 0!=this.uniforms.iClipPlane.value},this.update=function(){this.updateMatrixWorld();var e=new THREE.Matrix4;e.getInverse(this.matrix),e.transpose(),this.uniforms.vClipPlane.value[0]=this.clipplane.clone().applyMatrix4(e),this.updateClippingParams(this.uniforms),this.observer&&this.observer()},this.getClipPlane=function(){return this.clipplane.clone()},this.offset=function(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),this.planeOffset+=e,Math.abs(this.planeOffset)>.5*t&&(this.planeOffset=this.planeOffset>0?.5*t:.5*-t);var n=this.uniforms.vClipPlane.value[0].clone(),i=new THREE.Vector3(n.x,n.y,n.z);i.normalize();var r=new THREE.Vector3(i.x*this.planeOffset,i.y*this.planeOffset,i.z*this.planeOffset);this.position.copy(this.center).add(r),this.update()},this.setOffset=function(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),this.planeOffset=e,Math.abs(e)>.5*t&&(this.planeOffset=e>0?.5*t:.5*-t);var n=this.uniforms.vClipPlane.value[0].clone(),i=new THREE.Vector3(n.x,n.y,n.z);i.normalize();var r=new THREE.Vector3(i.x*this.planeOffset,i.y*this.planeOffset,i.z*this.planeOffset);this.position.copy(this.center).add(r),this.update()},this.changeNormal=function(e){this.quaternion.set(0,0,0,1),this.angleA=0,this.angleB=0,this.setNormal(e)},this.setNormal=function(e){var t=this.planeMesh,n=this.wireframeMesh;0==e?(this.clipplane.set(1,0,0,0),t.rotation.set(0,Math.PI/2,0),n.rotation.set(0,Math.PI/2,0)):1==e?(this.clipplane.set(-1,0,0,0),t.rotation.set(0,-Math.PI/2,0),n.rotation.set(0,-Math.PI/2,0)):2==e?(this.clipplane.set(0,0,-1,0),t.rotation.set(Math.PI,0,0),n.rotation.set(Math.PI,0,0)):3==e?(this.clipplane.set(0,0,1,0),t.rotation.set(0,0,0),n.rotation.set(0,0,0)):4==e?(this.clipplane.set(0,1,0,0),t.rotation.set(-Math.PI/2,0,0),n.rotation.set(-Math.PI/2,0,0)):5==e&&(this.clipplane.set(0,-1,0,0),t.rotation.set(Math.PI/2,0,0),n.rotation.set(Math.PI/2,0,0)),this.normalIndex=e,t.updateMatrixWorld(),n.updateMatrixWorld(),this.capPlane&&(this.capPlane.planeMesh.matrixWorld=t.matrixWorld,this.capPlane.lineMesh.matrixWorld=t.matrixWorld),this.update()};var n=new THREE.Quaternion,i=new THREE.Vector3(1,0,0);this.rotX=function(e){n.setFromAxisAngle(i,e),this.quaternion.multiply(n),this.update()};var r=new THREE.Vector3(0,1,0);this.rotY=function(e){n.setFromAxisAngle(r,e),this.quaternion.multiply(n),this.update()};var a=new THREE.Vector3(0,0,1);this.rotateByAxis=function(e,t){n.setFromAxisAngle(e,t),this.quaternion.multiply(n)},this.rotateAngleOffset=function(e,t){var n=this.normalIndex;e=e%360/180*Math.PI,0==n||1==n?("y"==t&&this.rotateByAxis(a,e),"z"==t&&this.rotateByAxis(r,e)):2==n||3==n?("x"==t&&this.rotateByAxis(i,e),"z"==t&&this.rotateByAxis(r,e)):4!=n&&5!=n||("x"==t&&this.rotateByAxis(i,e),"y"==t&&this.rotateByAxis(a,e)),this.update()},this.setRotateAngle=function(e,t){this.quaternion.set(0,0,0,1);var n=this.normalIndex;e=void 0==e?this.angleA:e%360,t=void 0==t?this.angleB:t%360,e=e<0?360+e:e,t=t<0?360+t:t,this.angleA=e,this.angleB=t,e=e/180*Math.PI,t=t/180*Math.PI,0==n||1==n?(e=0==n?-e:e,t=0==n?t:-t,this.rotateByAxis(a,e),this.rotateByAxis(r,t)):2==n||3==n?(this.rotateByAxis(i,e),this.rotateByAxis(r,t)):4!=n&&5!=n||(e=3==n?-e:e,t=3==n?t:-t,this.rotateByAxis(i,e),this.rotateByAxis(a,t)),this.update()},this.getRotateAngle=function(){return{angleA:this.angleA,angleB:this.angleB}},this.highLight=function(){this.planeMesh.material=this.planeHighLightMatrial},this.cancelHighLight=function(){this.planeMesh.material=this.planeMaterial,this.hit=!1};var o=function(e,t,n,i,r,a,o,s,l,u){this.enable=e,this.visible=t,this.rotatable=n,this.planeOffset=i,this.position=r,this.scale=a,this.quaternion=o,this.cubeSize=s,this.center=l,this.normalIndex=u};this.store=function(){return new o(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.planeOffset,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.normalIndex)},this.restore=function(e){this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.planeOffset=e.planeOffset,this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.normalIndex=void 0==e.normalIndex?this.normalIndex:e.normalIndex,this.setNormal(this.normalIndex)},this.setProcess=function(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),e>1?e=1:e<-1&&(e=-1),this.planeOffset=e*t*.5;var n=this.uniforms.vClipPlane.value[0].clone(),i=new THREE.Vector3(n.x,n.y,n.z);i.normalize();var r=new THREE.Vector3(i.x*this.planeOffset,i.y*this.planeOffset,i.z*this.planeOffset);this.position.copy(this.center).add(r),this.update()},this.restoreRotation=function(){this.quaternion.set(0,0,0,1),this.update()},this.getProcess=function(){var e=0;return this.normalIndex<2?e=this.cubeSize.x:this.normalIndex<4?e=this.cubeSize.z:this.normalIndex<6&&(e=this.cubeSize.y),this.planeOffset/e*2}},CLOUD.FillClipPlane.prototype=Object.create(CLOUD.ObjectGroup.prototype),CLOUD.FillClipPlane.prototype.constructor=CLOUD.FillClipPlane,CLOUD.FillClipPlane.prototype.init=function(){this.initPlaneModel(),this.initWireframes()},CLOUD.FillClipPlane.prototype.hitTest=function(e){if(!this.visible)return void(this.hit=!1);var t=null,n=null;if(this.hit=this.raycast(e),this.hit){var i=e.ray,r=new THREE.Plane,a=this.uniforms.vClipPlane.value[0];r.setComponents(a.x,a.y,a.z,a.w),t=i.distanceToPlane(r),n=i.direction.dot(r.normal)<0}return{sign:n,distance:t}},CLOUD.FillClipPlane.prototype.raycast=function(e,t){var n=[];return this.planeMesh.raycast(e,n),n.length>0},CLOUD.FillClipPlane.prototype.resize=function(e){var t=Math.max(e.x,Math.max(e.y,e.z)),n=t/this.length;this.scale.set(n,n,n),this.cubeSize.copy(e)},CLOUD.FillClipPlane.prototype.getSideLength=function(){return this.length*this.scale.x},CLOUD.ClipPlaneService=function(e){this.viewer=e},CLOUD.ClipPlaneService.prototype={construtor:CLOUD.ClipPlaneService,destroy:function(){this.viewer=null},update:function(e){var t=this.getEditor();t&&(t.update(e),this.viewer.render())},getEditor:function(){for(var e=this.viewer.editorManager.tools,t=0;t<e.length;t++)if(e[t].getName()==CLOUD.EditToolMode.CLIP_BY_BOX)return e[t];return null},setSectionBox:function(e,t){this.getEditor().setSectionBox(e,t)},toggle:function(e,t){this.getEditor().toggle(e,t)},setVisible:function(e){this.getEditor().visible(e)},setRotatable:function(e){this.getEditor().rotatable(e)},enablePick:function(e){this.getEditor().enablePick=e},saveState:function(){return this.getEditor().store()},loadState:function(e){this.getEditor().restore(e)},reset:function(){CLOUD.ClipPlaneManager.resetClipPlanes(this.viewer.getScene())},recalculate:function(){return this.viewer.getFilter().getVisibleComponentsBbox()},setProcess:function(e,t){this.getEditor().setProcess(e,t)},getProcess:function(e){return this.getEditor().getProcess(e)}},function(){var e=function e(){_classCallCheck(this,e)};e.getInstance=function(e){if(null==e.clipPlanes){var t=e.getBoundingBox();e.clipPlanes=new CLOUD.ClipPlanes(t.getSize().multiplyScalar(e.expandScalar),t.getCenter()),e.objectGroups.add(e.clipPlanes)}return e.clipPlanes},e.destroy=function(e){e.clipPlanes=null},e.setClipPlanes=function(e,t){if(t){var n=CLOUD.ClipPlaneManager.getInstance(e);t.setFromCenterAndSize(t.getCenter(),t.getSize().multiplyScalar(e.expandScalar)),n.setSectionBox(t.min,t.max)}},e.resetClipPlanes=function(e){var t=CLOUD.ClipPlaneManager.getInstance(e),n=e.getBoundingBox();if(t.reset(),n.max.x==-1/0||n.max.y==-1/0||n.max.z==-1/0||n.min.x==1/0||n.min.y==1/0||n.min.z==1/0)return void(e.clipPlanes=null);n.setFromCenterAndSize(n.getCenter(),n.getSize().multiplyScalar(e.expandScalar)),t.setSectionBox(n.min,n.max)},e.disableClipPlanes=function(e){null!=e.clipPlanes&&(e.clipPlanes.enable(!1,!1),e.clipPlanes.update())},CLOUD.ClipPlaneManager=e}(),function(){var e=function e(){_classCallCheck(this,e)};e.getInstance=function(e){if(null==e.fillClipPlane){var t=new THREE.Box3;t.copy(e.geometryGroup.boundingBox),t.applyMatrix4(e.geometryGroup.matrix),e.fillClipPlane=new CLOUD.FillClipPlane(t.getSize().multiplyScalar(e.expandScalar),t.getCenter()),e.objectGroups.add(e.fillClipPlane)}return e.fillClipPlane},e.destroy=function(e){e.fillClipPlane=null},e.disableClipPlanes=function(e){null!=e.fillClipPlane&&(e.fillClipPlane.enable(!1,!1),e.fillClipPlane.update())},CLOUD.FillClipPlaneManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.getModelManager(),{modelId:"ExternalComponent"}));return n.manager.addModel(n),n.filter=new CLOUD.FilterManager,n.filter.setObserverForSceneState(n.manager.getFilter().getObserverForSceneState()),n.meshes={},n.customSelectMaterials={},n.databagId="ExternalComponent",n.objectIds=null,n.lastFilteredIds=null,n.firstAnimation=!0,n.animationIds={},n.animationLength=0,n.animationId=0,n.invalidObjectType=["invalidPlane"],n.floorExplosion=!1,n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.manager.removeModel(this.id),this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this._removeNodeGroup(),this.meshes=null,this.customSelectMaterials=null,this.objectIds=null,this.lastFilteredIds=null,this._cancelAnimate(),this.firstAnimation=null,this.animationIds=null,this.invalidObjectType=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"addNode",value:function(e,t,n,i){if(this.meshes[e])return void console.log("Warning: name is already exist, please change name ");if(-1!=this.invalidObjectType.indexOf(t.type))return void console.log("Warning: the object is invalid");t instanceof Array||(t=[t]),this.meshes[e]=t;var r,a,o=[CLOUD.ExternalObjectConverterGroup];for(r=0,a=t.length;r<a;r++){var s,l=!1;o.some(function(e){return t[r]instanceof e&&(l=!0),l}),l?(s=t[r].clone(),t[r]=s):s=t[r],void 0===s._oriMatrix&&(s._oriMatrix=new THREE.Matrix4),s._oriMatrix.compose(s.position,s.quaternion,s.scale)}this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().addNode(e,t),void 0===n&&(n=!1),i&&(this.customSelectMaterials[e]=i);var u=this.getModelManager().viewer;for(r=0,a=t.length;r<a;r++){var s=t[r];s.name=e;var c=new THREE.Box3;c.setFromObject(s),s.box=c;var h=new THREE.Matrix4;h.getInverse(s.matrix),s.originBox=c.clone().applyMatrix4(h),this._initializeAnimation(s,e),this._getNodeGroup().add(s),s.updateMatrixWorld(!0),n||this._cacheNodeMaterial(s),4==CLOUD.GlobalData.LightPreset&&(u.traverseGroupEnableShadow(s,!0),u.updateShadowMap())}this._addToNodeInfoMap({name:e,userId:e,boundingBox:new THREE.Box3,state:CLOUD.EnumObjectState.Visible}),this._updateBoundingBoxByObjectId(e),this._updateFilterManager(),this.objectIds=Object.keys(this.meshes)}},{key:"getNodeById",value:function(e){var t=this.meshes[e];return t&&1===t.length?t[0]:t}},{key:"removeNodeById",value:function(e){if(this._hasObjectId(e)){var t=this.meshes[e];t[0].autoAnimation&&(delete this.animationIds[e],0==--this.animationLength&&this._cancelAnimate()),delete this.meshes[e],this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().removeNodeById(e),this.customSelectMaterials[e]&&delete this.customSelectMaterials[e];for(var n=this._getNodeGroup(),i=0,r=t.length;i<r;i++)n.remove(t[i]);this._removeFromNodeInfoMap(e),this._updateFilterManager(),this.filteredIds&&this.filteredIds[e]&&(delete this.filteredIds[e],this.lastFilteredIds=Object.keys(this.filteredIds)),this.objectIds=Object.keys(this.meshes);this.getModelManager().viewer.updateShadowMap()}}},{key:"clearNodes",value:function(){this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().clearNodes(),this._getNodeGroup().clear(),this._clearNodeInfoMap(),this.meshes={},this.customSelectMaterials={},this.objectIds=null,this.animationIds={},this.animationLength=0,this._cancelAnimate(),this._updateFilterManager(),this.filteredIds&&(this.filteredIds={},this.lastFilteredIds=Object.keys(this.filteredIds)),this.getModelManager().viewer.updateShadowMap()}},{key:"getAllNodes",value:function(){return this.meshes}},{key:"setAccumulateTransform",value:function(e,t,n,i,r){if(this.floorExplosion&&r)return void r();if(this._hasObjectId(e)){for(var a=this.meshes[e],o=0,s=a.length;o<s;o++){var l=a[o];this.setAccumulateTransformForMesh(l,t,n,i),l.box=l.originBox.clone().applyMatrix4(l.matrix),l.levelName=null}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().setAccumulateTransform(e,t,n,i);this.getModelManager().viewer.updateShadowMap()}}},{key:"setTransform",value:function(e,t,n,i,r){if(this.floorExplosion&&r)return void r();if(this._hasObjectId(e)){for(var a=this.meshes[e],o=0,s=a.length;o<s;o++){var l=a[o];this.setTransformForMesh(l,t,n,i),l.box=l.originBox.clone().applyMatrix4(l.matrix),l.levelName=null}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().setTransform(e,t,n,i);this.getModelManager().viewer.updateShadowMap()}}},{key:"rotateOnBasePoint",value:function(e,t,n,i){if(this._hasObjectId(e)){for(var r=this.meshes[e],a=new THREE.Vector3(t.x,t.y,t.z),o=new THREE.Vector3(n.x,n.y,n.z).normalize(),s=0,l=r.length;s<l;s++){var u=r[s],c=(new THREE.Quaternion).setFromAxisAngle(o,i);u.quaternion.premultiply(c),u.position.sub(a),u.position.applyQuaternion(c),u.position.add(a),u.updateMatrixWorld(),u.box=u.originBox.clone().applyMatrix4(u.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().rotateOnBasePoint(e,a,o,i);this.getModelManager().viewer.updateShadowMap()}}},{key:"scaleOnBasePoint",value:function(e,t,n){if(this._hasObjectId(e)){for(var i=this.meshes[e],r=new THREE.Vector3(t.x,t.y,t.z),a=0,o=i.length;a<o;a++){var s=i[a];s.scale.multiply(n),s.position.sub(r).multiply(n).add(r),s.updateMatrixWorld(),s.box=s.originBox.clone().applyMatrix4(s.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().scaleOnBasePoint(e,r,n)}}},{key:"getTransform",value:function(e){if(!this._hasObjectId(e))return null;var t=this.meshes[e];return{position:t[0].position,scale:t[0].scale,rotate:t[0].quaternion}}},{key:"applyTransform",value:function(e,t,n,i){if(this._hasObjectId(e)){var r=this.getTransformMatrix(t,n,i);this.applyTransformMatrix(e,r);this.getModelManager().viewer.updateShadowMap()}}},{key:"applyTransformMatrix",value:function(e,t){if(this._hasObjectId(e)){for(var n=this.meshes[e],i=0,r=n.length;i<r;i++){var a=n[i];this.updateMatrixWorldForMesh(a,t);var o=a.originBox.clone();a.box=o.applyMatrix4(a.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().applyTransformMatrix(e,t);this.getModelManager().viewer.updateShadowMap()}}},{key:"getTransformMatrix",value:function(e,t,n){e=e||new THREE.Vector3,t=t||new THREE.Vector3(1,1,1),n=n||new THREE.Quaternion;var i=new THREE.Matrix4;return i.compose(e,n,t),i}},{key:"setAccumulateTransformForMesh",value:function(e,t,n,i){t&&(e.position.x+=t.x,e.position.y+=t.y,e.position.z+=t.z),n&&(e.scale.x*=n.x,e.scale.y*=n.y,e.scale.z*=n.z),i&&(e.rotation.x+=i.x,e.rotation.y+=i.y,e.rotation.z+=i.z),e.updateMatrixWorld(),this.getModelManager().viewer.updateShadowMap()}},{key:"setTransformForMesh",value:function(e,t,n,i){t=t||e.position,n=n||e.scale,i=i||e.quaternion;var r=this.getTransformMatrix(t,n,i);this.updateMatrixWorldForMesh(e,r),this.getModelManager().viewer.updateShadowMap()}},{key:"updateMatrixWorldForMesh",value:function(e,t){var n=e._oriMatrix?e._oriMatrix:new THREE.Matrix4,i=n.clone().premultiply(t);i.decompose(e.position,e.quaternion,e.scale),e.matrixAutoUpdate||e.matrix.copy(i),e.updateMatrixWorld(!0),this.getModelManager().viewer.updateShadowMap()}},{key:"applyFilter",value:function(){this._hasNode()&&(this._collectFilteredIds(),this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}},{key:"applySelection",value:function(){this._hasNode()&&(this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}},{key:"clearSelection",value:function(){this._hasNode()&&(this._clearSelectedIds(),this.applyHover())}},{key:"applyHover",value:function(){this._hasNode()&&(this._collectHoveredIds(),this._updateNodes())}},{key:"clearHover",value:function(){this._hasNode()&&(this._clearHoveredIds(),this._updateNodes())}},{key:"getAllNodeInfos",value:function(){return this.nodeInfoMap}},{key:"getNodeInfosByUserId",value:function(e){return this.nodeInfoMap?this.nodeInfoMap[e]:void 0}},{key:"_addToNodeInfoMap",value:function(e){this.nodeInfoMap||(this.nodeInfoMap={}),this.nodeInfoMap[e.userId]||(this.nodeInfoMap[e.userId]=[]),this.nodeInfoMap[e.userId].push(e)}},{
key:"_removeFromNodeInfoMap",value:function(e){this.nodeInfoMap&&this.nodeInfoMap[e]&&delete this.nodeInfoMap[e]}},{key:"_clearNodeInfoMap",value:function(){this.nodeInfoMap={}}},{key:"_updateFilterManager",value:function(){var e={};e[this.id]=this.getAllNodeInfos(),this.getFilter().reinitFilterManager(e)}},{key:"_updateBoundingBoxByObjectId",value:function(e){if(this.nodeInfoMap&&this._hasObjectId(e)){var t,n,i=this.meshes[e],r=new THREE.Box3;for(t=0,n=i.length;t<n;t++)r.union(i[t].box);var a=this.nodeInfoMap[e];for(t=0,n=a.length;t<n;t++)a[t].boundingBox.copy(r)}}},{key:"_canBePick",value:function(e){return!!e._oriMaterial}},{key:"_getNodeGroup",value:function(){return this.getModelManager().getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.EXTERNALCOMPONENTMANAGER,{pickableType:CLOUD.PICKABLETYPE.ExternalComponent,globalSpace:!0})}},{key:"_removeNodeGroup",value:function(){this.getModelManager().getScene().removeObjectGroupByName(CLOUD.ObjectGroupType.EXTERNALCOMPONENTMANAGER)}},{key:"_cacheNodeMaterial",value:function(e){CLOUD.Utils.isGroupObject(e)?e.traverse(function(e){if(CLOUD.Utils.isMeshObject(e)&&!e._oriMaterial&&(e._oriMaterial=e.material,!e.geometry.index&&e.geometry.attributes&&e.geometry.attributes.position)){for(var t=[],n=e.geometry.attributes.position.array,i=0,r=n.length/3;i<r;i++)t.push(i);e.geometry.setIndex(new THREE.BufferAttribute(new Uint32Array(t),1))}}):e._oriMaterial||(e._oriMaterial=e.material)}},{key:"_collectFilteredIds",value:function(){var e=this.filteredIds={},t=this.getFilter(),n=t._hasHiddenFileIdFilter(),i=t._hasVisibleFilter(),r=t._hasOverrideMaterialFilter(),a=t._hasTransparentFilter();if(n||i||r||a)for(var o=this.objectIds,s=CLOUD.Model.EnumFilterState,l=0,u=o.length;l<u;l++){var c=o[l],h={name:c};if(i&&!1===t._isVisible(h))e[c]||(e[c]={}),e[c][s.HIDDEN]=!0;else if(a&&t._isTransparent(h))e[c]||(e[c]={}),e[c][s.TRANSPARENT]=!0;else if(r&&t._hasOverrideMaterial(h)){var d=t._getOverrideMaterial(h),f=null!=d?d.name:"";e[c]||(e[c]={}),e[c][s.OVERRIDED]=f}else;}}},{key:"_collectSelectedIds",value:function(){var e=this.filteredIds=this.filteredIds||{},t=CLOUD.Model.EnumFilterState,n=this.getModelManager().sceneState.getSelection(),i={};this._clearSelectedIds();for(var r=0,a=n.length;r<a;r++){var o=n[r];this.canBeSelectedId(o)&&(e[o]||(e[o]={}),e[o][t.SELECTED]=!0,i[o]=!0)}this.selectedIds=Object.keys(i)}},{key:"_clearSelectedIds",value:function(){if(this.filteredIds&&this.selectedIds&&this.selectedIds.length){for(var e=0,t=this.selectedIds.length;e<t;e++){var n=this.selectedIds[e];this.filteredIds[n]&&delete this.filteredIds[n][CLOUD.Model.EnumFilterState.SELECTED]}this.selectedIds=null}}},{key:"_collectHoveredIds",value:function(){var e=this.getModelManager().sceneState.hoverId;if(e&&this._hasObjectId(e)){var t=this.filteredIds=this.filteredIds||{};this.hoveredId=e,t[e]||(t[e]={}),t[e][CLOUD.Model.EnumFilterState.HOVER]=!0}}},{key:"_clearHoveredIds",value:function(){this.filteredIds&&this.hoveredId&&this.filteredIds[this.hoveredId]&&(delete this.filteredIds[this.hoveredId][CLOUD.Model.EnumFilterState.HOVER],this.hoveredId=void 0)}},{key:"_hasObjectId",value:function(e){var t=this.meshes[e];return!(!t||!t.length)}},{key:"canBeSelectedId",value:function(e){var t=this.meshes[e];return!(!t||t[0].disPickable)}},{key:"_hasNode",value:function(){return!(!this.objectIds||!this.objectIds.length)}},{key:"_traverseNodeById",value:function(e,t){if(this._hasObjectId(e))for(var n=this,i=this.meshes[e],r=0,a=i.length;r<a;r++){var o=i[r];CLOUD.Utils.isGroupObject(o)?o.traverseVisible(function(e){CLOUD.Utils.isMeshObject(e)&&n._canBePick(e)&&t&&t(e)}):CLOUD.Utils.isMeshObject(o)&&n._canBePick(o)&&t&&t(o)}}},{key:"_resetNodeMaterial",value:function(){var e=this.lastFilteredIds;if(e&&e.length)for(var t=0,n=e.length;t<n;t++)this._updateNodeVisible(e[t],!0),this._traverseNodeById(e[t],function(e){e.material=e._oriMaterial})}},{key:"_updateNodeVisible",value:function(e,t){for(var n=this.meshes[e],i=0,r=n.length;i<r;i++)n[i].visible=t}},{key:"_updateNodeById",value:function(e,t){if(this._hasObjectId(e)){var n=this.getModelManager().sceneState,i=CLOUD.Model.EnumFilterState,r=this.filteredIds[e];if(r){if(r[i.HIDDEN])return void this._updateNodeVisible(e,!1);if(r[i.TRANSPARENT]){var a=t._getMaterialByName("scene");return void this._traverseNodeById(e,function(e){e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=a:e.material=CLOUD.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,a)})}if(!this._isPickingEffectEnabled()&&r[i.SELECTED]){var o=n.selectionMaterial,s=this.customSelectMaterials[e];return void this._traverseNodeById(e,function(e){s?e.material=s:e._oriMaterial.isMeshPhongMaterial?(e.material=n.phongSelectionMaterial,e.material.skinning=e._oriMaterial.skinning):e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=o:e.material=CLOUD.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,o)})}if(r[i.HOVER])if(r[i.OVERRIDED]){var a=n.getHoverMaterial(t._getMaterialByName(r[i.OVERRIDED]));this._traverseNodeById(e,function(e){e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=a:e.material=CLOUD.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,a)})}else this._traverseNodeById(e,function(e){var t=n.getHoverMaterial(e._oriMaterial);e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=t:e.material=CLOUD.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,t)});else if(r[i.OVERRIDED]){var l=t._getMaterialByName(r[i.OVERRIDED]);return void this._traverseNodeById(e,function(e){e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=l:e.material=CLOUD.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,l)})}}}}},{key:"_updateNodes",value:function(){var e=this.getFilter();if(this._resetNodeMaterial(),this.filteredIds){for(var t in this.filteredIds)this._updateNodeById(t,e);this.lastFilteredIds=Object.keys(this.filteredIds)}}},{key:"_initializeAnimation",value:function(e,t){var n=this.getModelManager().viewer;if(e.autoAnimation){if("fire"==e.type){var i=CLOUD.GlobalData.SceneSize,r=n.getBoundingBoxWorld().getSize(),a=Math.max(r.x,r.y,r.z),o=i/a;e._initializeSizetween(o/.01421)}this.firstAnimation&&(this._animate(),this.firstAnimation=!1),this.animationIds[t]=!0,this.animationLength++}}},{key:"_animate",value:function(){function e(){t.animationId=requestAnimationFrame(e);JSON.parse(n.getCamera());for(var i in t.animationIds)for(var r=t.meshes[i],a=0,o=r.length;a<o;a++)r[a].autoAnimation&&r[a].update&&r[a].update();n.render()}var t=this,n=this.getModelManager().viewer;e()}},{key:"_cancelAnimate",value:function(){this.firstAnimation=!0,cancelAnimationFrame(this.animationId),this.animationId=0}},{key:"explode",value:function(){var e=this.getModelManager().viewer;this.floorExplosion=!0;var t=e.getFloorInfos();for(var n in this.meshes)for(var i=this.meshes[n],r=0,a=i.length;r<a;r++){var o=i[r],s=0;if(o.levelName)s=t[o.floorIndex].explodedHeight-o.explodedHeight,o.explodedHeight=t[o.floorIndex].explodedHeight;else for(var l=0,u=0,c=t.length,h=c-1;h>=0;h--){var d=t[h];if(u=t[h].preExplodedHeight-t[h].elevation+t[h].boundingBox.min.z,h==c-1&&(l=d.boundingBox.max.z-d.boundingBox.min.z+u),function(e,t,n){return n>=e-.001&&n<=t}(u,l,o.box.min.z)){o.levelName=d.name,s=d.explodedHeight-d.preExplodedHeight,o.explodedHeight=d.explodedHeight,o.floorIndex=h;break}l=u}var f=new THREE.Matrix4;f.makeTranslation(0,0,s),o.applyMatrix(f),o.updateMatrixWorld(),o.box=o.originBox.clone().applyMatrix4(o.matrix),this._updateBoundingBoxByObjectId(n)}}},{key:"isPickableNode",value:function(e){if(!this.canBeSelectedId(e.userId))return!1;var t=this.getFilter();return!t._isHiddenFileId(e)&&!1!==t._isVisible(e)&&!t._isTransparent(e)}},{key:"hasTransforms",value:function(){return!1}},{key:"isUserIdExist",value:function(e){return!!this.meshes[e]}},{key:"_isPickingEffectEnabled",value:function(){return!!CLOUD.GlobalData.PickingEffect}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingExternalMeshGenerator(this)),this.pickingNodeGenerator}},{key:"getPickingMeshes",value:function(e,t,n,i){var r=this.getPickingNodeGenerator(),a=r.updatePickingMeshes(e.selectedMaterial,n,i);a&&t.meshes.push(a)}},{key:"getBoundingBoxById",value:function(e){if(this.isUserIdExist(e)){return this.nodeInfoMap[e][0].boundingBox}return new THREE.Box3}}]),t}(CLOUD.BaseModel);CLOUD.ExternalComponentManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.geometryMapFromComponentId={},this.externalObjectMap={},this.defaultMaterial=CLOUD.MaterialUtil.getDefaultStandardMaterial()}return _createClass(e,[{key:"destroy",value:function(){this.viewer=null,this.geometryMapFromComponentId=null,this.externalObjectMap=null,this.defaultMaterial=null}},{key:"clear",value:function(){this.geometryMapFromComponentId={},this.externalObjectMap={},this.cancelAllHidden()}},{key:"cancelHiddenByComponentId",value:function(e){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelHiddenByUserId(e)}},{key:"cancelAllHidden",value:function(){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelAllHidden()}},{key:"convertToExternalObject",value:function(e,t,n){return this.externalObjectMap[e]?this.externalObjectMap[e].clone():(this._hideByUserId(t,n),this.externalObjectMap[e]=this._createMeshNodes(e,t),this.externalObjectMap[e].clone())}},{key:"getExternalObject",value:function(e){return this.externalObjectMap[e]}},{key:"_hideByUserId",value:function(e,t){this.viewer.setRenderStateChanged(!0);var n=this.viewer.modelManager.filterHelper.distributeId(e),i=(n.modelId,n.objectId);this.viewer.modelManager.getSourceObjectManager().hideByUserId(i,t)}},{key:"_getGeometries",value:function(e){var t=this.geometryMapFromComponentId[e];if(t)return t;var n=this.viewer.modelManager.filterHelper.distributeId(e),i=n.modelId,r=n.objectId,a=[];if(i){var o=this.viewer.modelManager.getModel(i);o._handler&&(a=a.concat(o._handler.getGeometryBuffersByUserId(r)))}else this.viewer.modelManager.traverseModels(function(e){e._handler&&(a=a.concat(e._handler.getGeometryBuffersByUserId(r)))});return t=this.geometryMapFromComponentId[e]=this._createGeometry(a)}},{key:"_createGeometry",value:function(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e[n],a=new THREE.BufferGeometry;a.setIndex(new THREE.BufferAttribute(r.index,1)),a.addAttribute("position",new THREE.BufferAttribute(r.position,3)),r.uv&&a.addAttribute("uv",new THREE.BufferAttribute(r.uv,2)),r.isLines||a.computeVertexNormals(),t.push({info:r,geometry:a})}return t}},{key:"_createMeshNodes",value:function(e,n){var i=new t;i.name=e;for(var r=this._getGeometries(n),a=0,o=r.length;a<o;a++){var s=r[a].geometry,l=r[a].info,u=this.viewer.modelManager.filterHelper.distributeId(n),c=(u.modelId,u.objectId),h=this.viewer.modelManager.getMaterialByNodeId(l.databagId,c,l.nodeId)||this.defaultMaterial,d=new THREE.Mesh(s,h);d=l.isLines?new THREE.LineSegments(s,h):new THREE.Mesh(s,h),d._databagId=l.databagId,d._nodeId=l.nodeId,d._oriUserId=n,d._oriMaterial=h,d._cloned=!0,l.matrix&&(d.matrix.copy(l.matrix),d.matrix.decompose(d.position,d.quaternion,d.scale)),i.add(d)}return i}}]),e}();CLOUD.ExternalObjectConverter=e;var t=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),t}(THREE.Group);CLOUD.ExternalObjectConverterGroup=t}();var AreaInfo=function(){function e(t){_classCallCheck(this,e),this.roomName=t,this.belong="user",this.roomBoundary=null,this.offsetZ=0,this.boundingBox=0}return _createClass(e,[{key:"checkRoomBoundary",value:function(e){function t(e,t,n){return(t.x-e.x)*(n.y-e.y)-(n.x-e.x)*(t.y-e.y)}function n(e,t,n,i){return!(Math.min(e.x,t.x)<=n.x&&n.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=n.y&&n.y<=Math.max(e.y,t.y))&&!(Math.min(e.x,t.x)<=i.x&&i.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=i.y&&i.y<=Math.max(e.y,t.y))}if(e.length<3)return console.log("Failed to create room boundary, the number of the points must be more than three."),!1;this.offsetZ=e[0][2];var i=new THREE.Box2,r=[];r.push(new THREE.Vector2(e[0][0],e[0][1]));for(var a=1,o=e.length;a<o;a++){if(3!=e[a].length)return console.log("Failed to create room boundary, the format of boundary is not right, please follow [[x1,y1,z1],...]"),!1;for(var a=1;a<e.length;a++){for(var s=!1,l=0;l<r.length;l++)if(e[a][0]==r[l].x&&e[a][1]==r[l].y){s=!0;break}if(!1===s){var u=new THREE.Vector2(e[a][0],e[a][1]);r.push(u),i.expandByPoint(u)}}}var c=r.length;if(c<3)return console.log("Failed to create room boundary, points are collinear."),!1;if(3==c)return 0==t(r[0],r[1],r[2])?(console.log("Failed to create room boundary, points are collinear."),!1):(r.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=r,this.boundingBox=i,!0);for(var h,d,f,p,a=0;a<c;a++){h=r[a],d=r[a==c-1?0:a+1];for(var l=a+2;l<c;l++)if((0!=a||l!=c-1)&&(f=r[l],p=r[l==c-1?0:l+1],function(e,i,r,a){var o=t(e,i,r)*t(e,i,a),s=t(r,a,e)*t(r,a,i);return!(o>0)&&(!(s>0)&&(0!=o||0!=s||!n(e,i,r,a)))}(h,d,f,p)))return console.log("Failed to create room boundary, the room boundary is self-intersection."),!1}return r.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=r,this.boundingBox=i,!0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"copy",value:function(e){return this.roomName=e.roomName,this.belong=e.belong,void 0!==e.roomBoundary&&(this.roomBoundary=JSON.parse(JSON.stringify(e.roomBoundary))),this.offsetZ=e.offsetZ,this.boundingBox=e.boundingBox.clone(),this}}]),e}();CLOUD.AreaInfo=AreaInfo;var BoundaryEdgeManager=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,CLOUD.ObjectGroupType.BoundaryEdgeManager,{priority:20}));return e.globalSpace=!0,e.areaInfo=new Array,e.areaGeometries=new Array,e.areaMeshes=new Array,e.areaMaterial=new THREE.LineMaterial({color:1005740}),e.areaMaterial.linewidth=5,e.areaMaterial.depthTest=!1,e}return _inherits(t,e),_createClass(t,[{key:"addAreaInfo",value:function(e){var t=this.areaInfo.length;return this.areaInfo.push(e),this.update(t),t}},{key:"setAreaInfo",value:function(e,t){return void 0!==e&&(this.areaInfo.length>e&&(this.areaInfo[e]=t,this.update(e),!0))}},{key:"setAreaLineColor",value:function(e){this.areaMaterial=new THREE.LineMaterial(e),this.areaMaterial.linewidth=1}},{key:"removeAreaInfo",value:function(e){if(void 0===e)return!1;if(this.areaMesh&&this.remove(this.areaMesh),this.areaInfo.length>e){this.areaInfo.splice(e,1),this.areaGeometries.splice(e,1);var t=this.areaMeshes[e];return this.remove(t),this.areaMeshes.splice(e,1),!0}return!1}},{key:"update",value:function(e){if(!(void 0===e||this.areaInfo.length<e)){for(var t=this.areaInfo[e].length,n=new Array,i=0;i<t;++i)for(var r=this.areaInfo[e][i],a=0,o=r.length;a<o;++a){var s=r[a];n.push(s.x),n.push(s.y),n.push(s.z)}this.areaMesh&&this.remove(this.areaMesh);var l=new THREE.LineSegmentsGeometry;l.setPositions(n),this.areaMaterial.resolution.set(window.innerWidth,window.innerHeight),this.areaMesh=new THREE.LineSegments2(l,this.areaMaterial),this.areaMesh.renderOrder=100,this.add(this.areaMesh),this.updateMatrixWorld(!0)}}}]),t}(CLOUD.ObjectGroup);BoundaryEdgeManager.getInstance=function(e){return null==e.boundaryEdge&&(e.boundaryEdge=new CLOUD.BoundaryEdgeManager,e.objectGroups.add(e.boundaryEdge),e.boundaryEdge.matrix.copy(e.geometryGroup.matrix),e.boundaryEdge.matrixAutoUpdate=!1,e.boundaryEdge.updateMatrixWorld(!0)),e.boundaryEdge},BoundaryEdgeManager.destroy=function(e){e.boundaryEdge=null},CLOUD.BoundaryEdgeManager=BoundaryEdgeManager;var ExtrudeBodyManager=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.getModelManager(),{modelId:CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER}));return n.manager.addModel(n),n.filter=new CLOUD.FilterManager,n.filter.setObserverForSceneState(n.manager.getFilter().getObserverForSceneState()),n.mapColorToNodeId={},n.selectionIds={},n.selectionColor={red:50,green:224,blue:240,alpha:.3},n.selectionEdgeColor={red:50,green:224,blue:240,alpha:1},n}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.manager.removeModel(this.id),this._removeNodeGroup(),this.mapColorToNodeId=null,this.selectionIds=null,this.selectionColor=null,this.selectionEdgeColor=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"_getNodeGroup",value:function(){return this.getModelManager().getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:CLOUD.PICKABLETYPE.Room,priority:20,globalSpace:!0})}},{key:"_removeNodeGroup",value:function(){this.getModelManager().getScene().removeObjectGroupByName(CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER)}},{key:"addNode",value:function(e,t,n,i,r,a){a=void 0==a||a,this.getNode(e)&&this.removeNodeById(e);var o=new Array,s=0,l=0,u=0,c=null;if(t.belong&&"user"==t.belong){s=t.offsetZ;for(var h=0,d=t.roomBoundary.length;h<d;h++){var f=t.roomBoundary[h];o[h]=new THREE.Vector2(f.x,f.y)}}else{t.version&&"2.0"==t.version&&(c=t.loops&&t.loops.length>0?t.loops[0]:[]);for(var p=c.length,h=0;h<p;++h)for(var m=c[h],g=m.length,v=0;v<g-1;v++){var y=m[v];o.push(new THREE.Vector2(y.x,y.y)),0==h&&0==v&&(s=y.z)}o.length>0&&o.push(o[0].clone())}if(t.offsetZ||(t.offsetZ=s),!(o.length<0)){var E=[];l=o[0].x,u=o[0].y;for(var h=0,d=o.length-1;h<d;h++){var y=o[h];l>y.x&&(l=y.x),u>y.y&&(u=y.y),E.push({x:y.x,y:y.y,z:s})}for(var h=0,d=o.length;h<d;h++)o[h].x-=l,o[h].y-=u;var b=new THREE.Shape(o),x={amount:n,bevelEnabled:!1},M=this._checkVertices(E.slice()),_=new THREE.ExtrudeGeometry(b,x);_.contour=E,this._faceToContour(_,l,u),_.boundingBox||_.computeBoundingBox();var C=new THREE.Mesh(_,i);C.name=e.toString(),C.translateX(l),C.translateY(u),C.translateZ(s),this.setColorInMap(C.name,i),this._getNodeGroup().add(C),this._getNodeGroup().updateMatrixWorld(!0);for(var I=C.geometry.faces,O=[],h=0,g=I.length;h<g;h++)O.push(I[h].a),O.push(I[h].b),O.push(I[h].c);for(var T=C.geometry.vertices,L=[],h=0,g=T.length;h<g;h++)L.push(T[h].x),L.push(T[h].y),L.push(T[h].z);var S=CLOUD.BuildRoomEdge(M,l,u,s,n);r.depthTest=!a,r.transparent=!0;var D=new THREE.LineSegments(S,r);D.translateX(l),D.translateY(u),D.translateZ(s),D.name="wireframe_"+e,this.setColorInMap(D.name,r),this._getNodeGroup().add(D),this._getNodeGroup().updateMatrixWorld(!0)}}},{key:"_checkVertices",value:function(e){function t(e,t,n){return Math.abs(t.x-e.x)<.1&&Math.abs(n.x-e.x)<.1||(Math.abs(t.y-e.y)<.1&&Math.abs(n.y-e.y)<.1||Math.abs((t.x-e.x)*(n.y-e.y)-(n.x-e.x)*(t.y-e.y))<10)}for(var n=e.length;t(e[0],e[1],e[n-1]);)e.shift(),n=e.length;for(n=e.length;t(e[0],e[n-2],e[n-1]);)e.pop(),n=e.length;n=e.length;for(var i=0;i+2<n;){for(var r=i;r+2<n&&t(e[i],e[r+1],e[r+2]);)e.splice(r+1,1),n=e.length;i++}return e}},{key:"_faceToContour",value:function(e,t,n){function i(e,t){return Math.abs(e-t)<=.1}function r(e,t){var n=e<t?e:t,i=e>t?e:t;return 0==n&&i==u-1?{st:i,ed:n}:{st:n,ed:i}}for(var a=e.contour,o=e.vertices,s=[],l=o.length,u=a.length,c=0;c<u;c++){for(var h=0;h<.5*l;h++)if(i(o[h].x+t,a[c].x)&&i(o[h].y+n,a[c].y)){s[h]=c;break}for(var h=.5*l;h<l;h++)if(i(o[h].x+t,a[c].x)&&i(o[h].y+n,a[c].y)){s[h]=c;break}}for(var d=e.faces,c=0,f=d.length;c<f;c++){var p=d[c],m=s[p.a],g=s[p.b],v=s[p.c];m!=g&&m!=v||(p.contourIndex=r(g,v)),v==g&&(p.contourIndex=r(m,g))}}},{key:"applyFrontEffect",value:function(e,t,n){for(var i=this._getNodeGroup().parent.children,r=i.length,a=new Array(r),o=0;o<r;++o)a[o]=i[o].visible,i[o].visible=!1;this.setVisible(!0);var s=e.autoClear,l=e.autoClearColor,u=e.autoClearDepth,c=e.autoClearStencil;e.autoClear=!0,e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.render(t,n),e.autoClear=s,e.autoClearColor=l,e.autoClearDepth=u,e.autoClearStencil=c;for(var o=0;o<r;++o)i[o].visible=a[o]}},{key:"setColorInMap",value:function(e,t){var n={red:255*t.color.r,green:255*t.color.g,blue:255*t.color.b,alpha:t.opacity};this.mapColorToNodeId[e]=n}},{key:"createMaterial",value:function(e){return CLOUD.MaterialUtil.createStandardMaterial(e)}},{key:"setNodeMaterial",value:function(e,t,n){var i=this.getNode(e);if(i){var r=i.material;for(var a in t){var o=a;r.hasOwnProperty(o)&&(r[o]="color"==o?new THREE.Color(t[a]):t[a])}}if(i=this.getNode("wireframe_"+e)){var r=i.material;for(var a in n){var o=a;r.hasOwnProperty(o)&&(r[o]="color"==o?new THREE.Color(n[a]):n[a])}}}},{key:"getNode",value:function(e){for(var t=this._getNodeGroup().children,n=0,i=t.length;n<i;n++)if(t[n].name==e.toString())return t[n];return null}},{key:"removeNodeById",value:function(e){var t=this.getNode(e);return t&&(delete this.mapColorToNodeId[t.name],this._getNodeGroup().remove(t)),!!(t=this.getNode("wireframe_"+e))&&(delete this.mapColorToNodeId[t.name],this._getNodeGroup().remove(t),!0)}},{key:"clearNodes",value:function(){this._getNodeGroup().clear(),this.mapColorToNodeId={}}},{key:"setNodeVisibleById",value:function(e,t){var n=this.getNode(e);return n&&(n.visible=t),!!(n=this.getNode("wireframe_"+e))&&(n.visible=t,!0)}},{key:"showAllNodes",value:function(){for(var e=this._getNodeGroup().children,t=0,n=e.length;t<n;t++)e[t].visible=!0}},{key:"hideAllNodes",value:function(){for(var e=this._getNodeGroup().children,t=0,n=e.length;t<n;t++)e[t].visible=!1}},{key:"setNodeColorById",value:function(e,t){var n=this.getNode(e);if(n){var i=n.material;return i.color=new THREE.Color(t.red/255,t.green/255,t.blue/255),i.opacity=t.alpha,t!=this.selectionColor&&t!=this.selectionEdgeColor&&this.setColorInMap(n.name,i),!0}return!1}},{key:"getNodeColorById",value:function(e){return this.mapColorToNodeId[e]}},{key:"setWireframeColorById",value:function(e,t){return this.setNodeColorById("wireframe_"+e,t)}},{key:"getWireframeColorById",value:function(e){return this.getNodeColorById("wireframe_"+e)}},{key:"applySelection",value:function(){this.clearSelection();var e=this.selectionIds,t=this.mapColorToNodeId,n=this.getModelManager().sceneState.getSelectionSet(this.id);for(var i in n)t[i]&&(e[i]=!0,this.setNodeColorById(i,this.selectionColor),this.setWireframeColorById(i,this.selectionEdgeColor))}},{key:"clearSelection",value:function(){var e=this.selectionIds,t=this.mapColorToNodeId;if(e){for(var n=this._getNodeGroup().children,i=0,r=n.length;i<r;i++){var a=n[i],o=t[a.name];a.material.color=new THREE.Color(o.red/255,o.green/255,o.blue/255),a.material.opacity=o.alpha}this.selectionIds={}}}},{key:"applyHover",value:function(){var e=this.getModelManager().sceneState;if(e.hoverId&&!e.isSelected(e.hoverId)){var t=this.getNode(e.hoverId);if(t){this.hoveredId=e.hoverId;var n=this.mapColorToNodeId[this.hoveredId],i=CLOUD.MaterialUtil.getHoverColorByColor({r:n.red/255,g:n.green/255,b:n.blue/255,a:n.alpha});t.material.color.setRGB(i.r,i.g,i.b),t.material.opacity=i.a}}}},{key:"clearHover",value:function(){var e=this.hoveredId;if(e){if(this.selectionIds[e])return void(this.hoveredId=null);var t=this.getNode(e);if(!t)return void(this.hoveredId=null);var n=this.mapColorToNodeId[e];t.material.color.setRGB(n.red/255,n.green/255,n.blue/255),t.material.opacity=n.alpha,this.hoveredId=null}}},{key:"sortRenderOrder",value:function(e){for(var t=this._getNodeGroup().children,n=e.camera.position.clone(),i=new Map,r=0,a=t.length;r<a;++r){var o=t[r];if(-1!=o.name.indexOf("wireframe"));else{var s={};s[o.name]=null;var l=e.getBoundingBoxByIds(s).getCenter(),u=n.distanceTo(l);i.set(r,u)}}var c=Array.from(i);c.sort(function(e,t){return t[1]-e[1]});for(var h=1,r=0,a=c.length;r<a;++r)t[c[r][0]].renderOrder=h,null!=t[c[r][0]+1]&&(t[c[r][0]+1].renderOrder=h),++h}},{key:"explode",value:function(){for(var e=this.getModelManager().getFloorInfos(),t=this._getNodeGroup().children,n=0,i=t.length;n<i;n++){var r=t[n],a=0;if(r.levelName)a=e[r.floorIndex].explodedHeight-r.explodedHeight,r.explodedHeight=e[r.floorIndex].explodedHeight;else for(var o=0,s=0,l=e.length,u=l-1;u>=0;u--){var c=e[u];if(s=e[u].preExplodedHeight-e[u].elevation+e[u].boundingBox.min.z,u==l-1&&(o=c.boundingBox.max.z-c.boundingBox.min.z+s),function(e,t,n){return n>=e-.001&&n<=t}(s,o,r.position.z)){r.levelName=c.name,a=c.explodedHeight-c.preExplodedHeight,r.explodedHeight=c.explodedHeight,r.floorIndex=u;break}o=s}r.translateZ(a),r.updateMatrixWorld()}}},{key:"setVisible",value:function(e){this._getNodeGroup().visible=e}}]),t}(CLOUD.BaseModel);ExtrudeBodyManager.getInstance=function(e){var t=e.getModelManager().getScene();if(null==t.extrudeBodyManager){t.extrudeBodyManager=new CLOUD.ExtrudeBodyManager(e);var n=t.extrudeBodyManager._getNodeGroup();t.objectGroups.add(n),n.matrix.copy(t.geometryGroup.matrix),n.matrixAutoUpdate=!1,n.updateMatrixWorld(!0)}return t.extrudeBodyManager},ExtrudeBodyManager.destroy=function(e){var t=e.getModelManager().getScene();t.extrudeBodyManager.destroy(),t.extrudeBodyManager=null},CLOUD.ExtrudeBodyManager=ExtrudeBodyManager,function(){var e=function e(t,n,i){_classCallCheck(this,e),this.id=t,this.condition=n,this.material=i};CLOUD.MaterialOverrider=e}(),function(){var e=function(){function e(t,n){_classCallCheck(this,e),this.overriders=[],this.overrideData=t,this.materials={},this.materialsByName={},this.textures={},this.defaultColor=n||"#808080",this.loader=new CLOUD.MaterialOverriderLoader(this.defaultColor)}return _createClass(e,[{key:"load",value:function(e,t,n,i,r){n=void 0!=n&&n,(new CLOUD.MaterialOverriderLoader).getMaterialOverriders(this.overriders,e,t,n,i,r)}},{key:"loadByDemand",value:function(e,t,n){this.loader.getMaterialsByDemand(this.materials,this.materialsByName,this.textures,this.overrideData,e,t,n)}},{key:"setDefaultColor",value:function(e){this.defaultColor=e,this.loader.defaultColor=e}},{key:"getOverrideMaterials",value:function(){return this.materials}},{key:"getOverrideMaterialByNodeInfo",value:function(e){var t=this.materials;return t["elementId_"+e.userId]||t["familyId_"+e.userData.familyId]||t["systemTypeId_"+e.userData.systemTypeId]}},{key:"getOverrideMaterialByName",value:function(e){return this.materialsByName[e]}},{key:"updateMaterialsValue",value:function(e,t){var n,i=this.materials;for(var r in i)(n=i[r])&&n[e]&&(n[e]=t,void 0!==n.refreshUniforms&&n.refreshUniforms(),n.needsUpdate=!0)}}]),e}();CLOUD.MaterialOverriderSet=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.loader=new THREE.FileLoader,this.loadTaskCount=0,this.maxLoadTask=0,this.defaultColor=t}return _createClass(e,[{key:"getMaterialOverriders",value:function(e,t,n,i,r,a){var o=this,s=t.overrides;o._getOverridesByData(e,s,n,i,r,a),0==this.maxLoadTask&&r&&r()}},{key:"getMaterialsByDemand",value:function(e,t,n,i,r,a,o){this.maxLoadTask=0,this.loadTaskCount=0;for(var s=[],l=i.overrides,u=i.textureMaterials,c=r.familyIds,h=r.elementIds,d=r.systemTypeIds,f=l.length,p=f-1;p>=0;p--){var m,g=l[p].targetType,v=l[p].target;if("family"==g){if(!c[v])continue;m="familyId_"+v}else if("element"==g){if(!h[v])continue;m="elementId_"+v}else{if("systemType"!=g)continue;if(!d[v])continue;m="systemTypeId_"+v}if(!e[m]){var y=l[p].colorMaterial;if(!y){if(!l[p].textureMaterial)continue;y=this.defaultColor}var E=new CLOUD.CloudStandardMaterial;if(E.pureColor=y,E.color.setStyle(y),E.name=y,l[p].textureMaterial){var b=JSON.parse(l[p].textureMaterial),x=b.materialId,M=u[b.materialId];E.name=M?x+E.name:E.name;var _=t[E.name];if(_){e[m]=_;continue}if(M){var C=JSON.parse(M);if(C.diffuse_color){var I=C.diffuse_color.split(",");E.color.setRGB(parseFloat(I[0]),parseFloat(I[1]),parseFloat(I[2])),E.opacity=parseFloat(I[3])}var O=1==C.transparent;if(E.transparent=O,E.roughness=C.roughness,E.metalness=C.metallic,E.bumpScale=C.enableBump,!s[b.materialId]&&!n[b.materialId]){if(C.diffuse_texture){var T=C.diffuse_texture.texture_file;T&&""!=T?(this.maxLoadTask+=2,s[b.materialId]={diffuse:C.diffuse_texture}):E.textureColor=E.color.getStyle()}if(C.bump_texture){var L=C.bump_texture.texture_file;L&&""!=L&&(this.maxLoadTask+=2,s[b.materialId]?s[b.materialId].bump=C.bump_texture:s[b.materialId]={bump:C.bump_texture})}}}else E.textureColor=y,console.log("Warning: there is no corresponding textureMaterial whose materialId is "+b.materialId)}else{var _=t[E.name];if(_){e[m]=_;continue}E.textureColor=y}E.needsUpdate=!0,E.side=THREE.DoubleSide,e[m]=E,t[E.name]=E}}this._mappingTexturesByDemand(t,n,s,a,o),0==this.maxLoadTask&&a&&a()}},{key:"_getOverridesByData",value:function(e,t,n,i,r,a){for(var o=n.familyIds,s=n.elementIds,l=n.systemTypeIds,u=!1,c=[],h=[],d=0,f=t.length;d<f;d++){var p,m=t[d].targetType,g=t[d].target;if("family"==m){if(!o[g])continue;p=[{familyId:g}]}else if("element"==m){if(!s[g])continue;p=[{elementId:g}]}else{if("systemType"!=consitionType)continue;if(!l[g])continue;p=[{systemTypeId:g}]}u=!0;var v;if(i){var y=t[d].colorMaterial;if(!y)continue;v=new CLOUD.CloudStandardMaterial,v.color.setStyle(y),v.name=t[d].id}else{if(!t[d].textureMaterial)continue;var E=JSON.parse(t[d].textureMaterial);if(!E.diffuse_color)continue;var y=E.diffuse_color.split(","),b=1==E.transparent;v=new CLOUD.CloudStandardMaterial({opacity:parseFloat(y[3]),roughness:E.roughness,metalness:E.metallic,transparent:b,bumpScale:E.enableBump}),v.name=E.id,v.color.setRGB(parseFloat(y[0]),parseFloat(y[1]),parseFloat(y[2]));var x=E.diffuse_texture.texture_file;x&&""!=x&&(this.maxLoadTask+=2,c[d]={diffuse:E.diffuse_texture});var M=E.bump_texture.texture_file;M&&""!=M&&(this.maxLoadTask+=2,c[d]?c[d].bump=E.bump_texture:c[d]={bump:E.bump_texture}),v.needsUpdate=!0}h[d]=v;var _=new CLOUD.MaterialOverrider(t[d].id,p,v);e.push(_)}if(this._mappingTextures(h,c,r,a),!u){console.log("there is no conditions matched"),a&&a()}}},{key:"_mappingTextures",value:function(e,t,n,i){for(var r=0;r<e.length;r++){if(e[r]&&t[r]){if(t[r].diffuse){var a=this._loadTexture(t[r].diffuse,n,i);e[r].map=a}if(t[r].bump){var o=this._loadTexture(t[r].bump,n,i);e[r].bumpMap=o}e[r].needsUpdate=!0}}}},{key:"_mappingTexturesByDemand",value:function(e,t,n,i,r){for(var a in e)if(e.hasOwnProperty(a)){var o=e[a],s=o.name.split("#")[0];if(o&&n[s]){if(!t[s]){if(t[s]=[],n[s].diffuse){var l=this._loadTexture(n[s].diffuse,i,r);l.texturetype="map",t[s].push(l)}if(n[s].bump){var u=this._loadTexture(n[s].bump,i,r);u.texturetype="bumpMap",t[s].push(u)}}e[a].map=t[s][0],t[s].length>1&&(e[a].bumpMap=t[s][1]),e[a].needsUpdate=!0}}}},{key:"_loadTexture",value:function(e,t,n){var i=new THREE.Texture,r=this;return(new TEST.CryptoResourceLoader).loadURL(e.texture_file,function(n){var a=new Blob([n],{type:"jpeg"}),o=r._loadImage(URL.createObjectURL(a),function(){r._onLoadFinished(t)});i.image=o;var s=e.scale.split(","),l=e.offset.split(",");i.repeat.fromArray([parseFloat(s[0]),parseFloat(s[1])]),i.offset.fromArray([parseFloat(l[0]),parseFloat(l[1])]),i.wrapS=r._getTextureWrapping(e.wrap_parameter_s),i.wrapT=r._getTextureWrapping(e.wrap_parameter_t),i.magFilter=r._getTextureFilter(e.filter_mode_mag),i.minFilter=r._getTextureFilter(e.filter_mode_min),i.setRotateAngle(e.rotation),i.needsUpdate=!0,r._onLoadFinished(t)},function(){n&&n()}),i}},{key:"_loadImage",value:function(e,t){var n=new Image;return n.onload=function(){var e=document.createElement("canvas");e.width=CLOUD.MaterialUtil.nextHighestPowerOfTwo(n.width),e.height=CLOUD.MaterialUtil.nextHighestPowerOfTwo(n.height),e.getContext("2d").drawImage(n,0,0,n.width,n.height,0,0,e.width,e.height),t()},n.onerror=function(e){console.log("Error: image is failed to loaded"),t()},n.src=e,n}},{key:"_getTextureFilter",value:function(e){switch(e){case"NEAREST":return THREE.NearestFilter;case"NEAREST_MIPMAP_NEAREST":return THREE.NearestMipMapNearestFilter;case"NEAREST_MIPMAP_LINEAR":return THREE.NearestMipMapLinearFilter;case"LINEAR":return THREE.LinearFilter;case"LINEAR_MIPMAP_NEAREST":return THREE.LinearMipMapNearestFilter;case"LINEAR_MIPMAP_LINEAR":return THREE.LinearMipMapLinearFilter
;default:return THREE.NearestFilter}}},{key:"_getTextureWrapping",value:function(e){switch(e){case"REPEAT":return THREE.RepeatWrapping;case"CLAMP":return THREE.ClampToEdgeWrapping;case"MIRROR":return THREE.MirroredRepeatWrapping;default:return THREE.RepeatWrapping}}},{key:"_onLoadFinished",value:function(e){++this.loadTaskCount>=this.maxLoadTask&&e&&e()}}]),e}();CLOUD.MaterialOverriderLoader=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.model=t.modelManager.getFirstModel(),this.model.registerPlugin(this),this.material=CLOUD.MaterialUtil.getDefaultStandardMaterial(),this.loader=new CLOUD.SegmentLoader(this),this.index=0,this.segmentIdMap={},this.segmentPathMap={},this.segmentIdArray=[],this.elementIdMap={},this.partialElementMap={},this.partialNodeInfoMapFromNodeId={},this.partialNodeIdMapFromSegmentId={},this.partialParentUserIdMapFromSegmentId={},this.partialNodeIdMapFromUserId={},this.geometryIdMapFromDataId={},this.dataBufferMapFromGeometryId={},this.geometryMapFromGeometryId={},this.meshNodeMapFromNodeId={},this.nodeIdMapOctantMap={},this.selectedNodeIdArray=[],this.hoveredNodeIdArray=[]}return _createClass(e,[{key:"destroy",value:function(){this.pickingNodeGenerator&&(this.pickingNodeGenerator.destroy(),this.pickingNodeGenerator=null),this.removeSegmentBufferByDataIds(Object.keys(this.geometryIdMapFromDataId)),this.destroyGeometries(),this.model=null,this.loader.destroy(),this.loader=null,this.material=null,this.segmentIdMap=null,this.segmentPathMap=null,this.segmentIdArray=null,this.elementIdMap=null,this.partialElementMap=null,this.partialNodeInfoMapFromNodeId=null,this.partialNodeIdMapFromSegmentId=null,this.partialParentUserIdMapFromSegmentId=null,this.partialNodeIdMapFromUserId=null,this.geometryIdMapFromDataId=null,this.dataBufferMapFromGeometryId=null,this.meshNodeMapFromNodeId=null,this.nodeIdMapOctantMap=null,this.selectedNodeIdArray=null,this.hoveredNodeIdArray=null,this.segmentIdMapFromPartialElementId&&(this.segmentIdMapFromPartialElementId=null),this.viewer=null}},{key:"removeFromSegmentIdMap",value:function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t],r=this.segmentIdMap[i];r&&(delete this.segmentIdMap[i],delete this.segmentPathMap[r][i],CLOUD.Utils.isOwnEmptyObject(this.segmentPathMap[r])&&delete this.segmentPathMap[r])}this.segmentIdArray=Object.keys(this.segmentIdMap)}},{key:"loadSegmentsByPaths",value:function(e,t){function n(e){var a=e;return function(){i.loadSegmentByTaskId(a,function(){a<r-1?requestAnimationFrame(n(a+1)):t&&t()})}}var i=this,r=e.length;requestAnimationFrame(n(0))}},{key:"loadSegmentByTaskId",value:function(e,t){var n=this.addedSegmentPaths[e];if(-1===n||"-1"===n)return void(t&&t());this.loader.load(n,function(){t&&t()})}},{key:"cacheSegmentBuffer",value:function(e,t,n){this.geometryIdMapFromDataId[e]||(this.geometryIdMapFromDataId[e]=[]);var i=e+"|"+t;this.geometryIdMapFromDataId[e].push(i),this.dataBufferMapFromGeometryId[i]=n}},{key:"removeSegmentBufferByDataIds",value:function(e){for(var t=0,n=e.length;t<n;t++){var i=CLOUD.Utils.getEncodedId(e[t]),r=this.geometryIdMapFromDataId[i];if(r){for(var a=0,o=r.length;a<o;a++){var s=r[a];this.disposeGeometryByGeometryId(s),delete this.dataBufferMapFromGeometryId[s]}delete this.geometryIdMapFromDataId[i]}}}},{key:"hasNodeInfoFromPartialNodeInfoMap",value:function(e){return!!this.partialNodeInfoMapFromNodeId[e]}},{key:"classifyNodeInfos",value:function(e){this.partialNodeInfoMapFromNodeId[e.nodeId]=e,this.partialNodeIdMapFromSegmentId[e.segmentId]||(this.partialNodeIdMapFromSegmentId[e.segmentId]=[]),this.partialNodeIdMapFromSegmentId[e.segmentId].push(e.nodeId),this.partialParentUserIdMapFromSegmentId[e.segmentId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId][e.userId]=!0,this.partialNodeIdMapFromUserId[e.userId]||(this.partialNodeIdMapFromUserId[e.userId]=[]),this.partialNodeIdMapFromUserId[e.userId].push(e.nodeId)}},{key:"getAllPartialSegmentIds",value:function(){return Object.keys(this.partialNodeIdMapFromSegmentId)}},{key:"getNodeIdsBySegmentId",value:function(e){return this.partialNodeIdMapFromSegmentId[e]}},{key:"getNodeInfoByNodeId",value:function(e){return this.partialNodeInfoMapFromNodeId[e]}},{key:"getNodeIdsByUserId",value:function(e){return this.partialNodeIdMapFromUserId[e]}},{key:"getNodeInfosBySegmentId",value:function(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var n=[],i=0,r=t.length;i<r;i++){var a=this.getNodeInfoByNodeId(t[i]);a&&n.push(a)}return n}},{key:"getNodeInfosBySegmentIds",value:function(e){var t,n,i=[],r=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),a=r.usedSegmentIds,o=r.notUsedSegmentIds;for(t=0,n=a.length;t<n;t++)i=i.concat(this.getNodeInfosBySegmentId(a[t]));for(t=0,n=o.length;t<n;t++)i=i.concat(this.getNodeInfosBySegmentId(o[t]));return i}},{key:"getMeshesNodeByNodeId",value:function(e){var t=this.getNodeInfoByNodeId(e);if(!t)return null;var n=this.getMeshNodesByNodeInfo(t);return n||null}},{key:"getMeshNodesByNodeInfo",value:function(e){if(this.meshNodeMapFromNodeId[e.nodeId])return this.meshNodeMapFromNodeId[e.nodeId];var t=this.getGeometriesByNodeInfo(e);if(!t)return null;for(var n=[],i=this.model.getMaterialByMaterialId(e.materialId)||this.material,r=0,a=t.length;r<a;r++){var o=new CLOUD.MeshEx(t[r],i);o.spawn({databagId:this.model.databagId,matrix:e.matrix}),o.name=e.userId,o._nodeId=e.nodeId,o._oriMaterial=i,n.push(o)}if(!e.boundingBox){e.boundingBox=new THREE.Box3;for(var s=0,l=n.length;s<l;s++)e.boundingBox.union(n[s].computeBoundingBox());e.matrix&&e.boundingBox.applyMatrix4(e.matrix)}return this.meshNodeMapFromNodeId[e.nodeId]=n,this.meshNodeMapFromNodeId[e.nodeId]}},{key:"getMeshNodesWithNotUsedSegment",value:function(e,t){for(var n=CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),i=[],r=0,a=t.length;r<a;r++){var o=this.getNodeIdsBySegmentId(t[r]);if(o)for(var s=0,l=o.length;s<l;s++){var u=this.getNodeInfoByNodeId(o[s]);u&&n[u.parentUserId]&&i.push(u)}}return this.getMeshNodesByNodeInfos(i)}},{key:"getMeshNodesByNodeInfos",value:function(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=this.getMeshNodesByNodeInfo(e[n]);if(r)for(var a=0,o=r.length;a<o;a++)t.push(r[a])}return t}},{key:"getMeshNodesBySegmentId",value:function(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var n=[],i=0,r=t.length;i<r;i++){var a=this.getMeshesNodeByNodeId(t[i]);if(a)for(var o=0,s=a.length;o<s;o++)n.push(a[o])}return n}},{key:"getMeshNodesBySegmentIds",value:function(e){for(var t=[],n=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),i=n.usedSegmentIds,r=n.notUsedSegmentIds,a=0,o=i.length;a<o;a++)t=t.concat(this.getMeshNodesBySegmentId(i[a]));return t=t.concat(this.getMeshNodesWithNotUsedSegment(i,r))}},{key:"getUserIdsBySegmentId",value:function(e){var t={},n={},i=this.getNodeIdsBySegmentId(e);if(i)for(var r=0,a=i.length;r<a;r++){var o=this.getNodeInfoByNodeId(i[r]);o&&(t[o.userId]=!0,n[o.parentUserId]=!0)}for(var s=this.elementIdMap[e],l=0,u=s.length;l<u;l++)n[s[l]]||(t[s[l]]=!0);return Object.keys(t)}},{key:"getUserIdsBySegmentIds",value:function(e){for(var t=[],n=0,i=e.length;n<i;n++)t=t.concat(this.getUserIdsBySegmentId(e[n]));return t}},{key:"getUserIdMapBySegmentIdAndParentUserId",value:function(e,t){return this.partialParentUserIdMapFromSegmentId[e]?this.partialParentUserIdMapFromSegmentId[e][t]:null}},{key:"getParentUserIdsBySegmentId",value:function(e){return this.partialParentUserIdMapFromSegmentId[e]?Object.keys(this.partialParentUserIdMapFromSegmentId[e]):[]}},{key:"getParentUserIdsBySegmentIds",value:function(e){for(var t=[],n=0,i=e.length;n<i;n++)t=t.concat(this.getParentUserIdsBySegmentId(e[n]));return t}},{key:"hasSegmentIdFromSegmentIdMap",value:function(e){return!!this.segmentIdMap[e]}},{key:"getGeometriesByNodeInfo",value:function(e){var t=e.geometryId;if(this.geometryMapFromGeometryId[t])return this.geometryMapFromGeometryId[t];var n=this.getGeometryDataBuffer(t),i=this._createBufferGeometry(e.type,n);return i?(i instanceof Array||(i=[i]),this.geometryMapFromGeometryId[t]=i,this.geometryMapFromGeometryId[t]):null}},{key:"_createBufferGeometry",value:function(e,t){var n=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,i=null;switch(e){case n.MESH:case n.MESH_REF:if(!t)return null;i=new THREE.BufferGeometry,i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N?i.addAttribute("normal",new THREE.BufferAttribute(t.N,3)):i.computeVertexNormals(),t.UV&&i.addAttribute("uv",new THREE.BufferAttribute(t.UV,2));break;case n.TUBE:case n.PIPE:i=CLOUD.GeomUtil.UnitCylinderInstance;break;case n.BOX:i=CLOUD.GeomUtil.UnitBoxInstance;break;case n.BOX_M:i=CLOUD.GeomUtil.getUnitTextureBox();break;case n.PIPE_M:i=CLOUD.GeomUtil.getUnitTextureCylinder();break;case n.LINE:if(!t)return null;i=new THREE.BufferGeometry,i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3))}return i}},{key:"_isParameterizedGeometry",value:function(e){var t=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType;return e===t.TUBE||e===t.PIPE||e===t.BOX||e===t.BOX_M||e===t.PIPE_M}},{key:"getGeometryDataBuffer",value:function(e){return this.dataBufferMapFromGeometryId[e]}},{key:"destroyGeometries",value:function(){for(var e=Object.keys(this.geometryMapFromGeometryId),t=0,n=e.length;t<n;t++)this.disposeGeometryByGeometryId(e[t]);this.disposeGeometryByGeometryId=null}},{key:"disposeGeometryByGeometryId",value:function(e){if(this.geometryMapFromGeometryId[e]){for(var t=this.geometryMapFromGeometryId[e],n=0,i=t.length;n<i;n++)t[n].dispose();delete this.geometryMapFromGeometryId[e]}}},{key:"getUsedAndNotUsedSegmentIdsBySegmentIds",value:function(e){var t,n,i={};for(t=0,n=e.length;t<n;t++)this.hasSegmentIdFromSegmentIdMap(e[t])&&(i[e[t]]=!0);var r=[],a=this.getAllPartialSegmentIds();for(t=0,n=a.length;t<n;t++)i[a[t]]||r.push(a[t]);return{usedSegmentIds:Object.keys(i),notUsedSegmentIds:r}}},{key:"getNotUsedPartialUserIds",value:function(e,t){for(var n=[],i=CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),r=CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(t)),a=Object.keys(r),o=[],s=0,l=a.length;s<l;s++){var u=a[s];i[u]&&o.push(u)}for(var c=0,h=o.length;c<h;c++)for(var d=0,f=t.length;d<f;d++){var p=this.getUserIdMapBySegmentIdAndParentUserId(t[d],o[c]);p&&(n=n.concat(Object.keys(p)))}return n}},{key:"updateNodeInfos",value:function(){var e=this,t=this.model;this.traversePartialElements(function(n,i,r){var a=e.getDescriptor().getNodeInfosByUserId(i);if(a)for(var o=0,s=a.length;o<s;o++){var l=a[o];if(!l.finalState&&(l.finalState=!0,l.nodeId=n+"|"+l.nodeId,!e.hasNodeInfoFromPartialNodeInfoMap(l.nodeId))){l.state=CLOUD.EnumObjectState.Visible,l.material=null,e._isParameterizedGeometry(l.type)?l.geometryId=l.geometryId:l.geometryId=n+"|"+l.geometryId,l.segmentId=""!==r.segmentId?r.segmentId:"unknown",l.parentUserId=r.parentUserId,l.single=!0,l.uv=!1;var u=t.getModelDescriptor().getNodeInfosByUserId(l.parentUserId);l.materialId=u?u[0].materialId:-1,l.cellId=u?u[0].cellId:0,l.userData=l.userData?l.userData:u?u[0].userData:null,l.isSegment=!0,e.classifyNodeInfos(l)}}}),this.initFilterManager()}},{key:"getNodeGroup",value:function(){return this.model._getNodeGroup("FlowSegments",{globalSpace:!0})}},{key:"updateMeshNodes",value:function(){this.clearAllMeshNodes();var e=this.segmentIdArray;if(this.applyReplacementBySegmentIds(e),0!==e.length){for(var t=this.getMeshNodesBySegmentIds(e),n=this.getNodeGroup(),i=0,r=t.length;i<r;i++)n.add(t[i]),this.addMeshToOctantMap(t[i]);n.updateMatrixWorld(!0)}}},{key:"addMeshToOctantMap",value:function(e){var t=this.model.manager,n=this.model.getEncodedDatabagId(),i=e._nodeId,r=this.getNodeInfoByNodeId(e._nodeId);t.addNodeInfoToOctantMap(n,r.cellId,r),t.addMeshToOctantMap(n,r.nodeId,new CLOUD.SingleCapsuleObject(r.nodeId,e)),this.nodeIdMapOctantMap[i]=!0}},{key:"clearMeshNodesFromOctantMap",value:function(){for(var e=this.model.manager,t=this.model.getEncodedDatabagId(),n=Object.keys(this.nodeIdMapOctantMap),i=0,r=n.length;i<r;i++)e.removeMeshFromOctantMap(t,this.getNodeInfoByNodeId(n[i]));this.nodeIdMapOctantMap={}}},{key:"clearAllMeshNodes",value:function(){this.getNodeGroup().clear(),this.clearMeshNodesFromOctantMap()}},{key:"removeFromMeshNodeMap",value:function(e){for(var t=0,n=e.length;t<n;t++){var i=this.getNodeIdsBySegmentId(e[t]);if(i)for(var r=0,a=i.length;r<a;r++){var o=i[r];this.disposeGeometryByGeometryId(this.getNodeInfoByNodeId(o).geometryId),delete this.meshNodeMapFromNodeId[o]}}}},{key:"applyReplacementBySegmentIds",value:function(e){if(!e||!e.length)return this.model.setReplacedUserIdMap(null),this.resetFilterState(),void this.model.applyReplacement();this.model.setReplacedUserIdMap(CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e))),this.model.applyReplacement()}},{key:"restoreComponentsState",value:function(){for(var e=this.getMeshNodesBySegmentIds(this.segmentIdArray),t=0,n=e.length;t<n;t++)e[t].material=e[t]._oriMaterial,e[t].visible=!0}},{key:"restoreMeshNodeMaterialByNodeIds",value:function(e){for(var t=0,n=e.length;t<n;t++){var i=this.getMeshesNodeByNodeId(e[t]);if(i)for(var r=0,a=i.length;r<a;r++)i[r].material=i[r]._oriMaterial}}},{key:"updateFilterManager",value:function(){this.model.getFilter().reinitFilterManager(this.model.manager.getNodeInfos())}},{key:"initFilterManager",value:function(){this.usedNodeInfos=this.getNodeInfosBySegmentIds(this.segmentIdArray),this.model.getModelDescriptor().addToNodeInfoMap(this.usedNodeInfos),this.updateFilterManager()}},{key:"deinitFilterManager",value:function(){this.usedNodeInfos&&this.model.getModelDescriptor().removeFromNodeInfoMap(this.usedNodeInfos),this.updateFilterManager()}},{key:"applyFilter",value:function(){for(var e=this.model.getFilter(),t=e._hasHiddenFileIdFilter(),n=e._hasVisibleFilter(),i=e._hasOverrideMaterialFilter(),r=e._hasTransparentFilter(),a=e._getMaterialByName("scene"),o=this.getMeshNodesBySegmentIds(this.segmentIdArray),s=0,l=o.length;s<l;s++){var u=o[s];u.visible=!0,u.material=u._oriMaterial;var c=this.getNodeInfoByNodeId(u._nodeId);if(t&&e._isHiddenFileId(c)||n&&!1===e._isVisible(c))u.visible=!1;else if(r&&e._isTransparent(c))u.material=a;else if(i&&e._hasOverrideMaterial(c)){var h=e._getOverrideMaterial(c);if(!h||""===h.name)continue;u.material=e._getMaterialByName(h.name)}else;}}},{key:"applySelection",value:function(){if(!CLOUD.GlobalData.PickingEffect){var e=this.model.manager.sceneState,t=this.model.selectedMaterial,n=e.getSelection();this.clearSelection();var i=this.selectedNodeIdArray;this.traverseMeshNodeMapByUserIds(n,function(e,n){for(var r=0,a=e.length;r<a;r++)e[r].material=t;i.push(n)})}}},{key:"clearSelection",value:function(){CLOUD.GlobalData.PickingEffect||this.selectedNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.selectedNodeIdArray),this.selectedNodeIdArray.length=0)}},{key:"applyHover",value:function(){var e=this.model.manager,t=e.sceneState;if(t.hoverId&&!t.isSelected(t.hoverId)){this.clearHover();var n=this.model.getFilter(),i=this.hoveredNodeIdArray;this.traverseMeshNodeMapByUserIds([t.hoverId],function(r,a,o){for(var s=0,l=r.length;s<l;s++){var u=r[s],c=e.getOverrideMaterialByNodeInfo(o)||n._getOverrideMaterial(o)||u._oriMaterial;u.material=t.getHoverMaterial(c)}i.push(a)})}}},{key:"clearHover",value:function(){this.hoveredNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.hoveredNodeIdArray),this.hoveredNodeIdArray.length=0)}},{key:"traverseMeshNodeMapByUserIds",value:function(e,t){for(var n=0,i=e.length;n<i;n++){var r=e[n],a=this.getNodeIdsByUserId(e[n]);if(a&&a.length)for(var o=0,s=a.length;o<s;o++){var l=a[o],u=this.getNodeInfoByNodeId(l),c=this.getMeshNodesByNodeInfo(u);c&&t(c,l,u,r)}}}},{key:"getSegmentIdsByPartialElementId",value:function(e){if(this.segmentIdMapFromPartialElementId)return this.segmentIdMapFromPartialElementId[e];var t=this.segmentIdMapFromPartialElementId={};return this.traversePartialElements(function(e,n,i){t[n]||(t[n]=[]),t[n].push(i.segmentId),t[i.parentUserId]||(t[i.parentUserId]=[]),t[i.parentUserId].push(i.segmentId)}),t[e]}},{key:"cachePartialElements",value:function(e,t){this.partialElementMap[e]||(this.partialElementMap[e]={}),this.partialElementMap[e][t.partialElementId]={userId:t.partialElementId,segmentId:t.segmentId,parentUserId:t.elementId}}},{key:"traversePartialElements",value:function(e){for(var t in this.partialElementMap)for(var n in this.partialElementMap[t])e(t,n,this.partialElementMap[t][n])}},{key:"getSegmentIsolateOption",value:function(){return e.IsolateOption}},{key:"getSegmentMetadata",value:function(e,t,n){this.loader._loadMetadata(e,t,n)}},{key:"resetFilterState",value:function(){var e=this.model.getFilter();e.showAll(),e.opaqueAll()}},{key:"unloadSegments",value:function(e){this.deinitFilterManager(),this.removeFromSegmentIdMap(e),this.removeFromMeshNodeMap(e),this.updateMeshNodes()}},{key:"loadSegments",value:function(e,t){if(e instanceof Array&&0!==e.length){this.elementIdMap={};for(var n={},i={},r=0,a=e.length;r<a;r++){var o,s=e[r].id;o=e[r].paths.length?e[r].paths[0].databag:-1,n[s]=o,i[o]||(i[o]={}),i[o][s]=!0,this.elementIdMap[s]=e[r].elementIds||[]}var l=CLOUD.Utils.getDifferentialIdxs(n,this.segmentIdMap);this.segmentIdMap=l.objCurrUsedIdxs,this.segmentIdArray=Object.keys(this.segmentIdMap);var u=CLOUD.Utils.getDifferentialIdxs(i,this.segmentPathMap);this.segmentPathMap=u.objCurrUsedIdxs,this.addedSegmentPaths=u.addIdxs;var c=!1;if(l.removeIdxs.length&&(c=!0,this.removeFromMeshNodeMap(l.removeIdxs)),u.removeIdxs.length&&(c=!0,this.removeSegmentBufferByDataIds(u.removeIdxs)),0===this.addedSegmentPaths.length)return void(c&&this.updateMeshNodes());this.applyReplacementBySegmentIds(null);var h=this;this.loadSegmentsByPaths(this.addedSegmentPaths,function(){h.updateNodeInfos(),h.updateMeshNodes(),t&&t()})}}},{key:"hideComponentsBySegment",value:function(e){var t=this.model.getFilter(),n=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),i=this.getUserIdsBySegmentIds(n.usedSegmentIds);t.hideByIds(i)}},{key:"showComponentsBySegment",value:function(e){var t=this.model.getFilter(),n=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),i=this.getUserIdsBySegmentIds(n.usedSegmentIds);t.showByIds(i)}},{key:"isolateComponentsBySegment",value:function(t,n){var i=this.model.getFilter(),r=this.getUsedAndNotUsedSegmentIdsBySegmentIds(t),a=this.getUserIdsBySegmentIds(r.usedSegmentIds),o=this.getNotUsedPartialUserIds(r.usedSegmentIds,r.notUsedSegmentIds);switch(this.restoreComponentsState(),n){case e.IsolateOption.HIDDEN:i.hideAll(),i.showByIds(a);break;case e.IsolateOption.TRANSLUCENT:i.showByIds(a),o.length&&i.showByIds(o),i.makeTranslucentOthersByIds([]),i.opaqueByIds(a);break;case e.IsolateOption.PARTLYTRANSLUCENT:i.hideAll(),i.showByIds(a),o.length&&(i.showByIds(o),i.makeTranslucentByIds(o))}}},{key:"disable",value:function(){this.getNodeGroup().visible=!1,this.applyReplacementBySegmentIds(null)}},{key:"enable",value:function(){this.getNodeGroup().visible=!0,this.applyReplacementBySegmentIds(this.segmentIdArray)}},{key:"getDescriptor",value:function(){return this.loader.descriptor}},{key:"getMeshesByUserIds",value:function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t],r=this.getNodeIdsByUserId(i);if(r&&r.length)for(var a=0,o=r.length;a<o;a++){var s=this.getNodeInfoByNodeId(r[a]);if(this.isPickableNode(s)){var l=this.getMeshNodesByNodeInfo(s);if(l)for(var u=0,c=l.length;u<c;u++)this.model.minDistanceObjects[i].push({mesh:l[u],matrix:s.matrix,boundingBox:s.boundingBox})}}}}},{key:"isPickableNode",value:function(e){var t=this.model.getFilter(),n=t._hasHiddenFileIdFilter(),i=t._hasVisibleFilter(),r=t._hasTransparentFilter();return!(n&&t._isHiddenFileId(e)||i&&!1===t._isVisible(e))&&(!r||!t._isTransparent(e))}},{key:"getPickingNodeGenerator",value:function(){return this.pickingNodeGenerator||(this.pickingNodeGenerator=new CLOUD.PickingSegmentMeshGenerator(this)),this.pickingNodeGenerator}}]),e}();e.IsolateOption=CLOUD.Utils.freezeObject({HIDDEN:0,TRANSLUCENT:1,PARTLYTRANSLUCENT:2}),CLOUD.SegmentManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.loader=new THREE.FileLoader,this.url=new CLOUD.Loader.Url({serverUrl:"",databagId:""}),this.currentTaskCount=0,this.maxTaskCount=0,this.mpkTaskManager=new CLOUD.TaskManager,this.databagId="",this.descriptor=new CLOUD.ModelView.DefaultDescriptor}return _createClass(e,[{key:"destroy",value:function(){this.model=null,this.loader=null,this.url=null,this.mpkTaskManager=null,this.descriptor.destroy(),this.descriptor=null}},{key:"load",value:function(e,t){var n=this;this.finishedCallback=t,this.databagId=e,this.url.databagPath=e,this.loader.setResponseType(""),this.loader.load(this.url.projectUrl(),function(e){var t;try{t=JSON.parse(e)}catch(e){return void console.log("Config data exceptions!")}var i=t.metadata,r=i.scenes?1:0;if(0===r)return void console.log("empty scene!");var a=i.mpks||0;if(0===a)return void console.log("empty mpk data!");var o=i.symbol?1:0,s=i.userdata?1:0,l=i.lines||0;n.maxTaskCount+=r,n.maxTaskCount+=o,n.maxTaskCount+=1,n.maxTaskCount+=s,n.maxTaskCount+=l,n.maxTaskCount+=a,n._loadScene(),o&&n._loadSymbol(),n._loadUserId(),s&&n._loadUserData(),l&&n._loadLine(),n._loadMpks(a)})}},{key:"_loadMetadata",value:function(e,t,n){var i=this,e=CLOUD.Utils.getEncodedId(e);this.loader.setResponseType(""),this.loader.load(t,function(t){for(var r=JSON.parse(t),a=r.partialElements,o=0,s=a.length;o<s;o++)i.model.cachePartialElements(e,a[o]);n&&n()},void 0,function(e){n&&n()})}},{key:"_loadScene",value:function(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.sceneUrl(0),function(t){e.descriptor.mapSceneReader[0]=new CLOUD.Loader.SceneReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadLine",value:function(){var e=this,t=CLOUD.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.lineUrl(),function(n){for(var i=new CLOUD.Loader.LineReader(n),r=0,a=i.header.lineCount;r<a;++r){var o=i.getPtBuffer(r),s=i.getIdxBuffer(r);if(void 0!=o&&void 0!=s){var l=i.getLineData(r);if(0===l.lineType){for(var u=[],c=1,h=s.length;c<h;c++)u.push(s[c-1]),u.push(s[c]);u.length&&(s=u)}e.model.cacheSegmentBuffer(t,"line-"+l.line_id,{P:o,I:s})}else CLOUD.Logger.log("Error Geometry!")}i=null,e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadSymbol",value:function(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.symbolUrl(),function(t){e.descriptor.symbolReader=new CLOUD.Loader.SymbolReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadUserId",value:function(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.userIdUrl(),function(t){e.descriptor.userIdReader=new CLOUD.Loader.IdReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadUserData",value:function(){var e=this;this.loader.setResponseType(""),this.loader.load(this.url.userDataUrl(),function(t){e.descriptor.userDataReader=new CLOUD.Loader.UserDataReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadMpks",value:function(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this.loadMpk.bind(this))}},{key:"loadMpk",value:function(e,t){var n=this,i=CLOUD.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.mpkUrl(e),function(e){for(var r=new CLOUD.Loader.MPKReader(e),a=r.header.meshCount,o=new THREE.Matrix4,s=0;s<a;++s){var l=r.getPtBuffer(s),u=r.getIdxBuffer(s);if(void 0!=l&&void 0!=u){var c=r.getNormalBuffer(s),h=r.getMeshData(s),d=r.getUVBuffer(s);0!==h.baseScale&&(l=new Float32Array(l),o.identity(),o.setPosition(new THREE.Vector3(h.baseX,h.baseY,h.baseZ)),o.scale(new THREE.Vector3(h.baseScale,h.baseScale,h.baseScale)),CLOUD.GeomUtil.applyMatrix4ToBuffer(o,l)),n.model.cacheSegmentBuffer(i,h.mesh_id,{P:l,I:u,N:c,UV:d})}else CLOUD.Logger.log("Error Geometry!")}r=null,t(),n._onTaskFinished()},void 0,function(e){n._onTaskFinished()})}},{key:"_onTaskFinished",value:function(){++this.currentTaskCount>=this.maxTaskCount&&(this.prepareData(),this.finishedCallback())}},{key:"prepareData",value:function(){this.descriptor.parseItemData()}}]),e}();CLOUD.SegmentLoader=e}();var Walkthrough=function(){function e(t){_classCallCheck(this,e),this.name=t||"",this.keyFrameList=[],this.walkthroughTime=5,this.interpolateType=0,this.fps=60,this.parts=100,this.rotateSpeed=Math.PI/this.fps/4,this.parameters={segments:this.walkthroughTime*this.fps*this.parts,closed:!1,curveType:"centripetal",tension:.25},this.modificationId=0,this.mapDeltaAngle={},this.mapDeltaOffset={},this.allocateSegmentList=null}return _createClass(e,[{key:"addKeyFrame",value:function(e){var t=new THREE.Vector3(e.position.x,e.position.y,e.position.z),n=new THREE.Vector3(e.target.x,e.target.y,e.target.z);this.keyFrameList.push({position:t,target:n,id:e.id,name:e.name}),this.modificationId++}},{key:"setKeyFrameList",value:function(e){this.keyFrameList=[];for(var t=0,n=e.length;t<n;t++)this.addKeyFrame(e[t])}},{key:"removeKeyFrame",value:function(e){var t=this.keyFrameList.length;e>=0&&e<t&&(this.keyFrameList.splice(e,1),this.modificationId++)}},{key:"getKeyFrames",value:function(){return this.keyFrameList}},{key:"getKeyFrameCount",value:function(){return this.keyFrameList.length}},{key:"clearFrames",value:function(){this.keyFrameList=[]}},{key:"getJumpCounts",value:function(e){var t=e/(1e3/this.fps)*this.parts;return t=parseInt(t)}},{key:"setWalkthroughTime",value:function(e){this.walkthroughTime=e,this.setSegments(e*this.fps*this.parts)}},{key:"setInterpolateType",value:function(e){this.interpolateType=e,1==e&&this.setSplineTension(0)}},{key:"getInterpolateType",value:function(){return this.interpolateType}},{key:"setName",value:function(e){this.name=e}},{key:"getName",value:function(){return this.name}},{key:"getKeyFramePositions",value:function(){for(var e=[],t=0,n=this.keyFrameList.length;t<n;t++){var i=this.keyFrameList[t];e.push(i.position)}return e}},{key:"getKeyFramePosition",value:function(e){return this.keyFrameList[e].position}},{key:"getKeyFrameDirection",value:function(e){var t=this.keyFrameList[e];return t.target.clone().sub(t.position)}},{key:"getKeyFrameTarget",value:function(e){return this.keyFrameList[e].target}},{key:"allocateSegments",value:function(){for(var e=[],t=0,n=this.keyFrameList.length;t<n-1;t++){var i=this.keyFrameList[t].position,r=this.keyFrameList[t+1].position;e.push(r.clone().sub(i).length())}for(var a=0,o=0,n=e.length;o<n;o++)a+=e[o];for(var s=this.getSegments(),l=0,n=e.length;0!=a&&l<n;l++)e[l]/=a,e[l]*=this.getSegments(),e[l]=Math.floor(e[l]),s-=e[l];for(var u=0;u<s;u++)e[u]>0&&e[u]++;this.allocateSegmentList=e}},{key:"getAllocateSegmentCount",value:function(e){return null==this.allocateSegmentList&&this.allocateSegments(),this.allocateSegmentList[e]}},{key:"getSplineParam",value:function(e,t){null==this.allocateSegmentList&&this.allocateSegments();var n=this.allocateSegmentList.length;return(e+t/this.allocateSegmentList[e])/n}},{key:"getDeltaAngle",value:function(e){return this.mapDeltaAngle[e]}},{key:"calculateDeltaAngle",value:function(){for(var e=this.allocateSegmentList,t=0;t<e.length;t++){var n=this.getKeyFrameDirection(t),i=this.getKeyFrameDirection(t+1),r=n.angleTo(i),a=e[t];if(0==a){var o=Math.floor(r/this.rotateSpeed)*this.parts;e[t]=o,this.mapDeltaAngle[t]=r/o}else this.mapDeltaAngle[t]=r/a}}},{key:"getRotateAxis",value:function(e){var t=this.getKeyFrameDirection(e),n=this.getKeyFrameDirection(e+1);return t.clone().cross(n.clone()).normalize()}},{key:"getDeltaOffset",value:function(e){return this.mapDeltaOffset[e]}},{key:"calculateDeltaOffset",value:function(){for(var e=this.allocateSegmentList,t=0;t<e.length;t++){var n=this.getKeyFramePositions(),i=n[t],r=n[t+1],a=this.allocateSegmentList[t];this.mapDeltaOffset[t]=0==a?new THREE.Vector3:r.clone().sub(i).divideScalar(a)}}},{key:"setSplineTension",value:function(e){e>=0&&e<=1&&(this.parameters.tension=e,this.modificationId++)}},{key:"setSegments",value:function(e){this.parameters.segments=e,this.modificationId++}},{key:"getSegments",value:function(){return this.parameters.segments}},{key:"setParameters",value:function(e){this.parameters=e,this.modificationId++}},{key:"getParameters",value:function(){return this.parameters}},{key:"setFps",value:function(e){this.fps=e,this.modificationId++}},{key:"getModificationId",value:function(){return this.modificationId}}]),e}();CLOUD.Walkthrough=Walkthrough;var WalkthroughPlayer=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.walkthrough=null,this.bPause=!1,this.bContinue=!1,this.bStop=!1,this.spline=null,this.reqid=0,this.playBinded=this.play.bind(this),this.recordId=-1,this.keyFrameIdx=0,this.count=-1,this.camera=this.viewer.cameraControl.camera,this.pausePlayCallback=null,this.stopPlayCallback=null,this.timeRecorder={last:0,pause:0,deltaTime:0},this.keyFrameCallback=null}return _createClass(e,[{key:"setWalkthrough",value:function(e){this.walkthrough=e,this.bPause=!1,this.recordId=-1,this.spline=null,this.keyFrameIdx=0,this.count=-1}},{key:"updateCamera",value:function(e,t){this.camera.position.add(e),this.camera.target.addVectors(this.camera.position,t)}},{key:"play",value:function(){this.reqid=requestAnimationFrame(this.playBinded),0==this.bContinue?(this.bContinue=!0,this.timeRecorder.deltaTime=this.timeRecorder.pause-this.timeRecorder.last):this.timeRecorder.deltaTime=performance.now()-this.timeRecorder.last,this.timeRecorder.last=performance.now();var e=this.walkthrough.getJumpCounts(this.timeRecorder.deltaTime);if(this.recordId!==this.walkthrough.getModificationId()&&(this.walkthrough.allocateSegments(),this.walkthrough.calculateDeltaOffset(),this.walkthrough.calculateDeltaAngle(),this.recordId=this.walkthrough.getModificationId()),this.bPause)return this.timeRecorder.pause=performance.now(),console.log("Walkthrough pause now,key frame index is "+this.keyFrameIdx),cancelAnimationFrame(this.reqid),this.pausePlayCallback&&this.pausePlayCallback(),this.bPause=!1,void(this.bContinue=!1);var t=this.walkthrough.getKeyFrameCount(),n=this.walkthrough.getAllocateSegmentCount(this.keyFrameIdx);if(0==n)this.keyFrameIdx++,this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=-1;else{if(this.bStop||this.keyFrameIdx==t-1)return void this.stop(!0);if(-1==this.count){this.timeStart=performance.now(),this.triggerKeyFrameCallback(this.keyFrameIdx);var i=this.walkthrough.getKeyFramePosition(this.keyFrameIdx),r=this.walkthrough.getKeyFrameTarget(this.keyFrameIdx);this.camera.position.copy(i),this.camera.target.copy(r),this.count=0}else if(this.count<n){this.count+e>n&&(e=n-this.count);var a=this.walkthrough.getDeltaOffset(this.keyFrameIdx),o=this.walkthrough.getDeltaAngle(this.keyFrameIdx),s=this.walkthrough.getRotateAxis(this.keyFrameIdx),l=new THREE.Vector3;l.subVectors(this.camera.target.clone(),this.camera.position),0==isNaN(s.length())&&l.applyAxisAngle(s,o*e),this.count+e==n?(this.keyFrameIdx++,this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=0):this.count+=e,this.updateCamera(a.clone().multiplyScalar(e),l)}}this.viewer.render()}},{key:"pause",value:function(){this.bPause=!0}},{key:"stop",value:function(e){e&&(this.bStop=!1,this.keyFrameIdx=0,this.count=-1,console.log("Time cost "+(performance.now()-this.timeStart)+"ms."),cancelAnimationFrame(this.reqid),this.stopPlayCallback&&this.stopPlayCallback())}},{key:"startFrom",value:function(e){for(var t=this.walkthrough,n=t.getKeyFrameCount(),i=t.getKeyFrames(),r=0;r<n;r++)if(i[r].id==e)return this.keyFrameIdx=r,void(this.count=-1)}},{
key:"setKeyFrameCallback",value:function(e){this.keyFrameCallback=e}},{key:"triggerKeyFrameCallback",value:function(e){this.keyFrameCallback&&this.keyFrameCallback(e)}},{key:"addPausePlayCallback",value:function(e){this.pausePlayCallback=e}},{key:"addStopPlayCallback",value:function(e){this.stopPlayCallback=e}},{key:"updataSpline",value:function(){var e=this.walkthrough.getKeyFramePositions(),t=this.walkthrough.getParameters();this.spline=new THREE.CatmullRomCurve3(e,t.closed,t.curveType,t.tension)}}]),e}();CLOUD.WalkthroughPlayer=WalkthroughPlayer;var WalkthroughManager=function(){function e(){_classCallCheck(this,e),this.walkthroughList=[]}return _createClass(e,[{key:"clear",value:function(){this.walkthroughList=[]}},{key:"add",value:function(e){this.walkthroughList.push(e)}},{key:"remove",value:function(e){for(var t=0,n=this.walkthroughList.length;t<n;t++){if(this.walkthroughList[t].getName()==e)return void this.walkthroughList.splice(t,1)}}},{key:"save",value:function(){return JSON.stringify(this.walkthroughList)}},{key:"load",value:function(e){this.clear();for(var t=JSON.parse(e),n=0,i=t.length;n<i;n++){var r=new CLOUD.Walkthrough;r.setName(t[n].name),r.setKeyFrameList(t[n].keyFrameList),r.setParameters(t[n].parameters),r.setWalkthroughTime(t[n].walkthroughTime),r.setInterpolateType(t[n].type),r.setFps(t[n].fps),this.add(r)}return this.walkthroughList}}]),e}();CLOUD.WalkthroughManager=WalkthroughManager,CLOUD.SceneStateHelper=function(e){this.selectionSet={},this.selectionMaterial=CLOUD.MaterialUtil.createHighlightMaterial(),this.selectionMaterial.colorState=CLOUD.EnumShaderColorState.SELECT,this.selectionMaterial.name="selection",this.selectionMaterial.refreshUniforms(),this.hoverId=void 0,this.hoverMaterialDefaultParams={color:14540253,opacity:.9,transparent:!0,side:THREE.DoubleSide},this.hoverMaterial=CLOUD.MaterialUtil.createStandardMaterial(this.hoverMaterialDefaultParams),this.hoverMaterial.name="hover",this.modelManager=e,this.blinkComponentIds={};var t=this;this.filter=e.getFilter(),this.filter.setObserverForSceneState(function(n,i){t.removeSelection(n,i),t.clearBlinkComponentsById(n,i),e.viewer.render()}),this.phongHoverMaterial=new THREE.MeshPhongMaterial(this.hoverMaterialDefaultParams),this.phongSelectionMaterial=new THREE.MeshPhongMaterial(CLOUD.GlobalData.SelectionColor)},CLOUD.SceneStateHelper.prototype={constructor:CLOUD.SceneStateHelper,destroy:function(){this.selectionSet=null,this.blinkComponentIds=null,this.modelManager=null,this.selectionMaterial.destroy(),this.selectionMaterial=null,this.hoverMaterial.destroy(),this.hoverMaterial=null,this.phongHoverMaterial.dispose(),this.phongHoverMaterial=null,this.phongSelectionMaterial.dispose(),this.phongSelectionMaterial=null},_dispatchChangeEvent:function(){var e=this.getSelection();this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_CHANGED,selectionList:e})},clearSelection:function(e){var t,n=!1;if(void 0===e){var i=[];for(var r in this.selectionSet){n=!1,t=this.getSelectionSet(r);for(var a in t)if(t.hasOwnProperty(a)){n=!0;break}n&&i.push(r)}if(i.length){for(var o=0,s=i.length;o<s;o++)this.selectionSet[i[o]]={},this.modelManager.clearSelection(i[o]);this._dispatchChangeEvent()}}else{t=this.getSelectionSet(e);for(var a in t)if(t.hasOwnProperty(a)){n=!0;break}n&&(this.selectionSet[e]={},this.modelManager.clearSelection(e),this._dispatchChangeEvent())}},addSelection:function(e,t){if(e&&!(e.length<1)){var n,i=[],r=!1,a=this.modelManager,o=this.filter;if(void 0===t){for(var s={},l=a.getModelIds(),u=[],c=0,h=l.length;c<h;c++){var d=l[c];n=this.getSelectionSet(d),r=!1;for(var f=e.length-1;f>=0;f--){var p=e[f];a.isUserIdExist(p,d)&&(!n[p]&&o.isComponentActive(p,d)&&(n[p]=!0,r=!0),s[p]=!0)}r&&u.push(d)}for(var f=e.length-1;f>=0;f--){var p=e[f];s[p]||i.push(p)}if(i.length>0&&a.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_FAILED,failedId:i}),u.length){for(var m=0,g=u.length;m<g;m++)this.modelManager.applySelection(u[m]);this._dispatchChangeEvent()}}else{n=this.getSelectionSet(t);for(var f=e.length-1;f>=0;f--){var p=e[f];a.isUserIdExist(p,t)?!n[p]&&o.isComponentActive(p,t)&&(n[p]=!0,r=!0):i.push(p)}i.length>0&&a.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_FAILED,failedId:i}),r&&(this.modelManager.applySelection(t),this._dispatchChangeEvent())}}},setSelection:function(e,t){if(e&&!(e.length<1))if(void 0===t){for(var n in this.selectionSet)delete this.selectionSet[n];this.addSelection(e)}else this.selectionSet[t]={},this.addSelection(e,t)},removeSelection:function(e,t){if(e&&!(e.length<1)){var n=!1;if(void 0===t){var i=[];for(var r in this.selectionSet){var a=this.getSelectionSet(r);n=!1;for(var o=0,s=e.length;o<s;++o){var l=e[o];a[l]&&(delete a[l],n=!0)}n&&i.push(r)}if(i.length){for(var o=0,s=i.length;o<s;o++)this.modelManager.applySelection(i[o]);this._dispatchChangeEvent()}}else{for(var a=this.getSelectionSet(t),o=0,s=e.length;o<s;++o){var l=e[o];a[l]&&(delete a[l],n=!0)}n&&(this.modelManager.applySelection(t),this._dispatchChangeEvent())}}},getSelection:function(e){var t={};if(void 0===e)for(var n in this.selectionSet)for(var i=this.getSelectionSet(n),r=Object.keys(i),a=0,o=r.length;a<o;a++)t[r[a]]=!0;else t=this.getSelectionSet(n);return Object.keys(t)},hasSelection:function(e){var t,n=!1;if(void 0===e)for(var i in this.selectionSet){t=this.getSelectionSet(i);for(var r in t)if(t.hasOwnProperty[r]){n=!0;break}if(n)break}else{t=this.getSelection(e);for(var r in t)if(t.hasOwnProperty[r]){n=!0;break}}return n},getSelectionSet:function(e){if(void 0===e){var t={};for(var n in this.selectionSet)for(var i=this.getSelectionSet(n),r=Object.keys(i),a=0,o=r.length;a<o;a++)t[r[a]]=!0;return t}return void 0===this.selectionSet[e]&&(this.selectionSet[e]={}),this.selectionSet[e]},isSelected:function(e,t){var n,i=!1;if(void 0===t){for(var r in this.selectionSet)if((n=this.selectionSet[r])&&n[e]){i=!0;break}}else(n=this.selectionSet[t])&&n[e]&&(i=!0);return i},setHoverId:function(e,t){this.hoverId=e,this.modelManager.applyHover(t)},clearHover:function(e){this.hoverId=void 0,this.modelManager.clearHover(e)},getHoverMaterial:function(e){var t=e&&e.isMeshPhongMaterial?this.phongHoverMaterial.clone():this.hoverMaterial.clone();if(e&&e.hasOwnProperty("color")){var n=e.color.clone(),i=Math.max(n.r,Math.max(n.g,n.b));0==i&&(i=.5),n.r+=0==n.r?.3*i:.2*n.r,n.g+=0==n.g?.3*i:.2*n.g,n.b+=0==n.b?.3*i:.2*n.b,n.r>1&&(n.r=1),n.g>1&&(n.g=1),n.b>1&&(n.b=1),1===n.r&&1===n.g&&1===n.b&&(n.r=.7,n.g=.7,n.b=.7),t.color.setHex(n.getHex()),void 0!==e.opacity?t.opacity=e.opacity:t.opacity=this.hoverMaterialDefaultParams.opacity,void 0!==e.transparent?t.transparent=e.transparent:t.transparent=this.hoverMaterialDefaultParams.transparent,void 0!==e.side?t.side=e.side:t.side=this.hoverMaterialDefaultParams.side,void 0!==e.metalness&&(t.metalness=e.metalness),void 0!==e.roughness&&(t.roughness=e.roughness),void 0!==e.bumpMap&&(t.bumpMap=e.bumpMap),void 0!==e.alphaMap&&(t.alphaMap=e.alphaMap),void 0!==e.emissiveMap&&(t.emissiveMap=e.emissiveMap),void 0!==e.envMap&&(t.envMap=e.envMap),void 0!==e.envMapIntensity&&(t.envMapIntensity=e.envMapIntensity),void 0!==e.map&&null!==e.map&&(t.map=e.map,t.opacity=CLOUD.MaterialUtil.getHoverOpacity(t.opacity)),t.needsUpdate=!0}return t},getHoverColorByMaterial:function(e){var t=void 0!==e.opacity?e.opacity:this.hoverMaterialDefaultParams.opacity,n=void 0!==e.transparent?e.transparent:this.hoverMaterialDefaultParams.transparent;if(void 0!==e.map&&null!==e.map&&(t=CLOUD.MaterialUtil.getHoverOpacity(t)),!e.hasOwnProperty("color"))return{rgbaColor:[this.hoverMaterial.color.r,this.hoverMaterial.color.g,this.hoverMaterial.color.b,t],transparent:n};var i=e.color.clone(),r=Math.max(i.r,Math.max(i.g,i.b));return 0==r&&(r=.5),i.r+=0==i.r?.3*r:.2*i.r,i.g+=0==i.g?.3*r:.2*i.g,i.b+=0==i.b?.3*r:.2*i.b,i.r>1&&(i.r=1),i.g>1&&(i.g=1),i.b>1&&(i.b=1),1===i.r&&1===i.g&&1===i.b&&(i.r=.7,i.g=.7,i.b=.7),{rgbaColor:[i.r,i.g,i.b,t],transparent:n}},setSelectionColor:function(e,t){var n=this.selectionMaterial.color,i=this.selectionMaterial.opacity;t=void 0==t?i:t,"0x"+n.getHexString()==e&&i==t||(this.selectionMaterial.color.setHex(e),t&&(this.selectionMaterial.opacity=t),this.selectionMaterial.needsUpdate=!0)},getSelectionMaterial:function(){return this.selectionMaterial.clone()},setBlinkComponentsById:function(e,t){if(this.blinkComponentIds={},e&&0!==e.length){for(var n=e.length-1;n>=0;n--){var i=e[n];this.filter.isComponentActive(i,t)&&(this.blinkComponentIds[e[n]]=!0)}this.modelManager.applyBlink()}},addBlinkComponentsById:function(e,t){if(e&&e.length){for(var n=this.blinkComponentIds,i=!1,r=e.length-1;r>=0;r--){var a=e[r];!n[a]&&this.filter.isComponentActive(a)&&(n[a]=!0,i=!0)}i&&this.modelManager.applyBlink()}},clearBlinkComponentsById:function(e,t){if(e&&e.length){for(var n=!1,i=this.blinkComponentIds,r=0,a=e.length;r<a;++r){var o=e[r];i[o]&&(delete i[o],n=!0)}n&&this.modelManager.applyBlink()}},clearAllBlinkComponents:function(){var e=!1,t=this.blinkComponentIds;CLOUD.Utils.isOwnEmptyObject(t)||(e=!0,this.blinkComponentIds={}),e&&this.modelManager.clearBlink()},getBlinkComponents:function(){return Object.keys(this.blinkComponentIds)},getBlinkComponentsIdMap:function(e){var t=this;if(this.modelManager.getBlinkEnabled()){if(e){var n=this.getBlinkComponents(),i={};return n.forEach(function(n){var r=t.modelManager.filterHelper.distributeId(n),a=r.modelId,o=r.objectId;a&&a.toString()!==e.toString()||(i[o]=t.blinkComponentIds[n])}),i}return this.blinkComponentIds}return null},getBlinkMaterial:function(e){return CLOUD.MaterialUtil.getBlinkMaterial(e,this.modelManager.getBlinkColor())}},CLOUD.Viewer=function(){this.domElement=null,this.camera=null,this.callbacks={},this.tmpBox=new THREE.Box3,this.enableCameraNearFar=!0,this.currentHomeView=CLOUD.EnumStandardView.ISO,this.initialView=CLOUD.EnumStandardView.ISO,this.modelManager=new CLOUD.ModelManager(this),this.editorManager=new CLOUD.EditorManager,this.isRecalculationPlanes=!1,this.calculationPlanesBind=this.calculationPlanes.bind(this),this.addRenderFinishedCallback(this.calculationPlanesBind),this.transitionAnimationState=!0,this.animator=new CLOUD.CameraAnimator,this.animator.setDuration(1e3),this.IBLManager=new CLOUD.IBLManager(this),this.rendererManager=new CLOUD.RendererManager(this),this.cameraStateWithFrustum=!1,this.filterHelper=this.modelManager.getFilterHelper()},CLOUD.Viewer.prototype={constructor:CLOUD.Viewer,addCallbacks:function(e,t){var n=this.callbacks[e];n||(n=[],this.callbacks[e]=n),-1===n.indexOf(t)&&n.push(t)},removeCallbacks:function(e,t){var n=this.callbacks[e];if(n){var i=n.indexOf(t);-1!==i&&n.splice(i,1)}},removeAllCallbacks:function(){for(var e in this.callbacks)for(var t=this.callbacks[e],n=0,i=t.length;n<i;n++)t.splice(0,1);for(var e in this.callbacks)delete this.callbacks[e];this.callbacks={}},onCallbacks:function(e){var t=this.callbacks[e];if(t)for(var n=0;n<t.length;n++)t[n]&&t[n]()},addRenderCallback:function(e){this.addCallbacks("render",e)},removeRenderCallback:function(e){this.removeCallbacks("render",e)},onRenderCallback:function(){this.onCallbacks("render")},addRenderFinishedCallback:function(e){this.addCallbacks("renderFinished",e)},removeRenderFinishedCallback:function(e){this.removeCallbacks("renderFinished",e)},onRenderFinishedCallback:function(){this.onCallbacks("renderFinished")},destroy:function(){this.removeAllCallbacks(),this.renderSettings.canvas=null,this.renderSettings.context=null,this.renderSettings=null,this.rendererManager.destroy(),this.rendererManager=null,this.cameraControl.destroy(),this.cameraControl=null,this.camera=null,this.defaultCamera=null,this.editorManager.destroy(),this.modelManager.destroy(),this.modelManager=null,this.editorManager=null,this.domElement=null,this.callbacks=null,this.tmpBox=null,this.calculationPlanesBind=null,this.animator=null,this.IBLManager=null},init:function(e){console.log("Web3D: "+CLOUD.Version),CLOUD.GlobalData.IsMobile=!this.isDesktop();var t=this,n=CLOUD.GlobalData.maxDrawCacheNum,i={alpha:!0,preserveDrawingBuffer:!0,antialias:!0,maxDrawCacheNum:n,stencil:!0,logarithmicDepthBuffer:!1};CLOUD.GlobalData.EnableLogarithmicDepthBuffer&&(i.logarithmicDepthBuffer=!0);var r;try{r=document.createElement("canvas");var a=r.getContext("webgl",i)||r.getContext("experimental-webgl",i);a||(i.antialias=!1),i.context=a}catch(e){return!1}this.domElement=e,CLOUD.GeomUtil.initializeUnitInstances(),i.canvas=r,this.renderSettings=i;var o=e.offsetWidth,s=e.offsetHeight,l={width:o,height:s,fov:45,near:.1,far:20*CLOUD.GlobalData.SceneSize};return this.camera=this.defaultCamera=new CLOUD.Camera(CLOUD.CAMERATYPE.PERSPECTIVE,l),this.cameraControl=new CLOUD.CameraControl(this,this.getScene(),this.camera,this.domElement,function(e){t.render(e)}),this.setEditorDefault(),this.modelManager.onUpdateViewer=function(){t.render(!0)},this.editorManager.registerDomEventListeners(this.domElement),!0},render:function(e){this.rendererManager.render(e)},resize:function(e,t){this.camera&&this.getRenderer()&&(this.camera.setSize(e,t),this.camera.updateProjectionMatrix(),this.rendererManager.setSize(e,t),this.modelManager.updateMaterialsValue("viewportSize",new THREE.Vector2(e,t)),this.onCallbacks("resize"),this.render())},resizeByFrustum:function(e,t){this.camera&&this.getRenderer()&&(this.camera.updateProjectionMatrixByFrustum=!0,this.camera.setSizeByFrustum(e,t),this.render(),this.camera.updateProjectionMatrixByFrustum=!1)},calculateNearFar:function(){var e=this.getScene(),t=e.getBoundingBoxWorld(),n=this.camera;if(null!=t){var i=this.tmpBox;if(i.copy(t),CLOUD.GlobalData.EnableGisMap){var r=e.calculateGisMapBox(n);i.union(r)}i.applyMatrix4(e.getMatrixGlobal());var a=i.getCenter(),o=n.position,s=o.clone().sub(a),l=s.length(),u=i.getSize().length();CLOUD.GlobalData.EnableGisMap&&void 0!=e.getObjectGroup(CLOUD.GlobalData.TileGlobalGroupName)&&(u/=2);var c,h;if(this.modelManager.containsCamera||!this.enableCameraNearFar)h=u,c=n.isPerspective?.1:-h;else{var d=.5*u;if(h=l+d,n.isPerspective){c=(l*l+.001*l)/16777.216,l<d?c=.1:c+d>l&&(c=l-d)}else c=-h}n.setNearFar(c,h)}},resetSelectionColor:function(e,t){this.modelManager.sceneState.setSelectionColor(e,t)},calculateMinDistance:function(e,t){function n(e,t,n,o,s,l){i.fromBufferAttribute(t,n),r.fromBufferAttribute(t,o),a.fromBufferAttribute(t,s),l&&(i.applyMatrix4(l),r.applyMatrix4(l),a.applyMatrix4(l)),e.push(i),e.push(r),e.push(a)}var i=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Vector3,o=this.modelManager.getMinDistanceObjects(e,t);if(!o)return-1;var s=[],l={start:null,end:null,minDistance:Number.POSITIVE_INFINITY};for(var u in o)s.push(o[u]);if(s[0].length<1||s[1].length<1)return-1;var c=s[0],h=s[1],d=c.length,f=h.length,p=null,m=Number.POSITIVE_INFINITY;if(d>1||f>1){p={};for(var g=0;g<d;g++)for(var v=c[g],y=0;y<f;y++){var E=h[y],b=function(e,t){for(var n=0,i=0,r=0;r<3;r++){var a=e.min.getComponent(r),o=e.max.getComponent(r),s=t.min.getComponent(r),l=t.max.getComponent(r),u=0;a>l?u=a-l:o<s&&(u=s-o),n+=u*u;var c=Math.max(l,o)-Math.min(a,s);i+=c*c}return{minDis:Math.sqrt(n),maxDis:Math.sqrt(i)}}(v.boundingBox,h[y].boundingBox);m=m<b.maxDis?m:b.maxDis,p[g+"_"+y]=b}}for(var g=0;g<d;g++)for(var v=c[g],y=0;y<f;y++){if(p){var x=p[g+"_"+y].minDis;if(x>m||x>l.minDistance)continue}var E=h[y],M=function(e,t,i){for(var r,a,o,s={start:null,end:null,minDistance:i},l=e.mesh,u=e.indexInfo,c=e.matrix,h=l.geometry,d=h.attributes.position,f=u?u.indexStart:0,p=h.getIndex().array,m=u?u.indexStart+u.indexCount:p.length,g=t.mesh,v=t.indexInfo,y=t.matrix,E=f,b=m;E<b;E+=3){r=p[E],a=p[E+1],o=p[E+2];var x=[];n(x,d,r,a,o,c);var M=CLOUD.Utils.minDistanceBetweenTriToMesh(x,g,v,y);M.minDistance<s.minDistance&&(s.minDistance=M.minDistance,s.start=M.start,s.end=M.end)}return s}(v,E,l.minDistance);if(M.minDistance<l.minDistance&&(l.minDistance=M.minDistance,l.start=M.start,l.end=M.end),0==l.minDistance)return l}return p=null,l},registerDomEventListeners:function(){this.domElement&&this.editorManager.registerDomEventListeners(this.domElement)},unregisterDomEventListeners:function(){this.domElement&&this.editorManager.unregisterDomEventListeners(this.domElement)},registerEventListener:function(e,t){this.modelManager.addEventListener(e,t)},unregisterEventListener:function(e,t){this.modelManager.removeEventListener(e,t)},load:function(e){var t=this,n=this.getModelManager();return console.time("loadedAndRendered"),n.load(e,function(){t.rendererManager.setupRenderer(t.renderSettings)},function(e){n.updateFilterManager(),n.getFilter().calculateVisibleComponentsBbox(),n.setDrawableModel(!0),console.time("Rendering: "),t.camera.dirty?t.render():(t.goToInitialView(),t.zoomAll()),console.timeEnd("Rendering: "),console.timeEnd("loadedAndRendered")})},unload:function(e){var t=this;this.getModelManager().unload(e,function(){t.zoomAll(),t.render()})},unloadAll:function(){this.getModelManager().unloadAll(),this.render()},showScene:function(e,t){var n=this;this.getModelManager().setModelVisibility(e,t,function(){n.render()})},clearAll:function(){this.getScene().clearAll()},restore:function(){this.getFilter().clear(),this.getScene().disableClipPlanes(),this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_VIEWER_RESTORED})},getScene:function(){return this.modelManager.scene},getCapsScene:function(){return this.modelManager.capsScene},getEditorManager:function(){return this.editorManager},getUserdataByUserId:function(e){var t=this.modelManager.getNodeInfosByUserId(e);return t&&t instanceof Array?t[0].userData:null},getFilter:function(){return this.modelManager.getFilter()},getCurrentEditorName:function(){return this.editorManager.getCurrentEditorName()},getCurrentEditor:function(){return this.editorManager.getCurrentEditor()},setEditorMode:function(e){this.editorManager.setEditorMode(this,e)},setEditorDefault:function(){this.setEditorMode(CLOUD.EditorMode.PICK)},setPickMode:function(){console.warn("CLOUD.Viewer.setPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.PICK)},setRectPickMode:function(){console.warn("CLOUD.Viewer.setRectPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.PICK_BY_RECT)},setOrbitMode:function(){console.warn("CLOUD.Viewer.setOrbitMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.ORBIT)},setZoomMode:function(){console.warn("CLOUD.Viewer.setZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.ZOOM)},setRectZoomMode:function(){console.warn("CLOUD.Viewer.setRectZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.ZOOM_BY_RECT)},setPanMode:function(){console.warn("CLOUD.Viewer.setPanMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.PAN)},setFlyMode:function(){console.warn("CLOUD.Viewer.setFlyMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.FLY)},setMeasureMode:function(){console.warn("CLOUD.Viewer.setMeasureMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.MEASURE)},setClipPlanesMode:function(){console.warn("CLOUD.Viewer.setClipPlanesMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.CLIP_BY_BOX)},getBoundingBoxWorld:function(){return this.getScene().getBoundingBoxWorld()},getBoundingBox:function(){return this.getScene().getBoundingBox()},zoomIn:function(e){void 0===e&&(e=.1),e<0&&(e=0),this.cameraControl.zoom(e)},zoomOut:function(e){void 0===e&&(e=.1),e>0?e*=-1:e=0,this.cameraControl.zoom(e)},zoomAll:function(e,t){var n=this.getScene().getBoundingBox();this._zoomToLocalBBox(n,e,t)},zoomToBuilding:function(e,t){this.zoomAll(e,t)},zoomToSelection:function(e,t,n){var i=this.getScene(),r=this.modelManager.sceneState,a=this.getBoundingBoxByIds(r.getSelectionSet());a.isEmpty()&&(a=i.getBoundingBox()),1==this.getTransitionAnimationState()?this.animator.setStandardView(void 0,this,a,e,void 0,"[object Function]"===Object.prototype.toString.call(n)?n:void 0):this._zoomToLocalBBox(a,e,t)},_zoomToLocalBBox:function(e,t,n,i){this.camera.zoomToBBox(e,t,n,i),this.cameraControl.update(!0,!0),this.cameraControl.dirtyCamera(!0)},zoomToBBox:function(e,t,n,i){var r=new THREE.Box3;e?(r.copy(e),r.applyMatrix4(this.getScene().getMatrixGlobal())):r.copy(this.getScene().getBoundingBox()),1==this.getTransitionAnimationState()?this.animator.setStandardView(void 0,this,r,t,void 0,"[object Function]"===Object.prototype.toString.call(i)?i:void 0):this._zoomToLocalBBox(r,t,n)},zoomToBBoxByDirection:function(e,t,n,i){if(!t)return void this.zoomToBBox(e,n,i);if(t&&e){var r=e.clone(),a=r.getCenter().clone().add(t);r.applyMatrix4(this.getScene().getMatrixGlobal()),a.applyMatrix4(this.getScene().getMatrixGlobal());var o=a.clone().sub(r.getCenter());o.length()>1e-4?(o.normalize(),viewer.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(r,n,i,o)):this._zoomToLocalBBox(r,n,i)}},zoomToBBoxWithOuterBox:function(e,t,n,i){if(!t)return void this.zoomToBBox(e,n,i);if(t&&e){var r=e.clone(),a=t.getCenter();r.applyMatrix4(this.getScene().getMatrixGlobal()),a.applyMatrix4(this.getScene().getMatrixGlobal());var o=a.clone().sub(r.getCenter());o.length()>1e-4?(o.normalize(),this.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(r,n,i,o)):this._zoomToLocalBBox(r,n,i)}},getObjectsInBox:function(e){var t=new THREE.Box3;return t.copy(e),t.applyMatrix4(this.getScene().getMatrixGlobal()),CLOUD.PickUtil.getObjectsInBox(this.getScene(),t,this.modelManager,this)},setStandardView:function(e,t,n,i){var r,a=this.camera;if(r=this.getScene().getBoundingBox(),this.transitionAnimationState)this.animator.setStandardView(e,this,r,t,n,i);else{a.setStandardView(e,r);this.camera.zoomToBBox(r,t);this.cameraControl.update(!0,!0),i&&i()}},getLineSelectRange:function(){return CLOUD.GlobalData.LineSelectRange},setLineSelectRange:function(e){CLOUD.GlobalData.LineSelectRange=e},_setStandardView:function(e,t){var n=this.camera,i=this.getScene().getBoundingBox();n.setStandardView(e,i),n.zoomToBBox(i,t)},setStandardViewWithBox:function(e,t,n,i){if(t?t.applyMatrix4(this.getScene().getMatrixGlobal()):t=this.getScene().getBoundingBox(),this.transitionAnimationState)this.animator.setStandardView(e,this,t,n);else{var r=this.camera;r.setStandardView(e,t),r.zoomToBBox(t,n,i),this.cameraControl.update(!0,!0)}},setTopView:function(e,t,n){this.setStandardViewWithBox(CLOUD.EnumStandardView.ISO,e,t,n)},setInitialViewType:function(e){console.warn("CLOUD.Viewer.setInitialViewType() has been deprecated. Use CLOUD.Viewer.setInitialView() instead."),this.setInitialView(e)},setInitialView:function(e){this.initialView=e,this._setStandardView(e)},goToInitialView:function(e){this.setStandardView(this.initialView,e,null)},setHomeViewType:function(e){console.warn("CLOUD.Viewer.setHomeViewType() has been deprecated. Use CLOUD.Viewer.setHomeView() instead."),this.setHomeView(e)},setHomeView:function(e){this.currentHomeView=e,this._setStandardView(e)},getHomeView:function(){return this.currentHomeView},goToHomeView:function(e){this.setStandardView(this.currentHomeView,e,null)},rotateByAxis:function(e,t,n){var i=2*Math.PI/60/60*e;if(t&&"x"!=t){if("y"!=t)return void console.warn("Illegal rotation axis for Viewer.rotateByAxis().");this.cameraControl.handleRotation(0,-i,n)}else this.cameraControl.handleRotation(-i,0,n);this.cameraControl.update(!0)},setImageResPath:function(e){CLOUD.GlobalData.TextureResRoot=e},setLightIntensityFactor:function(e){CLOUD.GlobalData.LightIntensityFactor=e},setLimitFrameTime:function(e){CLOUD.GlobalData.IncrementRender&&(e<=0&&(e=30),CLOUD.GlobalData.LimitFrameTime=e)},limitFrameRate:function(e){CLOUD.GlobalData.IncrementRender&&(e<=0&&(e=4),CLOUD.GlobalData.LimitFrameTime=1e3/e)},transformCamera:function(e){return CLOUD.CameraUtil.transformCamera(e,this.modelManager.scene)},getCamera:function(){var e=this.getScene(),t=e.getMatrixGlobal(),n=this.cameraControl.getCamera(),i=this.cameraControl.getCameraName(),r=new CLOUD.CameraInfo(i,n.position,n.target,n.realUp||n.up);if(r=CLOUD.Camera.drawingToWorld(r,t),this.cameraStateWithFrustum)var a=n.near*Math.tan(.5*THREE.Math.DEG2RAD*n.fov)/n.zoom,o=2*a,s=n.aspect*o;var l=new CLOUD.CameraInfo(i,r.position,r.target,r.up,n.fov,n.zoom,void 0,s,o);return JSON.stringify(l)},setCameraStateWithFrustum:function(e){this.cameraStateWithFrustum=e},setCamera:function(e,t,n){this.camera.dirty=!0;var i=this,r=CLOUD.CameraUtil.parseCameraInfo(e);if(null===r)console.log("Invalid camera info string. Fail to set camera.");else if(this.switchToCamera(r.name)){var a=this.getScene(),o=a.getMatrixGlobal(),s=CLOUD.Camera.worldToDrawing(r,o);if(s.name=r.name,s.zoom=r.zoom,this.transitionAnimationState){var l={position:this.camera.position.clone(),target:this.camera.target.clone(),up:this.camera.realUp.clone()||this.camera.up.clone(),zoom:this.camera.zoom};this.animator.active(l,s,this,function(e){i.cameraControl.update(!0,!0)},function(){r.frustumWidth&&r.frustumHeight&&i.resizeByFrustum(r.frustumWidth,r.frustumHeight),n&&n()})}else{"orth"===r.name&&i.camera.setZoom(r.zoom);var u=new THREE.Vector3;u.subVectors(s.target,s.position),this.camera.LookAt(s.target,u,s.up),t&&this.cameraControl.updateCamera(),r.frustumWidth&&r.frustumHeight&&(i.cameraControl.update(!0,!0),i.resizeByFrustum(r.frustumWidth,r.frustumHeight)),n&&n()}}},getRenderBufferScreenShot:function(e,t){var n=this.getRenderer().domElement,i=n.toDataURL("image/png"),r=n.width,a=n.height,o=window.devicePixelRatio||1,s=r/o,l=a/o;if(!s||!l)return t?(t(i),null):i;var u,c,h=0,d=0;if(s>l||r/a<s/l?(u=s,c=a/r*s,d=l/2-c/2):(c=l,u=r/a*l,h=s/2-u/2),t){var f=new Image;return f.onload=function(){var n=document.createElement("canvas"),i=n.getContext("2d");n.width=s,n.height=l,e&&(i.fillStyle=e,i.fillRect(0,0,s,l)),i.drawImage(f,h,d,u,c);var r=n.toDataURL("image/png");t(r)},f.src=i,null}var f=new Image;f.src=i;var p=document.createElement("canvas"),m=p.getContext("2d");return p.width=s,p.height=l,e&&(m.fillStyle=e,m.fillRect(0,0,s,l)),m.drawImage(f,h,d,u,c),p.toDataURL("image/png")},screenShot:function(e,t,n){var i=this,r=function(e,t,n){var r=i.getRenderer().domElement,a=r.toDataURL("image/png"),o=r.width,s=r.height,l=(window.devicePixelRatio,e),u=t;if(!l||!u)return n?(n(a),null):a;var c,h,d=0,f=0;if(l>u||o/s<l/u?(c=l,h=s/o*l,f=u/2-h/2):(h=u,c=o/s*u,d=l/2-c/2),n){var p=new Image;return p.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=l,e.height=u,t.drawImage(p,d,f,c,h);var i=e.toDataURL("image/png");n(i)},p.src=a,null}}(e,t,n);return this.render(),r},canvas2image:function(e,t){var n,i=this;return t?(this.getRenderBufferScreenShot(e,function(e){t(e),i.render()}),null):(n=this.getRenderBufferScreenShot(e),this.render(),n)},lockAxisZ:function(e,t){var n=this.cameraControl;if(n){var i=n.getZenith(),r=this.getBoundingBox().getCenter().clone();if(e&&void 0!==t||(t=null),t){var a=t[0],o=t[1];i>o?n.handleRotation(0,o-i,r):i<a&&n.handleRotation(0,a-i,r),this.render()}this.cameraControl.lockAxisZ(e),this.cameraControl.setLockAxisZRange(t)}},isLockedAxisZ:function(){return this.cameraControl.isLockedAxisZ()},enableTranslucentByDClick:function(e){CLOUD.GlobalData.EnableDemolishByDClick=e},enableHitDetection:function(e){CLOUD.GlobalData.EnableHitDetection=e},rotateCamera:function(e){this.cameraControl.processRotate(e),this.cameraControl.update()},setRotationCenter:function(e){this.rotationCenter=new THREE.Vector3(e.x,e.y,e.z)},clearRotationCenter:function(){this.rotationCenter=void 0},getRotationCenter:function(){return this.rotationCenter},getActiveCameraInfo:function(){var e={};e.up=new THREE.Vector3,e.dir=new THREE.Vector3;var t=this.camera,n=t.getWorldDirection();return e.up.copy(t.realUp||t.up),e.dir.copy(n),e},calculationPlanes:function(){if(this.isRecalculationPlanes){this.isRecalculationPlanes=!1;var e=this.getScene(),t=this.getBoundingBoxByIds();t.isEmpty()&&(t=e.getBoundingBox()),CLOUD.ClipPlaneManager.getInstance(e).calculationPlanes(t.getSize(),t.getCenter()),this.render()}},recalculationPlanes:function(){this.isRecalculationPlanes=!0},setOctantDepth:function(e){CLOUD.GlobalData.OctantDepth=e},resizePool:function(e){CLOUD.GlobalData.maxObjectNumInPool=e,this.modelManager.updateSceneRenderable(),this.render()},setCategoriesToHighPriority:function(e,t){var n=0==t?"inner":"outer";this.modelManager.setCategoriesToHighPriority(e,n)},clearCategoriesFromHighPriority:function(e){var t=0==e?"inner":"outer";this.modelManager.clearCategoriesFromHighPriority(t)},clearAllCategoriesFromHighPriority:function(){this.modelManager.clearAllCategoriesFromHighPriority()},isolate:function(e,t){this.getFilter().isolate(e,t)},setIsolateMaterial:function(e){this.getFilter().setIsolateMaterial(e)},resetIsolateMaterial:function(){this.getFilter().resetIsolateMaterial()},setOrbitButton:function(e){var t=this.editorManager._getEditorByName(this,CLOUD.EditorMode.ORBIT),n=this.editorManager._getEditorByName(this,CLOUD.EditorMode.PICK),i={};"left"===e?i={ORBIT:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT}:"right"===e&&(i={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT}),t&&t.updateButtons(i),n&&n.updateButtons(i)},showPickedInformation:function(e){CLOUD.UIHelper.showPickedInformation(e)},setOrbitEnabled:function(e){CLOUD.EditorConfig.NoRotate=!0!==e},getOrbitEnabled:function(){return!CLOUD.EditorConfig.NoRotate},setSelectPadCallback:function(e){var t=this.editorManager.getCurrentEditor();t&&t.selectPad&&(t.selectPad.callback=e)},setDeviceMobile:function(e){CLOUD.GlobalData.IsMobile=e||!1},setPointRotateMode:function(e){CLOUD.EditorConfig.RotatePivotMode=e},worldToDrawing:function(e){return this.cameraControl?this.getScene().worldToDrawing(e):(console.log("camera is not initialized!!!"),null)},drawingToWorld:function(e){return this.cameraControl?this.getScene().drawingToWorld(e):(console.log("camera is not initialized!!!"),null)},worldToCanvas:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var n=t.getContainerDimensions();if(!n)return null;var i=t.getCamera(),r=this.getScene(),a=r.worldToDrawing(e);return CLOUD.CameraUtil.drawingToCanvas(i,a,n.width,n.height)},canvasToWorld:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var n=t.getContainerDimensions();if(!n)return null;var i=t.getCamera(),r=this.getScene(),a=CLOUD.CameraUtil.canvasToDrawing(i,e,n.width,n.height),o=r.drawingToWorld(a);return{x:o.x,y:o.y,z:o.z}},worldToClient:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var n=t.getContainerDimensions();if(!n)return null;var i=t.getCamera(),r=this.getScene(),a=r.worldToDrawing(e),o=CLOUD.CameraUtil.drawingToCanvas(i,a,n.width,n.height);return o?(o.x+=n.left,o.y+=n.top,o):null},worldPointsToClient:function(e,t){var n=this.cameraControl;if(!n)return console.log("camera is not initialized!!!"),null;var i=n.getContainerDimensions();if(!i)return null;var r=n.getCamera(),a=this.getScene(),o=a.worldToDrawing(e),s=a.worldToDrawing(t),l=CLOUD.CameraUtil.drawingPointsToCanvas(r,o,s,i.width,i.height);return l?(l.start.x+=i.left,l.start.y+=i.top,l.end.x+=i.left,l.end.y+=i.top,l):null},clientToWorld:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var n=t.getContainerDimensions();if(!n)return null;var i={x:e.x,y:e.y,z:e.z};i.x-=n.left,i.y-=n.top;var r=t.getCamera(),a=this.getScene(),i=CLOUD.CameraUtil.canvasToDrawing(r,i,n.width,n.height),o=a.drawingToWorld(i);return{x:o.x,y:o.y,z:o.z}},insideCamera:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1
;var n=this.getScene(),i=n.worldToDrawing(e);return t.getFrustum().containsPoint(i)},locateToPointWithParallelEye:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var n=this.getScene(),i=n.worldToDrawing(e);t.flyToPointWithParallelEye(i)},locateToPoint:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var n=this.getScene(),i=n.worldToDrawing(e);t.flyToPoint(i)},enableHover:function(e){CLOUD.GlobalData.Hover=e},getObjectsByClientCoordinates:function(e){return new CLOUD.IntersectHelper(this).getObjectsByClientCoordinates(e)},getIBLManager:function(){return this.IBLManager},loadEnvMap:function(e){for(var t=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],n=[],i=0;i<6;++i)n.push("/"+e+"/"+t[i]);var r=this;(new THREE.HDRCubeTextureLoader).load(THREE.FloatType,n,function(e){r.environmentCubeMap=e,r.modelManager.updateMaterialsValue("envMap",e),r.setRenderStateChanged(!0),r.render()})},setEnvMapIntensity:function(e){this.modelManager.updateMaterialsValue("envMapIntensity",e),this.setRenderStateChanged(!0),this.render()},closeEnvMap:function(){this.modelManager.updateMaterialsValue("envMap",null),this.setRenderStateChanged(!0),this.render()},isSupportSSAO:function(){return!CLOUD.GlobalData.IncrementRender},isSSAOEnabled:function(){return CLOUD.GlobalData.SSAO},enableSSAO:function(e){return 0!=this.isSupportSSAO()&&(CLOUD.GlobalData.SSAO==e||(CLOUD.GlobalData.EnableRenderPass=e,CLOUD.GlobalData.SSAO=e,this.setRenderStateChanged(!0),this.render(),!0))},switchNewStyleMaterial:function(e){this.modelManager.switchNewStyleMaterial(e),this.setRenderStateChanged(!0),this.render()},enableColorWithoutLight:function(e){this.modelManager.enableColorWithoutLight(e),this.setRenderStateChanged(!0),this.render()},addPlane:function(e,t,n,i){var r=new THREE.Vector3;r.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),r.multiplyScalar(.5);var a=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(a,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(r),o.renderOrder=10,this.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.CUSTOMPLANE,{globalSpace:!0}).add(o),o.updateMatrixWorld(!0);var s=this,l=new THREE.TextureLoader;return l.setCrossOrigin("anonymous"),l.load(n,function(e){o.material.map=e,o.material.needsUpdate=!0,s.setRenderStateChanged(!0),i&&i()}),o},removePlane:function(e){var t=this.getScene(),n=t.getObjectGroup(CLOUD.ObjectGroupType.CUSTOMPLANE);n&&n.remove(e)},clearPlane:function(){var e=this.getScene(),t=e.getObjectGroup(CLOUD.ObjectGroupType.CUSTOMPLANE);t&&t.clear()},enableTextureMapping:function(e){CLOUD.GlobalData.EnableTextureMapping=e},enableLightmap:function(e){CLOUD.GlobalData.EnableLightmap!=e&&(CLOUD.GlobalData.EnableLightmap=e)},setLightmapIntensity:function(e){CLOUD.GlobalData.LightmapIntensity!=e&&(CLOUD.GlobalData.LightmapIntensity=e)},setReverseWheelDirection:function(e){CLOUD.EditorConfig.ReverseWheelDirection=!!e},getReverseWheelDirection:function(){return CLOUD.EditorConfig.ReverseWheelDirection},setMovementSpeedRate:function(e){void 0!==e&&(CLOUD.EditorConfig.MovementSpeedRate=e)},getMovementSpeedRate:function(){return CLOUD.EditorConfig.MovementSpeedRate},moveTo:function(e,t,n){var i=this.editorManager.editor;i&&i.moveTo(e,t,n)},rotateTo:function(e){var t=this.editorManager.editor;t&&t.rotateTo(e)},enableOcclusionTranslucent:function(e){CLOUD.GlobalData.OcclusionTranslucentEnabled=!!e},setOcclusionOpacity:function(e){CLOUD.GlobalData.OcclusionOpacity=e},setOcclusionDistanceToCamera:function(e){CLOUD.GlobalData.OcclusionDistanceToCamera=e},fitAndRotateBySelection:function(){this.cameraControl&&this.cameraControl.fitAndRotateBySelection()},setRoamingWalkHeight:function(e,t,n){if(!(e instanceof Array))return void console.log("elevations is not arry");var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),!1;if(t<=0&&(t=1750),void 0===n&&(n=!0),i.setCameraHeight(e,t),n){var r=this.editorManager.getCurrentEditor();r&&r.name===CLOUD.EditorMode.WALK&&r.update&&i.flyOnWorld()}},setRoamingWalkAbsoluteHeight:function(e,t){var n=this.cameraControl;if(!n)return console.log("camera is not initialized!!!"),!1;if(void 0===t&&(t=!0),n.setCameraAbsoluteHeight(e),t){var i=this.editorManager.getCurrentEditor();i&&i.name===CLOUD.EditorMode.WALK&&i.update&&n.flyOnWorld()}},cameraToWorld:function(e){return this.camera?CLOUD.Camera.drawingToWorld(e,this.getScene().getMatrixGlobal()):null},cameraToDrawing:function(e){return this.camera?CLOUD.Camera.worldToDrawing(e,this.getScene().getMatrixGlobal()):null},clearSelection:function(e){this.modelManager.sceneState.clearSelection(e)},addToSelection:function(e,t){var n=this,i=function(e,t){n.modelManager.sceneState.addSelection(t,e.id)};this.filterHelper.executeIds(e,i,t)},removeFromSelection:function(e,t){var n=this,i=function(e,t){n.modelManager.sceneState.removeSelection(t,e.id)};this.filterHelper.executeIds(e,i,t)},setSelection:function(e,t){var n=this,i=function(e,t){n.modelManager.sceneState.setSelection(t,e.id)};this.filterHelper.executeIds(e,i,t)},getSelection:function(e){return this.modelManager.sceneState.getSelection(e,e)},setSelectionColor:function(e){this.modelManager.sceneState.setSelectionColor(e)},pickByPoint:function(e){var t=this.cameraControl;if(!1===t.enabled)return!1;var n=new THREE.Vector2(e.x,e.y),i=t.getIntersectContext(n),r=t.intersector.pick(i),a=this.getScene();if(r){a.intersectToWorld(r,this);var o={};return o.faceIndex=r.faceIndex,o.meshId=r.userId,o.worldPosition=r.worldPosition,o.worldBoundingBox=r.worldBoundingBox,o}return null},pickByPointWithNormal:function(e){var t=this.getScene(),n=this.cameraControl;if(!1===n.enabled)return null;var i=new THREE.Vector2(e.x,e.y),r=n.getIntersectContext(i),a=n.intersector.pick(r);if(!a)return null;t.intersectToWorld(a,this),a.cx=i.x,a.cy=i.y;var o=[];o.push(a);var s=t.getMatrixGlobal(),l=a.face.normal.clone(),u=a.worldPosition.clone(),c=new THREE.Ray(u,l);c.applyMatrix4(s);var h=n.intersector.getIntersectByRay(r,c);return h&&(t.intersectToWorld(h,this),o.push(h)),o},toDefaultOrthographicCamera:function(e){this.switchToCamera("orth"),(e||void 0===e)&&this.render()},toDefaultPerspectiveCamera:function(e){this.switchToCamera("persp"),(e||void 0===e)&&this.render()},getCameraNameList:function(){return["pesp","orth"].concat(this.modelManager.getCameraNameList())},switchToCamera:function(e){var t=!0;if("persp"===e)this.camera=this.defaultCamera,this.camera.toPerspective();else if("orth"===e)this.camera=this.defaultCamera,this.camera.toOrthographic();else{var n=this.modelManager.getCamera(e);n?this.camera=n:(console.log("Fail to switch because not found camera '"+e+"'"),t=!1)}return t&&this.cameraControl.setCamera(this.camera),t},getNumOfElements:function(){return this.modelManager.getNumOfElements()},getNumOfRenderables:function(){return this.modelManager.getNumOfRenderables()},getNumOfTriangles:function(){return this.modelManager.getNumOfTriangles()},setLightPreset:function(e){CLOUD.GlobalData.LightPreset=e,this.getScene().lightPreset(),this.setRenderStateChanged(!0)},getLightPreset:function(){return CLOUD.GlobalData.LightPreset},setAmbientLightIntensity:function(e){var t=this.getScene().ambientLight;t&&(t.intensity=e,this.setRenderStateChanged(!0))},getAmbientLightIntensity:function(){var e=this.getScene().ambientLight;return e?e.intensity:void 0},setWalkHeightLocked:function(e){var t=this.editorManager.getCurrentEditor();t&&t.name===CLOUD.EditorMode.WALK&&t.setHeightLocked(e)},setWalkLookMousePressed:function(e){var t=this.editorManager.getCurrentEditor();t&&t.name===CLOUD.EditorMode.WALK&&t.setDragLook(e)},setWalkSpeedRate:function(e){var t=this.editorManager.getCurrentEditor();t&&t.name===CLOUD.EditorMode.WALK&&(CLOUD.EditorConfig.WalkSpeedRate=e)},getWalkSpeedRate:function(){return CLOUD.EditorConfig.WalkSpeedRate},setDrawingStyle:function(e){CLOUD.GlobalData.DrawingStyle=e,this.setRenderStateChanged(!0)},getWireframeColor:function(){var e=this.modelManager;for(var t in e.models){var n=e.models[t].wireframeManager;if(n)return n.getWireframeColor()}return CLOUD.MaterialUtil.DefaultWireframeColor},setWireframeColor:function(e){var t=this.modelManager;for(var n in t.models){var i=t.models[n].wireframeManager;i&&i.setWireframeColor(new THREE.Color(e.red/255,e.green/255,e.blue/255),e.alpha)}this.setRenderStateChanged(!0)},restoreWireframeColor:function(){var e=this.modelManager;for(var t in e.models){var n=e.models[t].wireframeManager;n&&n.restoreWireframeColor()}this.setRenderStateChanged(!0)},setInstanceMode:function(e){if(!CLOUD.GlobalData.Instance===e){if(CLOUD.GlobalData.Instance=e,e){var t=this.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0});t.visible=!0}else{var t=this.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0});t.visible=!1}this.setRenderStateChanged(!0)}},setTransitionAnimationState:function(e){this.transitionAnimationState=e},getTransitionAnimationState:function(){return this.transitionAnimationState},clipPoint:function(e){var t=this.getRenderer();if(!t)return!1;var n=t.clippingPlanes;if(n&&n.length>0)for(var i=0;i<n.length;++i){var r=n[i],a=r.normal;if(e.dot(a)<-r.constant)return!0}return!1},getExplosionExtent:function(){return this.modelManager.getExplosionExtent()},setExplosionExtent:function(e){CLOUD.GlobalData.EnableExplosion&&this.modelManager.setExplosionExtent(e)},setFloorExplosion:function(e,t){CLOUD.GlobalData.EnableExplosion&&this.modelManager.setFloorExplosion(e,t)},getFloorExplosionExtent:function(){return this.modelManager.floorExplosionExtent},getFloorExplosionList:function(){return this.modelManager.floorExplosionList},setFloorInfos:function(e){if(!this.modelManager.floorInfos){for(var t=0,n=e.length;t<n;t++)e[t].explodedHeight=e[t].elevation,e[t].preExplodedHeight=e[t].elevation;this.modelManager.floorInfos=e;var i=this.modelManager.scene.getBoundingBoxWorld();this.modelManager.totalHeight=i.getSize().z}},getFloorInfos:function(){return this.modelManager.getFloorInfos()},setExposureShift:function(e){CLOUD.GlobalData.ToneMapping=1;var t=e>0?-.4*e+.5:-4*e+.5;this.modelManager.updateMaterialsValue("shift",t),this.setRenderStateChanged(!0)},setRenderStateChanged:function(e){this.modelManager&&this.modelManager.setRenderStateChanged(e)},isDesktop:function(){return CLOUD.Utils.isDesktop()},getComponentInfoByUserId:function(e){return this.modelManager.getComponentInfoByUserId(e)},getBoundingBoxByIds:function(e){var t=this.modelManager.getBoundingBoxByIds(e);return t.isEmpty()||t.applyMatrix4(this.getScene().getMatrixGlobal()),t},convertAnnotationsToV3:function(e){return CLOUD.Compatibility.convertAnnotationsToV3(this,e)},loadMpkOnDemand:function(e,t,n){var i=this;this.modelManager.getLoadOnDemandDirector().loadMpkOnDemandByConditionsWithDelay(e,function(){i.getRenderer()&&i.getRenderer().clear(!0,!0,!0)},t,n)},getBoundingBoxOnDemand:function(){return this.modelManager.hasLoadOnDemandDirector()?this.modelManager.getLoadOnDemandDirector().getBoundingBoxOnDemand():null},setOutlineEdgeColor:function(e){this.composer&&this.composer.setOutlineEdgeColor(e)},createAreaInfo:function(e,t){var n=new CLOUD.AreaInfo(e);return n.checkRoomBoundary(t)?n:null},enableBlinkComponents:function(e){this.modelManager.isBlinkPermited()||(this.modelManager.enableBlink(e),this.render())},setBlinkComponentsById:function(e){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.setBlinkComponentsById(e)},addBlinkComponentsById:function(e){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.addBlinkComponentsById(e)},clearBlinkComponentsById:function(e){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.clearBlinkComponentsById(e)},clearAllBlinkComponents:function(){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.clearAllBlinkComponents()},getBlinkComponents:function(){return this.modelManager.isBlinkPermited()?null:this.modelManager.sceneState.getBlinkComponents()},setBlinkColor:function(e){this.modelManager.isBlinkPermited()||this.modelManager.setBlinkColor(e.color,e.opacity)},setBlinkIntervalTime:function(e){this.modelManager.isBlinkPermited()||this.modelManager.setBlinkIntervalTime(e)},enableSnap:function(e){this.editorManager.getToolByName("pickByRect").enableSnap(e)},pickToPoint:function(e,t){return this.editorManager.editor.pickHelper.pickToPoint(e,t)},getViewportSize:function(){return this.rendererManager.getRendererSize()},getRenderer:function(){return this.rendererManager.getRenderer()},getModelManager:function(){return this.modelManager},getReceivingPlane:function(){return this.getScene().getReceivingPlane()},enableShadow:function(e){var t=e?4:3;if(t!=CLOUD.GlobalData.LightPreset){this.getReceivingPlane(),this.setLightPreset(t);var n=this.getRenderer();n.shadowMap.enabled=e,n.shadowMap.type=THREE.PCFSoftShadowMap,n.shadowMap.autoUpdate=!1,n.shadowMap.renderSingleSided=!1,n.shadowMap.needsUpdate=!0;for(var i=this.getScene().getObjectGroups(),r=this.getScene(),a=0;a<i.length;a++){r.getObjectGroupType(i[a].name).groupType!=CLOUD.ObjectGroupType.IBLCUBE&&this.traverseGroupEnableShadow(i[a],e)}}},traverseGroupEnableShadow:function(e,t){var n=this;this.getRenderer();!function(e){if(e instanceof THREE.Mesh){var i=e.material;if(i instanceof Array){var r;if("PhoneLightingMaterial"==i[0].type)return;e.castShadow=t,e.receiveShadow=t;for(var a=0;a<i.length;a++)i[a].needsUpdate=!0,r=i[a].defines;t&&r&&r.hasOwnProperty("USE_INSTANCE")&&(e.customDepthMaterial=n.getInstanceDepthMaterial())}else{if("PhoneLightingMaterial"==i.type)return;e.castShadow=t,e.receiveShadow=t,i.needsUpdate=!0;var r=i.defines;t&&r&&r.hasOwnProperty("USE_INSTANCE")&&(e.customDepthMaterial=n.getInstanceDepthMaterial()),i.needsUpdate=!0}}}(e);for(var i=e.children,r=0,a=i.length;r<a;r++)this.traverseGroupEnableShadow(i[r],t)},getInstanceDepthMaterial:function(){if(this.instanceDepthMaterial)return this.instanceDepthMaterial;var e=new CLOUD.InstancedDepthMaterial;return e.depthPacking=THREE.RGBADepthPacking,this.instanceDepthMaterial=e,this.instanceDepthMaterial},updateShadowMap:function(){if(4==CLOUD.GlobalData.LightPreset){this.getRenderer().shadowMap.needsUpdate=!0}}},function(){function e(t,n,i){function r(o,s){if(!n[o]){if(!t[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var c=n[o]={exports:{}};t[o][0].call(c.exports,function(e){return r(t[o][1][e]||e)},c,c.exports,e,t,n,i)}return n[o].exports}for(var a="function"==typeof require&&require,o=0;o<i.length;o++)r(i[o]);return r}return e}()({1:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./BimCubeData"),r=e("./BimCubeView"),a=e("./BimCubeEditor"),o=function(){function e(e,t,n){this.callback=n,this.functionsUnexecuted=[];var o=this;this.bimCubeData=new i.BimCubeData(t,function(){o.bimCubeView=new r.BimCubeView(e,o.bimCubeData),o.bimCubeEditor=new a.BimCubeEditor(e,o.bimCubeData,o.bimCubeView),o.callback&&o.callback(),o.applyFunctionsUnexecuted()})}return e.prototype.applyFunctionsUnexecuted=function(){for(var e=this.functionsUnexecuted,t=0;t<e.length;t++){switch(e[t]){case"show":this.show();break;case"hide":this.hide()}}this.functionsUnexecuted=[]},e.prototype.switchCameraType=function(e){this.bimCubeView.switchCameraType(e)},e.prototype.addEventListener=function(e,t){this.bimCubeEditor.addEventListener(e,t)},e.prototype.show=function(){if(!this.bimCubeView)return void this.functionsUnexecuted.push("show");var e=this.bimCubeData.getScene();this.bimCubeView.setActiveScene(e),this.bimCubeView.render()},e.prototype.hide=function(){if(!this.bimCubeView)return void this.functionsUnexecuted.push("hide");var e=new THREE.Scene;this.bimCubeView.setActiveScene(e),this.bimCubeView.render()},e.prototype.update=function(e){this.bimCubeView.render(e)},e.prototype.destroy=function(){this.bimCubeData.destroy(),this.bimCubeData=null,this.bimCubeEditor.destroy(),this.bimCubeEditor=null,this.bimCubeView.destroy(),this.bimCubeView=null,this.callback=null,this.functionsUnexecuted=null},e}();n.BimCube=o,window.BimCube=o},{"./BimCubeData":2,"./BimCubeEditor":3,"./BimCubeView":4}],2:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./CubeEdge"),r=e("./CubeCorner"),a=e("./CubeFace"),o=function(){function e(e,t){this.languageType=e,this.initialize(),this.scene=new THREE.Scene,this.callback=t,this.buildEdges(),this.buildCorners(),this.buildFaces()}return e.prototype.initialize=function(){this.enumViewMode={2673:"Top",4015:"Bottom","0231":"Front",5764:"Back",1375:"Right",4620:"Left",3:"RoofSouthEast",2:"RoofSouthWest",7:"RoofNorthEast",6:"RoofNorthWest",1:"BottomSouthEast",0:"BottomSouthWest",4:"BottomNorthWest",5:"BottomNorthEast",32:"RoofFront",76:"RoofBack",37:"RoofRight",26:"RoofLeft","01":"BottomFront",45:"BottomBack",15:"BottomRight","04":"BottomLeft",13:"SouthEast",20:"SouthWest",57:"NorthEast",64:"NorthWest"},this.length=100,this.vertices=[],this.vertexIds=[],this.edgeIds=[],this.edgeIndices=[],this.faceIds=[],this.faceIndices=[],this.componentList=[],this.texturesLoaded=0;var e=this.length;this.vertices.push(new THREE.Vector3(-e/2,-e/2,e/2)),this.vertices.push(new THREE.Vector3(e/2,-e/2,e/2)),this.vertices.push(new THREE.Vector3(-e/2,e/2,e/2)),this.vertices.push(new THREE.Vector3(e/2,e/2,e/2)),this.vertices.push(new THREE.Vector3(-e/2,-e/2,-e/2)),this.vertices.push(new THREE.Vector3(e/2,-e/2,-e/2)),this.vertices.push(new THREE.Vector3(-e/2,e/2,-e/2)),this.vertices.push(new THREE.Vector3(e/2,e/2,-e/2));for(var t=0;t<8;t++)this.vertexIds.push(t+"");this.edgeIndices.push([0,1],[1,3],[3,2],[2,0]),this.edgeIndices.push([0,4],[1,5],[2,6],[3,7]),this.edgeIndices.push([4,5],[5,7],[7,6],[6,4]);for(var t=0;t<12;t++){var n=this.edgeIndices[t];this.edgeIds.push(n[0]+""+n[1])}this.faceIndices.push([0,2,3,1]),this.faceIndices.push([4,0,1,5]),this.faceIndices.push([4,6,2,0]),this.faceIndices.push([2,6,7,3]),this.faceIndices.push([1,3,7,5]),this.faceIndices.push([5,7,6,4]);for(var t=0;t<6;t++){var i=this.faceIndices[t];this.faceIds.push(i[0]+""+i[1]+i[2]+i[3])}},e.prototype.buildFaces=function(){for(var e=this.vertices,t=this.faceIndices,n=this.faceIds,i=this,r=0;r<6;r++)!function(r){var o=window.bimfaceStaticHost+"/textures/"+i.languageType+"/"+i.enumViewMode[n[r]]+".png",s=new THREE.TextureLoader;s.setCrossOrigin("anonymous");var l=i;s.load(o,function(i){var o=new a.CubeFace(e,t[r],n[r],i);l.componentList.push(o),l.scene.add(o.getMesh()),l.scene.add(o.getWireframe()),l.scene.add(o.getHighlightMesh()),6==++l.texturesLoaded&&l.callback&&l.callback()})}(r)},e.prototype.buildEdges=function(){for(var e=this.vertices,t=this.edgeIndices,n=this.edgeIds,r=0;r<12;r++){var a=new i.CubeEdge(e,t[r],n[r]);this.componentList.push(a),this.scene.add(a.getMesh()),this.scene.add(a.getWireframe()),this.scene.add(a.getHighlightWireframeMesh())}},e.prototype.buildCorners=function(){for(var e=this.vertices,t=this.vertexIds,n=0;n<8;n++){var i=new r.CubeCorner(e[n],t[n]);this.componentList.push(i),this.scene.add(i.getMesh()),this.scene.add(i.getWireframe()),this.scene.add(i.getCornerFace()),this.scene.add(i.getCornerWireframe())}},e.prototype.getComponent=function(e){for(var t=0;t<this.componentList.length;t++){var n=this.componentList[t];if(n.getId()==e)return n}return null},e.prototype.transparentCorners=function(){},e.prototype.opaqueCorners=function(){},e.prototype.getScene=function(){return this.scene},e.prototype.getMeshes=function(){for(var e=[],t=this.scene.children,n=0;n<t.length;n++){var i=t[n];"Mesh"===i.type&&!0!==i.isHighlightMesh&&e.push(i)}return e},e.prototype.destroy=function(){this.scene=null,this.vertices=null,this.vertexIds=null,this.edgeIds=null,this.edgeIndices=null,this.faceIds=null,this.faceIndices=null,this.componentList=null,this.enumViewMode=null},e}();n.BimCubeData=o},{"./CubeCorner":6,"./CubeEdge":7,"./CubeFace":8}],3:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./EventManager"),r=function(){function e(e,t,n){this.eventManager=new i.EventManager,this.container=e,this.bimCubeData=t,this.bimCubeView=n,this.initialize()}return e.prototype.initialize=function(){this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this);var e=this.container;e.addEventListener("mousemove",this.onMouseMoveBinded,!1),e.addEventListener("mousedown",this.onMouseDownBinded,!1),this.raycaster=new THREE.Raycaster,this.lastHoverComponentId=null,this.bMouseDown=!1,this.mouseDownPos=null,this.doubleClickFlag=!1},e.prototype.onMouseDown=function(e){this.bMouseDown=!0,this.mouseDownPos=new THREE.Vector2(e.offsetX,e.offsetY),window.addEventListener("mouseup",this.onMouseUpBinded,!1)},e.prototype.onMouseMove=function(e){if(!this.bMouseDown){var t={x:e.offsetX,y:e.offsetY},n=this.canvasToNormalized(t),i=this.hitTest(n),r=this.lastHoverComponentId;if(i){if(i!=this.lastHoverComponentId){var a=this.bimCubeData.getComponent(i);a.highlight(),this.bimCubeView.render(),this.lastHoverComponentId=i}}else this.lastHoverComponentId=null;if(r&&i!=r){var a=this.bimCubeData.getComponent(r);a.cancelHighlight(),this.bimCubeView.render()}}},e.prototype.onMouseUp=function(e){if(window.removeEventListener("mouseup",this.onMouseUpBinded),0!=this.bMouseDown){var t=this;if(0!=this.doubleClickFlag)return void(this.bMouseDown=!1);this.doubleClickFlag=!0,setTimeout(function(){t.doubleClickFlag=!1},1e3),this.bMouseDown=!1;var n=new THREE.Vector2(e.offsetX,e.offsetY);if(n.x==this.mouseDownPos.x&&n.y==this.mouseDownPos.y){var r={x:e.offsetX,y:e.offsetY},a=this.canvasToNormalized(r),o=this.hitTest(a);if(o){if(this.lastHoverComponentId){this.bimCubeData.getComponent(this.lastHoverComponentId).cancelHighlight(),this.lastHoverComponentId=null,this.bimCubeView.render()}var s=i.EventManager.enumTypes,l={type:s.ON_COMPONENT_CLICK,componentId:o,viewType:this.bimCubeData.enumViewMode[o]};this.eventManager.dispatchEvent(l)}}}},e.prototype.canvasToNormalized=function(e){var t=this.container.offsetWidth,n=this.container.offsetHeight,i={x:0,y:0};return i.x=e.x/t*2-1,i.y=-e.y/n*2+1,i},e.prototype.hitTest=function(e){var t=this.bimCubeView.getActiveCamera();this.raycaster.setFromCamera(e,t);var n=this.bimCubeData.getMeshes(),i=this.raycaster.intersectObjects(n,!0);if(0!=i.length){var r=i[0].object.componentId;if(i.length>=2){var a=i[1].object.componentId;4==r.length&&2==a.length&&i[1].distance<i[0].distance+5&&(r=a)}return r}},e.prototype.addEventListener=function(e,t){this.eventManager.addEventListener(e,t)},e.prototype.destroy=function(){window.removeEventListener("mouseup",this.onMouseUpBinded),this.container.removeEventListener("mousemove",this.onMouseMoveBinded),this.container.removeEventListener("mousedown",this.onMouseDownBinded),this.container=null,this.eventManager=null,this.bimCubeData=null,this.bimCubeView=null,this.onMouseDownBinded=null,this.onMouseUpBinded=null,this.onMouseMoveBinded=null,this.raycaster=null,this.lastHoverComponentId=null,this.mouseDownPos=null},e}();n.BimCubeEditor=r},{"./EventManager":9}],4:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){this.container=e,this.bimCubeData=t,this.activeCamera=new THREE.OrthographicCamera(-110,110,110,-110,-110,110),this.activeScene,this.initialize()}return e.prototype.initialize=function(){this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.container.appendChild(this.renderer.domElement);var e,t;"none"==this.container.style.display?(e=this.container.style.width.replace("px",""),t=this.container.style.height.replace("px","")):(e=this.container.offsetWidth,t=this.container.offsetHeight),this.renderer.setSize(e,t)},e.prototype.switchCameraType=function(e){},e.prototype.getActiveCamera=function(){return this.activeCamera},e.prototype.setActiveScene=function(e){this.activeScene=e},e.prototype.render=function(e){e&&(this.activeCamera.up.copy(e.up),this.activeCamera.lookAt(e.dir),this.activeCamera.updateMatrixWorld());var t=this.activeScene||this.bimCubeData.getScene();this.renderer.autoClear=!0,this.renderer.render(t,this.activeCamera)},e.prototype.destroy=function(){this.container.removeChild(this.renderer.domElement),this.container=null,this.renderer.dispose(),this.renderer=null,this.activeScene=null,this.bimCubeData=null,this.activeCamera=null},e.enumTypes={PERSPECTIVE:1e3,ORTHOGRAPHIC:1001},e}();n.BimCubeView=i},{}],5:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this.faceDefaultColor=14936556,this.wireframeDefaultColor=13421772,this.faceHighlightColor=12255212,this.wireframeHighlightColor=3330982}return e.prototype.createMesh=function(e){var t=new THREE.Geometry;t.vertices=e;for(var n=e.length-2,i=1;i<=n;i++){var r=new THREE.Face3(0,i,i+1);t.faces.push(r)}var a=new THREE.MeshBasicMaterial({color:this.faceDefaultColor,side:THREE.DoubleSide}),o=new THREE.Mesh(t,a);return o.componentId=this.componentId,o},e.prototype.createWireframe=function(e){for(var t=new THREE.LineGeometry,n=[],i=0;i<e.length;i++){var r=e[i];n.push(r.x,r.y,r.z)}t.setPositions(n);var a=new THREE.LineMaterial({color:this.wireframeDefaultColor,linewidth:1});a.resolution.set(160,160);var o=new THREE.Line2(t,a);return o.componentId=this.componentId,o},e.prototype.getMesh=function(){return this.mesh},e.prototype.getWireframe=function(){return this.wireframeMesh},e.prototype.transparent=function(e){e.material&&(e.material.transparent=!0,e.material.opacity=0)},e.prototype.opaque=function(e){e.material&&(e.material.transparent=!1,e.material.opacity=1)},e.prototype.getId=function(){return this.componentId},e}();n.CubeComponent=i},{}],6:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./CubeComponent"),a=function(e){function t(t,n){var i=e.call(this)||this;return i.length=20,i.vertex=t,i.cornerFace=null,i.cornerWireframe=null,i.componentId=n,i.cornerVertices=null,i.build(),i}return i(t,e),t.prototype.build=function(){var e=[],t=this.vertex.clone(),n=t.clone().multiplyScalar(-1);e.push(t);var i=this.vertex.clone(),r=n.x>0?this.length:-this.length;i.x+=r,e.push(i);var a=this.vertex.clone(),o=n.y>0?this.length:-this.length;a.y+=o,e.push(a);var s=this.vertex.clone(),l=n.z>0?this.length:-this.length;s.z+=l,e.push(s),this.cornerVertices=e,this.mesh=this.createMesh([i,a,s]),this.wireframeMesh=this.createWireframe([i,a,s,i]),this.buildCornerFace(),this.buildCornerWireframe()},t.prototype.highlight=function(){this.wireframeMesh.material.color.setHex(this.wireframeHighlightColor),this.wireframeMesh.renderOrder=100,this.mesh.material.color.setHex(this.faceHighlightColor),this.cornerFace.material.color.setHex(this.faceHighlightColor),this.cornerFace.material.transparent=!0,this.cornerFace.material.opacity=.5,this.cornerWireframe.material.color.setHex(this.wireframeHighlightColor),this.cornerWireframe.visible=!0},t.prototype.cancelHighlight=function(){this.wireframeMesh.material.color.setHex(this.wireframeDefaultColor),this.wireframeMesh.renderOrder=0,this.mesh.material.color.setHex(this.faceDefaultColor),this.transparent(this.cornerFace),this.cornerWireframe.visible=!1},t.prototype.buildCornerFace=function(){if(!this.cornerFace){var e=this.cornerVertices;e.push(e[1]),this.cornerFace=this.createMesh(e),this.transparent(this.cornerFace)}},t.prototype.getCornerFace=function(){return this.cornerFace},t.prototype.getCornerWireframe=function(){return this.cornerWireframe},t.prototype.buildCornerWireframe=function(){if(!this.cornerWireframe){for(var e=[],t=1;t<this.cornerVertices.length;t++){var n=this.cornerVertices[0],i=this.cornerVertices[t];e.push(n,i)}this.cornerWireframe=this.createWireframe(e),this.cornerWireframe.visible=!1}},t}(r.CubeComponent);n.CubeCorner=a},{"./CubeComponent":5}],7:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./CubeComponent"),a=function(e){function t(t,n,i){var r=e.call(this)||this;return r.highlightWidth=3,r.width=15,r.vertices=t,r.indices=n,r.componentId=i,r.highlightWireframeMesh=null,r.testWireframe=null,r.build(),r}return i(t,e),t.prototype.build=function(){var e=this.indices[0],t=this.indices[1],n=this.vertices[e],i=this.vertices[t],r=n.clone().add(i).multiplyScalar(.5),a=r.clone().multiplyScalar(-1),o=a.clone().normalize(),s=[],l=i.clone().sub(n).normalize(),u=n.clone().add(l.clone().multiplyScalar(20)),c=n.clone().add(l.clone().multiplyScalar(80)),h=[];if(0!==a.x){var d=a.x>0?this.width:-this.width;h.push((new THREE.Vector3).setX(d).add(o))}if(0!==a.y){var f=a.y>0?this.width:-this.width;h.push((new THREE.Vector3).setY(f).add(o))}if(0!==a.z){var p=a.z>0?this.width:-this.width;h.push((new THREE.Vector3).setZ(p).add(o))}2===h.length&&(s.push(u.clone().add(o)),s.push(u.clone().add(h[0])),s.push(c.clone().add(h[0])),s.push(c.clone().add(o)),s.push(c.clone().add(h[1])),s.push(u.clone().add(h[1]))),this.mesh=this.createMesh(s),this.transparent(this.mesh),this.wireframeMesh=this.createWireframe([u,c]),this.highlightWireframeMesh=this.createHighlightWireframe([u.sub(o),c.sub(o)])},t.prototype.createHighlightWireframe=function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n];t.push(i.x,i.y,i.z)}var r=new THREE.LineGeometry;r.setPositions(t);var a=new THREE.LineMaterial({color:this.wireframeHighlightColor,linewidth:this.highlightWidth,dashed:!1});a.resolution.set(160,160);var o=new THREE.Line2(r,a);return o.computeLineDistances(),o.scale.set(1,1,1),o.visible=!1,o.renderOrder=100,o},t.prototype.getTestWireframe=function(){return this.testWireframe},t.prototype.getHighlightWireframeMesh=function(){return this.highlightWireframeMesh},t.prototype.highlight=function(){this.highlightWireframeMesh.visible=!0,this.highlightWireframeMesh.renderOrder=100},t.prototype.cancelHighlight=function(){this.highlightWireframeMesh.visible=!1},t}(r.CubeComponent);n.CubeEdge=a},{"./CubeComponent":5}],8:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./CubeComponent"),a=function(e){function t(t,n,i,r){var a=e.call(this)||this;return a.length=60,a.vertices=t,a.indices=n,a.componentId=i,a.vertexUvs=null,a.texture=r,a.highlightMesh=null,a.wireframeMesh=null,a.vertexUvs=[],a.vertexUvs.push(new THREE.Vector2(0,.2)),a.vertexUvs.push(new THREE.Vector2(0,.8)),a.vertexUvs.push(new THREE.Vector2(.2,1)),a.vertexUvs.push(new THREE.Vector2(.8,1)),a.vertexUvs.push(new THREE.Vector2(1,.8)),a.vertexUvs.push(new THREE.Vector2(1,.2)),a.vertexUvs.push(new THREE.Vector2(.8,0)),a.vertexUvs.push(new THREE.Vector2(.2,0)),a.build(),a}return i(t,e),t.prototype.build=function(){for(var e=[],t=null,n=null,i=0,r=this.indices.length;i<r;i++){var a=this.indices[i],o=this.indices[i+1]
;t=this.vertices[a],n=this.vertices[o],i===r-1&&(n=this.vertices[this.indices[0]]);var s=n.clone().sub(t).normalize(),l=t.clone().add(n).multiplyScalar(.5);e.push(l.clone().sub(s.clone().multiplyScalar(this.length/2))),e.push(l.clone().add(s.clone().multiplyScalar(this.length/2)))}this.createTexturedMesh(e);for(var u=new THREE.Box3,c=0;c<this.indices.length;c++){var h=this.indices[c];u.expandByPoint(this.vertices[h])}for(var d=u.getCenter().normalize(),f=[],p=0;p<e.length;p++){var m=e[p];f.push(m.clone().add(d))}this.highlightMesh=this.createMesh(f),this.highlightMesh.visible=!1,this.highlightMesh.isHighlightMesh=!0,f.push(f[0]),this.wireframeMesh=this.createWireframe(f)},t.prototype.highlight=function(){this.highlightMesh.visible=!0,this.highlightMesh.material.color.setHex(this.faceHighlightColor),this.highlightMesh.material.transparent=!0,this.highlightMesh.material.opacity=.5,this.wireframeMesh.material.color.setHex(this.wireframeHighlightColor)},t.prototype.cancelHighlight=function(){this.highlightMesh.visible=!1,this.wireframeMesh.material.color.setHex(this.wireframeDefaultColor)},t.prototype.createTexturedMesh=function(e){var t=new THREE.Geometry;t.vertices=e;for(var n=e.length-2,i=1;i<=n;i++){var r=new THREE.Face3(0,i,i+1);t.faces.push(r)}for(var a=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!1}),o=this.vertexUvs,s=0;s<t.faces.length;s++){var r=t.faces[s];t.faceVertexUvs[0].push([o[r.a],o[r.b],o[r.c]])}t.uvsNeedUpdate=!0,this.mesh=new THREE.Mesh(t,a),this.mesh.componentId=this.componentId},t.prototype.getHighlightMesh=function(){return this.highlightMesh},t.prototype.buildVertexUvs=function(e){for(var t=[],n=(new THREE.Box3).setFromPoints(e),i=n.min,r=n.getSize(),a=0==r.x?"x":0==r.y?"y":"z",o=0;o<e.length;o++){var s=e[o],l=(r.x+r.y+r.z)/2,u=s.clone().sub(i).multiplyScalar(1/l),c=new THREE.Vector2(u.x,u.y);"x"==a?c=new THREE.Vector2(u.y,u.z):"y"==a&&(c=new THREE.Vector2(u.x,u.z)),t.push(c)}return t},t}(r.CubeComponent);n.CubeFace=a},{"./CubeComponent":5}],9:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this.eventDispatcher=new THREE.EventDispatcher}return e.prototype.addEventListener=function(e,t){this.eventDispatcher.addEventListener(e,t)},e.prototype.hasEventListener=function(e){this.eventDispatcher.hasEventListener(e)},e.prototype.removeEventListener=function(e,t){this.eventDispatcher.removeEventListener(e,t)},e.prototype.dispatchEvent=function(e){this.eventDispatcher.dispatchEvent(e)},e.enumTypes={ON_COMPONENT_HOVER:1e3,ON_COMPONENT_CLICK:1001},e}();n.EventManager=i},{}]},{},[1]),function(){function e(t,n,i){function r(o,s){if(!n[o]){if(!t[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var c=n[o]={exports:{}};t[o][0].call(c.exports,function(e){return r(t[o][1][e]||e)},c,c.exports,e,t,n,i)}return n[o].exports}for(var a="function"==typeof require&&require,o=0;o<i.length;o++)r(i[o]);return r}return e}()({1:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){}return e.prototype.cross=function(e,t,n,i){return(t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x)},e.prototype.getArea=function(e,t,n){return this.cross(e,t,e,n)},e.prototype.getAbsArea=function(e,t,n){return Math.abs(this.getArea(e,t,n))},e.prototype.getInterPoint=function(e,t,n,i){var r=this.getAbsArea(e,t,n),a=this.getAbsArea(e,t,i);return new THREE.Vector2((i.x*r+n.x*a)/(r+a),(i.y*r+n.y*a)/(r+a))},e.prototype.isAngleGreaterThanPi=function(e,t,n){var i=new THREE.Vector3;return i.crossVectors(e,t),!(i.dot(n)>=0)},e.prototype.normalizedPointToScreen=function(e,t){e.x=e.x*t.width,e.y=-e.y*t.height},e.prototype.screenToNormalizedPoint=function(e,t){e.x=e.x/t.width,e.y=-e.y/t.height},e.prototype.normalizedPointToWorld=function(e,t){var n=t.getSize();e.x=.5*(e.x+1)*n.x+t.min.x,e.y=.5*(e.y+1)*n.y+t.min.y},e.prototype.worldToNormalizedPoint=function(e,t){var n=t.getSize();e.x=(e.x-t.min.x)/n.x*2-1,e.y=(e.y-t.min.y)/n.y*2-1},e.prototype.toWorldPoint=function(e,t,n,i){e.x<0&&(e.x=0),e.x>t&&(e.x=t),e.y<0&&(e.y=0),e.y>n&&(e.y=n),e.x=e.x/t*2-1,e.y=-e.y/n*2+1,this.normalizedPointToWorld(e,i)},e.prototype.getCuttingBoxOnCanvas=function(e,t,n,i){var r=new THREE.Box3,a=new THREE.Vector2(e.x,e.y),o=new THREE.Vector2(t.x,t.y);this.toWorldPoint(a,n[0],n[1],i),this.toWorldPoint(o,n[0],n[1],i);var s=[];return s.push(new THREE.Vector3(a.x,a.y)),s.push(new THREE.Vector3(a.x,a.y)),s.push(new THREE.Vector3(a.x,o.y)),s.push(new THREE.Vector3(a.x,o.y)),s.push(new THREE.Vector3(o.x,o.y)),s.push(new THREE.Vector3(o.x,o.y)),s.push(new THREE.Vector3(o.x,a.y)),s.push(new THREE.Vector3(o.x,a.y)),r.setFromPoints(s),{min:{x:r.min.x,y:r.min.y,z:0},max:{x:r.max.x,y:r.max.y,z:0}}},e.prototype.canvasPointToClient=function(e,t){var n=t.mapContainer;if(!n||!t.floorPlaneBox)return null;var i=this.getContainerOffsetToClient(n);if(0===i.width||0===i.height)return null;var r=new THREE.Vector2;return r.x=e.x+i.left,r.y=e.y+i.top,r},e.prototype.getMainSceneMatrix=function(e){return e.getScene().getMatrixGlobal()},e.prototype.transformWorldPoint=function(e,t){var n=this.getMainSceneMatrix(e);t.applyMatrix4(n)},e.prototype.expandBbox=function(e,t){var n=e.getCenter(),i=e.getSize(),r=new THREE.Vector2,a=t,o=i.x/i.y,s=i.x,l=i.y;o>a?l=s/a:o<a&&(s=l*a),r.set(s,l),e.setFromCenterAndSize(n,r)},e.prototype.containsPointInMainScene=function(e,t){var n=e.getScene().getBoundingBoxWorld();return!!n&&n.containsPoint(t)},e.prototype.isMouseOverCanvas=function(e,t,n){if(e){var i=this.getContainerOffsetToClient(e),r=new THREE.Vector2;if(r.x=n.x-i.left,r.y=n.y-i.top,0===i.width||0===i.height)return!1;var a={width:t[0],height:t[0]};if(r.x>0&&r.x<a.width&&r.y>0&&r.y<a.height)return!0}return!1},e.prototype.normalizePoint=function(e,t,n){var i=new THREE.Vector2;if(e){var r=this.getContainerOffsetToClient(e),a=new THREE.Vector2;a.x=n.x-r.left,a.y=n.y-r.top;var o={width:t[0],height:t[1]};if(a.x>0&&a.x<o.width&&a.y>0&&a.y<o.height)return i.x=a.x/o.width*2-1,i.y=-a.y/o.height*2+1,new THREE.Vector2(i.x,i.y)}return null},e.getIntersectionByPoint=function(e,t,n){void 0===n&&(n=3);for(var i=null,r=n*n,a=0,o=e.length;a<o;a++){var s=e[a].intersectionPoint;if(s){if(s.distanceToSquared(t)<r){i=e[a];break}}}return i},e.prototype.flyToPointWithParallelEye=function(e,t){e.cameraControl.flyToPointWithParallelEye(t)},e.prototype.getIntersectionToMinDistance=function(e,t){if(e.length<1)return null;for(var n=0,i=0,r=0,a=e.length;r<a;r++){var o=e[r];if(o.intersectionPoint){var s=new THREE.Vector2(o.intersectionPoint.x,o.intersectionPoint.y),l=s.distanceToSquared(t);0==n?n=l:n>l&&(n=l,i=r)}}return e[i]},e.prototype.getAxisGridInfoByNormalizedPoint=function(e,t){var n=t.clone(),i=e.naviData.getAxisGridBox2D();this.normalizedPointToWorld(n,i);var r=t.clone(),a={width:e.svgHalfWidth,height:e.svgHalfHeight};this.normalizedPointToScreen(r,a);var o=this.getIntersectionToMinDistance(e.naviData.getAxisGridIntersectionPoints(),r);if(o&&o.intersectionPoint){var s=new THREE.Vector2(o.intersectionPoint.x,o.intersectionPoint.y);this.screenToNormalizedPoint(s,a),this.normalizedPointToWorld(s,i);var l=Math.round(n.x-s.x),u=Math.round(n.y-s.y);return{position:n,abcName:o.abcName,numeralName:o.numeralName,offsetX:l,offsetY:u}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}},e.prototype.getAxisGridInfoByPoint=function(e,t){var n=this.getMainSceneMatrix(e.viewer),i=new THREE.Matrix4;i.getInverse(n);var r=t.clone();r.applyMatrix4(i);var a=r.clone(),o={width:e.svgHalfWidth,height:e.svgHalfHeight},s=e.naviData.getAxisGridBox2D();this.worldToNormalizedPoint(a,s),this.normalizedPointToScreen(a,o);var l=this.getIntersectionToMinDistance(e.naviData.getAxisGridIntersectionPoints(),a);if(l&&l.intersectionPoint){var u=new THREE.Vector2(l.intersectionPoint.x,l.intersectionPoint.y);this.screenToNormalizedPoint(u,o),this.normalizedPointToWorld(u,s);var c=Math.round(r.x-u.x),h=Math.round(r.y-u.y);return{position:r,abcName:l.abcName,numeralName:l.numeralName,offsetX:c,offsetY:h}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}},e.prototype.calculateEdgePositionCameraOutBounds=function(e,t,n){var i=function(e,t){for(var n=!1,i=0,r=e.length;i<r;i++)if(this.isEqualBetweenPoints(t,e[i],this.epsilon)){n=!0;break}return n},r=n.clone();if(r.min.x-=.5,r.min.y-=.5,r.max.x+=.5,r.max.y+=.5,!r.containsPoint(e)){var a=[],o=new THREE.Vector3(e.x,e.y,0),s=new THREE.Ray(o,t),l=new THREE.Vector3(n.min.x,n.min.y,0),u=new THREE.Vector3(-1,0,0),c=new THREE.Plane;c.setFromNormalAndCoplanarPoint(u,l);var h=s.intersectPlane(c);if(h&&r.containsPoint(h)&&a.push(h),l.set(n.max.x,n.max.y,0),u.set(-1,0,0),c.setFromNormalAndCoplanarPoint(u,l),h=s.intersectPlane(c),h&&r.containsPoint(h)&&a.push(h),l.set(n.min.x,n.min.y,0),u.set(0,1,0),c.setFromNormalAndCoplanarPoint(u,l),h=s.intersectPlane(c),h&&r.containsPoint(h)&&(i(h,a)||a.push(h)),l.set(n.max.x,n.max.y,0),u.set(0,1,0),c.setFromNormalAndCoplanarPoint(u,l),h=s.intersectPlane(c),h&&r.containsPoint(h)&&(i(h,a)||a.push(h)),2!=a.length)return null;var d=a[0],f=a[1],p=f.clone().sub(d).normalize();return this.isEqualBetweenPoints(p,t,1e-5)?a[0]:a[1]}return null},e.prototype.getContainerOffsetToClient=function(e){var t,n=function(e){for(var t=0,n=0;e;)t+=e.offsetTop,n+=e.offsetLeft,e=e.offsetParent;var i=document.body,r=document.documentElement,a=window.pageYOffset||r.scrollTop||i.scrollTop,o=window.pageXOffset||r.scrollLeft||i.scrollLeft;return t-=a,n-=o,{top:t,left:n}},i=function(e){var t=e.getBoundingClientRect(),n=document.body,i=document.documentElement,r=i.clientTop||n.clientTop,a=i.clientLeft||n.clientLeft,o=t.top-r,s=t.left-a;return{top:Math.round(o),left:Math.round(s)}};if(e!=document){var r=function(e){return e.getBoundingClientRect?i(e):n(e)}(e);t={width:e.offsetWidth,height:e.offsetHeight,left:r.left,top:r.top}}else t={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return t},e.prototype.isEqualBetweenPoints=function(e,t,n){n=n||1e-4;var i=e.x-t.x,r=e.y-t.y;return!(Math.sqrt(i*i+r*r)>n)},e}();n.Algorithm=i},{}],2:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e){this.resourceGrids=e,this.floorPlaneBox=new THREE.Box2}return e.prototype.get=function(){return this.resourceGrids},e}();n.AxisGrids=i},{}],3:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e){this.resourcePlanes=e}return e.prototype.find=function(e){for(var t=0;t<this.resourcePlanes.length;t++){var n=this.resourcePlanes[t];if(n.id==e)return n}},e.prototype.getFloorPlaneBox=function(e){var t=this.find(e);return t.boundingBox||t.BoundingBox},e.prototype.getUrl=function(e){var t=this.find(e);return t.path||t.Path},e.prototype.getElevation=function(e){return this.find(e).Elevation},e.prototype.getName=function(e){var t=this.find(e);return t.name||t.Name},e}();n.FloorPlanes=i},{}],4:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e){this.resourceLevels=e,this.elevations=[],this.offsetForPlane=235,this.createElevationsInOrder()}return e.prototype.createElevationsInOrder=function(){var e=this.resourceLevels;for(var t in e)void 0!=e[t].elevation&&this.elevations.push(e[t].elevation);var n=function(e,t){return e-t};this.elevations.sort(n)},e.prototype.getMinMaxElevations=function(e){var t=[0,0],n=this.resourceLevels;for(var i in n)if(n[i].name==e){t[0]=n[i].elevation-this.offsetForPlane;break}for(var r=0;r<this.elevations.length;r++)if(this.elevations[r]>t[0]+this.offsetForPlane){t[1]=this.elevations[r],t[1]-=this.offsetForPlane;break}return t},e.prototype.getElevation=function(e){for(var t=this.resourceLevels,n=0;n<t.length;n++){var i=t[n];if(i.id==e)return i.elevation}},e.prototype.getElevationsInOrder=function(){return this.elevations},e.prototype.getLevelIdByElevation=function(e){for(var t=this.resourceLevels,n=0;n<t.length;n++){var i=t[n];if(i.elevation==e)return i.id}},e}();n.Levels=i},{}],5:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=e("../Algorithm"),o=e("./GridLine"),s=e("./AxisNotation"),l=function(e){function t(t,n,i,r){var o=e.call(this)||this;return o.intersections=[],o.lineElements=[],o.horizLineElements=[],o.verticalLineElements=[],o.width=n[0],o.height=n[1],o.bIsShowAxisGrid=i,o.multiplyZoomFactor=r,o.algorithm=new a.Algorithm,o.materialGrid=new THREE.LineBasicMaterial({color:10066329,linewidth:.5}),o.children=[],o.resourceGrids=t,o.boundingBox=new THREE.Box2,o.realBoundingBox=new THREE.Box2,o.clipBox2D=new THREE.Box2(new THREE.Vector2(-o.width/2,-o.height/2),new THREE.Vector2(o.width/2,o.height/2)),o.axisGridNumberInterval=3,o.isValid()&&(o.calculateIntersections(),o.build()),o}return i(t,e),t.prototype.build=function(){for(var e=this.lineElements,t=new THREE.Box2,n=0;n<e.length;n++)for(var i=e[n],r=0;r<i.length;r++){var a=i[r],l=a.v1.clone(),u=a.v2.clone(),c=a.material;t.makeEmpty(),t.setFromPoints([l,u]),this.clipBox2D.intersectsBox(t)&&(this.add(new o.GridLine(l,u,c,a.name)),r%this.axisGridNumberInterval==0&&this.add(new s.AxisNotation(l,u,a.name,c)))}},t.prototype.calculateAxisGridBox=function(e,t,n){this.boundingBox.makeEmpty();for(var i=this.resourceGrids,r=0,a=i.length;r<a;r++){var o=i[r],s=o.start||o.Start,l=o.end||o.End,u=new THREE.Vector2(s.X,s.Y),c=new THREE.Vector2(l.X,l.Y);this.boundingBox.expandByPoint(u),this.boundingBox.expandByPoint(c)}this.realBoundingBox=this.boundingBox.clone();var h=this.boundingBox.getCenter(),d=this.boundingBox.getSize(),f=new THREE.Vector2,p=e/t,m=d.x/d.y,g=d.x,v=d.y,y=4*(n+4)*this.multiplyZoomFactor;m>p?(this.bIsShowAxisGrid&&(g=d.x*e/(e-y)),v=g/p):m<p&&(this.bIsShowAxisGrid&&(v=d.y*t/(t-y)),g=v*p),f.set(g,v),this.boundingBox.setFromCenterAndSize(h,f)},t.prototype.getAxisGridBox=function(e){return this.isValid()&&this.calculateAxisGridBox(this.width,this.height,10),e?this.realBoundingBox:this.boundingBox},t.prototype.isEmpty=function(){return 0==this.boundingBox.getSize().length()},t.prototype.isValid=function(){return!!this.resourceGrids},t.prototype.calculateIntersections=function(){var e=this.resourceGrids,t=0,n=0,i=e.length,r=this.getAxisGridBox();for(t=0;t<i;t++){var a=e[t],o=a.name||a.Name,s=a.start||a.Start,l=a.end||a.End,u=new THREE.Vector2(s.X,s.Y),c=new THREE.Vector2(l.X,l.Y),h={width:this.width/2,height:this.height/2};this.algorithm.worldToNormalizedPoint(u,r),this.algorithm.normalizedPointToScreen(u,h),this.algorithm.worldToNormalizedPoint(c,r),this.algorithm.normalizedPointToScreen(c,h);var d=c.clone().sub(u).normalize();Math.abs(d.x)>=Math.abs(d.y)?this.horizLineElements.push({name:o,v1:u,v2:c,material:this.materialGrid}):this.verticalLineElements.push({name:o,v1:u,v2:c,material:this.materialGrid})}this.lineElements.push(this.horizLineElements),this.lineElements.push(this.verticalLineElements);var f,p,m,g,v,y,E,b,x=this.horizLineElements.length,M=this.verticalLineElements.length;for(t=0;t<x;t++)for(f=this.horizLineElements[t],g=f.name,v=f.v1.clone(),y=f.v2.clone(),n=0;n<M;n++){p=this.verticalLineElements[n],m=p.name,E=p.v1.clone(),b=p.v2.clone();var _=!1;E.x<=Math.max(v.x,y.x)&&E.x>=Math.min(v.x,y.x)&&v.y<=Math.max(E.y,b.y)&&v.y>=Math.min(E.y,b.y)&&(_=!0);var C=null;_&&(C=this.algorithm.getInterPoint(v,y,E,b)),this.intersections.push({intersectionPoint:C,horizLine:[v.clone(),y.clone()],verticalLine:[E.clone(),b.clone()],abcName:g,numeralName:m})}},t.prototype.getIntersections=function(){return this.intersections},t.prototype.abtainRenderables=function(e){for(var t=0;t<this.children.length;t++){this.children[t].abtainRenderables(e)}},t.prototype.getGridLineByName=function(e){for(var t=this.children,n=0;n<t.length;n++){var i=t[n];if(i instanceof o.GridLine&&i.isMatch(e))return i}},t.prototype.move=function(e,t){this.children.forEach(function(n){n.move(e,t)})},t}(r.DrawableItem);n.AxisGrid=l},{"../Algorithm":1,"./AxisNotation":6,"./DrawableItem":8,"./GridLine":10}],6:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=e("./TipCircle"),o=e("./TipText"),s=function(e){function t(t,n,i,r){var a=e.call(this)||this;return a.start=t,a.end=n,a.name=i,a.axisGridNumberCircleRadius=10,a.build(),a}return i(t,e),t.prototype.build=function(){var e=new THREE.Vector2;e.subVectors(this.end,this.start).normalize().multiplyScalar(this.axisGridNumberCircleRadius),this.start.sub(e),this.end.add(e),this.add(new a.TipCircle(this.start,this.axisGridNumberCircleRadius)),this.add(new a.TipCircle(this.end,this.axisGridNumberCircleRadius)),this.add(new o.TipText(this.start,this.name)),this.add(new o.TipText(this.end,this.name))},t.prototype.abtainRenderables=function(e){for(var t=0;t<this.children.length;t++){this.children[t].abtainRenderables(e)}},t.prototype.move=function(e,t){this.children.forEach(function(n){n.move(e,t)})},t}(r.DrawableItem);n.AxisNotation=s},{"./DrawableItem":8,"./TipCircle":12,"./TipText":14}],7:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=e("../Editor/PanEditor"),o=function(e){function t(){var t=e.call(this)||this;return t.cameraCircleNode=null,t.cameraArrowNode=null,t.rotateAngle=0,t.panelSize=[298,198],t.build(),t}return i(t,e),t.prototype.build=function(){var e=document.createElementNS(this.xmlns,"g");e.setAttribute("fill","none"),e.setAttribute("fill-rule","evenodd"),e.setAttribute("stroke-width","1");var t=document.createElementNS(this.xmlns,"circle");t.setAttribute("r","4.5"),t.setAttribute("stroke","#FFFFFF"),t.setAttribute("fill","#32D3A6"),this.cameraCircleNode=t;var n=document.createElementNS(this.xmlns,"path");n.setAttribute("d","M5.94925387,0 C18.4132389,0 28.6581001,9.50119823 29.8362478,21.6560048 L5.94925387,25 Z"),n.setAttribute("fill","url(#radialGradient-1)"),n.setAttribute("transform","translate(13,-21)rotate(50)"),this.cameraArrowNode=n;var i=document.createElementNS(this.xmlns,"defs"),r=document.createElementNS(this.xmlns,"radialGradient"),a=document.createElementNS(this.xmlns,"stop"),o=document.createElementNS(this.xmlns,"stop");r.setAttribute("cx","0%"),r.setAttribute("cy","100%"),r.setAttribute("fx","0%"),r.setAttribute("fy","100%"),r.setAttribute("r","104.321936%"),r.setAttribute("id","radialGradient-1"),a.setAttribute("stop-color","#36D4A8"),a.setAttribute("offset","0%"),o.setAttribute("stop-color","#36D4A8"),o.setAttribute("offset","100%"),o.setAttribute("stop-opacity","0"),i.append(r),r.append(a),r.append(o),e.appendChild(i),e.appendChild(t),e.appendChild(n),this.svgNode=e},t.prototype.setCircleAttribute=function(e,t){this.cameraCircleNode.setAttribute(e,t)},t.prototype.setArrowAttribute=function(e,t){this.cameraArrowNode.setAttribute(e,t)},t.prototype.rotate=function(e){e&&(this.rotateAngle=e);var t=this.svgNode.getAttribute("transform");t+="rotate("+this.rotateAngle+")",this.svgNode.setAttribute("transform",t)},t.prototype.setOffsetAndRotate=function(e,t,n){var i=this.setOffsetBoundary(e,t);this.locate(i.X,i.Y),this.rotate(n),a.PanEditor.panOffsetXForCamera=0,a.PanEditor.panOffsetYForCamera=0},t.prototype.move=function(e,t){var n=this.position.x+e,i=this.position.y+t,r=this.setOffsetBoundary(n,i);this.svgNode.setAttribute("transform","translate("+r.X+","+r.Y+")")},t.prototype.setOpacity=function(e){this.svgNode.setAttribute("opacity",e)},t.prototype.setCameraArrowOpacity=function(e){this.cameraArrowNode.setAttribute("opacity",e)},t.prototype.setCameraCircleOpacity=function(e){this.cameraCircleNode.setAttribute("opacity",e)},t.prototype.setBigCamera=function(){this.cameraCircleNode.setAttribute("r","4.5"),this.cameraArrowNode.setAttribute("transform","translate(13,-21)rotate(50)")},t.prototype.setSmallCamera=function(){this.cameraCircleNode.setAttribute("r","2"),this.cameraArrowNode.setAttribute("transform","translate(20,-21)rotate(50)")},t.prototype.setPanelSize=function(e){this.panelSize=e},t.prototype.setOffsetBoundary=function(e,t){var n=this.panelSize[0]/2-6,i=-this.panelSize[0]/2+6,r=this.panelSize[1]/2-6,a=-this.panelSize[1]/2+6;return e>=n||e<=i||t>=r||t<=a?this.setSmallCamera():this.setBigCamera(),e>n&&(e=n),e<i&&(e=i),t>r&&(t=r),t<a&&(t=a),{X:e,Y:t}},t}(r.DrawableItem);n.CameraNode=o},{"../Editor/PanEditor":16,"./DrawableItem":8}],8:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this.xmlns="http://www.w3.org/2000/svg",this.material=null,this.svgNode=null,this.children=[],this.glodonColor="#11DAB7",this.position=new THREE.Vector2}return e.prototype.add=function(e){this.children.push(e)},e.prototype.getSvgNode=function(){return this.svgNode},e.prototype.abtainRenderables=function(e){e.appendChild(this.svgNode)},e.prototype.isMatch=function(e){return this.name==e},e.prototype.highlight=function(){this.svgNode.setAttribute("style","stroke:"+this.glodonColor)},e.prototype.cancelHighlight=function(){this.svgNode.setAttribute("style","stroke:"+this.material.color.getStyle())},e.prototype.locate=function(e,t){this.position.set(e,t),this.move(0,0)},e.prototype.move=function(e,t){var n=this.position.x+e,i=this.position.y+t;this.svgNode.setAttribute("transform","translate("+n+","+i+")")},e}();n.DrawableItem=i},{}],9:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=function(e){function t(t,n){var i=e.call(this)||this;return i.imageUrl=t,i.width=n[0],i.height=n[1],i.offsetX=n[2],i.offsetY=n[3],i.build(),i}return i(t,e),t.prototype.build=function(){var e=document.createElementNS(this.xmlns,"image");e.href.baseVal=this.imageUrl,e.setAttribute("herf",this.imageUrl),e.setAttribute("preserveAspectRatio","none"),e.setAttribute("width",this.width+""),e.setAttribute("height",this.height+""),e.setAttribute("x",-.5*this.width+""),e.setAttribute("y",-.5*this.height+""),this.svgNode=e,this.locate(this.offsetX,this.offsetY)},t}(r.DrawableItem);n.FloorPlane=a},{"./DrawableItem":8}],10:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=function(e){function t(t,n,i,r){var a=e.call(this)||this;return a.start=t,a.end=n,a.material=i,a.name=r,a.build(),a}return i(t,e),t.prototype.build=function(){var e=document.createElementNS(this.xmlns,"line");e.setAttribute("x1",this.start.x),e.setAttribute("y1",this.start.y),e.setAttribute("x2",this.end.x),e.setAttribute("y2",this.end.y);var t=this.material;t instanceof THREE.LineBasicMaterial&&e.setAttribute("style","fill: none; stroke: "+t.color.getStyle()+"; stroke-width: "+t.linewidth+"; stroke-opacity: "+t.opacity+"; stroke-linecap: "+t.linecap+"; stroke-linejoin: "+t.linejoin),this.svgNode=e},t}(r.DrawableItem);n.GridLine=a},{"./DrawableItem":8}],11:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=function(e){function t(t,n){var i=e.call(this)||this;return i.radius=t,i.material=n,i.build(),i}return i(t,e),t.prototype.build=function(){var e=document.createElementNS(this.xmlns,"circle");e.setAttribute("r",this.radius+""),e.setAttribute("fill",this.glodonColor),e.setAttribute("style","fill: none; stroke: "+this.glodonColor),e.setAttribute("opacity","0"),this.svgNode=e},t.prototype.highlight=function(){this.svgNode.setAttribute("style","stroke:"+this.glodonColor),this.svgNode.setAttribute("opacity","1")},t.prototype.cancelHighlight=function(){this.svgNode.setAttribute("style","stroke:rgb(153,153,153)"),this.svgNode.setAttribute("opacity","0")},t.prototype.setOffset=function(e,t){this.svgNode.setAttribute("transform","translate("+e+","+t+")")},t}(r.DrawableItem);n.HighlightPoint=a},{"./DrawableItem":8}],12:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=function(e){function t(t,n){var i=e.call(this)||this;return i.center=t,i.radium=n,i.circleColor=new THREE.Color(.6,.6,.6),i.build(),i}return i(t,e),t.prototype.build=function(){var e=this.center.x,t=this.center.y;if("NaN"!=e.toString()&&"NaN"!=t.toString()){var n=document.createElementNS(this.xmlns,"circle");n.setAttribute("r",this.radium+""),n.setAttribute("style","fill: none; stroke: "+this.circleColor.getStyle()+"; stroke-width: 1"),this.svgNode=n,this.locate(e,t)}},t}(r.DrawableItem);n.TipCircle=a},{"./DrawableItem":8}],13:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=function(e){function t(){var t=e.call(this)||this;return t.tipNodeBackgroundColor="#fff",t.tipNodeColor="#000",t.initialize(),t.build(),t}return i(t,e),t.prototype.initialize=function(){var e=".cloud-tip:after { box-sizing: border-box;display: inline;font-size: 10px;width: 100%;line-height: 1;color: "+this.tipNodeBackgroundColor+";content: '\\25BC';position: absolute;text-align: center;margin: -4px 0 0 0;top: 100%;left: 0;}";this.loadStyleString(e)},t.prototype.loadStyleString=function(e){var t=document.createElement("style");t.type="text/css",t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t)},t.prototype.build=function(){var e=document.createElement("div");e.className="cloud-tip",e.style.position="absolute",e.style.opacity="0",e.style.background=this.tipNodeBackgroundColor,e.style.color=this.tipNodeColor,e.style.padding="0 8px 0 8px",e.style.borderRadius="2px",e.style.fontSize="8px",e.style.zIndex="10",this.svgNode=e},t.prototype.show=function(){this.svgNode.style.opacity=1,this.svgNode.className="cloud-tip"},t.prototype.hide=function(){this.svgNode.style.opacity=0,this.svgNode.className=""},t.prototype.setContent=function(e){this.svgNode.innerHTML=e},t.prototype.setOffset=function(e,t){var n=this.svgNode.getBoundingClientRect();this.svgNode.style.left=e[0]/2+t[0]-.5*n.width+"px",this.svgNode.style.top=e[1]/2+t[1]-n.height-12+"px"},t}(r.DrawableItem);n.TipNode=a},{"./DrawableItem":8}],14:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./DrawableItem"),a=function(e){function t(t,n){var i=e.call(this)||this;return i.center=t,i.literal=n,i.fontSize=8,i.textColor=new THREE.Color(.6,.6,.6),i.build(),i}return i(t,e),t.prototype.build=function(){var e=this.center.x,t=this.center.y;if("NaN"!=e.toString()&&"NaN"!=t.toString()){var n=document.createElementNS(this.xmlns,"text");n.setAttribute("style","font-size:"+this.fontSize+"px; fill: none; stroke: "+this.textColor.getStyle()+"; stroke-width: 1"),n.innerHTML=this.literal,n.textContent=this.literal;var i=(n.getBoundingClientRect(),e-3.5),r=t+2.8;this.svgNode=n,this.locate(i,r)}},t}(r.DrawableItem);n.TipText=a},{"./DrawableItem":8}],15:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i;!function(e){e.Default="Editor",e.PICK_Editor="Pick",e.RECTPICK_Editor="RectPick",e.PAN_Editor="Pan",e.Zoom_Editor="Zoom"}(i=n.EditorName||(n.EditorName={}));var r=function(){function e(){this.bIsMouseDown=!1,this.name=i.Default}return e.prototype.onMouseDown=function(e){},e.prototype.onMouseMove=function(e){},e.prototype.onMouseUp=function(e){},e.prototype.onMouseWheel=function(e){},e.prototype.getName=function(){return this.name},e}();n.Editor=r},{}],16:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./Editor"),a=e("./ZoomEditor"),o=e("../EventManager"),s=function(e){function t(n,i){var a=e.call(this)||this;return a.name=r.EditorName.PAN_Editor,a.eventManager=i,a.vfData=n.getData(),a.bIsMouseDown=!1,a.mouseDownPos=new THREE.Vector2,t.panOffsetX=0,t.panOffsetY=0,a}return i(t,e),t.prototype.onMouseDown=function(e){this.bIsMouseDown=!0,this.mouseDownPos.setX(e.clientX),this.mouseDownPos.setY(e.clientY)},t.prototype.onMouseMove=function(e){this.bIsMouseDown},t.prototype.onMouseUp=function(e){if(0!=this.bIsMouseDown&&1!=this.vfData.getZoomFactor()){var n=e.clientX-this.mouseDownPos.x,i=e.clientY-this.mouseDownPos.y,r=this.boundsChecking(n,i);n=r[0],i=r[1],t.panOffsetX+=n,t.panOffsetY+=i,t.panOffsetXForCamera+=n,t.panOffsetYForCamera+=i,this.vfData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:o.EventType.PAN_MOUSE_MOVE,data:{offsetX:t.panOffsetX,offsetY:t.panOffsetY,zoomFactor:this.vfData.getZoomFactor()}}),this.bIsMouseDown=!1}},t.prototype.boundsChecking=function(e,t){var n=this.vfData.getCorner("Origin","LB"),i=this.vfData.getCorner("Virtual","LB"),r=this.vfData.getCorner("Origin","RT"),a=this.vfData.getCorner("Virtual","RT");if(e>0){var o=n[0]-i[0];o<=e&&(e=o)}else if(e<0){var o=r[0]-a[0]
;o>=e&&(e=o)}if(t<0){var s=n[1]-i[1];s>=t&&(t=s)}else if(t>0){var s=r[1]-a[1];s<=t&&(t=s)}return[e,t]},t.prototype.updateZoomAndPan=function(){var e=this.vfData.getCorner("Origin","LT"),t=this.vfData.getCorner("Virtual","LT");a.ZoomEditor.offsetXForZoomAndPan=e[0]-t[0],a.ZoomEditor.offsetYForZoomAndPan=e[1]-t[1]},t.clear=function(){t.panOffsetX=0,t.panOffsetY=0,t.panOffsetXForCamera=0,t.panOffsetYForCamera=0},t}(r.Editor);n.PanEditor=s},{"../EventManager":20,"./Editor":15,"./ZoomEditor":19}],17:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./Editor"),a=e("../Algorithm"),o=e("../HighlightControl"),s=e("../EventManager"),l=e("./PanEditor"),u=e("./ZoomEditor"),c=function(e){function t(t,n){var i=e.call(this)||this;return i.name=r.EditorName.PICK_Editor,i.vfViewer=t,i.vfData=t.getData(),i.algorithm=new a.Algorithm,i.highlightControl=new o.HighlightControl(i.vfData),i.cameraProjectedPosZ=1750,i.mapClickMode="default",i.lastMousePoint=new THREE.Vector2,i.eventManager=n,i.bIsEnableHover=!0,i}return i(t,e),t.prototype.onMouseDown=function(e){this.bIsMouseDown=!0,this.lastMousePoint.setX(e.clientX),this.lastMousePoint.setY(e.clientY)},t.prototype.onMouseMove=function(e){if(0!=this.bIsEnableHover||!this.bIsMouseDown){var t=new THREE.Vector2(e.clientX,e.clientY);t.x+=u.ZoomEditor.offsetXForZoomAndPan,t.y+=+u.ZoomEditor.offsetYForZoomAndPan;var n=this.vfViewer.getMapContainer(),i=this.vfData.getSize();if(this.algorithm.isMouseOverCanvas(n,i,t)){var r=this.algorithm.normalizePoint(n,i,t),a=new THREE.Vector2(r.x,r.y),o=null;this.bIsAllowNear?(this.algorithm.normalizedPointToScreen(a,{width:i[0]/2,height:i[1]/2}),o=this.algorithm.getIntersectionToMinDistance(this.vfData.getIntersections(),a)):o=this.getIntersectionByNormalizedPoint(a),this.highlightControl.cancelHightlight(),o&&this.highlightControl.hightlight(o,l.PanEditor.panOffsetX,l.PanEditor.panOffsetY)}}},t.prototype.onMouseUp=function(e){this.bIsMouseDown=!1,this.lastMousePoint.x===e.clientX&&this.lastMousePoint.y===e.clientY&&this.locateByClientPoint(e.clientX+u.ZoomEditor.offsetXForZoomAndPan,e.clientY+u.ZoomEditor.offsetYForZoomAndPan)},t.prototype.setIsAllowNear=function(e){this.bIsAllowNear=e},t.prototype.getIntersectionByNormalizedPoint=function(e){for(var t=null,n=this.vfData.getIntersections(),i=0,r=n.length;i<r;i++){var a=n[i].intersectionPoint;if(a){var o=new THREE.Vector2(e.x,e.y),s=this.vfData.getSize();this.algorithm.normalizedPointToScreen(o,{width:s[0]/2,height:s[1]/2});if(a.distanceToSquared(o)<9){t=n[i];break}}}return t},t.prototype.locateByClientPoint=function(e,t){var n=new THREE.Vector2(e,t),i=new THREE.Vector3,r=this.vfViewer.getMapContainer(),a=this.vfData.getSize(),o=this.algorithm.normalizePoint(r,a,n);if(null==o)return void console.warn("Click point out of boundary.");var l=this.vfData.getAxisGridBox2D();this.algorithm.normalizedPointToWorld(o,l);var u=this.algorithm.normalizePoint(r,a,n);this.algorithm.normalizedPointToScreen(u,{width:a[0]/2,height:a[1]/2});var c=this.algorithm.getIntersectionToMinDistance(this.vfData.getIntersections(),u);if(c&&c.intersectionPoint){var h=new THREE.Vector2(c.intersectionPoint.x,c.intersectionPoint.y);if(u.sub(h).lengthSq()<9){var d=h.clone(),f={width:a[0]/2,height:a[1]/2};this.algorithm.screenToNormalizedPoint(d,f),this.algorithm.normalizedPointToWorld(d,l),i.set(d.x,d.y,this.cameraProjectedPosZ)}else i.set(o.x,o.y,this.cameraProjectedPosZ)}else i.set(o.x,o.y,this.cameraProjectedPosZ);var p=i.clone(),m=this.vfData.getElevationById();return"string"==typeof m&&(m=parseFloat(m)),p.z+=m,"default"==this.mapClickMode?(this.eventManager.dispatchEvent({type:s.EventType.PICK_MOUSE_UP,data:p}),this.algorithm.transformWorldPoint(this.vfViewer.getViewer(),p),this.algorithm.flyToPointWithParallelEye(this.vfViewer.getViewer(),p)):"static"==this.mapClickMode&&this.eventManager.dispatchEvent({type:s.EventType.PICK_MOUSE_UP,data:p}),!0},t.prototype.setClickMode=function(e){this.mapClickMode=e},t}(r.Editor);n.PickEditor=c},{"../Algorithm":1,"../EventManager":20,"../HighlightControl":21,"./Editor":15,"./PanEditor":16,"./ZoomEditor":19}],18:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r=e("./Editor"),a=e("../NaviAction"),o=e("../EventManager"),s=e("../Algorithm"),l=e("./ZoomEditor"),u=function(e){function t(t,n){var i=e.call(this)||this;return i.name=r.EditorName.RECTPICK_Editor,i.eventManager=n,i.viewerFloorData=t.getData(),i.naviAction=new a.NaviAction(t),i.vfViewer=t,i.algorithm=new s.Algorithm,i}return i(t,e),t.prototype.onMouseDown=function(e){this.naviAction.setMouseState(!0);var t=this.adjustEvent(e);if(this.naviAction.setLastMousePoint(t.clientX,t.clientY),0==this.naviAction.pointsCount()){var n={x:t.offsetX,y:t.offsetY};this.naviAction.addPointToRectangle(n.x,n.y),this.naviAction.createSvgRect(n)}if(2==this.naviAction.pointsCount()){var i={x:e.offsetX,y:e.offsetY},r=this.naviAction.hitGrips(i),a=this.naviAction.isPointInRectangle(i.x,i.y);r>=0?this.naviAction.setEditMode(!0):a&&(this.naviAction.updateLastMousePointToRect(),this.naviAction.setPanMode(!0))}this.eventManager.dispatchEvent({type:o.EventType.RECTPICK_MOUSE_DOWN})},t.prototype.onMouseMove=function(e){if(2==this.naviAction.pointsCount()&&this.naviAction.hightlightGrip(e),this.naviAction.getMouseState()){var t=this.vfViewer.getDomContainer().getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;if(this.naviAction.pointsCount()<2&&this.naviAction.updateSvgRect({x:n,y:i}),this.naviAction.getEditMode()){var r={x:n,y:i},a=this.naviAction.hitGrips(r);if(this.naviAction.getMouseClickState())return this.firstPos=r,this.naviAction.setMouseClickState(!1),void(a>=0&&this.naviAction.setCurrentGripId(a));var o=r;this.naviAction.getCurrentGripId()>=0&&(this.naviAction.gripDragging(this.firstPos,o),this.naviAction.resetSvgRect(),this.naviAction.removeGrips(),this.naviAction.drawGrips()),this.firstPos=o}this.naviAction.getPanMode()&&this.naviAction.panRectangle(e.clientX,e.clientY)}},t.prototype.onMouseUp=function(e){if(this.naviAction.setMouseState(!1),this.naviAction.setMouseClickState(!0),this.naviAction.setCurrentGripId(-1),this.naviAction.setPanMode(!1),this.naviAction.equalWithLastPoint(e.clientX,e.clientY))return void(1==this.naviAction.pointsCount()&&this.naviAction.clearRectangle());if(1==this.naviAction.pointsCount()){var t=this.adjustEvent(e),n=this.vfViewer.getDomContainer().getBoundingClientRect(),i=t.clientX-n.left,r=t.clientY-n.top;this.naviAction.pointValidation(i,r),this.naviAction.resetSvgRect(),this.naviAction.drawGrips()}this.naviAction.setEditMode(!1)},t.prototype.clear=function(){this.naviAction.destroyAll()},t.prototype.getBoundingBoxIsolate=function(){var e=this.naviAction.getRectangle(),t={x:e[0]+l.ZoomEditor.offsetXForZoomAndPan,y:e[1]+l.ZoomEditor.offsetYForZoomAndPan},n={x:e[2]+l.ZoomEditor.offsetXForZoomAndPan,y:e[3]+l.ZoomEditor.offsetYForZoomAndPan},i=this.algorithm.getCuttingBoxOnCanvas(t,n,this.viewerFloorData.getSize(),this.viewerFloorData.getAxisGridBox2D()),r=this.viewerFloorData.getFloorPlaneBox();return i.min.z=r.min.z,i.max.z=r.max.z,i},t.prototype.getIntersectionByNormalizedPoint=function(e,t){var n=this.vfViewer.getData().getIntersections(),i=new THREE.Vector2(e.x,e.y);return this.algorithm.normalizedPointToScreen(i,{width:t[0]/2,height:t[1]/2}),s.Algorithm.getIntersectionByPoint(n,i)},t.prototype.adjustEvent=function(e){var t={offsetX:e.offsetX,offsetY:e.offsetY,clientX:e.clientX,clientY:e.clientY},n=new THREE.Vector2(t.clientX,t.clientY);n.x+=l.ZoomEditor.offsetXForZoomAndPan,n.y+=l.ZoomEditor.offsetYForZoomAndPan;var i=this.vfViewer.getMapContainer(),r=this.vfViewer.getData().getSize(),a=this.algorithm.normalizePoint(i,r,n),o=this.getIntersectionByNormalizedPoint(a,r);if(o){var s=this.vfViewer.getDomContainer().getBoundingClientRect();t.clientX=o.intersectionPoint.x-l.ZoomEditor.offsetXForZoomAndPan,t.offsetX=t.clientX+r[0]/2,t.clientX=t.offsetX+s.left,t.clientY=o.intersectionPoint.y-l.ZoomEditor.offsetYForZoomAndPan,t.offsetY=t.clientY+r[1]/2,t.clientY=t.offsetY+s.top}return t},t}(r.Editor);n.RectPickEditor=u},{"../Algorithm":1,"../EventManager":20,"../NaviAction":22,"./Editor":15,"./ZoomEditor":19}],19:[function(e,t,n){var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(n,"__esModule",{value:!0});var r,a=e("./Editor"),o=e("./PanEditor"),s=e("../EventManager");!function(e){e.Min="Min",e.Max="Max"}(r=n.VFSizeMode||(n.VFSizeMode={}));var l=function(e){function t(t,n){var i=e.call(this)||this;return i.totalZoomFactors=[],i.zoomFactors=[],i.lastZoomFactor=1,i.currentIdx=0,i.name=a.EditorName.Zoom_Editor,i.eventManager=n,i.vfData=t.getData(),i.vfViewer=t,i}return i(t,e),t.prototype.onMouseWheel=function(e){var t=e.deltaY||-e.wheelDelta||e.detail,n=t<0,i=-1;if(n?this.currentIdx<this.zoomFactors.length-1&&(this.currentIdx++,i=this.zoomFactors[this.currentIdx]):this.currentIdx>0&&(this.currentIdx--,i=this.zoomFactors[this.currentIdx]),!(i<0||this.lastZoomFactor==i)){this.lastZoomFactor=i,1==i&&o.PanEditor.clear();var r=this.vfData.getOriginSize(),a=new THREE.Vector2(e.offsetX-r[0]/2,e.offsetY-r[1]/2),l=this.zoomFactors[this.currentIdx],u=0,c=0;if(n){var h=this.zoomFactors[this.currentIdx-1],d=l/h,f=[],p=this.vfData.getCorner("Virtual","LB");p[0]-=a.x,p[1]-=a.y,f.push(p[0]*d+a.x),f.push(p[1]*d+a.y),this.vfData.setZoomFactor(l);var m=this.vfData.getCorner("Virtual","LB");this.vfData.setZoomFactor(h),u=f[0]-m[0],c=f[1]-m[1]}else{var h=this.zoomFactors[this.currentIdx+1],g=this.boundsChecking(l,h,a);u=g[0],c+=g[1]}o.PanEditor.panOffsetX+=u,o.PanEditor.panOffsetY+=c,o.PanEditor.panOffsetXForCamera+=u,o.PanEditor.panOffsetYForCamera+=c,this.vfData.setZoomFactor(i),this.vfViewer.destroy(),this.vfData.destroy(),this.vfData.build(),this.vfViewer.update(),this.vfData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:s.EventType.ZOOM_MOUSE_WHEEL,data:{offsetX:o.PanEditor.panOffsetX,offsetY:o.PanEditor.panOffsetY,zoomFactor:i}})}},t.prototype.boundsChecking=function(e,t,n){var i=e/t,r=this.vfData.getCorner("Virtual","LB"),a=this.vfData.getCorner("Virtual","LT"),o=this.vfData.getCorner("Virtual","RT"),s=this.vfData.getCorner("Virtual","RB"),l=[0,0],u=(r[0]-n.x)*i+n.x,c=(r[1]-n.y)*i+n.y;this.vfData.setZoomFactor(e);var h=this.vfData.getCorner("Virtual","LB");this.vfData.setZoomFactor(t),l[0]=u-h[0],l[1]=c-h[1];var d=0,f=0,p=this.vfData.getCorner("Origin","LB");u>p[0]&&(l[0]+=p[0]-u,d++),c<p[1]&&(l[1]+=p[1]-c,f++),u=(a[0]-n.x)*i+n.x,c=(a[1]-n.y)*i+n.y;var m=this.vfData.getCorner("Origin","LT");u>m[0]&&0==d&&(l[0]+=m[0]-u,d++),c>m[1]&&0==f&&(l[1]+=m[1]-c,f++),u=(o[0]-n.x)*i+n.x,c=(o[1]-n.y)*i+n.y;var g=this.vfData.getCorner("Origin","RT");u<g[0]&&0==d&&(l[0]+=g[0]-u,d++),c>g[1]&&0==f&&(l[1]+=g[1]-c,f++),u=(s[0]-n.x)*i+n.x,c=(s[1]-n.y)*i+n.y;var v=this.vfData.getCorner("Origin","RB");return u<v[0]&&0==d&&(l[0]+=v[0]-u,d++),c<v[1]&&0==f&&(l[1]+=v[1]-c,f++),l},t.prototype.enableMode=function(e){if(e==r.Min)this.zoomFactors=this.totalZoomFactors;else if(e==r.Max){this.zoomFactors=this.totalZoomFactors.slice(1,this.totalZoomFactors.length);for(var t=1;t<this.zoomFactors.length;t++)this.zoomFactors[t]/=this.zoomFactors[0];this.zoomFactors[0]=1}this.currentIdx=0},t.prototype.setZoomFactors=function(e){this.totalZoomFactors=e,this.zoomFactors=e},t.prototype.setZoonIndex=function(e){this.currentIdx=e},t.prototype.getZoonIndex=function(){return this.currentIdx},t.prototype.updateZoomAndPan=function(){var e=this.vfData.getCorner("Origin","LT"),n=this.vfData.getCorner("Virtual","LT");t.offsetXForZoomAndPan=e[0]-n[0],t.offsetYForZoomAndPan=e[1]-n[1]},t.clear=function(){t.offsetXForZoomAndPan=0,t.offsetYForZoomAndPan=0},t.offsetXForZoomAndPan=0,t.offsetYForZoomAndPan=0,t}(a.Editor);n.ZoomEditor=l},{"../EventManager":20,"./Editor":15,"./PanEditor":16}],20:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});!function(e){e[e.RECTPICK_MOUSE_DOWN=1e3]="RECTPICK_MOUSE_DOWN",e[e.RECTPICK_MOUSE_MOVE=1001]="RECTPICK_MOUSE_MOVE",e[e.RECTPICK_MOUSE_UP=1002]="RECTPICK_MOUSE_UP",e[e.PICK_MOUSE_DOWN=2e3]="PICK_MOUSE_DOWN",e[e.PICK_MOUSE_MOVE=2001]="PICK_MOUSE_MOVE",e[e.PICK_MOUSE_UP=2002]="PICK_MOUSE_UP",e[e.Floor_Plane_Changed=3e3]="Floor_Plane_Changed",e[e.Floor_Plane_Changed_For_Panel=3001]="Floor_Plane_Changed_For_Panel",e[e.Resize=4e3]="Resize",e[e.Camera_Height_Changed=5e3]="Camera_Height_Changed",e[e.ZOOM_MOUSE_WHEEL=6e3]="ZOOM_MOUSE_WHEEL",e[e.PAN_MOUSE_MOVE=7e3]="PAN_MOUSE_MOVE",e[e.Minimap_Rect_Changed=8e3]="Minimap_Rect_Changed",e[e.Minimap_Rect_Destroyed=8001]="Minimap_Rect_Destroyed"}(n.EventType||(n.EventType={}));!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"}(n.MouseEventType||(n.MouseEventType={}));var i=function(){function e(){this.eventDispatcher=new THREE.EventDispatcher}return e.prototype.addEventListener=function(e,t){this.eventDispatcher.addEventListener(e,t)},e.prototype.hasEventListener=function(e){this.eventDispatcher.hasEventListener(e)},e.prototype.removeEventListener=function(e,t){this.eventDispatcher.removeEventListener(e,t)},e.prototype.dispatchEvent=function(e){this.eventDispatcher.dispatchEvent(e)},e}();n.EventManager=i},{}],21:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e){this.viewerFloorData=e}return e.prototype.hightlight=function(e,t,n){var i=this.viewerFloorData.getOriginSize();this.intersectPoint=this.viewerFloorData.getIntersectPoint();var r=[e.intersectionPoint.x+t,e.intersectionPoint.y+n];this.intersectPoint.setOffset(r[0],r[1]),this.abcGridLine=this.viewerFloorData.getGridLineByName(e.abcName),this.numeralGridLine=this.viewerFloorData.getGridLineByName(e.numeralName),this.intersectPoint.highlight(),this.abcGridLine.highlight(),this.numeralGridLine.highlight(),this.tipNode=this.viewerFloorData.getTipNode(),this.tipNode.setContent(e.numeralName+"-"+e.abcName),this.tipNode.setOffset(i,r),this.tipNode.show()},e.prototype.cancelHightlight=function(){this.intersectPoint&&(this.intersectPoint.cancelHighlight(),this.abcGridLine.cancelHighlight(),this.numeralGridLine.cancelHighlight(),this.tipNode.hide(),this.intersectPoint=null,this.abcGridLine=null,this.numeralGridLine=null,this.tipNode=null)},e}();n.HighlightControl=i},{}],22:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./EventManager"),r=function(){function e(e){this.vfViewer=e,this.vfData=e.getData(),this.svgRect=null,this.rectForMinimapId="RectForMinimap",this.bEditMode=!1,this.bPanMode=!1,this.bMouseDown=!1,this.rectangle=[],this.currentGripId=-1,this.lastHighlightGripId=-1,this.bFirstMouseClick=!0,this.lastMousePoint=new THREE.Vector2,this.lastMousePointToRectMin=new THREE.Vector2,this.lastMousePointToRectMax=new THREE.Vector2,this.pointOnBorder=[],this.eventManager=e.getEventManager(),this.panOffset=[0,0],this.zoomFactor=1;var t=this;this.eventManager.addEventListener(i.EventType.ZOOM_MOUSE_WHEEL,function(e){var n=e.data;t.zoomAndPan(n.offsetX,n.offsetY,n.zoomFactor)}),this.eventManager.addEventListener(i.EventType.PAN_MOUSE_MOVE,function(e){var n=e.data;t.zoomAndPan(n.offsetX,n.offsetY,n.zoomFactor)})}return e.prototype.getMouseClickState=function(){return this.bFirstMouseClick},e.prototype.setMouseClickState=function(e){this.bFirstMouseClick=!!e},e.prototype.getCurrentGripId=function(){return this.currentGripId},e.prototype.setCurrentGripId=function(e){this.currentGripId=e},e.prototype.getRectangleInfo=function(){var e=Math.abs(this.rectangle[2]-this.rectangle[0]),t=Math.abs(this.rectangle[3]-this.rectangle[1]);return{x:this.rectangle[0],y:this.rectangle[1],width:e,height:t}},e.prototype.setLastMousePoint=function(e,t){this.lastMousePoint.x=e,this.lastMousePoint.y=t},e.prototype.equalWithLastPoint=function(e,t){return this.lastMousePoint.x===e&&this.lastMousePoint.y===t},e.prototype.getRectangle=function(){return this.rectangle},e.prototype.addPointToRectangle=function(e,t){"number"==typeof e&&this.rectangle.push(e),"number"==typeof t&&this.rectangle.push(t)},e.prototype.pointsCount=function(){return this.rectangle.length/2},e.prototype.pointValidation=function(e,t){var n=this.vfViewer.getDomContainer().getBoundingClientRect();(e<0||t<0||e>n.width||t>n.height)&&(e=this.pointOnBorder[0],t=this.pointOnBorder[1]),e<this.rectangle[0]?(this.rectangle.push(this.rectangle[0]),this.rectangle[0]=e):this.rectangle.push(e),t<this.rectangle[1]?(this.rectangle.push(this.rectangle[1]),this.rectangle[1]=t):this.rectangle.push(t)},e.prototype.getMouseState=function(){return this.bMouseDown},e.prototype.setMouseState=function(e){this.bMouseDown=!!e},e.prototype.getEditMode=function(){return this.bEditMode},e.prototype.setEditMode=function(e){this.bEditMode=!!e},e.prototype.getPanMode=function(){return this.bPanMode},e.prototype.setPanMode=function(e){this.bPanMode=!!e},e.prototype.createSvgElement=function(e){var t=document.createElementNS("http://www.w3.org/2000/svg",e);return t.setAttribute("pointer-events","inherit"),t},e.prototype.createSvgRect=function(e){this.svgRect||(this.svgRect=this.createSvgElement("rect"),this.svgRect.setAttribute("id",this.rectForMinimapId),this.svgRect.setAttribute("stroke-width",2),this.svgRect.style.position="absolute",this.svgRect.style.fillOpacity="0.4",this.svgRect.style.fill=this.vfData.getGlodonColor(),this.svgRect.style.display="block",this.svgRect.style.stroke=this.vfData.getGlodonColor(),this.svgRect.style.strokeWidth="2");var t=Math.abs(e.x-this.rectangle[0]),n=Math.abs(e.y-this.rectangle[1]),i=this.vfViewer.getAuxContainer(),r=i.clientWidth,a=i.clientHeight,o=["translate(",e.x-r/2,",",e.y-a/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",o),this.svgRect.setAttribute("width",t+""),this.svgRect.setAttribute("height",n+""),i.appendChild(this.svgRect)},e.prototype.updateSvgRect=function(e){this.pointOnBorder=[],this.pointOnBorder.push(e.x,e.y);var t=Math.abs(e.x-this.rectangle[0]),n=Math.abs(e.y-this.rectangle[1]),i={x:this.rectangle[0],y:this.rectangle[1]};if(e.x<i.x||e.y<i.y){e.x<i.x&&(i.x=e.x),e.y<i.y&&(i.y=e.y);var r=this.vfData.getOriginSize(),a=["translate(",i.x-r[0]/2,",",i.y-r[1]/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",a)}this.svgRect.setAttribute("width",t+""),this.svgRect.setAttribute("height",n+"")},e.prototype.resetSvgRect=function(){var e=Math.abs(this.rectangle[0]-this.rectangle[2]),t=Math.abs(this.rectangle[1]-this.rectangle[3]);this.svgRect.setAttribute("width",e+""),this.svgRect.setAttribute("height",t+"");var n=this.vfViewer.getAuxContainer(),r=n.clientWidth,a=n.clientHeight,o=["translate(",this.rectangle[0]-r/2,",",this.rectangle[1]-a/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",o),this.eventManager.dispatchEvent({type:i.EventType.Minimap_Rect_Changed,rectInfo:this.getRectangleInfo()})},e.prototype.clearRectangle=function(){this.rectangle=[]},e.prototype.adjustRectangle=function(e,t,n){if(t[0]>=n[0])switch(e){case 0:case 1:case 2:t[0]=n[0];break;case 4:case 5:case 6:n[0]=t[0]}if(t[1]>=n[1])switch(e){case 2:case 3:case 4:n[1]=t[1];break;case 6:case 7:case 0:t[1]=n[1]}return t.concat(n)},e.prototype.gripDragging=function(e,t){var n=this.rectangle,i=t.x-e.x,r=t.y-e.y,a=[n[0],n[1]],o=[n[2],n[3]];switch(this.currentGripId){case 0:a[0]+=i,a[1]+=r;break;case 1:a[0]+=i;break;case 2:a[0]+=i,o[1]+=r;break;case 3:o[1]+=r;break;case 4:o[0]+=i,o[1]+=r;break;case 5:o[0]+=i;break;case 6:a[1]+=r,o[0]+=i;break;case 7:a[1]+=r;break;default:console.log("default grip id."+this.currentGripId)}var s=this.vfData.getOriginSize();o[0]=o[0]>s[0]?s[0]:o[0],o[1]=o[1]>s[1]?s[1]:o[1],this.rectangle=this.adjustRectangle(this.currentGripId,a,o)},e.prototype.hightlightGrip=function(e){var t={x:e.offsetX,y:e.offsetY},n=this.hitGrips(t);if(n!=this.lastHighlightGripId&&this.currentGripId<0&&this.lastHighlightGripId>=0){var i=document.getElementById(this.rectForMinimapId+"-"+this.lastHighlightGripId);i.style.stroke=this.vfData.getGlodonColor()}if(this.currentGripId>=0||n>=0){this.currentGripId>=0&&(n=this.currentGripId);var i=document.getElementById(this.rectForMinimapId+"-"+n);i.style.stroke="#f5a623",this.currentGripId<0&&(this.lastHighlightGripId=n)}},e.prototype.drawGrips=function(){for(var e=this.getGrips(),t=0;t<e.length;t+=2){var n=!((t/2-1)%2);if(n){var i=this.createSegmentGrip(t/2,this.vfData.getGlodonColor());this.currentGripId==t/2&&(i=this.createSegmentGrip(t/2,"#FF9D0B")),this.vfViewer.getAuxContainer().appendChild(i)}}for(var t=0;t<e.length;t+=2){var n=!((t/2-1)%2);if(!n){var i=this.createGrip(t/2,this.vfData.getGlodonColor());this.currentGripId==t/2&&(i=this.createGrip(t/2,"#FF9D0B")),this.vfViewer.getAuxContainer().appendChild(i)}}},e.prototype.createSegmentGrip=function(e,t){var n=this.getGrips(),i=this.rectForMinimapId+"-"+e,r=document.getElementById(i);r&&r.parentNode.removeChild(r);var a=this.createSvgElement("line"),o=this.vfViewer.getAuxContainer().clientWidth,s=this.vfViewer.getAuxContainer().clientHeight,l=(e-1)%(n.length/2),u=(e+1)%(n.length/2),c=String(n[2*l]-o/2),h=String(n[2*l+1]-s/2),d=String(n[2*u]-o/2),f=String(n[2*u+1]-s/2);return a.setAttribute("id",i),a.setAttribute("x1",c),a.setAttribute("y1",h),a.setAttribute("x2",d),a.setAttribute("y2",f),a.setAttribute("style","fill: none; stroke: "+(t||"#4784cb")+"; stroke-width: 2; fill: #ffffff; display: block; position: absolute"),a},e.prototype.createGrip=function(e,t){var n=this.getGrips(),i=this.rectForMinimapId+"-"+e,r=document.getElementById(i);r&&r.parentNode.removeChild(r);var a=this.createSvgElement("circle"),o=this.vfViewer.getAuxContainer().clientWidth,s=this.vfViewer.getAuxContainer().clientHeight,l=["translate(",n[2*e]-o/2,",",n[2*e+1]-s/2,") ","rotate(",0,") "].join("");return a.setAttribute("id",i),a.setAttribute("transform",l),a.setAttribute("r","3"),a.setAttribute("style","fill: none; stroke: "+(t||"#4784cb")+"; stroke-width: 1; fill: #ffffff; display: block; position: absolute"),a},e.prototype.removeGrips=function(){for(var e=0;e<8;e++){var t=document.getElementById(this.rectForMinimapId+"-"+e);t&&t.parentNode.removeChild(t)}},e.prototype.removeSvgRect=function(){var e=document.getElementById(this.rectForMinimapId);e&&e.parentNode.removeChild(e)},e.prototype.destroyAll=function(){this.removeGrips(),this.removeSvgRect(),this.clearRectangle(),this.eventManager.dispatchEvent({type:i.EventType.Minimap_Rect_Destroyed})},e.prototype.getGrips=function(){var e={x:this.rectangle[0],y:this.rectangle[1]},t={x:this.rectangle[2],y:this.rectangle[3]},n={x:(e.x+t.x)/2,y:(e.y+t.y)/2},i=[];return i.push(e.x,e.y),i.push(e.x,n.y),i.push(e.x,t.y),i.push(n.x,t.y),i.push(t.x,t.y),i.push(t.x,n.y),i.push(t.x,e.y),i.push(n.x,e.y),i},e.prototype.hitGrips=function(e){for(var t=this.getGrips(),n=0;n<t.length;n+=2){var i=!((n/2-1)%2),r=!1;if(i){var a=(n/2-1)%(t.length/2),o=(n/2+1)%(t.length/2),s=t[2*a],l=t[2*a+1],u=t[2*o],c=t[2*o+1];r=this.isPointInSegment(e.x,e.y,s,l,u,c,3)}else{var h=[t[n],t[n+1]];r=this.isPointInCircle(e,h,6)}if(r)return n/2}return-1},e.prototype.isPointInCircle=function(e,t,n){var i=e.x-t[0],r=e.y-t[1];return Math.sqrt(i*i+r*r)<=n},e.prototype.isPointInSegment=function(e,t,n,i,r,a,o){o=o||0;var s=(r-n)*(e-n)+(a-i)*(t-i);if(s<=0)return Math.sqrt((e-n)*(e-n)+(t-i)*(t-i))<=o;var l=(r-n)*(r-n)+(a-i)*(a-i);if(s>=l)return Math.sqrt((e-r)*(e-r)+(t-a)*(t-a))<=o;var u=s/l,c=n+(r-n)*u,h=i+(a-i)*u;return Math.sqrt((e-c)*(e-c)+(h-t)*(h-t))<=o},e.prototype.isPointInRectangle=function(e,t){if(this.pointsCount()<2)return!1;var n=this.rectangle,i=n[0]<n[2]?[n[0],n[2]]:[n[2],n[0]],r=i[0],a=i[1],o=(n[1],n[3],[n[1],n[3]]),s=o[0],l=o[1];return r<e&&e<a&&s<t&&t<l},e.prototype.panRectangle=function(e,t){var n=this.rectangle,i=this.vfViewer.getDomContainer().getBoundingClientRect();this.lastMousePointToRectMin.x+e<0?e=-this.lastMousePointToRectMin.x:this.lastMousePointToRectMax.x+e>i.width&&(e=i.width-this.lastMousePointToRectMax.x),this.lastMousePointToRectMin.y+t<0?t=-this.lastMousePointToRectMin.y:this.lastMousePointToRectMax.y+t>i.height&&(t=i.height-this.lastMousePointToRectMax.y),n[0]=this.lastMousePointToRectMin.x+e,n[1]=this.lastMousePointToRectMin.y+t,n[2]=this.lastMousePointToRectMax.x+e,n[3]=this.lastMousePointToRectMax.y+t,this.resetSvgRect(),this.drawGrips()},e.prototype.updateLastMousePointToRect=function(){this.lastMousePointToRectMin.x=this.rectangle[0]-this.lastMousePoint.x,this.lastMousePointToRectMin.y=this.rectangle[1]-this.lastMousePoint.y,this.lastMousePointToRectMax.x=this.rectangle[2]-this.lastMousePoint.x,this.lastMousePointToRectMax.y=this.rectangle[3]-this.lastMousePoint.y},e.prototype.zoomAndPan=function(e,t,n){if(this.pointsCount()<2)return this.panOffset=[e,t],void(this.zoomFactor=n);for(var i=this.vfViewer.getDomContainer().getBoundingClientRect(),r=i.width,a=i.height,o=new THREE.Vector2(.5*r,.5*a),s=0;s<=this.rectangle.length/2;s+=2){var l=new THREE.Vector2(this.rectangle[s]-this.panOffset[0],this.rectangle[s+1]-this.panOffset[1]),u=l.clone().sub(o);u.divideScalar(this.zoomFactor),this.rectangle[s]=u.x+o.x,this.rectangle[s+1]=u.y+o.y;var c=new THREE.Vector2(this.rectangle[s],this.rectangle[s+1]),h=c.clone().sub(o);h.multiplyScalar(n),this.rectangle[s]=o.x+h.x+e,this.rectangle[s+1]=o.y+h.y+t}this.panOffset=[e,t],this.zoomFactor=n,this.resetSvgRect(),this.drawGrips()},e}();n.NaviAction=r},{"./EventManager":20}],23:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./ViewerFloorData"),r=e("./ViewerFloorView"),a=e("./ViewerFloorEditor"),o=e("./Editor/Editor"),s=e("./EventManager"),l=e("./Editor/ZoomEditor"),u=e("./Editor/PanEditor"),c=function(){function e(e,t){this.vfData=new i.ViewerFloorData,this.vfView=new r.ViewerFloorView(e,t,this.vfData),this.bIsEnableFloorPlaneChangedEvent=!0;var n=this.getMapContainer();this.vfEditor=new a.ViewerFloorEditor(n,this.vfData,this.vfView),THREE.vf=this}return e.prototype.setAxisGridData=function(e){this.vfData.setAxisGrids(e)},e.prototype.setPlanes=function(e){this.vfData.setPlanes(e)},e.prototype.setFloorPlaneId=function(e){this.vfData.setFloorPlaneId(e);var t=this.vfData.getProperZoomFactors();this.vfEditor.setZoomFactors(t),u.PanEditor.clear(),this.bIsEnableFloorPlaneChangedEvent&&this.vfEditor.getEventManager().dispatchEvent({type:s.EventType.Floor_Plane_Changed,elevation:this.vfData.getElevationById()}),this.vfEditor.getEventManager().dispatchEvent({type:s.EventType.Floor_Plane_Changed_For_Panel,name:this.getFloorPlaneName()})},e.prototype.getEventManager=function(){return this.vfEditor.getEventManager()},e.prototype.enableFloorPlaneChangedEvent=function(e){this.bIsEnableFloorPlaneChangedEvent=e},e.prototype.setSize=function(e,t){this.vfData.setSize(e,t)},e.prototype.resize=function(e,t,n){this.vfEditor.clearZoomAndPan(),this.vfData.setIsShowAxisGrid(n),this.vfData.setSize(e,t),this.vfView.setSize(e,t),n?(this.vfEditor.setZoomMode(l.VFSizeMode.Max),this.vfEditor.enableEditor(o.EditorName.RECTPICK_Editor),this.vfEditor.enablePickHover(!0)):(this.clearRectPick(),this.vfEditor.setZoomMode(l.VFSizeMode.Min),this.vfEditor.disableEditor(o.EditorName.RECTPICK_Editor),this.vfEditor.enablePickHover(!1)),this.vfData.getTipNode().hide()},e.prototype.destroy=function(){this.vfView.destroy(),this.vfData.destroy(),this.clearRectPick()},e.prototype.rebuildData=function(){this.vfData.build()},e.prototype.renderCameraNode=function(){this.vfView.updateCameraNode()},e.prototype.addEventListener=function(e,t){this.vfEditor.addEventListener(e,t)},e.prototype.clearRectPick=function(){this.vfEditor.clearRectPick()},e.prototype.clearZoomAndPan=function(){this.vfEditor.clearZoomAndPan(),this.vfView.destroy(),this.vfData.destroy(),this.vfData.build(),this.vfView.update()},e.prototype.getBoundingBoxIsolate=function(){return this.vfEditor.getBoundingBoxIsolate()},e.prototype.getFloorPlaneName=function(){return this.vfData.getDataFloorPlanes().getName(this.vfData.getFloorPlaneId())},e.prototype.getAxisGridBox2D=function(){return this.vfData.getAxisGridBox2D()},e.prototype.setMapClickMode=function(e){this.vfEditor.setMapClickMode(e)},e.prototype.getMapContainer=function(){return this.vfView.getDomContainer()},e.prototype.render=function(){this.vfView.update()},e.prototype.getPanOffset=function(){return{x:u.PanEditor.panOffsetX,y:u.PanEditor.panOffsetY}},e}();n.ViewerFloor=c,window.ViewerFloor=c},{"./Editor/Editor":15,"./Editor/PanEditor":16,"./Editor/ZoomEditor":19,"./EventManager":20,"./ViewerFloorData":24,"./ViewerFloorEditor":25,"./ViewerFloorView":26}],24:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./DrawableItem/AxisGrid"),r=e("./DrawableItem/FloorPlane"),a=e("./DrawableItem/CameraNode"),o=e("./Data/AxisGrids"),s=e("./Data/Levels"),l=e("./Data/FloorPlanes"),u=e("./Algorithm"),c=e("./DrawableItem/HighlightPoint"),h=e("./DrawableItem/TipNode"),d=e("./Editor/PanEditor"),f=function(){function e(){this.zoomFactor=1,this.bboxLengthStages=[15e4,3e5],this.zoomFactors1=[1,7/4,2.5,10/3],this.zoomFactors2=[1,7/4,2.5,14/3,65/12,20/3],this.zoomFactors3=[1,7/4,2.5,10/3,14/3,65/12,20/3,49/6,10],this.floorPlaneId=null,this.drawableItems=[],this.width=298,this.height=198,this.bIsShowAxisGrid=!1,this.bIsShowCameraNode=!0,this.bIsShowFloorPlane=!0,this.floorPlaneBox=new THREE.Box3,this.axisGridNode=null,this.cameraNode=null,this.floorPlaneNode=null,this.algorithm=new u.Algorithm,this.glodonColor="#11DAB7"}return e.prototype.setAxisGrids=function(e){this.dataAxisGrid=new o.AxisGrids(e.Grids),this.dataLevels=new s.Levels(e.Levels)},e.prototype.setPlanes=function(e){this.dataFloorPlanes=new l.FloorPlanes(e)},e.prototype.setFloorPlaneId=function(e){this.floorPlaneId=e,this.build()},e.prototype.getFloorPlaneId=function(){return this.floorPlaneId},e.prototype.getFloorPlaneBox=function(){var e=this.dataFloorPlanes.getFloorPlaneBox(this.floorPlaneId),t=this.dataFloorPlanes.getName(this.floorPlaneId),n=this.dataLevels.getMinMaxElevations(t);return this.floorPlaneBox.min=new THREE.Vector3(e.Min.X,e.Min.Y,n[0]),this.floorPlaneBox.max=new THREE.Vector3(e.Max.X,e.Max.Y,n[1]),this.floorPlaneBox},e.prototype.setSize=function(e,t){this.width=e,this.height=t},e.prototype.getSize=function(){return[this.width*this.zoomFactor,this.height*this.zoomFactor]},e.prototype.getOriginSize=function(){return[this.width,this.height]},e.prototype.getGlodonColor=function(){return this.glodonColor},e.prototype.build=function(){if(this.axisGridNode=new i.AxisGrid(this.dataAxisGrid.get(),this.getSize(),this.bIsShowAxisGrid,this.getZoomFactor()),this.axisGridNode.isEmpty()&&(this.bIsShowAxisGrid=!1),this.bIsShowAxisGrid&&this.drawableItems.push(this.axisGridNode),this.buildFloorPlane(),this.bIsShowCameraNode){this.cameraNode=new a.CameraNode;var e=this.getOriginSize();this.cameraNode.setPanelSize(e),this.drawableItems.push(this.cameraNode)}this.intersectPoint=new c.HighlightPoint(3),this.drawableItems.push(this.intersectPoint),this.tipNode=new h.TipNode,this.drawableItems.push(this.tipNode)},e.prototype.buildFloorPlane=function(){
if(this.bIsShowFloorPlane){var e=this.getFloorPlaneBox();this.getAxisGridBox2D().containsBox(e)||console.warn("the bounding-box of axis-grid is not contains the bounding-box of floor-plane!");var t=this.getFloorPlaneParams();this.floorPlaneNode=new r.FloorPlane(this.dataFloorPlanes.getUrl(this.floorPlaneId),t),this.drawableItems.push(this.floorPlaneNode)}},e.prototype.getFloorPlaneParams=function(){var e=this.getFloorPlaneBox(),t=this.getAxisGridBox2D(),n=new THREE.Box2(new THREE.Vector2(e.min.x,e.min.y),new THREE.Vector2(e.max.x,e.max.y)),i=this.getSize()[0],r=this.getSize()[1],a=i/r,o=t.getSize();o.x/o.y!=a&&(this.algorithm.expandBbox(t,a),o=t.getSize());var s=[],l=i/o.x,u=n.getSize().x*l,c=n.getSize().y*l;s.push(u,c);var h=n.getCenter().clone().sub(t.getCenter());return h.x*=l,h.y*=-l,s.push(h.x,h.y),s},e.prototype.updateFloorPlane=function(e){for(var t=this.dataLevels.getElevationsInOrder(),n=this.getElevationById(),i=void 0,r=void 0,a=0;a<t.length;a++){var o=t[a];if(o>e){r=o;break}}for(var a=t.length-1;a>=0;a--){var o=t[a];if(o<e){i=o;break}}if(void 0==i){var s=this.dataLevels.getLevelIdByElevation(r);return this.floorPlaneId=s,!0}if(void 0==r){var s=this.dataLevels.getLevelIdByElevation(i);return this.floorPlaneId=s,!0}if(n>=i&&n<r)return!1;var s=this.dataLevels.getLevelIdByElevation(i);return this.floorPlaneId=s,!0},e.prototype.getDataFloorPlanes=function(){return this.dataFloorPlanes},e.prototype.getAxisGridBox2D=function(e){var t=this.axisGridNode.getAxisGridBox(e);if(0==t.getSize().length()){var n=this.getFloorPlaneBox();if(e)return n;var i=(new THREE.Box2).set(new THREE.Vector2(n.min.x,n.min.y),new THREE.Vector2(n.max.x,n.max.y)),r=i.getCenter(),a=i.getSize(),o=new THREE.Vector2,s=this.width/this.height,l=a.x/a.y,u=a.x,c=a.y;return l>s?c=u/s:l<s&&(u=c*s),o.set(u,c),i.setFromCenterAndSize(r,o),i}return t},e.prototype.getDrawableItems=function(){return this.drawableItems},e.prototype.destroy=function(){this.drawableItems=[]},e.prototype.setIsShowAxisGrid=function(e){this.bIsShowAxisGrid=e},e.prototype.getCameraNode=function(){for(var e=this.drawableItems,t=0;t<e.length;t++){var n=e[t];if(n instanceof a.CameraNode)return n}},e.prototype.getElevationById=function(){return this.dataLevels.getElevation(this.floorPlaneId)},e.prototype.updateMovement=function(){this.getFloorPlaneNode().move(d.PanEditor.panOffsetX,d.PanEditor.panOffsetY);var e=this.getAxisGridNode();e&&e.move(d.PanEditor.panOffsetX,d.PanEditor.panOffsetY);var t=this.getCameraNode();t.move(d.PanEditor.panOffsetXForCamera,d.PanEditor.panOffsetYForCamera),t.rotate()},e.prototype.getCorner=function(e,t){var n=[],i=[];"Origin"==e?(n=[0,0],i=this.getOriginSize()):"Virtual"==e&&(n=[d.PanEditor.panOffsetX,d.PanEditor.panOffsetY],i=this.getSize());var r=0,a=0;switch(t){case"LB":r=n[0]-i[0]/2,a=n[1]+i[1]/2;break;case"LT":r=n[0]-i[0]/2,a=n[1]-i[1]/2;break;case"RT":r=n[0]+i[0]/2,a=n[1]-i[1]/2;break;case"RB":r=n[0]+i[0]/2,a=n[1]+i[1]/2;break;default:console.log("CornerName is wrong.")}return[r,a]},e.prototype.getIntersections=function(){return this.axisGridNode.getIntersections()},e.prototype.getGridLineByName=function(e){return this.axisGridNode.getGridLineByName(e)},e.prototype.getTipNode=function(){return this.tipNode},e.prototype.getFloorPlaneNode=function(){return this.floorPlaneNode},e.prototype.getAxisGridNode=function(){return 0==this.bIsShowAxisGrid?null:this.axisGridNode},e.prototype.getIntersectPoint=function(){return this.intersectPoint},e.prototype.setZoomFactor=function(e){this.zoomFactor=e},e.prototype.getZoomFactor=function(){return this.zoomFactor},e.prototype.getProperZoomFactors=function(){var e=this.getAxisGridBox2D(!0),t=Math.max(e.getSize().x,e.getSize().y);return t<=this.bboxLengthStages[0]?this.zoomFactors1:t<=this.bboxLengthStages[1]?this.zoomFactors2:this.zoomFactors3},e}();n.ViewerFloorData=f},{"./Algorithm":1,"./Data/AxisGrids":2,"./Data/FloorPlanes":3,"./Data/Levels":4,"./DrawableItem/AxisGrid":5,"./DrawableItem/CameraNode":7,"./DrawableItem/FloorPlane":9,"./DrawableItem/HighlightPoint":11,"./DrawableItem/TipNode":13,"./Editor/PanEditor":16}],25:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./EventManager"),r=e("./Editor/PickEditor"),a=e("./Editor/Editor"),o=e("./Editor/RectPickEditor"),s=e("./Editor/PanEditor"),l=e("./Editor/ZoomEditor"),u=e("./EventManager"),c=function(){function e(e,t,n){this.eventManager=new i.EventManager,this.mapContainer=e,this.viewerFloorData=t,this.vfViewer=n,this.vfViewer.setEventManager(this.eventManager),this.activeEditors=[],this.bIsEnablePickHover=!1,this.initialize()}return e.prototype.initialize=function(){this.onContextmenuBinded=this.onContextmenu.bind(this),this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.onMouseWheelBinded=this.onMouseWheel.bind(this),this.addDomEventListeners(),this.enableEditor(a.EditorName.PICK_Editor),this.enableEditor(a.EditorName.PAN_Editor),this.enableEditor(a.EditorName.Zoom_Editor)},e.prototype.addDomEventListeners=function(){var e=this.mapContainer;e.addEventListener("contextmenu",this.onContextmenuBinded,!1),e.addEventListener("mousemove",this.onMouseMoveBinded,!1),e.addEventListener("mousedown",this.onMouseDownBinded,!1),e.addEventListener("mousewheel",this.onMouseWheelBinded,!1),document.addEventListener("mouseup",this.onMouseUpBinded,!1)},e.prototype.removeDomEventListeners=function(){var e=this.mapContainer;e.removeEventListener("contextmenu",this.onContextmenuBinded,!1),e.removeEventListener("mousemove",this.onMouseMoveBinded,!1),e.removeEventListener("mousedown",this.onMouseDownBinded,!1),document.removeEventListener("mouseup",this.onMouseUpBinded,!1)},e.prototype.onMouseDown=function(e){for(var t=this.activeEditors,n=0;n<t.length;n++){var i=t[n];i.getName()==a.EditorName.PICK_Editor&&e.button!=u.MouseEventType.Left||(i.getName()==a.EditorName.RECTPICK_Editor&&e.button!=u.MouseEventType.Left||i.getName()==a.EditorName.PAN_Editor&&e.button==u.MouseEventType.Left||i.onMouseDown(e))}},e.prototype.onMouseMove=function(e){for(var t=this.activeEditors,n=0;n<t.length;n++){var i=t[n];i.getName()==a.EditorName.PICK_Editor&&0==this.bIsEnablePickHover||i.onMouseMove(e)}},e.prototype.onMouseUp=function(e){for(var t=this.activeEditors,n=0;n<t.length;n++){var i=t[n];i.getName()==a.EditorName.PICK_Editor&&e.button!=u.MouseEventType.Left||(i.getName()==a.EditorName.RECTPICK_Editor&&e.button!=u.MouseEventType.Left||i.getName()==a.EditorName.PAN_Editor&&e.button==u.MouseEventType.Left||i.onMouseUp(e))}},e.prototype.onMouseWheel=function(e){var t=this.find(a.EditorName.Zoom_Editor);t&&t.onMouseWheel(e)},e.prototype.onContextmenu=function(e){e.preventDefault()},e.prototype.addEventListener=function(e,t){this.eventManager.addEventListener(e,t)},e.prototype.clearRectPick=function(){var e=this.find(a.EditorName.RECTPICK_Editor);e instanceof o.RectPickEditor&&e.clear()},e.prototype.clearZoomAndPan=function(){s.PanEditor.clear(),l.ZoomEditor.clear(),this.viewerFloorData.setZoomFactor(1);var e=this.find(a.EditorName.Zoom_Editor);e instanceof l.ZoomEditor&&e.setZoonIndex(0)},e.prototype.getBoundingBoxIsolate=function(){var e=this.find(a.EditorName.RECTPICK_Editor);if(e instanceof o.RectPickEditor)return e.getBoundingBoxIsolate()},e.prototype.setMapClickMode=function(e){var t=this.find(a.EditorName.PICK_Editor);t instanceof r.PickEditor&&t.setClickMode(e)},e.prototype.find=function(e){for(var t=this.activeEditors,n=0;n<t.length;n++)if(t[n].getName()===e)return t[n]},e.prototype.enableEditor=function(e){if(!this.find(e)){var t=this.activeEditors;switch(e){case a.EditorName.PICK_Editor:t.push(new r.PickEditor(this.vfViewer,this.eventManager));break;case a.EditorName.RECTPICK_Editor:t.push(new o.RectPickEditor(this.vfViewer,this.eventManager));break;case a.EditorName.PAN_Editor:t.push(new s.PanEditor(this.vfViewer,this.eventManager));break;case a.EditorName.Zoom_Editor:t.push(new l.ZoomEditor(this.vfViewer,this.eventManager))}}},e.prototype.getEventManager=function(){return this.eventManager},e.prototype.disableEditor=function(e){for(var t=this.activeEditors,n=0;n<t.length;n++)t[n].getName()===e&&t.splice(n,1)},e.prototype.enablePickHover=function(e){this.bIsEnablePickHover=e},e.prototype.setZoomMode=function(e){var t=this.find(a.EditorName.Zoom_Editor);t instanceof l.ZoomEditor&&t.enableMode(e)},e.prototype.setZoomFactors=function(e){var t=this.find(a.EditorName.Zoom_Editor);t instanceof l.ZoomEditor&&t.setZoomFactors(e)},e}();n.ViewerFloorEditor=c},{"./Editor/Editor":15,"./Editor/PanEditor":16,"./Editor/PickEditor":17,"./Editor/RectPickEditor":18,"./Editor/ZoomEditor":19,"./EventManager":20}],26:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Algorithm"),r=e("./DrawableItem/TipNode"),a=e("./EventManager"),o=e("./Editor/PanEditor"),s=function(){function e(e,t,n){this.viewer=e,this.domContainer=t,this.viewerFloorData=n,this.width=298,this.height=198,this.algorithm=new i.Algorithm,this.eventManager=null,this.currentFloorName=null,this.initialize()}return e.prototype.initialize=function(){var e="http://www.w3.org/2000/svg";this.drawableContainer=document.createElementNS(e,"svg"),this.drawableContainer.setAttribute("width",this.width+""),this.drawableContainer.setAttribute("height",this.height+""),this.drawableContainer.setAttribute("viewBox",-this.width/2+" "+-this.height/2+" "+this.width+" "+this.height),this.drawableContainer.style.position="absolute",this.auxContainer=document.createElementNS(e,"svg"),this.auxContainer.setAttribute("width",this.width+""),this.auxContainer.setAttribute("height",this.height+""),this.auxContainer.setAttribute("viewBox",-this.width/2+" "+-this.height/2+" "+this.width+" "+this.height),this.auxContainer.style.position="absolute",this.mapContainer=document.createElement("div"),this.mapContainer.style.left="0px",this.mapContainer.style.bottom="0px",this.mapContainer.style.position="relative",this.mapContainer.outling="none",this.mapContainer.appendChild(this.drawableContainer),this.mapContainer.appendChild(this.auxContainer),this.domContainer.appendChild(this.mapContainer),this.cameraHeightChangedCallbackBinded=this.cameraHeightChangedCallback.bind(this),this.viewer.registerEventListener(400,this.cameraHeightChangedCallbackBinded)},e.prototype.cameraHeightChangedCallback=function(e){var t=e.cameraPosition,n=this.viewer.getScene().getMatrixGlobal(),i=(new THREE.Matrix4).getInverse(n),r=t.clone().applyMatrix4(i);if(this.viewerFloorData.getAxisGridBox2D().containsPoint(new THREE.Vector2(r.x,r.y))&&this.viewerFloorData.updateFloorPlane(r.z)){var o=this.viewerFloorData.getDataFloorPlanes(),s=o.getName(this.viewerFloorData.getFloorPlaneId());s&&this.currentFloorName!=s&&(this.currentFloorName=s,this.eventManager.dispatchEvent({type:a.EventType.Camera_Height_Changed,id:this.viewerFloorData.getFloorPlaneId()}),console.log("Current floor plane is "+s))}},e.prototype.getMapContainer=function(){return this.drawableContainer},e.prototype.getDomContainer=function(){return this.mapContainer},e.prototype.getAuxContainer=function(){return this.auxContainer},e.prototype.getViewer=function(){return this.viewer},e.prototype.getData=function(){return this.viewerFloorData},e.prototype.setSize=function(e,t){this.mapContainer.style.width=e+"px",this.mapContainer.style.height=t+"px",this.drawableContainer.setAttribute("width",e+""),this.drawableContainer.setAttribute("height",t+""),this.drawableContainer.setAttribute("viewBox",-e/2+" "+-t/2+" "+e+" "+t),this.auxContainer.setAttribute("width",e+""),this.auxContainer.setAttribute("height",t+""),this.auxContainer.setAttribute("viewBox",-e/2+" "+-t/2+" "+e+" "+t),this.destroy(),this.viewerFloorData.destroy(),this.viewerFloorData.build(),this.update(),this.eventManager.dispatchEvent({type:a.EventType.Resize,size:{width:e,height:t}})},e.prototype.destroy=function(){for(var e=this.drawableContainer;e.children.length>0;){var t=e.children[0];e.removeChild(t)}this.mapContainer.removeChild(e);var n=this.getData().getTipNode();null!=n.getSvgNode().parentNode&&this.mapContainer.removeChild(n.getSvgNode())},e.prototype.updateCameraNode=function(){var e=this.viewer,t=e.camera,n=e.cameraControl;if(t&&n){var i=t.position,r=t.target,a=this.algorithm.getMainSceneMatrix(e),s=new THREE.Matrix4;s.getInverse(a);var l=this.viewerFloorData.getFloorPlaneBox(),u=l.getCenter(),c=new THREE.Vector3(l.min.x,l.min.y,u.z).applyMatrix4(a),h=new THREE.Vector3(l.min.x,l.max.y,u.z).applyMatrix4(a),d=new THREE.Vector3(l.max.x,l.min.y,u.z).applyMatrix4(a),f=new THREE.Plane;f.setFromCoplanarPoints(c,h,d);var p=f.projectPoint(i);p.applyMatrix4(s);var m=f.projectPoint(r);m.applyMatrix4(s);var g=m.clone().sub(p);g.z=0,g.normalize();var v=i.clone();v.applyMatrix4(s);var y=v.clone(),E=this.viewerFloorData.getSize(),b={width:E[0]/2,height:E[1]/2},x=this.viewerFloorData.getAxisGridBox2D();this.algorithm.worldToNormalizedPoint(y,x),this.algorithm.normalizedPointToScreen(y,b);var M=this.viewerFloorData.getCameraNode();if(M.setOpacity("1.0"),g.length()<1e-5)M.setCameraArrowOpacity("0.0"),M.setOffsetAndRotate(y.x+o.PanEditor.panOffsetX,y.y+o.PanEditor.panOffsetY,0);else{var _=new THREE.Vector3(0,0,1),C=new THREE.Vector3(1,0,0),I=this.algorithm.isAngleGreaterThanPi(C,g,_),O=THREE.Math.radToDeg(C.angleTo(g));I||(O*=-1);var T=this.algorithm.calculateEdgePositionCameraOutBounds(p,g,x);if(T){var L=new THREE.Vector2(T.x,T.y);this.algorithm.worldToNormalizedPoint(L,x),this.algorithm.normalizedPointToScreen(L,b),M.setSmallCamera(),M.setOffsetAndRotate(L.x+o.PanEditor.panOffsetX,L.y+o.PanEditor.panOffsetY,O)}else M.setBigCamera(),M.setOffsetAndRotate(y.x+o.PanEditor.panOffsetX,y.y+o.PanEditor.panOffsetY,O);M.setCameraArrowOpacity("1.0")}}},e.prototype.update=function(e){for(var t=this.viewerFloorData.getDrawableItems(),n=0;n<t.length;n++){var i=t[n];i instanceof r.TipNode?this.mapContainer.appendChild(i.getSvgNode()):i.abtainRenderables(this.drawableContainer)}this.updateCameraNode();var a=this.mapContainer.firstChild;a?this.mapContainer.insertBefore(this.drawableContainer,a):this.mapContainer.appendChild(this.drawableContainer)},e.prototype.setEventManager=function(e){this.eventManager=e},e.prototype.getEventManager=function(){return this.eventManager},e}();n.ViewerFloorView=s},{"./Algorithm":1,"./DrawableItem/TipNode":13,"./Editor/PanEditor":16,"./EventManager":20}]},{},[23]);